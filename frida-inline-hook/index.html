



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="qQVmgWozVe7BXoA15J3gAZpEA5dK168admH4U3W6PAk">
  <meta name="msvalidate.01" content="4902E39C0135E72DE537BCB0FE08B40A">
  <meta name="baidu-site-verification" content="codeva-CSYjpuVg5v">


<link rel="alternate" type="application/rss+xml" title="oaciaのBbBlog~" href="https://oacia.dev/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="oaciaのBbBlog~" href="https://oacia.dev/atom.xml" />
<link rel="alternate" type="application/json" title="oaciaのBbBlog~" href="https://oacia.dev/feed.json" />
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-regular.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-700.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/font_1832207_igi8uaupcus.woff2"
/>
<link rel="preload" href="/background_picture/1_gongzi.webp" as="image" />
<link rel="preload" href="/background_picture/2_xiaoxia.webp" as="image" />
<link rel="preload" href="/background_picture/3_xingye.webp" as="image" />
<link rel="preload" href="/images/avatar.jpg" as="image" />



<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="https://oacia.dev/frida-inline-hook/">


<meta name="description" content="# 前言 最近需要对一个固件的 arm64 linux 系统中的一个进程进行 inline hook, 然而当把 frida-inject  上传上去之后运行却发现，由于 linux 版本为 4.4 有些古老了，并且比正常的 linux 缺了一些文件，导致 frida 一运行就报错退出，所以就想着能不能自己去实现一个 inline hook. 但在这之前我们得先知道原理才行～如果想知道 inlin">
<meta property="og:type" content="article">
<meta property="og:title" content="frida inline hook原理分析及实践">
<meta property="og:url" content="https://oacia.dev/frida-inline-hook/">
<meta property="og:site_name" content="oaciaのBbBlog~">
<meta property="og:description" content="# 前言 最近需要对一个固件的 arm64 linux 系统中的一个进程进行 inline hook, 然而当把 frida-inject  上传上去之后运行却发现，由于 linux 版本为 4.4 有些古老了，并且比正常的 linux 缺了一些文件，导致 frida 一运行就报错退出，所以就想着能不能自己去实现一个 inline hook. 但在这之前我们得先知道原理才行～如果想知道 inlin">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240723231240202.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240723150910476.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240723151030760.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240723151113720.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240723232420799.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240724005026756.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240724012046288.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240827140044091.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240724013031337.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240724013427577.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240724013125866.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240816101950696.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240819152115591.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240819160333432.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240819162616719.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240819162708924.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240820155113179.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240826150146133.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240826153126695.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240826153223819.png">
<meta property="og:image" content="https://oacia.dev/frida-inline-hook/image-20240829154247205.png">
<meta property="article:published_time" content="2024-08-12T19:11:00.000Z">
<meta property="article:modified_time" content="2025-04-08T18:55:11.553Z">
<meta property="article:author" content="oacia">
<meta property="article:tag" content="reverse,安卓逆向,区块链,学习笔记,破解实战,前端,CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oacia.dev/frida-inline-hook/image-20240723231240202.png">
<meta name="twitter:creator" content="@oacia86">


  <title>
frida inline hook原理分析及实践 |
oacia = oaciaのBbBlog~ = DEVIL or SWEET</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  var jq_151 = $.noConflict(true);
  var RENDERER = {
    INIT_CHERRY_BLOSSOM_COUNT : 30,
    MAX_ADDING_INTERVAL : 10,
    WATCH_INTERVAL : 300,
    
    init : function(){
      this.setParameters();
      this.reconstructMethods();
      this.setup();
      this.bindEvent();
      this.render();
    },
    setParameters : function(){
      this.$window = jq_151(window);
      this.$container = jq_151('#loading');
      this.$canvas = jq_151('<canvas />');
      this.context = this.$canvas.appendTo(this.$container).get(0).getContext('2d');
      this.cherries = [];
      this.watchIds = [];
    },
    reconstructMethods : function(){
      this.watchWindowSize = this.watchWindowSize.bind(this);
      this.jdugeToStopResize = this.jdugeToStopResize.bind(this);
      this.render = this.render.bind(this);
    },
    setup : function(){
      this.cherries.length = 0;
      this.watchIds.length = 0;
      this.width = this.$container.width();
      this.height = this.$container.height();
      this.$canvas.attr({width : this.width, height : this.height});
      this.maxAddingInterval = Math.round(this.MAX_ADDING_INTERVAL * 1000 / this.width);
      this.addingInterval = this.maxAddingInterval;
      this.createCherries();
    },
    createCherries : function(){
      for(var i = 0, length = Math.round(this.INIT_CHERRY_BLOSSOM_COUNT * this.width / 1000); i < length; i++){
        this.cherries.push(new CHERRY_BLOSSOM(this, true));
      }
    },
    watchWindowSize : function(){
      this.clearTimer();
      this.tmpWidth = window.width;
      this.tmpHeight = window.height;
      this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL));
    },
    clearTimer : function(){
      while(this.watchIds.length > 0){
        clearTimeout(this.watchIds.pop());
      }
    },
    jdugeToStopResize : function(){
      var width = window.width,
        height = window.height,
        stopped = (width == this.tmpWidth && height == this.tmpHeight);
        
      this.tmpWidth = width;
      this.tmpHeight = height;
      
      if(stopped){
        this.setup();
      }
    },
    bindEvent : function(){
      this.$window.on('resize', this.watchWindowSize);
    },
    render : function(){
      //console.log("render")

      if(jq_151(this.$container).css("display")!="none"){
        requestAnimationFrame(this.render);
      }
      
      this.context.clearRect(0, 0, this.width, this.height);
      
      this.cherries.sort(function(cherry1, cherry2){
        return cherry1.z - cherry2.z;
      });
      for(var i = this.cherries.length - 1; i >= 0; i--){
        if(!this.cherries[i].render(this.context)){
          this.cherries.splice(i, 1);
        }
      }
      if(--this.addingInterval == 0){
        this.addingInterval = this.maxAddingInterval;
        this.cherries.push(new CHERRY_BLOSSOM(this, false));
      }
    }
  };
  var CHERRY_BLOSSOM = function(renderer, isRandom){
    this.renderer = renderer;
    this.init(isRandom);
  };
  CHERRY_BLOSSOM.prototype = {
    FOCUS_POSITION : 300,
    FAR_LIMIT : 600,
    MAX_RIPPLE_COUNT : 100,
    RIPPLE_RADIUS : 100,
    SURFACE_RATE : 0.5,
    SINK_OFFSET : 20,
    
    init : function(isRandom){
      this.x = this.getRandomValue(-this.renderer.width, this.renderer.width);
      this.y = isRandom ? this.getRandomValue(0, this.renderer.height) : this.renderer.height * 1.5;
      this.z = this.getRandomValue(0, this.FAR_LIMIT);
      this.vx = this.getRandomValue(-2, 2);
      this.vy = -2;
      this.theta = this.getRandomValue(0, Math.PI * 2);
      this.phi = this.getRandomValue(0, Math.PI * 2);
      this.psi = 0;
      this.dpsi = this.getRandomValue(Math.PI / 600, Math.PI / 300);
      this.opacity = 0;
      this.endTheta = false;
      this.endPhi = false;
      this.rippleCount = 0;
      
      var axis = this.getAxis(),
        theta = this.theta + Math.ceil(-(this.y + this.renderer.height * this.SURFACE_RATE) / this.vy) * Math.PI / 500;
      theta %= Math.PI * 2;
      
      this.offsetY = 40 * ((theta <= Math.PI / 2 || theta >= Math.PI * 3 / 2) ? -1 : 1);
      this.thresholdY = this.renderer.height / 2 + this.renderer.height * this.SURFACE_RATE * axis.rate;
      this.entityColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.entityColor.addColorStop(0, 'hsl(330, 70%, ' + 50 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(0.05, 'hsl(330, 40%,' + 55 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(1, 'hsl(330, 20%, ' + 70 * (0.3 + axis.rate) + '%)');
      this.shadowColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.shadowColor.addColorStop(0, 'hsl(330, 40%, ' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(0.05, 'hsl(330, 40%,' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(1, 'hsl(330, 20%, ' + 40 * (0.3 + axis.rate) + '%)');
    },
    getRandomValue : function(min, max){
      return min + (max - min) * Math.random();
    },
    getAxis : function(){
      var rate = this.FOCUS_POSITION / (this.z + this.FOCUS_POSITION),
        x = this.renderer.width / 2 + this.x * rate,
        y = this.renderer.height / 2 - this.y * rate;
      return {rate : rate, x : x, y : y};
    },
    renderCherry : function(context, axis){
      context.beginPath();
      context.moveTo(0, 40);
      context.bezierCurveTo(-60, 20, -10, -60, 0, -20);
      context.bezierCurveTo(10, -60, 60, 20, 0, 40);
      context.fill();
      
      for(var i = -4; i < 4; i++){
        context.beginPath();
        context.moveTo(0, 40);
        context.quadraticCurveTo(i * 12, 10, i * 4, -24 + Math.abs(i) * 2);
        context.stroke();
      }
    },
    render : function(context){
      var axis = this.getAxis();
      
      if(axis.y == this.thresholdY && this.rippleCount < this.MAX_RIPPLE_COUNT){
        context.save();
        context.lineWidth = 2;
        context.strokeStyle = 'hsla(0, 0%, 100%, ' + (this.MAX_RIPPLE_COUNT - this.rippleCount) / this.MAX_RIPPLE_COUNT + ')';
        context.translate(axis.x + this.offsetY * axis.rate * (this.theta <= Math.PI ? -1 : 1), axis.y);
        context.scale(1, 0.3);
        context.beginPath();
        context.arc(0, 0, this.rippleCount / this.MAX_RIPPLE_COUNT * this.RIPPLE_RADIUS * axis.rate, 0, Math.PI * 2, false);
        context.stroke();
        context.restore();
        this.rippleCount++;
      }
      if(axis.y < this.thresholdY || (!this.endTheta || !this.endPhi)){
        if(this.y <= 0){
          this.opacity = Math.min(this.opacity + 0.01, 1);
        }
        context.save();
        context.globalAlpha = this.opacity;
        context.fillStyle = this.shadowColor;
        context.strokeStyle = 'hsl(330, 30%,' + 40 * (0.3 + axis.rate) + '%)';
        context.translate(axis.x, Math.max(axis.y, this.thresholdY + this.thresholdY - axis.y));
        context.rotate(Math.PI - this.theta);
        context.scale(axis.rate * -Math.sin(this.phi), axis.rate);
        context.translate(0, this.offsetY);
        this.renderCherry(context, axis);
        context.restore();
      }
      context.save();
      context.fillStyle = this.entityColor;
      context.strokeStyle = 'hsl(330, 40%,' + 70 * (0.3 + axis.rate) + '%)';
      context.translate(axis.x, axis.y + Math.abs(this.SINK_OFFSET * Math.sin(this.psi) * axis.rate));
      context.rotate(this.theta);
      context.scale(axis.rate * Math.sin(this.phi), axis.rate);
      context.translate(0, this.offsetY);
      this.renderCherry(context, axis);
      context.restore();
      
      if(this.y <= -this.renderer.height / 4){
        if(!this.endTheta){
          for(var theta = Math.PI / 2, end = Math.PI * 3 / 2; theta <= end; theta += Math.PI){
            if(this.theta < theta && this.theta + Math.PI / 200 > theta){
              this.theta = theta;
              this.endTheta = true;
              break;
            }
          }
        }
        if(!this.endPhi){
          for(var phi = Math.PI / 8, end = Math.PI * 7 / 8; phi <= end; phi += Math.PI * 3 / 4){
            if(this.phi < phi && this.phi + Math.PI / 200 > phi){
              this.phi = Math.PI / 8;
              this.endPhi = true;
              break;
            }
          }
        }
      }
      if(!this.endTheta){
        if(axis.y == this.thresholdY){
          this.theta += Math.PI / 200 * ((this.theta < Math.PI / 2 || (this.theta >= Math.PI && this.theta < Math.PI * 3 / 2)) ? 1 : -1);
        }else{
          this.theta += Math.PI / 500;
        }
        this.theta %= Math.PI * 2;
      }
      if(this.endPhi){
        if(this.rippleCount == this.MAX_RIPPLE_COUNT){
          this.psi += this.dpsi;
          this.psi %= Math.PI * 2;
        }
      }else{
        this.phi += Math.PI / ((axis.y == this.thresholdY) ? 200 : 500);
        this.phi %= Math.PI;
      }
      if(this.y <= -this.renderer.height * this.SURFACE_RATE){
        this.x += 2;
        this.y = -this.renderer.height * this.SURFACE_RATE;
      }else{
        this.x += this.vx;
        this.y += this.vy;
      }
      return this.z > -this.FOCUS_POSITION && this.z < this.FAR_LIMIT && this.x < this.renderer.width * 1.5;
    }
  };
  jq_151(function(){
    RENDERER.init();
  });
</script>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <!--
    <div class="alice">
      <img src="/images/alice-shake.gif" alt="">
    </div>

    
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
    -->
  </div>
  <script
      defer="defer"
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"
      integrity="sha512-1dalHDkG9EtcOmCnoCjiwQ/HEB5SDNqw8d4G2MKoNwjiwMNeBAkudsBCmSlMnXdsH8Bm0mOd3tl/6nL5y0bMaQ=="
      crossorigin="anonymous"
    ></script>
  <script defer="defer" src="/js/gsap/DrawSVGPlugin.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomEase.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomBounce.min.js"></script>
  <script defer="defer" src="/js/gsap/SplitText.min.js"></script>
  <script defer="defer" src="/js/gsap/logo-run.js"></script>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">frida inline hook原理分析及实践
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2024-08-13 03:11:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2024-08-13T03:11:00+08:00">2024-08-13</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>21k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>20 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">oacia</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="/background_picture/1_mary.jpg"></li>
          <li class="item" data-background-image="/background_picture/2_xingye.webp"></li>
          <li class="item" data-background-image="/background_picture/3_xiaoxia.webp"></li>
          <li class="item" data-background-image="/background_picture/4_alice.webp"></li>
          <li class="item" data-background-image="/background_picture/5_mutsuki.jpg"></li>
          <li class="item" data-background-image="/background_picture/6_arona_plana.webp"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb">
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://oacia.dev/frida-inline-hook/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="oacia">
    <meta itemprop="description" content="DEVIL or SWEET, 月遇从云 花遇和风">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="oaciaのBbBlog~">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="前言"><a class="anchor" href="#前言">#</a> 前言</h1>
<p>最近需要对一个固件的 arm64 linux 系统中的一个进程进行 inline hook, 然而当把 <code>frida-inject</code>  上传上去之后运行却发现，由于 linux 版本为 4.4 有些古老了，并且比正常的 linux 缺了一些文件，导致 frida 一运行就报错退出，所以就想着能不能自己去实现一个 inline hook. 但在这之前我们得先知道原理才行～如果想知道 inline hook 的原理是什么样子的，我认为最好的办法就是直接去看看 hook 之后的代码变成了什么样子，用调试的方法研究 frida 实现 inline hook 的具体实现</p>
<p>首先我们对一个测试 apk 注入下面的脚本实现 hook</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_dlopen</span><span class="token punctuation">(</span>soName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"android_dlopen_ext"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token keyword">var</span> pathptr <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pathptr <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> pathptr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                    <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>pathptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>soName<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                        <span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token comment">//do your own code</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                    <span class="token function">hook_native</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_native</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"liboacia.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x10B0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook test apk at "</span><span class="token punctuation">,</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x10B0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pid = "</span><span class="token punctuation">,</span>Process<span class="token punctuation">.</span><span class="token function">getCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token function">setImmediate</span><span class="token punctuation">(</span>hook_dlopen<span class="token punctuation">,</span> <span class="token string">"liboacia.so"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>oriole:/ <span class="token comment"># /data/local/tmp/fs16.3.3 &amp;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>frida <span class="token parameter variable">-U</span> <span class="token parameter variable">-l</span> .<span class="token punctuation">\</span>hook.js <span class="token parameter variable">-f</span> com.oacia.apk_protect</pre></td></tr></table></figure><p>被 hook 的代码如图所示</p>
<p><img data-src="/frida-inline-hook/image-20240723231240202.png" alt="image-20240723231240202" style="aspect-ratio:1533 / 588;"></p>
<p>注入完成之后，我们使用 lldb 去调试看看</p>
<h1 id="lldb动态调试"><a class="anchor" href="#lldb动态调试">#</a> lldb 动态调试</h1>
<p>先到 <code>ndk\26.1.10909125\toolchains\llvm\prebuilt\windows-x86_64\lib\clang\17\lib\linux\aarch64</code>  把 <code>lldb-server</code>  推送到手机上</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>adb push .<span class="token punctuation">\</span>lldb-server /data/local/tmp</pre></td></tr></table></figure><p>随后在手机上启动 <code>lldb-server</code></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./lldb-server platform <span class="token parameter variable">--server</span> <span class="token parameter variable">--listen</span> unix-abstract:///data/local/tmp/debug.sock <span class="token operator">&amp;</span></pre></td></tr></table></figure><p>然后找到 <code>ndk\26.1.10909125\toolchains\llvm\prebuilt\windows-x86_64\bin\lldb.cmd</code> , 运行这个 cmd</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>.<span class="token punctuation">\</span>lldb.cmd</pre></td></tr></table></figure><p>进入后设置要连接的类型为 <code>remote-android</code></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>platform <span class="token keyword">select</span> remote-android</pre></td></tr></table></figure><p><img data-src="/frida-inline-hook/image-20240723150910476.png" alt="image-20240723150910476" style="aspect-ratio:585 / 103;"></p>
<p>然后连接安卓中的 <code>lldb-server</code></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>platform connect unix-abstract-connect:///data/local/tmp/debug.sock</pre></td></tr></table></figure><p><img data-src="/frida-inline-hook/image-20240723151030760.png" alt="image-20240723151030760" style="aspect-ratio:1270 / 266;"></p>
<p>使用 <code>platform status</code>  查看是否已经连接</p>
<p><img data-src="/frida-inline-hook/image-20240723151113720.png" alt="image-20240723151113720" style="aspect-ratio:1061 / 197;"></p>
<p>之后 attach 到指定的包名上</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>process attach <span class="token parameter variable">-p</span> <span class="token punctuation">[</span>pid<span class="token punctuation">]</span></pre></td></tr></table></figure><details class="info"><summary>error: attach failed: Connection shut down...</summary><div>
<p>我在使用 lldb 的过程中出现了这个报错</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>lldb<span class="token punctuation">)</span> process attach <span class="token parameter variable">-p</span> <span class="token number">32883</span></pre></td></tr><tr><td data-num="2"></td><td><pre>error: attach failed: Connection shut down by remote side <span class="token keyword">while</span> waiting <span class="token keyword">for</span> reply to initial handshake packet</pre></td></tr></table></figure><p>网上都说是开了 SELinux 的问题，我把 SELinux 临时设置为 0 还是没有解决这个 error</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>oriole:/data/local/tmp <span class="token comment"># setenforce 0</span></pre></td></tr><tr><td data-num="2"></td><td><pre>oriole:/data/local/tmp <span class="token comment"># getenforce                                             Permissive</span></pre></td></tr></table></figure><p>没办法，只能用 logcat 看看日志了，随后发现了这条日志，但是木有作用</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>E adbd: failed to connect to socket <span class="token string">'localabstract:'</span><span class="token builtin class-name">:</span> could not connect to localabstract address <span class="token string">'localabstract:'</span></pre></td></tr></table></figure><p>后来排查了一下午，原来是我为了防止进程名检测，保留了过去 ida-server 和 frida-server push 到手机里面之后<strong>修改文件名</strong>的习惯，把 <code>llbd-server</code>  的名字改成了 <code>lldb26</code> , 然后…attach 的时候就报错了（改个文件名都不行 <code>-,-</code></p>
</div></details>
<p>随后打个断点</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>lldb<span class="token punctuation">)</span> breakpoint <span class="token builtin class-name">set</span> <span class="token parameter variable">-s</span> liboacia.so <span class="token parameter variable">-a</span> 0x10B0</pre></td></tr></table></figure><p>通过对 hook 地址的反编译，发现了很有意思的点就是从 hook 地址开始的后 16 个字节的汇编都和原来不一样了，但是 lldb 的汇编看起来很奇怪</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>0x6e84a900b0: 0x58000050   ldr    x16, <span class="token comment">#0x8</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    0x6e84a900b4: 0xd61f0200   br     x16</pre></td></tr><tr><td data-num="3"></td><td><pre>    0x6e84a900b8: 0xb092a400   adrp   x0, <span class="token parameter variable">-895871</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    0x6e84a900bc: 0x00000071   udf    <span class="token comment">#0x71</span></pre></td></tr></table></figure><p><img data-src="/frida-inline-hook/image-20240723232420799.png" alt="image-20240723232420799" style="aspect-ratio:1663 / 748;"></p>
<p>这段汇编给 x16 寄存器赋值为相对偏移 #0x8 位置的值，然后再去进行 BR 跳转，这后两行的指令 <code>adrp x0, -895871</code>  和 <code>udf #0x71</code>  压根就不是指令，而是一个八字节的一级跳板要跳往的地址</p>
<p>不得不说 lldb 确实是一个非常强大的动调工具，我觉得使用 lldb 的 python API 直接用脚本和汇编交互的样子一定非常的厉害，等之后分析抖音的 vmp 的时候在用它吧</p>
<p>想看正确的汇编怎么办呢，上 IDA!</p>
<h1 id="ida动态调试分析hook跳板"><a class="anchor" href="#ida动态调试分析hook跳板">#</a> IDA 动态调试分析 hook 跳板</h1>
<p>IDA 直接附加的话是附加不上的，原因在于 apk 设置了 <code>android:extractNativeLibs=&quot;false&quot;</code>  导致 so 不会被解压到 <code>/data/app/...com.oacia.apk_protect/lib/arm64</code>  文件夹中，而是直接从 apk 中加载，所以 IDA 也就找不到这个 so 加载的时候了，这种情况下我们把要调试的 <code>liboacia.so</code>  用 MT 管理器直接复制到 <code>/data/app/...com.oacia.apk_protect/lib/arm64</code>  里面去就可以了，同时注意需要给这个 so  <code>rwx</code>  的运行权限</p>
<h2 id="一级跳板"><a class="anchor" href="#一级跳板">#</a> 一级跳板</h2>
<p>有了 IDA 强大的反编译功能，这里的汇编也是显示了出来，从 hook 点开始的 16 个字节全部被一级跳板的字节码覆盖了，前 8 字节是两行汇编，用来实现跳板的跳转，后八字节存储了跳板要跳往的地址</p>
<p><img data-src="/frida-inline-hook/image-20240724005026756.png" alt="image-20240724005026756" style="aspect-ratio:2083 / 277;"></p>
<p>这里使用的是 x16 和 x17 寄存器，那为什么使用这两个寄存器呢？</p>
<p>根据<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXJtLmNvbS9kb2N1bWVudGF0aW9uL2RlbjAwMjQvYS9UaGUtQUJJLWZvci1BUk0tNjQtYml0LUFyY2hpdGVjdHVyZS9SZWdpc3Rlci11c2UtaW4tdGhlLUFBcmNoNjQtUHJvY2VkdXJlLUNhbGwtU3RhbmRhcmQvUGFyYW1ldGVycy1pbi1nZW5lcmFsLXB1cnBvc2UtcmVnaXN0ZXJz"> arm64 官网描述</span>，x16 和 x17 是程序内调用临时寄存器，也就是平时根本不会用他们，所以把这两个寄存器用作跳板是再合适不过的</p>
<blockquote>
<p>X16 and X17 are IP0 and IP1, intra-procedure-call temporary registers. These can be used by call veneers and similar code, or as temporary registers for intermediate values between subroutine calls. They are corruptible by a function. Veneers are small pieces of code which are automatically inserted by the linker, for example when the branch target is out of range of the branch instruction.</p>
</blockquote>
<p>那顺便也记一下其他寄存器的作用好了</p>
<ul>
<li>X0-X7: 参数寄存器，用于传递函数参数和返回结果，要是参数比八个多的话就会用堆栈去传递</li>
<li>X8: 用来存放函数返回值的，不过这个寄存器比较特殊一点，只有当返回值是大型结构体的时候才会用 x8 去返回，其余情况都是用 x0 去返回的</li>
<li>X9-X15: 临时寄存器，这 7 个寄存器是用来存储临时数据的</li>
<li>X16-X17: 他们是给编译器使用的，正常的程序都不会使用他们，所以当作跳板是相当的合适</li>
<li>X18: 平台寄存器，基本是不用的</li>
<li>X19-X28: 保存寄存器，这 10 个寄存器用来保存函数调用上下文</li>
<li>X29: FP 寄存器，用于连接栈帧</li>
<li>X30: 也叫 LR 寄存器，用于保存子程序的返回地址</li>
<li>X31: SP 寄存器，用于指向每个函数的栈顶</li>
<li>SP： <code>SP</code>  是栈顶指针寄存器，类似 <code>Intel 64</code>  中的 <code>RSP</code>  寄存器</li>
<li>PC： <code>PC</code>  寄存器存储当前要执行的指令地址，类似 <code>Intel 64</code>  中的 <code>RIP</code>  寄存器</li>
</ul>
<h2 id="二级跳板"><a class="anchor" href="#二级跳板">#</a> 二级跳板</h2>
<p>二级跳板中 X17 保存了返回地址，也就是我们本身的 hook 地址的值，而 X16 则保存了三级跳版的位置，而在二级跳板的下方，竟然还有一个跳板，不过现在还没有看到它的用途所在</p>
<p><img data-src="/frida-inline-hook/image-20240724012046288.png" alt="image-20240724012046288" style="aspect-ratio:1793 / 552;"></p>
<blockquote>
<p>这里二级跳板有啥用？为啥不直接跳到三级跳板？</p>
</blockquote>
<h2 id="三级跳板"><a class="anchor" href="#三级跳板">#</a> 三级跳板</h2>
<p>这三级跳板总共干了三件事情</p>
<h3 id="保存寄存器环境"><a class="anchor" href="#保存寄存器环境">#</a> 保存寄存器环境</h3>
<p><img data-src="/frida-inline-hook/image-20240827140044091.png" alt="image-20240827140044091" style="aspect-ratio:1640 / 1078;"></p>
<h3 id="跳转到核心代码"><a class="anchor" href="#跳转到核心代码">#</a> 跳转到核心代码</h3>
<p><img data-src="/frida-inline-hook/image-20240724013031337.png" alt="image-20240724013031337" style="aspect-ratio:1925 / 91;"></p>
<p>经过三个跳板的层层跳转，我们也是终于来到了 <code>frida_agent_64.so</code>  中执行我们编写的 hook 逻辑比如打印寄存器，读取内存等操作了</p>
<p><img data-src="/frida-inline-hook/image-20240724013427577.png" alt="image-20240724013427577" style="aspect-ratio:1590 / 1285;"></p>
<h3 id="恢复寄存器环境"><a class="anchor" href="#恢复寄存器环境">#</a> 恢复寄存器环境</h3>
<p>使用 <code>LDP</code>  加载栈中保存的寄存器环境</p>
<p><img data-src="/frida-inline-hook/image-20240724013125866.png" alt="image-20240724013125866" style="aspect-ratio:1789 / 1010;"></p>
<h2 id="恢复执行流"><a class="anchor" href="#恢复执行流">#</a> 恢复执行流</h2>
<p>由于 hook 所生成的跳板函数会对 hook 位置的 16 字节汇编进行覆盖，所以必须要对被覆盖的那 16 字节汇编再次执行，否则将会对执行流产生影响。在三级跳板的最后 <code>RET X16</code> , 将会来到跳转到此处执行先前未完成的汇编</p>
<p><img data-src="/frida-inline-hook/image-20240816101950696.png" alt="image-20240816101950696" style="aspect-ratio:1437 / 267;"></p>
<h1 id="自实现inline-hook"><a class="anchor" href="#自实现inline-hook">#</a> 自实现 inline hook</h1>
<p>虽说要 hook 的目标是 arm64 linux, 但是本人对于安卓更为熟悉一些，所以这里的示例也使用的是 android (毕竟都是 arm64 架构，hook 肯定是通用的)</p>
<p>先写个一键编译的 <code>run.bat</code>  脚本，这样运行一下连带编译传输到手机上的步骤都一步到位了～</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token string">"E:\Program Files\CLion 2024.1<span class="token entity" title="\b">\b</span>in<span class="token entity" title="\c">\c</span>make\win<span class="token entity" title="\x64">\x64</span><span class="token entity" title="\b">\b</span>in<span class="token entity" title="\c">\c</span>make.exe"</span> <span class="token parameter variable">--build</span> E:<span class="token punctuation">\</span>analysis<span class="token punctuation">\</span>frida-inline-hook<span class="token punctuation">\</span>self_hook<span class="token punctuation">\</span>cmake-build-android <span class="token parameter variable">--target</span> hook-server <span class="token parameter variable">-j</span> <span class="token number">14</span></pre></td></tr><tr><td data-num="2"></td><td><pre>adb push .<span class="token punctuation">\</span>cmake-build-android<span class="token punctuation">\</span>hook-server /data/local/tmp</pre></td></tr><tr><td data-num="3"></td><td><pre>adb shell <span class="token string">"chmod 777 /data/local/tmp/hook-server"</span></pre></td></tr><tr><td data-num="4"></td><td><pre>adb shell <span class="token function">su</span> <span class="token parameter variable">-c</span> <span class="token string">"/data/local/tmp/hook-server"</span></pre></td></tr></table></figure><h2 id="ptrace注入"><a class="anchor" href="#ptrace注入">#</a> ptrace 注入</h2>
<p>如果我们要自己去实现对进程的注入，那么首先要做的就是使用 ptrace 的 <code>PTRACE_ATTACH</code>  附加到这个进程上面去</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">ptraceAttach</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ptrace</span><span class="token punctuation">(</span>PTRACE_ATTACH<span class="token punctuation">,</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[ptrace] Failed to attach:%d\n"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[ptrace] Attach to pid %d\n"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">int</span> stat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/*  在用 ptrace 去 attach 一个进程之后，那个被 attach 的进程某种意义上说可以算作那个 attach</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     *  进程的子进程，这种情况下，就可以通过 waitpid 这个函数来知道被调试的进程何时停止运行</pre></td></tr><tr><td data-num="11"></td><td><pre>     *</pre></td></tr><tr><td data-num="12"></td><td><pre>     *  @param option->WUNTRACED: 如果子进程进入暂停状态，则马上返回。*/</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token operator">&amp;</span>stat<span class="token punctuation">,</span>WUNTRACED<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/frida-inline-hook/image-20240819152115591.png" alt="image-20240819152115591" style="aspect-ratio:1183 / 67;"></p>
<p>一旦我们使用 ptrace 附加了上去，这就意味着我们有了对这个进程空间中的内存进行操作的权力，现在我们需要知道的是目标 so 库的基址在什么地方，这样我们才可以通过在 ida 中静态分析找到的 hook 点的偏移，来找到 hook 点的虚拟内存地址，而这可以通过遍历 maps 来实现</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> libname<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 获取 hook-server 的 pid, 这样可以通过本地 libc 库函数地址 - 本地 libc 基址 + 远程 libc 基址 得到远程 libc 库函数地址</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        pid<span class="token operator">=</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">char</span> maps<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">void</span><span class="token operator">*</span> base_addr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">snprintf</span><span class="token punctuation">(</span>maps<span class="token punctuation">,</span>MAX_PATH<span class="token punctuation">,</span><span class="token string">"/proc/%d/maps"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    FILE <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>maps<span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">char</span> line<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span><span class="token punctuation">,</span>name<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>base<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">feof</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token function">memset</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>MAX_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function">fgets</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span>MAX_PATH<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">//printf("%s\n",line);</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// 查找指定模块是否在某行出现</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span>libname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">//maps 形式: base-end [rwxsp] offset dev inode pathname</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token comment">//eg. 6f1305e000-6f13060000 r-xp 00000000 fe:2e 90655 /lib/arm64/liboacia.so</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token comment">/*</span></pre></td></tr><tr><td data-num="22"></td><td><pre>             * https://man7.org/linux/man-pages/man5/proc_pid_maps.5.html</pre></td></tr><tr><td data-num="23"></td><td><pre>             * The [offset] field is the offset into the file/whatever;</pre></td></tr><tr><td data-num="24"></td><td><pre>             * [dev] is the device (major:minor);</pre></td></tr><tr><td data-num="25"></td><td><pre>             * [inode] is the inode on that device.  0 indicates that no inode is associated with the memory</pre></td></tr><tr><td data-num="26"></td><td><pre>             * region, as would be the case with BSS (uninitialized data).</pre></td></tr><tr><td data-num="27"></td><td><pre>             * If  the [pathname] field is blank, this is an anonymous mapping as obtained</pre></td></tr><tr><td data-num="28"></td><td><pre>             * via the mmap(2) function.  There is no easy way to coordinate this back to</pre></td></tr><tr><td data-num="29"></td><td><pre>             * a process's source, short of running it through gdb(1), strace(1), or similar.*/</pre></td></tr><tr><td data-num="30"></td><td><pre>            base <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 以 `-` 为分隔符，读取基址</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            base_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">strtoul</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[maps] find module [%s] base at 0x%08lx\n"</span><span class="token punctuation">,</span>libname<span class="token punctuation">,</span>base_addr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">return</span> base_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/frida-inline-hook/image-20240819160333432.png" alt="image-20240819160333432" style="aspect-ratio:737 / 62;"></p>
<p>现在我们尝试去读取一下 hook 点的汇编，来看看 ptrace 究竟有没有生效，这可以通过 <code>PTRACE_PEEKTEXT</code>  来实现</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">ptraceReadData</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span> addr<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token class-name">size_t</span> len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">size_t</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">long</span> rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        rdata<span class="token operator">=</span><span class="token function">ptrace</span><span class="token punctuation">(</span>PTRACE_PEEKTEXT<span class="token punctuation">,</span>pid<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>addr<span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>rdata<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/frida-inline-hook/image-20240819162616719.png" alt="image-20240819162616719" style="aspect-ratio:794 / 280;"></p>
<p>nice, 将通过 ptrace 读取的汇编和 ida 中反编译出来的汇编对比一下，简直就是一模一样～</p>
<p><img data-src="/frida-inline-hook/image-20240819162708924.png" alt="image-20240819162708924" style="aspect-ratio:1194 / 240;"></p>
<h2 id="为字符串分配内存"><a class="anchor" href="#为字符串分配内存">#</a> 为字符串分配内存</h2>
<p>接下来我们需要通过 <code>dlopen</code>  加载我们的功能库 so, 而这必定会涉及到字符串相关的内存，为了让目标字符串可以被远程的进程访问到，所以我们必须要通过 <code>mmap</code>  在远程的进程空间中分配一块属于我们自己的，可以自由操控的内存</p>
<p>在这之前，我们先对当前的寄存器环境进行保存，以便之后可以还原寄存器的环境</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">ptraceGetRegs</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">user_pt_regs</span> <span class="token operator">*</span>regs_addr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">iovec</span> io<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    io<span class="token punctuation">.</span>iov_base <span class="token operator">=</span> regs_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    io<span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">user_pt_regs</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">//NT_PRSTATUS: general-purpose registers, 定义在 elf.h 中</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre>     * PTRACE_GETREGSET</pre></td></tr><tr><td data-num="8"></td><td><pre>     * 读取被追踪者寄存器。addr 参数决定读取寄存器的类型。</pre></td></tr><tr><td data-num="9"></td><td><pre>     * 如果 addr 是 NT_PRSTATUS，则读取通用寄存器。</pre></td></tr><tr><td data-num="10"></td><td><pre>     * 如果 addr 是 NT_foo，则读取浮点或向量寄存器（如果有的话)。data 参数指向 iovec 类型：</pre></td></tr><tr><td data-num="11"></td><td><pre>     */</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ptrace</span><span class="token punctuation">(</span>PTRACE_GETREGSET<span class="token punctuation">,</span>pid<span class="token punctuation">,</span>NT_PRSTATUS<span class="token punctuation">,</span><span class="token operator">&amp;</span>io<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Get regs failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">void</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">user_pt_regs</span> oldRegs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">user_pt_regs</span> regs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 保存寄存器环境</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">ptraceGetRegs</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token operator">&amp;</span>oldRegs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>regs<span class="token punctuation">,</span><span class="token operator">&amp;</span>oldRegs<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">user_pt_regs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>接下来我们去获取一下 <code>mmap</code>  在远程空间中的位置，在 <code>android</code>  中， <code>mmap</code>  是在 libc 库中被定义的，具体的位置是在 <code>/apex/com.android.runtime/lib64/bionic/libc.so</code> , 由于 mmap 在 <code>libc.so</code>  中的相对偏移是固定的，而我们可以在 <code>hook-server</code>  内部直接获取到 mmap 函数的本地地址 (利用 <code>*mmap</code>  获取函数指针即可实现), 所以我们再读取一下 <code>hook-server</code>  中的 <code>libc.so</code>  的基址，相减即可得到 mmap 函数的相对偏移，把这个相对偏移再加上被 hook 的进程中的 <code>libc.so</code>  的基址，不就可以得到 mmap 函数在远程进程中的地址咯</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">getRemoteLibFunc</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> libname<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span> LocalFuncAddr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">void</span> <span class="token operator">*</span>LocalLibBase<span class="token punctuation">,</span><span class="token operator">*</span>RemoteLibBase<span class="token punctuation">,</span><span class="token operator">*</span>RemoteFuncAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    LocalLibBase <span class="token operator">=</span> <span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>libname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//-1 表示在当前 hook-server 的 maps 中寻找库的基址</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    RemoteLibBase <span class="token operator">=</span> <span class="token function">findModuleByName</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>libname<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    RemoteFuncAddr <span class="token operator">=</span> LocalFuncAddr<span class="token operator">-</span>LocalLibBase<span class="token operator">+</span>RemoteLibBase<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"LocalLibBase: 0x%08lx, LocalFuncAddr: 0x%08lx\nRemoteLibBase: 0x%08lx, func offset: 0x%08lx\n"</span><span class="token punctuation">,</span>LocalLibBase<span class="token punctuation">,</span>LocalFuncAddr<span class="token punctuation">,</span>RemoteLibBase<span class="token punctuation">,</span>LocalFuncAddr<span class="token operator">-</span>LocalLibBase<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span> RemoteFuncAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">void</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 通过 mmap 为跳板分配内存</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">void</span><span class="token operator">*</span> RemoteMmapAddr <span class="token operator">=</span> <span class="token function">getRemoteLibFunc</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token string">"libc.so"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>mmap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[libc] find remote mmap addr at 0x%08lx\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>RemoteMmapAddr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>随后再去设置一下寄存器和 pc 的值，mmap 就能被我们成功的调用了，ptrace 主动调用的细节可以看我写的注释↓</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CPSR_T_MASK</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1u</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ARM_lr</span> <span class="token expression">regs<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token function">ptraceCall</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span> funcaddr<span class="token punctuation">,</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">long</span><span class="token operator">*</span> argv<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">user_pt_regs</span> <span class="token operator">*</span>regs<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 比八个参数多的话，多出的参数通过栈去传参</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>argc<span class="token operator">></span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        regs<span class="token operator">-></span>sp <span class="token operator">=</span>regs<span class="token operator">-></span>sp <span class="token operator">-</span> <span class="token punctuation">(</span>argc<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 申请 8 个寄存器的栈空间</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token function">ptraceWriteData</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>regs<span class="token operator">-></span>sp<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>argv<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>argc<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 少于 8 个参数，就通过 x0~x7 寄存器去传参</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        regs<span class="token operator">-></span>regs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    regs<span class="token operator">-></span>pc <span class="token operator">=</span> <span class="token punctuation">(</span>__u64<span class="token punctuation">)</span> funcaddr<span class="token punctuation">;</span><span class="token comment">// 将 pc 寄存器的值修改为函数地址，这样我们就可以跳转到函数的目标地址去执行 arm64 指令了</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[ptraceCall] funcaddr: 0x%08lx\n"</span><span class="token punctuation">,</span>regs<span class="token operator">-></span>pc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>regs<span class="token operator">-></span>pc<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">//thumb 模式</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 当 pc 的最后一位为 1, 即 pc 为奇数时，设置 pstate CPSR 的 T 标志位为 1, 表示接下来的指令以 thumb 模式执行</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        regs<span class="token operator">-></span>pc<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">//pstate, 这是 arm64v8a 的叫法，在 armv7a 中叫 CPSR 寄存器</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">//more-> https://blog.csdn.net/longwang155069/article/details/105204547</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        regs<span class="token operator">-></span>pstate<span class="token operator">|=</span>CPSR_T_MASK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">//arm 模式</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// 当 pc 的最后一位为 0, 即 pc 为偶数时，清除 pstate CPSR 的 T 标志位，表示接下来的指令以 arm 模式执行</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        regs<span class="token operator">-></span>pstate<span class="token operator">&amp;=</span><span class="token operator">~</span>CPSR_T_MASK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    regs<span class="token operator">-></span>ARM_lr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 设置 lr 寄存器为 0, 要是函数执行完毕之后返回 0 地址会抛出异常，这个异常在后面是有用的</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token function">ptraceSetRegs</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置寄存器的值，把函数的参数和地址传进寄存器里面</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">int</span> stat <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="33"></td><td><pre>     * 对于使用 ptrace_cont 重新运行的进程，它会在 3 种情况下进入暂停状态</pre></td></tr><tr><td data-num="34"></td><td><pre>     * 1. 下一次系统调用</pre></td></tr><tr><td data-num="35"></td><td><pre>     * 2. 子进程退出</pre></td></tr><tr><td data-num="36"></td><td><pre>     * 3. 子进程的执行发生错误</pre></td></tr><tr><td data-num="37"></td><td><pre>     * 这里的 0xb7f 我们可以拆分成两部分来看，后 2 字节 0x7f, 表示进程进入了暂停的状态</pre></td></tr><tr><td data-num="38"></td><td><pre>     * (如果后两字节是 0x00 则表示子进程退出状态), 而前两字节 0xb, 表示进程发送的错误信号为 11 (SIGSEGV),</pre></td></tr><tr><td data-num="39"></td><td><pre>     * 即内存访问异常，因为我们之前将 lr 寄存器的值设为了 0, 所以当远程函数调用完毕之后会抛出异常，</pre></td></tr><tr><td data-num="40"></td><td><pre>     * 当 ptrace 收到这个异常信号时，就知道远程函数调用以及完成了～</pre></td></tr><tr><td data-num="41"></td><td><pre>     */</pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span>stat<span class="token operator">!=</span><span class="token number">0xb7f</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token function">ptraceContinue</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 让被 ptrace 的线程开始运行</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token operator">&amp;</span>stat<span class="token punctuation">,</span>WUNTRACED<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[ptraceCall] stat: 0x%04x\n"</span><span class="token punctuation">,</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token function">ptraceGetRegs</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 当远程函数调用完成之后，读取寄存器获取返回值</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token keyword">void</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token comment">// 调用 mmap 函数</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">long</span> paras<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    paras<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    paras<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x1000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    paras<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span>PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token operator">|</span>PROT_EXEC<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    paras<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>MAP_ANONYMOUS<span class="token operator">|</span>MAP_PRIVATE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    paras<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    paras<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token function">ptraceCall</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>RemoteMmapAddr<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span>paras<span class="token punctuation">,</span><span class="token operator">&amp;</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">void</span> <span class="token operator">*</span>RemoteMemAddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>regs<span class="token punctuation">.</span>regs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//mmap 返回值存储在 x0 中，从 x0 获取远程的 mmap 函数分配的内存</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[libc] mmap alloc memory at 0x%08lx\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>RemoteMemAddr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/frida-inline-hook/image-20240820155113179.png" alt="image-20240820155113179" style="aspect-ratio:780 / 252;"></p>
<h2 id="加载hook功能库so"><a class="anchor" href="#加载hook功能库so">#</a> 加载 hook 功能库 so</h2>
<p>现在我们已经通过 mmap 成功的在被 hook 进程中分配了一块内存，接下来要做的是在被 hook 进程中加载我们的 hook 功能库 so, 这个 so 是跳板最终要跳往的地方，用来执行打印或修改寄存器的操作，我们现在就把这个 so 的名称叫做 <code>libhook-agent.so</code>  吧，当前代码如下，通过远程调用 <code>work_func</code>  来观察我们的 so 是否被成功的加载进来</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//hook-agent.c</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/log.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOG_TAG</span> <span class="token string">"hook-agent"</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGD</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_DEBUG  <span class="token punctuation">,</span> LOG_TAG<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">int</span> <span class="token function">work_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"call work_func ok!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">777</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>首先我们先获取一下 <code>dlopen</code>  在远程进程中的地址，随后将要加载的 so 的绝对地址写入 mmap 分配的内存中，再去调用 ptrace 调用一下 <code>dlopen</code>  函数就可以啦</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 获取 dlopen 在远程进程中的地址</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> RemoteDlopenAddr <span class="token operator">=</span> <span class="token function">getRemoteLibFunc</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token string">"libdl.so"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>dlopen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[libdl] find remote dlopen addr at 0x%08lx\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>RemoteDlopenAddr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  * 将要加载的 so 的绝对地址写入 mmap 分配的内存中，可以把 so 放在 app 的私有目录下面，</pre></td></tr><tr><td data-num="7"></td><td><pre>  * 要是放在 /data/local/tmp 目录下面，会遇到 avc denied, </pre></td></tr><tr><td data-num="8"></td><td><pre>  * 这个时候需要使用 setenforce 0 临时禁用掉 selinux 才可以</pre></td></tr><tr><td data-num="9"></td><td><pre>*/</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">ptraceWriteData</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>RemoteMemAddr<span class="token punctuation">,</span><span class="token string">"/data/data/com.oacia.apk_protect/libhook-agent.so"</span><span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"/data/data/com.oacia.apk_protect/libhook-agent.so"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 调用 dlopen 函数</span></pre></td></tr><tr><td data-num="13"></td><td><pre>paras<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> RemoteMemAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>paras<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>RTLD_NOW<span class="token operator">|</span>RTLD_GLOBAL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token function">ptraceCall</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>RemoteDlopenAddr<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>paras<span class="token punctuation">,</span><span class="token operator">&amp;</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span>HookAgentAddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>regs<span class="token punctuation">.</span>regs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//dlopen 返回值存储在 x0 中，从 x0 获取远程的 dlopen 返回的 handle</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[libdl] dlopen libhook-agent.so addr: 0x%08lx\n\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>HookAgentAddr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><code>HookAgentAddr</code>  的值不为空，说明 <code>libhook-agent.so</code>  被成功的加载了进来</p>
<p><img data-src="/frida-inline-hook/image-20240826150146133.png" alt="image-20240826150146133" style="aspect-ratio:798 / 129;"></p>
<p>随后我们再使用远程进程的 <code>dlsym</code> , 找到 <code>libhook-agent.so</code>  功能函数的地址，并主动调用 <code>work_func</code>  来看一下情况</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//dlsym 获取调用函数的地址</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> RemoteDlsymAddr <span class="token operator">=</span> <span class="token function">getRemoteLibFunc</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token string">"libdl.so"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>dlsym<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[libdl] find remote dlsym addr at 0x%08lx\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>RemoteDlsymAddr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 将被调用函数的函数名写入 mmap 分配的内存中</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">ptraceWriteData</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>RemoteMemAddr<span class="token punctuation">,</span><span class="token string">"work_func"</span><span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"work_func"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>paras<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> HookAgentAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>paras<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> RemoteMemAddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">ptraceCall</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>RemoteDlsymAddr<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>paras<span class="token punctuation">,</span><span class="token operator">&amp;</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> remoteFuncAddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>regs<span class="token punctuation">.</span>regs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[libdl] dlsym find hook-agent function addr at 0x%08lx\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>remoteFuncAddr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token function">ptraceCall</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>remoteFuncAddr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>paras<span class="token punctuation">,</span><span class="token operator">&amp;</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 主动调用 hook-agent 中的 work_func</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">int</span> checkOK <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>regs<span class="token punctuation">.</span>regs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"call wrok_func in libhook-agent.so, ret -> %d\n"</span><span class="token punctuation">,</span>checkOK<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>nice! 函数被成功的调用了，并且返回值也是和 <code>work_func</code>  中的返回值一模一样</p>
<p><img data-src="/frida-inline-hook/image-20240826153126695.png" alt="image-20240826153126695" style="aspect-ratio:830 / 157;"></p>
<p>而此时的 logcat, 也有日志被正确的打印出来</p>
<p><img data-src="/frida-inline-hook/image-20240826153223819.png" alt="image-20240826153223819" style="aspect-ratio:1089 / 36;"></p>
<h2 id="在hook点patch上跳板"><a class="anchor" href="#在hook点patch上跳板">#</a> 在 hook 点 patch 上跳板</h2>
<blockquote>
<p>现在我们需要在 hook 点 patch 跳板，目前来看最初使用的跨进程通过 ptrace 的 <code>PTRACE_POKETEXT</code>  在进程中写入跳板的方式，似乎是存在 bug 的，写入字节的次数的过多的话被 hook 进程就会崩溃，并且跨进程通过 ptrace 调用 <code>mprotect</code>  将 hook 处的页属性改为 <code>rwx</code>  没有生效，写入时进程就会崩溃</p>
</blockquote>
<details class="info"><summary>通过ptrace的`PTRACE_POKETEXT`进行patch</summary><div>
<p>接下来我们使用 <code>X16</code>  寄存器，在 hook 点 patch 上一级跳板，这个一级跳板将会跳往二级跳板</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">write_trampoline_stage1</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span> target<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> libname<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> save_code<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">void</span><span class="token operator">*</span> RemoteLibBase <span class="token operator">=</span> <span class="token function">findModuleByName</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>libname<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">long</span> hook_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>RemoteLibBase<span class="token operator">+</span>offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 生成跳板函数</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> trampoline<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token comment">//LDR X16,#0x8</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x1f</span><span class="token punctuation">,</span><span class="token number">0xD6</span><span class="token punctuation">,</span><span class="token comment">//BR X16</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        trampoline<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>target<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 读取即将被覆盖的指令</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">ptraceReadData</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> hook_addr<span class="token punctuation">,</span> save_code<span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 写入跳板</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">ptraceWriteData</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> hook_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>trampoline<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">// 写入一级跳板汇编</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">char</span> save_code<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 保存被跳板覆盖的指令，在完成 hook 之后这 4 行汇编需要被执行</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token function">memset</span><span class="token punctuation">(</span>save_code<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token function">write_trampoline_stage1</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>RemoteMemAddr<span class="token punctuation">,</span><span class="token string">"liboacia.so"</span><span class="token punctuation">,</span><span class="token number">0x10B0</span><span class="token punctuation">,</span>save_code<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>在二级跳板这里，我们直接将保存寄存器环境，跳往功能函数，恢复寄存器环境，执行被跳板覆盖的汇编的这四个过程直接合在一起</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">write_trampoline_stage2</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span> patch_addr<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> libname<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> save_code<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span> hook_agent_func_addr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">void</span><span class="token operator">*</span> RemoteLibBase <span class="token operator">=</span> <span class="token function">findModuleByName</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>libname<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">long</span> hook_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>RemoteLibBase<span class="token operator">+</span>offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">long</span> ret_addr <span class="token operator">=</span> hook_addr<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 生成跳板函数，trampoline bytes are from frida hook decompile</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">char</span> trampoline<span class="token punctuation">[</span><span class="token number">360</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token comment">// 保存寄存器环境</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0xd1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0x7f</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token number">0xfc</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token number">0xfa</span><span class="token punctuation">,</span><span class="token number">0x6f</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x5f</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token number">0xf4</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token number">0xf2</span><span class="token punctuation">,</span><span class="token number">0x4f</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0x47</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token number">0xee</span><span class="token punctuation">,</span><span class="token number">0x3f</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token number">0xec</span><span class="token punctuation">,</span><span class="token number">0x37</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token number">0xea</span><span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token number">0xe8</span><span class="token punctuation">,</span><span class="token number">0x27</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token number">0xe6</span><span class="token punctuation">,</span><span class="token number">0x1f</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token number">0xe4</span><span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0x0f</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token number">0xfd</span><span class="token punctuation">,</span><span class="token number">0x7b</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token number">0xfb</span><span class="token punctuation">,</span><span class="token number">0x73</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token number">0xf7</span><span class="token punctuation">,</span><span class="token number">0x63</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token number">0xf5</span><span class="token punctuation">,</span><span class="token number">0x5b</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token number">0xf3</span><span class="token punctuation">,</span><span class="token number">0x53</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token number">0xf1</span><span class="token punctuation">,</span><span class="token number">0x4b</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token number">0xef</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token number">0xed</span><span class="token punctuation">,</span><span class="token number">0x3b</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token number">0xe9</span><span class="token punctuation">,</span><span class="token number">0x2b</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token number">0xe7</span><span class="token punctuation">,</span><span class="token number">0x23</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token number">0xe5</span><span class="token punctuation">,</span><span class="token number">0x1b</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token number">0xe3</span><span class="token punctuation">,</span><span class="token number">0x13</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token number">0xe1</span><span class="token punctuation">,</span><span class="token number">0x0b</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0x3b</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token number">0xe1</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0x0c</span><span class="token punctuation">,</span><span class="token number">0x91</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0x8f</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token number">0xfd</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token number">0xfd</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0x0c</span><span class="token punctuation">,</span><span class="token number">0x91</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token number">0xe1</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x91</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0x23</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x91</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token number">0xe3</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0x0c</span><span class="token punctuation">,</span><span class="token number">0x91</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token comment">// 跳转到核心代码</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0x11</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token number">0x64</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x3f</span><span class="token punctuation">,</span><span class="token number">0xd6</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token comment">// 还原寄存器环境</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x91</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token number">0xe1</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0x1b</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token number">0xe1</span><span class="token punctuation">,</span><span class="token number">0x0b</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token number">0xe3</span><span class="token punctuation">,</span><span class="token number">0x13</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token number">0xe5</span><span class="token punctuation">,</span><span class="token number">0x1b</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token number">0xe7</span><span class="token punctuation">,</span><span class="token number">0x23</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token number">0xe9</span><span class="token punctuation">,</span><span class="token number">0x2b</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token number">0xed</span><span class="token punctuation">,</span><span class="token number">0x3b</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token number">0xef</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            <span class="token number">0xf1</span><span class="token punctuation">,</span><span class="token number">0x4b</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token number">0xf3</span><span class="token punctuation">,</span><span class="token number">0x53</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            <span class="token number">0xf5</span><span class="token punctuation">,</span><span class="token number">0x5b</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token number">0xf7</span><span class="token punctuation">,</span><span class="token number">0x63</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            <span class="token number">0xfb</span><span class="token punctuation">,</span><span class="token number">0x73</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token number">0xfd</span><span class="token punctuation">,</span><span class="token number">0x7b</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            <span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0x0f</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token number">0xe4</span><span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token number">0xe6</span><span class="token punctuation">,</span><span class="token number">0x1f</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            <span class="token number">0xe8</span><span class="token punctuation">,</span><span class="token number">0x27</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token number">0xea</span><span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="81"></td><td><pre>            <span class="token number">0xec</span><span class="token punctuation">,</span><span class="token number">0x37</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token number">0xee</span><span class="token punctuation">,</span><span class="token number">0x3f</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="83"></td><td><pre>            <span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0x47</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token number">0xf2</span><span class="token punctuation">,</span><span class="token number">0x4f</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="85"></td><td><pre>            <span class="token number">0xf4</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="86"></td><td><pre>            <span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x5f</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="87"></td><td><pre>            <span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="88"></td><td><pre>            <span class="token number">0xfa</span><span class="token punctuation">,</span><span class="token number">0x6f</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token number">0xfc</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="90"></td><td><pre>            <span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0x7f</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="91"></td><td><pre>            <span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0x47</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>            <span class="token comment">// 执行先前因 patch 跳板被覆盖的代码，16 字节占位</span></pre></td></tr><tr><td data-num="94"></td><td><pre>            <span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="95"></td><td><pre>            <span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="96"></td><td><pre>            <span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="97"></td><td><pre>            <span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre>            <span class="token comment">// 返回 hook 点之后的位置继续执行逻辑</span></pre></td></tr><tr><td data-num="100"></td><td><pre>            <span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="101"></td><td><pre>            <span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x1f</span><span class="token punctuation">,</span><span class="token number">0xD6</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>            <span class="token comment">//8 字节占位，存储功能函数的地址</span></pre></td></tr><tr><td data-num="104"></td><td><pre>            <span class="token number">0xbb</span><span class="token punctuation">,</span><span class="token number">0xbb</span><span class="token punctuation">,</span><span class="token number">0xbb</span><span class="token punctuation">,</span><span class="token number">0xbb</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="105"></td><td><pre>            <span class="token number">0xbb</span><span class="token punctuation">,</span><span class="token number">0xbb</span><span class="token punctuation">,</span><span class="token number">0xbb</span><span class="token punctuation">,</span><span class="token number">0xbb</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre>            <span class="token comment">//8 字节占位，存储功能 hook 完成后返回到原来程序的地址</span></pre></td></tr><tr><td data-num="108"></td><td><pre>            <span class="token number">0xcc</span><span class="token punctuation">,</span><span class="token number">0xcc</span><span class="token punctuation">,</span><span class="token number">0xcc</span><span class="token punctuation">,</span><span class="token number">0xcc</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="109"></td><td><pre>            <span class="token number">0xcc</span><span class="token punctuation">,</span><span class="token number">0xcc</span><span class="token punctuation">,</span><span class="token number">0xcc</span><span class="token punctuation">,</span><span class="token number">0xcc</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="110"></td><td><pre></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">16</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>        trampoline<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">320</span><span class="token punctuation">]</span> <span class="token operator">=</span> save_code<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        trampoline<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">344</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>hook_agent_func_addr<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="118"></td><td><pre></pre></td></tr><tr><td data-num="119"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>        trampoline<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">352</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>ret_addr<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    </pre></td></tr><tr><td data-num="123"></td><td><pre>    <span class="token function">ptraceWriteData</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> patch_addr<span class="token punctuation">,</span> trampoline<span class="token punctuation">,</span> <span class="token number">360</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div></details>
<p>所以可以想想换一种方法，既然 so 可以注入进去，那就直接在 so 加载的时候，通过 <code>__attribute__((constructor))</code> , 在通过这个 so 在被 hook 进程内部执行 patch 跳板的逻辑不就可以了</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 完成一次完整的 hook, 需要先由 hook 点的一级跳板跳转到二级跳板的位置，</pre></td></tr><tr><td data-num="3"></td><td><pre> * 一级跳板通过 BR X16 跳往二级跳板，二级跳板保存寄存器的环境，跳转到 hook 的</pre></td></tr><tr><td data-num="4"></td><td><pre> * 功能函数位置，随后还原寄存器环境，并执行先前被覆盖的四条汇编</pre></td></tr><tr><td data-num="5"></td><td><pre> * , 随后通过 BR X16 寄存器，跳往 hook 点之后的位置，完成一次完整的 hook</pre></td></tr><tr><td data-num="6"></td><td><pre> *</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">ctor</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    u_long hook_addr <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"liboacia.so"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0x10B8</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"hook-agent init!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">extern</span> u_long _trampoline_<span class="token punctuation">,</span>_shellcode_addr_<span class="token punctuation">,</span>_shellcode_start_<span class="token punctuation">,</span>_shellcode_end_<span class="token punctuation">,</span>_origin_patched_code_<span class="token punctuation">,</span>_hook_main_func_addr_<span class="token punctuation">,</span>_hook_finish_return_addr_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    u_long total_len <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token operator">&amp;</span>_shellcode_end_ <span class="token operator">-</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token operator">&amp;</span>_shellcode_start_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"shellcode len: %lu, hook_addr: 0x%08lx,offset: 0x%04x"</span><span class="token punctuation">,</span>total_len<span class="token punctuation">,</span>hook_addr<span class="token punctuation">,</span><span class="token number">0x10B8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 为 shellcode 分配内存</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    u_long page_size <span class="token operator">=</span> <span class="token function">getpagesize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    u_long shellcode_mem_start <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> page_size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE <span class="token operator">|</span> PROT_EXEC<span class="token punctuation">,</span> MAP_ANONYMOUS <span class="token operator">|</span> MAP_PRIVATE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>shellcode_mem_start<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> page_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>shellcode_mem_start<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_shellcode_start_<span class="token punctuation">,</span> total_len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"_shellcode_addr_: 0x%08lx,shellcode_mem_start: 0x%08lx"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span>u_long<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_shellcode_addr_<span class="token punctuation">,</span> shellcode_mem_start<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 尝试了一下好像没有办法给_shellcode_addr_赋值 (很奇怪)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 所以索性直接这样赋值了 *(u_long*)(hook_addr + 8) = shellcode_mem_start;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">//*(u_long*)&amp;_shellcode_addr_ = (u_long)shellcode_mem_start;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 通过相对偏移的方式，定位到需要替换的地址在 mmap 分配的内存中的地址</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    u_long mem_hook_main_func_addr_ <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token operator">&amp;</span>_hook_main_func_addr_ <span class="token operator">-</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token operator">&amp;</span>_shellcode_start_ <span class="token operator">+</span> shellcode_mem_start<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    u_long mem_origin_patched_code_ <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token operator">&amp;</span>_origin_patched_code_ <span class="token operator">-</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token operator">&amp;</span>_shellcode_start_ <span class="token operator">+</span> shellcode_mem_start<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    u_long mem_hook_finish_return_addr_ <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token operator">&amp;</span>_hook_finish_return_addr_ <span class="token operator">-</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token operator">&amp;</span>_shellcode_start_ <span class="token operator">+</span> shellcode_mem_start<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">//hook 的功能函数的地址</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token operator">*</span><span class="token punctuation">(</span>u_long<span class="token operator">*</span><span class="token punctuation">)</span>mem_hook_main_func_addr_ <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span>hook_main<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 被跳板覆盖前，hook 点的 16 字节</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token operator">*</span><span class="token punctuation">(</span>u_long<span class="token operator">*</span><span class="token punctuation">)</span>mem_origin_patched_code_ <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>u_long<span class="token operator">*</span><span class="token punctuation">)</span>hook_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token operator">*</span><span class="token punctuation">(</span>u_long<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mem_origin_patched_code_ <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>u_long<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>hook_addr <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">//hook 执行完毕后的返回地址</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token operator">*</span><span class="token punctuation">(</span>u_long<span class="token operator">*</span><span class="token punctuation">)</span>mem_hook_finish_return_addr_ <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span>hook_addr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">//patch 上我们的跳板</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    u_long entry_page_start <span class="token operator">=</span> <span class="token punctuation">(</span>u_long<span class="token punctuation">)</span><span class="token punctuation">(</span>hook_addr<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token punctuation">(</span>page_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">mprotect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_long<span class="token operator">*</span><span class="token punctuation">)</span>entry_page_start<span class="token punctuation">,</span> page_size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE <span class="token operator">|</span> PROT_EXEC<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token operator">*</span><span class="token punctuation">(</span>u_long<span class="token operator">*</span><span class="token punctuation">)</span>hook_addr <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>u_long<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_trampoline_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token operator">*</span><span class="token punctuation">(</span>u_long<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>hook_addr <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> shellcode_mem_start<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>相关的 shellcode 如下，在保存寄存器环境时，CPSR 寄存器也要一起保存，但是看 frida hook 之后的样子，只需要保存 NZCV 寄存器就足够了，所以这里也不对 CPSR 寄存器的其他字段作保存了</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>#在hook点patch上跳板<span class="token punctuation">,</span>跳转到我们的shellcode</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">.</span>global _trampoline_</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">shellcode</span><span class="token expression">所在的地址<span class="token punctuation">,</span>跳板需要跳转到shellcode</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">.</span>global _shellcode_addr_</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">shellcode</span><span class="token expression">的起始地址和结束地址<span class="token punctuation">,</span>用来定位shellcode的大小以及字节</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">.</span>global _shellcode_start_</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">.</span>global _shellcode_end_</pre></td></tr><tr><td data-num="8"></td><td><pre>#被跳板覆盖的<span class="token number">16</span>字节指令<span class="token punctuation">,</span>这些指令我们需要在hook完成之后再次执行<span class="token punctuation">,</span>才不会影响到原本的逻辑</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">.</span>global _origin_patched_code_</pre></td></tr><tr><td data-num="10"></td><td><pre>#跳转到hook的核心功能函数的地址去执行读取寄存器<span class="token operator">/</span>修改寄存器等操作</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">.</span>global _hook_main_func_addr_</pre></td></tr><tr><td data-num="12"></td><td><pre>#当所有的hook逻辑执行完毕之后<span class="token punctuation">,</span>需要返回到hook点后<span class="token number">16</span>字节的位置去执行后续的指令</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">.</span>global _hook_finish_return_addr_</pre></td></tr><tr><td data-num="14"></td><td><pre>_trampoline_<span class="token operator">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    LDR X16<span class="token punctuation">,</span> SHELLCODE_ADDR</pre></td></tr><tr><td data-num="16"></td><td><pre>    BR x16</pre></td></tr><tr><td data-num="17"></td><td><pre>#这里需要先声明SHELLCODE_ADDR的地址<span class="token punctuation">,</span>否则会出现ld<span class="token operator">:</span> error<span class="token operator">:</span> relocation R_AARCH64_LD_PREL_LO19 cannot be used against symbol <span class="token char">'_shellcode_addr_'</span></pre></td></tr><tr><td data-num="18"></td><td><pre>#就是说不能用已经声明过全局的符号来作重定位</pre></td></tr><tr><td data-num="19"></td><td><pre>SHELLCODE_ADDR<span class="token operator">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>_shellcode_addr_<span class="token operator">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">.</span>dword <span class="token number">0x1234567812345678</span></pre></td></tr><tr><td data-num="22"></td><td><pre>_shellcode_start_<span class="token operator">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    #本来想参考https<span class="token operator">:</span><span class="token comment">//github.com/zzyccs/inlineHook/blob/master/app/src/main/cpp/inline_shellcode.S</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    #手动通过STP寄存器的大小一个一个算出存入堆栈的地址的</pre></td></tr><tr><td data-num="25"></td><td><pre>    #但是看了一下frida<span class="token punctuation">,</span>直接用STP Xt1<span class="token punctuation">,</span> Xt2<span class="token punctuation">,</span> <span class="token punctuation">[</span>Xn<span class="token operator">|</span>SP<span class="token punctuation">,</span> #imm<span class="token punctuation">]</span><span class="token operator">!</span> <span class="token punctuation">;</span> <span class="token number">64</span><span class="token operator">-</span>bit</pre></td></tr><tr><td data-num="26"></td><td><pre>    #这种预索引的方式修改SP的值<span class="token punctuation">,</span>这样就不需要size<span class="token operator">*</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">*</span><span class="token number">1.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>的方式去计算寄存器存储的位置</pre></td></tr><tr><td data-num="27"></td><td><pre>    #可以达到持续入栈的效果<span class="token punctuation">,</span>太厉害啦</pre></td></tr><tr><td data-num="28"></td><td><pre>    STP             Q30<span class="token punctuation">,</span> Q31<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    STP             Q28<span class="token punctuation">,</span> Q29<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    STP             Q26<span class="token punctuation">,</span> Q27<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    STP             Q24<span class="token punctuation">,</span> Q25<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    STP             Q22<span class="token punctuation">,</span> Q23<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    STP             Q20<span class="token punctuation">,</span> Q21<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    STP             Q18<span class="token punctuation">,</span> Q19<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    STP             Q16<span class="token punctuation">,</span> Q17<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    STP             Q14<span class="token punctuation">,</span> Q15<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    STP             Q12<span class="token punctuation">,</span> Q13<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    STP             Q10<span class="token punctuation">,</span> Q11<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    STP             Q8<span class="token punctuation">,</span> Q9<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    STP             Q6<span class="token punctuation">,</span> Q7<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    STP             Q4<span class="token punctuation">,</span> Q5<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    STP             Q2<span class="token punctuation">,</span> Q3<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    STP             Q0<span class="token punctuation">,</span> Q1<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    STP             X30<span class="token punctuation">,</span> X31<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    STP             X28<span class="token punctuation">,</span> X29<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    STP             X26<span class="token punctuation">,</span> X27<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    STP             X24<span class="token punctuation">,</span> X25<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    STP             X22<span class="token punctuation">,</span> X23<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    STP             X20<span class="token punctuation">,</span> X21<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    STP             X18<span class="token punctuation">,</span> X19<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    STP             X16<span class="token punctuation">,</span> X17<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    STP             X14<span class="token punctuation">,</span> X15<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    STP             X12<span class="token punctuation">,</span> X13<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    STP             X10<span class="token punctuation">,</span> X11<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    STP             X8<span class="token punctuation">,</span> X9<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    STP             X6<span class="token punctuation">,</span> X7<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    STP             X4<span class="token punctuation">,</span> X5<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    STP             X2<span class="token punctuation">,</span> X3<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    STP             X0<span class="token punctuation">,</span> X1<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    #特别注意<span class="token punctuation">,</span>CPSR寄存器也要保存<span class="token punctuation">,</span>不然只能打印一次值然后就崩溃了<span class="token operator">-</span>m<span class="token operator">-</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">aarch</span><span class="token expression"><span class="token number">64</span>不能和aarch32一样<span class="token punctuation">,</span>直接访问CPSR得到所有的值<span class="token punctuation">,</span>所以得分开来访问</span></span></pre></td></tr><tr><td data-num="62"></td><td><pre>    #看frida的hook之后的样子<span class="token punctuation">,</span>看上去只需要保存NZCV寄存器就足够了</pre></td></tr><tr><td data-num="63"></td><td><pre>    MRS             X1<span class="token punctuation">,</span> NZCV</pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token expression">MRS             X0<span class="token punctuation">,</span> DAIF</span></span></pre></td></tr><tr><td data-num="65"></td><td><pre>    STP             X0<span class="token punctuation">,</span> X1<span class="token punctuation">,</span><span class="token punctuation">[</span>SP<span class="token punctuation">,</span>#<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">]</span><span class="token operator">!</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>    MOV             X0<span class="token punctuation">,</span> SP</pre></td></tr><tr><td data-num="68"></td><td><pre>    LDR             X16<span class="token punctuation">,</span> HOOK_MAIN_FUNC_ADDR</pre></td></tr><tr><td data-num="69"></td><td><pre>    BLR             X16</pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>    #恢复CPSR寄存器</pre></td></tr><tr><td data-num="72"></td><td><pre>    LDP             X0<span class="token punctuation">,</span> X1<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    MSR             NZCV<span class="token punctuation">,</span> X1</pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token expression">MSR             DAIF<span class="token punctuation">,</span> X0</span></span></pre></td></tr><tr><td data-num="75"></td><td><pre>    #恢复X0<span class="token operator">-</span>X31<span class="token punctuation">,</span>Q0<span class="token operator">-</span>Q31寄存器</pre></td></tr><tr><td data-num="76"></td><td><pre>    LDP             X0<span class="token punctuation">,</span> X1<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    LDP             X2<span class="token punctuation">,</span> X3<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    LDP             X4<span class="token punctuation">,</span> X5<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    LDP             X6<span class="token punctuation">,</span> X7<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    LDP             X8<span class="token punctuation">,</span> X9<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    LDP             X10<span class="token punctuation">,</span> X11<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    LDP             X12<span class="token punctuation">,</span> X13<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    LDP             X14<span class="token punctuation">,</span> X15<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    LDP             X16<span class="token punctuation">,</span> X17<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    LDP             X18<span class="token punctuation">,</span> X19<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    LDP             X20<span class="token punctuation">,</span> X21<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    LDP             X22<span class="token punctuation">,</span> X23<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    LDP             X24<span class="token punctuation">,</span> X25<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    LDP             X26<span class="token punctuation">,</span> X27<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    LDP             X28<span class="token punctuation">,</span> X29<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    LDP             X30<span class="token punctuation">,</span> X31<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x10</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    LDP             Q0<span class="token punctuation">,</span> Q1<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    LDP             Q2<span class="token punctuation">,</span> Q3<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    LDP             Q4<span class="token punctuation">,</span> Q5<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    LDP             Q6<span class="token punctuation">,</span> Q7<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    LDP             Q8<span class="token punctuation">,</span> Q9<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    LDP             Q10<span class="token punctuation">,</span> Q11<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    LDP             Q12<span class="token punctuation">,</span> Q13<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    LDP             Q14<span class="token punctuation">,</span> Q15<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    LDP             Q16<span class="token punctuation">,</span> Q17<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    LDP             Q18<span class="token punctuation">,</span> Q19<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    LDP             Q20<span class="token punctuation">,</span> Q21<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    LDP             Q22<span class="token punctuation">,</span> Q23<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    LDP             Q24<span class="token punctuation">,</span> Q25<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    LDP             Q26<span class="token punctuation">,</span> Q27<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="106"></td><td><pre>    LDP             Q28<span class="token punctuation">,</span> Q29<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    LDP             Q30<span class="token punctuation">,</span> Q31<span class="token punctuation">,</span> <span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span>#<span class="token number">0x20</span></pre></td></tr><tr><td data-num="108"></td><td><pre>_origin_patched_code_<span class="token operator">:</span></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token punctuation">.</span>dword <span class="token number">0x1234567812345678</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token punctuation">.</span>dword <span class="token number">0x1234567812345678</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    LDR             X16<span class="token punctuation">,</span> HOOK_FINISH_RETURN_ADDR</pre></td></tr><tr><td data-num="112"></td><td><pre>    BR              X16</pre></td></tr><tr><td data-num="113"></td><td><pre>HOOK_MAIN_FUNC_ADDR<span class="token operator">:</span></pre></td></tr><tr><td data-num="114"></td><td><pre>_hook_main_func_addr_<span class="token operator">:</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token punctuation">.</span>dword <span class="token number">0x1234567812345678</span></pre></td></tr><tr><td data-num="116"></td><td><pre>HOOK_FINISH_RETURN_ADDR<span class="token operator">:</span></pre></td></tr><tr><td data-num="117"></td><td><pre>_hook_finish_return_addr_<span class="token operator">:</span></pre></td></tr><tr><td data-num="118"></td><td><pre>    <span class="token punctuation">.</span>dword <span class="token number">0x1234567812345678</span></pre></td></tr><tr><td data-num="119"></td><td><pre>_shellcode_end_<span class="token operator">:</span></pre></td></tr></table></figure><h2 id="执行hook逻辑"><a class="anchor" href="#执行hook逻辑">#</a> 执行 hook 逻辑</h2>
<p>这里我们的 hook 逻辑很简单，就是打印调用函数 strlen 之后 X0 的值</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">hook_main</span><span class="token punctuation">(</span>u_long sp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"enter hook main!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">//sp -- sp+0x10 存储的是 NZCV 寄存器，从 sp+0x10 开始才是 x0-x31 的位置</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    u_long strlen_ret_value <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>u_long<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sp<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"hook done! target function strlen return value is 0x%08lx"</span><span class="token punctuation">,</span>strlen_ret_value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>终于现在我们也可以自己完成一次简单的 hook 了！</p>
<p><img data-src="/frida-inline-hook/image-20240829154247205.png" alt="image-20240829154247205" style="aspect-ratio:1238 / 375;"></p>
<p>完整代码已经传到 github 上面啦 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lhL2lubGluZWhvb2tfZGVtbw==">https://github.com/oacia/inlinehook_demo</span></p>
<h1 id="参考资料"><a class="anchor" href="#参考资料">#</a> 参考资料</h1>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9ib29rLmNyaWZhbi5vcmcvYm9va3MvYW5kcm9pZF9yZV9keW5hbWljX2RlYnVnL3dlYnNpdGUvbGxkYl9kZWJ1Z19hbmRyb2lkL2xsZGJfZGVidWdfYW5kcm9pZF9wcm9jZXNzLmh0bWw=">Mac 中：用 lldb 调试安卓 app 进程</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dhbmd5aXl1bmd3L2FydGljbGUvZGV0YWlscy84MTA2OTYzMQ==">【工具使用】Android 调试利器之 LLDB</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9pcmVlLmRldi9kZXZlbG9wZXJzL2RlYnVnZ2luZy9hbmRyb2lkLXdpdGgtbGxkYi8=">Android LLDB debugging</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLnhoeWVheC5jb20vMjAyMi8wNS8wNi9kZWJ1Zy1hbmRyb2lkLWJ5LWdkYi1hbmQtbGxkYi8=">使用 GDB、LLDB 调试安卓程序</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjczMjczLmh0bQ==">[原创] Frida inlineHook 原理分析及简单设计一款 AArch64 inlineHook 工具</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly90b21xdW5jaGFvLmdpdGh1Yi5pby8yMDIxLzAxLzE5L25vdGUvcmV2L2dhbWUtMS8=">Android 下实现 ptrace 注入 &amp; hook</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L015QXJyb3cvYXJ0aWNsZS9kZXRhaWxzLzk2MzAzNzc=">使用 ptrace 向已运行进程中注入.so 并执行相关函数</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1llbGxvd19NYXRyaXgvYXJ0aWNsZS9kZXRhaWxzLzEwNDE2NjI1Nw==">Android 注入要点记录</span></li>
</ul>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2025-04-09 02:55:11" itemprop="dateModified" datetime="2025-04-09T02:55:11+08:00">2025-04-09</time>
  </span>
  <span id="frida-inline-hook/" class="item leancloud_visitors" data-flag-title="frida inline hook原理分析及实践" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>oacia <i class="ic i-at"><em>@</em></i>oaciaのBbBlog~
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://oacia.dev/frida-inline-hook/" title="frida inline hook原理分析及实践">https://oacia.dev/frida-inline-hook/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/bilibili-get-ticket/" itemprop="url" rel="prev" data-background-image="&#x2F;picture&#x2F;684530.webp" title="b站app漫展抢票">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>b站app漫展抢票</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/douyin-6shen-init/" itemprop="url" rel="next" data-background-image="&#x2F;picture&#x2F;24402.webp" title="初探抖音六神之字符串解密算法分析">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>初探抖音六神之字符串解密算法分析</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text"> 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lldb%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-text"> lldb 动态调试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ida%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90hook%E8%B7%B3%E6%9D%BF"><span class="toc-text"> IDA 动态调试分析 hook 跳板</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E8%B7%B3%E6%9D%BF"><span class="toc-text"> 一级跳板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E7%BA%A7%E8%B7%B3%E6%9D%BF"><span class="toc-text"> 二级跳板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E7%BA%A7%E8%B7%B3%E6%9D%BF"><span class="toc-text"> 三级跳板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E5%AF%84%E5%AD%98%E5%99%A8%E7%8E%AF%E5%A2%83"><span class="toc-text"> 保存寄存器环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%B3%E8%BD%AC%E5%88%B0%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-text"> 跳转到核心代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E5%AF%84%E5%AD%98%E5%99%A8%E7%8E%AF%E5%A2%83"><span class="toc-text"> 恢复寄存器环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E6%89%A7%E8%A1%8C%E6%B5%81"><span class="toc-text"> 恢复执行流</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9E%E7%8E%B0inline-hook"><span class="toc-text"> 自实现 inline hook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ptrace%E6%B3%A8%E5%85%A5"><span class="toc-text"> ptrace 注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98"><span class="toc-text"> 为字符串分配内存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BDhook%E5%8A%9F%E8%83%BD%E5%BA%93so"><span class="toc-text"> 加载 hook 功能库 so</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8hook%E7%82%B9patch%E4%B8%8A%E8%B7%B3%E6%9D%BF"><span class="toc-text"> 在 hook 点 patch 上跳板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8Chook%E9%80%BB%E8%BE%91"><span class="toc-text"> 执行 hook 逻辑</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text"> 参考资料</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="oacia"
      data-src="/images/avatar.jpg">
  
  <svg class="logo-overview" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 540.19 380.99">
    <g id="clips" fill= #00a99d; stroke="none">
      <clipPath id="o">
        <path d="M93.57,284c8,0,14.91-1,20.75-3,5.83-2,10.41-3.66,13.75-5,4.66-1.66,6.16-.75,4.5,2.75-1.67,3.5-4.67,6.42-9,8.75-2.34,1.34-6.09,2.84-11.25,4.5-5.17,1.67-11.09,2.5-17.75,2.5-.34,8.67-3.34,16.84-9,24.5-5.67,7.67-13.34,13.34-23,17-6,2.34-12.17,3.59-18.5,3.75-6.34,.17-12.17-.66-17.5-2.5-5.34-1.83-10.09-4.66-14.25-8.5-4.17-3.83-7.25-8.41-9.25-13.75-2-5.33-2.83-11-2.5-17s1.83-11.83,4.5-17.5c2.66-5.66,6.33-10.75,11-15.25,4.66-4.5,10.16-7.75,16.5-9.75,5.66-1.66,11.41-1.66,17.25,0,5.83,1.67,10.08,4.34,12.75,8,1.66,2.67,2.5,5.67,2.5,9,3-2,6.33-3,10-3h1c3.33,0,6.5,.84,9.5,2.5,3,1.67,5.33,4.5,7,8.5l1,3.5Zm-34,39.5c5.66-.66,10.33-3.83,14-9.5,3.66-5.66,5.33-12.16,5-19.5-4.67,.34-9.09-.41-13.25-2.25-4.17-1.83-6.42-4.58-6.75-8.25-.67-3,0-5.5,2-7.5-.67-2.66-2.75-5-6.25-7s-7.09-2.16-10.75-.5c-4.67,2-8.25,5.84-10.75,11.5-2.5,5.67-3.09,11.84-1.75,18.5,1.33,8,4.75,14.34,10.25,19,5.5,4.67,11.58,6.5,18.25,5.5Z"/>
      </clipPath>
      <clipPath id="a1">
        <path d="M176.06,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      <clipPath id="c">
        <path d="M250.06,280.5c4.66-7.66,12-13.16,22-16.5,10-3.33,19.83-3.66,29.5-1,7.66,2.34,13.5,5.67,17.5,10,4,4.34,5.83,8.5,5.5,12.5-.34,4.67-2.25,8.59-5.75,11.75-3.5,3.17-7.09,5.34-10.75,6.5-3.67,1.17-6.84,1.25-9.5,.25-2.67-1-3.34-3.16-2-6.5,2.66-8,2.75-14.58,.25-19.75-2.5-5.16-5.92-6.41-10.25-3.75-2.67,1.67-5,4.09-7,7.25-2,3.17-3.5,6.75-4.5,10.75s-1.42,8.09-1.25,12.25c.16,4.17,.75,7.92,1.75,11.25,1.33,4,3.66,7.42,7,10.25,3.33,2.84,7.16,4.67,11.5,5.5,4.33,.84,8.91,.67,13.75-.5,4.83-1.16,9.25-3.75,13.25-7.75,7.33-6.66,12.33-14.33,15-23,.33-1.66,1.16-2.91,2.5-3.75,1.33-.83,2.5-1.08,3.5-.75,1,.34,1.83,1.09,2.5,2.25,.66,1.17,.66,2.92,0,5.25-2.34,9.34-6.34,17-12,23-4.67,5.67-10.5,10.42-17.5,14.25-7,3.84-14.25,6.09-21.75,6.75-7.5,.67-14.84-.33-22-3-7.17-2.66-13.25-7.5-18.25-14.5-6-8.66-8.75-17.66-8.25-27,.5-9.33,2.25-16.66,5.25-22Z"/>
      </clipPath>
      <clipPath id="i_b">
        <path d="M393.06,330c-2.34,2.67-5.17,5.09-8.5,7.25-3.34,2.17-7.09,3.59-11.25,4.25-4.17,.67-8.59,.67-13.25,0-4.67-.66-9.17-2.33-13.5-5-4.67-2.66-7.67-7.58-9-14.75-1.34-7.16-1.83-14.66-1.5-22.5,.33-7.83,1.33-14.91,3-21.25,1.66-6.33,3.33-10.16,5-11.5,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,3.59,1.25,6.75-.17,3.17-.5,6.92-1,11.25-.5,4.34-1.09,8.92-1.75,13.75-.67,4.84-.67,9.42,0,13.75,.33,3.67,1.33,6.42,3,8.25,1.66,1.84,3.5,2.84,5.5,3,2,.17,4-.25,6-1.25s3.83-2.33,5.5-4c3-3.66,5.66-7.66,8-12,2.33-4.33,4.16-8.16,5.5-11.5,1-3.66,2.91-5.25,5.75-4.75,2.83,.5,3.75,3.09,2.75,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.34,8.59-10,14.25Z"/>
      </clipPath>
      <clipPath id="a2">
        <path d="M461.56,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      
    </g>
    <g
      id="strokes"
      fill="none"
      stroke=#96d7f5
      stroke-linecap="round"
      stroke-linejoin="round"
    >
    <path
    clip-path="url(#o)"
    class="oPath path"
    d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
    stroke-width="32.5"
    ></path>
    <path
      clip-path="url(#a1)"
      class="a1Path path"
      d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
      stroke-width="59"
    ></path>
    <path
      clip-path="url(#c)"
      class="cPath path"
      d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
      stroke-width="110"
    ></path>
    <path
      clip-path="url(#i_b)"
      class="i_bPath path"
      d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
      stroke-width="33"
    ></path>
    <path
      clip-path="url(#a2)"
      class="a2Path path"
      d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
      stroke-width="70"
    ></path>
    </g>
    <g
      id="strokes2"
      fill="none"
      stroke=#ff97b8
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path
        clip-path="url(#o)"
        class="oPath path"
        d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
        stroke-width="32.5"
      ></path>
      <path
        clip-path="url(#a1)"
        class="a1Path path"
        d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
        stroke-width="59"
      ></path>
      <path
        clip-path="url(#c)"
        class="cPath path"
        d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
        stroke-width="110"
      ></path>
      <path
        clip-path="url(#i_b)"
        class="i_bPath path"
        d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
        stroke-width="33"
      ></path>
      <path
        clip-path="url(#a2)"
        class="a2Path path"
        d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
        stroke-width="70"
      ></path>
    </g>
    <g class="dot-group">
      <path
        id="dot"
        fill=#ff97b8
        d="M362.58,182.21c4.66-.33,9.66,1.17,15,4.5,5.33,3.34,7.66,7.5,7,12.5-.67,2.34-1.92,4.92-3.75,7.75-1.84,2.84-4,5.5-6.5,8s-4.84,4.75-7,6.75c-2.17,2-3.75,3.17-4.75,3.5-2.67,1.67-5.34,2.25-8,1.75-2.67-.5-5-1.5-7-3s-3.59-3.33-4.75-5.5c-1.17-2.16-1.92-4.25-2.25-6.25-.34-2,.16-4.66,1.5-8,1.33-3.33,3.08-6.58,5.25-9.75,2.16-3.16,4.58-6,7.25-8.5,2.66-2.5,5.33-3.75,8-3.75Z"
      ></path>
    </g>
  </svg>
  <div class="description" itemprop="description">月遇从云 花遇和风</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">53</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">46</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lh" title="https:&#x2F;&#x2F;github.com&#x2F;oacia"><i class="ic i-github"></i></span>
      <a target="_blank" rel="noopener" href="https://twitter.com/oacia86" title="https:&#x2F;&#x2F;twitter.com&#x2F;oacia86" class="item twitter"><i class="ic i-twitter"></i></a>
      <span class="exturl item paper-plane" data-url="aHR0cHM6Ly90Lm1lL29hY2lh" title="https:&#x2F;&#x2F;t.me&#x2F;oacia"><i class="ic i-paper-plane"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOm9hY2lhODZAZ21haWwuY29t" title="mailto:oacia86@gmail.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about-oacia/" rel="section"><i class="ic i-user"></i>关于oacia</a>
  </li>

    
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-feather"></i>文章</a>
  </li>

    
  <li class="item">
    <a href="/TODOlist/" rel="section"><i class="ic i-clock"></i>要做的事</a>
  </li>

    
  <li class="item">
    <a href="/website_maintenance/" rel="section"><i class="ic i-calendar"></i>更新日志</a>
  </li>

    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>小伙伴</a>
  </li>

    
  <li class="item">
    <a href="/music/" rel="section"><i class="ic i-music"></i>听会儿歌吧</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/bilibili-get-ticket/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/douyin-6shen-init/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2022 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">oacia @ oacia</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">968k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">14:40</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>



<script data-config type="text/javascript">
  var LOCAL = {
    path: 'frida-inline-hook/',
    favicon: {
      show: "柚鳥ナツ",
      hide: "甘い幸せ"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>
<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>


<script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>
<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
