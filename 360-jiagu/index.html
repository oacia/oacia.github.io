



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="qQVmgWozVe7BXoA15J3gAZpEA5dK168admH4U3W6PAk">
  <meta name="msvalidate.01" content="4902E39C0135E72DE537BCB0FE08B40A">
  <meta name="baidu-site-verification" content="codeva-CSYjpuVg5v">


<link rel="alternate" type="application/rss+xml" title="oaciaのBbBlog~" href="https://oacia.dev/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="oaciaのBbBlog~" href="https://oacia.dev/atom.xml" />
<link rel="alternate" type="application/json" title="oaciaのBbBlog~" href="https://oacia.dev/feed.json" />
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-regular.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-700.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/font_1832207_igi8uaupcus.woff2"
/>
<link rel="preload" href="/background_picture/1_gongzi.webp" as="image" />
<link rel="preload" href="/background_picture/2_xiaoxia.webp" as="image" />
<link rel="preload" href="/background_picture/3_xingye.webp" as="image" />
<link rel="preload" href="/images/avatar.jpg" as="image" />



<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="https://oacia.dev/360-jiagu/">


<meta name="description" content="# 前言  在去年 9 月的时候，我就想研究一下 apk 的加固，在网上逛了一圈，感觉 360 加固不错，所以先选它啦，写了一个测试 apk 丢到 360 加固里面加固了一下 这里我用的是 360 加固的免费版 (因为付费版太贵啦) 本来计划着去年分析完 360 加固的，但是总是抽不出一段完整的时间来所以就拖到了现在，终于最近因为过年赋闲在家，就花了几天分析了一下 360 加固，感觉这几天探索 3">
<meta property="og:type" content="article">
<meta property="og:title" content="360加固dex解密流程分析">
<meta property="og:url" content="https://oacia.dev/360-jiagu/">
<meta property="og:site_name" content="oaciaのBbBlog~">
<meta property="og:description" content="# 前言  在去年 9 月的时候，我就想研究一下 apk 的加固，在网上逛了一圈，感觉 360 加固不错，所以先选它啦，写了一个测试 apk 丢到 360 加固里面加固了一下 这里我用的是 360 加固的免费版 (因为付费版太贵啦) 本来计划着去年分析完 360 加固的，但是总是抽不出一段完整的时间来所以就拖到了现在，终于最近因为过年赋闲在家，就花了几天分析了一下 360 加固，感觉这几天探索 3">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20230930183634640.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20230930183713453.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20230930183731411.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20230930182440462.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20230930184207278.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20230930184336555.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20230930184605448.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20230930184748578.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20230930190258638.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20231118145804113.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20231118150855726.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20231118151321228.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20231119122024522.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240212225108205.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240213225015953.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20231117143717038.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20231117143828767.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240213225949584.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240213230022534.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240213230048818.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240213232138840.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240213232208410.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240213233913165.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240213234737987.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220220722659.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240217212952888.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240217213007622.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240218174655222.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240218174801778.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240218175140788.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240218175438786.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240218175803731.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219144353027.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219181823744.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219181928308.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219184405967.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219184824589.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219185005955.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219185724473.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219190012572.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219191502430.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219191628154.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219191808113.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219191839316.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20231118152818874.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219195550519.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219200830705.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219200139731.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219200302071.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219200510607.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219200703480.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219201000793.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219201131482.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219202037098.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220214503336.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220131405321.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240219203139130.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220000932490.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220001104708.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220001342895.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220001528743.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220012621743.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220003908902.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220004233903.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220004029770.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220012939262.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220013039190.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220013502056.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220023743626.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220024254105.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220024130734.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220024433454.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220024522541.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220024831366.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220024916186.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220025025814.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220145850194.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220025453629.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220025540021.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220220013192.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220220022117.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220223148864.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220223253986.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220172348458.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221131839098.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220224638674.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221131944227.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221132044506.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220231727044.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220231901275.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220232029056.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220232313676.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221141755126.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221142103021.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221160528463.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221162607623.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221162856663.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221170453897.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221170627481.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221172325310.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221172717168.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240220225331054.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221133619261.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221173657553.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221174419522.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221180350649.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221184130805.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221180415665.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221180705025.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240221185357390.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222005607295.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222005639325.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222010902622.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222011044885.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222011143427.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222011351754.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222012001816.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222012543471.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222013454838.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222013944879.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222015211639.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222015139528.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222015651090.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222030003433.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222030104410.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222030239507.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222030345127.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222030355010.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222030924824.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222172233276.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240222031222988.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307115103478.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307120002564.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307120118309.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307120333178.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307120808017.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307120941018.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307121240701.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307121409507.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307121648094.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307124356084.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307191208065.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307191316415.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307191840395.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307192203905.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307193744892.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240307194101403.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308004303427.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308110813489.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308005514430.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308005825649.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308010341488.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308010411747.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308010524472.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308011028793.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308011259938.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308011627096.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308012120417.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308012312135.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308012704595.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308014607722.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308012938693.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308112313375.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308112226813.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240308112237431.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240309004158571.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240309004238199.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240309004324883.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240309004410712.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240309011700849.png">
<meta property="og:image" content="https://oacia.dev/360-jiagu/image-20240309013111976.png">
<meta property="article:published_time" content="2024-02-21T19:14:53.000Z">
<meta property="article:modified_time" content="2025-04-08T18:55:11.178Z">
<meta property="article:author" content="oacia">
<meta property="article:tag" content="reverse,安卓逆向,区块链,学习笔记,破解实战,前端,CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oacia.dev/360-jiagu/image-20230930183634640.png">
<meta name="twitter:creator" content="@oacia86">


  <title>
360加固dex解密流程分析 |
oacia = oaciaのBbBlog~ = DEVIL or SWEET</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  var jq_151 = $.noConflict(true);
  var RENDERER = {
    INIT_CHERRY_BLOSSOM_COUNT : 30,
    MAX_ADDING_INTERVAL : 10,
    WATCH_INTERVAL : 300,
    
    init : function(){
      this.setParameters();
      this.reconstructMethods();
      this.setup();
      this.bindEvent();
      this.render();
    },
    setParameters : function(){
      this.$window = jq_151(window);
      this.$container = jq_151('#loading');
      this.$canvas = jq_151('<canvas />');
      this.context = this.$canvas.appendTo(this.$container).get(0).getContext('2d');
      this.cherries = [];
      this.watchIds = [];
    },
    reconstructMethods : function(){
      this.watchWindowSize = this.watchWindowSize.bind(this);
      this.jdugeToStopResize = this.jdugeToStopResize.bind(this);
      this.render = this.render.bind(this);
    },
    setup : function(){
      this.cherries.length = 0;
      this.watchIds.length = 0;
      this.width = this.$container.width();
      this.height = this.$container.height();
      this.$canvas.attr({width : this.width, height : this.height});
      this.maxAddingInterval = Math.round(this.MAX_ADDING_INTERVAL * 1000 / this.width);
      this.addingInterval = this.maxAddingInterval;
      this.createCherries();
    },
    createCherries : function(){
      for(var i = 0, length = Math.round(this.INIT_CHERRY_BLOSSOM_COUNT * this.width / 1000); i < length; i++){
        this.cherries.push(new CHERRY_BLOSSOM(this, true));
      }
    },
    watchWindowSize : function(){
      this.clearTimer();
      this.tmpWidth = window.width;
      this.tmpHeight = window.height;
      this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL));
    },
    clearTimer : function(){
      while(this.watchIds.length > 0){
        clearTimeout(this.watchIds.pop());
      }
    },
    jdugeToStopResize : function(){
      var width = window.width,
        height = window.height,
        stopped = (width == this.tmpWidth && height == this.tmpHeight);
        
      this.tmpWidth = width;
      this.tmpHeight = height;
      
      if(stopped){
        this.setup();
      }
    },
    bindEvent : function(){
      this.$window.on('resize', this.watchWindowSize);
    },
    render : function(){
      //console.log("render")

      if(jq_151(this.$container).css("display")!="none"){
        requestAnimationFrame(this.render);
      }
      
      this.context.clearRect(0, 0, this.width, this.height);
      
      this.cherries.sort(function(cherry1, cherry2){
        return cherry1.z - cherry2.z;
      });
      for(var i = this.cherries.length - 1; i >= 0; i--){
        if(!this.cherries[i].render(this.context)){
          this.cherries.splice(i, 1);
        }
      }
      if(--this.addingInterval == 0){
        this.addingInterval = this.maxAddingInterval;
        this.cherries.push(new CHERRY_BLOSSOM(this, false));
      }
    }
  };
  var CHERRY_BLOSSOM = function(renderer, isRandom){
    this.renderer = renderer;
    this.init(isRandom);
  };
  CHERRY_BLOSSOM.prototype = {
    FOCUS_POSITION : 300,
    FAR_LIMIT : 600,
    MAX_RIPPLE_COUNT : 100,
    RIPPLE_RADIUS : 100,
    SURFACE_RATE : 0.5,
    SINK_OFFSET : 20,
    
    init : function(isRandom){
      this.x = this.getRandomValue(-this.renderer.width, this.renderer.width);
      this.y = isRandom ? this.getRandomValue(0, this.renderer.height) : this.renderer.height * 1.5;
      this.z = this.getRandomValue(0, this.FAR_LIMIT);
      this.vx = this.getRandomValue(-2, 2);
      this.vy = -2;
      this.theta = this.getRandomValue(0, Math.PI * 2);
      this.phi = this.getRandomValue(0, Math.PI * 2);
      this.psi = 0;
      this.dpsi = this.getRandomValue(Math.PI / 600, Math.PI / 300);
      this.opacity = 0;
      this.endTheta = false;
      this.endPhi = false;
      this.rippleCount = 0;
      
      var axis = this.getAxis(),
        theta = this.theta + Math.ceil(-(this.y + this.renderer.height * this.SURFACE_RATE) / this.vy) * Math.PI / 500;
      theta %= Math.PI * 2;
      
      this.offsetY = 40 * ((theta <= Math.PI / 2 || theta >= Math.PI * 3 / 2) ? -1 : 1);
      this.thresholdY = this.renderer.height / 2 + this.renderer.height * this.SURFACE_RATE * axis.rate;
      this.entityColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.entityColor.addColorStop(0, 'hsl(330, 70%, ' + 50 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(0.05, 'hsl(330, 40%,' + 55 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(1, 'hsl(330, 20%, ' + 70 * (0.3 + axis.rate) + '%)');
      this.shadowColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.shadowColor.addColorStop(0, 'hsl(330, 40%, ' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(0.05, 'hsl(330, 40%,' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(1, 'hsl(330, 20%, ' + 40 * (0.3 + axis.rate) + '%)');
    },
    getRandomValue : function(min, max){
      return min + (max - min) * Math.random();
    },
    getAxis : function(){
      var rate = this.FOCUS_POSITION / (this.z + this.FOCUS_POSITION),
        x = this.renderer.width / 2 + this.x * rate,
        y = this.renderer.height / 2 - this.y * rate;
      return {rate : rate, x : x, y : y};
    },
    renderCherry : function(context, axis){
      context.beginPath();
      context.moveTo(0, 40);
      context.bezierCurveTo(-60, 20, -10, -60, 0, -20);
      context.bezierCurveTo(10, -60, 60, 20, 0, 40);
      context.fill();
      
      for(var i = -4; i < 4; i++){
        context.beginPath();
        context.moveTo(0, 40);
        context.quadraticCurveTo(i * 12, 10, i * 4, -24 + Math.abs(i) * 2);
        context.stroke();
      }
    },
    render : function(context){
      var axis = this.getAxis();
      
      if(axis.y == this.thresholdY && this.rippleCount < this.MAX_RIPPLE_COUNT){
        context.save();
        context.lineWidth = 2;
        context.strokeStyle = 'hsla(0, 0%, 100%, ' + (this.MAX_RIPPLE_COUNT - this.rippleCount) / this.MAX_RIPPLE_COUNT + ')';
        context.translate(axis.x + this.offsetY * axis.rate * (this.theta <= Math.PI ? -1 : 1), axis.y);
        context.scale(1, 0.3);
        context.beginPath();
        context.arc(0, 0, this.rippleCount / this.MAX_RIPPLE_COUNT * this.RIPPLE_RADIUS * axis.rate, 0, Math.PI * 2, false);
        context.stroke();
        context.restore();
        this.rippleCount++;
      }
      if(axis.y < this.thresholdY || (!this.endTheta || !this.endPhi)){
        if(this.y <= 0){
          this.opacity = Math.min(this.opacity + 0.01, 1);
        }
        context.save();
        context.globalAlpha = this.opacity;
        context.fillStyle = this.shadowColor;
        context.strokeStyle = 'hsl(330, 30%,' + 40 * (0.3 + axis.rate) + '%)';
        context.translate(axis.x, Math.max(axis.y, this.thresholdY + this.thresholdY - axis.y));
        context.rotate(Math.PI - this.theta);
        context.scale(axis.rate * -Math.sin(this.phi), axis.rate);
        context.translate(0, this.offsetY);
        this.renderCherry(context, axis);
        context.restore();
      }
      context.save();
      context.fillStyle = this.entityColor;
      context.strokeStyle = 'hsl(330, 40%,' + 70 * (0.3 + axis.rate) + '%)';
      context.translate(axis.x, axis.y + Math.abs(this.SINK_OFFSET * Math.sin(this.psi) * axis.rate));
      context.rotate(this.theta);
      context.scale(axis.rate * Math.sin(this.phi), axis.rate);
      context.translate(0, this.offsetY);
      this.renderCherry(context, axis);
      context.restore();
      
      if(this.y <= -this.renderer.height / 4){
        if(!this.endTheta){
          for(var theta = Math.PI / 2, end = Math.PI * 3 / 2; theta <= end; theta += Math.PI){
            if(this.theta < theta && this.theta + Math.PI / 200 > theta){
              this.theta = theta;
              this.endTheta = true;
              break;
            }
          }
        }
        if(!this.endPhi){
          for(var phi = Math.PI / 8, end = Math.PI * 7 / 8; phi <= end; phi += Math.PI * 3 / 4){
            if(this.phi < phi && this.phi + Math.PI / 200 > phi){
              this.phi = Math.PI / 8;
              this.endPhi = true;
              break;
            }
          }
        }
      }
      if(!this.endTheta){
        if(axis.y == this.thresholdY){
          this.theta += Math.PI / 200 * ((this.theta < Math.PI / 2 || (this.theta >= Math.PI && this.theta < Math.PI * 3 / 2)) ? 1 : -1);
        }else{
          this.theta += Math.PI / 500;
        }
        this.theta %= Math.PI * 2;
      }
      if(this.endPhi){
        if(this.rippleCount == this.MAX_RIPPLE_COUNT){
          this.psi += this.dpsi;
          this.psi %= Math.PI * 2;
        }
      }else{
        this.phi += Math.PI / ((axis.y == this.thresholdY) ? 200 : 500);
        this.phi %= Math.PI;
      }
      if(this.y <= -this.renderer.height * this.SURFACE_RATE){
        this.x += 2;
        this.y = -this.renderer.height * this.SURFACE_RATE;
      }else{
        this.x += this.vx;
        this.y += this.vy;
      }
      return this.z > -this.FOCUS_POSITION && this.z < this.FAR_LIMIT && this.x < this.renderer.width * 1.5;
    }
  };
  jq_151(function(){
    RENDERER.init();
  });
</script>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <!--
    <div class="alice">
      <img src="/images/alice-shake.gif" alt="">
    </div>

    
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
    -->
  </div>
  <script
      defer="defer"
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"
      integrity="sha512-1dalHDkG9EtcOmCnoCjiwQ/HEB5SDNqw8d4G2MKoNwjiwMNeBAkudsBCmSlMnXdsH8Bm0mOd3tl/6nL5y0bMaQ=="
      crossorigin="anonymous"
    ></script>
  <script defer="defer" src="/js/gsap/DrawSVGPlugin.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomEase.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomBounce.min.js"></script>
  <script defer="defer" src="/js/gsap/SplitText.min.js"></script>
  <script defer="defer" src="/js/gsap/logo-run.js"></script>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">360加固dex解密流程分析
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2024-02-22 03:14:53">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2024-02-22T03:14:53+08:00">2024-02-22</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>62k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>56 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">oacia</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="/background_picture/1_mary.jpg"></li>
          <li class="item" data-background-image="/background_picture/2_xingye.webp"></li>
          <li class="item" data-background-image="/background_picture/3_xiaoxia.webp"></li>
          <li class="item" data-background-image="/background_picture/4_alice.webp"></li>
          <li class="item" data-background-image="/background_picture/5_mutsuki.jpg"></li>
          <li class="item" data-background-image="/background_picture/6_arona_plana.webp"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb">
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://oacia.dev/360-jiagu/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="oacia">
    <meta itemprop="description" content="DEVIL or SWEET, 月遇从云 花遇和风">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="oaciaのBbBlog~">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="前言"><a class="anchor" href="#前言">#</a> 前言</h1>
<blockquote>
<p>在去年 9 月的时候，我就想研究一下 apk 的加固，在网上逛了一圈，感觉 360 加固不错，所以先选它啦，写了一个测试 apk 丢到 360 加固里面加固了一下</p>
<p>这里我用的是 360 加固的免费版 (因为付费版太贵啦)</p>
<p>本来计划着去年分析完 360 加固的，但是总是抽不出一段完整的时间来所以就拖到了现在，终于最近因为过年赋闲在家，就花了几天分析了一下 360 加固，感觉这几天探索 360 加固的过程真是充满了惊喜和乐趣呢～</p>
</blockquote>
<p>2024 年 3 月 8 号记:</p>
<blockquote>
<p>距离上次看 360 加固已经半个月啦，今天正想着自己要做什么事情的时候，到博客看了眼 TODOlist, 突然发现咦我是不是还没看过 dex 的解密算法长什么样？所以今天就把这个给做完了，不得不说逆向真的是消磨无聊时间最有效的方法哈哈哈</p>
</blockquote>
<p>360 加固测试 apk: <span class="exturl" data-url="aHR0cHM6Ly9vYWNpYS5naXRodWIuaW8vMzYwLWppYWd1LzM2MGppYWd1LmFwaw==">下载地址</span></p>
<p>未加固的原版 apk: <span class="exturl" data-url="aHR0cHM6Ly9vYWNpYS5naXRodWIuaW8vMzYwLWppYWd1L29yaWdpbmFsLmFwaw==">下载地址</span></p>
<h1 id="java层初步分析"><a class="anchor" href="#java层初步分析">#</a> java 层初步分析</h1>
<p>包名: <code>com.oacia.apk_protect</code></p>
<p>入口: <code>com.stub.StubApp</code></p>
<p>我们从 <code>AndroidManifest.xml</code>  中可以得知，360 加固的入口是 <code>com.stub.StubApp</code> , 所以我们就先进到 apk 的入口进行分析</p>
<p><img data-src="/360-jiagu/image-20230930183634640.png" alt="image-20230930183634640" style="aspect-ratio:804 / 196;"></p>
<p>在这个入口类中，不仅有常规的 <code>onCreate()</code>  函数，还有一个函数值得注意，他就是 <code>attachBaseContext(Context context)</code></p>
<p><img data-src="/360-jiagu/image-20230930183713453.png" alt="image-20230930183713453" style="aspect-ratio:1557 / 449;"></p>
<blockquote>
<p>Application 的 <code>onCreate</code>  和 <code>attachBaseContext</code>  是 Application 的两个回调方法，通常我们会在其中做一些初始化操作， <code>attachBaseContext</code>  在 <code>onCreate</code> <strong> 之前执行</strong></p>
</blockquote>
<p>其中出现的字符串经过了加密混淆操作，加密函数如下，算法是将所有的字符与 <code>16</code>  进行异或</p>
<p><img data-src="/360-jiagu/image-20230930183731411.png" alt="image-20230930183731411" style="aspect-ratio:604 / 274;"></p>
<p>我们写个 jeb 脚本把加密字符串解密来方便后续的静态分析</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># coding=utf-8</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> com<span class="token punctuation">.</span>pnfsoftware<span class="token punctuation">.</span>jeb<span class="token punctuation">.</span>client<span class="token punctuation">.</span>api <span class="token keyword">import</span> IScript<span class="token punctuation">,</span> IconType<span class="token punctuation">,</span> ButtonGroupType</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">from</span> com<span class="token punctuation">.</span>pnfsoftware<span class="token punctuation">.</span>jeb<span class="token punctuation">.</span>core <span class="token keyword">import</span> RuntimeProjectUtil</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> com<span class="token punctuation">.</span>pnfsoftware<span class="token punctuation">.</span>jeb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>units<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java <span class="token keyword">import</span> IJavaSourceUnit</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">from</span> com<span class="token punctuation">.</span>pnfsoftware<span class="token punctuation">.</span>jeb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>units<span class="token punctuation">.</span>code <span class="token keyword">import</span> ICodeUnit<span class="token punctuation">,</span> ICodeItem</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">from</span> com<span class="token punctuation">.</span>pnfsoftware<span class="token punctuation">.</span>jeb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>output<span class="token punctuation">.</span>text <span class="token keyword">import</span> ITextDocument</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">from</span> com<span class="token punctuation">.</span>pnfsoftware<span class="token punctuation">.</span>jeb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>units<span class="token punctuation">.</span>code<span class="token punctuation">.</span>java <span class="token keyword">import</span> IJavaSourceUnit<span class="token punctuation">,</span> IJavaStaticField<span class="token punctuation">,</span> IJavaNewArray<span class="token punctuation">,</span> IJavaConstant<span class="token punctuation">,</span> IJavaCall<span class="token punctuation">,</span> IJavaField<span class="token punctuation">,</span> IJavaMethod<span class="token punctuation">,</span> IJavaClass</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">from</span> com<span class="token punctuation">.</span>pnfsoftware<span class="token punctuation">.</span>jeb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>events <span class="token keyword">import</span> JebEvent<span class="token punctuation">,</span> J</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">from</span> com<span class="token punctuation">.</span>pnfsoftware<span class="token punctuation">.</span>jeb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util <span class="token keyword">import</span> DecompilerHelper</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 解密字符串函数的类名以及方法名</span></pre></td></tr><tr><td data-num="12"></td><td><pre>methodName <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Lcom/qihoo/util/a;'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">dec_str_360jiagu</span><span class="token punctuation">(</span>IScript<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start deal with strings'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        self<span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx</pre></td></tr><tr><td data-num="19"></td><td><pre>        engctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span>getEnginesContext<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> engctx<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Back-end engines not initialized'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">return</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>        projects <span class="token operator">=</span> engctx<span class="token punctuation">.</span>getProjects<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> projects<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'There is no opened project'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">return</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>        units <span class="token operator">=</span> RuntimeProjectUtil<span class="token punctuation">.</span>findUnitsByType<span class="token punctuation">(</span>projects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> IJavaSourceUnit<span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">for</span> unit <span class="token keyword">in</span> units<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            javaClass <span class="token operator">=</span> unit<span class="token punctuation">.</span>getClassElement<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] decrypt:'</span> <span class="token operator">+</span> javaClass<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            self<span class="token punctuation">.</span>cstbuilder <span class="token operator">=</span> unit<span class="token punctuation">.</span>getFactories<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getConstantFactory<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            self<span class="token punctuation">.</span>processClass<span class="token punctuation">(</span>javaClass<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            unit<span class="token punctuation">.</span>notifyListeners<span class="token punctuation">(</span>JebEvent<span class="token punctuation">(</span>J<span class="token punctuation">.</span>UnitChange<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Done.'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">processClass</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> javaClass<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">if</span> javaClass<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> methodName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token keyword">return</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">for</span> method <span class="token keyword">in</span> javaClass<span class="token punctuation">.</span>getMethods<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            block <span class="token operator">=</span> method<span class="token punctuation">.</span>getBody<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            i <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token keyword">while</span> i <span class="token operator">&lt;</span> block<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                stm <span class="token operator">=</span> block<span class="token punctuation">.</span>get<span class="token punctuation">(</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                self<span class="token punctuation">.</span>checkElement<span class="token punctuation">(</span>block<span class="token punctuation">,</span> stm<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                i <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">checkElement</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> IJavaCall<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                mmethod <span class="token operator">=</span> e<span class="token punctuation">.</span>getMethod<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                mname <span class="token operator">=</span> mmethod<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                msig <span class="token operator">=</span> mmethod<span class="token punctuation">.</span>getSignature<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token keyword">if</span> mname <span class="token operator">==</span> methodName<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">and</span> methodName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">in</span> msig<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                    v <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                    <span class="token keyword">for</span> arg <span class="token keyword">in</span> e<span class="token punctuation">.</span>getArguments<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> IJavaConstant<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                            v<span class="token punctuation">.</span>append<span class="token punctuation">(</span>arg<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                        decstr <span class="token operator">=</span> self<span class="token punctuation">.</span>decryptstring<span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                        parent<span class="token punctuation">.</span>replaceSubElement<span class="token punctuation">(</span>e<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cstbuilder<span class="token punctuation">.</span>createString<span class="token punctuation">(</span>decstr<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token keyword">for</span> subelt <span class="token keyword">in</span> e<span class="token punctuation">.</span>getSubElements<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>subelt<span class="token punctuation">,</span> IJavaClass<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>subelt<span class="token punctuation">,</span> IJavaField<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>subelt<span class="token punctuation">,</span> IJavaMethod<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                    <span class="token keyword">continue</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                self<span class="token punctuation">.</span>checkElement<span class="token punctuation">(</span>e<span class="token punctuation">,</span> subelt<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">except</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">decryptstring</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        src <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token keyword">for</span> index<span class="token punctuation">,</span> char <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            src<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'unicode_escape'</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>解密后的效果如下</p>
<p><img data-src="/360-jiagu/image-20230930182440462.png" alt="image-20230930182440462" style="aspect-ratio:1575 / 816;"></p>
<p>我们往下进行分析，可以知道 <code>attachBaseContext</code>  的第一个作用是根据目标手机的架构加载 <code>libjiagu_xxx.so</code>  如图</p>
<p><img data-src="/360-jiagu/image-20230930184207278.png" alt="image-20230930184207278" style="aspect-ratio:1304 / 899;"></p>
<p>这些 so 在 <code>assets</code>  目录下</p>
<p><img data-src="/360-jiagu/image-20230930184336555.png" alt="image-20230930184336555" style="aspect-ratio:810 / 261;"></p>
<p>在加载完 <code>libjiagu_xxx.so</code>  之后，还调用了 <code>DtcLoader</code>  类进行初始化，这里使用的 jadx 的反编译结果，因为 jeb 没有反编译出 <code>DtcLoader.init();</code>  方法来</p>
<p><img data-src="/360-jiagu/image-20230930184605448.png" alt="image-20230930184605448" style="aspect-ratio:765 / 198;"></p>
<p><code>DtcLoader</code>  类如图所示</p>
<p><img data-src="/360-jiagu/image-20230930184748578.png" alt="image-20230930184748578" style="aspect-ratio:1344 / 636;"></p>
<p>当 <code>DtcLoader</code>  类被加载到 JVM 中时，会去加载 <code>libjgdtc.so</code> , 如果加载失败，则会尝试从 <code>/data/app/com.oacia.apk_protect/lib/arm64/libjgdtc.so</code>  或者 <code>/data/data/com.oacia.apk_protect/lib/libjgdtc.so</code>  中去加载这个 so</p>
<p>但是当我们去进入到这两个目录进行寻找时，却发现没有这个 <code>libjgdtc.so</code>  存在</p>
<p><img data-src="/360-jiagu/image-20230930190258638.png" alt="image-20230930190258638" style="aspect-ratio:494 / 1023;"></p>
<p>所以我们的分析重点是在 <code>libjiagu.so</code>  中，这里我选取了 arm64 架构的 so 文件 <code>libjiagu_a64.so</code>  进行分析</p>
<h1 id="壳elf导入导出表修复"><a class="anchor" href="#壳elf导入导出表修复">#</a> 壳 ELF 导入导出表修复</h1>
<p>我们使用 ida 分析 <code>libjiagu_a64.so</code> , 发现导入表和导出表都没有内容，既然是这种情况，那么应该是在 so 装载进内存时导入导出表才会去进行相应的链接操作</p>
<p><img data-src="/360-jiagu/image-20231118145804113.png" alt="image-20231118145804113" style="aspect-ratio:1920 / 596;"></p>
<p>所以我们可以先用 frida 把这个 so 给 dump 下来</p>
<p>首先我们在手机上运行一下 frida server</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>PS D:<span class="token punctuation">\</span>frida<span class="token operator">></span> adb shell</pre></td></tr><tr><td data-num="2"></td><td><pre>blueline:/ $ <span class="token function">su</span></pre></td></tr><tr><td data-num="3"></td><td><pre>blueline:/ <span class="token comment"># cd /data/local/tmp</span></pre></td></tr><tr><td data-num="4"></td><td><pre>blueline:/data/local/tmp <span class="token comment"># ./fs -l 0.0.0.0:1234</span></pre></td></tr></table></figure><p>随后做一下端口转发</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>adb forward tcp:1234 tcp:1234</pre></td></tr></table></figure><p>frida 命令行语句如下</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>frida <span class="token parameter variable">-H</span> <span class="token number">127.0</span>.0.1:1234 <span class="token parameter variable">-l</span> .<span class="token punctuation">\</span>hook.js <span class="token parameter variable">-f</span> <span class="token string">"com.oacia.apk_protect"</span></pre></td></tr></table></figure><p>注入如下脚本</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">my_hook_dlopen</span><span class="token punctuation">(</span>soName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"android_dlopen_ext"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token keyword">var</span> pathptr <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pathptr <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> pathptr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                    <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>pathptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>soName<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                        <span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token function">dump_so</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">function</span> <span class="token function">dump_so</span><span class="token punctuation">(</span><span class="token parameter">so_name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">var</span> libso <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span>so_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[name]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[base]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[size]:"</span><span class="token punctuation">,</span> <span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[path]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">var</span> file_path <span class="token operator">=</span> <span class="token string">"/data/data/com.oacia.apk_protect/"</span> <span class="token operator">+</span> libso<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> libso<span class="token punctuation">.</span>base <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> <span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".so"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">var</span> file_handle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>file_handle <span class="token operator">&amp;&amp;</span> file_handle <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        Memory<span class="token punctuation">.</span><span class="token function">protect</span><span class="token punctuation">(</span><span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token string">'rwx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">var</span> libso_buffer <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        file_handle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>libso_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        file_handle<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        file_handle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[dump]:"</span><span class="token punctuation">,</span> file_path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token function">my_hook_dlopen</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="/360-jiagu/image-20231118150855726.png" alt="image-20231118150855726" style="aspect-ratio:998 / 155;"></p>
<p>随后我们使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Y4TEVGVC9Tb0ZpeGVy"> SoFixer</span> 修复一下这个 so, 这里的 <code>-m</code>  参数即这个 so 在内存中的 <code>base</code>  基地址</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>.<span class="token punctuation">\</span>SoFixer-Windows-64.exe <span class="token parameter variable">-s</span> .<span class="token punctuation">\</span>libjiagu_64.so_0x74a2845000_0x274000.so <span class="token parameter variable">-o</span> .<span class="token punctuation">\</span>libjiagu_64_0x74a2845000_0x274000_fix.so <span class="token parameter variable">-m</span> 0x74a2845000 <span class="token parameter variable">-d</span></pre></td></tr></table></figure><p>修复完成后，导入表和导出表就恢复了</p>
<p><img data-src="/360-jiagu/image-20231118151321228.png" alt="image-20231118151321228" style="aspect-ratio:1537 / 706;"></p>
<h1 id="加固壳反调试初步分析"><a class="anchor" href="#加固壳反调试初步分析">#</a> 加固壳反调试初步分析</h1>
<p>首先我们去 hook 一下打开 so 的函数</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_dlopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"android_dlopen_ext"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token keyword">var</span> pathptr <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pathptr <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> pathptr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                    <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>pathptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"load "</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token function">setImmediate</span><span class="token punctuation">(</span>hook_dlopen<span class="token punctuation">)</span></pre></td></tr></table></figure><p>日志如下，所以反调试是在 <code>libjiagu_64.so</code>  中</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>load libstats_jni.so</pre></td></tr><tr><td data-num="2"></td><td><pre>load /data/app/~~P6meiEqXSQZrP2ChUgVgOg<span class="token operator">==</span>/com.oacia.apk_protect-ezyVSLdtBZmLTZejgPlSoQ<span class="token operator">==</span>/oat/arm64/base.odex</pre></td></tr><tr><td data-num="3"></td><td><pre>load /data/data/com.oacia.apk_protect/.jiagu/libjiagu_64.so</pre></td></tr></table></figure><p>然后去 hook 打开文件的函数 <code>open</code></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">my_hook_dlopen</span><span class="token punctuation">(</span>soName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"android_dlopen_ext"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token keyword">var</span> pathptr <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pathptr <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> pathptr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                    <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>pathptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>soName<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                        <span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token function">hook_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">var</span> pth <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token function">ptr</span><span class="token punctuation">(</span>pth<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token function-variable function">onEnter</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>filename<span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token function-variable function">onLeave</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token function">setImmediate</span><span class="token punctuation">(</span>my_hook_dlopen<span class="token punctuation">,</span><span class="token string">"libjiagu"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>日志如下</p>
<p><img data-src="/360-jiagu/image-20231119122024522.png" alt="image-20231119122024522" style="aspect-ratio:849 / 170;"></p>
<p>这里我们发现了 <code>/proc/self/maps</code> , 这是常见的反调试，要绕过这个检测，我们可以备份一个正常的 <code>maps</code>  文件，然后用 frida 去 hook  <code>open</code>  函数，如果匹配到字符串 <code>maps</code> , 就将字符串重定向到我们备份的 <code>maps</code>  文件</p>
<p>首先我们正常打开一次加壳的 apk, 然后使用下列命令备份 maps</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">cp</span> /proc/self/maps /data/data/com.oacia.apk_protect/maps</pre></td></tr></table></figure><p>然后我们注入如下 frida 脚本</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">my_hook_dlopen</span><span class="token punctuation">(</span>soName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"android_dlopen_ext"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token keyword">var</span> pathptr <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pathptr <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> pathptr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                    <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>pathptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>soName<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                        <span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token function">hook_proc_self_maps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_proc_self_maps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">const</span> openPtr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">getExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">const</span> open <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>openPtr<span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">var</span> fakePath <span class="token operator">=</span> <span class="token string">"/data/data/com.oacia.apk_protect/maps"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openPtr<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NativeCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">pathnameptr<span class="token punctuation">,</span> flag</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">var</span> pathname <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">readUtf8String</span><span class="token punctuation">(</span>pathnameptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">,</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pathname<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"maps"</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"find"</span><span class="token punctuation">,</span>pathname<span class="token punctuation">,</span><span class="token string">",redirect to"</span><span class="token punctuation">,</span>fakePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">var</span> filename <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">allocUtf8String</span><span class="token punctuation">(</span>fakePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token keyword">return</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>pathnameptr<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">return</span> fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token function">setImmediate</span><span class="token punctuation">(</span>my_hook_dlopen<span class="token punctuation">,</span><span class="token string">"libjiagu"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>但是当注入这段脚本后，进程由于非法内存访问而退出了，这说明 360 加固不仅读取 maps 文件，并且会尝试访问 maps 文件中所记录的文件或内存映射。这里由于 frida 注入后重启 apk, 但是备份的 maps 文件中记录的是先前的映射起始地址 (这块内存在关闭 apk 后就被抹去了), 所以当壳尝试访问其中的映射时产生了非法内存访问从而让进程崩溃</p>
<p><img data-src="/360-jiagu/image-20240212225108205.png" alt="image-20240212225108205" style="aspect-ratio:1901 / 667;"></p>
<p>这里我的解决方式是将上述 frida 代码中的 <code>fakePath</code>  赋值为一个不存在的文件例如 <code>/data/data/com.oacia.apk_protect/maps_nonexistent</code> , 来让壳没有内容可以访问</p>
<p>修改完 <code>fakePath</code>  后重新注入代码，这个打印出来的日志可以说非常有意思，我们来看一下，相比 hook  <code>open</code>  之前的日志，我们成功的让 360 加固的壳释放出了 dex</p>
<p><img data-src="/360-jiagu/image-20240213225015953.png" alt="image-20240213225015953" style="aspect-ratio:1290 / 632;"></p>
<p>然而这个壳似乎是又发现了些什么异常，随后赶紧让 app 退出了，但是由于退出的太过仓促，它甚至还没有来得及把 dex 从文件夹中删除</p>
<p><img data-src="/360-jiagu/image-20231117143717038.png" alt="image-20231117143717038" style="aspect-ratio:467 / 417;"></p>
<p>用 010editor 打开 <code>classes.dex</code> , 发现前几位并不是 dex 的魔术头，说明这个 dex 还没有被解密，不过现在我们只需要分析 dex 如何被壳从内存中释放出来的过程就可以了～</p>
<p><img data-src="/360-jiagu/image-20231117143828767.png" alt="image-20231117143828767" style="aspect-ratio:788 / 577;"></p>
<p>如何可以定位到是什么位置调用了 <code>open</code>  函数来打开 <code>classes.dex</code>  呢？</p>
<p>很简单，打印一下堆栈就可以了</p>
<p>假如我们使用常规的 frida 打印堆栈代码，即使用 <code>DebugSymbol.fromAddress</code>  函数来判断地址所在的 <code>so</code>  的位置，那么进程是会报错退出的</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'RegisterNatives called from:\\n'</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">backtrace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span> Backtracer<span class="token punctuation">.</span><span class="token constant">FUZZY</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>DebugSymbol<span class="token punctuation">.</span>fromAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\\n'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>所以这里 <code>DebugSymbol.fromAddress</code>  所实现的逻辑需要自己编写，即下方的 <code>addr_in_so</code>  函数</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">addr_in_so</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> process_Obj_Module_Arr <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">enumerateModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> process_Obj_Module_Arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>addr<span class="token operator">></span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base <span class="token operator">&amp;&amp;</span> addr<span class="token operator">&lt;</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"is in"</span><span class="token punctuation">,</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">"offset: 0x"</span><span class="token operator">+</span><span class="token punctuation">(</span>addr<span class="token operator">-</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_proc_self_maps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">const</span> openPtr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">getExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">const</span> open <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>openPtr<span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">var</span> fakePath <span class="token operator">=</span> <span class="token string">"/data/data/com.oacia.apk_protect/maps_nonexistent"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openPtr<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NativeCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">pathnameptr<span class="token punctuation">,</span> flag</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">var</span> pathname <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">readUtf8String</span><span class="token punctuation">(</span>pathnameptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">,</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//,Process.getCurrentThreadId()</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pathname<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"maps"</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"find"</span><span class="token punctuation">,</span>pathname<span class="token operator">+</span><span class="token string">", redirect to"</span><span class="token punctuation">,</span>fakePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">var</span> filename <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">allocUtf8String</span><span class="token punctuation">(</span>fakePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">return</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pathname<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"dex"</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            Thread<span class="token punctuation">.</span><span class="token function">backtrace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span> Backtracer<span class="token punctuation">.</span><span class="token constant">FUZZY</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>addr_in_so<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>pathnameptr<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">function</span> <span class="token function">my_hook_dlopen</span><span class="token punctuation">(</span>soName<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"android_dlopen_ext"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token keyword">var</span> pathptr <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pathptr <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> pathptr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                    <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>pathptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                    <span class="token comment">//console.log(path);</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>soName<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                        <span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                    <span class="token function">hook_proc_self_maps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token function">setImmediate</span><span class="token punctuation">(</span>my_hook_dlopen<span class="token punctuation">,</span><span class="token string">'libjiagu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>于是我们得到了释放三个 dex 文件的堆栈回溯</p>
<ul>
<li><code>classes.dex</code> <br>
<img data-src="/360-jiagu/image-20240213225949584.png" alt="image-20240213225949584" style="aspect-ratio:878 / 513;"></li>
<li><code>classes2.dex</code> <br>
<img data-src="/360-jiagu/image-20240213230022534.png" alt="image-20240213230022534" style="aspect-ratio:896 / 518;"></li>
<li><code>classes3.dex</code> <br>
<img data-src="/360-jiagu/image-20240213230048818.png" alt="image-20240213230048818" style="aspect-ratio:900 / 259;"></li>
</ul>
<p>这里我们发现 <code>classes.dex</code>  与 <code>classes2.dex</code>  的堆栈回溯完全相同，并且 <code>classes3.dex</code>  的前半部分和前两个 dex 的堆栈一样，随后进程便又退出了</p>
<p>通过对堆栈的分析，我们可以发现三个 dex 应该是在一个循环中被依次加载的</p>
<p>接下来我们便跳转到堆栈所打印的偏移来进一步分析下</p>
<p>然而当我们跳转到堆栈回溯中的 <code>libjiagu_64.so</code>  的偏移 <code>0x19b780</code>  或者 <code>0x134598</code>  时，却发现这些地址的值都是 0</p>
<p><img data-src="/360-jiagu/image-20240213232138840.png" alt="image-20240213232138840" style="aspect-ratio:721 / 104;"></p>
<p><img data-src="/360-jiagu/image-20240213232208410.png" alt="image-20240213232208410" style="aspect-ratio:751 / 102;"></p>
<p>我们很快就能想到这里用到的技术应该是先将一块内存标记为可写可执行，随后将字节码填充进去，所以说，我们只需要在壳打开 dex 时，将此时的 <code>libjiagu_64.so</code>  从内存中 dump 下来就可以了</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">dump_so</span><span class="token punctuation">(</span><span class="token parameter">so_name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> libso <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span>so_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[name]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[base]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[size]:"</span><span class="token punctuation">,</span> <span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[path]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">var</span> file_path <span class="token operator">=</span> <span class="token string">"/data/data/com.oacia.apk_protect/"</span> <span class="token operator">+</span> libso<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> libso<span class="token punctuation">.</span>base <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> <span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".so"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">var</span> file_handle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>file_handle <span class="token operator">&amp;&amp;</span> file_handle <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        Memory<span class="token punctuation">.</span><span class="token function">protect</span><span class="token punctuation">(</span><span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token string">'rwx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">var</span> libso_buffer <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        file_handle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>libso_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        file_handle<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        file_handle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[dump]:"</span><span class="token punctuation">,</span> file_path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">var</span> dump_once <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">// 因为会打开三次 dex, 所以这里我们仅 dump 打开第一次 dex 时的 libjiagu_64.so</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_proc_self_maps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">const</span> openPtr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">getExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">const</span> open <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>openPtr<span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">var</span> fakePath <span class="token operator">=</span> <span class="token string">"/data/data/com.oacia.apk_protect/maps_nonexistent"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>openPtr<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NativeCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">pathnameptr<span class="token punctuation">,</span> flag</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">var</span> pathname <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">readUtf8String</span><span class="token punctuation">(</span>pathnameptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">,</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//,Process.getCurrentThreadId()</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pathname<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"maps"</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"find"</span><span class="token punctuation">,</span>pathname<span class="token operator">+</span><span class="token string">", redirect to"</span><span class="token punctuation">,</span>fakePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">var</span> filename <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">allocUtf8String</span><span class="token punctuation">(</span>fakePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">return</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pathname<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"dex"</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dump_once<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                dump_once <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token function">dump_so</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>pathnameptr<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">return</span> fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后再去用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Y4TEVGVC9Tb0ZpeGVy"> SoFixer</span> 修复这个 dump 下来的 so</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>.<span class="token punctuation">\</span>SoFixer-Windows-64.exe <span class="token parameter variable">-s</span> .<span class="token punctuation">\</span>libjiagu_64.so_0x7a69829000_0x274000_open_classes.dex.so <span class="token parameter variable">-o</span> .<span class="token punctuation">\</span>libjiagu_64.so_0x7a69829000_0x274000_open_classes.dex_fix.so <span class="token parameter variable">-m</span> 0x7a69829000 <span class="token parameter variable">-d</span></pre></td></tr></table></figure><p>再次来到偏移 <code>0x19B780</code>  处，可以发现这块空内存已经被填充了数据</p>
<p><img data-src="/360-jiagu/image-20240213233913165.png" alt="image-20240213233913165" style="aspect-ratio:971 / 383;"></p>
<p>接下来我们想知道的是究竟是从什么地方开始被填充了新的数据，所以我们可以用 WinMerge 来让填充和未填充数据的 so 进行比较看看，结果却有了惊人的发现，被填充的数据是从 <code>0xe7000</code>  开始的，它的开头竟然是 ELF 文件的魔数头！？这有意思了，那么就是一个 so 里面藏了另外一个 so 咯～</p>
<p><img data-src="/360-jiagu/image-20240213234737987.png" alt="image-20240213234737987" style="aspect-ratio:1920 / 1080;"></p>
<p>我们写个 python 脚本，把这个 ELF 从 <code>0x0e7000</code>  开始后面的所有字节都复制到新的文件里面</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'libjiagu_64.so_0x7a69829000_0x274000_open_classes.dex.so'</span><span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    s<span class="token operator">=</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'libjiagu_0xe7000.so'</span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0xe7000</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>但是当把这个 elf 提取出来之后拿 <code>010editor</code>  看却发现 <code>program header table</code>  被加密了</p>
<p><img data-src="/360-jiagu/image-20240220220722659.png" alt="image-20240220220722659" style="aspect-ratio:800 / 434;"></p>
<p>这就导致 ida 根本就无法进行正常的分析</p>
<p><img data-src="/360-jiagu/image-20240217212952888.png" alt="image-20240217212952888" style="aspect-ratio:472 / 149;"></p>
<p><img data-src="/360-jiagu/image-20240217213007622.png" alt="image-20240217213007622" style="aspect-ratio:862 / 371;"></p>
<h1 id="主elf解密流程分析"><a class="anchor" href="#主elf解密流程分析">#</a> 主 ELF 解密流程分析</h1>
<p>壳 elf 加载主 elf, 并且 program header 还被加密了，感觉这种形式很像是 <strong>自实现 linker 加固 so</strong></p>
<p>对于这种加固方式，壳 elf 在代码中自己实现了解析 ELF 文件的函数，并将解析结果赋值到 <code>soinfo</code>  结构体中，随后调用 <code>dlopen</code>  进行手动加载</p>
<p>来到 ida 里面在导入表对 <code>dlopen</code>  进行交叉引用，我们看到 dlopen 有 5 个交叉引用</p>
<p><img data-src="/360-jiagu/image-20240218174655222.png" alt="image-20240218174655222" style="aspect-ratio:925 / 277;"></p>
<p>看到第二个交叉引用，来到 <code>sub_3C94</code>  函数，这个 for 循环看起来像是在用符号表通过 dlopen 加载依赖项</p>
<p><img data-src="/360-jiagu/image-20240218174801778.png" alt="image-20240218174801778" style="aspect-ratio:759 / 469;"></p>
<p>向上面翻翻代码，看到这个 switch 就知道找对地方了，这里应该就是自实现 linker 来加载 so 的</p>
<p><img data-src="/360-jiagu/image-20240218175140788.png" alt="image-20240218175140788" style="aspect-ratio:591 / 784;"></p>
<p>因为这和 AOSP 源码 ( <code>android-platform\bionic\linker\linker.cpp</code> ) 中的预链接 ( <code>soinfo::prelink_image</code> ) 这部分的操作极为的相似</p>
<p><img data-src="/360-jiagu/image-20240218175438786.png" alt="image-20240218175438786" style="aspect-ratio:1097 / 757;"></p>
<p>那接下来就在 ida 中导入 soinfo 相关的符号就可以啦</p>
<p>在 ida 中依次点击 <code>View-&gt;Open subviews-&gt;Local Types</code> , 然后按下键盘上的 <code>Insert</code>  将下面的结构体添加到对话框中</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//IMPORTANT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">//ELF64 启用该宏</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__LP64__</span>  <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//ELF32 启用该宏</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//#define __work_around_b_24465209__  1</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="8"></td><td><pre>//https://android.googlesource.com/platform/bionic/+/master/linker/Android.bp</pre></td></tr><tr><td data-num="9"></td><td><pre>架构为 32 位 定义__work_around_b_24465209__宏</pre></td></tr><tr><td data-num="10"></td><td><pre>arch: &#123;</pre></td></tr><tr><td data-num="11"></td><td><pre>        arm: &#123;cflags: ["-D__work_around_b_24465209__"],&#125;,</pre></td></tr><tr><td data-num="12"></td><td><pre>        x86: &#123;cflags: ["-D__work_around_b_24465209__"],&#125;,</pre></td></tr><tr><td data-num="13"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num="14"></td><td><pre>*/</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">//android-platform\bionic\libc\include\link.h</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ElfW</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">)</span> Elf64_ </span><span class="token punctuation">##</span> <span class="token expression">type</span></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ElfW</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">)</span> Elf32_ </span><span class="token punctuation">##</span> <span class="token expression">type</span></span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_common_types.h</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">// Android uses RELA for LP64.</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USE_RELA</span> <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">//android-platform\bionic\libc\kernel\uapi\asm-generic\int-ll64.h</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">//__signed__-->signed</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">signed</span> <span class="token keyword">char</span> __s8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> __u8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">signed</span> <span class="token keyword">short</span> __s16<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> __u16<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">signed</span> <span class="token keyword">int</span> __s32<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> __u32<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">signed</span> <span class="token keyword">long</span> <span class="token keyword">long</span> __s64<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> __u64<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">//A12-src\msm-google\include\uapi\linux\elf.h</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">/* 32-bit ELF base types. */</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">typedef</span> __u32	Elf32_Addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token keyword">typedef</span> __u16	Elf32_Half<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">typedef</span> __u32	Elf32_Off<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token keyword">typedef</span> __s32	Elf32_Sword<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">typedef</span> __u32	Elf32_Word<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">/* 64-bit ELF base types. */</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token keyword">typedef</span> __u64	Elf64_Addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token keyword">typedef</span> __u16	Elf64_Half<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token keyword">typedef</span> __s16	Elf64_SHalf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token keyword">typedef</span> __u64	Elf64_Off<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token keyword">typedef</span> __s32	Elf64_Sword<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token keyword">typedef</span> __u32	Elf64_Word<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token keyword">typedef</span> __u64	Elf64_Xword<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token keyword">typedef</span> __s64	Elf64_Sxword<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dynamic</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  Elf32_Sword d_tag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token keyword">union</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    Elf32_Sword	d_val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    Elf32_Addr	d_ptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token punctuation">&#125;</span> d_un<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Dyn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  Elf64_Sxword d_tag<span class="token punctuation">;</span>		<span class="token comment">/* entry tag value */</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token keyword">union</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    Elf64_Xword d_val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    Elf64_Addr d_ptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token punctuation">&#125;</span> d_un<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Dyn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf32_rel</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  Elf32_Addr	r_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  Elf32_Word	r_info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Rel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_rel</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  Elf64_Addr r_offset<span class="token punctuation">;</span>	<span class="token comment">/* Location at which to apply the action */</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  Elf64_Xword r_info<span class="token punctuation">;</span>	<span class="token comment">/* index and type of relocation */</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Rel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf32_rela</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  Elf32_Addr	r_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  Elf32_Word	r_info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  Elf32_Sword	r_addend<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Rela<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_rela</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  Elf64_Addr r_offset<span class="token punctuation">;</span>	<span class="token comment">/* Location at which to apply the action */</span></pre></td></tr><tr><td data-num="92"></td><td><pre>  Elf64_Xword r_info<span class="token punctuation">;</span>	<span class="token comment">/* index and type of relocation */</span></pre></td></tr><tr><td data-num="93"></td><td><pre>  Elf64_Sxword r_addend<span class="token punctuation">;</span>	<span class="token comment">/* Constant addend used to compute value */</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Rela<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf32_sym</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>  Elf32_Word	st_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>  Elf32_Addr	st_value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>  Elf32_Word	st_size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	st_info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	st_other<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>  Elf32_Half	st_shndx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Sym<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_sym</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  Elf64_Word st_name<span class="token punctuation">;</span>		<span class="token comment">/* Symbol name, index in string tbl */</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	st_info<span class="token punctuation">;</span>	<span class="token comment">/* Type and binding attributes */</span></pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	st_other<span class="token punctuation">;</span>	<span class="token comment">/* No defined meaning, 0 */</span></pre></td></tr><tr><td data-num="109"></td><td><pre>  Elf64_Half st_shndx<span class="token punctuation">;</span>		<span class="token comment">/* Associated section index */</span></pre></td></tr><tr><td data-num="110"></td><td><pre>  Elf64_Addr st_value<span class="token punctuation">;</span>		<span class="token comment">/* Value of the symbol */</span></pre></td></tr><tr><td data-num="111"></td><td><pre>  Elf64_Xword st_size<span class="token punctuation">;</span>		<span class="token comment">/* Associated symbol size */</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Sym<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EI_NIDENT</span>	<span class="token expression"><span class="token number">16</span></span></span></pre></td></tr><tr><td data-num="116"></td><td><pre></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf32_hdr</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	e_ident<span class="token punctuation">[</span>EI_NIDENT<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  Elf32_Half	e_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>  Elf32_Half	e_machine<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  Elf32_Word	e_version<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>  Elf32_Addr	e_entry<span class="token punctuation">;</span>  <span class="token comment">/* Entry point */</span></pre></td></tr><tr><td data-num="123"></td><td><pre>  Elf32_Off	e_phoff<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>  Elf32_Off	e_shoff<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>  Elf32_Word	e_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>  Elf32_Half	e_ehsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>  Elf32_Half	e_phentsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>  Elf32_Half	e_phnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>  Elf32_Half	e_shentsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>  Elf32_Half	e_shnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>  Elf32_Half	e_shstrndx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Ehdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre></pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_hdr</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	e_ident<span class="token punctuation">[</span>EI_NIDENT<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* ELF "magic number" */</span></pre></td></tr><tr><td data-num="136"></td><td><pre>  Elf64_Half e_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>  Elf64_Half e_machine<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>  Elf64_Word e_version<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>  Elf64_Addr e_entry<span class="token punctuation">;</span>		<span class="token comment">/* Entry point virtual address */</span></pre></td></tr><tr><td data-num="140"></td><td><pre>  Elf64_Off e_phoff<span class="token punctuation">;</span>		<span class="token comment">/* Program header table file offset */</span></pre></td></tr><tr><td data-num="141"></td><td><pre>  Elf64_Off e_shoff<span class="token punctuation">;</span>		<span class="token comment">/* Section header table file offset */</span></pre></td></tr><tr><td data-num="142"></td><td><pre>  Elf64_Word e_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>  Elf64_Half e_ehsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>  Elf64_Half e_phentsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>  Elf64_Half e_phnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>  Elf64_Half e_shentsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>  Elf64_Half e_shnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>  Elf64_Half e_shstrndx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Ehdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token comment">/* These constants define the permissions on sections in the program</span></pre></td></tr><tr><td data-num="152"></td><td><pre>   header, p_flags. */</pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PF_R</span>		<span class="token expression"><span class="token number">0x4</span></span></span></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PF_W</span>		<span class="token expression"><span class="token number">0x2</span></span></span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PF_X</span>		<span class="token expression"><span class="token number">0x1</span></span></span></pre></td></tr><tr><td data-num="156"></td><td><pre></pre></td></tr><tr><td data-num="157"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf32_phdr</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="158"></td><td><pre>  Elf32_Word	p_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="159"></td><td><pre>  Elf32_Off	p_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>  Elf32_Addr	p_vaddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>  Elf32_Addr	p_paddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>  Elf32_Word	p_filesz<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>  Elf32_Word	p_memsz<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>  Elf32_Word	p_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>  Elf32_Word	p_align<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Phdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre></pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_phdr</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>  Elf64_Word p_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>  Elf64_Word p_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>  Elf64_Off p_offset<span class="token punctuation">;</span>		<span class="token comment">/* Segment file offset */</span></pre></td></tr><tr><td data-num="172"></td><td><pre>  Elf64_Addr p_vaddr<span class="token punctuation">;</span>		<span class="token comment">/* Segment virtual address */</span></pre></td></tr><tr><td data-num="173"></td><td><pre>  Elf64_Addr p_paddr<span class="token punctuation">;</span>		<span class="token comment">/* Segment physical address */</span></pre></td></tr><tr><td data-num="174"></td><td><pre>  Elf64_Xword p_filesz<span class="token punctuation">;</span>		<span class="token comment">/* Segment size in file */</span></pre></td></tr><tr><td data-num="175"></td><td><pre>  Elf64_Xword p_memsz<span class="token punctuation">;</span>		<span class="token comment">/* Segment size in memory */</span></pre></td></tr><tr><td data-num="176"></td><td><pre>  Elf64_Xword p_align<span class="token punctuation">;</span>		<span class="token comment">/* Segment alignment, file &amp; memory */</span></pre></td></tr><tr><td data-num="177"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Phdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="178"></td><td><pre></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf32_shdr</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="180"></td><td><pre>  Elf32_Word	sh_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="181"></td><td><pre>  Elf32_Word	sh_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="182"></td><td><pre>  Elf32_Word	sh_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="183"></td><td><pre>  Elf32_Addr	sh_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>  Elf32_Off	sh_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>  Elf32_Word	sh_size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="186"></td><td><pre>  Elf32_Word	sh_link<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="187"></td><td><pre>  Elf32_Word	sh_info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>  Elf32_Word	sh_addralign<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="189"></td><td><pre>  Elf32_Word	sh_entsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="190"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Shdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre></pre></td></tr><tr><td data-num="192"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_shdr</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="193"></td><td><pre>  Elf64_Word sh_name<span class="token punctuation">;</span>		<span class="token comment">/* Section name, index in string tbl */</span></pre></td></tr><tr><td data-num="194"></td><td><pre>  Elf64_Word sh_type<span class="token punctuation">;</span>		<span class="token comment">/* Type of section */</span></pre></td></tr><tr><td data-num="195"></td><td><pre>  Elf64_Xword sh_flags<span class="token punctuation">;</span>		<span class="token comment">/* Miscellaneous section attributes */</span></pre></td></tr><tr><td data-num="196"></td><td><pre>  Elf64_Addr sh_addr<span class="token punctuation">;</span>		<span class="token comment">/* Section virtual addr at execution */</span></pre></td></tr><tr><td data-num="197"></td><td><pre>  Elf64_Off sh_offset<span class="token punctuation">;</span>		<span class="token comment">/* Section file offset */</span></pre></td></tr><tr><td data-num="198"></td><td><pre>  Elf64_Xword sh_size<span class="token punctuation">;</span>		<span class="token comment">/* Size of section in bytes */</span></pre></td></tr><tr><td data-num="199"></td><td><pre>  Elf64_Word sh_link<span class="token punctuation">;</span>		<span class="token comment">/* Index of another section */</span></pre></td></tr><tr><td data-num="200"></td><td><pre>  Elf64_Word sh_info<span class="token punctuation">;</span>		<span class="token comment">/* Additional section information */</span></pre></td></tr><tr><td data-num="201"></td><td><pre>  Elf64_Xword sh_addralign<span class="token punctuation">;</span>	<span class="token comment">/* Section alignment */</span></pre></td></tr><tr><td data-num="202"></td><td><pre>  Elf64_Xword sh_entsize<span class="token punctuation">;</span>	<span class="token comment">/* Entry size if section holds table */</span></pre></td></tr><tr><td data-num="203"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Shdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="204"></td><td><pre></pre></td></tr><tr><td data-num="205"></td><td><pre></pre></td></tr><tr><td data-num="206"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_soinfo.h</span></pre></td></tr><tr><td data-num="207"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">linker_dtor_function_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="208"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">linker_ctor_function_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="209"></td><td><pre></pre></td></tr><tr><td data-num="210"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__work_around_b_24465209__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="211"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SOINFO_NAME_LEN</span> <span class="token expression"><span class="token number">128</span></span></span></pre></td></tr><tr><td data-num="212"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="213"></td><td><pre></pre></td></tr><tr><td data-num="214"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">soinfo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="215"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__work_around_b_24465209__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="216"></td><td><pre>  <span class="token keyword">char</span> old_name_<span class="token punctuation">[</span>SOINFO_NAME_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="217"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="218"></td><td><pre>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> phdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="219"></td><td><pre>  <span class="token class-name">size_t</span> phnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="220"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__work_around_b_24465209__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="221"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> unused0<span class="token punctuation">;</span> <span class="token comment">// DO NOT USE, maintained for compatibility.</span></pre></td></tr><tr><td data-num="222"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="223"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> base<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="224"></td><td><pre>  <span class="token class-name">size_t</span> size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="225"></td><td><pre></pre></td></tr><tr><td data-num="226"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__work_around_b_24465209__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="227"></td><td><pre>  <span class="token class-name">uint32_t</span> unused1<span class="token punctuation">;</span>  <span class="token comment">// DO NOT USE, maintained for compatibility.</span></pre></td></tr><tr><td data-num="228"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="229"></td><td><pre></pre></td></tr><tr><td data-num="230"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span><span class="token operator">*</span> dynamic<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="231"></td><td><pre></pre></td></tr><tr><td data-num="232"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__work_around_b_24465209__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="233"></td><td><pre>  <span class="token class-name">uint32_t</span> unused2<span class="token punctuation">;</span> <span class="token comment">// DO NOT USE, maintained for compatibility</span></pre></td></tr><tr><td data-num="234"></td><td><pre>  <span class="token class-name">uint32_t</span> unused3<span class="token punctuation">;</span> <span class="token comment">// DO NOT USE, maintained for compatibility</span></pre></td></tr><tr><td data-num="235"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="236"></td><td><pre></pre></td></tr><tr><td data-num="237"></td><td><pre>  soinfo<span class="token operator">*</span> next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="238"></td><td><pre>  <span class="token class-name">uint32_t</span> flags_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="239"></td><td><pre></pre></td></tr><tr><td data-num="240"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strtab_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="241"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span><span class="token operator">*</span> symtab_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="242"></td><td><pre></pre></td></tr><tr><td data-num="243"></td><td><pre>  <span class="token class-name">size_t</span> nbucket_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="244"></td><td><pre>  <span class="token class-name">size_t</span> nchain_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="245"></td><td><pre>  <span class="token class-name">uint32_t</span><span class="token operator">*</span> bucket_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="246"></td><td><pre>  <span class="token class-name">uint32_t</span><span class="token operator">*</span> chain_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="247"></td><td><pre></pre></td></tr><tr><td data-num="248"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="249"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span> unused4<span class="token punctuation">;</span> <span class="token comment">// DO NOT USE, maintained for compatibility</span></pre></td></tr><tr><td data-num="250"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="251"></td><td><pre></pre></td></tr><tr><td data-num="252"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>USE_RELA<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="253"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Rela<span class="token punctuation">)</span><span class="token operator">*</span> plt_rela_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="254"></td><td><pre>  <span class="token class-name">size_t</span> plt_rela_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="255"></td><td><pre></pre></td></tr><tr><td data-num="256"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Rela<span class="token punctuation">)</span><span class="token operator">*</span> rela_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="257"></td><td><pre>  <span class="token class-name">size_t</span> rela_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="258"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="259"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Rel<span class="token punctuation">)</span><span class="token operator">*</span> plt_rel_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="260"></td><td><pre>  <span class="token class-name">size_t</span> plt_rel_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="261"></td><td><pre></pre></td></tr><tr><td data-num="262"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Rel<span class="token punctuation">)</span><span class="token operator">*</span> rel_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="263"></td><td><pre>  <span class="token class-name">size_t</span> rel_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="264"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="265"></td><td><pre></pre></td></tr><tr><td data-num="266"></td><td><pre>  <span class="token class-name">linker_ctor_function_t</span><span class="token operator">*</span> preinit_array_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="267"></td><td><pre>  <span class="token class-name">size_t</span> preinit_array_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="268"></td><td><pre></pre></td></tr><tr><td data-num="269"></td><td><pre>  <span class="token class-name">linker_ctor_function_t</span><span class="token operator">*</span> init_array_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="270"></td><td><pre>  <span class="token class-name">size_t</span> init_array_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="271"></td><td><pre>  <span class="token class-name">linker_dtor_function_t</span><span class="token operator">*</span> fini_array_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="272"></td><td><pre>  <span class="token class-name">size_t</span> fini_array_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="273"></td><td><pre></pre></td></tr><tr><td data-num="274"></td><td><pre>  <span class="token class-name">linker_ctor_function_t</span> init_func_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="275"></td><td><pre>  <span class="token class-name">linker_dtor_function_t</span> fini_func_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="276"></td><td><pre></pre></td></tr><tr><td data-num="277"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="278"></td><td><pre>#if defined (__arm__)</pre></td></tr><tr><td data-num="279"></td><td><pre>  // ARM EABI section used for stack unwinding.</pre></td></tr><tr><td data-num="280"></td><td><pre>  uint32_t* ARM_exidx;</pre></td></tr><tr><td data-num="281"></td><td><pre>  size_t ARM_exidx_count;</pre></td></tr><tr><td data-num="282"></td><td><pre>#endif</pre></td></tr><tr><td data-num="283"></td><td><pre>  size_t ref_count_;</pre></td></tr><tr><td data-num="284"></td><td><pre>// 怎么找不 link_map 这个类型的声明...</pre></td></tr><tr><td data-num="285"></td><td><pre>  link_map link_map_head;</pre></td></tr><tr><td data-num="286"></td><td><pre></pre></td></tr><tr><td data-num="287"></td><td><pre>  bool constructors_called;</pre></td></tr><tr><td data-num="288"></td><td><pre></pre></td></tr><tr><td data-num="289"></td><td><pre>  // When you read a virtual address from the ELF file, add this</pre></td></tr><tr><td data-num="290"></td><td><pre>  //value to get the corresponding address in the process' address space.</pre></td></tr><tr><td data-num="291"></td><td><pre>  ElfW (Addr) load_bias;</pre></td></tr><tr><td data-num="292"></td><td><pre></pre></td></tr><tr><td data-num="293"></td><td><pre>#if !defined (__LP64__)</pre></td></tr><tr><td data-num="294"></td><td><pre>  bool has_text_relocations;</pre></td></tr><tr><td data-num="295"></td><td><pre>#endif</pre></td></tr><tr><td data-num="296"></td><td><pre>  bool has_DT_SYMBOLIC;</pre></td></tr><tr><td data-num="297"></td><td><pre>*/</pre></td></tr><tr><td data-num="298"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>导入完成后按下 <code>Y</code>  键，将 <code>a1</code>  定义为 <code>soinfo*</code></p>
<p><img data-src="/360-jiagu/image-20240218175803731.png" alt="image-20240218175803731" style="aspect-ratio:676 / 184;"></p>
<p>然后就可以看到这些符号了，但是看这些符号总感觉有些不太对劲，这里不应该出现 <code>a1[1]</code>  或者 <code>a1[2]</code> , 所以我猜测这个 soinfo 有被魔改的痕迹</p>
<p><img data-src="/360-jiagu/image-20240219144353027.png" alt="image-20240219144353027" style="aspect-ratio:750 / 808;"></p>
<p>虽然这个 soinfo 可能有被魔改了，我们还是从 <code>sub_3C94</code>  这个预链接相关函数入手好了，交叉引用发现 <code>sub_3C94</code>  是被 <code>sub_49F0</code>  调用</p>
<p>随后我们来到 <code>sub_49F0</code>  内调用 <code>sub_3C94</code>  函数的位置，向下看，进入 <code>sub_4918</code>  函数中</p>
<p><img data-src="/360-jiagu/image-20240219181823744.png" alt="image-20240219181823744" style="aspect-ratio:782 / 307;"></p>
<p><code>sub_4918</code>  中调用了 <code>sub_5E6C</code> , 我们进入 <code>sub_5E6C</code></p>
<p><img data-src="/360-jiagu/image-20240219181928308.png" alt="image-20240219181928308" style="aspect-ratio:1023 / 727;"></p>
<p>这个函数中出现了 <code>0x38</code>  这个数字， <code>0x38</code>  是这个循环的步长</p>
<p><img data-src="/360-jiagu/image-20240219184405967.png" alt="image-20240219184405967" style="aspect-ratio:1118 / 714;"></p>
<p>0x38 这个数字有什么特殊的含义吗？当然有了！！</p>
<p>我们把刚刚提取出来的 elf 用 <code>010editor</code>  打开，看到 <code>elf_header</code>  的 <code>phentsize</code>  这个字段，这个字段的含义是一个 <code>Program header table</code>  的长度，它正正好好也是 <code>0x38</code></p>
<p><img data-src="/360-jiagu/image-20240219184824589.png" alt="image-20240219184824589" style="aspect-ratio:1907 / 798;"></p>
<p>所以说在 <code>sub_5E6C</code>  中变量 <code>v5</code>  的类型应该是 <code>Elf64_Phdr *</code> , 我们直接重定义类型</p>
<p><img data-src="/360-jiagu/image-20240219185005955.png" alt="image-20240219185005955" style="aspect-ratio:1323 / 307;"></p>
<p>既然知道了真正的 <code>program header table</code>  就是在这个位置的，那我们直接在这个地方把 <code>program header table</code>  整个给 dump 下来不就行了</p>
<p>所以我们直接去 hook <code>sub_5E6C</code>  的三个传入的值</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_5E6C</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x5E6C</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">// fd, buff, len</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>              <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="8"></td><td><pre>              <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">0x38</span><span class="token operator">*</span><span class="token number">0x6</span><span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="9"></td><td><pre>              <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>              <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">base = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>module<span class="token punctuation">.</span>base<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/360-jiagu/image-20240219185724473.png" alt="image-20240219185724473" style="aspect-ratio:1718 / 884;"></p>
<p>上面的第一个 hexdump 就是 <code>program header table</code> , 我们可以用 <code>cyberchef</code>  将 <code>hexdump</code>  转成数组的形式</p>
<p><img data-src="/360-jiagu/image-20240219190012572.png" alt="image-20240219190012572" style="aspect-ratio:1920 / 973;"></p>
<p><code>0x6</code>  则对应着 <code>phnum</code> , 这表示共有 6 个 <code>program header table</code></p>
<p><code>0x793ca38000</code>  表示这个主 ELF 的基址，因为这个主 ELF 的位置在壳 ELF 基址的偏移 <code>0xe7000</code>  处，而最下面这行也已经打印出了壳 ELF 的基址为 <code>0x793c951000</code> , <code>0x793ca38000==0x793c951000+0xe7000</code>  等式成立</p>
<p>至此为止，我们拿到了解密之后的 <code>program header table</code> , 同时我们也知道了 <code>sub_5E6C</code>  传入的三个参数分别是 <code>phdr</code> , <code>phnum</code>  以及 <code>base</code></p>
<p>但是 <code>phdr</code>  成员命名是在 soinfo 偏移的 <code>0x0</code>  的位置</p>
<p><img data-src="/360-jiagu/image-20240219191502430.png" alt="image-20240219191502430" style="aspect-ratio:601 / 296;"></p>
<p>那假如 <code>a1</code>  的类型就是 <code>soinfo*</code> , 为什么在 <code>sub_4918</code>  里面调用 <code>sub_5E6C</code>  传入的是偏移是 <code>232</code>  呢？</p>
<p><img data-src="/360-jiagu/image-20240219191628154.png" alt="image-20240219191628154" style="aspect-ratio:1047 / 206;"></p>
<p>所以 <code>soinfo*</code>  必定有被魔改，同时我们也可以在 soinfo 前填充一个大小为 232 的 char 类型数组看看是什么情况</p>
<p><img data-src="/360-jiagu/image-20240219191808113.png" alt="image-20240219191808113" style="aspect-ratio:355 / 229;"></p>
<p>很好，这验证了我们对于 <code>soinfo*</code>  被魔改的猜测，因为在一切正常的情况之下，函数的调用应该是 <code>sub_5E6C(a1-&gt;phdr, a1-&gt;phnum, a1-&gt;base)</code>  才对</p>
<p><img data-src="/360-jiagu/image-20240219191839316.png" alt="image-20240219191839316" style="aspect-ratio:986 / 145;"></p>
<p>但是我很想知道这个壳 ELF 究竟是如何被解密出来的，那么首先来看看主 ELF 的函数调用链是什么样子的吧～</p>
<p>我写了一个 ida 插件来实现这个过程<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lhL3N0YWxrZXJfdHJhY2Vfc28="> stalker_trace_so</span></p>
<p>在 IDA 中使用 <code>Edit-&gt;Plugins-&gt;stalker_trace_so</code>  后，在 so 所在的目录下会生成一个 js 脚本，我们用 frida 注入到 apk 中即可，需要注意的是 <code>so_name</code>  需要改成 <code>libjiagu_64.so</code></p>
<p><img data-src="/360-jiagu/image-20231118152818874.png" alt="image-20231118152818874" style="aspect-ratio:733 / 171;"></p>
<p>打印出来的完整日志如下</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>call1<span class="token operator">:</span>JNI_OnLoad</pre></td></tr><tr><td data-num="2"></td><td><pre>call2<span class="token operator">:</span><span class="token class-name">j_interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num="3"></td><td><pre>call3<span class="token operator">:</span><span class="token class-name">interpreter_wrap_int64_t</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>call4<span class="token operator">:</span>getenv</pre></td></tr><tr><td data-num="5"></td><td><pre>call5<span class="token operator">:</span>sub_13908</pre></td></tr><tr><td data-num="6"></td><td><pre>call6<span class="token operator">:</span>inotify_add_watch</pre></td></tr><tr><td data-num="7"></td><td><pre>call7<span class="token operator">:</span>sub_11220</pre></td></tr><tr><td data-num="8"></td><td><pre>call8<span class="token operator">:</span>fopen</pre></td></tr><tr><td data-num="9"></td><td><pre>call9<span class="token operator">:</span>sub_9DD8</pre></td></tr><tr><td data-num="10"></td><td><pre>call10<span class="token operator">:</span>sub_E3E0</pre></td></tr><tr><td data-num="11"></td><td><pre>call11<span class="token operator">:</span>strtol</pre></td></tr><tr><td data-num="12"></td><td><pre>call12<span class="token operator">:</span>feof</pre></td></tr><tr><td data-num="13"></td><td><pre>call13<span class="token operator">:</span>raise</pre></td></tr><tr><td data-num="14"></td><td><pre>call14<span class="token operator">:</span>memset</pre></td></tr><tr><td data-num="15"></td><td><pre>call15<span class="token operator">:</span>sub_C918</pre></td></tr><tr><td data-num="16"></td><td><pre>call16<span class="token operator">:</span>sub_9988</pre></td></tr><tr><td data-num="17"></td><td><pre>call17<span class="token operator">:</span>sub_9964</pre></td></tr><tr><td data-num="18"></td><td><pre>call18<span class="token operator">:</span>sub_9AC4</pre></td></tr><tr><td data-num="19"></td><td><pre>call19<span class="token operator">:</span>j_ffi_prep_cif</pre></td></tr><tr><td data-num="20"></td><td><pre>call20<span class="token operator">:</span>ffi_prep_cif</pre></td></tr><tr><td data-num="21"></td><td><pre>call21<span class="token operator">:</span>j_ffi_prep_cif_machdep</pre></td></tr><tr><td data-num="22"></td><td><pre>call22<span class="token operator">:</span>ffi_prep_cif_machdep</pre></td></tr><tr><td data-num="23"></td><td><pre>call23<span class="token operator">:</span>j_ffi_call</pre></td></tr><tr><td data-num="24"></td><td><pre>call24<span class="token operator">:</span>ffi_call</pre></td></tr><tr><td data-num="25"></td><td><pre>call25<span class="token operator">:</span>sub_1674C</pre></td></tr><tr><td data-num="26"></td><td><pre>call26<span class="token operator">:</span>j_ffi_call_SYSV</pre></td></tr><tr><td data-num="27"></td><td><pre>call27<span class="token operator">:</span>ffi_call_SYSV</pre></td></tr><tr><td data-num="28"></td><td><pre>call28<span class="token operator">:</span>sub_167BC</pre></td></tr><tr><td data-num="29"></td><td><pre>call29<span class="token operator">:</span>sub_1647C</pre></td></tr><tr><td data-num="30"></td><td><pre>call30<span class="token operator">:</span>sub_163DC</pre></td></tr><tr><td data-num="31"></td><td><pre>call31<span class="token operator">:</span>sub_9900</pre></td></tr><tr><td data-num="32"></td><td><pre>call32<span class="token operator">:</span>sub_94BC</pre></td></tr><tr><td data-num="33"></td><td><pre>call33<span class="token operator">:</span>inotify_init</pre></td></tr><tr><td data-num="34"></td><td><pre>call34<span class="token operator">:</span>fmod</pre></td></tr><tr><td data-num="35"></td><td><pre>call35<span class="token operator">:</span>strncpy</pre></td></tr><tr><td data-num="36"></td><td><pre>call36<span class="token operator">:</span>_Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRi</pre></td></tr><tr><td data-num="37"></td><td><pre>call37<span class="token operator">:</span>sub_9E58</pre></td></tr><tr><td data-num="38"></td><td><pre>call38<span class="token operator">:</span>sub_999C</pre></td></tr><tr><td data-num="39"></td><td><pre>call39<span class="token operator">:</span>sub_10964</pre></td></tr><tr><td data-num="40"></td><td><pre>call40<span class="token operator">:</span>j_lseek_1</pre></td></tr><tr><td data-num="41"></td><td><pre>call41<span class="token operator">:</span>lseek</pre></td></tr><tr><td data-num="42"></td><td><pre>call42<span class="token operator">:</span>sub_96E0</pre></td></tr><tr><td data-num="43"></td><td><pre>call43<span class="token operator">:</span>sub_8000</pre></td></tr><tr><td data-num="44"></td><td><pre>call44<span class="token operator">:</span>dlopen</pre></td></tr><tr><td data-num="45"></td><td><pre>call45<span class="token operator">:</span>sub_60E0</pre></td></tr><tr><td data-num="46"></td><td><pre>call46<span class="token operator">:</span>sub_6544</pre></td></tr><tr><td data-num="47"></td><td><pre>call47<span class="token operator">:</span>sub_4B54</pre></td></tr><tr><td data-num="48"></td><td><pre>call48<span class="token operator">:</span>sub_6128</pre></td></tr><tr><td data-num="49"></td><td><pre>call49<span class="token operator">:</span>_ZN9__arm_c_19__arm_c_0Ev</pre></td></tr><tr><td data-num="50"></td><td><pre>call50<span class="token operator">:</span>sub_A3EC</pre></td></tr><tr><td data-num="51"></td><td><pre>call51<span class="token operator">:</span>sub_99CC</pre></td></tr><tr><td data-num="52"></td><td><pre>call52<span class="token operator">:</span>sub_9944</pre></td></tr><tr><td data-num="53"></td><td><pre>call53<span class="token operator">:</span>sub_6484</pre></td></tr><tr><td data-num="54"></td><td><pre>call54<span class="token operator">:</span>sub_6590</pre></td></tr><tr><td data-num="55"></td><td><pre>call55<span class="token operator">:</span>prctl</pre></td></tr><tr><td data-num="56"></td><td><pre>call56<span class="token operator">:</span>sub_6698</pre></td></tr><tr><td data-num="57"></td><td><pre>call57<span class="token operator">:</span>sub_9FFC</pre></td></tr><tr><td data-num="58"></td><td><pre>call58<span class="token operator">:</span>j_lseek_3</pre></td></tr><tr><td data-num="59"></td><td><pre>call59<span class="token operator">:</span>j_lseek_2</pre></td></tr><tr><td data-num="60"></td><td><pre>call60<span class="token operator">:</span>j_lseek_0</pre></td></tr><tr><td data-num="61"></td><td><pre>call61<span class="token operator">:</span>sub_9A90</pre></td></tr><tr><td data-num="62"></td><td><pre>call62<span class="token operator">:</span>sub_5F20</pre></td></tr><tr><td data-num="63"></td><td><pre>call63<span class="token operator">:</span>sub_6044</pre></td></tr><tr><td data-num="64"></td><td><pre>call64<span class="token operator">:</span>sub_3574</pre></td></tr><tr><td data-num="65"></td><td><pre>call65<span class="token operator">:</span>uncompress</pre></td></tr><tr><td data-num="66"></td><td><pre>call66<span class="token operator">:</span>sub_49F0</pre></td></tr><tr><td data-num="67"></td><td><pre>call67<span class="token operator">:</span>sub_5400</pre></td></tr><tr><td data-num="68"></td><td><pre>call68<span class="token operator">:</span>sub_5478</pre></td></tr><tr><td data-num="69"></td><td><pre>call69<span class="token operator">:</span>sub_5B08</pre></td></tr><tr><td data-num="70"></td><td><pre>call70<span class="token operator">:</span>sub_5650</pre></td></tr><tr><td data-num="71"></td><td><pre>call71<span class="token operator">:</span>sub_580C</pre></td></tr><tr><td data-num="72"></td><td><pre>call72<span class="token operator">:</span>open</pre></td></tr><tr><td data-num="73"></td><td><pre>call73<span class="token operator">:</span>atoi</pre></td></tr><tr><td data-num="74"></td><td><pre>call74<span class="token operator">:</span>sub_3C94</pre></td></tr><tr><td data-num="75"></td><td><pre>call75<span class="token operator">:</span>strncmp</pre></td></tr><tr><td data-num="76"></td><td><pre>call76<span class="token operator">:</span>sub_4918</pre></td></tr><tr><td data-num="77"></td><td><pre>call77<span class="token operator">:</span>sub_4000</pre></td></tr><tr><td data-num="78"></td><td><pre>call78<span class="token operator">:</span>sub_41B4</pre></td></tr><tr><td data-num="79"></td><td><pre>call79<span class="token operator">:</span>sub_35AC</pre></td></tr><tr><td data-num="80"></td><td><pre>call80<span class="token operator">:</span>sigaction</pre></td></tr><tr><td data-num="81"></td><td><pre>call81<span class="token operator">:</span>sub_5E6C</pre></td></tr><tr><td data-num="82"></td><td><pre>call82<span class="token operator">:</span>sub_5444</pre></td></tr><tr><td data-num="83"></td><td><pre>call83<span class="token operator">:</span>sub_633C</pre></td></tr><tr><td data-num="84"></td><td><pre>call84<span class="token operator">:</span>sub_8130</pre></td></tr><tr><td data-num="85"></td><td><pre>call85<span class="token operator">:</span>sub_4C70</pre></td></tr><tr><td data-num="86"></td><td><pre>call86<span class="token operator">:</span>sub_825C</pre></td></tr><tr><td data-num="87"></td><td><pre>call87<span class="token operator">:</span>sub_8B50</pre></td></tr><tr><td data-num="88"></td><td><pre>call88<span class="token operator">:</span>sub_8ED4</pre></td></tr><tr><td data-num="89"></td><td><pre>call89<span class="token operator">:</span>sub_8430</pre></td></tr><tr><td data-num="90"></td><td><pre>call90<span class="token operator">:</span>interpreter_wrap_int64_t_bridge</pre></td></tr><tr><td data-num="91"></td><td><pre>call91<span class="token operator">:</span>sub_9D60</pre></td></tr><tr><td data-num="92"></td><td><pre>call92<span class="token operator">:</span>sub_166C4</pre></td></tr><tr><td data-num="93"></td><td><pre>call93<span class="token operator">:</span>memcpy</pre></td></tr><tr><td data-num="94"></td><td><pre>call94<span class="token operator">:</span>_Z9__arm_a_2PcmS_Rii</pre></td></tr><tr><td data-num="95"></td><td><pre>call95<span class="token operator">:</span>j_ffi_prep_cif_var</pre></td></tr><tr><td data-num="96"></td><td><pre>call96<span class="token operator">:</span>ffi_prep_cif_var</pre></td></tr></table></figure><p>我们以 <code>sub_3C94</code>  为起点开始分析，因为这是我们通过 <code>dlopen</code>  交叉引用找到的<strong>自实现 linker 加固 so</strong> 的一个功能函数</p>
<p>对 <code>sub_3C94</code>  不断按下 <code>X</code>  查看交叉引用，得到如下的调用关系 <code>sub_4B54-&gt;sub_49F0-&gt;sub_3C94</code></p>
<p><code>sub_4B54</code>  可能被 <code>sub_8000</code>  或 <code>sub_8C74</code>  调用</p>
<p><img data-src="/360-jiagu/image-20240219195550519.png" alt="image-20240219195550519" style="aspect-ratio:879 / 220;"></p>
<p>我们将 <code>stalker_trace_so</code>  打印出来的内容中，提取关键的部分拿过来看看，说明 <code>sub_4B54</code>  是被 <code>sub_8000</code>  调用的</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>call43<span class="token operator">:</span>sub_8000 <span class="token operator">&lt;</span><span class="token operator">--</span></pre></td></tr><tr><td data-num="2"></td><td><pre>call44<span class="token operator">:</span>dlopen</pre></td></tr><tr><td data-num="3"></td><td><pre>call45<span class="token operator">:</span>sub_60E0</pre></td></tr><tr><td data-num="4"></td><td><pre>call46<span class="token operator">:</span>sub_6544</pre></td></tr><tr><td data-num="5"></td><td><pre>call47<span class="token operator">:</span>sub_4B54 <span class="token operator">&lt;</span><span class="token operator">--</span></pre></td></tr><tr><td data-num="6"></td><td><pre>call48<span class="token operator">:</span>sub_6128</pre></td></tr><tr><td data-num="7"></td><td><pre>call49<span class="token operator">:</span>_ZN9__arm_c_19__arm_c_0Ev</pre></td></tr><tr><td data-num="8"></td><td><pre>call50<span class="token operator">:</span>sub_A3EC</pre></td></tr><tr><td data-num="9"></td><td><pre>call51<span class="token operator">:</span>sub_99CC</pre></td></tr><tr><td data-num="10"></td><td><pre>call52<span class="token operator">:</span>sub_9944</pre></td></tr><tr><td data-num="11"></td><td><pre>call53<span class="token operator">:</span>sub_6484</pre></td></tr><tr><td data-num="12"></td><td><pre>call54<span class="token operator">:</span>sub_6590</pre></td></tr><tr><td data-num="13"></td><td><pre>call55<span class="token operator">:</span>prctl</pre></td></tr><tr><td data-num="14"></td><td><pre>call56<span class="token operator">:</span>sub_6698</pre></td></tr><tr><td data-num="15"></td><td><pre>call57<span class="token operator">:</span>sub_9FFC</pre></td></tr><tr><td data-num="16"></td><td><pre>call58<span class="token operator">:</span>j_lseek_3</pre></td></tr><tr><td data-num="17"></td><td><pre>call59<span class="token operator">:</span>j_lseek_2</pre></td></tr><tr><td data-num="18"></td><td><pre>call60<span class="token operator">:</span>j_lseek_0</pre></td></tr><tr><td data-num="19"></td><td><pre>call61<span class="token operator">:</span>sub_9A90</pre></td></tr><tr><td data-num="20"></td><td><pre>call62<span class="token operator">:</span>sub_5F20</pre></td></tr><tr><td data-num="21"></td><td><pre>call63<span class="token operator">:</span>sub_6044</pre></td></tr><tr><td data-num="22"></td><td><pre>call64<span class="token operator">:</span>sub_3574</pre></td></tr><tr><td data-num="23"></td><td><pre>call65<span class="token operator">:</span>uncompress</pre></td></tr><tr><td data-num="24"></td><td><pre>call66<span class="token operator">:</span>sub_49F0 <span class="token operator">&lt;</span><span class="token operator">--</span></pre></td></tr><tr><td data-num="25"></td><td><pre>call67<span class="token operator">:</span>sub_5400</pre></td></tr><tr><td data-num="26"></td><td><pre>call68<span class="token operator">:</span>sub_5478</pre></td></tr><tr><td data-num="27"></td><td><pre>call69<span class="token operator">:</span>sub_5B08</pre></td></tr><tr><td data-num="28"></td><td><pre>call70<span class="token operator">:</span>sub_5650</pre></td></tr><tr><td data-num="29"></td><td><pre>call71<span class="token operator">:</span>sub_580C</pre></td></tr><tr><td data-num="30"></td><td><pre>call72<span class="token operator">:</span>open</pre></td></tr><tr><td data-num="31"></td><td><pre>call73<span class="token operator">:</span>atoi</pre></td></tr><tr><td data-num="32"></td><td><pre>call74<span class="token operator">:</span>sub_3C94 <span class="token operator">&lt;</span><span class="token operator">--</span></pre></td></tr></table></figure><p><code>sub_8000</code>  的函数长这个样子，请记住第 25 行 <code>0xB8010</code>  这个数字，后面会派上用场的</p>
<p><img data-src="/360-jiagu/image-20240219200830705.png" alt="image-20240219200830705" style="aspect-ratio:791 / 678;"></p>
<p>跟着函数调用链一处一处的在 IDA 中跳转到相应的地址进行查看，在 <code>call62:sub_5F20</code>  我们发现了有意思的代码</p>
<p>这个函数，一眼 RC4 呀</p>
<p><img data-src="/360-jiagu/image-20240219200139731.png" alt="image-20240219200139731" style="aspect-ratio:1387 / 810;"></p>
<p>用 frida 去 hook 一下这个函数看看 RC4 的密钥是什么</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_5f20_guess_rc4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 像是 RC4 的样子，hook 看看</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x5f20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">// fd, buff, len</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>              <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="8"></td><td><pre>              <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">0x10</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="9"></td><td><pre>              <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>              <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>              <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="15"></td><td><pre>              <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">256</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="16"></td><td><pre>              <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>              <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/360-jiagu/image-20240219200302071.png" alt="image-20240219200302071" style="aspect-ratio:1214 / 231;"></p>
<p>所以密钥就是这个咯</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>key <span class="token operator">=</span> <span class="token string">b"vUV4#\x91#SVt"</span></pre></td></tr></table></figure><p>继续跟着函数调用链走，在 <code>call63:sub_6044</code>  我们发现了 RC4 的解密函数</p>
<p><img data-src="/360-jiagu/image-20240219200510607.png" alt="image-20240219200510607" style="aspect-ratio:811 / 731;"></p>
<p>hook 一下 <code>call63:sub_6044</code>  看看到底给什么数据解密了</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">var</span> rc4_enc_text_addr<span class="token punctuation">,</span>rc4_enc_size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_rc4_enc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x6044</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token comment">// fd, buff, len</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            rc4_enc_text_addr <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            rc4_enc_size <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>              <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="11"></td><td><pre>              <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">0x30</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="12"></td><td><pre>              <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>              <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>rc4_enc_text_addr<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>              <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="21"></td><td><pre>              <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">0x30</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="22"></td><td><pre>              <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>              <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/360-jiagu/image-20240219200703480.png" alt="image-20240219200703480" style="aspect-ratio:1193 / 269;"></p>
<p>这个函数的第二个参数是 <code>0xb8010</code> , 感觉是解密的数据的长度的样子，而且这个数字，有没有感觉在哪里见过呢？</p>
<p>没错，这个数字刚刚就出现在 <code>sub_8000</code>  中</p>
<p><img data-src="/360-jiagu/image-20240219201000793.png" alt="image-20240219201000793" style="aspect-ratio:479 / 184;"></p>
<p>而 <code>v5[0]</code>  的值是 <code>qword_2E270</code> , 这个数组也是 <code>01 18 25 e7</code>  开头的</p>
<p><img data-src="/360-jiagu/image-20240219201131482.png" alt="image-20240219201131482" style="aspect-ratio:1100 / 471;"></p>
<p>继续跟着调用链走，接下来是调用 <code>call65:uncompress</code> , 进行解压缩操作</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_uncompress_res</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"uncompress"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hook uncompress"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>              <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="8"></td><td><pre>              <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">0x30</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="9"></td><td><pre>              <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>              <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token function">dump_memory</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">uncompress_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>我们发现解压缩的数据，前面四个字节 <code>b9 0e 1a 00</code>  没有包含在解压缩的字节之内</p>
<p><img data-src="/360-jiagu/image-20240219202037098.png" alt="image-20240219202037098" style="aspect-ratio:1193 / 464;"></p>
<p>现在既然我们已经知道了主 ELF 在壳 ELF 中的位置，以及解密的算法，那我们直接从解压 apk, 找到里面的 <code>assets/libjiagu_a64.so</code> , 不就能直接把壳 ELF 解密出来咯</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> zlib</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> struct</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">def</span> <span class="token function">RC4</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    S <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    j <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    out <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment"># KSA Phase</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment"># PRGA Phase</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    i <span class="token operator">=</span> j <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">for</span> ch <span class="token keyword">in</span> data<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        out<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ch <span class="token operator">^</span> S<span class="token punctuation">[</span><span class="token punctuation">(</span>S<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">return</span> out</pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">def</span> <span class="token function">RC4decrypt</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">return</span> RC4<span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>wrap_elf_start <span class="token operator">=</span> <span class="token number">0x1e270</span></pre></td></tr><tr><td data-num="28"></td><td><pre>wrap_elf_size <span class="token operator">=</span> <span class="token number">0xb8010</span></pre></td></tr><tr><td data-num="29"></td><td><pre>key <span class="token operator">=</span> <span class="token string">b"vUV4#\x91#SVt"</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'com.oacia.apk_protect/assets/libjiagu_a64.so'</span><span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    wrap_elf <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"># 对密文进行解密</span></pre></td></tr><tr><td data-num="35"></td><td><pre>dec_compress_elf <span class="token operator">=</span> RC4decrypt<span class="token punctuation">(</span>wrap_elf<span class="token punctuation">[</span>wrap_elf_start<span class="token punctuation">:</span>wrap_elf_start<span class="token operator">+</span>wrap_elf_size<span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>dec_elf <span class="token operator">=</span> zlib<span class="token punctuation">.</span>decompress<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>dec_compress_elf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'wrap_elf'</span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>dec_elf<span class="token punctuation">)</span></pre></td></tr></table></figure><p>解密完成后，我们发现 <code>0x1a0eb9</code>  应该表示解压缩之后数据的大小</p>
<p><img data-src="/360-jiagu/image-20240220214503336.png" alt="image-20240220214503336" style="aspect-ratio:926 / 305;"></p>
<p><img data-src="/360-jiagu/image-20240220131405321.png" alt="image-20240220131405321" style="aspect-ratio:831 / 258;"></p>
<p><code>wrap_elf</code>  的前半部分是一大堆莫名其妙有很多 <code>D3</code>  的东西，但是看到中间还是发现了壳 ELF 的身影</p>
<p><img data-src="/360-jiagu/image-20240219203139130.png" alt="image-20240219203139130" style="aspect-ratio:811 / 423;"></p>
<p>我们以 <code>.ELF</code>  为标志将这两部分分离一下</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'wrap_elf'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    wrap_elf <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>ELF_magic <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0x45</span><span class="token punctuation">,</span> <span class="token number">0x4C</span><span class="token punctuation">,</span> <span class="token number">0x46</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>wrap_elf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ELF_magic<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> wrap_elf<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ELF_magic<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> ELF_magic<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'wrap_elf_part1'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>wrap_elf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'wrap_elf_part2'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>wrap_elf<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">break</span></pre></td></tr></table></figure><p>跟着函数调用链来到 <code>call69:sub_5B08</code> , 这里又出现了 <code>0x38</code> , 并且 <code>word_38</code>  跳转过去的值为 6</p>
<p><img data-src="/360-jiagu/image-20240220000932490.png" alt="image-20240220000932490" style="aspect-ratio:677 / 365;"></p>
<p>这正好和 <code>phentsize</code>  和 <code>phnum</code>  的值相对应</p>
<p><img data-src="/360-jiagu/image-20240220001104708.png" alt="image-20240220001104708" style="aspect-ratio:1079 / 51;"></p>
<p>所以可想而知，这又是一个关键点了，往下看一下代码，发现了循环异或，那我们不妨用 frida 把 <code>v4</code>  的值 hook 下来看看是什么</p>
<p><img data-src="/360-jiagu/image-20240220001342895.png" alt="image-20240220001342895" style="aspect-ratio:641 / 741;"></p>
<p>v4 的值出现了那么多的 <code>d3</code></p>
<p><img data-src="/360-jiagu/image-20240220001528743.png" alt="image-20240220001528743" style="aspect-ratio:1200 / 470;"></p>
<p>而这就是 <code>wrap_elf</code>  的前半部分那一大堆我们看不懂的字节</p>
<p><img data-src="/360-jiagu/image-20240220012621743.png" alt="image-20240220012621743" style="aspect-ratio:794 / 494;"></p>
<p>接下来用来解密的循环就是一个 arm64 的 neon 运算</p>
<p><img data-src="/360-jiagu/image-20240220003908902.png" alt="image-20240220003908902" style="aspect-ratio:645 / 327;"></p>
<p>官网可以找到<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXJtLmNvbS9hcmNoaXRlY3R1cmVzL2luc3RydWN0aW9uLXNldHMvaW50cmluc2ljcy8jcT12ZHVwcV9uX3M4"> vdupq_n_s8</span> 和<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXJtLmNvbS9hcmNoaXRlY3R1cmVzL2luc3RydWN0aW9uLXNldHMvaW50cmluc2ljcy8jcT12ZW9ycV9zOA=="> veorq_s8</span>, 根据函数描述可以知道这里用向量运算，把向量中的每一个元素都异或了 <code>0xd3</code></p>
<p><img data-src="/360-jiagu/image-20240220004233903.png" alt="image-20240220004233903" style="aspect-ratio:1225 / 511;"></p>
<p><img data-src="/360-jiagu/image-20240220004029770.png" alt="image-20240220004029770" style="aspect-ratio:1232 / 517;"></p>
<p>对 <code>sub_5B08</code>  进行分析之后，我们便可以知道 <code>wrap_elf_part1</code>  的读取方式是第一个字节表示被异或的数字，这里是 <code>0xD3</code> , 后面的四个字节表示一个段的长度，随后读取指定长度的字节并异或，之后再读取四个字节获取到下一个段的长度，以此类推，直到读取到文件末尾</p>
<p><img data-src="/360-jiagu/image-20240220012939262.png" alt="image-20240220012939262" style="aspect-ratio:800 / 628;"></p>
<p>在 <code>sub_5B08</code>  的最后，因为 <code>v31</code> , <code>v19</code> , <code>v43</code> , <code>v7</code>  代表对应的数据组的长度，所以这里共有四个数据组，而为了表示每一个数据组的长度共需占用 <code>4*4=16</code>  字节，并且文件开头还有 <code>1</code>  位的异或值，于是这些长度加起来， <code>*(a1 + 0x98)</code>  的偏移就来到了主 ELF 的魔术头 <code>.ELF</code>  的位置了</p>
<p><img data-src="/360-jiagu/image-20240220013039190.png" alt="image-20240220013039190" style="aspect-ratio:630 / 66;"></p>
<p><img data-src="/360-jiagu/image-20240220013502056.png" alt="image-20240220013502056" style="aspect-ratio:900 / 363;"></p>
<p>我们可以在 <code>sub_5B08</code>  中为变量 <code>a1</code>  定义一个结构体，成员分别表示数据组的 1,2,3,4 这四个部分，这样我们就知道这四个部分分别被用到什么地方了</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">deal_extra</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">char</span> blank<span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">int</span> phnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>extra_part1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">int</span> phdr_size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">char</span> blank2<span class="token punctuation">[</span><span class="token number">36</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>extra_part2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>extra_part3<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>extra_part4<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>main_elf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="/360-jiagu/image-20240220023743626.png" alt="image-20240220023743626" style="aspect-ratio:656 / 200;"></p>
<p>接下来再捋一下函数的调用链 <code>sub_49F0-&gt;sub_5478(&amp;v16, a1, v4)-&gt;sub_5B08(a1, a2, a3)</code> , 在 <code>sub_5B08</code>  中，我们把 <code>a1</code>  的类型定义成了 <code>deal_extra</code> , 所以理所应当的，我们也把 <code>sub_49F0</code>  中的变量 <code>v16</code>  的类型定义为 <code>deal_extra</code></p>
<p>在 <code>sub_49F0</code>  中我们发现成员 <code>extra_part</code>  赋值给了变量 <code>v7</code> , 所以我们也为 <code>v7</code>  建立一个结构体让 v7 的偏移可以对应这些变量</p>
<p><img data-src="/360-jiagu/image-20240220024254105.png" alt="image-20240220024254105" style="aspect-ratio:507 / 288;"></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">deal_extra_B</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">char</span> blank<span class="token punctuation">[</span><span class="token number">232</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>extra_part1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">char</span> blank1<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">int</span> phnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>extra_part4<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">char</span> blank2<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>extra_part2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">char</span> blank3<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">int</span> <span class="token operator">*</span>extra_part3<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="/360-jiagu/image-20240220024130734.png" alt="image-20240220024130734" style="aspect-ratio:595 / 331;"></p>
<p>这样做有什么意义呢？</p>
<p>我们发现变量 <code>v7</code>  分别被传入到了 <code>sub_3C94</code>  和 <code>sub_4918</code>  中，我们分别进去看看</p>
<p><img data-src="/360-jiagu/image-20240220024433454.png" alt="image-20240220024433454" style="aspect-ratio:785 / 287;"></p>
<p>在 <code>sub_3C94</code>  中解析了 <code>extra_part4</code> , 显而易见，这个 <code>switch</code>  是用来处理动态链接库的，即 <code>extra_part4</code>  对应 <code>.dynamic</code>  段</p>
<p><img data-src="/360-jiagu/image-20240220024522541.png" alt="image-20240220024522541" style="aspect-ratio:801 / 716;"></p>
<p><img data-src="/360-jiagu/image-20240220024831366.png" alt="image-20240220024831366" style="aspect-ratio:1097 / 757;"></p>
<p>在 <code>sub_4918</code>  中， <code>extra_part2</code>  和 <code>extra_part3</code>  被传入到 <code>sub_4000</code>  中</p>
<p><img data-src="/360-jiagu/image-20240220024916186.png" alt="image-20240220024916186" style="aspect-ratio:972 / 248;"></p>
<p>而这个函数中的 <code>switch</code>  是用来处理重定位的，因为重定位主要有基址重定位和符号重定位，这两个的值分别是 <code>0x403</code>  和 <code>0x402</code></p>
<p>所以 <code>extra_part2</code>  和 <code>extra_part3</code>  分别对应着 <code>.rela.dyn</code>  (403 重定位) 和 <code>.rela.plt</code>  (402 重定位)</p>
<p><img data-src="/360-jiagu/image-20240220025025814.png" alt="image-20240220025025814" style="aspect-ratio:713 / 577;"></p>
<p><img data-src="/360-jiagu/image-20240220145850194.png" alt="image-20240220145850194" style="aspect-ratio:1100 / 208;"></p>
<p>而之后 <code>extra_part1</code>  被传入到了 <code>sub_5E6C</code>  中</p>
<p><img data-src="/360-jiagu/image-20240220025453629.png" alt="image-20240220025453629" style="aspect-ratio:1189 / 232;"></p>
<p>而来到 <code>sub_5E6C</code>  也来到了我们最开始分析的起点 (兜兜转转又回来了), 所以 <code>extra_part1</code>  表示 <code>program header table</code></p>
<p><img data-src="/360-jiagu/image-20240220025540021.png" alt="image-20240220025540021" style="aspect-ratio:1270 / 693;"></p>
<p>至此为止，四个数据组所对应的段都分析完成</p>
<ul>
<li><code>数据组1</code>  表示 <code>program header table</code></li>
<li><code>数据组2</code>  表示 <code>.rela.plt</code></li>
<li><code>数据组3</code>  表示 <code>.rela.dyn</code></li>
<li><code>数据组4</code>  表示 <code>.dynamic</code></li>
</ul>
<p>所以接下来，写个脚本把这四个数据组给分离成单独的文件咯</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> copy</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> zlib</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">def</span> <span class="token function">RC4</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    S <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    j <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    out <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment"># KSA Phase</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment"># PRGA Phase</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    i <span class="token operator">=</span> j <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">for</span> ch <span class="token keyword">in</span> data<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        out<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ch <span class="token operator">^</span> S<span class="token punctuation">[</span><span class="token punctuation">(</span>S<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">return</span> out</pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">def</span> <span class="token function">RC4decrypt</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> RC4<span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>wrap_elf_start <span class="token operator">=</span> <span class="token number">0x1e270</span></pre></td></tr><tr><td data-num="30"></td><td><pre>wrap_elf_size <span class="token operator">=</span> <span class="token number">0xb8010</span></pre></td></tr><tr><td data-num="31"></td><td><pre>key <span class="token operator">=</span> <span class="token string">b"vUV4#\x91#SVt"</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'com.oacia.apk_protect/assets/libjiagu_a64.so'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    wrap_elf <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment"># 对密文进行解密</span></pre></td></tr><tr><td data-num="36"></td><td><pre>dec_compress_elf <span class="token operator">=</span> RC4decrypt<span class="token punctuation">(</span>wrap_elf<span class="token punctuation">[</span>wrap_elf_start<span class="token punctuation">:</span>wrap_elf_start <span class="token operator">+</span> wrap_elf_size<span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>dec_elf <span class="token operator">=</span> zlib<span class="token punctuation">.</span>decompress<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>dec_compress_elf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'wrap_elf'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>dec_elf<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">part</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        self<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">b''</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        self<span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        self<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>index <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="51"></td><td><pre>extra_part <span class="token operator">=</span> <span class="token punctuation">[</span>part<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>seg <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"phdr"</span><span class="token punctuation">,</span> <span class="token string">".rela.plt"</span><span class="token punctuation">,</span> <span class="token string">".rela.dyn"</span><span class="token punctuation">,</span> <span class="token string">".dynamic"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="54"></td><td><pre>v_xor <span class="token operator">=</span> dec_elf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    size <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>dec_elf<span class="token punctuation">[</span>index<span class="token punctuation">:</span>index <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    index <span class="token operator">+=</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    extra_part<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> seg<span class="token punctuation">[</span>i<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    extra_part<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">^</span> v_xor<span class="token punctuation">,</span> dec_elf<span class="token punctuation">[</span>index<span class="token punctuation">:</span>index <span class="token operator">+</span> size<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    extra_part<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">=</span> size</pre></td></tr><tr><td data-num="62"></td><td><pre>    index <span class="token operator">+=</span> size</pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token keyword">for</span> p <span class="token keyword">in</span> extra_part<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">if</span> p<span class="token punctuation">.</span>value<span class="token operator">!=</span><span class="token string">b''</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        filename <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"libjiagu.so_</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">&#123;</span>p<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[</span><span class="token interpolation"><span class="token punctuation">&#123;</span>p<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string">] get </span><span class="token interpolation"><span class="token punctuation">&#123;</span>filename<span class="token punctuation">&#125;</span></span><span class="token string">, size: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>p<span class="token punctuation">.</span>value<span class="token punctuation">)</span></pre></td></tr></table></figure><p>于是我们得到了这四个文件</p>
<p><img data-src="/360-jiagu/image-20240220220013192.png" alt="image-20240220220013192" style="aspect-ratio:725 / 114;"></p>
<p><img data-src="/360-jiagu/image-20240220220022117.png" alt="image-20240220220022117" style="aspect-ratio:930 / 150;"></p>
<h1 id="主elf导入导出表修复"><a class="anchor" href="#主elf导入导出表修复">#</a> 主 ELF 导入导出表修复</h1>
<p>需要被修复的主 ELF 是我们在从 <code>assets/libjiagu_a64.so</code>  利用 <code>RC4</code>  和 <code>decompress</code>  解密出来的文件的后半部分那个 ELF</p>
<p>可以写个 python 脚本分离出后面的 ELF</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'wrap_elf'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    wrap_elf <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>ELF_magic <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0x45</span><span class="token punctuation">,</span> <span class="token number">0x4C</span><span class="token punctuation">,</span> <span class="token number">0x46</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>wrap_elf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ELF_magic<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> wrap_elf<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ELF_magic<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> ELF_magic<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'libjiagu_0xe7000.so'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>wrap_elf<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">break</span></pre></td></tr></table></figure><p>现在我们拿到了主 ELF 的四个重要的数据段，分别是 <code>phdr</code> , <code>.rela.plt</code> , <code>.rela.dyn</code> , <code>.dynamic</code> , 那么接下来需要做的工作就是修复主 ELF 的导入导出表了，不然导入导出函数都看不见怎么逆嘞～</p>
<p>在使用自实现 linker 加固 so 时， <code>phdr</code> , <code>.rela.plt</code> , <code>.rela.dyn</code> , <code>.dynamic</code>  这四个段是从待加固的 so 中提取出来，然后加密存储到其他位置，<strong> 原来的位置会使用无关字节直接覆盖</strong></p>
<p>等到需要为加固的 so 进行预链接和重定位的工作时，才将这些段解密并通过自己实现的预链接和重定位代码，让待加固的 so 可以正确的被壳 so 加载出来</p>
<p>我们进行修复的方法其实就藏在这句话中 <code>原来的位置会使用无关字节直接覆盖</code> ，我们可以将分离出来的这四个段再塞回到原来的位置</p>
<p><code>自实现linker加固so</code>  的加固方案既然都把那四个段加密存到其他地方了，那怎么不直接把原来的四个段直接删除而是用无关字节覆盖呢？</p>
<p>因为直接把段删除掉的话，会影响了一整个 ELF 文件的布局，偏移就会变得和原先不一样，然后产生各种奇奇怪怪的问题</p>
<blockquote>
<p>在 010editor 中，按下 <code>ctrl+shift+C</code>  可以复制整块内存，按下 <code>ctrl+shift+V</code>  可以粘贴整块内存</p>
</blockquote>
<ol>
<li>
<p>修复 <code>program header table</code></p>
<p>复制 <code>libjiagu.so_0x150_phdr</code>  的所有字节，然后来到 <code>libjiagu_0xe7000.so</code>  中选中 <code>struct program_header_table</code>  粘贴</p>
<p><img data-src="/360-jiagu/image-20240220223148864.png" alt="image-20240220223148864" style="aspect-ratio:835 / 788;"></p>
<p>随后按下 <code>F5</code>  刷新模板</p>
</li>
<li>
<p>修复 <code>.dynamic</code></p>
<p><code>program header table</code>  的 <code>(RW_) Dynamic Segment</code>  的 <code>p_offset</code>  指向 <code>.dynamic</code>  段的位置<br>
<img data-src="/360-jiagu/image-20240220223253986.png" alt="image-20240220223253986" style="aspect-ratio:918 / 471;"><br>
 跳转到该位置，复制 <code>libjiagu.so_0x1b0_.dynamic</code>  的内容并粘贴到这个位置</p>
</li>
<li>
<p>修复重定位表<br>
我们需要通过 <code>.dynamic</code>  段的 <code>d_tag</code>  字段来直到重定位表的位置，下面是 AOSP 中 <code>d_tag</code>  的宏定义<br>
<img data-src="/360-jiagu/image-20240220172348458.png" alt="image-20240220172348458" style="aspect-ratio:480 / 708;"></p>
</li>
</ol>
<p>所有的 <code>d_tag</code>  标志对应的含义可以在<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vY2QvRTI0ODQ3XzAxL2h0bWwvRTIyMTk2L3RvYy5odG1s"> ORACLE 链接程序和库指南 </span>中找到</p>
<p>对于我们修复主 ELF 比较重要的 <code>tag</code>  有</p>
<table>
<thead>
<tr>
<th>d_tag</th>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>DT_JMPREL</td>
<td>0x17</td>
<td><code>.rela.plt</code>  在文件中的偏移</td>
</tr>
<tr>
<td>DT_PLTRELSZ</td>
<td>0x2</td>
<td><code>.rela.plt</code>  的大小</td>
</tr>
<tr>
<td>DT_RELA</td>
<td>0x7</td>
<td><code>.rela.dyn</code>  在文件中的偏移</td>
</tr>
<tr>
<td>DT_RELASZ</td>
<td>0x8</td>
<td><code>.rela.dyn</code>  的大小</td>
</tr>
</tbody>
</table>
<p>我们可以在 <code>.dynamic</code>  中发现这些 <code>tag</code>  以及对应的值</p>
<p><img data-src="/360-jiagu/image-20240221131839098.png" alt="image-20240221131839098" style="aspect-ratio:1139 / 558;"></p>
<p>看看这两个大小分别是 <code>0x1650</code>  和 <code>0x25188</code> , 这不就和我们刚刚分离出来的文件大小一模一样嘛，说明我们离修复完成不远了</p>
<p><img data-src="/360-jiagu/image-20240220224638674.png" alt="image-20240220224638674" style="aspect-ratio:1175 / 182;"></p>
<p>然后就是和之前一样，跳转到 <code>.rela.plt</code>  和 <code>.rela.dyn</code>  的对应地址，然后把这些段本来的数据粘贴进去</p>
<p>现在我们就修复好啦，拿 ida 打开主 ELF 看看，满满的都是符号！</p>
<p><img data-src="/360-jiagu/image-20240221131944227.png" alt="image-20240221131944227" style="aspect-ratio:1920 / 1080;"></p>
<p>随便找个导入函数交叉引用看看，一切正常 <code>(●'◡'●)</code></p>
<p><img data-src="/360-jiagu/image-20240221132044506.png" alt="image-20240221132044506" style="aspect-ratio:1920 / 1080;"></p>
<p>为了方便起见，我们可以将主 ELF 的基址定义成在其在壳 ELF 的偏移 <code>0xe7000</code>  方便后续的分析</p>
<h1 id="主dex解密流程初步分析"><a class="anchor" href="#主dex解密流程初步分析">#</a> 主 DEX 解密流程初步分析</h1>
<p>还记得在<strong>加固壳反调试初步分析</strong>中，我们拿到了未解密的 dex 嘛</p>
<p><img data-src="/360-jiagu/image-20240220231727044.png" alt="image-20240220231727044" style="aspect-ratio:789 / 448;"></p>
<p>那么接下来有个问题就是，这个未解密的 dex 究竟藏在了 apk 的什么地方呢？</p>
<p>我将未加固的 apk 解压出来，然后用 7zip 压缩其中的 dex, 发现大小依然有 2.8MB</p>
<p><img data-src="/360-jiagu/image-20240220231901275.png" alt="image-20240220231901275" style="aspect-ratio:602 / 59;"></p>
<p>随后我将经过 360 加固之后的 apk 解压出来，按大小对文件进行排序之后发现，最大的文件就只有这个壳 <code>classes.dex</code> , 而别的文件甚至连 1MB 都没到，总不可能压缩率可以高到这种地步吧</p>
<p><img data-src="/360-jiagu/image-20240220232029056.png" alt="image-20240220232029056" style="aspect-ratio:465 / 256;"></p>
<p>所以我们打开 <code>classes.dex</code>  看看，在这个 <code>classes.dex</code>  的末尾，果然藏着一大堆的数据</p>
<p><img data-src="/360-jiagu/image-20240220232313676.png" alt="image-20240220232313676" style="aspect-ratio:790 / 514;"></p>
<p>而末尾的数据是由 <code>71 68 00 01</code>  和我们之前看到的加密的 dex 一模一样</p>
<p>接下来我们继续用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lhL3N0YWxrZXJfdHJhY2Vfc28="> stalker_trace_so</span> 去看看补充上主 ELF 的函数地址以及名称之后的函数调用链是什么样子的，首先在主 ELF 中运行插件 <code>Edit-&gt;Plugins-&gt;stalker_trace_so</code></p>
<p>之后同样的，我们需要将 <code>so_name</code>  改成 <code>libjiagu_64.so</code> , 特别注意的是，这里我们需要把壳 ELF 的 <code>func_addr</code>  和 <code>func_name</code>  给复制过来，同时使用 <code>concat</code>  方法将主 ELF 和壳 ELF 的函数地址和函数名拼接成一个新的数组</p>
<p><img data-src="/360-jiagu/image-20240221141755126.png" alt="image-20240221141755126" style="aspect-ratio:1201 / 264;"></p>
<p>之前替换 <code>/proc/self/maps</code>  来实现初步反调试的 js 函数 <code>hook_proc_self_maps</code>  也需要同时执行</p>
<p>输出结果如下， <code>KEkeELF</code>  标志表示壳 ELF, <code>mainELF</code>  表示主 ELF,(为什么是 <code>KEke</code> , 只是为了对齐看着舒服：))</p>
<p>要判断调用的函数在哪个 ELF 里面，在 <code>trace_so()</code>  里面稍作修改判断一下范围可以了</p>
<p><img data-src="/360-jiagu/image-20240221142103021.png" alt="image-20240221142103021" style="aspect-ratio:1414 / 490;"></p>
<p>打印出来的结果如下</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call1<span class="token operator">:</span><span class="token function">JNI_OnLoad</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call2<span class="token operator">:</span><span class="token class-name">j_interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call3<span class="token operator">:</span><span class="token class-name">interpreter_wrap_int64_t</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call4<span class="token operator">:</span><span class="token function">getenv</span>                    </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call5<span class="token operator">:</span><span class="token function">sub_13908</span>                 </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call6<span class="token operator">:</span><span class="token function">inotify_add_watch</span>         </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call7<span class="token operator">:</span><span class="token function">sub_11220</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call8<span class="token operator">:</span><span class="token function">fopen</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call9<span class="token operator">:</span><span class="token function">sub_9DD8</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call10<span class="token operator">:</span><span class="token function">sub_E3E0</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call11<span class="token operator">:</span><span class="token function">strtol</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call12<span class="token operator">:</span><span class="token function">feof</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call13<span class="token operator">:</span><span class="token function">raise</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call14<span class="token operator">:</span><span class="token function">memset</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call15<span class="token operator">:</span><span class="token function">sub_C918</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call16<span class="token operator">:</span><span class="token function">sub_9988</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call17<span class="token operator">:</span><span class="token function">sub_9964</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call18<span class="token operator">:</span><span class="token function">sub_9AC4</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call19<span class="token operator">:</span><span class="token function">j_ffi_prep_cif</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call20<span class="token operator">:</span><span class="token function">ffi_prep_cif</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call21<span class="token operator">:</span><span class="token function">j_ffi_prep_cif_machdep</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call22<span class="token operator">:</span><span class="token function">ffi_prep_cif_machdep</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call23<span class="token operator">:</span><span class="token function">j_ffi_call</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call24<span class="token operator">:</span><span class="token function">ffi_call</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call25<span class="token operator">:</span><span class="token function">sub_1674C</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call26<span class="token operator">:</span><span class="token function">j_ffi_call_SYSV</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call27<span class="token operator">:</span><span class="token function">ffi_call_SYSV</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call28<span class="token operator">:</span><span class="token function">sub_167BC</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call29<span class="token operator">:</span><span class="token function">sub_1647C</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call30<span class="token operator">:</span><span class="token function">sub_163DC</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call31<span class="token operator">:</span><span class="token function">sub_9900</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call32<span class="token operator">:</span><span class="token function">sub_94BC</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call33<span class="token operator">:</span><span class="token function">inotify_init</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call34<span class="token operator">:</span><span class="token function">fmod</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call35<span class="token operator">:</span><span class="token function">strncpy</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call36<span class="token operator">:</span><span class="token function">_Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRi</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call37<span class="token operator">:</span><span class="token function">sub_9E58</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call38<span class="token operator">:</span><span class="token function">sub_999C</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call39<span class="token operator">:</span><span class="token function">sub_10964</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call40<span class="token operator">:</span><span class="token function">j_lseek_1</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call41<span class="token operator">:</span><span class="token function">lseek</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call42<span class="token operator">:</span><span class="token function">sub_96E0</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call43<span class="token operator">:</span><span class="token function">sub_8000</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call44<span class="token operator">:</span><span class="token function">dlopen</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call45<span class="token operator">:</span><span class="token function">sub_60E0</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call46<span class="token operator">:</span><span class="token function">sub_6544</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call47<span class="token operator">:</span><span class="token function">sub_4B54</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call48<span class="token operator">:</span><span class="token function">sub_6128</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call49<span class="token operator">:</span><span class="token function">_ZN9__arm_c_19__arm_c_0Ev</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call50<span class="token operator">:</span><span class="token function">sub_A3EC</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call51<span class="token operator">:</span><span class="token function">sub_99CC</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call52<span class="token operator">:</span><span class="token function">sub_9944</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call53<span class="token operator">:</span><span class="token function">sub_6484</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call54<span class="token operator">:</span><span class="token function">sub_6590</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call55<span class="token operator">:</span><span class="token function">prctl</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call56<span class="token operator">:</span><span class="token function">sub_6698</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call57<span class="token operator">:</span><span class="token function">sub_9FFC</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call58<span class="token operator">:</span><span class="token function">j_lseek_3</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call59<span class="token operator">:</span><span class="token function">j_lseek_2</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call60<span class="token operator">:</span><span class="token function">j_lseek_0</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call61<span class="token operator">:</span><span class="token function">sub_9A90</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call62<span class="token operator">:</span><span class="token function">sub_5F20</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call63<span class="token operator">:</span><span class="token function">sub_6044</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call64<span class="token operator">:</span><span class="token function">sub_3574</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call65<span class="token operator">:</span><span class="token function">uncompress</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call66<span class="token operator">:</span><span class="token function">sub_49F0</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call67<span class="token operator">:</span><span class="token function">sub_5400</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call68<span class="token operator">:</span><span class="token function">sub_5478</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call69<span class="token operator">:</span><span class="token function">sub_5B08</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call70<span class="token operator">:</span><span class="token function">sub_5650</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call71<span class="token operator">:</span><span class="token function">sub_580C</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call72<span class="token operator">:</span><span class="token function">open</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call73<span class="token operator">:</span><span class="token function">atoi</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call74<span class="token operator">:</span><span class="token function">sub_3C94</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call75<span class="token operator">:</span><span class="token function">strncmp</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call76<span class="token operator">:</span><span class="token function">sub_4918</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call77<span class="token operator">:</span><span class="token function">sub_4000</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call78<span class="token operator">:</span><span class="token function">sub_41B4</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call79<span class="token operator">:</span><span class="token function">sub_35AC</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call80<span class="token operator">:</span><span class="token function">sigaction</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call81<span class="token operator">:</span><span class="token function">sub_5E6C</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call82<span class="token operator">:</span><span class="token function">sub_5444</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call83<span class="token operator">:</span><span class="token function">sub_11603C</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call84<span class="token operator">:</span><span class="token function">j__Znwm</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call85<span class="token operator">:</span><span class="token function">_Znwm</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call86<span class="token operator">:</span><span class="token function">malloc</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call87<span class="token operator">:</span><span class="token function">__cxa_atexit</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call88<span class="token operator">:</span><span class="token function">sub_1160B4</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call89<span class="token operator">:</span><span class="token function">sub_1160C4</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call90<span class="token operator">:</span><span class="token function">strlen</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call91<span class="token operator">:</span><span class="token function">memcpy</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call92<span class="token operator">:</span><span class="token function">sub_1161FC</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call93<span class="token operator">:</span><span class="token function">sub_1164AC</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call94<span class="token operator">:</span><span class="token function">sub_1164D8</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call95<span class="token operator">:</span><span class="token function">sub_116528</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call96<span class="token operator">:</span><span class="token function">sub_1165C8</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call97<span class="token operator">:</span><span class="token function">sub_1A32C0</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call98<span class="token operator">:</span><span class="token function">sub_1A3150</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call99<span class="token operator">:</span><span class="token function">sub_1A3204</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call100<span class="token operator">:</span><span class="token function">sub_1166FC</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call101<span class="token operator">:</span><span class="token function">sub_116728</span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call102<span class="token operator">:</span><span class="token function">sub_116750</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call103<span class="token operator">:</span><span class="token function">sub_116830</span></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call104<span class="token operator">:</span><span class="token function">sub_116BA0</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call105<span class="token operator">:</span><span class="token function">sub_633C</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call106<span class="token operator">:</span><span class="token function">sub_8130</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call107<span class="token operator">:</span><span class="token function">sub_4C70</span></pre></td></tr><tr><td data-num="108"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call108<span class="token operator">:</span><span class="token function">sub_825C</span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call109<span class="token operator">:</span><span class="token function">sub_8B50</span></pre></td></tr><tr><td data-num="110"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call110<span class="token operator">:</span><span class="token function">sub_8ED4</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call111<span class="token operator">:</span><span class="token function">sub_8430</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call112<span class="token operator">:</span><span class="token function">JNI_OnLoad</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call113<span class="token operator">:</span><span class="token class-name">j_interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call114<span class="token operator">:</span><span class="token class-name">interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call115<span class="token operator">:</span><span class="token function">interpreter_wrap_int64_t_bridge</span></pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call116<span class="token operator">:</span><span class="token function">sub_9D60</span></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call117<span class="token operator">:</span><span class="token function">sub_1B3F0C</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call118<span class="token operator">:</span><span class="token function">gettimeofday</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call119<span class="token operator">:</span><span class="token function">sub_11BD9C</span></pre></td></tr><tr><td data-num="120"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call120<span class="token operator">:</span><span class="token function">sub_1182D8</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call121<span class="token operator">:</span><span class="token function">sub_123970</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call122<span class="token operator">:</span><span class="token function">sub_1B6448</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call123<span class="token operator">:</span><span class="token function">getenv</span></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call124<span class="token operator">:</span><span class="token function">sub_11F130</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call125<span class="token operator">:</span><span class="token function">sub_12047C</span></pre></td></tr><tr><td data-num="126"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call126<span class="token operator">:</span><span class="token function">j__ZdlPv</span></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call127<span class="token operator">:</span><span class="token function">_ZdlPv</span></pre></td></tr><tr><td data-num="128"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call128<span class="token operator">:</span><span class="token function">free</span></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call129<span class="token operator">:</span><span class="token function">sub_1427E8</span></pre></td></tr><tr><td data-num="130"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call130<span class="token operator">:</span><span class="token function">dlopen</span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call131<span class="token operator">:</span><span class="token function">sub_11BDA8</span></pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call132<span class="token operator">:</span><span class="token function">sub_11BE58</span></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call133<span class="token operator">:</span><span class="token function">sub_11F69C</span></pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call134<span class="token operator">:</span><span class="token function">sub_117BE0</span></pre></td></tr><tr><td data-num="135"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call135<span class="token operator">:</span><span class="token function">sub_117CA0</span></pre></td></tr><tr><td data-num="136"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call136<span class="token operator">:</span><span class="token function">fopen</span></pre></td></tr><tr><td data-num="137"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call137<span class="token operator">:</span><span class="token function">sub_117E90</span></pre></td></tr><tr><td data-num="138"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call138<span class="token operator">:</span><span class="token function">sub_14285C</span></pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call139<span class="token operator">:</span><span class="token function">sub_1429CC</span></pre></td></tr><tr><td data-num="140"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call140<span class="token operator">:</span><span class="token function">sub_11C1AC</span></pre></td></tr><tr><td data-num="141"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call141<span class="token operator">:</span><span class="token function">sub_11C1B4</span></pre></td></tr><tr><td data-num="142"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call142<span class="token operator">:</span><span class="token function">sub_11C210</span></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call143<span class="token operator">:</span><span class="token function">sub_166C4</span></pre></td></tr><tr><td data-num="144"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call144<span class="token operator">:</span><span class="token function">memcpy</span></pre></td></tr><tr><td data-num="145"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call145<span class="token operator">:</span><span class="token function">sub_123324</span></pre></td></tr><tr><td data-num="146"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call146<span class="token operator">:</span><span class="token function">sub_1205A0</span></pre></td></tr><tr><td data-num="147"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call147<span class="token operator">:</span><span class="token function">sub_11F768</span></pre></td></tr><tr><td data-num="148"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call148<span class="token operator">:</span><span class="token function">memcmp</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call149<span class="token operator">:</span><span class="token function">opendir</span></pre></td></tr><tr><td data-num="150"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call150<span class="token operator">:</span><span class="token function">closedir</span></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call151<span class="token operator">:</span><span class="token function">sub_11859C</span></pre></td></tr><tr><td data-num="152"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call152<span class="token operator">:</span><span class="token function">sub_11C268</span></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call153<span class="token operator">:</span><span class="token function">sub_11C300</span></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call154<span class="token operator">:</span><span class="token function">sub_117B68</span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call155<span class="token operator">:</span><span class="token function">sub_1186B8</span></pre></td></tr><tr><td data-num="156"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call156<span class="token operator">:</span><span class="token function">sub_143964</span></pre></td></tr><tr><td data-num="157"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call157<span class="token operator">:</span><span class="token function">sub_1B66A8</span></pre></td></tr><tr><td data-num="158"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call158<span class="token operator">:</span><span class="token function">pthread_mutex_lock</span></pre></td></tr><tr><td data-num="159"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call159<span class="token operator">:</span><span class="token function">sub_142EA0</span></pre></td></tr><tr><td data-num="160"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call160<span class="token operator">:</span><span class="token function">sub_143A38</span></pre></td></tr><tr><td data-num="161"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call161<span class="token operator">:</span><span class="token function">sub_11CF8C</span></pre></td></tr><tr><td data-num="162"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call162<span class="token operator">:</span><span class="token function">sub_131D58</span></pre></td></tr><tr><td data-num="163"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call163<span class="token operator">:</span><span class="token function">sub_1B66D0</span></pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call164<span class="token operator">:</span><span class="token function">pthread_mutex_unlock</span></pre></td></tr><tr><td data-num="165"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call165<span class="token operator">:</span><span class="token function">sub_1178E8</span></pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call166<span class="token operator">:</span><span class="token function">sub_13D70C</span></pre></td></tr><tr><td data-num="167"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call167<span class="token operator">:</span><span class="token function">sub_19F984</span></pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call168<span class="token operator">:</span><span class="token function">sub_11F1C8</span></pre></td></tr><tr><td data-num="169"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call169<span class="token operator">:</span><span class="token function">atoi</span></pre></td></tr><tr><td data-num="170"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call170<span class="token operator">:</span><span class="token function">sub_12D2F8</span></pre></td></tr><tr><td data-num="171"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call171<span class="token operator">:</span><span class="token function">sub_17ABE8</span></pre></td></tr><tr><td data-num="172"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call172<span class="token operator">:</span><span class="token function">sub_172660</span></pre></td></tr><tr><td data-num="173"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call173<span class="token operator">:</span><span class="token function">sub_13BFF0</span></pre></td></tr><tr><td data-num="174"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call174<span class="token operator">:</span><span class="token function">sub_172AA4</span></pre></td></tr><tr><td data-num="175"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call175<span class="token operator">:</span><span class="token function">sub_13BD80</span></pre></td></tr><tr><td data-num="176"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call176<span class="token operator">:</span><span class="token function">sub_13BE2C</span></pre></td></tr><tr><td data-num="177"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call177<span class="token operator">:</span><span class="token function">sub_13BE4C</span></pre></td></tr><tr><td data-num="178"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call178<span class="token operator">:</span><span class="token function">memmove</span></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call179<span class="token operator">:</span><span class="token function">sub_13BE64</span></pre></td></tr><tr><td data-num="180"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call180<span class="token operator">:</span><span class="token function">sub_172D78</span></pre></td></tr><tr><td data-num="181"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call181<span class="token operator">:</span><span class="token function">sub_13E510</span></pre></td></tr><tr><td data-num="182"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call182<span class="token operator">:</span><span class="token function">sub_1926F0</span></pre></td></tr><tr><td data-num="183"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call183<span class="token operator">:</span><span class="token function">sub_13DB7C</span></pre></td></tr><tr><td data-num="184"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call184<span class="token operator">:</span><span class="token function">sub_1B7A08</span></pre></td></tr><tr><td data-num="185"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call185<span class="token operator">:</span><span class="token function">sub_1B7ABC</span></pre></td></tr><tr><td data-num="186"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call186<span class="token operator">:</span><span class="token function">pthread_cond_broadcast</span></pre></td></tr><tr><td data-num="187"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call187<span class="token operator">:</span><span class="token function">sub_12FA34</span></pre></td></tr><tr><td data-num="188"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call188<span class="token operator">:</span><span class="token function">sub_120664</span></pre></td></tr><tr><td data-num="189"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call189<span class="token operator">:</span><span class="token function">sub_1332B8</span></pre></td></tr><tr><td data-num="190"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call190<span class="token operator">:</span><span class="token function">sub_13E0F8</span></pre></td></tr><tr><td data-num="191"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call191<span class="token operator">:</span><span class="token function">sub_12743C</span></pre></td></tr><tr><td data-num="192"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call192<span class="token operator">:</span><span class="token function">sub_124C68</span></pre></td></tr><tr><td data-num="193"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call193<span class="token operator">:</span><span class="token function">sub_125DC4</span></pre></td></tr><tr><td data-num="194"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call194<span class="token operator">:</span><span class="token function">sub_124510</span></pre></td></tr><tr><td data-num="195"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call195<span class="token operator">:</span><span class="token function">sub_126888</span></pre></td></tr><tr><td data-num="196"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call196<span class="token operator">:</span><span class="token function">strdup</span></pre></td></tr><tr><td data-num="197"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call197<span class="token operator">:</span><span class="token function">sub_126920</span></pre></td></tr><tr><td data-num="198"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call198<span class="token operator">:</span><span class="token function">sub_122180</span></pre></td></tr><tr><td data-num="199"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call199<span class="token operator">:</span><span class="token function">sub_11BC1C</span></pre></td></tr><tr><td data-num="200"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call200<span class="token operator">:</span><span class="token function">sub_13DF34</span></pre></td></tr><tr><td data-num="201"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call201<span class="token operator">:</span><span class="token function">getpid</span></pre></td></tr><tr><td data-num="202"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call202<span class="token operator">:</span><span class="token function">memset</span></pre></td></tr><tr><td data-num="203"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call203<span class="token operator">:</span><span class="token function">snprintf</span></pre></td></tr><tr><td data-num="204"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call204<span class="token operator">:</span><span class="token function">sub_124FA0</span></pre></td></tr><tr><td data-num="205"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call205<span class="token operator">:</span><span class="token function">sub_1B6498</span></pre></td></tr><tr><td data-num="206"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call206<span class="token operator">:</span><span class="token function">sub_1A0C88</span></pre></td></tr><tr><td data-num="207"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call207<span class="token operator">:</span><span class="token function">sub_217444</span></pre></td></tr><tr><td data-num="208"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call208<span class="token operator">:</span><span class="token function">sub_2175E0</span></pre></td></tr><tr><td data-num="209"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call209<span class="token operator">:</span><span class="token function">read</span></pre></td></tr><tr><td data-num="210"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call210<span class="token operator">:</span><span class="token function">strncmp</span></pre></td></tr><tr><td data-num="211"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call211<span class="token operator">:</span><span class="token function">close</span></pre></td></tr><tr><td data-num="212"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call212<span class="token operator">:</span><span class="token function">sub_1B578C</span></pre></td></tr><tr><td data-num="213"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call213<span class="token operator">:</span><span class="token function">j___self_lseek</span></pre></td></tr><tr><td data-num="214"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call214<span class="token operator">:</span><span class="token function">__self_lseek</span></pre></td></tr><tr><td data-num="215"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call215<span class="token operator">:</span><span class="token function">sub_1B586C</span></pre></td></tr><tr><td data-num="216"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call216<span class="token operator">:</span><span class="token function">j_j___read_self</span></pre></td></tr><tr><td data-num="217"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call217<span class="token operator">:</span><span class="token function">j___read_self</span></pre></td></tr><tr><td data-num="218"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call218<span class="token operator">:</span><span class="token function">__read_self</span></pre></td></tr><tr><td data-num="219"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call219<span class="token operator">:</span><span class="token function">sub_1B6528</span></pre></td></tr><tr><td data-num="220"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call220<span class="token operator">:</span><span class="token function">sub_1B6578</span></pre></td></tr><tr><td data-num="221"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call221<span class="token operator">:</span><span class="token function">mmap</span></pre></td></tr><tr><td data-num="222"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call222<span class="token operator">:</span><span class="token function">sub_1B5B50</span></pre></td></tr><tr><td data-num="223"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call223<span class="token operator">:</span><span class="token function">calloc</span></pre></td></tr><tr><td data-num="224"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call224<span class="token operator">:</span><span class="token function">memchr</span></pre></td></tr><tr><td data-num="225"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call225<span class="token operator">:</span><span class="token function">sub_1B5D04</span></pre></td></tr><tr><td data-num="226"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call226<span class="token operator">:</span><span class="token function">sub_1B5EC4</span></pre></td></tr><tr><td data-num="227"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call227<span class="token operator">:</span><span class="token function">sub_1B6270</span></pre></td></tr><tr><td data-num="228"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call228<span class="token operator">:</span><span class="token function">sub_1B6180</span></pre></td></tr><tr><td data-num="229"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call229<span class="token operator">:</span><span class="token function">sub_1B6678</span></pre></td></tr><tr><td data-num="230"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call230<span class="token operator">:</span><span class="token function">inflateInit2_</span></pre></td></tr><tr><td data-num="231"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call231<span class="token operator">:</span><span class="token function">inflate</span></pre></td></tr><tr><td data-num="232"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call232<span class="token operator">:</span><span class="token function">inflateEnd</span></pre></td></tr><tr><td data-num="233"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call233<span class="token operator">:</span><span class="token function">sub_1B6540</span></pre></td></tr><tr><td data-num="234"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call234<span class="token operator">:</span><span class="token function">munmap</span></pre></td></tr><tr><td data-num="235"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call235<span class="token operator">:</span><span class="token function">sub_1B56F8</span></pre></td></tr><tr><td data-num="236"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call236<span class="token operator">:</span><span class="token function">sub_19BC9C</span></pre></td></tr><tr><td data-num="237"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call237<span class="token operator">:</span><span class="token function">sub_19CCD4</span></pre></td></tr><tr><td data-num="238"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call238<span class="token operator">:</span><span class="token function">sub_12D470</span></pre></td></tr><tr><td data-num="239"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call239<span class="token operator">:</span><span class="token function">sub_142FE0</span></pre></td></tr><tr><td data-num="240"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call240<span class="token operator">:</span><span class="token function">sub_143008</span></pre></td></tr><tr><td data-num="241"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call241<span class="token operator">:</span><span class="token function">sub_142ABC</span></pre></td></tr><tr><td data-num="242"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call242<span class="token operator">:</span><span class="token function">sub_143848</span></pre></td></tr><tr><td data-num="243"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call243<span class="token operator">:</span><span class="token function">sub_143B48</span></pre></td></tr><tr><td data-num="244"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call244<span class="token operator">:</span><span class="token function">sub_143088</span></pre></td></tr><tr><td data-num="245"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call245<span class="token operator">:</span><span class="token function">sub_1222D0</span></pre></td></tr><tr><td data-num="246"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call246<span class="token operator">:</span><span class="token function">sub_14316C</span></pre></td></tr><tr><td data-num="247"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call247<span class="token operator">:</span><span class="token function">sub_142954</span></pre></td></tr><tr><td data-num="248"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call248<span class="token operator">:</span><span class="token function">_Z9__arm_a_2PcmS_Rii</span></pre></td></tr><tr><td data-num="249"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call249<span class="token operator">:</span><span class="token function">sub_142894</span></pre></td></tr><tr><td data-num="250"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call250<span class="token operator">:</span><span class="token function">sub_1428BC</span></pre></td></tr><tr><td data-num="251"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call251<span class="token operator">:</span><span class="token function">sub_127DCC</span></pre></td></tr><tr><td data-num="252"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call252<span class="token operator">:</span><span class="token function">sub_14292C</span></pre></td></tr><tr><td data-num="253"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call253<span class="token operator">:</span><span class="token function">sub_121B78</span></pre></td></tr><tr><td data-num="254"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call254<span class="token operator">:</span><span class="token function">sub_121BE0</span></pre></td></tr><tr><td data-num="255"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call255<span class="token operator">:</span><span class="token function">sub_123CE8</span></pre></td></tr><tr><td data-num="256"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call256<span class="token operator">:</span><span class="token function">sub_123BC0</span></pre></td></tr><tr><td data-num="257"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call257<span class="token operator">:</span><span class="token function">sub_11959C</span></pre></td></tr><tr><td data-num="258"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call258<span class="token operator">:</span><span class="token function">sub_1AC170</span></pre></td></tr><tr><td data-num="259"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call259<span class="token operator">:</span><span class="token function">pthread_create</span></pre></td></tr><tr><td data-num="260"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call260<span class="token operator">:</span><span class="token function">sub_1AC210</span></pre></td></tr><tr><td data-num="261"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call261<span class="token operator">:</span><span class="token function">sub_1B5DE4</span></pre></td></tr><tr><td data-num="262"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call262<span class="token operator">:</span><span class="token function">sub_1B60E8</span></pre></td></tr><tr><td data-num="263"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call263<span class="token operator">:</span><span class="token function">sub_19F7C4</span></pre></td></tr><tr><td data-num="264"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call264<span class="token operator">:</span><span class="token function">sub_1B2DC8</span></pre></td></tr><tr><td data-num="265"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call265<span class="token operator">:</span><span class="token function">sub_1B1CE8</span></pre></td></tr><tr><td data-num="266"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call266<span class="token operator">:</span><span class="token function">sub_1B0974</span></pre></td></tr><tr><td data-num="267"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call267<span class="token operator">:</span><span class="token function">sub_1AFE6C</span></pre></td></tr><tr><td data-num="268"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call268<span class="token operator">:</span><span class="token function">sub_126ED8</span></pre></td></tr><tr><td data-num="269"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call269<span class="token operator">:</span><span class="token function">sub_1AFE8C</span></pre></td></tr><tr><td data-num="270"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call270<span class="token operator">:</span><span class="token function">sub_1AFE90</span></pre></td></tr><tr><td data-num="271"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call271<span class="token operator">:</span><span class="token function">sub_1AB87C</span></pre></td></tr><tr><td data-num="272"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call272<span class="token operator">:</span><span class="token function">sub_1B26D4</span></pre></td></tr><tr><td data-num="273"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call273<span class="token operator">:</span><span class="token function">sub_1B26F4</span></pre></td></tr><tr><td data-num="274"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call274<span class="token operator">:</span><span class="token function">sub_1B27C8</span></pre></td></tr><tr><td data-num="275"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call275<span class="token operator">:</span><span class="token function">j_ffi_prep_cif_var</span></pre></td></tr><tr><td data-num="276"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call276<span class="token operator">:</span><span class="token function">ffi_prep_cif_var</span></pre></td></tr><tr><td data-num="277"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call277<span class="token operator">:</span><span class="token function">sub_1AAF48</span></pre></td></tr><tr><td data-num="278"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call278<span class="token operator">:</span><span class="token function">sub_1AAF54</span></pre></td></tr><tr><td data-num="279"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call279<span class="token operator">:</span><span class="token function">sub_2162D4</span></pre></td></tr><tr><td data-num="280"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call280<span class="token operator">:</span><span class="token function">sub_1B2898</span></pre></td></tr><tr><td data-num="281"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call281<span class="token operator">:</span><span class="token function">sub_1B2918</span></pre></td></tr><tr><td data-num="282"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call282<span class="token operator">:</span><span class="token function">sub_1ABE90</span></pre></td></tr><tr><td data-num="283"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call283<span class="token operator">:</span><span class="token function">sub_13E0EC</span></pre></td></tr><tr><td data-num="284"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call284<span class="token operator">:</span><span class="token function">sub_124900</span></pre></td></tr><tr><td data-num="285"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call285<span class="token operator">:</span><span class="token function">sub_1A0C34</span></pre></td></tr><tr><td data-num="286"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call286<span class="token operator">:</span><span class="token function">sub_217188</span></pre></td></tr><tr><td data-num="287"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call287<span class="token operator">:</span><span class="token function">j_strcmp</span></pre></td></tr><tr><td data-num="288"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call288<span class="token operator">:</span><span class="token function">strcmp</span></pre></td></tr><tr><td data-num="289"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call289<span class="token operator">:</span><span class="token function">sub_194514</span></pre></td></tr><tr><td data-num="290"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call290<span class="token operator">:</span><span class="token function">sub_1A2380</span></pre></td></tr><tr><td data-num="291"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call291<span class="token operator">:</span><span class="token function">sub_1A23CC</span></pre></td></tr><tr><td data-num="292"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call292<span class="token operator">:</span><span class="token function">sub_1A2718</span></pre></td></tr><tr><td data-num="293"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call293<span class="token operator">:</span><span class="token function">sub_1A2A94</span></pre></td></tr><tr><td data-num="294"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call294<span class="token operator">:</span><span class="token function">sub_1A25E0</span></pre></td></tr><tr><td data-num="295"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call295<span class="token operator">:</span>sub_1A2984</pre></td></tr></table></figure><p>分析输出的结果，我们发现了三个有趣的函数 <code>inflateInit2_</code> , <code>inflate</code> , <code>inflateEnd</code> , 这不是 zlib 用来解压缩的函数嘛～</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call230<span class="token operator">:</span><span class="token function">inflateInit2_</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call231<span class="token operator">:</span><span class="token function">inflate</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call232<span class="token operator">:</span>inflateEnd</pre></td></tr></table></figure><p>对 <code>inflateInit2_</code> 交叉引用，发现有两个函数调用了它</p>
<p><img data-src="/360-jiagu/image-20240221160528463.png" alt="image-20240221160528463" style="aspect-ratio:879 / 220;"></p>
<p>那么要怎么知道是哪一个函数先调用的 <code>inflateInit2_</code> 呢？向上看看函数调用链就行了</p>
<p>于是我们发现是 <code>sub_1B6270</code>  调用了 <code>inflateInit2_</code></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call227<span class="token operator">:</span>sub_1B6270 <span class="token operator">&lt;</span><span class="token operator">--</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call228<span class="token operator">:</span><span class="token function">sub_1B6180</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call229<span class="token operator">:</span><span class="token function">sub_1B6678</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call230<span class="token operator">:</span><span class="token function">inflateInit2_</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call231<span class="token operator">:</span><span class="token function">inflate</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call232<span class="token operator">:</span>inflateEnd</pre></td></tr></table></figure><p>我们来到 <code>sub_1B6270</code> , 先到<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21hZGxlci96bGli"> https://github.com/madler/zlib</span> 把 <code>zlib.h</code>  中的 <code>z_stream_s</code> , 导入的方法和之前一样</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">z_const</span> <span class="token expression"><span class="token keyword">const</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  Byte<span class="token punctuation">;</span>  <span class="token comment">/* 8 bits */</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   uInt<span class="token punctuation">;</span>  <span class="token comment">/* 16 bits or more */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span>  uLong<span class="token punctuation">;</span> <span class="token comment">/* 32 bits or more */</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">z_stream_s</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    z_const Bytef <span class="token operator">*</span>next_in<span class="token punctuation">;</span>     <span class="token comment">/* next input byte */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    uInt     avail_in<span class="token punctuation">;</span>  <span class="token comment">/* number of bytes available at next_in */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    uLong    total_in<span class="token punctuation">;</span>  <span class="token comment">/* total number of input bytes read so far */</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    Bytef    <span class="token operator">*</span>next_out<span class="token punctuation">;</span> <span class="token comment">/* next output byte will go here */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    uInt     avail_out<span class="token punctuation">;</span> <span class="token comment">/* remaining free space at next_out */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    uLong    total_out<span class="token punctuation">;</span> <span class="token comment">/* total number of bytes output so far */</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span> z_stream<span class="token punctuation">;</span></pre></td></tr></table></figure><p>重定义 <code>s</code>  的类型为 <code>z_stream</code> , 这四个字段的含义如下</p>
<ul>
<li><code>s.next_in</code> : 压缩数据</li>
<li><code>s.avail_in</code> : 压缩数据的长度</li>
<li><code>s.next_out</code> : 解压后的数据</li>
<li><code>s.avail_out</code> : 解压后数据的长度</li>
</ul>
<p><img data-src="/360-jiagu/image-20240221162607623.png" alt="image-20240221162607623" style="aspect-ratio:542 / 368;"></p>
<p>各个成员的偏移如图所示</p>
<p><img data-src="/360-jiagu/image-20240221162856663.png" alt="image-20240221162856663" style="aspect-ratio:328 / 195;"></p>
<p>随后我们用 frida 去 hook 一下 <code>inflate</code>  函数看看解压缩之后的数据是什么</p>
<p>这里有个技巧，就是如何可以 hook 到主 ELF 中的函数，因为在壳 ELF 加载进内存时，主 ELF 还没有被加载，所以假如在壳 ELF 通过 <code>android_dlopen_ext</code>  打开时我们进行 hook, 是会 hook 失败的</p>
<p>那么如何才能获取到主 ELF 的 hook 时机呢？我们可以通过统计外部函数的调用次数来判断是否已经加载了主 ELF, 例如我这里，我通过 <code>zlib_count</code>  统计外部函数 <code>inflate</code>  调用次数，因为在壳 ELF 会使用 <code>uncompress</code>  调用一次 <code>inflate</code> , 所以当第二次调用 <code>inflate</code> , 我们就知道这肯定是主 ELF 调用的，所以我们也可以在这个位置放心大胆的 hook 了</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">dump_memory</span><span class="token punctuation">(</span><span class="token parameter">start<span class="token punctuation">,</span>size<span class="token punctuation">,</span>filename</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> file_path <span class="token operator">=</span> <span class="token string">"/data/data/com.oacia.apk_protect/"</span> <span class="token operator">+</span> filename<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">var</span> file_handle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>file_handle <span class="token operator">&amp;&amp;</span> file_handle <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">var</span> libso_buffer <span class="token operator">=</span> start<span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span><span class="token function">toUInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        file_handle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>libso_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        file_handle<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        file_handle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[dump]:"</span><span class="token punctuation">,</span> file_path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_zlib_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x1B63F0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// fd, buff, len</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"inflate result"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>next_in<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>              <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="20"></td><td><pre>              <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">0x50</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="21"></td><td><pre>              <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>              <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>next_out<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>              <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="26"></td><td><pre>              <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">0x50</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="27"></td><td><pre>              <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>              <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token function">dump_memory</span><span class="token punctuation">(</span>next_out<span class="token punctuation">,</span>avail_out<span class="token punctuation">,</span><span class="token string">"dex001"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">var</span> zlib_count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">var</span> next_in<span class="token punctuation">,</span>avail_in<span class="token punctuation">,</span>next_out<span class="token punctuation">,</span>avail_out<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_zlib</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"inflate"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// fd, buff, len</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            zlib_count<span class="token operator">+=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>zlib_count<span class="token operator">></span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token function">hook_zlib_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            next_in<span class="token operator">=</span><span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            avail_in<span class="token operator">=</span><span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            next_out<span class="token operator">=</span><span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            avail_out<span class="token operator">=</span><span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>next_in<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>              <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="52"></td><td><pre>              <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">0x50</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="53"></td><td><pre>              <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>              <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>解压缩之后的输出如下，在输出的文件头，我们发现了 <code>dex035</code> , 所以我们把这块内存 dump 下来看看，使用上方的 <code>dump_memory(start,size,filename)</code>  函数即可</p>
<p><img data-src="/360-jiagu/image-20240221170453897.png" alt="image-20240221170453897" style="aspect-ratio:1182 / 361;"></p>
<p>把这个解压缩之后的 dex 拖入到 jadx 里面，却发现这个类名怎么和壳 DEX 的类名一模一样，通过校验哈希发现 dump 下来的 dex 和壳 dex 其实是同一个文件</p>
<p><img data-src="/360-jiagu/image-20240221170627481.png" alt="image-20240221170627481" style="aspect-ratio:386 / 224;"></p>
<p>我们在之前的分析中知道壳 dex 的末尾附带了一大串的加密数据，所以通过将这个解压缩得到了这个 dex, 就说明马上要进行加密主 DEX 的解密操作了</p>
<p>解压缩的函数是 <code>sub_1B6270</code> , 接下来我们继续通过 <code>stalker_trace_so</code>  打印出来的内容，并利用交叉引用来追踪该函数的调用链</p>
<p>就比如说对于函数 <code>sub_1B6270</code> , 它有两个交叉引用</p>
<p><img data-src="/360-jiagu/image-20240221172325310.png" alt="image-20240221172325310" style="aspect-ratio:879 / 220;"></p>
<p>通过 <code>stalker_trace_so</code>  打印出来的函数调用链，我们发现是 <code>sub_1A0C88</code>  在 <code>sub_1B6270</code>  之前调用，所以函数的调用关系就是 <code>sub_1A0C88-&gt;sub_1B6270</code> , 以此类推</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call206<span class="token operator">:</span><span class="token function">sub_1A0C88</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call227<span class="token operator">:</span>sub_1B6270</pre></td></tr></table></figure><p>所以一路跟过来之后，函数的调用链为 <code>sub_1332B8-&gt;sub_124FA0-&gt;sub_1A0C88-&gt;sub_1B6270-&gt;inflate</code> , <code>sub_1332B8</code>  函数之后就没有交叉引用了</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call189<span class="token operator">:</span><span class="token function">sub_1332B8</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call204<span class="token operator">:</span><span class="token function">sub_124FA0</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call206<span class="token operator">:</span><span class="token function">sub_1A0C88</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call227<span class="token operator">:</span><span class="token function">sub_1B6270</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call230<span class="token operator">:</span><span class="token function">inflateInit2_</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call231<span class="token operator">:</span><span class="token function">inflate</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call232<span class="token operator">:</span>inflateEnd</pre></td></tr></table></figure><p>在这个函数中，我们发现了 <code>apk@classes.dex</code> , 而它的作用，正是为了找到已加载到内存且优化后的壳 dex</p>
<p><img data-src="/360-jiagu/image-20240221172717168.png" alt="image-20240221172717168" style="aspect-ratio:1261 / 182;"></p>
<hr>
<p>在<strong>加固壳反调试初步分析</strong>的后半部分，我们打印出了加固壳打开 dex 的堆栈回溯，现在我们直接跳转到相对应的地方看看</p>
<p><img data-src="/360-jiagu/image-20240220225331054.png" alt="image-20240220225331054" style="aspect-ratio:878 / 513;"></p>
<p>我们到 <code>0x19b780</code>  看看，看起来是一个标准的打开并写入文件的函数</p>
<p><img data-src="/360-jiagu/image-20240221133619261.png" alt="image-20240221133619261" style="aspect-ratio:983 / 665;"></p>
<p>随后对该函数进行交叉引用，我们发现 <code>sub_1332B8</code>  竟然调用了它，就在刚刚我们就分析出这个函数中可是同时也执行了从内存中获取壳 dex 的操作的呢</p>
<p><img data-src="/360-jiagu/image-20240221173657553.png" alt="image-20240221173657553" style="aspect-ratio:879 / 258;"></p>
<p>我们对这两处调用都 hook 一下看看是什么情况，打印的结果如下，说明这两处调用都打开了 dex, <code>sub_1332B8</code>  中的前一个调用打开了 <code>classes.dex</code> , 后一个调用打开了 <code>classes2.dex</code>  和 <code>classes3.dex</code> , 而 <code>classes.dex</code>  文件中的内容就是加密的主 dex</p>
<p><img data-src="/360-jiagu/image-20240221174419522.png" alt="image-20240221174419522" style="aspect-ratio:892 / 298;"></p>
<p>在创建完 <code>classes2.dex</code>  和 <code>classes3.dex</code> , 通过 hook 发现调用在调用 <code>sub_128D44</code>  之后进程就退出了</p>
<p><img data-src="/360-jiagu/image-20240221180350649.png" alt="image-20240221180350649" style="aspect-ratio:1079 / 268;"></p>
<p>我们去 hook 一下 <code>sub_128D44</code>  这个函数，发现传入的参数 <code>v8</code>  正是加密的主 DEX</p>
<p><img data-src="/360-jiagu/image-20240221184130805.png" alt="image-20240221184130805" style="aspect-ratio:1196 / 273;"></p>
<p>而 <code>sub_128D44</code>  函数是这个样子的，并且在壳 ELF 加载时启动 <code>stalker_trace_so</code>  的 <code>trace_so()</code>  函数所打印出的结果中，并没有这个函数的调用被打印出来</p>
<p><img data-src="/360-jiagu/image-20240221180415665.png" alt="image-20240221180415665" style="aspect-ratio:925 / 106;"></p>
<p>这该怎么办呢？</p>
<p>很简单，在调用 <code>sub_128D44</code>  的位置再去调用一次 <code>trace_so()</code>  函数从现在的位置开始打印函数的调用链不就行咯：)</p>
<p><img data-src="/360-jiagu/image-20240221180705025.png" alt="image-20240221180705025" style="aspect-ratio:1218 / 366;"></p>
<p>函数调用关系如下，我们发现再 <code>mainELF</code>  调用完 <code>sub_128D44</code>  之后，通过一系列操作又回到了壳 ELF 中，最终调用 <code>raise</code>  导致进程退出</p>
<p><img data-src="/360-jiagu/image-20240221185357390.png" alt="image-20240221185357390" style="aspect-ratio:721 / 605;"></p>
<p>然而，当我跳转到最后调用的几个函数时，可以说函数复杂到让人咋舌</p>
<p><img data-src="/360-jiagu/image-20240222005607295.png" alt="image-20240222005607295" style="aspect-ratio:1351 / 497;"></p>
<p><img data-src="/360-jiagu/image-20240222005639325.png" alt="image-20240222005639325" style="aspect-ratio:1619 / 626;"></p>
<p>这么复杂，是给人分析的吗！？所以我便卡在这里了很久</p>
<p>我想了想现在摆在面前的有两条路，是和一眼望不到尽头的这俩函数死磕到底，还是选择把 360 加固的反调试搞定？</p>
<p>我选择后者，因为明显搞定反调试要比把这两个函数分析明白要稍微简单一点</p>
<h1 id="加固壳反调试深入分析"><a class="anchor" href="#加固壳反调试深入分析">#</a> 加固壳反调试深入分析</h1>
<p>在<strong>加固壳反调试初步分析</strong>中，我曾尝试过 <code>dbus</code> , <code>TracerPid</code> , <code>readlink</code> , <code>strstr</code>  都没有明显的效果，只有 hook  <code>open</code>  函数让我看到了些许的曙光，那么现在应该还有一种非常重要的反调试手段没有用到，那就是 <code>pthread_create</code>  反调试</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">check_pthread_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> pthread_create_addr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'pthread_create'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">var</span> pthread_create <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>pthread_create_addr<span class="token punctuation">,</span> <span class="token string">"int"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"pointer"</span><span class="token punctuation">,</span> <span class="token string">"pointer"</span><span class="token punctuation">,</span> <span class="token string">"pointer"</span><span class="token punctuation">,</span> <span class="token string">"pointer"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>pthread_create_addr<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">NativeCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">parg0<span class="token punctuation">,</span> parg1<span class="token punctuation">,</span> parg2<span class="token punctuation">,</span> parg3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">var</span> so_name <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByAddress</span><span class="token punctuation">(</span>parg2<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">var</span> so_path <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByAddress</span><span class="token punctuation">(</span>parg2<span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">var</span> so_base <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">getBaseAddress</span><span class="token punctuation">(</span>so_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">var</span> offset <span class="token operator">=</span> parg2 <span class="token operator">-</span> so_base<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">var</span> <span class="token constant">PC</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>so_name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"jiagu"</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"======"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"find thread func offset"</span><span class="token punctuation">,</span> so_name<span class="token punctuation">,</span> offset<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            Thread<span class="token punctuation">.</span><span class="token function">backtrace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span> Backtracer<span class="token punctuation">.</span><span class="token constant">ACCURATE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>addr_in_so<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">var</span> check_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment">//1769036,1771844</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>check_list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"check bypass"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token constant">PC</span> <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span>parg0<span class="token punctuation">,</span> parg1<span class="token punctuation">,</span> parg2<span class="token punctuation">,</span> parg3<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token constant">PC</span> <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span>parg0<span class="token punctuation">,</span> parg1<span class="token punctuation">,</span> parg2<span class="token punctuation">,</span> parg3<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">PC</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"int"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"pointer"</span><span class="token punctuation">,</span> <span class="token string">"pointer"</span><span class="token punctuation">,</span> <span class="token string">"pointer"</span><span class="token punctuation">,</span> <span class="token string">"pointer"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">function</span> <span class="token function">addr_in_so</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">var</span> process_Obj_Module_Arr <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">enumerateModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> process_Obj_Module_Arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>addr<span class="token operator">></span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base <span class="token operator">&amp;&amp;</span> addr<span class="token operator">&lt;</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"is in"</span><span class="token punctuation">,</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">"offset: 0x"</span><span class="token operator">+</span><span class="token punctuation">(</span>addr<span class="token operator">-</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>注入代码之后， <code>pthread_create</code>  的调用都指向了同一个地址 <code>0x17710</code></p>
<p><img data-src="/360-jiagu/image-20240222010902622.png" alt="image-20240222010902622" style="aspect-ratio:735 / 781;"></p>
<p>我们跳转到这个地址之后却发现为什么会没有 <code>pthread_create</code>  呢？？</p>
<p><img data-src="/360-jiagu/image-20240222011044885.png" alt="image-20240222011044885" style="aspect-ratio:1113 / 306;"></p>
<p>看了一眼这个代码所在的函数的名称 <code>ffi_call_SYSV</code></p>
<p><img data-src="/360-jiagu/image-20240222011143427.png" alt="image-20240222011143427" style="aspect-ratio:947 / 186;"></p>
<p>hmmm, 看来是用<span class="exturl" data-url="aHR0cHM6Ly9hbGV4Y29kZTIuZ2l0Ym9vay5pby9pb3MtZGV2ZWxvcG1lbnQtZ3VpZGVsaW5lcy9pb3MtemEtdGFuL2xpYmZmaS1kb25nLXRhaS10aWFvLXlvbmctaGUtZGluZy15aS1jLWhhbi1zaHU="> libffi 动态调用函数</span>呀</p>
<p><img data-src="/360-jiagu/image-20240222011351754.png" alt="image-20240222011351754" style="aspect-ratio:1012 / 715;"></p>
<p>直接到<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpYmZmaQ=="> libffi 的 github 仓库</span>看一眼<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpYmZmaS9saWJmZmkvYmxvYi9tYXN0ZXIvc3JjL2FhcmNoNjQvc3lzdi5T"> ffi_call_SYSV 的源码</span></p>
<p>一进去注释都写得清清楚楚了</p>
<p><img data-src="/360-jiagu/image-20240222012001816.png" alt="image-20240222012001816" style="aspect-ratio:803 / 502;"></p>
<p>利用注释就可以知道每行汇编都代表什么了，所以 <code>BLR X24</code>  表示去动态调用函数，而前面的 <code>X0</code> , <code>X2</code> , <code>X4</code> , <code>X6</code>  是用来传参的</p>
<p><img data-src="/360-jiagu/image-20240222012543471.png" alt="image-20240222012543471" style="aspect-ratio:1845 / 790;"></p>
<p>我们 hook 一下 <code>x0</code>  看看有没有什么敏感的字符串</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">anti_frida_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x1770C</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token keyword">try</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然而神奇的是，我仅仅去 hook 并打印 x0 字符串，其他什么事情都不干，apk 竟然神奇的进去了，只不过会没有响应，感觉距离成功不远了呢</p>
<p><img data-src="/360-jiagu/image-20240222013454838.png" alt="image-20240222013454838" style="aspect-ratio:489 / 922;"></p>
<p>有点意思，筛选一下看看有没有什么敏感的字符串好咯</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">anti_frida_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x1770C</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token keyword">try</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'frida'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'gum-js-loop'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'gmain'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'linjector'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'/proc/'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>竟然还真有，那就把这些字符串全部替换成无意义的字符串看看咯</p>
<p><img data-src="/360-jiagu/image-20240222013944879.png" alt="image-20240222013944879" style="aspect-ratio:1633 / 205;"></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">anti_frida_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x1770C</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token keyword">try</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'frida'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'gum-js-loop'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'gmain'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'linjector'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'/proc/'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                    Memory<span class="token punctuation">.</span><span class="token function">protect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">,</span> Process<span class="token punctuation">.</span>pointerSize<span class="token punctuation">,</span> <span class="token string">'rwx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                    <span class="token keyword">var</span> replace_str<span class="token operator">=</span><span class="token string">""</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>s<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                        replace_str<span class="token operator">+=</span><span class="token string">"0"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                    <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">.</span><span class="token function">writeUtf8String</span><span class="token punctuation">(</span>replace_str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然而这样做进程却一个劲的崩溃！！</p>
<p>没事，寄存器 <code>x0</code>  用不了，还有 <code>x2</code> , <code>x4</code> , <code>x6</code>  没替换过呢！我一个一个的试过去，终于，当我将寄存器改成 x6 时，进程终于不再崩溃成功的进入了 apk!</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">anti_frida_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x1770C</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token keyword">try</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x6<span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'frida'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'gum-js-loop'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'gmain'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'linjector'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'/proc/'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                    <span class="token comment">//console.log(s)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                    Memory<span class="token punctuation">.</span><span class="token function">protect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">,</span> Process<span class="token punctuation">.</span>pointerSize<span class="token punctuation">,</span> <span class="token string">'rwx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                    <span class="token keyword">var</span> replace_str<span class="token operator">=</span><span class="token string">""</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>s<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                        replace_str<span class="token operator">+=</span><span class="token string">"0"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                    <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">.</span><span class="token function">writeUtf8String</span><span class="token punctuation">(</span>replace_str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/360-jiagu/image-20240222015211639.png" alt="image-20240222015211639" style="aspect-ratio:492 / 984;"></p>
<p>看一眼检测的字符串，怎么全是 <code>/memfd:frida-agent-64.so</code></p>
<p><img data-src="/360-jiagu/image-20240222015139528.png" alt="image-20240222015139528" style="aspect-ratio:920 / 269;"></p>
<h1 id="主dex加载流程分析"><a class="anchor" href="#主dex加载流程分析">#</a> 主 DEX 加载流程分析</h1>
<p>回到这个卡了我们很久位置，现在过了反调试之后这里的代码终于可以继续执行下去了</p>
<p><img data-src="/360-jiagu/image-20240222015651090.png" alt="image-20240222015651090" style="aspect-ratio:1109 / 304;"></p>
<p>向下看找到这一个函数 <code>sub_18FEA8</code></p>
<p><img data-src="/360-jiagu/image-20240222030003433.png" alt="image-20240222030003433" style="aspect-ratio:1425 / 230;"></p>
<p>在这个函数中的字符串全部都是加密的，颇有种此地无银三百两的感觉，我们把字符串解密后发现了 <code>DexFileLoader</code>  相关的字符串，说明这个函数肯定和加载 dex 有某种关联</p>
<p><img data-src="/360-jiagu/image-20240222030104410.png" alt="image-20240222030104410" style="aspect-ratio:1527 / 470;"></p>
<p>我们 hook 一下这个函数，发现这个函数共调用了三次，而且传入的值都是已经解密了的 dex, <code>classes.dex</code> , <code>classes2.dex</code> , <code>classes3.dex</code>  分别通过这个函数加载</p>
<p><code>classes.dex</code></p>
<p><img data-src="/360-jiagu/image-20240222030239507.png" alt="image-20240222030239507" style="aspect-ratio:1192 / 363;"></p>
<p><code>classes2.dex</code></p>
<p><img data-src="/360-jiagu/image-20240222030345127.png" alt="image-20240222030345127" style="aspect-ratio:1181 / 364;"></p>
<p><code>classes3.dex</code></p>
<p><img data-src="/360-jiagu/image-20240222030355010.png" alt="image-20240222030355010" style="aspect-ratio:1193 / 358;"></p>
<p>把这三个 dex 给 dump 下来看看，于是我们得到了这三个文件</p>
<p><img data-src="/360-jiagu/image-20240222030924824.png" alt="image-20240222030924824" style="aspect-ratio:632 / 96;"></p>
<p>把最大的那个 dex 拖到 jadx 分析里面，发现这正是我们要找的主 DEX</p>
<p><img data-src="/360-jiagu/image-20240222172233276.png" alt="image-20240222172233276" style="aspect-ratio:1920 / 1078;"></p>
<p>其他函数都很正常，唯独 <code>onCreate</code>  函数变成了 <code>native</code>  声明，要是有同样分析到这里的朋友可以去研究研究 <code>onCreate</code>  函数对应的 <code>native</code>  本地函数究竟在什么地方，相信有了本文的铺垫，对于进行后续 <code>onCreate</code>  函数的分析应该是有所帮助的吧～</p>
<p>而除此之外的别的类和直接反编译未加固的 apk 的类是一样的</p>
<p><img data-src="/360-jiagu/image-20240222031222988.png" alt="image-20240222031222988" style="aspect-ratio:1920 / 1079;"></p>
<h1 id="主dex解密算法分析"><a class="anchor" href="#主dex解密算法分析">#</a> 主 DEX 解密算法分析</h1>
<p>我们在<strong>加固壳反调试深入分析</strong>成功的绕过了 360 加固的 frida 检测，现在我们再次回到 <code>sub_1332B8</code>  中的 <code>sub_128D44</code> , 来进行后续的解密算法的分析</p>
<p>下图是<strong>主 DEX 解密流程初步分析</strong>末尾部分的内容，我们将以这个函数 <code>sub_128D44</code>  为起点进行解密算法的分析，因为参数 <code>v8</code>  传入的值是加密之后的主 DEX</p>
<p><img data-src="/360-jiagu/image-20240307115103478.png" alt="image-20240307115103478" style="aspect-ratio:1080 / 642;"></p>
<p>我们在这个内存用 frida 打一个内存读写断点来看看是究竟是什么函数读取了主 DEX, 同时需要注意加上我们的反调试函数</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">var</span> so_name <span class="token operator">=</span> <span class="token string">"libjiagu_64.so"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_dex_dec_enter_in_main_elf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x1346B4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token comment">//memory breakpoint</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            MemoryAccessMonitor<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                    <span class="token literal-property property">base</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                    <span class="token literal-property property">size</span><span class="token operator">:</span><span class="token number">40</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                    <span class="token function-variable function">onAccess</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">details</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span>operation<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">get_addr_in_so</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span>from<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">var</span> zlib_count<span class="token operator">=</span><span class="token number">0</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_zlib</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"inflate"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// fd, buff, len</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            zlib_count<span class="token operator">+=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>zlib_count<span class="token operator">===</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token function">hook_dex_dec_enter_in_main_elf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">function</span> <span class="token function">anti_frida_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x1770C</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">try</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x6<span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'frida'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'gum-js-loop'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'gmain'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'linjector'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                    s<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'/proc/'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                    <span class="token comment">//console.log(s)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                    Memory<span class="token punctuation">.</span><span class="token function">protect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">,</span> Process<span class="token punctuation">.</span>pointerSize<span class="token punctuation">,</span> <span class="token string">'rwx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                    <span class="token keyword">var</span> replace_str<span class="token operator">=</span><span class="token string">""</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>s<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                        replace_str<span class="token operator">+=</span><span class="token string">"0"</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                    <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">.</span><span class="token function">writeUtf8String</span><span class="token punctuation">(</span>replace_str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token keyword">function</span> <span class="token function">get_addr_in_so</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">var</span> process_Obj_Module_Arr <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">enumerateModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> process_Obj_Module_Arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>addr<span class="token operator">></span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base <span class="token operator">&amp;&amp;</span> addr<span class="token operator">&lt;</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token keyword">return</span> addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" is in "</span><span class="token operator">+</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">" offset: 0x"</span><span class="token operator">+</span><span class="token punctuation">(</span>addr<span class="token operator">-</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">return</span> addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_dlopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token comment">//hook_call_constructors();</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"android_dlopen_ext"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                <span class="token keyword">var</span> pathptr <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pathptr <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> pathptr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                    <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>pathptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"dlopen "</span><span class="token operator">+</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>so_name<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                        <span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="90"></td><td><pre>            <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                    <span class="token comment">//you can do any thing before stalker trace so</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                    <span class="token comment">//trace_so();</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                    <span class="token function">hook_zlib</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                    <span class="token function">anti_frida_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                    <span class="token comment">//hook_C918();</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token function">setImmediate</span><span class="token punctuation">(</span>hook_dlopen<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>打印日志如下</p>
<p><img data-src="/360-jiagu/image-20240307120002564.png" alt="image-20240307120002564" style="aspect-ratio:718 / 67;"></p>
<p>说明是在 <code>0xd364</code>  处读取了这个主 DEX</p>
<p>跳转到 <code>0xd364</code>  之后发现这个地址在函数 <code>sub_C918</code>  中，看起来这个函数的形状像一个火车头一样 XD</p>
<p><img data-src="/360-jiagu/image-20240307120118309.png" alt="image-20240307120118309" style="aspect-ratio:1920 / 520;"></p>
<p>接下来我们继续使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lhL3N0YWxrZXJfdHJhY2Vfc28="> staker_trace_so</span> 生成的 <code>trace_so()</code>  函数去看看函数的调用链是什么样子的，trace 的起点就是在 <code>sub_1332B8</code>  中的 <code>sub_128D44</code> , 同时注意加上我们的反调试函数</p>
<p><img data-src="/360-jiagu/image-20240307120333178.png" alt="image-20240307120333178" style="aspect-ratio:1218 / 229;"></p>
<p>打印出来的函数调用链如下</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>start Stalker<span class="token operator">!</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Stalker end<span class="token operator">!</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call1<span class="token operator">:</span><span class="token function">sub_128D44</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call2<span class="token operator">:</span><span class="token class-name">j_interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call3<span class="token operator">:</span><span class="token class-name">interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call4<span class="token operator">:</span><span class="token function">interpreter_wrap_int64_t_bridge</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call5<span class="token operator">:</span><span class="token function">getenv</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call6<span class="token operator">:</span><span class="token function">sub_13908</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call7<span class="token operator">:</span><span class="token function">inotify_add_watch</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call8<span class="token operator">:</span><span class="token function">sub_11220</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call9<span class="token operator">:</span><span class="token function">fopen</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call10<span class="token operator">:</span><span class="token function">sub_9DD8</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call11<span class="token operator">:</span><span class="token function">sub_E3E0</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call12<span class="token operator">:</span><span class="token function">strtol</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call13<span class="token operator">:</span><span class="token function">feof</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call14<span class="token operator">:</span><span class="token function">raise</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call15<span class="token operator">:</span><span class="token function">memset</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call16<span class="token operator">:</span>sub_C918<span class="token comment">// 这个函数中读取加密之后的 dex</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call17<span class="token operator">:</span><span class="token function">sub_9964</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call18<span class="token operator">:</span><span class="token function">sub_9AC4</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call19<span class="token operator">:</span><span class="token function">sub_9988</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call20<span class="token operator">:</span><span class="token function">j_ffi_prep_cif</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call21<span class="token operator">:</span><span class="token function">ffi_prep_cif</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call22<span class="token operator">:</span><span class="token function">j_ffi_prep_cif_machdep</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call23<span class="token operator">:</span><span class="token function">ffi_prep_cif_machdep</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call24<span class="token operator">:</span><span class="token function">j_ffi_call</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call25<span class="token operator">:</span><span class="token function">ffi_call</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call26<span class="token operator">:</span><span class="token function">sub_1674C</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call27<span class="token operator">:</span><span class="token function">j_ffi_call_SYSV</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call28<span class="token operator">:</span><span class="token function">ffi_call_SYSV</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call29<span class="token operator">:</span><span class="token function">sub_167BC</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call30<span class="token operator">:</span><span class="token function">sub_1647C</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call31<span class="token operator">:</span><span class="token function">sub_163DC</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call32<span class="token operator">:</span><span class="token function">_Znwm</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call33<span class="token operator">:</span><span class="token function">malloc</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call34<span class="token operator">:</span><span class="token function">sub_128D64</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call35<span class="token operator">:</span><span class="token function">sub_9E58</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call36<span class="token operator">:</span><span class="token function">j_lseek_1</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call37<span class="token operator">:</span><span class="token function">lseek</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call38<span class="token operator">:</span><span class="token function">sub_A3EC</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call39<span class="token operator">:</span><span class="token function">sub_99CC</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call40<span class="token operator">:</span><span class="token function">sub_9944</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call41<span class="token operator">:</span><span class="token function">sub_999C</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call42<span class="token operator">:</span><span class="token function">sub_128D70</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call43<span class="token operator">:</span><span class="token function">memcpy</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call44<span class="token operator">:</span><span class="token function">sub_14283C</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call45<span class="token operator">:</span><span class="token function">j__Znwm</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call46<span class="token operator">:</span><span class="token function">sub_1429CC</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call47<span class="token operator">:</span><span class="token function">sub_142FE0</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call48<span class="token operator">:</span><span class="token function">sub_10964</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call49<span class="token operator">:</span><span class="token function">sub_9D60</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call50<span class="token operator">:</span><span class="token function">sub_143008</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call51<span class="token operator">:</span><span class="token function">sub_142ABC</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call52<span class="token operator">:</span><span class="token function">sub_142EA0</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call53<span class="token operator">:</span><span class="token function">sub_143A38</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call54<span class="token operator">:</span><span class="token function">sub_11CF8C</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call55<span class="token operator">:</span><span class="token function">sub_12047C</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call56<span class="token operator">:</span><span class="token function">strlen</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call57<span class="token operator">:</span><span class="token function">memcmp</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call58<span class="token operator">:</span><span class="token function">sub_117B68</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call59<span class="token operator">:</span><span class="token function">sub_166C4</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call60<span class="token operator">:</span><span class="token function">memcpy</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call61<span class="token operator">:</span><span class="token function">sub_143848</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call62<span class="token operator">:</span><span class="token function">sub_1B66A8</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call63<span class="token operator">:</span><span class="token function">pthread_mutex_lock</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call64<span class="token operator">:</span><span class="token function">sub_143B48</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call65<span class="token operator">:</span><span class="token function">sub_1B66D0</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call66<span class="token operator">:</span><span class="token function">pthread_mutex_unlock</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call67<span class="token operator">:</span><span class="token function">sub_143088</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call68<span class="token operator">:</span><span class="token function">sub_11F768</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call69<span class="token operator">:</span><span class="token function">j__ZdlPv</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call70<span class="token operator">:</span><span class="token function">_ZdlPv</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call71<span class="token operator">:</span><span class="token function">free</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call72<span class="token operator">:</span><span class="token function">sub_1178E8</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call73<span class="token operator">:</span><span class="token function">sub_1222D0</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call74<span class="token operator">:</span><span class="token function">sub_14316C</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call75<span class="token operator">:</span><span class="token function">sub_142954</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call76<span class="token operator">:</span><span class="token function">_Z9__arm_a_2PcmS_Rii</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call77<span class="token operator">:</span><span class="token class-name">j_interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call78<span class="token operator">:</span><span class="token class-name">interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call79<span class="token operator">:</span><span class="token function">sub_9FFC</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call80<span class="token operator">:</span><span class="token function">j_lseek_3</span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call81<span class="token operator">:</span><span class="token function">j_lseek_2</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call82<span class="token operator">:</span><span class="token function">sub_9A90</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call83<span class="token operator">:</span><span class="token function">sub_142894</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call84<span class="token operator">:</span><span class="token function">sub_1428BC</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call85<span class="token operator">:</span><span class="token function">sub_127DCC</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call86<span class="token operator">:</span><span class="token function">sub_14292C</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call87<span class="token operator">:</span><span class="token function">sub_14285C</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call88<span class="token operator">:</span><span class="token function">j_lseek_0</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call89<span class="token operator">:</span><span class="token function">_Znam</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call90<span class="token operator">:</span><span class="token function">sub_128E88</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call91<span class="token operator">:</span><span class="token function">_ZdaPv</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call92<span class="token operator">:</span><span class="token function">sub_142AA4</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call93<span class="token operator">:</span><span class="token function">sub_142A10</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call94<span class="token operator">:</span><span class="token function">sub_12036C</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call95<span class="token operator">:</span><span class="token function">sub_1B6680</span></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call96<span class="token operator">:</span><span class="token function">pthread_mutex_destroy</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call97<span class="token operator">:</span><span class="token function">sub_131D58</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call98<span class="token operator">:</span><span class="token function">sub_11F3A4</span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call99<span class="token operator">:</span>sub_18FEA8<span class="token comment">// 这个函数中传入解密之后的 dex, 位置如下图所示</span></pre></td></tr></table></figure><p><img data-src="/360-jiagu/image-20240307120808017.png" alt="image-20240307120808017" style="aspect-ratio:1473 / 142;"></p>
<p>追踪函数调用链，我们发现了两个有趣的函数</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call50<span class="token operator">:</span><span class="token function">sub_143008</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call51<span class="token operator">:</span>sub_142ABC</pre></td></tr></table></figure><p><code>sub_143008</code>  看起来是一个解密的函数，先加上 0x70 再异或 0x36, 我们 hook 一下传入的参数看看是什么情况</p>
<p><img data-src="/360-jiagu/image-20240307120941018.png" alt="image-20240307120941018" style="aspect-ratio:914 / 874;"></p>
<p><img data-src="/360-jiagu/image-20240307121240701.png" alt="image-20240307121240701" style="aspect-ratio:1188 / 232;"></p>
<p>我们再去看看加密的 dex, 发现这个函数传入的就是加密的主 dex</p>
<p><img data-src="/360-jiagu/image-20240307121409507.png" alt="image-20240307121409507" style="aspect-ratio:792 / 329;"></p>
<p>把这部分解密看看里面是什么内容</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'ke_classes.dex'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    s <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>dexA <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">0x31A4</span><span class="token punctuation">:</span><span class="token number">0x31A4</span> <span class="token operator">+</span> <span class="token number">0x41E</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre>dexA <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>dexA<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>dexA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    dexA<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dexA<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0x70</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x36</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xff</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'dexA.dex'</span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>dexA<span class="token punctuation">)</span></pre></td></tr></table></figure><p>简单看了看， <code>APPKEY</code> , <code>activityName</code>  等等像是一些配置信息的样子</p>
<p><img data-src="/360-jiagu/image-20240307121648094.png" alt="image-20240307121648094" style="aspect-ratio:793 / 738;"></p>
<p>这部分内容解密完之后，在 <code>sub_142ABC</code>  中以 <code>pk</code>  为标志读取各个配置信息</p>
<p><img data-src="/360-jiagu/image-20240307124356084.png" alt="image-20240307124356084" style="aspect-ratio:807 / 355;"></p>
<p>之后我继续一个一个跳转到打印出来的函数中看，却一直都没有发现后续部分的解密算法的身影，随后我又仔细的看了一下调用的函数，突然有了惊喜的发现，这里的 <code>pthread_mutex_lock</code>  不就意味着要用互斥锁来切换到另外一个线程了吗！？</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call61<span class="token operator">:</span><span class="token function">sub_143848</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call62<span class="token operator">:</span><span class="token function">sub_1B66A8</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call63<span class="token operator">:</span><span class="token function">pthread_mutex_lock</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call64<span class="token operator">:</span><span class="token function">sub_143B48</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call65<span class="token operator">:</span><span class="token function">sub_1B66D0</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call66<span class="token operator">:</span>pthread_mutex_unlock</pre></td></tr></table></figure><p>我们 hook 一下 <code>sub_143848</code> , 并同时打印出 pid 来看看是什么情况</p>
<p><img data-src="/360-jiagu/image-20240307191208065.png" alt="image-20240307191208065" style="aspect-ratio:728 / 588;"></p>
<p>果不其然，在这里我们发现除了主线程外，还有三个不同的线程调用了这个函数</p>
<p><img data-src="/360-jiagu/image-20240307191316415.png" alt="image-20240307191316415" style="aspect-ratio:948 / 537;"></p>
<p>那我们在 pid 和主线程不同的时候，用 <code>stalker_trace_so</code>  的 <code>trace_so</code>  函数在去看看究竟调用了什么函数吧</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">var</span> stalker_trace_once <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x143848</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>main_thread<span class="token operator">!==</span>Process<span class="token punctuation">.</span><span class="token function">getCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>stalker_trace_once<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    stalker_trace_once <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                    <span class="token function">trace_so</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>打印出的内容如下</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>main thread <span class="token number">9434</span></pre></td></tr><tr><td data-num="2"></td><td><pre>start Stalker<span class="token operator">!</span><span class="token punctuation">,</span> pid<span class="token operator">:</span> <span class="token number">9472</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Stalker end<span class="token operator">!</span>             </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call1<span class="token operator">:</span><span class="token function">sub_1B66A8</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call2<span class="token operator">:</span><span class="token function">pthread_mutex_lock</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call3<span class="token operator">:</span><span class="token function">sub_143B48</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call4<span class="token operator">:</span><span class="token function">memcmp</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call5<span class="token operator">:</span><span class="token function">sub_142EA0</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call6<span class="token operator">:</span><span class="token function">sub_143A38</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call7<span class="token operator">:</span><span class="token function">sub_1B66D0</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call8<span class="token operator">:</span><span class="token function">pthread_mutex_unlock</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call9<span class="token operator">:</span><span class="token function">memset</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call10<span class="token operator">:</span><span class="token function">inotify_add_watch</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call11<span class="token operator">:</span><span class="token function">sub_9AC4</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call12<span class="token operator">:</span><span class="token function">j_ffi_prep_cif</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call13<span class="token operator">:</span><span class="token function">ffi_prep_cif</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call14<span class="token operator">:</span><span class="token function">j_ffi_prep_cif_machdep</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call15<span class="token operator">:</span><span class="token function">ffi_prep_cif_machdep</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call16<span class="token operator">:</span><span class="token function">j_ffi_call</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call17<span class="token operator">:</span><span class="token function">ffi_call</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call18<span class="token operator">:</span><span class="token function">fopen</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call19<span class="token operator">:</span><span class="token function">sub_1674C</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call20<span class="token operator">:</span><span class="token function">j_ffi_call_SYSV</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call21<span class="token operator">:</span><span class="token function">ffi_call_SYSV</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call22<span class="token operator">:</span><span class="token function">sub_167BC</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call23<span class="token operator">:</span><span class="token function">sub_1647C</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call24<span class="token operator">:</span><span class="token function">sub_163DC</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call25<span class="token operator">:</span><span class="token function">sub_1178E8</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call26<span class="token operator">:</span><span class="token function">sub_9988</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call27<span class="token operator">:</span><span class="token function">sub_1236B8</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call28<span class="token operator">:</span><span class="token function">strlen</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call29<span class="token operator">:</span><span class="token function">sub_1222D0</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call30<span class="token operator">:</span><span class="token function">sub_128D70</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call31<span class="token operator">:</span><span class="token function">memcpy</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call32<span class="token operator">:</span><span class="token function">getenv</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call33<span class="token operator">:</span><span class="token function">sub_9E58</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call34<span class="token operator">:</span><span class="token function">j_lseek_1</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call35<span class="token operator">:</span><span class="token function">lseek</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call36<span class="token operator">:</span><span class="token function">sub_1A1AE8</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call37<span class="token operator">:</span><span class="token function">j_strcmp</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call38<span class="token operator">:</span><span class="token function">strcmp</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call39<span class="token operator">:</span><span class="token function">sub_19F7C4</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call40<span class="token operator">:</span><span class="token function">j__Znwm</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call41<span class="token operator">:</span><span class="token function">_Znwm</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call42<span class="token operator">:</span><span class="token function">malloc</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call43<span class="token operator">:</span><span class="token function">sub_1A1B64</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call44<span class="token operator">:</span><span class="token function">sub_9964</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call45<span class="token operator">:</span><span class="token function">sub_1A1B7C</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call46<span class="token operator">:</span><span class="token function">memset</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call47<span class="token operator">:</span><span class="token function">sub_1A1D84</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call48<span class="token operator">:</span><span class="token function">sub_1A1E74</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call49<span class="token operator">:</span><span class="token function">j_j__ZdlPv_12</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call50<span class="token operator">:</span><span class="token function">j__ZdlPv</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call51<span class="token operator">:</span><span class="token function">_ZdlPv</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call52<span class="token operator">:</span><span class="token function">free</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call53<span class="token operator">:</span><span class="token function">sub_18DC28</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call54<span class="token operator">:</span><span class="token function">sub_18DC4C</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call55<span class="token operator">:</span><span class="token function">sub_9FFC</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call56<span class="token operator">:</span><span class="token function">sub_19B7EC</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call57<span class="token operator">:</span><span class="token function">mmap</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call58<span class="token operator">:</span><span class="token function">sub_A3EC</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call59<span class="token operator">:</span><span class="token function">sub_9944</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call60<span class="token operator">:</span><span class="token function">sub_18DCC0</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call61<span class="token operator">:</span><span class="token function">sub_18F6AC</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call62<span class="token operator">:</span><span class="token function">sub_18DDA8</span></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call63<span class="token operator">:</span><span class="token function">sub_18DD94</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call64<span class="token operator">:</span><span class="token function">sub_18DDB8</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call65<span class="token operator">:</span><span class="token function">sub_18E8D0</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call66<span class="token operator">:</span><span class="token function">sub_18E244</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call67<span class="token operator">:</span><span class="token function">j_j__ZdlPv_5</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call68<span class="token operator">:</span><span class="token function">sub_129468</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call69<span class="token operator">:</span><span class="token function">sub_12D478</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call70<span class="token operator">:</span><span class="token function">sub_1A19EC</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call71<span class="token operator">:</span><span class="token function">raise</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call72<span class="token operator">:</span><span class="token function">j_lseek_2</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call73<span class="token operator">:</span><span class="token function">sub_9A90</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call74<span class="token operator">:</span><span class="token function">j_lseek_0</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">(</span>KEkeELF<span class="token punctuation">)</span>call75<span class="token operator">:</span><span class="token function">j_lseek_3</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call76<span class="token operator">:</span><span class="token function">sub_19BC9C</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call77<span class="token operator">:</span><span class="token function">sub_11CF8C</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call78<span class="token operator">:</span><span class="token function">sub_131D58</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call79<span class="token operator">:</span>memmove</pre></td></tr></table></figure><p>继续跟着调用的函数一处一处到 ida 里面看，在下面的函数中我们终于有了收获</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call45<span class="token operator">:</span><span class="token function">sub_1A1B7C</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call46<span class="token operator">:</span><span class="token function">memset</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call47<span class="token operator">:</span><span class="token function">sub_1A1D84</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call48<span class="token operator">:</span>sub_1A1E74</pre></td></tr></table></figure><p>这个算法，看起来又是 RC4 呐</p>
<p><img data-src="/360-jiagu/image-20240307191840395.png" alt="image-20240307191840395" style="aspect-ratio:999 / 749;"></p>
<p>hook 一下这个函数，发现密钥是 <code>b&quot;\x68\x76\x99\x72\x96\x60\x9f\x63\x96\x2c\x98\x30\xc2\x36\x51\x42&quot;</code></p>
<p><img data-src="/360-jiagu/image-20240307192203905.png" alt="image-20240307192203905" style="aspect-ratio:1171 / 392;"></p>
<p>再去 hook  <code>sub_1A1E74</code>  看看传入了什么数据，我们发现前三部分都是 <code>f7 4f e8 0e</code>  开头的</p>
<p><img data-src="/360-jiagu/image-20240307193744892.png" alt="image-20240307193744892" style="aspect-ratio:1200 / 819;"></p>
<p>看到这些数据，终于离成功又更进一步了，因为这些数据就是我们读取完壳 DEX 尾部的前 <code>0x41E</code>  个加密数据并解密出配置信息之后的那部分加密数据，同时我们也可以在 010editor 中通过搜索壳 DEX 找到它们，这三部分加密数据段所在的位置分别为 <code>0x35CE</code> , <code>0x3A93AD</code> , <code>0x417064</code></p>
<p><img data-src="/360-jiagu/image-20240307194101403.png" alt="image-20240307194101403" style="aspect-ratio:309 / 168;"></p>
<p>我们先来到第一个数据段的位置来分析数据段的结构，这个位置是在 <code>0x31A4+0x41E</code> , 即 <code>0x35c2</code>  之后</p>
<p><img data-src="/360-jiagu/image-20240308004303427.png" alt="image-20240308004303427" style="aspect-ratio:1031 / 349;"></p>
<p>所以这 dex 的第一个解密算法如下</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">RC4</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    S <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    j <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    out <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment"># KSA Phase</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment"># PRGA Phase</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    i <span class="token operator">=</span> j <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    count <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">for</span> ch <span class="token keyword">in</span> data<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        S<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> S<span class="token punctuation">[</span>i<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        out<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ch <span class="token operator">^</span> S<span class="token punctuation">[</span><span class="token punctuation">(</span>S<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> S<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> out</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">def</span> <span class="token function">RC4decrypt</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">return</span> RC4<span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>key <span class="token operator">=</span> <span class="token string">b"\x68\x76\x99\x72\x96\x60\x9f\x63\x96\x2c\x98\x30\xc2\x36\x51\x42"</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'com.oacia.apk_protect/classes.dex'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    enc_data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>start <span class="token operator">=</span> <span class="token number">0x35C2</span></pre></td></tr><tr><td data-num="30"></td><td><pre>dexcount <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>enc_data<span class="token punctuation">[</span>start<span class="token punctuation">:</span>start<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>start<span class="token operator">+=</span><span class="token number">4</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>dexcount<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    total_data_len <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>enc_data<span class="token punctuation">[</span>start<span class="token punctuation">:</span>start<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    start<span class="token operator">+=</span><span class="token number">4</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    rc4_data_len <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>enc_data<span class="token punctuation">[</span>start<span class="token punctuation">:</span>start<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    start<span class="token operator">+=</span><span class="token number">4</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    enc_dex <span class="token operator">=</span> enc_data<span class="token punctuation">[</span>start<span class="token punctuation">:</span>start<span class="token operator">+</span>rc4_data_len<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    start<span class="token operator">+=</span>rc4_data_len</pre></td></tr><tr><td data-num="39"></td><td><pre>    dec_dex <span class="token operator">=</span> RC4decrypt<span class="token punctuation">(</span>enc_dex<span class="token punctuation">,</span>key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    dec2_data_len <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>dec_dex<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'dex</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">.dex'</span></span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>dec_dex<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    extra <span class="token operator">=</span> enc_data<span class="token punctuation">[</span>start<span class="token punctuation">:</span>start<span class="token operator">+</span>total_data_len<span class="token operator">-</span>rc4_data_len<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    extra_data_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>dec_dex<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    extra_data_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>extra<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    start<span class="token operator">+=</span>total_data_len<span class="token operator">-</span>rc4_data_len<span class="token operator">-</span><span class="token number">4</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"part</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">: total_data_len: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>total_data_len<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">, rc4_data_len: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>rc4_data_len<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"rc4_dec_part</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">: extra_data_base: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>extra_data_base<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">,extra_data_len: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>extra_data_len<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">, dec2_data_len: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>dec2_data_len<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'dex</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">_extra.dex'</span></span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>extra<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><img data-src="/360-jiagu/image-20240308110813489.png" alt="image-20240308110813489" style="aspect-ratio:1370 / 203;"></p>
<p>但是光这还不够，因为 rc4 解密出来的数据仍然不是 DEX 格式</p>
<p><img data-src="/360-jiagu/image-20240308005514430.png" alt="image-20240308005514430" style="aspect-ratio:791 / 222;"></p>
<p>之后继续跟着函数调用链走，找到这些函数</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call60<span class="token operator">:</span><span class="token function">sub_18DCC0</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call61<span class="token operator">:</span><span class="token function">sub_18F6AC</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call62<span class="token operator">:</span><span class="token function">sub_18DDA8</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call63<span class="token operator">:</span><span class="token function">sub_18DD94</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call64<span class="token operator">:</span>sub_18DDB8</pre></td></tr></table></figure><p>在 <code>sub_18F6AC</code>  中的代码感觉很像是算法相关</p>
<p><img data-src="/360-jiagu/image-20240308005825649.png" alt="image-20240308005825649" style="aspect-ratio:1123 / 715;"></p>
<p>通过 hook 其中的 <code>sub_18DDB8</code>  函数发现 a3 是 rc4 解密之后的从 0xc 开始的数据段</p>
<p><img data-src="/360-jiagu/image-20240308010341488.png" alt="image-20240308010341488" style="aspect-ratio:1178 / 167;"></p>
<p><img data-src="/360-jiagu/image-20240308010411747.png" alt="image-20240308010411747" style="aspect-ratio:802 / 244;"></p>
<p>而前面的 0xc 位额外数据的读取方式为 5+4+4, 在 <code>sub_18DCC0</code>  中有读取操作，通过这样的读取操作我们可以依次得到 <code>0x010000005D</code> , <code>0x400000</code> , <code>0x109492</code></p>
<p><img data-src="/360-jiagu/image-20240308010524472.png" alt="image-20240308010524472" style="aspect-ratio:1015 / 418;"></p>
<p>这里的 <code>0x109492</code>  表示的是第二次解密的数据段的大小，那么 <code>0x40000</code>  表示什么呢？</p>
<p>还记得我们的加密数据段是有前后两部分的嘛，前半部分用 rc4 解密，那么后半部分我们来看看长什么样子好了</p>
<p><img data-src="/360-jiagu/image-20240308011028793.png" alt="image-20240308011028793" style="aspect-ratio:797 / 383;"></p>
<p>后半部分的数据看起来十分的规整，不像是有加密的样子</p>
<p>而在<strong>主 DEX 加载流程分析</strong>中，我们成功的 dump 出了主 DEX, 那么我们不妨把这个这里的数据到主 DEX 中搜索一番看看有什么发现吧</p>
<p>在主 DEX 中搜索第一行的字节，我们惊喜的发现竟然可以搜索到，并且它的位置正好就是 <code>0x400000</code> !</p>
<p><img data-src="/360-jiagu/image-20240308011259938.png" alt="image-20240308011259938" style="aspect-ratio:829 / 332;"></p>
<p>所以说经过 RC4 解密之后的这部分的数据结构我们也就可以知道了</p>
<p><img data-src="/360-jiagu/image-20240308011627096.png" alt="image-20240308011627096" style="aspect-ratio:793 / 310;"></p>
<p>接下来我们只要搞清楚在 <code>sub_18DDB8</code>  中第二次解密的算法是什么就可以了</p>
<p>我们再回到分析的起点 <code>sub_128D44</code>  函数，来看看能不能有其他的发现</p>
<p><img data-src="/360-jiagu/image-20240308012120417.png" alt="image-20240308012120417" style="aspect-ratio:1071 / 141;"></p>
<p>通过 hook  <code>sub_128D44</code>  的返回值 v150 之后发现，三级指针指向着解密之后的 dex</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">.</span><span class="token function">readS64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">0x40</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="/360-jiagu/image-20240308012312135.png" alt="image-20240308012312135" style="aspect-ratio:1191 / 172;"></p>
<p>而倘若我们观察这个解密数据所在的内存 <code>703bc75000</code> , 它正好是 <code>0x1000</code>  的倍数，而 <code>0x1000</code>  正好就是一页的大小</p>
<p>这意味着什么呢？</p>
<p>这说明 dex 所在的内存极有可能是通过 <code>mmap</code>  函数分配的！</p>
<p>而在 <code>stalker_trace_so</code>  打印的数据中，正好就有这个函数被调用了</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>mainELF<span class="token punctuation">)</span>call57<span class="token operator">:</span>mmap</pre></td></tr></table></figure><p>于是我们来到 mmap 被调用的函数</p>
<p><img data-src="/360-jiagu/image-20240308012704595.png" alt="image-20240308012704595" style="aspect-ratio:688 / 359;"></p>
<p>使用 frida hook mmap 返回的内存指针，然后打上内存读写断点，就可以帮助我们快速定位到最终解密算法完成之后赋值的地址</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_mmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libjiagu_64.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x19B81C</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">// fd, buff, len</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"mmap!"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            MemoryAccessMonitor<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                    <span class="token literal-property property">base</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                    <span class="token literal-property property">size</span><span class="token operator">:</span><span class="token number">30</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                    <span class="token function-variable function">onAccess</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">details</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span>operation<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">get_addr_in_so</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span>from<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ret</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">function</span> <span class="token function">get_addr_in_so</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">var</span> process_Obj_Module_Arr <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">enumerateModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> process_Obj_Module_Arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>addr<span class="token operator">></span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base <span class="token operator">&amp;&amp;</span> addr<span class="token operator">&lt;</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">return</span> addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" is in "</span><span class="token operator">+</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">" offset: 0x"</span><span class="token operator">+</span><span class="token punctuation">(</span>addr<span class="token operator">-</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">return</span> addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 <code>0x18ebd4</code>  中将值写入最终的目标内存，这个地址在 <code>sub_18E8D0</code>  中</p>
<p><img data-src="/360-jiagu/image-20240308014607722.png" alt="image-20240308014607722" style="aspect-ratio:737 / 132;"></p>
<p><img data-src="/360-jiagu/image-20240308012938693.png" alt="image-20240308012938693" style="aspect-ratio:532 / 211;"></p>
<p>在这个函数的开头，有对参数 a1 的读取操作</p>
<p><img data-src="/360-jiagu/image-20240308112313375.png" alt="image-20240308112313375" style="aspect-ratio:560 / 429;"></p>
<p>我们 hook 一下值来看看 a1 各个部分都有什么含义</p>
<p><img data-src="/360-jiagu/image-20240308112226813.png" alt="image-20240308112226813" style="aspect-ratio:1198 / 581;"></p>
<p><img data-src="/360-jiagu/image-20240308112237431.png" alt="image-20240308112237431" style="aspect-ratio:1408 / 457;"></p>
<p>给 a1 写一个结构体好了</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">dec2_struct</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">long</span> <span class="token keyword">long</span> shift_bit<span class="token punctuation">;</span><span class="token comment">// 移位的位数</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">int</span> reversed0<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">int</span> reversed1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">long</span> <span class="token keyword">long</span> constA<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">long</span> <span class="token keyword">long</span> dest<span class="token punctuation">;</span><span class="token comment">// 解密后的 dex 存储的地址</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">long</span> <span class="token keyword">long</span> constB<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">long</span> <span class="token keyword">long</span> constC<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">long</span> <span class="token keyword">long</span> index<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">long</span> <span class="token keyword">long</span> extra_dex_base<span class="token punctuation">;</span><span class="token comment">// 额外数据将要复制到的基址</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">int</span> guess_count2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">int</span> reversed2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">int</span> flag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">int</span> key<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">int</span> reversed3<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">int</span> reversed4<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">int</span> reversed5<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">int</span> data_len<span class="token punctuation">;</span><span class="token comment">// 记录额外数据的长度</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">int</span> input_read_index<span class="token punctuation">;</span><span class="token comment">// 记录读取输入的加密数据的下标</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> data<span class="token punctuation">[</span><span class="token number">0x112</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 记录额外数据</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>最后带着我们的结构体逛逛这个解密算法的函数好咯</p>
<p>sub_18F6AC</p>
<p><img data-src="/360-jiagu/image-20240309004158571.png" alt="image-20240309004158571" style="aspect-ratio:1044 / 623;"></p>
<p>sub_18DDB8</p>
<p><img data-src="/360-jiagu/image-20240309004238199.png" alt="image-20240309004238199" style="aspect-ratio:1413 / 766;"></p>
<p>sub_18E244</p>
<p><img data-src="/360-jiagu/image-20240309004324883.png" alt="image-20240309004324883" style="aspect-ratio:1186 / 669;"></p>
<p>sub_18E8D0</p>
<p><img data-src="/360-jiagu/image-20240309004410712.png" alt="image-20240309004410712" style="aspect-ratio:1635 / 623;"></p>
<p>这些函数无壳无花无打乱，也没有 vmp 加固，显得相当的干净，看起来是一个自定义算法</p>
<p>算法千变万化，但是加固永远不是重在算法</p>
<p>逆向一款优秀的加固壳，从中学习到的知识可以受益终生，同时也可以借此思考如何避免让别人轻易找到加固方案的突破口</p>
<p>逢山开路，遇水搭桥。兵来将挡，水来土掩。</p>
<p>我们最后来 hook 一下下面这个地方来为我们的分析画上圆满的句号吧</p>
<p><img data-src="/360-jiagu/image-20240309011700849.png" alt="image-20240309011700849" style="aspect-ratio:939 / 265;"></p>
<p><img data-src="/360-jiagu/image-20240309013111976.png" alt="image-20240309013111976" style="aspect-ratio:558 / 225;"></p>
<p>至此，360 加固分析完毕</p>
<h1 id="总结"><a class="anchor" href="#总结">#</a> 总结</h1>
<p>360 加固和常规的加固方案类似，都是 <code>壳DEX-&gt;壳ELF-&gt;主ELF-&gt;主DEX</code>  这样的过程，其中壳 ELF 解密主 ELF 所用到的算法是 <code>RC4</code>  和 <code>uncompress</code> , 壳 ELF 加载主 ELF 所用到的技术是自实现 linker 加固 so</p>
<p>当然 360 加固还有许多值得继续研究分析的地方，例如分发 so 函数的 vmp 其内部逻辑究竟是什么样子呢？native 化的 <code>onCreate</code>  函数，dex2c 的原理究竟是什么呢？这些就留给未来的不眠之夜吧～</p>
<p>月遇从云，花遇和风，今晚上的夜空很美</p>
<h1 id="参考资料"><a class="anchor" href="#参考资料">#</a> 参考资料</h1>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuNzcxNjkubmV0L2h0bWwvMTcwNzI0Lmh0bWw=">360 加固保关键技术浅析</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9jcnlwdGF4Lm1lZGl1bS5jb20vZGVjcnlwdGluZy1zdHJpbmdzLXdpdGgtYS1qZWItc2NyaXB0LTFhZjUyMmZhNDk3OQ==">Decrypting strings with a JEB script</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vcmV2ZXJjYy9wLzE3MTAwMzA4Lmh0bWw=">自实现 linker 加固 so</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjYwMDQ5Lmh0bQ==">360 加固保分析</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjc1ODExLmh0bQ==">误入虎穴，喜得虎子 —— 记一次手游加固的脱壳与修复</span></li>
</ul>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2025-04-09 02:55:11" itemprop="dateModified" datetime="2025-04-09T02:55:11+08:00">2025-04-09</time>
  </span>
  <span id="360-jiagu/" class="item leancloud_visitors" data-flag-title="360加固dex解密流程分析" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>oacia <i class="ic i-at"><em>@</em></i>oaciaのBbBlog~
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://oacia.dev/360-jiagu/" title="360加固dex解密流程分析">https://oacia.dev/360-jiagu/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/ElfReader/" itemprop="url" rel="prev" data-background-image="&#x2F;picture&#x2F;358988.webp" title="ELF结构分析及ElfReader">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>ELF结构分析及ElfReader</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/python-memory-leak/" itemprop="url" rel="next" data-background-image="&#x2F;picture&#x2F;41596.webp" title="记一次python ctypes.cast引起的内存泄漏">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>记一次python ctypes.cast引起的内存泄漏</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text"> 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#java%E5%B1%82%E5%88%9D%E6%AD%A5%E5%88%86%E6%9E%90"><span class="toc-text"> java 层初步分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A3%B3elf%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA%E8%A1%A8%E4%BF%AE%E5%A4%8D"><span class="toc-text"> 壳 ELF 导入导出表修复</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A0%E5%9B%BA%E5%A3%B3%E5%8F%8D%E8%B0%83%E8%AF%95%E5%88%9D%E6%AD%A5%E5%88%86%E6%9E%90"><span class="toc-text"> 加固壳反调试初步分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BBelf%E8%A7%A3%E5%AF%86%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text"> 主 ELF 解密流程分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BBelf%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA%E8%A1%A8%E4%BF%AE%E5%A4%8D"><span class="toc-text"> 主 ELF 导入导出表修复</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BBdex%E8%A7%A3%E5%AF%86%E6%B5%81%E7%A8%8B%E5%88%9D%E6%AD%A5%E5%88%86%E6%9E%90"><span class="toc-text"> 主 DEX 解密流程初步分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A0%E5%9B%BA%E5%A3%B3%E5%8F%8D%E8%B0%83%E8%AF%95%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90"><span class="toc-text"> 加固壳反调试深入分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BBdex%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text"> 主 DEX 加载流程分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BBdex%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-text"> 主 DEX 解密算法分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text"> 总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text"> 参考资料</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="oacia"
      data-src="/images/avatar.jpg">
  
  <svg class="logo-overview" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 540.19 380.99">
    <g id="clips" fill= #00a99d; stroke="none">
      <clipPath id="o">
        <path d="M93.57,284c8,0,14.91-1,20.75-3,5.83-2,10.41-3.66,13.75-5,4.66-1.66,6.16-.75,4.5,2.75-1.67,3.5-4.67,6.42-9,8.75-2.34,1.34-6.09,2.84-11.25,4.5-5.17,1.67-11.09,2.5-17.75,2.5-.34,8.67-3.34,16.84-9,24.5-5.67,7.67-13.34,13.34-23,17-6,2.34-12.17,3.59-18.5,3.75-6.34,.17-12.17-.66-17.5-2.5-5.34-1.83-10.09-4.66-14.25-8.5-4.17-3.83-7.25-8.41-9.25-13.75-2-5.33-2.83-11-2.5-17s1.83-11.83,4.5-17.5c2.66-5.66,6.33-10.75,11-15.25,4.66-4.5,10.16-7.75,16.5-9.75,5.66-1.66,11.41-1.66,17.25,0,5.83,1.67,10.08,4.34,12.75,8,1.66,2.67,2.5,5.67,2.5,9,3-2,6.33-3,10-3h1c3.33,0,6.5,.84,9.5,2.5,3,1.67,5.33,4.5,7,8.5l1,3.5Zm-34,39.5c5.66-.66,10.33-3.83,14-9.5,3.66-5.66,5.33-12.16,5-19.5-4.67,.34-9.09-.41-13.25-2.25-4.17-1.83-6.42-4.58-6.75-8.25-.67-3,0-5.5,2-7.5-.67-2.66-2.75-5-6.25-7s-7.09-2.16-10.75-.5c-4.67,2-8.25,5.84-10.75,11.5-2.5,5.67-3.09,11.84-1.75,18.5,1.33,8,4.75,14.34,10.25,19,5.5,4.67,11.58,6.5,18.25,5.5Z"/>
      </clipPath>
      <clipPath id="a1">
        <path d="M176.06,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      <clipPath id="c">
        <path d="M250.06,280.5c4.66-7.66,12-13.16,22-16.5,10-3.33,19.83-3.66,29.5-1,7.66,2.34,13.5,5.67,17.5,10,4,4.34,5.83,8.5,5.5,12.5-.34,4.67-2.25,8.59-5.75,11.75-3.5,3.17-7.09,5.34-10.75,6.5-3.67,1.17-6.84,1.25-9.5,.25-2.67-1-3.34-3.16-2-6.5,2.66-8,2.75-14.58,.25-19.75-2.5-5.16-5.92-6.41-10.25-3.75-2.67,1.67-5,4.09-7,7.25-2,3.17-3.5,6.75-4.5,10.75s-1.42,8.09-1.25,12.25c.16,4.17,.75,7.92,1.75,11.25,1.33,4,3.66,7.42,7,10.25,3.33,2.84,7.16,4.67,11.5,5.5,4.33,.84,8.91,.67,13.75-.5,4.83-1.16,9.25-3.75,13.25-7.75,7.33-6.66,12.33-14.33,15-23,.33-1.66,1.16-2.91,2.5-3.75,1.33-.83,2.5-1.08,3.5-.75,1,.34,1.83,1.09,2.5,2.25,.66,1.17,.66,2.92,0,5.25-2.34,9.34-6.34,17-12,23-4.67,5.67-10.5,10.42-17.5,14.25-7,3.84-14.25,6.09-21.75,6.75-7.5,.67-14.84-.33-22-3-7.17-2.66-13.25-7.5-18.25-14.5-6-8.66-8.75-17.66-8.25-27,.5-9.33,2.25-16.66,5.25-22Z"/>
      </clipPath>
      <clipPath id="i_b">
        <path d="M393.06,330c-2.34,2.67-5.17,5.09-8.5,7.25-3.34,2.17-7.09,3.59-11.25,4.25-4.17,.67-8.59,.67-13.25,0-4.67-.66-9.17-2.33-13.5-5-4.67-2.66-7.67-7.58-9-14.75-1.34-7.16-1.83-14.66-1.5-22.5,.33-7.83,1.33-14.91,3-21.25,1.66-6.33,3.33-10.16,5-11.5,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,3.59,1.25,6.75-.17,3.17-.5,6.92-1,11.25-.5,4.34-1.09,8.92-1.75,13.75-.67,4.84-.67,9.42,0,13.75,.33,3.67,1.33,6.42,3,8.25,1.66,1.84,3.5,2.84,5.5,3,2,.17,4-.25,6-1.25s3.83-2.33,5.5-4c3-3.66,5.66-7.66,8-12,2.33-4.33,4.16-8.16,5.5-11.5,1-3.66,2.91-5.25,5.75-4.75,2.83,.5,3.75,3.09,2.75,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.34,8.59-10,14.25Z"/>
      </clipPath>
      <clipPath id="a2">
        <path d="M461.56,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      
    </g>
    <g
      id="strokes"
      fill="none"
      stroke=#96d7f5
      stroke-linecap="round"
      stroke-linejoin="round"
    >
    <path
    clip-path="url(#o)"
    class="oPath path"
    d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
    stroke-width="32.5"
    ></path>
    <path
      clip-path="url(#a1)"
      class="a1Path path"
      d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
      stroke-width="59"
    ></path>
    <path
      clip-path="url(#c)"
      class="cPath path"
      d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
      stroke-width="110"
    ></path>
    <path
      clip-path="url(#i_b)"
      class="i_bPath path"
      d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
      stroke-width="33"
    ></path>
    <path
      clip-path="url(#a2)"
      class="a2Path path"
      d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
      stroke-width="70"
    ></path>
    </g>
    <g
      id="strokes2"
      fill="none"
      stroke=#ff97b8
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path
        clip-path="url(#o)"
        class="oPath path"
        d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
        stroke-width="32.5"
      ></path>
      <path
        clip-path="url(#a1)"
        class="a1Path path"
        d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
        stroke-width="59"
      ></path>
      <path
        clip-path="url(#c)"
        class="cPath path"
        d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
        stroke-width="110"
      ></path>
      <path
        clip-path="url(#i_b)"
        class="i_bPath path"
        d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
        stroke-width="33"
      ></path>
      <path
        clip-path="url(#a2)"
        class="a2Path path"
        d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
        stroke-width="70"
      ></path>
    </g>
    <g class="dot-group">
      <path
        id="dot"
        fill=#ff97b8
        d="M362.58,182.21c4.66-.33,9.66,1.17,15,4.5,5.33,3.34,7.66,7.5,7,12.5-.67,2.34-1.92,4.92-3.75,7.75-1.84,2.84-4,5.5-6.5,8s-4.84,4.75-7,6.75c-2.17,2-3.75,3.17-4.75,3.5-2.67,1.67-5.34,2.25-8,1.75-2.67-.5-5-1.5-7-3s-3.59-3.33-4.75-5.5c-1.17-2.16-1.92-4.25-2.25-6.25-.34-2,.16-4.66,1.5-8,1.33-3.33,3.08-6.58,5.25-9.75,2.16-3.16,4.58-6,7.25-8.5,2.66-2.5,5.33-3.75,8-3.75Z"
      ></path>
    </g>
  </svg>
  <div class="description" itemprop="description">月遇从云 花遇和风</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">53</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">46</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lh" title="https:&#x2F;&#x2F;github.com&#x2F;oacia"><i class="ic i-github"></i></span>
      <a target="_blank" rel="noopener" href="https://twitter.com/oacia86" title="https:&#x2F;&#x2F;twitter.com&#x2F;oacia86" class="item twitter"><i class="ic i-twitter"></i></a>
      <span class="exturl item paper-plane" data-url="aHR0cHM6Ly90Lm1lL29hY2lh" title="https:&#x2F;&#x2F;t.me&#x2F;oacia"><i class="ic i-paper-plane"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOm9hY2lhODZAZ21haWwuY29t" title="mailto:oacia86@gmail.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about-oacia/" rel="section"><i class="ic i-user"></i>关于oacia</a>
  </li>

    
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-feather"></i>文章</a>
  </li>

    
  <li class="item">
    <a href="/TODOlist/" rel="section"><i class="ic i-clock"></i>要做的事</a>
  </li>

    
  <li class="item">
    <a href="/website_maintenance/" rel="section"><i class="ic i-calendar"></i>更新日志</a>
  </li>

    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>小伙伴</a>
  </li>

    
  <li class="item">
    <a href="/music/" rel="section"><i class="ic i-music"></i>听会儿歌吧</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/ElfReader/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/python-memory-leak/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2022 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">oacia @ oacia</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">968k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">14:40</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>



<script data-config type="text/javascript">
  var LOCAL = {
    path: '360-jiagu/',
    favicon: {
      show: "柚鳥ナツ",
      hide: "甘い幸せ"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>
<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>


<script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>
<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
