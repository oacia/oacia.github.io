



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="qQVmgWozVe7BXoA15J3gAZpEA5dK168admH4U3W6PAk">
  <meta name="msvalidate.01" content="4902E39C0135E72DE537BCB0FE08B40A">
  <meta name="baidu-site-verification" content="codeva-CSYjpuVg5v">


<link rel="alternate" type="application/rss+xml" title="oaciaのBbBlog~" href="https://oacia.dev/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="oaciaのBbBlog~" href="https://oacia.dev/atom.xml" />
<link rel="alternate" type="application/json" title="oaciaのBbBlog~" href="https://oacia.dev/feed.json" />
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-regular.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-700.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/font_1832207_igi8uaupcus.woff2"
/>
<link rel="preload" href="/background_picture/1_gongzi.webp" as="image" />
<link rel="preload" href="/background_picture/2_xiaoxia.webp" as="image" />
<link rel="preload" href="/background_picture/3_xingye.webp" as="image" />
<link rel="preload" href="/images/avatar.jpg" as="image" />



<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="android" />


<link rel="canonical" href="https://oacia.dev/sec-2023/">


<meta name="description" content="# 前言  在今年三月份的时候，我参加了腾讯游戏安全技术竞赛，到现在差不多快过去半年了，当时做这道安卓初赛题目时，也是卡在开头就毫无头绪了，而后看到看雪上的三位大佬 |_|sher 师傅，juice4fun 师傅和 fallw1nd 师傅都分享了他们做这道题目时的解题过程，也是让我重拾了做出这道安卓初赛题的信心，因为需要分心在学习和其他事情上，所以从三月份到七月份也是陆陆续续复现了五个月，一路上走">
<meta property="og:type" content="article">
<meta property="og:title" content="细品sec2023安卓赛题">
<meta property="og:url" content="https://oacia.dev/sec-2023/">
<meta property="og:site_name" content="oaciaのBbBlog~">
<meta property="og:description" content="# 前言  在今年三月份的时候，我参加了腾讯游戏安全技术竞赛，到现在差不多快过去半年了，当时做这道安卓初赛题目时，也是卡在开头就毫无头绪了，而后看到看雪上的三位大佬 |_|sher 师傅，juice4fun 师傅和 fallw1nd 师傅都分享了他们做这道题目时的解题过程，也是让我重拾了做出这道安卓初赛题的信心，因为需要分心在学习和其他事情上，所以从三月份到七月份也是陆陆续续复现了五个月，一路上走">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230407124030376.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230407124010267.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230407160715829.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230407142822706.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230407160451904.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230407230411862.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230901121900113.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230901122457467.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230505192823591.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230901122928576.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230505193356013.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230505193659902.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230505195047080.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230901124209545.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230505195256088.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230901125853006.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230505144017295.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230506180743547.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/screenshot-16808551676034.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230506185306047.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230507183715015.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230808172326007.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230808172408181.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230507190652325.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230809155725055.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230809160214205.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230817132059046.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230817132705290.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230817133029502.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230817025119017.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230817030756246.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230817133504656.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230817154739431.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230817170036802.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230818141550105.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230819014827349.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230819020109133.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230819020355254.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230819022733118.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230825005445886.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230829154207172.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230829160716908.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830024642669.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230829154859854.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830000329982.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830000805212.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830000915933.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830001101633.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830001653193.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830022051922.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830033519965.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830064031273.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830065454042.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830065541513.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830070108643.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830070631442.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830070942449.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830091801333.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830091847819.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830101119023.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830102759333.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830105402607.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830105501678.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830102726283.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830110257781.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230830110454534.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230831064228955.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230831065121629.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230831070953192.png">
<meta property="og:image" content="https://oacia.dev/sec-2023/image-20230831072058487.png">
<meta property="article:published_time" content="2023-08-31T00:19:57.000Z">
<meta property="article:modified_time" content="2025-04-08T18:55:11.766Z">
<meta property="article:author" content="oacia">
<meta property="article:tag" content="android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oacia.dev/sec-2023/image-20230407124030376.png">
<meta name="twitter:creator" content="@oacia86">


  <title>
细品sec2023安卓赛题 |
oacia = oaciaのBbBlog~ = DEVIL or SWEET</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  var jq_151 = $.noConflict(true);
  var RENDERER = {
    INIT_CHERRY_BLOSSOM_COUNT : 30,
    MAX_ADDING_INTERVAL : 10,
    WATCH_INTERVAL : 300,
    
    init : function(){
      this.setParameters();
      this.reconstructMethods();
      this.setup();
      this.bindEvent();
      this.render();
    },
    setParameters : function(){
      this.$window = jq_151(window);
      this.$container = jq_151('#loading');
      this.$canvas = jq_151('<canvas />');
      this.context = this.$canvas.appendTo(this.$container).get(0).getContext('2d');
      this.cherries = [];
      this.watchIds = [];
    },
    reconstructMethods : function(){
      this.watchWindowSize = this.watchWindowSize.bind(this);
      this.jdugeToStopResize = this.jdugeToStopResize.bind(this);
      this.render = this.render.bind(this);
    },
    setup : function(){
      this.cherries.length = 0;
      this.watchIds.length = 0;
      this.width = this.$container.width();
      this.height = this.$container.height();
      this.$canvas.attr({width : this.width, height : this.height});
      this.maxAddingInterval = Math.round(this.MAX_ADDING_INTERVAL * 1000 / this.width);
      this.addingInterval = this.maxAddingInterval;
      this.createCherries();
    },
    createCherries : function(){
      for(var i = 0, length = Math.round(this.INIT_CHERRY_BLOSSOM_COUNT * this.width / 1000); i < length; i++){
        this.cherries.push(new CHERRY_BLOSSOM(this, true));
      }
    },
    watchWindowSize : function(){
      this.clearTimer();
      this.tmpWidth = window.width;
      this.tmpHeight = window.height;
      this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL));
    },
    clearTimer : function(){
      while(this.watchIds.length > 0){
        clearTimeout(this.watchIds.pop());
      }
    },
    jdugeToStopResize : function(){
      var width = window.width,
        height = window.height,
        stopped = (width == this.tmpWidth && height == this.tmpHeight);
        
      this.tmpWidth = width;
      this.tmpHeight = height;
      
      if(stopped){
        this.setup();
      }
    },
    bindEvent : function(){
      this.$window.on('resize', this.watchWindowSize);
    },
    render : function(){
      //console.log("render")

      if(jq_151(this.$container).css("display")!="none"){
        requestAnimationFrame(this.render);
      }
      
      this.context.clearRect(0, 0, this.width, this.height);
      
      this.cherries.sort(function(cherry1, cherry2){
        return cherry1.z - cherry2.z;
      });
      for(var i = this.cherries.length - 1; i >= 0; i--){
        if(!this.cherries[i].render(this.context)){
          this.cherries.splice(i, 1);
        }
      }
      if(--this.addingInterval == 0){
        this.addingInterval = this.maxAddingInterval;
        this.cherries.push(new CHERRY_BLOSSOM(this, false));
      }
    }
  };
  var CHERRY_BLOSSOM = function(renderer, isRandom){
    this.renderer = renderer;
    this.init(isRandom);
  };
  CHERRY_BLOSSOM.prototype = {
    FOCUS_POSITION : 300,
    FAR_LIMIT : 600,
    MAX_RIPPLE_COUNT : 100,
    RIPPLE_RADIUS : 100,
    SURFACE_RATE : 0.5,
    SINK_OFFSET : 20,
    
    init : function(isRandom){
      this.x = this.getRandomValue(-this.renderer.width, this.renderer.width);
      this.y = isRandom ? this.getRandomValue(0, this.renderer.height) : this.renderer.height * 1.5;
      this.z = this.getRandomValue(0, this.FAR_LIMIT);
      this.vx = this.getRandomValue(-2, 2);
      this.vy = -2;
      this.theta = this.getRandomValue(0, Math.PI * 2);
      this.phi = this.getRandomValue(0, Math.PI * 2);
      this.psi = 0;
      this.dpsi = this.getRandomValue(Math.PI / 600, Math.PI / 300);
      this.opacity = 0;
      this.endTheta = false;
      this.endPhi = false;
      this.rippleCount = 0;
      
      var axis = this.getAxis(),
        theta = this.theta + Math.ceil(-(this.y + this.renderer.height * this.SURFACE_RATE) / this.vy) * Math.PI / 500;
      theta %= Math.PI * 2;
      
      this.offsetY = 40 * ((theta <= Math.PI / 2 || theta >= Math.PI * 3 / 2) ? -1 : 1);
      this.thresholdY = this.renderer.height / 2 + this.renderer.height * this.SURFACE_RATE * axis.rate;
      this.entityColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.entityColor.addColorStop(0, 'hsl(330, 70%, ' + 50 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(0.05, 'hsl(330, 40%,' + 55 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(1, 'hsl(330, 20%, ' + 70 * (0.3 + axis.rate) + '%)');
      this.shadowColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.shadowColor.addColorStop(0, 'hsl(330, 40%, ' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(0.05, 'hsl(330, 40%,' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(1, 'hsl(330, 20%, ' + 40 * (0.3 + axis.rate) + '%)');
    },
    getRandomValue : function(min, max){
      return min + (max - min) * Math.random();
    },
    getAxis : function(){
      var rate = this.FOCUS_POSITION / (this.z + this.FOCUS_POSITION),
        x = this.renderer.width / 2 + this.x * rate,
        y = this.renderer.height / 2 - this.y * rate;
      return {rate : rate, x : x, y : y};
    },
    renderCherry : function(context, axis){
      context.beginPath();
      context.moveTo(0, 40);
      context.bezierCurveTo(-60, 20, -10, -60, 0, -20);
      context.bezierCurveTo(10, -60, 60, 20, 0, 40);
      context.fill();
      
      for(var i = -4; i < 4; i++){
        context.beginPath();
        context.moveTo(0, 40);
        context.quadraticCurveTo(i * 12, 10, i * 4, -24 + Math.abs(i) * 2);
        context.stroke();
      }
    },
    render : function(context){
      var axis = this.getAxis();
      
      if(axis.y == this.thresholdY && this.rippleCount < this.MAX_RIPPLE_COUNT){
        context.save();
        context.lineWidth = 2;
        context.strokeStyle = 'hsla(0, 0%, 100%, ' + (this.MAX_RIPPLE_COUNT - this.rippleCount) / this.MAX_RIPPLE_COUNT + ')';
        context.translate(axis.x + this.offsetY * axis.rate * (this.theta <= Math.PI ? -1 : 1), axis.y);
        context.scale(1, 0.3);
        context.beginPath();
        context.arc(0, 0, this.rippleCount / this.MAX_RIPPLE_COUNT * this.RIPPLE_RADIUS * axis.rate, 0, Math.PI * 2, false);
        context.stroke();
        context.restore();
        this.rippleCount++;
      }
      if(axis.y < this.thresholdY || (!this.endTheta || !this.endPhi)){
        if(this.y <= 0){
          this.opacity = Math.min(this.opacity + 0.01, 1);
        }
        context.save();
        context.globalAlpha = this.opacity;
        context.fillStyle = this.shadowColor;
        context.strokeStyle = 'hsl(330, 30%,' + 40 * (0.3 + axis.rate) + '%)';
        context.translate(axis.x, Math.max(axis.y, this.thresholdY + this.thresholdY - axis.y));
        context.rotate(Math.PI - this.theta);
        context.scale(axis.rate * -Math.sin(this.phi), axis.rate);
        context.translate(0, this.offsetY);
        this.renderCherry(context, axis);
        context.restore();
      }
      context.save();
      context.fillStyle = this.entityColor;
      context.strokeStyle = 'hsl(330, 40%,' + 70 * (0.3 + axis.rate) + '%)';
      context.translate(axis.x, axis.y + Math.abs(this.SINK_OFFSET * Math.sin(this.psi) * axis.rate));
      context.rotate(this.theta);
      context.scale(axis.rate * Math.sin(this.phi), axis.rate);
      context.translate(0, this.offsetY);
      this.renderCherry(context, axis);
      context.restore();
      
      if(this.y <= -this.renderer.height / 4){
        if(!this.endTheta){
          for(var theta = Math.PI / 2, end = Math.PI * 3 / 2; theta <= end; theta += Math.PI){
            if(this.theta < theta && this.theta + Math.PI / 200 > theta){
              this.theta = theta;
              this.endTheta = true;
              break;
            }
          }
        }
        if(!this.endPhi){
          for(var phi = Math.PI / 8, end = Math.PI * 7 / 8; phi <= end; phi += Math.PI * 3 / 4){
            if(this.phi < phi && this.phi + Math.PI / 200 > phi){
              this.phi = Math.PI / 8;
              this.endPhi = true;
              break;
            }
          }
        }
      }
      if(!this.endTheta){
        if(axis.y == this.thresholdY){
          this.theta += Math.PI / 200 * ((this.theta < Math.PI / 2 || (this.theta >= Math.PI && this.theta < Math.PI * 3 / 2)) ? 1 : -1);
        }else{
          this.theta += Math.PI / 500;
        }
        this.theta %= Math.PI * 2;
      }
      if(this.endPhi){
        if(this.rippleCount == this.MAX_RIPPLE_COUNT){
          this.psi += this.dpsi;
          this.psi %= Math.PI * 2;
        }
      }else{
        this.phi += Math.PI / ((axis.y == this.thresholdY) ? 200 : 500);
        this.phi %= Math.PI;
      }
      if(this.y <= -this.renderer.height * this.SURFACE_RATE){
        this.x += 2;
        this.y = -this.renderer.height * this.SURFACE_RATE;
      }else{
        this.x += this.vx;
        this.y += this.vy;
      }
      return this.z > -this.FOCUS_POSITION && this.z < this.FAR_LIMIT && this.x < this.renderer.width * 1.5;
    }
  };
  jq_151(function(){
    RENDERER.init();
  });
</script>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <!--
    <div class="alice">
      <img src="/images/alice-shake.gif" alt="">
    </div>

    
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
    -->
  </div>
  <script
      defer="defer"
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"
      integrity="sha512-1dalHDkG9EtcOmCnoCjiwQ/HEB5SDNqw8d4G2MKoNwjiwMNeBAkudsBCmSlMnXdsH8Bm0mOd3tl/6nL5y0bMaQ=="
      crossorigin="anonymous"
    ></script>
  <script defer="defer" src="/js/gsap/DrawSVGPlugin.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomEase.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomBounce.min.js"></script>
  <script defer="defer" src="/js/gsap/SplitText.min.js"></script>
  <script defer="defer" src="/js/gsap/logo-run.js"></script>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">细品sec2023安卓赛题
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2023-08-31 08:19:57">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2023-08-31T08:19:57+08:00">2023-08-31</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>64k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>59 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">oacia</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="/background_picture/1_mary.jpg"></li>
          <li class="item" data-background-image="/background_picture/2_xingye.webp"></li>
          <li class="item" data-background-image="/background_picture/3_xiaoxia.webp"></li>
          <li class="item" data-background-image="/background_picture/4_alice.webp"></li>
          <li class="item" data-background-image="/background_picture/5_mutsuki.jpg"></li>
          <li class="item" data-background-image="/background_picture/6_arona_plana.webp"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb">
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://oacia.dev/sec-2023/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="oacia">
    <meta itemprop="description" content="DEVIL or SWEET, 月遇从云 花遇和风">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="oaciaのBbBlog~">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="前言"><a class="anchor" href="#前言">#</a> 前言</h1>
<blockquote>
<p>在今年三月份的时候，我参加了腾讯游戏安全技术竞赛，到现在差不多快过去半年了，当时做这道安卓初赛题目时，也是卡在开头就毫无头绪了，而后看到看雪上的三位大佬<span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS91c2VyLWhvbWUtODg4NTU4Lmh0bQ=="> |_|sher 师傅</span>，<span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS91c2VyLWhvbWUtODMxNTI2Lmh0bQ==">juice4fun 师傅</span>和<span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS91c2VyLWhvbWUtODg3Njc2Lmh0bQ=="> fallw1nd 师傅</span>都分享了他们做这道题目时的解题过程，也是让我重拾了做出这道安卓初赛题的信心，因为需要分心在学习和其他事情上，所以从三月份到七月份也是陆陆续续复现了五个月，一路上走走停停</p>
<p>终于在八月份，我难能可贵的获得了整整一个月的充裕时间，这也让我可以好好去钻研这道对我来说难度极大的安卓题目了，解题的过程中基本上把我能想到的安卓逆向工具用了个遍，每当我在解题的过程中遇到瓶颈时，我总会把这三位大佬的 writeup 打开来反复观摩研究思考为什么要这样做，怎么做效果会更好</p>
<p>直到注册机写完之后纵观整个解题过程，真的是学到了很多</p>
<p>il2CppDumper 是分析 unity 游戏的基础，能有好的开头全靠站在巨人的肩膀上</p>
<p>运行时解密 so 文件，让我首次尝试去手工修复 dump 下来的 so</p>
<p>libsec2023.so 中的反调试让我学会使用在安卓手机中断下硬件断点的工具 rwProcMem33, 也开始第一次编译安卓内核，经历了两三个不眠之夜</p>
<p>第一眼见到 CSEL-BR 和 CSET-BR 结构的花指令让我毫无头绪，也让我开始思考 frida-stalker 与 unicorn 的区别所在，最终我选择使用 frida-stalker 辅助分析，IDApython 批量去花的方法，效果很好</p>
<p>BlackObfuscator 混淆让我想起了被 ollvm 的控制流平坦化支配的恐惧，一筹莫展之际，这个月最新的工具 Jeb5.1 竟然能完美去除 BlackObfuscator 混淆，着实让我惊喜不已</p>
<p>在探索 vm 的过程，我也慢慢的摸索出了 vm 题型的解题方法，或许未来遇到 vm 我也能游刃有余了</p>
<p>前言写的有点长了，也算是我在这半年对于这道安卓题的感悟吧哈哈，虽然是安卓方向初赛题，但是对我整个安卓逆向的学习过程意义非凡，这篇文章我也写的尽可能的详细，前后的思维也尽量避免跳跃，每一步的操作基本上都是有据可依的，为之后也同样想要复现这道赛题的朋友尽一点绵薄之力</p>
</blockquote>
<p>题目可以在腾讯游戏安全竞赛官网下载 <span class="exturl" data-url="aHR0cHM6Ly9nc2xhYi5xcS5jb20vaHRtbC9jb21wZXRpdGlvbi8yMDIzL2RvYy8lRTUlQUUlODklRTUlOEQlOTMlRTUlQUUlQTIlRTYlODglQjclRTclQUIlQUYlRTUlQUUlODklRTUlODUlQTgtJUU1JTg4JTlEJUU4JUI1JTlCJUU5JUEyJTk4JUU3JTlCJUFFLnppcA==">下载链接</span></p>
<p>我在 github 里面也存了一份上去 <span class="exturl" data-url="aHR0cHM6Ly9vYWNpYS5naXRodWIuaW8vc2VjLTIwMjMvJUU1JUFFJTg5JUU1JThEJTkzJUU1JUFFJUEyJUU2JTg4JUI3JUU3JUFCJUFGJUU1JUFFJTg5JUU1JTg1JUE4LSVFNSU4OCU5RCVFOCVCNSU5QiVFOSVBMiU5OCVFNyU5QiVBRS56aXA=">备用下载链接</span></p>
<h1 id="初探apk"><a class="anchor" href="#初探apk">#</a> 初探 apk</h1>
<p>首先我们通过 jadx 反编译 <code>mouse_pre.aligned.signed.apk</code> , 通过查看 <code>AndroidManifest.xml</code>  可以知道下列关键信息</p>
<ul>
<li>包名:  <code>com.com.sec2023.rocketmouse.mouse</code></li>
<li>入口:  <code>com.unity3d.player.UnityPlayerActivity</code></li>
</ul>
<p>解压该 apk, 通过查看 <code>lib</code>  文件夹内的内容，我们发现了 <code>libil2cpp.so</code></p>
<p><img data-src="/sec-2023/image-20230407124030376.png" alt="image-20230407124030376" style="aspect-ratio:1034 / 254;"></p>
<h1 id="尝试使用il2cppdumper获取符号信息"><a class="anchor" href="#尝试使用il2cppdumper获取符号信息">#</a> 尝试使用 Il2CppDumper 获取符号信息</h1>
<p>我们使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BlcmZhcmUvSWwyQ3BwRHVtcGVy"> Il2CppDumper</span> 尝试解密 <code>global-metadata.dat</code> , 但是却失败了</p>
<p><img data-src="/sec-2023/image-20230407124010267.png" alt="image-20230407124010267" style="aspect-ratio:1591 / 640;"></p>
<p>看了一下 <code>global-metadata.dat</code>  是没有加密的</p>
<p><img data-src="/sec-2023/image-20230407160715829.png" alt="image-20230407160715829" style="aspect-ratio:1920 / 1080;"></p>
<p>接下来我们用 ida 反编译 <code>libil2cpp.so</code> , 发现被加密了</p>
<p><img data-src="/sec-2023/image-20230407142822706.png" alt="image-20230407142822706" style="aspect-ratio:1920 / 1080;"></p>
<h1 id="dump解密后的libil2cppso"><a class="anchor" href="#dump解密后的libil2cppso">#</a> dump 解密后的 <code>libil2cpp.so</code></h1>
<p>接下来我准备用 frida 来把解密后的 <code>libil2cpp.so</code>  从内存中 dump 下来</p>
<p>但是当我用 frida 将代码注入进去后，apk 提示 <code>hack detect</code> , 然后就退出了</p>
<p>之后我不用 frida 注入这个 apk, 但是后台依旧运行着 frida-server,apk 依然弹出 <code>hack detect</code>  后退出</p>
<p>通过这一点我大致可以判断它的检测方式有这两种可能</p>
<ul>
<li>检测运行的程序名称有没有 <code>frida-server</code></li>
<li>检测 frida-server 的端口</li>
</ul>
<p>我们一个一个去验证一下</p>
<p>首先我们把后台运行的 frida-server 名称改成 <code>fs</code>  试试</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>blueline:/data/local/tmp <span class="token comment"># ./fs</span></pre></td></tr></table></figure><p>修改完后依旧弹出 <code>hack detect</code></p>
<p>那我们再去试一试修改 frida-server 的端口</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>blueline:/data/local/tmp <span class="token comment"># ./fs -l 0.0.0.0:1234</span></pre></td></tr></table></figure><p>端口修改之后用 frida 注入也不弹窗了</p>
<p>现在我们可以用 frida 把解密后的 <code>libil2cpp.so</code> dump 下来，脚本如下</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">dump_so</span><span class="token punctuation">(</span><span class="token parameter">so_name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">var</span> currentApplication <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"android.app.ActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">currentApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">var</span> dir <span class="token operator">=</span> currentApplication<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFilesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">var</span> libso <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span>so_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[name]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[base]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[size]:"</span><span class="token punctuation">,</span> <span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[path]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">var</span> file_path <span class="token operator">=</span> dir <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> libso<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> libso<span class="token punctuation">.</span>base <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> <span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".so"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">var</span> file_handle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        </pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>file_handle <span class="token operator">&amp;&amp;</span> file_handle <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            Memory<span class="token punctuation">.</span><span class="token function">protect</span><span class="token punctuation">(</span><span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token string">'rwx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token comment">// 如果报错为 Error: access violation accessing, 那么可以尝试添加下面的这一行代码，libso.base 加上的值是通过 address (access violation accessing)-address (base) 计算出来的</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">//Memory.protect(ptr(libso.base.add(0x13b7000)), libso.size-0x13b7000, 'rwx');</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">var</span> libso_buffer <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            file_handle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>libso_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            file_handle<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            file_handle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[dump]:"</span><span class="token punctuation">,</span> file_path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>rpc<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token literal-property property">dump_so</span><span class="token operator">:</span> dump_so</pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>在使用 frida 运行脚本之前需要注意去做一下<strong>端口转发</strong></p>
<figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>adb forward tcp:1234 tcp:1234</pre></td></tr></table></figure><p>随后进行 frida 注入</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>frida <span class="token parameter variable">-H</span> <span class="token number">127.0</span>.0.1:1234 <span class="token parameter variable">-l</span> <span class="token string">"D:<span class="token entity" title="\f">\f</span>rida\sec2023\global-metadata_dump.js"</span> <span class="token parameter variable">-f</span> <span class="token string">"com.com.sec2023.rocketmouse.mouse"</span></pre></td></tr></table></figure><p><img data-src="/sec-2023/image-20230407160451904.png" alt="image-20230407160451904" style="aspect-ratio:1571 / 498;"></p>
<h1 id="再次使用il2cppdumper获取符号信息"><a class="anchor" href="#再次使用il2cppdumper获取符号信息">#</a> 再次使用 Il2CppDumper 获取符号信息</h1>
<p>直接把 dump 下来的 <code>libil2cpp.so</code>  放到 Il2CppDumper 中，成功获取符号</p>
<p><img data-src="/sec-2023/image-20230407230411862.png" alt="image-20230407230411862" style="aspect-ratio:1920 / 497;"></p>
<h1 id="修复dump下来的so"><a class="anchor" href="#修复dump下来的so">#</a> 修复 dump 下来的 so</h1>
<p>对于 dump 下来的 so 文件，所有的段 (segment) 和节 (section) 的偏移都是<strong>在虚拟空间中的偏移</strong> (即映射到进程空间的虚拟地址偏移), 但静态分析工具分析 so 时所使用的偏移仍然为<strong>在实际文件中的偏移</strong> (即相对于文件开头的字节偏移量), 错误的偏移导致静态分析工具如 IDA 等无法分析 dump 下来的 so</p>
<p><strong>所以我们需要将 <code>segment</code>  和 <code>section</code>  在实际文件中的偏移替换为在虚拟空间中的偏移，这些偏移由 <code>program header table</code>  和 <code>secion header table</code>  内的成员指出</strong></p>
<p>我们将 <code>libil2cpp.so</code>  和 <code>libil2cpp.so_0x712a997000_0x13cc000.so</code>  一并拖入 <code>010 editor</code>  中，两个文件相互对比进行修复</p>
<p>在 <code>010editor</code>  中复制一个成员的值到另一个成员中，只需要在软件界面的 <code>Template Results</code>  中单击想要复制的值按下 <code>Ctrl</code> + <code>Shift</code> + <code>C</code> , 然后单击需要替换的值，按下 <code>Ctrl</code> + <code>Shift</code> + <code>V</code>  即可完成替换</p>
<h2 id="修正-段segment-的偏移"><a class="anchor" href="#修正-段segment-的偏移">#</a> 修正 段 (segment) 的偏移</h2>
<blockquote>
<p>段 (segment) 的位置和大小由程序头表 (Program Header Table) 中的这四个成员决定</p>
<table>
<thead>
<tr>
<th>成员名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>p_offset_FROM_FILE_BEGIN</code></td>
<td>在实际文件中的偏移</td>
</tr>
<tr>
<td><code>p_vaddr_VIRTUAL_ADDRESS</code></td>
<td>在虚拟空间中的偏移</td>
</tr>
<tr>
<td><code>p_filesz_SEGMENT_FILE_LENGTH</code></td>
<td>在实际文件中的大小</td>
</tr>
<tr>
<td><code>p_memsz_SEGMENT_RAM_LENGTH</code></td>
<td>在虚拟空间中的大小</td>
</tr>
</tbody>
</table>
</blockquote>
<p>在 <code>libil2cpp.so_0x712a997000_0x13cc000.so</code>  中我们将 <code>program_header_table</code>  中每一个 <code>element</code>  的 <code>p_vaddr_VIRTUAL_ADDRESS</code>  的值复制到 <code>p_offset_FROM_FILE_BEGIN</code> , <code>p_memsz_SEGMENT_RAM_LENGTH</code>  的值复制到 <code>p_filesz_SEGMENT_FILE_LENGTH</code></p>
<h2 id="修正-节头表secion-header-table-的偏移"><a class="anchor" href="#修正-节头表secion-header-table-的偏移">#</a> 修正 节头表 (secion header table) 的偏移</h2>
<blockquote>
<p>节头表 (secion header table) 的位置在<strong>最后一个段 (segment) 之后</strong>，我们可以从 ELF 文件的 Execution View 直观看出</p>
<p><img data-src="/sec-2023/image-20230901121900113.png" alt="image-20230901121900113" style="aspect-ratio:447 / 577;"></p>
</blockquote>
<p>由下图所示， <code>libil2cpp.so_0x712a997000_0x13cc000.so</code>  中 <code>section_header_table</code>  在实际文件中的偏移为 <code>0x11AB778</code> , 我们需要将其修改为在虚拟空间中的偏移，这个值为 <code>0x13CB778</code> , 计算过程如下，此处所涉及计算的成员的值是在 <code>program_header_table</code>  的最后一个 <code>element</code> , 即 <code>program_table_entry64_program_table_element[10]</code></p>
<ul>
<li><code>section_header_table</code>  在虚拟空间中的偏移: 0x13CB778 = 0x00000000013BC000 + 0xF778 =  <code>p_vaddr_VIRTUAL_ADDRESS</code> + <code>p_memsz_SEGMENT_RAM_LENGTH</code></li>
</ul>
<p><img data-src="/sec-2023/image-20230901122457467.png" alt="image-20230901122457467" style="aspect-ratio:1920 / 1051;"></p>
<div class="note info">
<p>Section Header Table 和 Program Header Table 并不是一定要位于文件开头和结尾的，其位置由 <code>ELF Header</code>  指出</p>
</div>
<p>决定 <code>section_header_table</code>  起始地址的成员为 <code>elf_header-&gt;e_shoff_SECTION_HEADER_OFFSET_IN_FILE</code> , 位置如下图所示，在修改完成后，按下 <code>F5</code>  重新运行模板 <code>ELF.bt</code></p>
<p><img data-src="/sec-2023/image-20230505192823591.png" alt="image-20230505192823591" style="aspect-ratio:982 / 899;"></p>
<h2 id="修补section的内容"><a class="anchor" href="#修补section的内容">#</a> 修补 section 的内容</h2>
<blockquote>
<p>在我们修正 节头表 (secion header table) 的偏移后，节头表所在的区域是没有内容的，如下图所示，所以需要从 <code>libil2cpp.so</code>  中复制节 (section) 的内容到 dump 下来的 so 中</p>
<p><img data-src="/sec-2023/image-20230901122928576.png" alt="image-20230901122928576" style="aspect-ratio:1586 / 653;"></p>
</blockquote>
<p>我们在 <code>libil2cpp.so</code>  点击 <code>struct section_header_table</code>  并按下 <code>Ctrl</code> + <code>Shift</code> + <code>C</code> , 然后回到 <code>libil2cpp.so_0x712a997000_0x13cc000.so</code>  中，选中 <code>section_header_table</code>  然后按下 <code>Ctrl</code> + <code>Shift</code> + <code>V</code> , 按下 <code>F5</code>  重新运行模板 <code>ELF.bt</code></p>
<p><img data-src="/sec-2023/image-20230505193356013.png" alt="image-20230505193356013" style="aspect-ratio:959 / 1023;"></p>
<h2 id="恢复节section的名称"><a class="anchor" href="#恢复节section的名称">#</a> 恢复节 (section) 的名称</h2>
<p>可以发现修补了节 (section) 的内容之后，section 的名称依旧是乱码</p>
<p>这是什么原因呢？</p>
<div class="note info">
<p><code>ELF</code>  文件中的每个 <code>section</code>  都是有名字的，比如 <code>.data</code> 、 <code>.text</code> 、 <code>.rodata</code> ，每个名字都是一个字符串，既然是字符串就需要一个字符串池来保存，而这个字符串池也是一个 <code>section</code> ，或者说准备一个 <code>section</code>  用来维护一个字符串池，这个字符串池保存了其他 section 以及它自己的名字。这个特殊的 section 叫做 <code>.shstrtab</code> ，所有 <code>section</code>  的头部是连续存放在一起的，类似一个数组， <code>e_shstrndx</code>  变量是 <code>.shstrtab</code>  在这个数组中的下标。</p>
</div>
<p>首先我们要明白 section 的名称是如何通过索引找到的，在 <code>libil2cpp.so_0x712a997000_0x13cc000.so</code>  中，找到 <code>elf_header-&gt;e_shtrndx_STRING_TABLE_INDEX</code> , 这个的值为 26 (0x1A), 说明了 <code>section_header_table-&gt;section_table_element[26]</code>  存储了所有 section 的名称</p>
<p><img data-src="/sec-2023/image-20230505193659902.png" alt="image-20230505193659902" style="aspect-ratio:976 / 892;"></p>
<p><code>section_header_table-&gt;section_table_element[26]</code>  中 <code>s_offset</code>  的值决定了 section 的名称将从 <code>1199370h</code>  去索引</p>
<p><img data-src="/sec-2023/image-20230505195047080.png" alt="image-20230505195047080" style="aspect-ratio:954 / 1080;"></p>
<p>我们可以在 dump 前后的 <code>libil2cpp.so</code>  都跳转到这个地址去看看，在 <code>010editor</code>  中进行地址跳转只需右键该值选择 <code>Goto Address</code>  即可</p>
<p><img data-src="/sec-2023/image-20230901124209545.png" alt="image-20230901124209545" style="aspect-ratio:1273 / 495;">section 的所有名称都在这个地方</p>
<p><img data-src="/sec-2023/image-20230505195256088.png" alt="image-20230505195256088" style="aspect-ratio:1920 / 1080;"></p>
<p>之后我们要将 <code>section</code>  的符号名称从原来的 so 复制到 dump 下来的 so 里面，位置就是我们之前分析出来的 <code>section_table_element[26]</code>  中 <code>s_offset</code>  所指向的物理内存地址，即选中 <code>libil2cpp.so</code>  从 <code>0x1199370h</code>  到 <code>0x1199470h</code>  按下 <code>Ctrl</code> + <code>Shift</code> + <code>C</code> , 然后将光标移动到 <code>libil2cpp.so_0x712a997000_0x13cc000.so</code>  的 <code>119A370h</code>  处，按下 <code>Ctrl</code> + <code>Shift</code> + <code>V</code></p>
<h2 id="修正-节section-的偏移"><a class="anchor" href="#修正-节section-的偏移">#</a> 修正 节 (section) 的偏移</h2>
<blockquote>
<p>节 (section) 的位置和大小由节头表 (secion_header_table) 中这两个成员决定</p>
<table>
<thead>
<tr>
<th>成员名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>s_addr</td>
<td>如果此 section 需要映射到进程空间，此成员指定映射的起始地址；如不需映射，此值为 0</td>
</tr>
<tr>
<td>s_offset</td>
<td>此 section 相对于文件开头的字节偏移量。如果 section 类型为  <code>SHT_NOBITS</code> , 表明该 section 在文件中不占空间，这时 sh_offset 没什么用</td>
</tr>
</tbody>
</table>
</blockquote>
<p>修正 节 (section) 的偏移有两条规则</p>
<ul>
<li>如果 s_addr 为 0, 无需修改 s_offset</li>
<li>如果 s_addr 不为 0, 则将 s_addr 的值复制给 s_offset</li>
</ul>
<p>修正完成后，按下 <code>F5</code>  重新运行模板 <code>ELF.bt</code> , 可以发现 section 的名称已经恢复，同时也有了 <code>dynamic_symbol_table</code></p>
<p><img data-src="/sec-2023/image-20230901125853006.png" alt="image-20230901125853006" style="aspect-ratio:1237 / 695;"></p>
<h1 id="在ida中恢复符号"><a class="anchor" href="#在ida中恢复符号">#</a> 在 IDA 中恢复符号</h1>
<p>然后，我们将 <code>libil2cpp.so_0x712a997000_0x13cc000.so</code>  拖入 <code>IDA</code>  中进行分析，待分析完成后，点击如图所示的选项重新定位基址为 <code>0x712a997000</code> , 这样可以分析出更多的符号</p>
<p><img data-src="/sec-2023/image-20230505144017295.png" alt="image-20230505144017295" style="aspect-ratio:696 / 654;"></p>
<p>之后，我们点击 <code>File-&gt;Script file...</code>  运行 <code>il2cppdumper</code>  中的 <code>ida_with_struct_py3.py</code> , 需要注意的这个脚本需要运行两次，第一次选择 <code>script.json</code> , 第二次选择 <code>il2cpp.h</code></p>
<p>处理之后的效果如下</p>
<p><img data-src="/sec-2023/image-20230506180743547.png" alt="image-20230506180743547" style="aspect-ratio:1920 / 1080;"></p>
<h1 id="寻找ok按钮调用的函数"><a class="anchor" href="#寻找ok按钮调用的函数">#</a> 寻找 OK 按钮调用的函数</h1>
<p>接下来需要知道这个 <code>OK</code>  按钮调用的函数</p>
<p><img data-src="/sec-2023/screenshot-16808551676034.png" alt="screenshot" style="aspect-ratio:1920 / 1200;"></p>
<p>我们可以使用这个工具<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0lJSUltbW15eXkvZnJpZGEtaWwyY3BwRHVtcGVy"> frida-il2cppDumper</span>, 用法就直接用 frida 注入 <code>_agent.js</code>  就可以了</p>
<figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>frida <span class="token operator">-</span>H 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:1234 <span class="token operator">-</span>l <span class="token string">"D:\frida\frida-il2cppDumper-main\_agent.js"</span> <span class="token operator">-</span>f <span class="token string">"com.com.sec2023.rocketmouse.mouse"</span></pre></td></tr></table></figure><p>当我们进入该 apk 之后，下列函数被调用</p>
<figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>method  call</pre></td></tr><tr><td data-num="2"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:SmallKeyboard</pre></td></tr><tr><td data-num="3"></td><td><pre> methodPointer offset in IDA:466300</pre></td></tr><tr><td data-num="4"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="9"></td><td><pre> method  call</pre></td></tr><tr><td data-num="10"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:iII1i</pre></td></tr><tr><td data-num="11"></td><td><pre> methodPointer offset in IDA:4663A8</pre></td></tr><tr><td data-num="12"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="17"></td><td><pre> method  call</pre></td></tr><tr><td data-num="18"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:iII1i</pre></td></tr><tr><td data-num="19"></td><td><pre> methodPointer offset in IDA:4663A8</pre></td></tr><tr><td data-num="20"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="25"></td><td><pre> method  call</pre></td></tr><tr><td data-num="26"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:iII1i</pre></td></tr><tr><td data-num="27"></td><td><pre> methodPointer offset in IDA:4663A8</pre></td></tr><tr><td data-num="28"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="33"></td><td><pre> method  call</pre></td></tr><tr><td data-num="34"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:iII1i</pre></td></tr><tr><td data-num="35"></td><td><pre> methodPointer offset in IDA:4663A8</pre></td></tr><tr><td data-num="36"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="41"></td><td><pre> method  call</pre></td></tr><tr><td data-num="42"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:iII1i</pre></td></tr><tr><td data-num="43"></td><td><pre> methodPointer offset in IDA:4663A8</pre></td></tr><tr><td data-num="44"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="49"></td><td><pre> method  call</pre></td></tr><tr><td data-num="50"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:iII1i</pre></td></tr><tr><td data-num="51"></td><td><pre> methodPointer offset in IDA:4663A8</pre></td></tr><tr><td data-num="52"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="57"></td><td><pre> method  call</pre></td></tr><tr><td data-num="58"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:iII1i</pre></td></tr><tr><td data-num="59"></td><td><pre> methodPointer offset in IDA:4663A8</pre></td></tr><tr><td data-num="60"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="65"></td><td><pre> method  call</pre></td></tr><tr><td data-num="66"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:iII1i</pre></td></tr><tr><td data-num="67"></td><td><pre> methodPointer offset in IDA:4663A8</pre></td></tr><tr><td data-num="68"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="73"></td><td><pre> method  call</pre></td></tr><tr><td data-num="74"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:iII1i</pre></td></tr><tr><td data-num="75"></td><td><pre> methodPointer offset in IDA:4663A8</pre></td></tr><tr><td data-num="76"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="81"></td><td><pre> method  call</pre></td></tr><tr><td data-num="82"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:iII1i</pre></td></tr><tr><td data-num="83"></td><td><pre> methodPointer offset in IDA:4663A8</pre></td></tr><tr><td data-num="84"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="89"></td><td><pre> method  call</pre></td></tr><tr><td data-num="90"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:iII1i</pre></td></tr><tr><td data-num="91"></td><td><pre> methodPointer offset in IDA:4663A8</pre></td></tr><tr><td data-num="92"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="95"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="97"></td><td><pre> method  call</pre></td></tr><tr><td data-num="98"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:iII1i</pre></td></tr><tr><td data-num="99"></td><td><pre> methodPointer offset in IDA:4663A8</pre></td></tr><tr><td data-num="100"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="105"></td><td><pre> method  call</pre></td></tr><tr><td data-num="106"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:SmallKeyboard</pre></td></tr><tr><td data-num="107"></td><td><pre> methodPointer offset in IDA:46618C</pre></td></tr><tr><td data-num="108"></td><td><pre> private Void <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="109"></td><td><pre></pre></td></tr><tr><td data-num="110"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="113"></td><td><pre> method  call</pre></td></tr><tr><td data-num="114"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:SmallKeyboard</pre></td></tr><tr><td data-num="115"></td><td><pre> methodPointer offset in IDA:465E90</pre></td></tr><tr><td data-num="116"></td><td><pre> private Void oO0oOo0<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="117"></td><td><pre></pre></td></tr><tr><td data-num="118"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr></table></figure><p>我们去看一下最后调用的这个函数 <code>oO0oOo0</code> , 进入 <code>IDA</code>  去进行分析，很明显是生成 TOKEN 的地方</p>
<p><img data-src="/sec-2023/image-20230506185306047.png" alt="image-20230506185306047" style="aspect-ratio:1916 / 886;"></p>
<p>当我们点击小键盘上的 OK 按钮后，下列函数被调用，由于调用的函数太多，我这里仅仅从首次调用的函数开始，截取了部分输出作为示例</p>
<figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre>method  call</pre></td></tr><tr><td data-num="2"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:&lt;>c__DisplayClass14_0</pre></td></tr><tr><td data-num="3"></td><td><pre> methodPointer offset in IDA:4663B0</pre></td></tr><tr><td data-num="4"></td><td><pre> internal Void &lt;<span class="token function">Start</span>>b__0<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="9"></td><td><pre> method  call</pre></td></tr><tr><td data-num="10"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:SmallKeyboard</pre></td></tr><tr><td data-num="11"></td><td><pre> methodPointer offset in IDA:465FDC</pre></td></tr><tr><td data-num="12"></td><td><pre> private Void iI1Ii<span class="token punctuation">(</span>GameObject go<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="17"></td><td><pre> method  call</pre></td></tr><tr><td data-num="18"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:SmallKeyboard</pre></td></tr><tr><td data-num="19"></td><td><pre> methodPointer offset in IDA:465880</pre></td></tr><tr><td data-num="20"></td><td><pre> private Void iI1Ii<span class="token punctuation">(</span>iII1i _info<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="25"></td><td><pre> method  call</pre></td></tr><tr><td data-num="26"></td><td><pre> nameSpaze: <span class="token keyword">class</span>:SmallKeyboard</pre></td></tr><tr><td data-num="27"></td><td><pre> methodPointer offset in IDA:465AB0</pre></td></tr><tr><td data-num="28"></td><td><pre> private Void iI1Ii<span class="token punctuation">(</span>UInt64 i1I<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="33"></td><td><pre> method  call</pre></td></tr><tr><td data-num="34"></td><td><pre> nameSpaze:OO0OoOOo <span class="token keyword">class</span>:Oo0</pre></td></tr><tr><td data-num="35"></td><td><pre> methodPointer offset in IDA:4660E8</pre></td></tr><tr><td data-num="36"></td><td><pre> public Void <span class="token punctuation">.</span>ctor<span class="token punctuation">(</span>UInt16<span class="token punctuation">[</span><span class="token punctuation">]</span> OoOOO00<span class="token punctuation">,</span> Int32 oOOO0O0O<span class="token punctuation">,</span> UInt32<span class="token punctuation">[</span><span class="token punctuation">]</span> OOoOO0<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="41"></td><td><pre> method  call</pre></td></tr><tr><td data-num="42"></td><td><pre> nameSpaze:OO0OoOOo <span class="token keyword">class</span>:Oo0</pre></td></tr><tr><td data-num="43"></td><td><pre> methodPointer offset in IDA:46A55C</pre></td></tr><tr><td data-num="44"></td><td><pre> private Void O000O000000o<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="49"></td><td><pre> method  call</pre></td></tr><tr><td data-num="50"></td><td><pre> nameSpaze:OO0OoOOo <span class="token keyword">class</span>:oO0OoOOo</pre></td></tr><tr><td data-num="51"></td><td><pre> methodPointer offset in IDA:46A4D8</pre></td></tr><tr><td data-num="52"></td><td><pre> private Void <span class="token punctuation">.</span>cctor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="57"></td><td><pre> method  call</pre></td></tr><tr><td data-num="58"></td><td><pre> nameSpaze:OO0OoOOo <span class="token keyword">class</span>:Oo0</pre></td></tr><tr><td data-num="59"></td><td><pre> methodPointer offset in IDA:46AD44</pre></td></tr><tr><td data-num="60"></td><td><pre> private Void oOOoO0o0<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="65"></td><td><pre> method  call</pre></td></tr><tr><td data-num="66"></td><td><pre> nameSpaze:OO0OoOOo <span class="token keyword">class</span>:Oo0</pre></td></tr><tr><td data-num="67"></td><td><pre> methodPointer offset in IDA:46B578</pre></td></tr><tr><td data-num="68"></td><td><pre> private Void O00O00000o<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre> method  <span class="token keyword">end</span></pre></td></tr></table></figure><p><code>SmallKeyboard</code>  类被调用了很多次，我们可以去 <code>dump.cs</code>  里面搜索一下，此处定义了 <code>KeyType</code>  不同的值对应的含义，那么这个 <code>EnterKey</code>  就是 <code>OK</code>  按钮了</p>
<p><img data-src="/sec-2023/image-20230507183715015.png" alt="image-20230507183715015" style="aspect-ratio:1920 / 986;"></p>
<p>回到 <code>IDA</code> , 我们再去搜索一下 <code>SmallKeyboard</code> , 找到 <code>SmallKeyboard__iI1Ii(SmallKeyboard_o *this, SmallKeyboard_iII1i_o *info, const MethodInfo *method)</code>  这个函数，这是与 <code>KeyType</code>  有关的函数，显而易见，我们需要重点分析的是 <code>KeyType == 2</code>  的情况</p>
<p><img data-src="/sec-2023/image-20230808172326007.png" alt="image-20230808172326007" style="aspect-ratio:1834 / 667;"></p>
<p>对于这行代码，我的猜测是 <code>v13</code>  存储了我输入的值，我们可以使用 <code>frida</code>  去 hook <code>System_Convert__ToUInt64_486054767044</code>  的返回值来验证我们的猜想</p>
<p><img data-src="/sec-2023/image-20230808172408181.png" alt="image-20230808172408181" style="aspect-ratio:1207 / 264;"></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_native</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 程序入口</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 获取模块</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libil2cpp.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 转为函数地址</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">var</span> addr<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"0x85b9c4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 获取函数入口</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">var</span> func <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] hook '</span><span class="token operator">+</span>func<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 函数 hook 钩子附加</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    </pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     </pre></td></tr><tr><td data-num="20"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hook success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"retvalue is :"</span><span class="token punctuation">,</span> retval<span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'method onleave'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token function">setTimeout</span><span class="token punctuation">(</span>hook_native<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>当我输入 <code>123456</code> , 并点击 <code>OK</code>  按钮后，frida 的回显如下，可以印证我们的猜测是正确的，v13 是我们输入的数字</p>
<p><img data-src="/sec-2023/image-20230507190652325.png" alt="image-20230507190652325" style="aspect-ratio:984 / 169;"></p>
<p><code>v13</code>  作为参数传入了 <code>SmallKeyboard__iI1Ii_486050613936</code>  内，那么这应该就是我们要寻找的加密逻辑</p>
<p>经过两个 B 跳转后，我们来到了这里</p>
<p><img data-src="/sec-2023/image-20230809155725055.png" alt="image-20230809155725055" style="aspect-ratio:861 / 137;"></p>
<p>这段汇编很有意思，我们去分析一下， <code>off_712BD51FF0</code>  存储的是导入函数 <code>g_sec2023_p_array</code>  的地址，而 <code>g_sec2023_p_array</code>  的函数定义在 <code>libsec2023.so</code>  中， <code>BR</code>  指令是无条件寄存器跳转，那么这四行 arm 汇编的意义就是调用 <code>g_sec2023_p_array</code>  偏移 <code>0x48</code>  处的函数</p>
<p>来到 <code>libsec2023.so</code>  我们即可找到相对应的导出函数 <code>sub_31164</code></p>
<p><img data-src="/sec-2023/image-20230809160214205.png" alt="image-20230809160214205" style="aspect-ratio:1130 / 222;"></p>
<p>那么显而易见，关键的逻辑就在 <code>libsec2023.so</code>  中的 <code>sub_31164</code>  了</p>
<h1 id="进入libsec2023so分析"><a class="anchor" href="#进入libsec2023so分析">#</a> 进入 libsec2023.so 分析</h1>
<p>对 <code>libsec2023.so</code>  的 <code>sub_31164</code> hook 一下</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_sub_31164</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 程序入口</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 获取模块</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libsec2023.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 转为函数地址</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">var</span> addr<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"0x31164"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 获取函数入口</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">var</span> func <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] hook '</span><span class="token operator">+</span>func<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 函数 hook 钩子附加</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    </pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     </pre></td></tr><tr><td data-num="20"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hook success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"retvalue is :"</span><span class="token punctuation">,</span> retval<span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'method onleave'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>rpc<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token literal-property property">hook_sub_35404</span><span class="token operator">:</span> hook_sub_35404</pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>但是当我注入将这段 frida 代码注入到 <code>libsec2023.so</code>  后，程序在短暂的延迟后显示 hack detect 后退出了</p>
<p>我们可以使用 <code>frida Stalker</code>  来查看这个 <code>so</code>  调用函数的过程</p>
<blockquote>
<p>为了使用上的方便，我写了一个 IDA 插件来实现下面的过程，插件地址:<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lhL3N0YWxrZXJfdHJhY2Vfc28=">https://github.com/oacia/stalker_trace_so</span>，这应该算是我第一次造轮子吧：)</p>
</blockquote>
<p>首先使用如下 <code>idaPython</code>  脚本打印出 <code>libsec2023.so</code>  的所有函数的地址和名称</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> idautils</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> idc</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>func_addr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>func_name <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">for</span> i <span class="token keyword">in</span> idautils<span class="token punctuation">.</span>Functions<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    func_addr<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    func_name<span class="token punctuation">.</span>append<span class="token punctuation">(</span>idc<span class="token punctuation">.</span>get_func_name<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">for</span> i <span class="token keyword">in</span> func_addr<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">, "</span></span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">for</span> i <span class="token keyword">in</span> func_name<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">\", "</span></span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>将上面 IDApython 所打印出的内容填入下面 <code>frida</code>  代码的变量 <code>func_addr</code>  和 <code>func_name</code>  中</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">var</span> func_addr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">var</span> func_name <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_dlopen</span><span class="token punctuation">(</span>soName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"android_dlopen_ext"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token keyword">var</span> pathptr <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pathptr <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> pathptr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                    <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>pathptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>soName<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                        <span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                    <span class="token comment">//hook_sub_3530C();</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                    <span class="token keyword">var</span> times <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libsec2023.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                    <span class="token keyword">this</span><span class="token punctuation">.</span>pid <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"start Stalker!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                    Stalker<span class="token punctuation">.</span><span class="token function">follow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pid<span class="token punctuation">,</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                        <span class="token literal-property property">events</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                            <span class="token literal-property property">call</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                            <span class="token literal-property property">ret</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                            <span class="token literal-property property">exec</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                            <span class="token literal-property property">block</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                            <span class="token literal-property property">compile</span><span class="token operator">:</span><span class="token boolean">false</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                        <span class="token function-variable function">onReceive</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">events</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                        <span class="token function-variable function">transform</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">iterator</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                            <span class="token keyword">var</span> instruction <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                            <span class="token keyword">do</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                                <span class="token keyword">if</span> <span class="token punctuation">(</span>func_addr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>instruction<span class="token punctuation">.</span>address <span class="token operator">-</span> module<span class="token punctuation">.</span>base<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"call"</span> <span class="token operator">+</span> times<span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> func_name<span class="token punctuation">[</span>func_addr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>instruction<span class="token punctuation">.</span>address <span class="token operator">-</span> module<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                                    times<span class="token operator">=</span>times<span class="token operator">+</span><span class="token number">1</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                                iterator<span class="token punctuation">.</span><span class="token function">keep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                            <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>instruction <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>                        <span class="token function-variable function">onCallSummary</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">summary</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Stalker end!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token function">setImmediate</span><span class="token punctuation">(</span>hook_dlopen<span class="token punctuation">,</span> <span class="token string">"libsec2023.so"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>打开 apk 后 frida 输出如下</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>call1:JNI_OnLoad</pre></td></tr><tr><td data-num="2"></td><td><pre>call2:sub_FF14</pre></td></tr><tr><td data-num="3"></td><td><pre>call3:.memset</pre></td></tr><tr><td data-num="4"></td><td><pre>call4:.vsnprintf</pre></td></tr><tr><td data-num="5"></td><td><pre>call5:.time</pre></td></tr><tr><td data-num="6"></td><td><pre>call6:.localtime</pre></td></tr><tr><td data-num="7"></td><td><pre>call7:.__android_log_print</pre></td></tr><tr><td data-num="8"></td><td><pre>call8:sub_10070</pre></td></tr><tr><td data-num="9"></td><td><pre>call9:.fopen</pre></td></tr><tr><td data-num="10"></td><td><pre>call10:sub_21000</pre></td></tr><tr><td data-num="11"></td><td><pre>call11:.pthread_once</pre></td></tr><tr><td data-num="12"></td><td><pre>call12:sub_21054</pre></td></tr><tr><td data-num="13"></td><td><pre>call13:sub_412CC</pre></td></tr><tr><td data-num="14"></td><td><pre>call14:.malloc</pre></td></tr><tr><td data-num="15"></td><td><pre>call15:sub_21098</pre></td></tr><tr><td data-num="16"></td><td><pre>call16:sub_FABC</pre></td></tr><tr><td data-num="17"></td><td><pre>call17:sub_1010C</pre></td></tr><tr><td data-num="18"></td><td><pre>call18:sub_10194</pre></td></tr><tr><td data-num="19"></td><td><pre>call19:sub_11C4C</pre></td></tr><tr><td data-num="20"></td><td><pre>call20:.pthread_mutex_init</pre></td></tr><tr><td data-num="21"></td><td><pre>call21:sub_103D0</pre></td></tr><tr><td data-num="22"></td><td><pre>call22:sub_2BCA8</pre></td></tr><tr><td data-num="23"></td><td><pre>call23:sub_125E4</pre></td></tr><tr><td data-num="24"></td><td><pre>call24:sub_12660</pre></td></tr><tr><td data-num="25"></td><td><pre>call25:sub_1CE70</pre></td></tr><tr><td data-num="26"></td><td><pre>call26:sub_1CE34</pre></td></tr><tr><td data-num="27"></td><td><pre>call27:sub_1C664</pre></td></tr><tr><td data-num="28"></td><td><pre>call28:.pthread_mutex_lock</pre></td></tr><tr><td data-num="29"></td><td><pre>call29:.pthread_mutex_unlock</pre></td></tr><tr><td data-num="30"></td><td><pre>call30:.strlen</pre></td></tr><tr><td data-num="31"></td><td><pre>call31:sub_125F0</pre></td></tr><tr><td data-num="32"></td><td><pre>call32:sub_1D998</pre></td></tr><tr><td data-num="33"></td><td><pre>call33:sub_2C67C</pre></td></tr><tr><td data-num="34"></td><td><pre>call34:sub_2C40C</pre></td></tr><tr><td data-num="35"></td><td><pre>call35:.__strlcpy_chk</pre></td></tr><tr><td data-num="36"></td><td><pre>call36:.__strlen_chk</pre></td></tr><tr><td data-num="37"></td><td><pre>call37:sub_11BC4</pre></td></tr><tr><td data-num="38"></td><td><pre>call38:sub_2CCC0</pre></td></tr><tr><td data-num="39"></td><td><pre>call39:sub_355F0</pre></td></tr><tr><td data-num="40"></td><td><pre>call40:sub_35630</pre></td></tr><tr><td data-num="41"></td><td><pre>call41:sub_356C4</pre></td></tr><tr><td data-num="42"></td><td><pre>call42:sub_35700</pre></td></tr><tr><td data-num="43"></td><td><pre>call43:sub_11DF0</pre></td></tr><tr><td data-num="44"></td><td><pre>call44:sub_35870</pre></td></tr><tr><td data-num="45"></td><td><pre>call45:sub_36940</pre></td></tr><tr><td data-num="46"></td><td><pre>call46:sub_36B34</pre></td></tr><tr><td data-num="47"></td><td><pre>call47:sub_36B9C</pre></td></tr><tr><td data-num="48"></td><td><pre>call48:sub_36BC8</pre></td></tr><tr><td data-num="49"></td><td><pre>call49:sub_36BF0</pre></td></tr><tr><td data-num="50"></td><td><pre>call50:sub_36E00</pre></td></tr><tr><td data-num="51"></td><td><pre>call51:sub_36E70</pre></td></tr><tr><td data-num="52"></td><td><pre>call52:sub_36ED0</pre></td></tr><tr><td data-num="53"></td><td><pre>call53:sub_36F00</pre></td></tr><tr><td data-num="54"></td><td><pre>call54:sub_36F3C</pre></td></tr><tr><td data-num="55"></td><td><pre>call55:nullsub_17</pre></td></tr><tr><td data-num="56"></td><td><pre>call56:sub_36C8C</pre></td></tr><tr><td data-num="57"></td><td><pre>call57:sub_36CB8</pre></td></tr><tr><td data-num="58"></td><td><pre>call58:sub_2E318</pre></td></tr><tr><td data-num="59"></td><td><pre>call59:sub_2E288</pre></td></tr><tr><td data-num="60"></td><td><pre>call60:sub_2D590</pre></td></tr><tr><td data-num="61"></td><td><pre>call61:sub_1F450</pre></td></tr><tr><td data-num="62"></td><td><pre>call62:sub_20FD0</pre></td></tr><tr><td data-num="63"></td><td><pre>call63:.fstat</pre></td></tr><tr><td data-num="64"></td><td><pre>call64:sub_2DB5C</pre></td></tr><tr><td data-num="65"></td><td><pre>call65:sub_1FE3C</pre></td></tr><tr><td data-num="66"></td><td><pre>call66:sub_1FB70</pre></td></tr><tr><td data-num="67"></td><td><pre>call67:.sscanf</pre></td></tr><tr><td data-num="68"></td><td><pre>call68:sub_200C0</pre></td></tr><tr><td data-num="69"></td><td><pre>call69:.memcpy</pre></td></tr><tr><td data-num="70"></td><td><pre>call70:sub_1F6C0</pre></td></tr><tr><td data-num="71"></td><td><pre>call71:sub_1F8A4</pre></td></tr><tr><td data-num="72"></td><td><pre>call72:.free</pre></td></tr><tr><td data-num="73"></td><td><pre>call73:sub_36D38</pre></td></tr><tr><td data-num="74"></td><td><pre>call74:sub_36D70</pre></td></tr><tr><td data-num="75"></td><td><pre>call75:sub_36DA4</pre></td></tr><tr><td data-num="76"></td><td><pre>call76:sub_37060</pre></td></tr><tr><td data-num="77"></td><td><pre>call77:sub_41368</pre></td></tr><tr><td data-num="78"></td><td><pre>call78:sub_36A20</pre></td></tr><tr><td data-num="79"></td><td><pre>call79:sub_36D10</pre></td></tr><tr><td data-num="80"></td><td><pre>call80:sub_3C6A4</pre></td></tr><tr><td data-num="81"></td><td><pre>call81:sub_369B0</pre></td></tr><tr><td data-num="82"></td><td><pre>call82:sub_3DF74</pre></td></tr><tr><td data-num="83"></td><td><pre>call83:sub_3A054</pre></td></tr><tr><td data-num="84"></td><td><pre>call84:sub_3A090</pre></td></tr><tr><td data-num="85"></td><td><pre>call85:sub_3A0FC</pre></td></tr><tr><td data-num="86"></td><td><pre>call86:sub_3A138</pre></td></tr><tr><td data-num="87"></td><td><pre>call87:sub_24364</pre></td></tr><tr><td data-num="88"></td><td><pre>call88:sub_3852C</pre></td></tr><tr><td data-num="89"></td><td><pre>call89:sub_38D9C</pre></td></tr><tr><td data-num="90"></td><td><pre>call90:sub_36A90</pre></td></tr><tr><td data-num="91"></td><td><pre>call91:sub_3F2B0</pre></td></tr><tr><td data-num="92"></td><td><pre>call92:sub_36120</pre></td></tr><tr><td data-num="93"></td><td><pre>call93:sub_36144</pre></td></tr><tr><td data-num="94"></td><td><pre>call94:sub_370AC</pre></td></tr><tr><td data-num="95"></td><td><pre>call95:sub_36558</pre></td></tr><tr><td data-num="96"></td><td><pre>call96:sub_21BAC</pre></td></tr><tr><td data-num="97"></td><td><pre>call97:sub_21C20</pre></td></tr><tr><td data-num="98"></td><td><pre>call98:sub_21F50</pre></td></tr><tr><td data-num="99"></td><td><pre>call99:sub_21DB4</pre></td></tr><tr><td data-num="100"></td><td><pre>call100:j_.pthread_mutex_lock</pre></td></tr><tr><td data-num="101"></td><td><pre>call101:j_.pthread_mutex_unlock</pre></td></tr><tr><td data-num="102"></td><td><pre>call102:sub_11E30</pre></td></tr><tr><td data-num="103"></td><td><pre>call103:sub_11C60</pre></td></tr><tr><td data-num="104"></td><td><pre>call104:.pthread_attr_init</pre></td></tr><tr><td data-num="105"></td><td><pre>call105:.pthread_attr_setstacksize</pre></td></tr><tr><td data-num="106"></td><td><pre>call106:.pthread_attr_setdetachstate</pre></td></tr><tr><td data-num="107"></td><td><pre>call107:.pthread_create</pre></td></tr><tr><td data-num="108"></td><td><pre>call108:.pthread_attr_destroy</pre></td></tr><tr><td data-num="109"></td><td><pre>call109:sub_11C6C</pre></td></tr><tr><td data-num="110"></td><td><pre>call110:j_j_.free_2</pre></td></tr><tr><td data-num="111"></td><td><pre>call111:j_.free</pre></td></tr><tr><td data-num="112"></td><td><pre>call112:sub_37254</pre></td></tr><tr><td data-num="113"></td><td><pre>call113:sub_37740</pre></td></tr><tr><td data-num="114"></td><td><pre>call114:sub_377A8</pre></td></tr><tr><td data-num="115"></td><td><pre>call115:sub_377D8</pre></td></tr><tr><td data-num="116"></td><td><pre>call116:sub_37804</pre></td></tr><tr><td data-num="117"></td><td><pre>call117:sub_37A64</pre></td></tr><tr><td data-num="118"></td><td><pre>call118:sub_37AD4</pre></td></tr><tr><td data-num="119"></td><td><pre>call119:sub_37B34</pre></td></tr><tr><td data-num="120"></td><td><pre>call120:sub_37B64</pre></td></tr><tr><td data-num="121"></td><td><pre>call121:sub_37BA0</pre></td></tr><tr><td data-num="122"></td><td><pre>call122:nullsub_18</pre></td></tr><tr><td data-num="123"></td><td><pre>call123:sub_3789C</pre></td></tr><tr><td data-num="124"></td><td><pre>call124:sub_378C4</pre></td></tr><tr><td data-num="125"></td><td><pre>call125:sub_20DD0</pre></td></tr><tr><td data-num="126"></td><td><pre>call126:sub_20580</pre></td></tr><tr><td data-num="127"></td><td><pre>call127:sub_20CB0</pre></td></tr><tr><td data-num="128"></td><td><pre>call128:sub_20EBC</pre></td></tr><tr><td data-num="129"></td><td><pre>call129:j_.stat</pre></td></tr><tr><td data-num="130"></td><td><pre>call130:.stat</pre></td></tr><tr><td data-num="131"></td><td><pre>call131:sub_373B4</pre></td></tr><tr><td data-num="132"></td><td><pre>call132:sub_1240C</pre></td></tr><tr><td data-num="133"></td><td><pre>call133:sub_1F74C</pre></td></tr><tr><td data-num="134"></td><td><pre>call134:.lseek</pre></td></tr><tr><td data-num="135"></td><td><pre>call135:sub_1F9EC</pre></td></tr><tr><td data-num="136"></td><td><pre>call136:sub_1FA34</pre></td></tr><tr><td data-num="137"></td><td><pre>call137:sub_37940</pre></td></tr><tr><td data-num="138"></td><td><pre>call138:sub_37974</pre></td></tr><tr><td data-num="139"></td><td><pre>call139:sub_379A8</pre></td></tr><tr><td data-num="140"></td><td><pre>call140:sub_1235C</pre></td></tr><tr><td data-num="141"></td><td><pre>call141:sub_37134</pre></td></tr><tr><td data-num="142"></td><td><pre>call142:sub_37184</pre></td></tr><tr><td data-num="143"></td><td><pre>call143:sub_371AC</pre></td></tr><tr><td data-num="144"></td><td><pre>call144:sub_376CC</pre></td></tr><tr><td data-num="145"></td><td><pre>call145:sub_37704</pre></td></tr><tr><td data-num="146"></td><td><pre>call146:sub_37738</pre></td></tr><tr><td data-num="147"></td><td><pre>call147:sub_3715C</pre></td></tr><tr><td data-num="148"></td><td><pre>call148:sub_36580</pre></td></tr><tr><td data-num="149"></td><td><pre>call149:sub_36538</pre></td></tr><tr><td data-num="150"></td><td><pre>call150:sub_36178</pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr></table></figure><h1 id="对libsec2023so打下硬件断点"><a class="anchor" href="#对libsec2023so打下硬件断点">#</a> 对 libsec2023.so 打下硬件断点</h1>
<p>这里需要用到的工具是 <code>rwprocmem33</code> , 具体的编译和使用可以移步我博客内的<a href="https://oacia.dev/rwProcMem33-usage/">这篇文章</a>进行阅读，这里不在过多赘述</p>
<p>运行下面的 frida 代码获取 <code>libsec2023.so</code>  的基址</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">dump_so</span><span class="token punctuation">(</span><span class="token parameter">so_name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">var</span> currentApplication <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"android.app.ActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">currentApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">var</span> dir <span class="token operator">=</span> currentApplication<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFilesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">var</span> libso <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span>so_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[name]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[base]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[size]:"</span><span class="token punctuation">,</span> <span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[path]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>rpc<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token literal-property property">dump_so</span><span class="token operator">:</span> dump_so</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>frida <span class="token parameter variable">-H</span> <span class="token number">127.0</span>.0.1:1234 <span class="token parameter variable">-l</span> <span class="token string">"D:<span class="token entity" title="\f">\f</span>rida\sec2023\get_so_base.js"</span> <span class="token parameter variable">-f</span> <span class="token string">"com.com.sec2023.rocketmouse.mouse"</span></pre></td></tr></table></figure><p><img data-src="/sec-2023/image-20230817132059046.png" alt="image-20230817132059046" style="aspect-ratio:1571 / 469;"></p>
<p>利用下面的命令获取进程的 PID</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">ps</span> <span class="token parameter variable">-A</span> <span class="token operator">|</span> <span class="token function">grep</span> mouse</pre></td></tr></table></figure><p>将得到的参数填入 <code>rwprocmem33</code>  中</p>
<p>首先对我们最感兴趣的 <code>libil2cpp.so</code>  调用的 <code>libsec2023.so</code>  的导出函数 <code>sub_35404</code>  下硬件断点看看，毕竟之前我们用 frida 去 hook 这个函数失败了嘛，硬件断点下的位置可以通过基址 (base)+ 偏移 (func offset) 得到</p>
<p>结果如下</p>
<p><img data-src="/sec-2023/image-20230817132705290.png" alt="image-20230817132705290" style="aspect-ratio:1064 / 1013;"></p>
<p>仅仅下了五秒的硬件断点，相同地址的命中次数进入达到了百万次</p>
<p>我们再对不同的地址打下硬件断点看看，发现均只有一个命中地址，并且命中次数都达到百万次</p>
<p>与基址相减得到偏移为 <code>0x37704</code></p>
<p><img data-src="/sec-2023/image-20230817133029502.png" alt="image-20230817133029502" style="aspect-ratio:1064 / 1013;"></p>
<p>进入 ida 查看 <code>sub_37704</code>  函数，代码很短，按下交叉引用也没有输出</p>
<p><img data-src="/sec-2023/image-20230817025119017.png" alt="image-20230817025119017" style="aspect-ratio:1020 / 379;"></p>
<p>这该怎么办呢？</p>
<p>还记得上面我们曾用 <code>frida-stalker</code>  打印出了 <code>libsec2023.so</code>  函数的调用链嘛，我们从 <code>sub_37704</code>  向上回溯看看</p>
<figure class="highlight text"><figcaption data-lang="text"></figcaption><table><tr><td data-num="1"></td><td><pre>call135:sub_1F9EC</pre></td></tr><tr><td data-num="2"></td><td><pre>call136:sub_1FA34</pre></td></tr><tr><td data-num="3"></td><td><pre>call137:sub_37940</pre></td></tr><tr><td data-num="4"></td><td><pre>call138:sub_37974</pre></td></tr><tr><td data-num="5"></td><td><pre>call139:sub_379A8</pre></td></tr><tr><td data-num="6"></td><td><pre>call140:sub_1235C</pre></td></tr><tr><td data-num="7"></td><td><pre>call141:sub_37134</pre></td></tr><tr><td data-num="8"></td><td><pre>call142:sub_37184</pre></td></tr><tr><td data-num="9"></td><td><pre>call143:sub_371AC</pre></td></tr><tr><td data-num="10"></td><td><pre>call144:sub_376CC</pre></td></tr><tr><td data-num="11"></td><td><pre>call145:sub_37704</pre></td></tr></table></figure><p><code>sub_37704</code>  是被 <code>sub_376CC</code>  调用的， <code>sub_376CC</code>  中的这个 <code>BR</code>  跳转应该是调用了 <code>sub_37704</code></p>
<p><img data-src="/sec-2023/image-20230817030756246.png" alt="image-20230817030756246" style="aspect-ratio:886 / 340;"></p>
<p>再看调用 <code>sub_376CC</code>  的函数 <code>sub_371AC</code> , 在这个函数中，我们发现了一条有趣的指令， <code>CSEL</code></p>
<p><img data-src="/sec-2023/image-20230817133504656.png" alt="image-20230817133504656" style="aspect-ratio:711 / 467;"></p>
<p>熟悉 arm 指令集的朋友肯定知道， <code>CSEL</code>  是 arm 中的分支结构指令，而 <code>BR</code>  跳转的位置由 <code>X8</code>  决定，所以这段汇编便可以改变便程序控制流</p>
<p><code>CSEL X8, X8, X9, EQ</code>  中， <code>EQ</code>  表示 <code>Equal</code> , 即相等条件，其值由最近的 CMP 的比较后得出的值决定，例如此处判断的条件就是 <code>CMP W0, W8</code></p>
<p>用 c 语言来表示就是</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span>W0 <span class="token operator">==</span> W8<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    X8 <span class="token operator">=</span> X8</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    X8 <span class="token operator">=</span> X9</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>而 <code>X8</code>  和 <code>X9</code>  相差 <code>0x10</code> , <code>X8</code>  的修改便导致了控制流的改变</p>
<p>为了不让控制流转向错误的分支导致 frida 注入后强制退出，我们可以对此处的汇编进行 patch, 将 <code>CSEL X8, X8, X9, EQ</code>  改为 <code>CSEL X8, X8, X8, EQ</code> , 即将汇编 <code>08 01 89 9A</code>  修改为 <code>08 01 88 9A</code></p>
<p><img data-src="/sec-2023/image-20230817154739431.png" alt="image-20230817154739431" style="aspect-ratio:772 / 460;"></p>
<p>但是要怎么让 apk 运行我们 patch 过后的 <code>libsec2023.so</code>  呢？</p>
<p>有以下的三种思路可以参考</p>
<ul>
<li>反编译 apk 然后替换其中的 <code>lib/arm64-v8a/libsec2023.so</code>  并回编译后安装 apk</li>
<li>在手机安装 apk 后，在 <code>/data/app/</code>  子目录中找到 <code>libsec2023.so</code>  的位置并予以替换</li>
<li>在 apk 加载 <code>libsec2023.so</code>  之后进行 patch</li>
</ul>
<p>前两种方法经过尝试均以失败告终，那么现在只剩下最后一种方法了，就是在 <code>libsec2023.so</code>  加载之后动态 patch, 而这利用 frida 可以说简直就是轻而易举，利用 <code>Memory.writeByteArray</code>  就可以做到</p>
<p>运行 <code>rpc.exports.anti_sec2023()</code>  的时机是在打开 apk 之后</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">anti_sec2023</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">var</span> currentApplication <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"android.app.ActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">currentApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">var</span> libso <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libsec2023.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[name]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[base]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[size]:"</span><span class="token punctuation">,</span> <span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[path]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        Memory<span class="token punctuation">.</span><span class="token function">protect</span><span class="token punctuation">(</span><span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token string">'rwx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        Memory<span class="token punctuation">.</span><span class="token function">writeByteArray</span><span class="token punctuation">(</span><span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x371DC</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x88</span><span class="token punctuation">,</span><span class="token number">0x9A</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>rpc<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token literal-property property">anti_sec2023</span><span class="token operator">:</span> anti_sec2023</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>之后再次尝试对 <code>sub_31164</code>  附加钩子</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_31164</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 程序入口</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 获取模块</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libsec2023.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 转为函数地址</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">var</span> addr<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"0x31164"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 获取函数入口</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">var</span> func <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] hook '</span><span class="token operator">+</span>func<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 函数 hook 钩子附加</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    </pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     </pre></td></tr><tr><td data-num="20"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hook success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"retvalue is :"</span><span class="token punctuation">,</span> retval<span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'method onleave'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这一次，钩子成功附加上去了！</p>
<p><img data-src="/sec-2023/image-20230817170036802.png" alt="image-20230817170036802" style="aspect-ratio:1586 / 635;"></p>
<h1 id="idapython去除csel-brcset-br结构"><a class="anchor" href="#idapython去除csel-brcset-br结构">#</a> IDApython 去除 CSEL-BR/CSET-BR 结构</h1>
<p><code>sub_31164</code>  首先调用了 <code>sub_3B8CC</code> , 那我们就就去分析一下 <code>sub_3B8CC</code></p>
<p><img data-src="/sec-2023/image-20230818141550105.png" alt="image-20230818141550105" style="aspect-ratio:430 / 797;"></p>
<p>往下看最后一行汇编是是 <code>BR X8</code> , 我们看看 <code>BR</code>  表示的意思是什么</p>
<blockquote>
<p>BR: 跳转到某寄存器 (的值) 指向的地址（无返回）, 不会改变 <em>lr (x30)</em> 寄存器的值。</p>
</blockquote>
<p>寄存器跳转的存在严重的阻碍了我们的逆向分析，那我们试试能不能稍稍修改一下</p>
<p>我们可以使用 <code>frida-stalker</code>  来追踪寄存器的值 (绝对不是因为我用不来 <code>unicorn</code>  才用 <code>frida</code>  的 (真的)</p>
<p>起初我是直接准备 patch 内存中的指令的，代码也写的差不多了 (现在被注释了), 没想到这寄存器跳转会有两种情况，没办法改成 <code>B</code>  跳转，不然进程会崩溃掉，所以就打印出跳转的地址手工分析咯</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">addr_locate_so</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 定位某个内存地址在哪个 so 里面，虽然可以直接 Process.getModuleByAddress, 但是会抛出异常所以就用函数实现了</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> process_Obj_Module_Arr <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">enumerateModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> process_Obj_Module_Arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>addr<span class="token operator">></span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base <span class="token operator">&amp;&amp;</span> addr<span class="token operator">&lt;</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token keyword">return</span> process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">":0x"</span><span class="token operator">+</span><span class="token punctuation">(</span>addr<span class="token operator">-</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">function</span> <span class="token function">anti_BR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">var</span> libso <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libsec2023.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">var</span> hook_addr <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x31164</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>tid <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] hook '</span><span class="token operator">+</span>hook_addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">var</span> reg_name<span class="token punctuation">;</span><span class="token comment">//br 之后的寄存器的名称</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">var</span> inst_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>hook_addr<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    </pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"start Stalker!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token comment">// 不追踪 libc.so, 不然 frida 会报错退出.. 看堆栈回溯应该是动态编译执行了 libc.so 里面的 ptrace 才导致的异常</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            Stalker<span class="token punctuation">.</span><span class="token function">exclude</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token string-property property">"base"</span><span class="token operator">:</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libc.so"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>base<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token string-property property">"size"</span><span class="token operator">:</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libc.so"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>size</pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            Stalker<span class="token punctuation">.</span><span class="token function">follow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tid<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token literal-property property">events</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                    <span class="token literal-property property">call</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// CALL instructions: yes please            </span></pre></td></tr><tr><td data-num="28"></td><td><pre>                    <span class="token literal-property property">ret</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// RET instructions</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                    <span class="token literal-property property">exec</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// all instructions: not recommended as it's</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                    <span class="token literal-property property">block</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// block executed: coarse execution trace</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                    <span class="token literal-property property">compile</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// block compiled: useful for coverage</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token function-variable function">transform</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">iterator</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                    <span class="token keyword">let</span> instruction <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                    <span class="token keyword">const</span> startAddress <span class="token operator">=</span> instruction<span class="token punctuation">.</span>address<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                    <span class="token keyword">const</span> isAppCode <span class="token operator">=</span> startAddress<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>startAddress<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>isAppCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>instruction<span class="token punctuation">.</span>mnemonic <span class="token operator">===</span> <span class="token string">"br"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                                reg_name <span class="token operator">=</span> instruction<span class="token punctuation">.</span>opStr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                                inst_addr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span>instruction<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>                                iterator<span class="token punctuation">.</span><span class="token function">putCallout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                                    <span class="token keyword">var</span> addr_before <span class="token operator">=</span> <span class="token function">addr_locate_so</span><span class="token punctuation">(</span>inst_addr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                                    <span class="token keyword">var</span> addr_after <span class="token operator">=</span> <span class="token function">addr_locate_so</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>context<span class="token punctuation">[</span>reg_name<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                                    <span class="token keyword">if</span><span class="token punctuation">(</span>addr_after<span class="token operator">==</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                                        addr_after <span class="token operator">=</span> <span class="token string">"unknown:"</span><span class="token operator">+</span>context<span class="token punctuation">[</span>reg_name<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>addr_before<span class="token punctuation">,</span><span class="token string">"jump to"</span><span class="token punctuation">,</span>addr_after<span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">,</span>reg_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                                    <span class="token comment">//Memory.patchCode(inst_addr,4,code =>&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                                        <span class="token comment">//var cw = new Arm64Writer(code,&#123;pc: inst_addr&#125;);</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                                        <span class="token comment">//cw.putBImm(new NativePointer(context[reg_name]));</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                                        <span class="token comment">//cw.flush();</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                                    <span class="token comment">//&#125;)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                        iterator<span class="token punctuation">.</span><span class="token function">keep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>instruction <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"stalker end!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            Stalker<span class="token punctuation">.</span><span class="token function">unfollow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            Stalker<span class="token punctuation">.</span><span class="token function">garbageCollect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>运行代码后，程序输出如下</p>
<figure class="highlight text"><figcaption data-lang="text"></figcaption><table><tr><td data-num="1"></td><td><pre>[Remote::com.com.sec2023.rocketmouse.mouse ]-> rpc.exports.anti_BR()</pre></td></tr><tr><td data-num="2"></td><td><pre>[+] hook 0x76cd136164</pre></td></tr><tr><td data-num="3"></td><td><pre>[Remote::com.com.sec2023.rocketmouse.mouse ]-> start Stalker!</pre></td></tr><tr><td data-num="4"></td><td><pre>stalker end!</pre></td></tr><tr><td data-num="5"></td><td><pre>libsec2023.so:0x3ba00 jump to libsec2023.so:0x3ba04   x10</pre></td></tr><tr><td data-num="6"></td><td><pre>libsec2023.so:0x3ba30 jump to libsec2023.so:0x3ba34   x12</pre></td></tr><tr><td data-num="7"></td><td><pre>libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba34   x12</pre></td></tr><tr><td data-num="8"></td><td><pre>libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba34   x12</pre></td></tr><tr><td data-num="9"></td><td><pre>libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba34   x12</pre></td></tr><tr><td data-num="10"></td><td><pre>libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba74   x12</pre></td></tr><tr><td data-num="11"></td><td><pre>libsec2023.so:0x3badc jump to libsec2023.so:0x3bae0   x13</pre></td></tr><tr><td data-num="12"></td><td><pre>libsec2023.so:0x3bb28 jump to libsec2023.so:0x3bae0   x13</pre></td></tr><tr><td data-num="13"></td><td><pre>libsec2023.so:0x3bb28 jump to libsec2023.so:0x3bae0   x13</pre></td></tr><tr><td data-num="14"></td><td><pre>libsec2023.so:0x3bb28 jump to libsec2023.so:0x3bae0   x13</pre></td></tr><tr><td data-num="15"></td><td><pre>libsec2023.so:0x3bb28 jump to libsec2023.so:0x3bb2c   x13</pre></td></tr><tr><td data-num="16"></td><td><pre>libsec2023.so:0x3bb4c jump to libsec2023.so:0x3ba04   x10</pre></td></tr><tr><td data-num="17"></td><td><pre>libsec2023.so:0x3bb4c jump to unknown:0x3   x10</pre></td></tr><tr><td data-num="18"></td><td><pre>libsec2023.so:0x3bb4c jump to unknown:0x2   x10</pre></td></tr><tr><td data-num="19"></td><td><pre>libsec2023.so:0x3bb4c jump to unknown:0x1   x10</pre></td></tr><tr><td data-num="20"></td><td><pre>libsec2023.so:0x3bb4c jump to unknown:0x0   x10</pre></td></tr><tr><td data-num="21"></td><td><pre>libsec2023.so:0x3bb4c jump to unknown:0xffffffffffffffff   x10</pre></td></tr><tr><td data-num="22"></td><td><pre>libsec2023.so:0x3bb4c jump to unknown:0x0   x10</pre></td></tr><tr><td data-num="23"></td><td><pre>libsec2023.so:0x3bb4c jump to unknown:0x6d000000   x10</pre></td></tr><tr><td data-num="24"></td><td><pre>libsec2023.so:0x3bb4c jump to unknown:0x6d940000   x10</pre></td></tr><tr><td data-num="25"></td><td><pre>libsec2023.so:0x3bb4c jump to unknown:0x6d94ca00   x10</pre></td></tr><tr><td data-num="26"></td><td><pre>libsec2023.so:0x3bb4c jump to unknown:0x6d94cae5   x10</pre></td></tr><tr><td data-num="27"></td><td><pre>libsec2023.so:0x3bb4c jump to libsec2023.so:0x3bb50   x10</pre></td></tr><tr><td data-num="28"></td><td><pre>libsec2023.so:0x3a08c jump to libsec2023.so:0x3a0f0   x8</pre></td></tr><tr><td data-num="29"></td><td><pre>libsec2023.so:0x3b508 jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="30"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="31"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="32"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="33"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="34"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="35"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="36"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="37"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="38"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="39"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="40"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="41"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="42"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="43"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="44"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="45"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="46"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c   x11</pre></td></tr><tr><td data-num="47"></td><td><pre>libsec2023.so:0x3b54c jump to libsec2023.so:0x3b550   x11</pre></td></tr><tr><td data-num="48"></td><td><pre>libsec2023.so:0x3b5c0 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="49"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="50"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="51"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="52"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="53"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="54"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="55"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="56"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="57"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="58"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="59"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="60"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="61"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="62"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="63"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="64"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="65"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4   x11</pre></td></tr><tr><td data-num="66"></td><td><pre>libsec2023.so:0x3b604 jump to libsec2023.so:0x3b608   x11</pre></td></tr><tr><td data-num="67"></td><td><pre>libsec2023.so:0x3aa70 jump to libsec2023.so:0x3aa74   x8</pre></td></tr><tr><td data-num="68"></td><td><pre>libsec2023.so:0x3aaa0 jump to libsec2023.so:0x3aaa4   x8</pre></td></tr><tr><td data-num="69"></td><td><pre>libsec2023.so:0x3aad4 jump to libsec2023.so:0x3aad8   x8</pre></td></tr><tr><td data-num="70"></td><td><pre>libsec2023.so:0x3ab04 jump to libsec2023.so:0x3ab70   x8</pre></td></tr><tr><td data-num="71"></td><td><pre>libsec2023.so:0xf28c jump to libc.so:0xb2688   x17</pre></td></tr><tr><td data-num="72"></td><td><pre>libsec2023.so:0xf4ac jump to libc.so:0xb2bd8   x17</pre></td></tr><tr><td data-num="73"></td><td><pre>libsec2023.so:0x3ac90 jump to libsec2023.so:0x3acc0   x11</pre></td></tr><tr><td data-num="74"></td><td><pre>libsec2023.so:0xf40c jump to libc.so:0x4bc20   x17</pre></td></tr><tr><td data-num="75"></td><td><pre>libsec2023.so:0xf40c jump to libc.so:0xb2688   x17</pre></td></tr><tr><td data-num="76"></td><td><pre>libsec2023.so:0xf40c jump to libc.so:0xb2bd8   x17</pre></td></tr><tr><td data-num="77"></td><td><pre>libsec2023.so:0x3b950 jump to libsec2023.so:0x3b95c   x8</pre></td></tr><tr><td data-num="78"></td><td><pre>libsec2023.so:0x3b950 jump to libsec2023.so:0x3a0f0   x8</pre></td></tr><tr><td data-num="79"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="80"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="81"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="82"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="83"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="84"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="85"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="86"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="87"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="88"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="89"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="90"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="91"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="92"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="93"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="94"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="95"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="96"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="97"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="98"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="99"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="100"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="101"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="102"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="103"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="104"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="105"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="106"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="107"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="108"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="109"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="110"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="111"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="112"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="113"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="114"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="115"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="116"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x76ccc36000   x8</pre></td></tr><tr><td data-num="117"></td><td><pre>libsec2023.so:0x3b950 jump to libsec2023.so:0x3aa74   x8</pre></td></tr><tr><td data-num="118"></td><td><pre>libsec2023.so:0x3b950 jump to libsec2023.so:0x3aaa4   x8</pre></td></tr><tr><td data-num="119"></td><td><pre>libsec2023.so:0x3b950 jump to libsec2023.so:0x3aad8   x8</pre></td></tr><tr><td data-num="120"></td><td><pre>libsec2023.so:0x3b950 jump to libsec2023.so:0x3ab70   x8</pre></td></tr><tr><td data-num="121"></td><td><pre>libsec2023.so:0x3b950 jump to libsec2023.so:0x3ab70   x8</pre></td></tr><tr><td data-num="122"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x77ea7ac3a0   x8</pre></td></tr><tr><td data-num="123"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x1c01f8026ad23c58   x8</pre></td></tr><tr><td data-num="124"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x1c01f8026ad23c58   x8</pre></td></tr><tr><td data-num="125"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0x1c01f8026ad23c58   x8</pre></td></tr><tr><td data-num="126"></td><td><pre>libsec2023.so:0x3b950 jump to unknown:0xe   x8</pre></td></tr><tr><td data-num="127"></td><td><pre>libsec2023.so:0x3b990 jump to libsec2023.so:0x3b99c   x8</pre></td></tr><tr><td data-num="128"></td><td><pre>libsec2023.so:0x311a0 jump to libil2cpp.so:0x13b8d64   x2</pre></td></tr></table></figure><p>我们不妨以地址 <code>0x3ba70</code>  作为分析的示例，这里我们发现 <code>0x3ba70</code>  会跳转的地址有两种情况，分别是 <code>0x3ba34</code>  和 <code>0x3ba74</code></p>
<p>等等， <code>0x3ba74</code> ?? 这不就是 <code>0x3ba70</code>  之后要执行的指令吗？</p>
<p>那结果显而易见了，这 <code>BR</code>  寄存器跳转的前身肯定就是条件跳转， <code>BGE</code> , <code>BLE</code>  这类的指令</p>
<figure class="highlight text"><figcaption data-lang="text"></figcaption><table><tr><td data-num="1"></td><td><pre>libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba34   x12</pre></td></tr><tr><td data-num="2"></td><td><pre>libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba34   x12</pre></td></tr><tr><td data-num="3"></td><td><pre>libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba34   x12</pre></td></tr><tr><td data-num="4"></td><td><pre>libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba74   x12</pre></td></tr></table></figure><p>接下来就是在 IDA 里面修复控制流咯，我们修复一下 <code>0x3ba00</code>  这个第一个 <code>BR</code>  跳转的地方，别的地方的思想都是一样的</p>
<figure class="highlight text"><figcaption data-lang="text"></figcaption><table><tr><td data-num="1"></td><td><pre>libsec2023.so:0x3ba00 jump to libsec2023.so:0x3ba04   x10</pre></td></tr></table></figure><p><img data-src="/sec-2023/image-20230819014827349.png" alt="image-20230819014827349" style="aspect-ratio:1452 / 276;"></p>
<p>进入到 <code>off_72C40</code> , 加上 <code>W11</code>  得到正确的跳转，写了个简单的 python 脚本输出 hex 方便直接复制进去</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>red_num <span class="token operator">=</span> <span class="token number">0xFFFFFFFF8C034254</span></pre></td></tr><tr><td data-num="2"></td><td><pre>add_num <span class="token operator">=</span> <span class="token number">0x740078FC</span></pre></td></tr><tr><td data-num="3"></td><td><pre>num <span class="token operator">=</span> <span class="token punctuation">(</span>red_num<span class="token operator">+</span>add_num<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xffffffff</span></pre></td></tr><tr><td data-num="4"></td><td><pre>my_byte <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>my_byte <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">hex</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> my_byte<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>my_byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>这个地方修复完是这样的，可以看到 <code>*(off_72C40+0)</code>  和 <code>*(off_72C40+0x28)</code>  的地方值已经被我加上去了</p>
<p><img data-src="/sec-2023/image-20230819020109133.png" alt="image-20230819020109133" style="aspect-ratio:938 / 128;"></p>
<p>接下来就是改是汇编了，ADD 指令我们肯定是不需要了，因为已经被我们加上去了，所以接下来继续往下走看的是这条 <code>CSEL X10, XZR, X9, CC</code>  指令</p>
<p><img data-src="/sec-2023/image-20230819020355254.png" alt="image-20230819020355254" style="aspect-ratio:462 / 268;"></p>
<p>各个条件码的含义如下</p>
<table>
<thead>
<tr>
<th>条件码</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>EQ</td>
<td>Z 置位；结果相等才执行</td>
</tr>
<tr>
<td>NE</td>
<td>Z 清零，结果不相等才执行</td>
</tr>
<tr>
<td>CS</td>
<td>C 置位，结果无符号 &gt;= 才执行</td>
</tr>
<tr>
<td>CC</td>
<td>C 清零，结果无符号 &lt; 才执行</td>
</tr>
<tr>
<td>MI</td>
<td>N 置位，结果为负数才执行</td>
</tr>
<tr>
<td>PL</td>
<td>N 清零，结果为正数或 0 才执行</td>
</tr>
<tr>
<td>VS</td>
<td>V 置位，结果溢出才执行</td>
</tr>
<tr>
<td>VC</td>
<td>V 清零，结果无溢出才执行</td>
</tr>
<tr>
<td>HI</td>
<td>C 置位 Z 清零，结果为无符号数大于才执行</td>
</tr>
<tr>
<td>LS</td>
<td>C 清零 Z 置位，结果为无符号数小于或等于才执行</td>
</tr>
<tr>
<td>GE</td>
<td>N 等于 V，结果为有符号数大于或等于才执行</td>
</tr>
<tr>
<td>LT</td>
<td>N 不等于 V，结果为有符号数小于才执行</td>
</tr>
<tr>
<td>GT</td>
<td>Z 清零且 N 等于 V ，结果为有符号大于才执行</td>
</tr>
<tr>
<td>LE</td>
<td>Z 置位或 N 不等于 V ，结果为有符号数小于或等于</td>
</tr>
<tr>
<td>AL</td>
<td>无条件执行。省略。</td>
</tr>
</tbody>
</table>
<p>那么这里 <code>BR</code>  分支跳转的意思就可以表示为</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span>X8 <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 由 CC 指令的含义知道是小于比较</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    B <span class="token number">0x3BA04</span><span class="token comment">// 即继续向下执行</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>X8 <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    B <span class="token number">0x3BB50</span><span class="token comment">// 跳转到其他地方</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>所以这里改成 <code>BGE</code> , 然后把不需要的指令 <code>NOP</code>  掉，一处地方就修复好啦</p>
<p><img data-src="/sec-2023/image-20230819022733118.png" alt="image-20230819022733118" style="aspect-ratio:774 / 298;"></p>
<p>还要注意的是，除了 <code>CSEL-BR</code>  结构之外，还有 <code>CSET-BR</code>  结构</p>
<p><img data-src="/sec-2023/image-20230825005445886.png" alt="image-20230825005445886" style="aspect-ratio:483 / 345;"></p>
<blockquote>
<p>CSET： 比较指令，满足条件，则并置 1，否则置 0 ，如：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>cmp w8<span class="token punctuation">,</span> #<span class="token number">2</span>        <span class="token punctuation">;</span> 将寄存器 w8 的值和常量 <span class="token number">2</span> 进行比较</pre></td></tr><tr><td data-num="2"></td><td><pre>cset w8<span class="token punctuation">,</span> gt       <span class="token punctuation">;</span> 如果是大于<span class="token punctuation">(</span>grater than<span class="token punctuation">)</span>，则将寄存器 w8 的值设置为 <span class="token number">1</span>，否则设置为 <span class="token number">0</span></pre></td></tr></table></figure></blockquote>
<p>和 <code>CSEL-BR</code>  结构的修复思路是相似的，对于上图 ( <code>0x3B95C</code>  处) 的 <code>CSET-BR</code>  结构，我们仅需关注这几行指令</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>CSET W23<span class="token punctuation">,</span> NE</pre></td></tr><tr><td data-num="2"></td><td><pre>LDR  X8<span class="token punctuation">,</span> <span class="token punctuation">[</span>X21<span class="token punctuation">,</span>W23<span class="token punctuation">,</span>UXTW#<span class="token number">3</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre>ADD  X8<span class="token punctuation">,</span> X8<span class="token punctuation">,</span> X22</pre></td></tr><tr><td data-num="4"></td><td><pre>BR   X8</pre></td></tr></table></figure><p>其中的 <code>LDR  X8, [X21,W23,UXTW#3]</code>  的含义可以用 C 语言这样表示 <code>X8 = *(X21 + (W23 &lt;&lt; 3))</code> , <code>UXTW#3</code>  即将操作数左移三位的意思</p>
<p>这样一个一个修复过去，未免也太麻烦了，那索性就写个 idapython 脚本一键去除 <code>CSEL-BR</code>  和 <code>CSET-BR</code>  结构来解放双手吧哈哈</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> ida_segment</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> idautils</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> idc</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> ida_bytes</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">from</span> keystone <span class="token keyword">import</span> <span class="token operator">*</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">def</span> <span class="token function">patch_nop</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># arm64 中的 NOP 指令是 b'\x1F\x20\x03\xD5'</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">while</span> end <span class="token operator">></span> begin<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        ida_bytes<span class="token punctuation">.</span>patch_bytes<span class="token punctuation">(</span>begin<span class="token punctuation">,</span> <span class="token string">b'\x1F\x20\x03\xD5'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        begin <span class="token operator">=</span> begin <span class="token operator">+</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 获取 text 段的起始地址</span></pre></td></tr><tr><td data-num="15"></td><td><pre>text_seg <span class="token operator">=</span> ida_segment<span class="token punctuation">.</span>get_segm_by_name<span class="token punctuation">(</span><span class="token string">".text"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>start<span class="token punctuation">,</span> end <span class="token operator">=</span> text_seg<span class="token punctuation">.</span>start_ea<span class="token punctuation">,</span> text_seg<span class="token punctuation">.</span>end_ea</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># start, end = 0x3BA34, 0x3BA80</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># start, end = 0x37390,0x373B4# 测试 ADRP 指令</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># start, end = 0x3FCE0, 0x3FD00  # 测试 EQ 情况</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#start, end = 0x3AA90, 0x3AAA4</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># start, end = 0x3A078, 0x3A090# 测试 CSET-BR 去除情况</span></pre></td></tr><tr><td data-num="22"></td><td><pre>current_addr <span class="token operator">=</span> start</pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># print(text_seg.start_ea,text_seg.end_ea)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>nop_addr_array_after_finish <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 在 CSEL/CSET-BR 结构修复完成后需要 NOP 的指令</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">while</span> current_addr <span class="token operator">&lt;</span> end<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment"># 处理 CSEL-BR 结构</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>current_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"CSEL"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        CSEL_addr <span class="token operator">=</span> current_addr</pre></td></tr><tr><td data-num="29"></td><td><pre>        nop_addr_array_temp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>CSEL_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        BR_addr <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        BR_reg <span class="token operator">=</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>current_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 向下搜寻 9 条指令，寻找是否有 BR 指令</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"BR"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                BR_addr <span class="token operator">=</span> temp_addr</pre></td></tr><tr><td data-num="37"></td><td><pre>                BR_reg <span class="token operator">=</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token keyword">break</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"CSEL"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token keyword">break</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">if</span> BR_addr <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 匹配到了 CSEL-BR 结构的汇编，需要去除</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token comment"># 形如 CSEL X11, X12, X11, GE, 获取 CSEL 后的操作数 op1~3, 以及条件码 cond</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            CSEL_op1 <span class="token operator">=</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>CSEL_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            CSEL_op2 <span class="token operator">=</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>CSEL_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            CSEL_op2_val <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            CSEL_op3 <span class="token operator">=</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>CSEL_addr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            CSEL_op3_val <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            CSEL_cond <span class="token operator">=</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>CSEL_addr<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token comment"># 读取条件分支语句 CSEL 中要赋值给目标寄存器的两个源寄存器中存储的值</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>prev_head<span class="token punctuation">(</span>CSEL_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span>CSEL_op2_val <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">or</span> CSEL_op3_val <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">and</span> temp_addr <span class="token operator">></span> text_seg<span class="token punctuation">.</span>start_ea<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token keyword">if</span> CSEL_op2 <span class="token operator">==</span> <span class="token string">"XZR"</span><span class="token punctuation">:</span>  <span class="token comment"># 如果寄存器的值是 XZR, 说明该值为 0</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                    CSEL_op2_val <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token keyword">if</span> CSEL_op3 <span class="token operator">==</span> <span class="token string">"XZR"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                    CSEL_op3_val <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"MOV"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">==</span> CSEL_op2<span class="token punctuation">[</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                                                               <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">and</span> CSEL_op2_val <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># 寄存器 X11 和 W11 是同一个寄存器</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                        CSEL_op2_val <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                        nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                    <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">==</span> CSEL_op3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">and</span> CSEL_op3_val <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                        CSEL_op3_val <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                        nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>prev_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token comment"># print(CSEL_op2_val, CSEL_op3_val, hex(current_addr))</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            <span class="token keyword">assert</span> CSEL_op2_val <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> CSEL_op3_val <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>            temp_addr <span class="token operator">=</span> BR_addr</pre></td></tr><tr><td data-num="71"></td><td><pre>            jump_array_reg <span class="token operator">=</span> <span class="token string">""</span>  <span class="token comment"># 存贮跳转表的寄存器名称</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            jump_array_addr <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token comment"># 跳转表所在的位置</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            add_reg <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 加到跳转表的值所在的寄存器</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            add_val <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token comment"># 加到跳转表的值</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token keyword">while</span> temp_addr <span class="token operator">></span> CSEL_addr<span class="token punctuation">:</span>  <span class="token comment"># 从后往前找，以 BR 所在的地址开始，CSEL 所在的地址结束，匹配必要的寄存器名称和值</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                <span class="token comment"># print(hex(temp_addr),idc.print_insn_mnem(temp_addr))</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ADD"</span> <span class="token keyword">and</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> BR_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                    add_reg<span class="token punctuation">.</span>append<span class="token punctuation">(</span>idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                    add_reg<span class="token punctuation">.</span>append<span class="token punctuation">(</span>idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                    nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="81"></td><td><pre>                <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"MOV"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">in</span> add_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                        add_val <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                        nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"LDR"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                    jump_array_reg <span class="token operator">=</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 获取存储跳转表的寄存器名称</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                    nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ADRL"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                    jump_array_reg <span class="token operator">=</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                    jump_array_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                    nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>prev_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre>            <span class="token comment"># 如果在 CSEL-BR 间的指令中没找到跳转表所在的位置，则向上寻找</span></pre></td></tr><tr><td data-num="95"></td><td><pre>            <span class="token keyword">if</span> jump_array_addr <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                temp_addr <span class="token operator">=</span> CSEL_addr</pre></td></tr><tr><td data-num="97"></td><td><pre>                <span class="token keyword">while</span> temp_addr <span class="token operator">></span> text_seg<span class="token punctuation">.</span>start_ea<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="98"></td><td><pre>                    <span class="token comment"># print(hex(temp_addr), idc.print_insn_mnem(temp_addr))</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ADRL"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                        <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> jump_array_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="101"></td><td><pre>                            jump_array_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="102"></td><td><pre>                            nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="103"></td><td><pre>                            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="104"></td><td><pre>                    <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ADRP"</span><span class="token punctuation">:</span>  <span class="token comment"># ADRP 指令，还需要加上另一部分</span></pre></td></tr><tr><td data-num="105"></td><td><pre>                        <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> jump_array_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="106"></td><td><pre>                            jump_array_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="107"></td><td><pre>                            nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="108"></td><td><pre>                            <span class="token keyword">while</span> temp_addr <span class="token operator">&lt;</span> text_seg<span class="token punctuation">.</span>end_ea<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="109"></td><td><pre>                                <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ADD"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="110"></td><td><pre>                                    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> jump_array_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="111"></td><td><pre>                                        jump_array_addr <span class="token operator">+=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="112"></td><td><pre>                                        nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="113"></td><td><pre>                                        <span class="token keyword">break</span></pre></td></tr><tr><td data-num="114"></td><td><pre>                                temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="115"></td><td><pre>                            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="116"></td><td><pre>                    temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>prev_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="117"></td><td><pre>            <span class="token comment"># print(hex(jump_array_addr),hex(add_val))</span></pre></td></tr><tr><td data-num="118"></td><td><pre></pre></td></tr><tr><td data-num="119"></td><td><pre>            <span class="token keyword">if</span> add_val <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="120"></td><td><pre>                temp_addr <span class="token operator">=</span> CSEL_addr</pre></td></tr><tr><td data-num="121"></td><td><pre>                <span class="token keyword">while</span> temp_addr <span class="token operator">></span> text_seg<span class="token punctuation">.</span>start_ea<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="122"></td><td><pre>                    <span class="token comment"># print(hex(temp_addr), idc.print_insn_mnem(temp_addr))</span></pre></td></tr><tr><td data-num="123"></td><td><pre>                    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"MOV"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="124"></td><td><pre>                        <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">in</span> add_reg <span class="token keyword">and</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'X'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="125"></td><td><pre>                            add_val <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="126"></td><td><pre>                            nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="127"></td><td><pre>                            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="128"></td><td><pre>                    temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>prev_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="129"></td><td><pre></pre></td></tr><tr><td data-num="130"></td><td><pre>            <span class="token comment"># 计算出分支跳转的两个位置</span></pre></td></tr><tr><td data-num="131"></td><td><pre>            branch_a <span class="token operator">=</span> <span class="token punctuation">(</span>ida_bytes<span class="token punctuation">.</span>get_qword<span class="token punctuation">(</span>jump_array_addr <span class="token operator">+</span> CSEL_op2_val<span class="token punctuation">)</span> <span class="token operator">+</span> add_val<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffffffffffff</span></pre></td></tr><tr><td data-num="132"></td><td><pre>            branch_b <span class="token operator">=</span> <span class="token punctuation">(</span>ida_bytes<span class="token punctuation">.</span>get_qword<span class="token punctuation">(</span>jump_array_addr <span class="token operator">+</span> CSEL_op3_val<span class="token punctuation">)</span> <span class="token operator">+</span> add_val<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffffffffffff</span></pre></td></tr><tr><td data-num="133"></td><td><pre>            <span class="token comment"># print(hex(branch_a), hex(branch_b))</span></pre></td></tr><tr><td data-num="134"></td><td><pre></pre></td></tr><tr><td data-num="135"></td><td><pre>            <span class="token comment"># print(CSEL_cond,hex(current_addr))</span></pre></td></tr><tr><td data-num="136"></td><td><pre></pre></td></tr><tr><td data-num="137"></td><td><pre>            <span class="token comment"># GE&lt;->LT 有符号大于等于 vs 有符号小于</span></pre></td></tr><tr><td data-num="138"></td><td><pre>            <span class="token comment"># EQ&lt;->NE 结果相等 vs 结果不相等</span></pre></td></tr><tr><td data-num="139"></td><td><pre>            <span class="token comment"># CC&lt;->CS 无符号小于 vs 无符号大于等于</span></pre></td></tr><tr><td data-num="140"></td><td><pre>            <span class="token comment"># HI&lt;->LS 无符号大于 vs 无符号小于等于</span></pre></td></tr><tr><td data-num="141"></td><td><pre>            <span class="token comment"># if CSEL_cond == "GE":# 构造 B.LT 跳转</span></pre></td></tr><tr><td data-num="142"></td><td><pre>            logic_rev <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"GE"</span><span class="token punctuation">:</span> <span class="token string">"LT"</span><span class="token punctuation">,</span> <span class="token string">"LT"</span><span class="token punctuation">:</span> <span class="token string">"GE"</span><span class="token punctuation">,</span> <span class="token string">"EQ"</span><span class="token punctuation">:</span> <span class="token string">"NE"</span><span class="token punctuation">,</span> <span class="token string">"NE"</span><span class="token punctuation">:</span> <span class="token string">"EQ"</span><span class="token punctuation">,</span> <span class="token string">"CC"</span><span class="token punctuation">:</span> <span class="token string">"CS"</span><span class="token punctuation">,</span> <span class="token string">"CS"</span><span class="token punctuation">:</span> <span class="token string">"CC"</span><span class="token punctuation">,</span> <span class="token string">"HI"</span><span class="token punctuation">:</span> <span class="token string">"LS"</span><span class="token punctuation">,</span> <span class="token string">"LS"</span><span class="token punctuation">:</span> <span class="token string">"HI"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>            ks <span class="token operator">=</span> Ks<span class="token punctuation">(</span>KS_ARCH_ARM64<span class="token punctuation">,</span> KS_MODE_LITTLE_ENDIAN<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="144"></td><td><pre>            code <span class="token operator">=</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="145"></td><td><pre>            <span class="token keyword">if</span> branch_b <span class="token operator">==</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>BR_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 判断逻辑不取反</span></pre></td></tr><tr><td data-num="146"></td><td><pre>                code <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"B.</span><span class="token interpolation"><span class="token punctuation">&#123;</span>CSEL_cond<span class="token punctuation">&#125;</span></span><span class="token string"> #</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>branch_a<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span></pre></td></tr><tr><td data-num="147"></td><td><pre>            <span class="token keyword">elif</span> branch_a <span class="token operator">==</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>BR_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 判断逻辑取反</span></pre></td></tr><tr><td data-num="148"></td><td><pre>                code <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"B.</span><span class="token interpolation"><span class="token punctuation">&#123;</span>logic_rev<span class="token punctuation">[</span>CSEL_cond<span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string"> #</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>branch_b<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span></pre></td></tr><tr><td data-num="149"></td><td><pre></pre></td></tr><tr><td data-num="150"></td><td><pre>            <span class="token comment">#print(hex(current_addr), hex(add_val), CSEL_op2_val, CSEL_op3_val, hex(jump_array_addr), code)</span></pre></td></tr><tr><td data-num="151"></td><td><pre></pre></td></tr><tr><td data-num="152"></td><td><pre>            <span class="token comment"># 修复 BR 跳转</span></pre></td></tr><tr><td data-num="153"></td><td><pre>            <span class="token keyword">if</span> code <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="154"></td><td><pre></pre></td></tr><tr><td data-num="155"></td><td><pre>                patch_br_byte<span class="token punctuation">,</span> count <span class="token operator">=</span> ks<span class="token punctuation">.</span>asm<span class="token punctuation">(</span>code<span class="token punctuation">,</span> addr<span class="token operator">=</span>BR_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="156"></td><td><pre>                ida_bytes<span class="token punctuation">.</span>patch_bytes<span class="token punctuation">(</span>BR_addr<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>patch_br_byte<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="157"></td><td><pre>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"fix CSEL-BR at </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>BR_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="158"></td><td><pre>                nop_addr_array_after_finish<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>nop_addr_array_temp<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="159"></td><td><pre>                current_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>BR_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="160"></td><td><pre>                <span class="token keyword">continue</span></pre></td></tr><tr><td data-num="161"></td><td><pre>            <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="162"></td><td><pre>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"error! unable to fix CSEL-BR at </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>current_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">,branch:</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>branch_a<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>branch_b<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="163"></td><td><pre></pre></td></tr><tr><td data-num="164"></td><td><pre>    <span class="token comment"># 处理 CSET-BR 结构</span></pre></td></tr><tr><td data-num="165"></td><td><pre>    <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>current_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"CSET"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="166"></td><td><pre>        CSET_addr <span class="token operator">=</span> current_addr</pre></td></tr><tr><td data-num="167"></td><td><pre>        nop_addr_array_temp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="168"></td><td><pre>        nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>CSET_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="169"></td><td><pre>        BR_addr <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="170"></td><td><pre>        BR_reg <span class="token operator">=</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="171"></td><td><pre>        temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>current_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="172"></td><td><pre>        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 向下搜寻 15 条指令，寻找是否有 BR 指令</span></pre></td></tr><tr><td data-num="173"></td><td><pre>            <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"BR"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="174"></td><td><pre>                BR_addr <span class="token operator">=</span> temp_addr</pre></td></tr><tr><td data-num="175"></td><td><pre>                BR_reg <span class="token operator">=</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="176"></td><td><pre>                <span class="token keyword">break</span></pre></td></tr><tr><td data-num="177"></td><td><pre>            <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"CSEL"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="178"></td><td><pre>                <span class="token keyword">break</span></pre></td></tr><tr><td data-num="179"></td><td><pre>            <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"RET"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="180"></td><td><pre>                <span class="token keyword">break</span></pre></td></tr><tr><td data-num="181"></td><td><pre>            temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="182"></td><td><pre>        <span class="token keyword">if</span> BR_addr <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 匹配到了 CSET-BR 结构的汇编，需要去除</span></pre></td></tr><tr><td data-num="183"></td><td><pre>            <span class="token comment"># 形如 CSET W23, NE, 获取 CSET 后的操作数 op1, 以及条件码 cond</span></pre></td></tr><tr><td data-num="184"></td><td><pre>            CSET_op1 <span class="token operator">=</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>CSET_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="185"></td><td><pre>            CSET_op1_val <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span></pre></td></tr><tr><td data-num="186"></td><td><pre>            CSET_cond <span class="token operator">=</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>CSET_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="187"></td><td><pre></pre></td></tr><tr><td data-num="188"></td><td><pre>            temp_addr <span class="token operator">=</span> BR_addr</pre></td></tr><tr><td data-num="189"></td><td><pre>            jump_array_reg <span class="token operator">=</span> <span class="token string">""</span>  <span class="token comment"># 存贮跳转表的寄存器名称</span></pre></td></tr><tr><td data-num="190"></td><td><pre>            jump_array_addr <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 跳转表所在的位置</span></pre></td></tr><tr><td data-num="191"></td><td><pre>            add_reg <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 加到跳转表的值所在的寄存器</span></pre></td></tr><tr><td data-num="192"></td><td><pre>            add_val <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 加到跳转表的值</span></pre></td></tr><tr><td data-num="193"></td><td><pre>            Lshift_val <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span></pre></td></tr><tr><td data-num="194"></td><td><pre>            <span class="token keyword">while</span> temp_addr <span class="token operator">></span> CSET_addr<span class="token punctuation">:</span>  <span class="token comment"># 从后往前找，以 BR 所在的地址开始，CSET 所在的地址结束，匹配必要的寄存器名称和值</span></pre></td></tr><tr><td data-num="195"></td><td><pre>                <span class="token comment"># print(hex(temp_addr),idc.print_insn_mnem(temp_addr))</span></pre></td></tr><tr><td data-num="196"></td><td><pre>                <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ADD"</span> <span class="token keyword">and</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> BR_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="197"></td><td><pre>                    add_reg<span class="token punctuation">.</span>append<span class="token punctuation">(</span>idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="198"></td><td><pre>                    add_reg<span class="token punctuation">.</span>append<span class="token punctuation">(</span>idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="199"></td><td><pre>                    nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="200"></td><td><pre>                <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"MOVK"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="201"></td><td><pre>                    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">in</span> add_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="202"></td><td><pre>                        add_val <span class="token operator">+=</span> <span class="token punctuation">(</span>idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="203"></td><td><pre>                <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"MOV"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="204"></td><td><pre>                    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">in</span> add_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="205"></td><td><pre>                        add_val <span class="token operator">+=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="206"></td><td><pre>                        nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="207"></td><td><pre>                <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"LDR"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="208"></td><td><pre>                    LDR_temp <span class="token operator">=</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="209"></td><td><pre>                    jump_array_reg <span class="token operator">=</span> LDR_temp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 获取存储跳转表的寄存器名称</span></pre></td></tr><tr><td data-num="210"></td><td><pre>                    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>LDR_temp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="211"></td><td><pre>                        Lshift_val <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>LDR_temp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="212"></td><td><pre>                    nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="213"></td><td><pre>                <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ADRL"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="214"></td><td><pre>                    jump_array_reg <span class="token operator">=</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="215"></td><td><pre>                    jump_array_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="216"></td><td><pre>                    nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="217"></td><td><pre>                <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"LSL"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="218"></td><td><pre>                    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">==</span> CSET_op1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="219"></td><td><pre>                        Lshift_val <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="220"></td><td><pre></pre></td></tr><tr><td data-num="221"></td><td><pre>                temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>prev_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="222"></td><td><pre></pre></td></tr><tr><td data-num="223"></td><td><pre>            <span class="token comment"># 如果在 CSET-BR 间的指令中没找到跳转表所在的位置，则向上寻找</span></pre></td></tr><tr><td data-num="224"></td><td><pre>            <span class="token keyword">if</span> jump_array_addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="225"></td><td><pre>                temp_addr <span class="token operator">=</span> CSET_addr</pre></td></tr><tr><td data-num="226"></td><td><pre>                <span class="token keyword">while</span> temp_addr <span class="token operator">></span> text_seg<span class="token punctuation">.</span>start_ea<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="227"></td><td><pre>                    <span class="token comment"># print(hex(temp_addr), idc.print_insn_mnem(temp_addr))</span></pre></td></tr><tr><td data-num="228"></td><td><pre>                    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ADRL"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="229"></td><td><pre>                        <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> jump_array_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="230"></td><td><pre>                            jump_array_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="231"></td><td><pre>                            nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="232"></td><td><pre>                            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="233"></td><td><pre>                    <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ADRP"</span><span class="token punctuation">:</span>  <span class="token comment"># ADRP 指令，还需要加上另一部分</span></pre></td></tr><tr><td data-num="234"></td><td><pre>                        <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> jump_array_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="235"></td><td><pre>                            jump_array_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="236"></td><td><pre>                            nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="237"></td><td><pre>                            <span class="token keyword">while</span> temp_addr <span class="token operator">&lt;</span> text_seg<span class="token punctuation">.</span>end_ea<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="238"></td><td><pre>                                <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ADD"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="239"></td><td><pre>                                    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> jump_array_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="240"></td><td><pre>                                        jump_array_addr <span class="token operator">+=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="241"></td><td><pre>                                        nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="242"></td><td><pre>                                        <span class="token keyword">break</span></pre></td></tr><tr><td data-num="243"></td><td><pre>                                temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="244"></td><td><pre>                            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="245"></td><td><pre>                    temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>prev_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="246"></td><td><pre>            <span class="token comment"># print(hex(jump_array_addr),hex(add_val))</span></pre></td></tr><tr><td data-num="247"></td><td><pre></pre></td></tr><tr><td data-num="248"></td><td><pre>            <span class="token comment"># 向上寻找加到跳转表的值</span></pre></td></tr><tr><td data-num="249"></td><td><pre>            <span class="token keyword">if</span> add_val <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="250"></td><td><pre>                temp_addr <span class="token operator">=</span> CSET_addr</pre></td></tr><tr><td data-num="251"></td><td><pre>                <span class="token keyword">while</span> temp_addr <span class="token operator">></span> text_seg<span class="token punctuation">.</span>start_ea<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="252"></td><td><pre>                    <span class="token comment"># print(hex(temp_addr), idc.print_insn_mnem(temp_addr))</span></pre></td></tr><tr><td data-num="253"></td><td><pre>                    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"MOV"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="254"></td><td><pre>                        <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">in</span> add_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="255"></td><td><pre>                            add_val <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="256"></td><td><pre>                            nop_addr_array_temp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="257"></td><td><pre>                            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="258"></td><td><pre>                    <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"MOVK"</span><span class="token punctuation">:</span>  <span class="token comment"># 形如 MOV W9, #0x76BC;MOVK W9, #0x4C48,LSL#16; 的形式</span></pre></td></tr><tr><td data-num="259"></td><td><pre>                        <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">in</span> add_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="260"></td><td><pre>                            <span class="token comment"># print(hex(add_val))</span></pre></td></tr><tr><td data-num="261"></td><td><pre>                            add_val <span class="token operator">=</span> <span class="token punctuation">(</span>idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="262"></td><td><pre>                            <span class="token comment"># print(hex(add_val))</span></pre></td></tr><tr><td data-num="263"></td><td><pre>                            <span class="token keyword">while</span> temp_addr <span class="token operator">></span> text_seg<span class="token punctuation">.</span>start_ea<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="264"></td><td><pre>                                <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"MOV"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="265"></td><td><pre>                                    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_operand<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">in</span> add_reg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="266"></td><td><pre>                                        add_val <span class="token operator">+=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="267"></td><td><pre>                                        <span class="token comment"># print(hex(add_val))</span></pre></td></tr><tr><td data-num="268"></td><td><pre>                                        <span class="token keyword">break</span></pre></td></tr><tr><td data-num="269"></td><td><pre>                                temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>prev_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="270"></td><td><pre></pre></td></tr><tr><td data-num="271"></td><td><pre>                            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="272"></td><td><pre></pre></td></tr><tr><td data-num="273"></td><td><pre>                    temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>prev_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="274"></td><td><pre></pre></td></tr><tr><td data-num="275"></td><td><pre>            <span class="token comment"># print(hex(current_addr))</span></pre></td></tr><tr><td data-num="276"></td><td><pre>            <span class="token comment"># 计算出分支跳转的两个位置</span></pre></td></tr><tr><td data-num="277"></td><td><pre>            branch_a <span class="token operator">=</span> <span class="token punctuation">(</span>ida_bytes<span class="token punctuation">.</span>get_qword<span class="token punctuation">(</span>jump_array_addr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Lshift_val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> add_val<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffffffffffff</span></pre></td></tr><tr><td data-num="278"></td><td><pre>            branch_b <span class="token operator">=</span> <span class="token punctuation">(</span>ida_bytes<span class="token punctuation">.</span>get_qword<span class="token punctuation">(</span>jump_array_addr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;&lt;</span> Lshift_val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> add_val<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffffffffffff</span></pre></td></tr><tr><td data-num="279"></td><td><pre>            <span class="token comment"># print(hex(branch_a), hex(branch_b))</span></pre></td></tr><tr><td data-num="280"></td><td><pre></pre></td></tr><tr><td data-num="281"></td><td><pre>            <span class="token comment"># print(CSEL_cond,hex(current_addr))</span></pre></td></tr><tr><td data-num="282"></td><td><pre></pre></td></tr><tr><td data-num="283"></td><td><pre>            <span class="token comment"># GE&lt;->LT 有符号大于等于 vs 有符号小于</span></pre></td></tr><tr><td data-num="284"></td><td><pre>            <span class="token comment"># EQ&lt;->NE 结果相等 vs 结果不相等</span></pre></td></tr><tr><td data-num="285"></td><td><pre>            <span class="token comment"># CC&lt;->CS 无符号小于 vs 无符号大于等于</span></pre></td></tr><tr><td data-num="286"></td><td><pre>            <span class="token comment"># HI&lt;->LS 无符号大于 vs 无符号小于等于</span></pre></td></tr><tr><td data-num="287"></td><td><pre>            <span class="token comment"># if CSEL_cond == "GE":# 构造 B.LT 跳转</span></pre></td></tr><tr><td data-num="288"></td><td><pre>            logic_rev <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"GE"</span><span class="token punctuation">:</span> <span class="token string">"LT"</span><span class="token punctuation">,</span> <span class="token string">"LT"</span><span class="token punctuation">:</span> <span class="token string">"GE"</span><span class="token punctuation">,</span> <span class="token string">"EQ"</span><span class="token punctuation">:</span> <span class="token string">"NE"</span><span class="token punctuation">,</span> <span class="token string">"NE"</span><span class="token punctuation">:</span> <span class="token string">"EQ"</span><span class="token punctuation">,</span> <span class="token string">"CC"</span><span class="token punctuation">:</span> <span class="token string">"CS"</span><span class="token punctuation">,</span> <span class="token string">"CS"</span><span class="token punctuation">:</span> <span class="token string">"CC"</span><span class="token punctuation">,</span> <span class="token string">"HI"</span><span class="token punctuation">:</span> <span class="token string">"LS"</span><span class="token punctuation">,</span> <span class="token string">"LS"</span><span class="token punctuation">:</span> <span class="token string">"HI"</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="289"></td><td><pre>            ks <span class="token operator">=</span> Ks<span class="token punctuation">(</span>KS_ARCH_ARM64<span class="token punctuation">,</span> KS_MODE_LITTLE_ENDIAN<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="290"></td><td><pre>            code <span class="token operator">=</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="291"></td><td><pre>            <span class="token keyword">if</span> branch_b <span class="token operator">==</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>BR_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 判断逻辑不取反</span></pre></td></tr><tr><td data-num="292"></td><td><pre>                code <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"B.</span><span class="token interpolation"><span class="token punctuation">&#123;</span>CSET_cond<span class="token punctuation">&#125;</span></span><span class="token string"> #</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>branch_a<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span></pre></td></tr><tr><td data-num="293"></td><td><pre>            <span class="token keyword">elif</span> branch_a <span class="token operator">==</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>BR_addr<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 判断逻辑取反</span></pre></td></tr><tr><td data-num="294"></td><td><pre>                code <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"B.</span><span class="token interpolation"><span class="token punctuation">&#123;</span>logic_rev<span class="token punctuation">[</span>CSET_cond<span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string"> #</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>branch_b<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span></pre></td></tr><tr><td data-num="295"></td><td><pre></pre></td></tr><tr><td data-num="296"></td><td><pre>            <span class="token comment"># print(hex(current_addr),add_reg,hex(add_val),CSET_op1,CSET_op1_val,jump_array_reg,hex(jump_array_addr),Lshift_val,code)</span></pre></td></tr><tr><td data-num="297"></td><td><pre>            <span class="token comment"># 修复 BR 跳转</span></pre></td></tr><tr><td data-num="298"></td><td><pre>            <span class="token keyword">if</span> code <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="299"></td><td><pre>                patch_br_byte<span class="token punctuation">,</span> count <span class="token operator">=</span> ks<span class="token punctuation">.</span>asm<span class="token punctuation">(</span>code<span class="token punctuation">,</span> addr<span class="token operator">=</span>BR_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="300"></td><td><pre>                ida_bytes<span class="token punctuation">.</span>patch_bytes<span class="token punctuation">(</span>BR_addr<span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>patch_br_byte<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="301"></td><td><pre>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"fix CSET-BR at </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>BR_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="302"></td><td><pre>                nop_addr_array_after_finish<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>nop_addr_array_temp<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="303"></td><td><pre>                current_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>BR_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="304"></td><td><pre>                <span class="token keyword">continue</span></pre></td></tr><tr><td data-num="305"></td><td><pre>            <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="306"></td><td><pre>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"error! unable to fix CSET-BR at </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>current_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">,branch:</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>branch_a<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>branch_b<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="307"></td><td><pre></pre></td></tr><tr><td data-num="308"></td><td><pre>    current_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>current_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="309"></td><td><pre></pre></td></tr><tr><td data-num="310"></td><td><pre><span class="token keyword">for</span> addr <span class="token keyword">in</span> nop_addr_array_after_finish<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="311"></td><td><pre>    patch_nop<span class="token punctuation">(</span>addr<span class="token punctuation">,</span> addr <span class="token operator">+</span> idc<span class="token punctuation">.</span>get_item_size<span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="加密一-在sub_3b9d4中"><a class="anchor" href="#加密一-在sub_3b9d4中">#</a> 加密一 在 sub_3B9D4 中</h1>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>__int64 __fastcall <span class="token function">sub_3B9D4</span><span class="token punctuation">(</span>__int64 result<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">unsigned</span> __int64 i<span class="token punctuation">;</span> <span class="token comment">// x8</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  __int64 v2<span class="token punctuation">;</span> <span class="token comment">// x10</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// w11</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  __int64 v4<span class="token punctuation">;</span> <span class="token comment">// x11</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment">// w10</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment">// w12</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">unsigned</span> __int8 v7<span class="token punctuation">;</span> <span class="token comment">// w14</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">int</span> v8<span class="token punctuation">;</span> <span class="token comment">// [xsp+Ch] [xbp-4h]</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    v2 <span class="token operator">=</span> <span class="token number">3LL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    v8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    v3 <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">do</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v8 <span class="token operator">+</span> v2<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>result <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">>></span> v3<span class="token punctuation">)</span> <span class="token operator">^</span> v2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token operator">--</span>v2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      v3 <span class="token operator">-=</span> <span class="token number">8</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span> v2 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">HIBYTE</span><span class="token punctuation">(</span>v8<span class="token punctuation">)</span> <span class="token operator">^=</span> <span class="token number">0x86u</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token function">BYTE2</span><span class="token punctuation">(</span>v8<span class="token punctuation">)</span> <span class="token operator">-=</span> <span class="token number">94</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    v4 <span class="token operator">=</span> <span class="token number">3LL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">BYTE1</span><span class="token punctuation">(</span>v8<span class="token punctuation">)</span> <span class="token operator">^=</span> <span class="token number">0xD3u</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">LOBYTE</span><span class="token punctuation">(</span>v8<span class="token punctuation">)</span> <span class="token operator">=</span> v8 <span class="token operator">-</span> <span class="token number">28</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>result <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    v6 <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">do</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      v7 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v8 <span class="token operator">+</span> v4<span class="token punctuation">)</span> <span class="token operator">-</span> v6<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v8 <span class="token operator">+</span> v4<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">=</span> v7<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      v5 <span class="token operator">+=</span> v7 <span class="token operator">&lt;&lt;</span> v6<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>result <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> v5<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      v6 <span class="token operator">-=</span> <span class="token number">8</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span> v4 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>第一个加密函数 <code>sub_3B9D4</code>  取出数据的每一位进行加密，其中出现的 <code>HIBYTE</code>  ,  <code>BYTE2</code> ,  <code>BYTE1</code> , <code>LOBYTE</code>    含义如下，假设有数据 <code>a1=0x12345678</code> , 则</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>取出的值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>HIBYTE(a1)</code></td>
<td>0x12</td>
</tr>
<tr>
<td><code>BYTE2(a1)</code></td>
<td>0x34</td>
</tr>
<tr>
<td><code>BYTE1(a1)</code></td>
<td>0x56</td>
</tr>
<tr>
<td><code>LOBYTE(a1)</code></td>
<td>0x78</td>
</tr>
</tbody>
</table>
<p>我们可以使用 frida 去 hook <code>sub_3B9D4</code>  传入的值以及返回值，观察加密前后的变化，假设我此处在小键盘输入的数字是 <code>999999999999</code> , <code>hex(999999999999)=0xe8d4a50fff</code></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//hook 第一个加密函数，观察数值前后变化</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_1_enc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 获取模块</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libsec2023.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 转为函数地址</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">var</span> addr<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"0x3B9D4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 获取函数入口</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">var</span> func <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] hook '</span><span class="token operator">+</span>func<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 函数 hook 钩子附加</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    </pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     </pre></td></tr><tr><td data-num="15"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'before first enc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="21"></td><td><pre>              <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"after first enc"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>retval<span class="token punctuation">,</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="30"></td><td><pre>              <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/sec-2023/image-20230829154207172.png" alt="image-20230829154207172" style="aspect-ratio:1028 / 285;"></p>
<p>于是第一个算法如下</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>algorithm_1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"enc"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"enc"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">^</span> <span class="token number">0xd3</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"enc"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">94</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"enc"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">^</span> <span class="token number">0x86</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"dec"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"dec"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">^</span> <span class="token number">0xd3</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"dec"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">94</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"dec"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">^</span> <span class="token number">0x86</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">def</span> <span class="token function">enc_1</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    input_byte <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>input_byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        index <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>algorithm_1<span class="token punctuation">[</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token string">"enc"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> index<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">8</span> <span class="token operator">*</span> index<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>input_byte<span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">def</span> <span class="token function">dec_1</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    input_byte <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>input_byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        index <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>algorithm_1<span class="token punctuation">[</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token string">"dec"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">(</span>input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> index<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> index</pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>input_byte<span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">def</span> <span class="token function">mytest_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token number">999999999999</span>  <span class="token comment"># 假设在小键盘输入 999999999999</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment"># 验证加密算法</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> enc_1<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">assert</span> <span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">b'\xe3\xd5\x39\x39\xcc\xca\x94\x6d'</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment"># 验证解密算法</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> dec_1<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">assert</span> <span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">b'\xff\x0f\xa5\xd4\xe8\x00\x00\x00'</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>mytest_1<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="在sub_3b9d4之后-bswap32分析"><a class="anchor" href="#在sub_3b9d4之后-bswap32分析">#</a> 在 sub_3B9D4 之后 bswap32 分析</h1>
<p>在对输入的值进行首轮加密之后，又再次对输入值经过 <code>bswap32</code>  函数加密</p>
<p><img data-src="/sec-2023/image-20230829160716908.png" alt="image-20230829160716908" style="aspect-ratio:943 / 608;"></p>
<p>这个函数对应的 arm 汇编为</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>REV W8<span class="token punctuation">,</span> W8</pre></td></tr></table></figure><p>那我们去 arm 手册看看 <code>REV</code>  指令的定义好了</p>
<blockquote>
<p>REV</p>
<p>Byte-Reverse Word reverses the byte order in a 32-bit register.</p>
<p>Operation</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> <span class="token function">ConditionPassed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> then</pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token function">EncodingSpecificOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token function">bits</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    result<span class="token operator">&lt;</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">></span> <span class="token operator">=</span> R<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    result<span class="token operator">&lt;</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">></span> <span class="token operator">=</span> R<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">8</span><span class="token operator">></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    result<span class="token operator">&lt;</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">8</span><span class="token operator">></span>  <span class="token operator">=</span> R<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">16</span><span class="token operator">></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    result<span class="token operator">&lt;</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">></span>   <span class="token operator">=</span> R<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    R<span class="token punctuation">[</span>d<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">;</span></pre></td></tr></table></figure></blockquote>
<p>看 <code>Operation</code>  很清楚的知道这就是反转字节，比如</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>w8 <span class="token operator">=</span> <span class="token number">0x12345678</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>REV W8<span class="token punctuation">,</span> W8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>w8<span class="token punctuation">;</span><span class="token comment">//w8 = 0x78563412</span></pre></td></tr></table></figure><p>所以此处 <code>bswap32(v6)</code> , 是对 <code>v6</code>  进行字节翻转，而 <code>v6 = HIDWORD(a1)</code> , 故在进行第一个加密函数 <code>sub_3B9D4</code>  之后，将首先对输入的高 32 位进行加密处理，这在我们后续 hook 第二个加密函数 <code>sub_3A924</code>  之后，也可以体现出来这一点</p>
<h1 id="加密二-blackobfuscator混淆"><a class="anchor" href="#加密二-blackobfuscator混淆">#</a> 加密二 BlackObfuscator 混淆</h1>
<p>我们首先 hook 一下 <code>sub_3A924</code>  让前后分析的逻辑连贯起来</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//hook 第 2 个加密函数，观察数值前后变化</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">var</span> enc2_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">var</span> input_2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_2_enc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 获取模块</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libsec2023.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 转为函数地址</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">var</span> addr<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"0x3A924"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 获取函数入口</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">var</span> func <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] hook '</span><span class="token operator">+</span>func<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 函数 hook 钩子附加</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    </pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        </pre></td></tr><tr><td data-num="17"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'before second enc, count:'</span><span class="token punctuation">,</span>enc2_count<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            input_2<span class="token punctuation">[</span>enc2_count<span class="token punctuation">]</span> <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            </pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'after second enc, count:'</span><span class="token punctuation">,</span>enc2_count<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span>input_2<span class="token punctuation">[</span>enc2_count<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                enc2_count<span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在经过第一轮加密后，我们得到了密文 <code>cc ca 94 6d e3 d5 39 39</code> , 而在此处，第一次调用 <code>sub_3A924</code>  的输入为 <code>6d 94 ca cc</code> , 第二次调用 <code>sub_3A924</code>  的输入为 <code>39 39 d5 e3</code> , 正好对应了上文提到的翻转字节处理</p>
<p><img data-src="/sec-2023/image-20230830024642669.png" alt="image-20230830024642669" style="aspect-ratio:1044 / 616;"></p>
<p>我们进入该函数后，发现如 <code>v11+1408LL</code> , <code>v11 + 1664LL</code>  等等的 <code>fastcall</code>  函数调用，一般这种形式的函数调用在安卓逆向中遇到的话，那大概率就是 <code>JNIEnv *</code></p>
<p><img data-src="/sec-2023/image-20230829154859854.png" alt="image-20230829154859854" style="aspect-ratio:1425 / 684;"></p>
<p>在此题中，我们只需要对 <code>v11</code>  按下 <code>Y</code>  切换类型，然后输入 <code>JNIEnv *</code> , 就会转换成 <code>JNIEnv *</code>  的结构体函数指针如图</p>
<p><img data-src="/sec-2023/image-20230830000329982.png" alt="image-20230830000329982" style="aspect-ratio:1095 / 866;"></p>
<p>在这里出现了 <code>jni</code>  函数 <code>GetStaticMethodID</code> , 我们 hook 一下这个函数观察调用了什么方法</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//hook GetStaticMethodID </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_GetStaticMethodID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">var</span> symbols <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">enumerateSymbolsSync</span><span class="token punctuation">(</span><span class="token string">"libart.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">var</span> addr_jni <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> symbols<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">var</span> symbol <span class="token operator">=</span> symbols<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>symbol<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"GetStaticMethodID"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            addr_jni <span class="token operator">=</span> symbol<span class="token punctuation">.</span>address<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"find "</span><span class="token punctuation">,</span>symbol<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[+] hook "</span><span class="token punctuation">,</span>addr_jni<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>addr_jni<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"call GetStaticMethodID: "</span><span class="token punctuation">,</span>symbol<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"name: "</span><span class="token punctuation">,</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"sig: "</span><span class="token punctuation">,</span>args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> </pre></td></tr><tr><td data-num="18"></td><td><pre>                    <span class="token comment">//console.log("return val")</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                    <span class="token comment">//console.log(retval);</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在输出中，我们发现 <code>GetStaticMethodID</code>  调用了名为 <code>encrypt</code>  的方法</p>
<p><img data-src="/sec-2023/image-20230830000805212.png" alt="image-20230830000805212" style="aspect-ratio:1656 / 234;"></p>
<p>但是我们在 apk 中却并未发现该方法</p>
<p><img data-src="/sec-2023/image-20230830000915933.png" alt="image-20230830000915933" style="aspect-ratio:1402 / 616;"></p>
<p>那么由此就可以推断出这个方法是由 dex 动态加载的</p>
<p>我们可以使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hsdXdhL2ZyaWRhLWRleGR1bXA="> frida-dexdump</span> 来把内存中的 dex 给 dump 下来，要注意 frida 的端口已经被我们修改为了 <code>1234</code> , 所以这里也要加上 <code>-H</code>  参数</p>
<p><img data-src="/sec-2023/image-20230830001101633.png" alt="image-20230830001101633" style="aspect-ratio:1683 / 875;"></p>
<p>将所有 dex dump 下来之后，接下来的步骤就是把这些 dex 一个一个拖进 jadx 里面反编译，去看看哪一个 dex 包含 <code>encrypt</code>  方法</p>
<p><img data-src="/sec-2023/image-20230830001653193.png" alt="image-20230830001653193" style="aspect-ratio:1920 / 1079;"></p>
<p>这个控制流一眼看上去就是加了混淆的，据 FallW1nd 师傅说是 <code>BlackObfuscator</code>  混淆，本来准备去手工分析的，但是想起前几天刚下载了 Jeb5.1, 就想看看新工具的效果怎样</p>
<p>当我用<span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjc4NDczLmh0bQ=="> Jeb5.1</span> 反编译这个 dex 之后，这 <code>BlackObfuscator</code>  混淆怎么就直接去除了？？？</p>
<p>好家伙这 Jeb5.1 竟然能自动去除控制流平坦化，crazy!</p>
<p><img data-src="/sec-2023/image-20230830022051922.png" alt="image-20230830022051922" style="aspect-ratio:1920 / 1080;"></p>
<p>那么这第二个加密的逻辑相当的清晰，算法如下</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> struct</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">def</span> <span class="token function">enc_2</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span>  <span class="token comment"># 字节再次翻转</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">input</span> <span class="token operator">>></span> <span class="token number">7</span> <span class="token operator">|</span> <span class="token builtin">input</span> <span class="token operator">&lt;&lt;</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    input_byte <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    xor_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">51</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">0x7C</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">102</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> xor_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>input_byte<span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">def</span> <span class="token function">dec_2</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    input_byte <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    xor_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">51</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">0x7C</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">102</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> xor_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>input_byte<span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">input</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span> <span class="token operator">|</span> <span class="token builtin">input</span> <span class="token operator">>></span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span>  <span class="token comment"># 字节再次翻转</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">input</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">def</span> <span class="token function">mytest_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token string">b'\xe3\xd5\x39\x39\xcc\xca\x94\x6d'</span><span class="token punctuation">,</span><span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    input_low<span class="token punctuation">,</span> input_high <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'>2I'</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 实现 bswap32</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment"># 验证加密算法</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    input_high <span class="token operator">=</span> enc_2<span class="token punctuation">(</span>input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">assert</span> input_high<span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">b'\xaa\x17\xd8\x10'</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    input_low <span class="token operator">=</span> enc_2<span class="token punctuation">(</span>input_low<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">assert</span> input_low<span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">b'\xf4\xc0\x8e\x36'</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment"># 验证解密算法</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    input_high <span class="token operator">=</span> dec_2<span class="token punctuation">(</span>input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    input_low <span class="token operator">=</span> dec_2<span class="token punctuation">(</span>input_low<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'>2I'</span><span class="token punctuation">,</span> input_low<span class="token punctuation">,</span> input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">assert</span> <span class="token builtin">input</span> <span class="token operator">==</span> <span class="token string">b'\xe3\xd5\x39\x39\xcc\xca\x94\x6d'</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>mytest_2<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="总览第二处加密-sub_3b8cc"><a class="anchor" href="#总览第二处加密-sub_3b8cc">#</a> 总览第二处加密 sub_3B8CC</h1>
<p><img data-src="/sec-2023/image-20230830033519965.png" alt="image-20230830033519965" style="aspect-ratio:1213 / 607;"></p>
<p>我们可以 hook 一下第二次加密前后输入的变化</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//hook sub_3B8CC, 观察传入的参数</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_3B8CC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 获取模块</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libsec2023.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 转为函数地址</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">var</span> addr<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"0x3B8CC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 获取函数入口</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">var</span> func <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] hook '</span><span class="token operator">+</span>func<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 函数 hook 钩子附加</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"\nbefore sub_3B8CC: "</span><span class="token punctuation">,</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            </pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"after sub_3B8CC: "</span><span class="token punctuation">,</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/sec-2023/image-20230830064031273.png" alt="image-20230830064031273" style="aspect-ratio:965 / 125;"></p>
<h1 id="回到libil2cppso中"><a class="anchor" href="#回到libil2cppso中">#</a> 回到 <code>libil2cpp.so</code>  中</h1>
<p>我们在 <code>sub_31164</code>  中去 hook 最后的 <code>br x2</code>  跳转来观察之后跳转到了哪一个函数中</p>
<p><img data-src="/sec-2023/image-20230830065454042.png" alt="image-20230830065454042" style="aspect-ratio:725 / 542;"></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">addr_in_so</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> process_Obj_Module_Arr <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">enumerateModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> process_Obj_Module_Arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 包含 "lib" 字符串的</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"lib"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>addr<span class="token operator">></span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base <span class="token operator">&amp;&amp;</span> addr<span class="token operator">&lt;</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"位于"</span><span class="token punctuation">,</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">"中"</span><span class="token punctuation">,</span><span class="token string">"offset: "</span><span class="token punctuation">,</span><span class="token punctuation">(</span>addr<span class="token operator">-</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">//hook sub_311A0, 查看 BR X2 跳转的地址</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_311A0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 获取模块</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libsec2023.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 转为函数地址</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">var</span> addr<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"0x311A0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 获取函数入口</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">var</span> func <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">NativePointer</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] hook '</span><span class="token operator">+</span>func<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 函数 hook 钩子附加</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    </pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token function">addr_in_so</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token comment">//console.log(hexdump(retval));</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>可见在 <code>libsec2023.so</code>  中经过两次加密之后，apk 回到了 <code>libil2cpp.so</code>  中</p>
<p><img data-src="/sec-2023/image-20230830065541513.png" alt="image-20230830065541513" style="aspect-ratio:946 / 100;"></p>
<h1 id="分析libil2cppso偏移为0x138d64处"><a class="anchor" href="#分析libil2cppso偏移为0x138d64处">#</a> 分析 libil2cpp.so 偏移为 0x138d64 处</h1>
<p>偏移 <code>0x138d64</code>  加上原来 so 的基址后，定位到了这个地方</p>
<p><img data-src="/sec-2023/image-20230830070108643.png" alt="image-20230830070108643" style="aspect-ratio:1193 / 235;"></p>
<p>B 跳转过去发现并不是一个函数，而是 <code>FUNCTION CHUNK</code></p>
<p><img data-src="/sec-2023/image-20230830070631442.png" alt="image-20230830070631442" style="aspect-ratio:1505 / 863;"></p>
<p>那先修改一下 <code>.init_proc</code>  的 <code>End address</code></p>
<p><img data-src="/sec-2023/image-20230830070942449.png" alt="image-20230830070942449" style="aspect-ratio:1472 / 847;"></p>
<p>然后回到之前 <code>chunk function</code>  的位置，按下 <code>P</code>  让 IDA 分析出函数，就可以看伪代码继续分析了</p>
<h1 id="加密三-vm指令分析"><a class="anchor" href="#加密三-vm指令分析">#</a> 加密三 vm 指令分析</h1>
<p>这个类的名称被 <code>o</code> , <code>O</code> , <code>0</code>  给混淆了，导致难以分辨类和变量，所以需要为这些类和变量进行重命名</p>
<p><img data-src="/sec-2023/image-20230830091801333.png" alt="image-20230830091801333" style="aspect-ratio:1314 / 447;"></p>
<p>在看看其他函数，这最后的 <code>v6 + v8 + (v6 | ~v8) + (v8 ^ v6) - (v6 &amp; ~v8) + 1</code>  看起来是 MBA 表达式</p>
<p><img data-src="/sec-2023/image-20230830091847819.png" alt="image-20230830091847819" style="aspect-ratio:1545 / 513;"></p>
<p>在 github 找个工具<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0RlbnV2b1NvZnR3YXJlU29sdXRpb25zL0dBTUJB"> GAMBA</span> 简化一下，有些表达式要分开简化效果才好，这里 <code>4294967296=0x100000000</code>  已经溢出 32 位了，所以 <code>4294967296+v8=v8</code></p>
<p><img data-src="/sec-2023/image-20230830101119023.png" alt="image-20230830101119023" style="aspect-ratio:1587 / 329;"></p>
<p>重命名函数之后，很明显发现这个加密算法应该和 VM 指令相关</p>
<p><img data-src="/sec-2023/image-20230830102759333.png" alt="image-20230830102759333" style="aspect-ratio:1334 / 530;"></p>
<p>我们回到类的初始化函数 <code>ctor</code>  完成之后，下一个要调用的函数 <code>OO0OoOOo_Oo0__oOOoO0o0</code></p>
<p><img data-src="/sec-2023/image-20230830105402607.png" alt="image-20230830105402607" style="aspect-ratio:1158 / 350;"></p>
<p>进入该函数，又是经典的 <code>while(1)</code>  循环，那么在这个循环里面，必定会出现 <code>eip</code>  和 <code>opcode</code> , 这两个分别对应着 <code>this-&gt;fields.oOOO0Oo0</code>  和 <code>U16_arr</code> , 我们重命名之</p>
<p><img data-src="/sec-2023/image-20230830105501678.png" alt="image-20230830105501678" style="aspect-ratio:1112 / 852;"></p>
<p>之后，我们以 <code>add</code>  函数为例分析其他全局变量的含义，这里对应的 vm 指令应该为 <code>add uS_arr[bbb], uS_arr[bbb], uS_arr[bbb+1]</code></p>
<p><img data-src="/sec-2023/image-20230830102726283.png" alt="image-20230830102726283" style="aspect-ratio:1372 / 503;"></p>
<p>到这里可能会有人纠结 <code>uS_arr</code>  究竟代表寄存器还是代表栈呢？我们回到初始化函数中，发现变量 <code>bbb</code>  所赋的初值为 <code>-1</code> , 那么由此可以确定， <code>uS_arr</code>  代表的是栈，而 <code>bbb</code>  则表示 <code>esp</code></p>
<p><img data-src="/sec-2023/image-20230830110257781.png" alt="image-20230830110257781" style="aspect-ratio:1341 / 466;"></p>
<p>至此为止，vm 所需的关键变量我们均已经分析清楚了</p>
<p><img data-src="/sec-2023/image-20230830110454534.png" alt="image-20230830110454534" style="aspect-ratio:1347 / 186;"></p>
<p>接下来就可以分析 vm 虚拟机了，对于 vm 类题型，我们只需要找到 vm 指令中的加减乘除位运算的位置和输入输出是多少就够了，别的指令比如 <code>push</code> , <code>pop</code> , <code>mov</code> ,opcode 是多少，opcode 是如何被 vm 读取等等这些问题都不需要考虑，因为在 vm 中，所有的 vm 指令的最终目的都是为了对输入的值进行操作，我们知道了这些加密运算，那么逆运算自然是信手拈来</p>
<p>所以在这里，我们可以用 frida 去 hook 一下运算相关的指令</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//hook vm</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_vm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libil2cpp.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">var</span> my_base <span class="token operator">=</span> <span class="token number">0x712a997000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">var</span> esp<span class="token punctuation">,</span>ptr_esp<span class="token punctuation">,</span>eip<span class="token punctuation">,</span>ptr_eip<span class="token punctuation">,</span>opcode<span class="token punctuation">,</span>input<span class="token punctuation">,</span>stack<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">var</span> addr_run<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x712AE01D44</span><span class="token operator">-</span>my_base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>addr_run<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            opcode <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            input <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x1c</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            stack <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x1c</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            ptr_esp <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            ptr_eip <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x2c</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"====start vm===="</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"input["</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">"]=0x"</span><span class="token operator">+</span>input<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token punctuation">&#125;</span>       </pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"====end vm===="</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">var</span> addr_add<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x712AE01E50</span><span class="token operator">-</span>my_base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>addr_add<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            esp<span class="token operator">=</span>ptr_esp<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            eip<span class="token operator">=</span>ptr_eip<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"stack["</span><span class="token operator">+</span>esp<span class="token operator">+</span><span class="token string">"]=0x"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>esp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"+"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token punctuation">(</span>esp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">var</span> addr_sub<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x712AE01ECC</span><span class="token operator">-</span>my_base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>addr_sub<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            esp<span class="token operator">=</span>ptr_esp<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            eip<span class="token operator">=</span>ptr_eip<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"stack["</span><span class="token operator">+</span>esp<span class="token operator">+</span><span class="token string">"]=0x"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>esp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"-"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token punctuation">(</span>esp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">var</span> addr_mul<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x712AE01F44</span><span class="token operator">-</span>my_base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>addr_mul<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            esp<span class="token operator">=</span>ptr_esp<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            eip<span class="token operator">=</span>ptr_eip<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"stack["</span><span class="token operator">+</span>esp<span class="token operator">+</span><span class="token string">"]=0x"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>esp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"*"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token punctuation">(</span>esp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">var</span> addr_Lshift<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x712AE01FC4</span><span class="token operator">-</span>my_base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>addr_Lshift<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            esp<span class="token operator">=</span>ptr_esp<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            eip<span class="token operator">=</span>ptr_eip<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"stack["</span><span class="token operator">+</span>esp<span class="token operator">+</span><span class="token string">"]=0x"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>esp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"&lt;&lt;"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token punctuation">(</span>esp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">var</span> addr_Rshift<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x712AE02040</span><span class="token operator">-</span>my_base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>addr_Rshift<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            esp<span class="token operator">=</span>ptr_esp<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            eip<span class="token operator">=</span>ptr_eip<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"stack["</span><span class="token operator">+</span>esp<span class="token operator">+</span><span class="token string">"]=0x"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>esp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">">>"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token punctuation">(</span>esp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">var</span> addr_and<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x712AE020BC</span><span class="token operator">-</span>my_base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>addr_and<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>            esp<span class="token operator">=</span>ptr_esp<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            eip<span class="token operator">=</span>ptr_eip<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"stack["</span><span class="token operator">+</span>esp<span class="token operator">+</span><span class="token string">"]=0x"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>esp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"&amp;"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token punctuation">(</span>esp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="87"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token keyword">var</span> addr_xor<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x712AE0213C</span><span class="token operator">-</span>my_base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>addr_xor<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>            esp<span class="token operator">=</span>ptr_esp<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>            eip<span class="token operator">=</span>ptr_eip<span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"stack["</span><span class="token operator">+</span>esp<span class="token operator">+</span><span class="token string">"]=0x"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>esp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"^"</span><span class="token operator">+</span>stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token punctuation">(</span>esp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readS32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="98"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>输出以及分析如下</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span>start vm<span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="2"></td><td><pre>input<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10d817aa</span><span class="token comment">// 输入的低 32 位</span></pre></td></tr><tr><td data-num="3"></td><td><pre>input<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x368ec0f4</span><span class="token comment">// 输入的高 32 位</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 低 32 位进行 vm 加密</span></pre></td></tr><tr><td data-num="5"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10d817aa</span><span class="token operator">>></span><span class="token number">24</span></pre></td></tr><tr><td data-num="6"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10</span><span class="token operator">&amp;</span><span class="token number">255</span><span class="token comment">// 取出第 4 个字节，即 0x10, 方便起见，记为 byte4</span></pre></td></tr><tr><td data-num="7"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x18</span><span class="token operator">-</span><span class="token number">8</span></pre></td></tr><tr><td data-num="8"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10d817aa</span><span class="token operator">>></span><span class="token number">16</span></pre></td></tr><tr><td data-num="9"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10d8</span><span class="token operator">&amp;</span><span class="token number">255</span><span class="token comment">// 取出第 3 个字节，即 0xd8, 记为 byte3</span></pre></td></tr><tr><td data-num="10"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10</span><span class="token operator">-</span><span class="token number">8</span></pre></td></tr><tr><td data-num="11"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10d817aa</span><span class="token operator">>></span><span class="token number">8</span></pre></td></tr><tr><td data-num="12"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10d817</span><span class="token operator">&amp;</span><span class="token number">255</span><span class="token comment">// 取出第 2 个字节，即 0x17, 记为 byte2</span></pre></td></tr><tr><td data-num="13"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x8</span><span class="token operator">-</span><span class="token number">8</span></pre></td></tr><tr><td data-num="14"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10d817aa</span><span class="token operator">>></span><span class="token number">0</span></pre></td></tr><tr><td data-num="15"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10d817aa</span><span class="token operator">&amp;</span><span class="token number">255</span><span class="token comment">// 取出第 1 个字节，即 0xaa, 记为 byte1</span></pre></td></tr><tr><td data-num="16"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0</span><span class="token operator">-</span><span class="token number">8</span></pre></td></tr><tr><td data-num="17"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xaa</span><span class="token operator">-</span><span class="token number">27</span><span class="token comment">//byte1=byte1-27=0x8f</span></pre></td></tr><tr><td data-num="18"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x17</span><span class="token operator">^</span><span class="token number">194</span><span class="token comment">//byte2=byte2^194=0xd5</span></pre></td></tr><tr><td data-num="19"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xd8</span><span class="token operator">+</span><span class="token number">168</span><span class="token comment">//byte3=byte3+168=0x180</span></pre></td></tr><tr><td data-num="20"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10</span><span class="token operator">^</span><span class="token number">54</span><span class="token comment">//byte4=byte4^54=0x26</span></pre></td></tr><tr><td data-num="21"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x8f</span><span class="token operator">^</span><span class="token number">0</span><span class="token comment">//byte1^0</span></pre></td></tr><tr><td data-num="22"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x8f</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token comment">//byte1&lt;&lt;0</span></pre></td></tr><tr><td data-num="23"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xff</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span></pre></td></tr><tr><td data-num="24"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x8f</span><span class="token operator">&amp;</span><span class="token number">255</span></pre></td></tr><tr><td data-num="25"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x8f</span><span class="token operator">+</span><span class="token number">0</span></pre></td></tr><tr><td data-num="26"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x4</span><span class="token operator">+</span><span class="token number">1</span></pre></td></tr><tr><td data-num="27"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0</span><span class="token operator">+</span><span class="token number">8</span></pre></td></tr><tr><td data-num="28"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xd5</span><span class="token operator">^</span><span class="token number">8</span><span class="token comment">//byte2^8</span></pre></td></tr><tr><td data-num="29"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdd</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token comment">//byte2&lt;&lt;8</span></pre></td></tr><tr><td data-num="30"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xff</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span></pre></td></tr><tr><td data-num="31"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdd00</span><span class="token operator">&amp;</span><span class="token number">65280</span></pre></td></tr><tr><td data-num="32"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xdd00</span><span class="token operator">+</span><span class="token number">143</span></pre></td></tr><tr><td data-num="33"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x5</span><span class="token operator">+</span><span class="token number">1</span></pre></td></tr><tr><td data-num="34"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x8</span><span class="token operator">+</span><span class="token number">8</span></pre></td></tr><tr><td data-num="35"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x180</span><span class="token operator">^</span><span class="token number">16</span><span class="token comment">//byte3^16</span></pre></td></tr><tr><td data-num="36"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x190</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token comment">//byte3&lt;&lt;16</span></pre></td></tr><tr><td data-num="37"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xff</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span></pre></td></tr><tr><td data-num="38"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x1900000</span><span class="token operator">&amp;</span><span class="token number">16711680</span></pre></td></tr><tr><td data-num="39"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x900000</span><span class="token operator">+</span><span class="token number">56719</span></pre></td></tr><tr><td data-num="40"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x6</span><span class="token operator">+</span><span class="token number">1</span></pre></td></tr><tr><td data-num="41"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10</span><span class="token operator">+</span><span class="token number">8</span></pre></td></tr><tr><td data-num="42"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x26</span><span class="token operator">^</span><span class="token number">24</span><span class="token comment">//byte4^24</span></pre></td></tr><tr><td data-num="43"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x3e</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token comment">//byte4&lt;&lt;24</span></pre></td></tr><tr><td data-num="44"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xff</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span></pre></td></tr><tr><td data-num="45"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x3e000000</span><span class="token operator">&amp;</span><span class="token operator">-</span><span class="token number">16777216</span></pre></td></tr><tr><td data-num="46"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x3e000000</span><span class="token operator">+</span><span class="token number">9493903</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment">// 高 32 位进行 vm 加密</span></pre></td></tr><tr><td data-num="50"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7</span><span class="token operator">+</span><span class="token number">1</span></pre></td></tr><tr><td data-num="51"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x18</span><span class="token operator">+</span><span class="token number">8</span></pre></td></tr><tr><td data-num="52"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x368ec0f4</span><span class="token operator">>></span><span class="token number">24</span><span class="token comment">// 取出第 4 个字节，即 0x36, 记为 byte4</span></pre></td></tr><tr><td data-num="53"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x36</span><span class="token operator">&amp;</span><span class="token number">255</span></pre></td></tr><tr><td data-num="54"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x18</span><span class="token operator">-</span><span class="token number">8</span></pre></td></tr><tr><td data-num="55"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x368ec0f4</span><span class="token operator">>></span><span class="token number">16</span><span class="token comment">// 取出第 3 个字节，即 0x8e, 记为 byte3</span></pre></td></tr><tr><td data-num="56"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x368e</span><span class="token operator">&amp;</span><span class="token number">255</span></pre></td></tr><tr><td data-num="57"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10</span><span class="token operator">-</span><span class="token number">8</span></pre></td></tr><tr><td data-num="58"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x368ec0f4</span><span class="token operator">>></span><span class="token number">8</span><span class="token comment">// 取出第 2 个字节，即 0xc0, 记为 byte2</span></pre></td></tr><tr><td data-num="59"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x368ec0</span><span class="token operator">&amp;</span><span class="token number">255</span></pre></td></tr><tr><td data-num="60"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x8</span><span class="token operator">-</span><span class="token number">8</span></pre></td></tr><tr><td data-num="61"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x368ec0f4</span><span class="token operator">>></span><span class="token number">0</span><span class="token comment">// 取出第 1 个字节，即 0xf4, 记为 byte1</span></pre></td></tr><tr><td data-num="62"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x368ec0f4</span><span class="token operator">&amp;</span><span class="token number">255</span></pre></td></tr><tr><td data-num="63"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0</span><span class="token operator">-</span><span class="token number">8</span></pre></td></tr><tr><td data-num="64"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xf4</span><span class="token operator">-</span><span class="token number">47</span><span class="token comment">//byte1=byte1-47=0xc5</span></pre></td></tr><tr><td data-num="65"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xc0</span><span class="token operator">^</span><span class="token number">182</span><span class="token comment">//byte2=byte2^182=0x76</span></pre></td></tr><tr><td data-num="66"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x8e</span><span class="token operator">+</span><span class="token number">55</span><span class="token comment">//byte3=byte3+55=0xc5</span></pre></td></tr><tr><td data-num="67"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x36</span><span class="token operator">^</span><span class="token number">152</span><span class="token comment">//byte4=byte4^152=0xae</span></pre></td></tr><tr><td data-num="68"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xc5</span><span class="token operator">+</span><span class="token number">0</span><span class="token comment">//byte1+0</span></pre></td></tr><tr><td data-num="69"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xc5</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token comment">//byte1&lt;&lt;0</span></pre></td></tr><tr><td data-num="70"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xff</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span></pre></td></tr><tr><td data-num="71"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xc5</span><span class="token operator">&amp;</span><span class="token number">255</span></pre></td></tr><tr><td data-num="72"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xc5</span><span class="token operator">+</span><span class="token number">0</span></pre></td></tr><tr><td data-num="73"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x4</span><span class="token operator">+</span><span class="token number">1</span></pre></td></tr><tr><td data-num="74"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x0</span><span class="token operator">+</span><span class="token number">8</span></pre></td></tr><tr><td data-num="75"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x76</span><span class="token operator">+</span><span class="token number">8</span><span class="token comment">//byte2+8</span></pre></td></tr><tr><td data-num="76"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7e</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token comment">//byte2&lt;&lt;8</span></pre></td></tr><tr><td data-num="77"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xff</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span></pre></td></tr><tr><td data-num="78"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7e00</span><span class="token operator">&amp;</span><span class="token number">65280</span></pre></td></tr><tr><td data-num="79"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7e00</span><span class="token operator">+</span><span class="token number">197</span></pre></td></tr><tr><td data-num="80"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x5</span><span class="token operator">+</span><span class="token number">1</span></pre></td></tr><tr><td data-num="81"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x8</span><span class="token operator">+</span><span class="token number">8</span></pre></td></tr><tr><td data-num="82"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xc5</span><span class="token operator">+</span><span class="token number">16</span><span class="token comment">//byte3+16</span></pre></td></tr><tr><td data-num="83"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xd5</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token comment">//byte3&lt;&lt;16</span></pre></td></tr><tr><td data-num="84"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xff</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span></pre></td></tr><tr><td data-num="85"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xd50000</span><span class="token operator">&amp;</span><span class="token number">16711680</span></pre></td></tr><tr><td data-num="86"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xd50000</span><span class="token operator">+</span><span class="token number">32453</span></pre></td></tr><tr><td data-num="87"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x6</span><span class="token operator">+</span><span class="token number">1</span></pre></td></tr><tr><td data-num="88"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x10</span><span class="token operator">+</span><span class="token number">8</span></pre></td></tr><tr><td data-num="89"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xae</span><span class="token operator">+</span><span class="token number">24</span><span class="token comment">//byte4+24</span></pre></td></tr><tr><td data-num="90"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xc6</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token comment">//byte&lt;&lt;24</span></pre></td></tr><tr><td data-num="91"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0xff</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span></pre></td></tr><tr><td data-num="92"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>x<span class="token operator">-</span><span class="token number">3</span>a000000<span class="token operator">&amp;</span><span class="token operator">-</span><span class="token number">16777216</span></pre></td></tr><tr><td data-num="93"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>x<span class="token operator">-</span><span class="token number">3</span>a000000<span class="token operator">+</span><span class="token number">13991621</span></pre></td></tr><tr><td data-num="94"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x7</span><span class="token operator">+</span><span class="token number">1</span></pre></td></tr><tr><td data-num="95"></td><td><pre>stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x18</span><span class="token operator">+</span><span class="token number">8</span></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token operator">==</span><span class="token operator">==</span>end vm<span class="token operator">==</span><span class="token operator">==</span></pre></td></tr><tr><td data-num="97"></td><td><pre>input<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x3e90dd8f</span></pre></td></tr><tr><td data-num="98"></td><td><pre>input<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>x<span class="token operator">-</span><span class="token number">392</span>a813b<span class="token comment">// 无符号 int 对应的是 0xc6d57ec5</span></pre></td></tr></table></figure><p>由此可见，这个 vm 其实相当的简单</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> struct</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">def</span> <span class="token function">enc_vm_low</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    byte4<span class="token punctuation">,</span> byte3<span class="token punctuation">,</span> byte2<span class="token punctuation">,</span> byte1 <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">">4B"</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    byte1 <span class="token operator">=</span> <span class="token punctuation">(</span>byte1 <span class="token operator">-</span> <span class="token number">27</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    byte2 <span class="token operator">=</span> <span class="token punctuation">(</span>byte2 <span class="token operator">^</span> <span class="token number">194</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">8</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    byte3 <span class="token operator">=</span> <span class="token punctuation">(</span>byte3 <span class="token operator">+</span> <span class="token number">168</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">16</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    byte4 <span class="token operator">=</span> <span class="token punctuation">(</span>byte4 <span class="token operator">^</span> <span class="token number">54</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">24</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">">4B"</span><span class="token punctuation">,</span> byte1 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte2 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte3 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte4 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">def</span> <span class="token function">dec_vm_low</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    byte4<span class="token punctuation">,</span> byte3<span class="token punctuation">,</span> byte2<span class="token punctuation">,</span> byte1 <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">">4B"</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    byte1 <span class="token operator">=</span> <span class="token punctuation">(</span>byte1 <span class="token operator">^</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">27</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    byte2 <span class="token operator">=</span> <span class="token punctuation">(</span>byte2 <span class="token operator">^</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">194</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    byte3 <span class="token operator">=</span> <span class="token punctuation">(</span>byte3 <span class="token operator">^</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">168</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    byte4 <span class="token operator">=</span> <span class="token punctuation">(</span>byte4 <span class="token operator">^</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">54</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">">4B"</span><span class="token punctuation">,</span> byte1 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte2 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte3 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte4 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">def</span> <span class="token function">enc_vm_high</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    byte4<span class="token punctuation">,</span> byte3<span class="token punctuation">,</span> byte2<span class="token punctuation">,</span> byte1 <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">">4B"</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    byte1 <span class="token operator">=</span> <span class="token punctuation">(</span>byte1 <span class="token operator">-</span> <span class="token number">47</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    byte2 <span class="token operator">=</span> <span class="token punctuation">(</span>byte2 <span class="token operator">^</span> <span class="token number">182</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    byte3 <span class="token operator">=</span> <span class="token punctuation">(</span>byte3 <span class="token operator">+</span> <span class="token number">55</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">16</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    byte4 <span class="token operator">=</span> <span class="token punctuation">(</span>byte4 <span class="token operator">^</span> <span class="token number">152</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">24</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">">4B"</span><span class="token punctuation">,</span> byte1 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte2 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte3 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte4 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">def</span> <span class="token function">dec_vm_high</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    byte4<span class="token punctuation">,</span> byte3<span class="token punctuation">,</span> byte2<span class="token punctuation">,</span> byte1 <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">">4B"</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    byte1 <span class="token operator">=</span> <span class="token punctuation">(</span>byte1 <span class="token operator">-</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">47</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    byte2 <span class="token operator">=</span> <span class="token punctuation">(</span>byte2 <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">182</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    byte3 <span class="token operator">=</span> <span class="token punctuation">(</span>byte3 <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">55</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    byte4 <span class="token operator">=</span> <span class="token punctuation">(</span>byte4 <span class="token operator">-</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">152</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">">4B"</span><span class="token punctuation">,</span> byte1 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte2 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte3 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte4 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token keyword">def</span> <span class="token function">mytest_3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    input_high <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token string">b'\xaa\x17\xd8\x10'</span><span class="token punctuation">,</span><span class="token string">'big'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    input_low <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token string">b'\xf4\xc0\x8e\x36'</span><span class="token punctuation">,</span><span class="token string">'big'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    input_high<span class="token punctuation">,</span> input_low <span class="token operator">=</span> input_low<span class="token punctuation">,</span> input_high  <span class="token comment"># 对应 sub_3B8CC 最后 输入的高 / 低 32 位交换</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'>2I'</span><span class="token punctuation">,</span> input_low<span class="token punctuation">,</span> input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token comment"># 验证加密算法</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    input_low<span class="token punctuation">,</span> input_high <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'&lt;2I'</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    input_low <span class="token operator">=</span> enc_vm_low<span class="token punctuation">(</span>input_low<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">assert</span> input_low <span class="token operator">==</span> <span class="token number">0x3e90dd8f</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    input_high <span class="token operator">=</span> enc_vm_high<span class="token punctuation">(</span>input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">assert</span> input_high <span class="token operator">==</span> <span class="token number">0xc6d57ec5</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment"># 验证解密算法</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    input_low <span class="token operator">=</span> dec_vm_low<span class="token punctuation">(</span>input_low<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token keyword">assert</span> input_low <span class="token operator">==</span> <span class="token number">0x10d817aa</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    input_high <span class="token operator">=</span> dec_vm_high<span class="token punctuation">(</span>input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">assert</span> input_high <span class="token operator">==</span> <span class="token number">0x368ec0f4</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>mytest_3<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="加密四-xtea分析"><a class="anchor" href="#加密四-xtea分析">#</a> 加密四 xtea 分析</h1>
<p>这个算法一看就知道是 xtea, 那么需要知道的就只有 <code>v24</code>  这个密钥了</p>
<p><img data-src="/sec-2023/image-20230831064228955.png" alt="image-20230831064228955" style="aspect-ratio:1540 / 672;"></p>
<p>用 frida 把密钥 hook 下来</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//hook xtea 加密的 key</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_xtea_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 获取模块</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libil2cpp.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">var</span> my_base <span class="token operator">=</span> <span class="token number">0x712a997000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">var</span> addr_key<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x712ADFCC60</span><span class="token operator">-</span>my_base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 函数 hook 钩子附加</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>addr_key<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">hexdump</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x20<span class="token punctuation">,</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">// 相对偏移</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span><span class="token comment">//dump 的大小</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token literal-property property">header</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token literal-property property">ansi</span><span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/sec-2023/image-20230831065121629.png" alt="image-20230831065121629" style="aspect-ratio:1590 / 193;"></p>
<p>再把 xtea 加密之后的值也顺便 hook 下来</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//hook 所有加密完成之后的值，以及比较的值</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_final_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 获取模块</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libil2cpp.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">var</span> my_base <span class="token operator">=</span> <span class="token number">0x712a997000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">var</span> addr_final_check<span class="token operator">=</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x712ADFCD14</span><span class="token operator">-</span>my_base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 函数 hook 钩子附加</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>addr_final_check<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"result = "</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x0<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"result_low = "</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x21<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"result_high = "</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x22<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="/sec-2023/image-20230831070953192.png" alt="image-20230831070953192" style="aspect-ratio:1026 / 102;"></p>
<p>那么这部分的算法如下</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> ctypes</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">def</span> <span class="token function">enc_xtea</span><span class="token punctuation">(</span>input_low<span class="token punctuation">,</span> input_high<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    v0<span class="token punctuation">,</span> v1 <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_uint32<span class="token punctuation">(</span>input_low<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_uint32<span class="token punctuation">(</span>input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x7b777c63</span><span class="token punctuation">,</span> <span class="token number">0xc56f6bf2</span><span class="token punctuation">,</span> <span class="token number">0x2b670130</span><span class="token punctuation">,</span> <span class="token number">0x76abd7fe</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    delta <span class="token operator">=</span> <span class="token number">0x21524111</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    total1 <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_uint32<span class="token punctuation">(</span><span class="token number">0xBEEFBEEF</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    total2 <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_uint32<span class="token punctuation">(</span><span class="token number">0x9D9D7DDE</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        v0<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>value <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>v1<span class="token punctuation">.</span>value <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> v1<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>total1<span class="token punctuation">.</span>value <span class="token operator">-</span> key<span class="token punctuation">[</span>total1<span class="token punctuation">.</span>value <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        v1<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v0<span class="token punctuation">.</span>value <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>v0<span class="token punctuation">.</span>value <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> v0<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>total2<span class="token punctuation">.</span>value <span class="token operator">+</span> key<span class="token punctuation">[</span><span class="token punctuation">(</span>total2<span class="token punctuation">.</span>value <span class="token operator">>></span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        total1<span class="token punctuation">.</span>value <span class="token operator">-=</span> delta</pre></td></tr><tr><td data-num="14"></td><td><pre>        total2<span class="token punctuation">.</span>value <span class="token operator">-=</span> delta</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">return</span> v0<span class="token punctuation">.</span>value<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>value</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">def</span> <span class="token function">dec_xtea</span><span class="token punctuation">(</span>input_low<span class="token punctuation">,</span> input_high<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    v0<span class="token punctuation">,</span> v1 <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_uint32<span class="token punctuation">(</span>input_low<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_uint32<span class="token punctuation">(</span>input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x7b777c63</span><span class="token punctuation">,</span> <span class="token number">0xc56f6bf2</span><span class="token punctuation">,</span> <span class="token number">0x2b670130</span><span class="token punctuation">,</span> <span class="token number">0x76abd7fe</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    delta <span class="token operator">=</span> <span class="token number">0x21524111</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    total1 <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_uint32<span class="token punctuation">(</span><span class="token number">0xBEEFBEEF</span> <span class="token operator">-</span> <span class="token number">64</span> <span class="token operator">*</span> delta<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    total2 <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_uint32<span class="token punctuation">(</span><span class="token number">0x9D9D7DDE</span> <span class="token operator">-</span> <span class="token number">64</span> <span class="token operator">*</span> delta<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        total1<span class="token punctuation">.</span>value <span class="token operator">+=</span> delta</pre></td></tr><tr><td data-num="26"></td><td><pre>        total2<span class="token punctuation">.</span>value <span class="token operator">+=</span> delta</pre></td></tr><tr><td data-num="27"></td><td><pre>        v1<span class="token punctuation">.</span>value <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v0<span class="token punctuation">.</span>value <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>v0<span class="token punctuation">.</span>value <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> v0<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>total2<span class="token punctuation">.</span>value <span class="token operator">+</span> key<span class="token punctuation">[</span><span class="token punctuation">(</span>total2<span class="token punctuation">.</span>value <span class="token operator">>></span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        v0<span class="token punctuation">.</span>value <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>value <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>v1<span class="token punctuation">.</span>value <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> v1<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>total1<span class="token punctuation">.</span>value <span class="token operator">-</span> key<span class="token punctuation">[</span>total1<span class="token punctuation">.</span>value <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">return</span> v0<span class="token punctuation">.</span>value<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>value</pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">def</span> <span class="token function">mytest_4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    input_low <span class="token operator">=</span> <span class="token number">0x3e90dd8f</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    input_high <span class="token operator">=</span> <span class="token number">0xc6d57ec5</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment"># 验证加密算法</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    input_low<span class="token punctuation">,</span> input_high <span class="token operator">=</span> enc_xtea<span class="token punctuation">(</span>input_low<span class="token punctuation">,</span> input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">assert</span> <span class="token punctuation">(</span>input_low<span class="token punctuation">,</span> input_high<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token number">0xabba3c01</span><span class="token punctuation">,</span> <span class="token number">0x7223607f</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment"># 验证解密算法</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    input_low<span class="token punctuation">,</span> input_high <span class="token operator">=</span> dec_xtea<span class="token punctuation">(</span>input_low<span class="token punctuation">,</span> input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">assert</span> <span class="token punctuation">(</span>input_low<span class="token punctuation">,</span> input_high<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token number">0x3e90dd8f</span><span class="token punctuation">,</span> <span class="token number">0xc6d57ec5</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>mytest_4<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>至此为止，所有加密算法分析完毕</p>
<h1 id="注册机"><a class="anchor" href="#注册机">#</a> 注册机</h1>
<p>在所有的加密完成后，这里的 <code>result</code>  就是我们的 <code>token</code> , 加密的低 32 位和 <code>token</code>  比较，高 32 位和 <code>0</code>  比较</p>
<p><img data-src="/sec-2023/image-20230831072058487.png" alt="image-20230831072058487" style="aspect-ratio:858 / 164;"></p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> struct</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> ctypes</pre></td></tr><tr><td data-num="3"></td><td><pre>algorithm_1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"dec"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"dec"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">^</span> <span class="token number">0xd3</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"dec"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">94</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"dec"</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">^</span> <span class="token number">0x86</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">def</span> <span class="token function">dec_xtea</span><span class="token punctuation">(</span>input_low<span class="token punctuation">,</span> input_high<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    v0<span class="token punctuation">,</span> v1 <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_uint32<span class="token punctuation">(</span>input_low<span class="token punctuation">)</span><span class="token punctuation">,</span> ctypes<span class="token punctuation">.</span>c_uint32<span class="token punctuation">(</span>input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x7b777c63</span><span class="token punctuation">,</span> <span class="token number">0xc56f6bf2</span><span class="token punctuation">,</span> <span class="token number">0x2b670130</span><span class="token punctuation">,</span> <span class="token number">0x76abd7fe</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    delta <span class="token operator">=</span> <span class="token number">0x21524111</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    total1 <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_uint32<span class="token punctuation">(</span><span class="token number">0xBEEFBEEF</span><span class="token operator">-</span><span class="token number">64</span><span class="token operator">*</span>delta<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    total2 <span class="token operator">=</span> ctypes<span class="token punctuation">.</span>c_uint32<span class="token punctuation">(</span><span class="token number">0x9D9D7DDE</span><span class="token operator">-</span><span class="token number">64</span><span class="token operator">*</span>delta<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        total1<span class="token punctuation">.</span>value <span class="token operator">+=</span> delta</pre></td></tr><tr><td data-num="17"></td><td><pre>        total2<span class="token punctuation">.</span>value <span class="token operator">+=</span> delta</pre></td></tr><tr><td data-num="18"></td><td><pre>        v1<span class="token punctuation">.</span>value <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v0<span class="token punctuation">.</span>value <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>v0<span class="token punctuation">.</span>value <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> v0<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>total2<span class="token punctuation">.</span>value <span class="token operator">+</span> key<span class="token punctuation">[</span><span class="token punctuation">(</span>total2<span class="token punctuation">.</span>value <span class="token operator">>></span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        v0<span class="token punctuation">.</span>value <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>value <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>v1<span class="token punctuation">.</span>value <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> v1<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>total1<span class="token punctuation">.</span>value <span class="token operator">-</span> key<span class="token punctuation">[</span>total1<span class="token punctuation">.</span>value <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">return</span> v0<span class="token punctuation">.</span>value<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>value</pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">def</span> <span class="token function">dec_vm_low</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    byte4<span class="token punctuation">,</span> byte3<span class="token punctuation">,</span> byte2<span class="token punctuation">,</span> byte1 <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">">4B"</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    byte1 <span class="token operator">=</span> <span class="token punctuation">(</span>byte1 <span class="token operator">^</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">27</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    byte2 <span class="token operator">=</span> <span class="token punctuation">(</span>byte2 <span class="token operator">^</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">194</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    byte3 <span class="token operator">=</span> <span class="token punctuation">(</span>byte3 <span class="token operator">^</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">168</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    byte4 <span class="token operator">=</span> <span class="token punctuation">(</span>byte4 <span class="token operator">^</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">54</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">">4B"</span><span class="token punctuation">,</span> byte1 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte2 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte3 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte4 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">def</span> <span class="token function">dec_vm_high</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    byte4<span class="token punctuation">,</span> byte3<span class="token punctuation">,</span> byte2<span class="token punctuation">,</span> byte1 <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">">4B"</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    byte1 <span class="token operator">=</span> <span class="token punctuation">(</span>byte1 <span class="token operator">-</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">47</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    byte2 <span class="token operator">=</span> <span class="token punctuation">(</span>byte2 <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">182</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    byte3 <span class="token operator">=</span> <span class="token punctuation">(</span>byte3 <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">55</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    byte4 <span class="token operator">=</span> <span class="token punctuation">(</span>byte4 <span class="token operator">-</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">152</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">">4B"</span><span class="token punctuation">,</span> byte1 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte2 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte3 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> byte4 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token keyword">def</span> <span class="token function">dec_2</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    input_byte <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    xor_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">51</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">0x7C</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">102</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> xor_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>input_byte<span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">input</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span> <span class="token operator">|</span> <span class="token builtin">input</span> <span class="token operator">>></span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token builtin">input</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'big'</span><span class="token punctuation">)</span>  <span class="token comment"># 字节再次翻转</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">input</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token keyword">def</span> <span class="token function">dec_1</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    input_byte <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>input_byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        index <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>algorithm_1<span class="token punctuation">[</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token string">"dec"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">(</span>input_byte<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span> index<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> index</pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>input_byte<span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>token <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"enter the token plz~:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>input_low<span class="token punctuation">,</span>input_high <span class="token operator">=</span> token<span class="token punctuation">,</span><span class="token number">0</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment">#xtea</span></pre></td></tr><tr><td data-num="64"></td><td><pre>input_low<span class="token punctuation">,</span>input_high<span class="token operator">=</span>dec_xtea<span class="token punctuation">(</span>input_low<span class="token punctuation">,</span> input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token comment">#vm</span></pre></td></tr><tr><td data-num="67"></td><td><pre>input_low<span class="token punctuation">,</span>input_high <span class="token operator">=</span> dec_vm_low<span class="token punctuation">(</span>input_low<span class="token punctuation">)</span><span class="token punctuation">,</span>dec_vm_high<span class="token punctuation">(</span>input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token comment">#bswap32</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token builtin">input</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'&lt;2I'</span><span class="token punctuation">,</span> input_low<span class="token punctuation">,</span> input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>input_low<span class="token punctuation">,</span> input_high <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'>2I'</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token comment">#高 / 低 32 位对调</span></pre></td></tr><tr><td data-num="74"></td><td><pre>input_low<span class="token punctuation">,</span> input_high<span class="token operator">=</span>input_high<span class="token punctuation">,</span> input_low</pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token comment">#blackObfuscator</span></pre></td></tr><tr><td data-num="77"></td><td><pre>input_high <span class="token operator">=</span> dec_2<span class="token punctuation">(</span>input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="78"></td><td><pre>input_low <span class="token operator">=</span> dec_2<span class="token punctuation">(</span>input_low<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token comment">#last decrypt</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token builtin">input</span> <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'>2I'</span><span class="token punctuation">,</span> input_low<span class="token punctuation">,</span> input_high<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token builtin">input</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span><span class="token string">'little'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token builtin">input</span> <span class="token operator">=</span> dec_1<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token comment">#output</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="参考资料"><a class="anchor" href="#参考资料">#</a> 参考资料</h1>
<ul>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNzEwODY4">ELF 文件格式的详解</span></p>
</li>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjc2OTQ5Lmh0bSNtc2dfaGVhZGVyX2gyXzA=">[原创] 2023 腾讯游戏安全竞赛初赛题解 (安卓)</span></p>
</li>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjc2ODk2Lmh0bSNtc2dfaGVhZGVyX2gyXzI=">[原创] 2023 腾讯游戏安全大赛 - 安卓赛道初赛 wp </span></p>
</li>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjc2ODkzLmh0bQ==">[原创] 腾讯游戏安全技术竞赛 2023 安卓客户端初赛 WriteUp</span></p>
</li>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODY2OTU2MS9hcnRpY2xlL2RldGFpbHMvMTA3Mjc5NTI4">ARMv8 (aarch64) 指令集特性</span></p>
</li>
</ul>

      <div class="tags">
          <a href="/tags/android/" rel="tag"><i class="ic i-tag"></i> android</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2025-04-09 02:55:11" itemprop="dateModified" datetime="2025-04-09T02:55:11+08:00">2025-04-09</time>
  </span>
  <span id="sec-2023/" class="item leancloud_visitors" data-flag-title="细品sec2023安卓赛题" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>oacia <i class="ic i-at"><em>@</em></i>oaciaのBbBlog~
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://oacia.dev/sec-2023/" title="细品sec2023安卓赛题">https://oacia.dev/sec-2023/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/idapython-learning/" itemprop="url" rel="prev" data-background-image="&#x2F;picture&#x2F;228579.webp" title="IDApython学习笔记">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>IDApython学习笔记</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/linux-socket-tcp-udp/" itemprop="url" rel="next" data-background-image="&#x2F;picture&#x2F;306656.webp" title="linux socket TCP&#x2F;UDP通信学习">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>linux socket TCP/UDP通信学习</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text"> 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9D%E6%8E%A2apk"><span class="toc-text"> 初探 apk</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E4%BD%BF%E7%94%A8il2cppdumper%E8%8E%B7%E5%8F%96%E7%AC%A6%E5%8F%B7%E4%BF%A1%E6%81%AF"><span class="toc-text"> 尝试使用 Il2CppDumper 获取符号信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dump%E8%A7%A3%E5%AF%86%E5%90%8E%E7%9A%84libil2cppso"><span class="toc-text"> dump 解密后的 libil2cpp.so</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E4%BD%BF%E7%94%A8il2cppdumper%E8%8E%B7%E5%8F%96%E7%AC%A6%E5%8F%B7%E4%BF%A1%E6%81%AF"><span class="toc-text"> 再次使用 Il2CppDumper 获取符号信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8Ddump%E4%B8%8B%E6%9D%A5%E7%9A%84so"><span class="toc-text"> 修复 dump 下来的 so</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%AD%A3-%E6%AE%B5segment-%E7%9A%84%E5%81%8F%E7%A7%BB"><span class="toc-text"> 修正 段 (segment) 的偏移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%AD%A3-%E8%8A%82%E5%A4%B4%E8%A1%A8secion-header-table-%E7%9A%84%E5%81%8F%E7%A7%BB"><span class="toc-text"> 修正 节头表 (secion header table) 的偏移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E8%A1%A5section%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-text"> 修补 section 的内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E8%8A%82section%E7%9A%84%E5%90%8D%E7%A7%B0"><span class="toc-text"> 恢复节 (section) 的名称</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%AD%A3-%E8%8A%82section-%E7%9A%84%E5%81%8F%E7%A7%BB"><span class="toc-text"> 修正 节 (section) 的偏移</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%A8ida%E4%B8%AD%E6%81%A2%E5%A4%8D%E7%AC%A6%E5%8F%B7"><span class="toc-text"> 在 IDA 中恢复符号</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%BB%E6%89%BEok%E6%8C%89%E9%92%AE%E8%B0%83%E7%94%A8%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-text"> 寻找 OK 按钮调用的函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5libsec2023so%E5%88%86%E6%9E%90"><span class="toc-text"> 进入 libsec2023.so 分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9libsec2023so%E6%89%93%E4%B8%8B%E7%A1%AC%E4%BB%B6%E6%96%AD%E7%82%B9"><span class="toc-text"> 对 libsec2023.so 打下硬件断点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#idapython%E5%8E%BB%E9%99%A4csel-brcset-br%E7%BB%93%E6%9E%84"><span class="toc-text"> IDApython 去除 CSEL-BR&#x2F;CSET-BR 结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E4%B8%80-%E5%9C%A8sub_3b9d4%E4%B8%AD"><span class="toc-text"> 加密一 在 sub_3B9D4 中</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%A8sub_3b9d4%E4%B9%8B%E5%90%8E-bswap32%E5%88%86%E6%9E%90"><span class="toc-text"> 在 sub_3B9D4 之后 bswap32 分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E4%BA%8C-blackobfuscator%E6%B7%B7%E6%B7%86"><span class="toc-text"> 加密二 BlackObfuscator 混淆</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E8%A7%88%E7%AC%AC%E4%BA%8C%E5%A4%84%E5%8A%A0%E5%AF%86-sub_3b8cc"><span class="toc-text"> 总览第二处加密 sub_3B8CC</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9E%E5%88%B0libil2cppso%E4%B8%AD"><span class="toc-text"> 回到 libil2cpp.so  中</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E6%9E%90libil2cppso%E5%81%8F%E7%A7%BB%E4%B8%BA0x138d64%E5%A4%84"><span class="toc-text"> 分析 libil2cpp.so 偏移为 0x138d64 处</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E4%B8%89-vm%E6%8C%87%E4%BB%A4%E5%88%86%E6%9E%90"><span class="toc-text"> 加密三 vm 指令分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E5%9B%9B-xtea%E5%88%86%E6%9E%90"><span class="toc-text"> 加密四 xtea 分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E6%9C%BA"><span class="toc-text"> 注册机</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text"> 参考资料</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="oacia"
      data-src="/images/avatar.jpg">
  
  <svg class="logo-overview" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 540.19 380.99">
    <g id="clips" fill= #00a99d; stroke="none">
      <clipPath id="o">
        <path d="M93.57,284c8,0,14.91-1,20.75-3,5.83-2,10.41-3.66,13.75-5,4.66-1.66,6.16-.75,4.5,2.75-1.67,3.5-4.67,6.42-9,8.75-2.34,1.34-6.09,2.84-11.25,4.5-5.17,1.67-11.09,2.5-17.75,2.5-.34,8.67-3.34,16.84-9,24.5-5.67,7.67-13.34,13.34-23,17-6,2.34-12.17,3.59-18.5,3.75-6.34,.17-12.17-.66-17.5-2.5-5.34-1.83-10.09-4.66-14.25-8.5-4.17-3.83-7.25-8.41-9.25-13.75-2-5.33-2.83-11-2.5-17s1.83-11.83,4.5-17.5c2.66-5.66,6.33-10.75,11-15.25,4.66-4.5,10.16-7.75,16.5-9.75,5.66-1.66,11.41-1.66,17.25,0,5.83,1.67,10.08,4.34,12.75,8,1.66,2.67,2.5,5.67,2.5,9,3-2,6.33-3,10-3h1c3.33,0,6.5,.84,9.5,2.5,3,1.67,5.33,4.5,7,8.5l1,3.5Zm-34,39.5c5.66-.66,10.33-3.83,14-9.5,3.66-5.66,5.33-12.16,5-19.5-4.67,.34-9.09-.41-13.25-2.25-4.17-1.83-6.42-4.58-6.75-8.25-.67-3,0-5.5,2-7.5-.67-2.66-2.75-5-6.25-7s-7.09-2.16-10.75-.5c-4.67,2-8.25,5.84-10.75,11.5-2.5,5.67-3.09,11.84-1.75,18.5,1.33,8,4.75,14.34,10.25,19,5.5,4.67,11.58,6.5,18.25,5.5Z"/>
      </clipPath>
      <clipPath id="a1">
        <path d="M176.06,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      <clipPath id="c">
        <path d="M250.06,280.5c4.66-7.66,12-13.16,22-16.5,10-3.33,19.83-3.66,29.5-1,7.66,2.34,13.5,5.67,17.5,10,4,4.34,5.83,8.5,5.5,12.5-.34,4.67-2.25,8.59-5.75,11.75-3.5,3.17-7.09,5.34-10.75,6.5-3.67,1.17-6.84,1.25-9.5,.25-2.67-1-3.34-3.16-2-6.5,2.66-8,2.75-14.58,.25-19.75-2.5-5.16-5.92-6.41-10.25-3.75-2.67,1.67-5,4.09-7,7.25-2,3.17-3.5,6.75-4.5,10.75s-1.42,8.09-1.25,12.25c.16,4.17,.75,7.92,1.75,11.25,1.33,4,3.66,7.42,7,10.25,3.33,2.84,7.16,4.67,11.5,5.5,4.33,.84,8.91,.67,13.75-.5,4.83-1.16,9.25-3.75,13.25-7.75,7.33-6.66,12.33-14.33,15-23,.33-1.66,1.16-2.91,2.5-3.75,1.33-.83,2.5-1.08,3.5-.75,1,.34,1.83,1.09,2.5,2.25,.66,1.17,.66,2.92,0,5.25-2.34,9.34-6.34,17-12,23-4.67,5.67-10.5,10.42-17.5,14.25-7,3.84-14.25,6.09-21.75,6.75-7.5,.67-14.84-.33-22-3-7.17-2.66-13.25-7.5-18.25-14.5-6-8.66-8.75-17.66-8.25-27,.5-9.33,2.25-16.66,5.25-22Z"/>
      </clipPath>
      <clipPath id="i_b">
        <path d="M393.06,330c-2.34,2.67-5.17,5.09-8.5,7.25-3.34,2.17-7.09,3.59-11.25,4.25-4.17,.67-8.59,.67-13.25,0-4.67-.66-9.17-2.33-13.5-5-4.67-2.66-7.67-7.58-9-14.75-1.34-7.16-1.83-14.66-1.5-22.5,.33-7.83,1.33-14.91,3-21.25,1.66-6.33,3.33-10.16,5-11.5,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,3.59,1.25,6.75-.17,3.17-.5,6.92-1,11.25-.5,4.34-1.09,8.92-1.75,13.75-.67,4.84-.67,9.42,0,13.75,.33,3.67,1.33,6.42,3,8.25,1.66,1.84,3.5,2.84,5.5,3,2,.17,4-.25,6-1.25s3.83-2.33,5.5-4c3-3.66,5.66-7.66,8-12,2.33-4.33,4.16-8.16,5.5-11.5,1-3.66,2.91-5.25,5.75-4.75,2.83,.5,3.75,3.09,2.75,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.34,8.59-10,14.25Z"/>
      </clipPath>
      <clipPath id="a2">
        <path d="M461.56,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      
    </g>
    <g
      id="strokes"
      fill="none"
      stroke=#96d7f5
      stroke-linecap="round"
      stroke-linejoin="round"
    >
    <path
    clip-path="url(#o)"
    class="oPath path"
    d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
    stroke-width="32.5"
    ></path>
    <path
      clip-path="url(#a1)"
      class="a1Path path"
      d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
      stroke-width="59"
    ></path>
    <path
      clip-path="url(#c)"
      class="cPath path"
      d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
      stroke-width="110"
    ></path>
    <path
      clip-path="url(#i_b)"
      class="i_bPath path"
      d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
      stroke-width="33"
    ></path>
    <path
      clip-path="url(#a2)"
      class="a2Path path"
      d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
      stroke-width="70"
    ></path>
    </g>
    <g
      id="strokes2"
      fill="none"
      stroke=#ff97b8
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path
        clip-path="url(#o)"
        class="oPath path"
        d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
        stroke-width="32.5"
      ></path>
      <path
        clip-path="url(#a1)"
        class="a1Path path"
        d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
        stroke-width="59"
      ></path>
      <path
        clip-path="url(#c)"
        class="cPath path"
        d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
        stroke-width="110"
      ></path>
      <path
        clip-path="url(#i_b)"
        class="i_bPath path"
        d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
        stroke-width="33"
      ></path>
      <path
        clip-path="url(#a2)"
        class="a2Path path"
        d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
        stroke-width="70"
      ></path>
    </g>
    <g class="dot-group">
      <path
        id="dot"
        fill=#ff97b8
        d="M362.58,182.21c4.66-.33,9.66,1.17,15,4.5,5.33,3.34,7.66,7.5,7,12.5-.67,2.34-1.92,4.92-3.75,7.75-1.84,2.84-4,5.5-6.5,8s-4.84,4.75-7,6.75c-2.17,2-3.75,3.17-4.75,3.5-2.67,1.67-5.34,2.25-8,1.75-2.67-.5-5-1.5-7-3s-3.59-3.33-4.75-5.5c-1.17-2.16-1.92-4.25-2.25-6.25-.34-2,.16-4.66,1.5-8,1.33-3.33,3.08-6.58,5.25-9.75,2.16-3.16,4.58-6,7.25-8.5,2.66-2.5,5.33-3.75,8-3.75Z"
      ></path>
    </g>
  </svg>
  <div class="description" itemprop="description">月遇从云 花遇和风</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">53</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">46</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lh" title="https:&#x2F;&#x2F;github.com&#x2F;oacia"><i class="ic i-github"></i></span>
      <a target="_blank" rel="noopener" href="https://twitter.com/oacia86" title="https:&#x2F;&#x2F;twitter.com&#x2F;oacia86" class="item twitter"><i class="ic i-twitter"></i></a>
      <span class="exturl item paper-plane" data-url="aHR0cHM6Ly90Lm1lL29hY2lh" title="https:&#x2F;&#x2F;t.me&#x2F;oacia"><i class="ic i-paper-plane"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOm9hY2lhODZAZ21haWwuY29t" title="mailto:oacia86@gmail.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about-oacia/" rel="section"><i class="ic i-user"></i>关于oacia</a>
  </li>

    
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-feather"></i>文章</a>
  </li>

    
  <li class="item">
    <a href="/TODOlist/" rel="section"><i class="ic i-clock"></i>要做的事</a>
  </li>

    
  <li class="item">
    <a href="/website_maintenance/" rel="section"><i class="ic i-calendar"></i>更新日志</a>
  </li>

    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>小伙伴</a>
  </li>

    
  <li class="item">
    <a href="/music/" rel="section"><i class="ic i-music"></i>听会儿歌吧</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/idapython-learning/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/linux-socket-tcp-udp/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2022 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">oacia @ oacia</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">968k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">14:40</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>



<script data-config type="text/javascript">
  var LOCAL = {
    path: 'sec-2023/',
    favicon: {
      show: "柚鳥ナツ",
      hide: "甘い幸せ"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>
<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>


<script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>
<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
