



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="qQVmgWozVe7BXoA15J3gAZpEA5dK168admH4U3W6PAk">
  <meta name="msvalidate.01" content="4902E39C0135E72DE537BCB0FE08B40A">
  <meta name="baidu-site-verification" content="codeva-CSYjpuVg5v">


<link rel="alternate" type="application/rss+xml" title="oaciaのBbBlog~" href="https://oacia.dev/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="oaciaのBbBlog~" href="https://oacia.dev/atom.xml" />
<link rel="alternate" type="application/json" title="oaciaのBbBlog~" href="https://oacia.dev/feed.json" />
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-regular.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-700.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/font_1832207_igi8uaupcus.woff2"
/>
<link rel="preload" href="/background_picture/1_gongzi.webp" as="image" />
<link rel="preload" href="/background_picture/2_xiaoxia.webp" as="image" />
<link rel="preload" href="/background_picture/3_xingye.webp" as="image" />
<link rel="preload" href="/images/avatar.jpg" as="image" />



<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="https://oacia.dev/android-load-so/">


<meta name="description" content="对于某些加固壳，加载解释器 elf 的方式不会是常规的 System.loadLibrary , 而是仿照 System.loadLibrary  在 AOSP 中的实现方式，在 JNI 中自己实现 so 的加载  本次所使用到的 AOSP 的源码的安卓版本为 android-12.0.0_r34 # so 的启动过程 # System.load 在 Android 中我们想要加载一个 so 时">
<meta property="og:type" content="article">
<meta property="og:title" content="安卓so加载流程源码分析">
<meta property="og:url" content="https://oacia.dev/android-load-so/">
<meta property="og:site_name" content="oaciaのBbBlog~">
<meta property="og:description" content="对于某些加固壳，加载解释器 elf 的方式不会是常规的 System.loadLibrary , 而是仿照 System.loadLibrary  在 AOSP 中的实现方式，在 JNI 中自己实现 so 的加载  本次所使用到的 AOSP 的源码的安卓版本为 android-12.0.0_r34 # so 的启动过程 # System.load 在 Android 中我们想要加载一个 so 时">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://oacia.dev/android-load-so/image-20240216214503902.png">
<meta property="og:image" content="https://oacia.dev/android-load-so/image-20240217132018399.png">
<meta property="og:image" content="https://oacia.dev/android-load-so/image-20240217131920074.png">
<meta property="og:image" content="https://oacia.dev/android-load-so/image-20240709133045436.png">
<meta property="og:image" content="https://oacia.dev/android-load-so/image-20240711144153063.png">
<meta property="article:published_time" content="2024-02-14T03:19:19.000Z">
<meta property="article:modified_time" content="2025-04-08T18:55:11.444Z">
<meta property="article:author" content="oacia">
<meta property="article:tag" content="reverse,安卓逆向,区块链,学习笔记,破解实战,前端,CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oacia.dev/android-load-so/image-20240216214503902.png">
<meta name="twitter:creator" content="@oacia86">


  <title>
安卓so加载流程源码分析 |
oacia = oaciaのBbBlog~ = DEVIL or SWEET</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  var jq_151 = $.noConflict(true);
  var RENDERER = {
    INIT_CHERRY_BLOSSOM_COUNT : 30,
    MAX_ADDING_INTERVAL : 10,
    WATCH_INTERVAL : 300,
    
    init : function(){
      this.setParameters();
      this.reconstructMethods();
      this.setup();
      this.bindEvent();
      this.render();
    },
    setParameters : function(){
      this.$window = jq_151(window);
      this.$container = jq_151('#loading');
      this.$canvas = jq_151('<canvas />');
      this.context = this.$canvas.appendTo(this.$container).get(0).getContext('2d');
      this.cherries = [];
      this.watchIds = [];
    },
    reconstructMethods : function(){
      this.watchWindowSize = this.watchWindowSize.bind(this);
      this.jdugeToStopResize = this.jdugeToStopResize.bind(this);
      this.render = this.render.bind(this);
    },
    setup : function(){
      this.cherries.length = 0;
      this.watchIds.length = 0;
      this.width = this.$container.width();
      this.height = this.$container.height();
      this.$canvas.attr({width : this.width, height : this.height});
      this.maxAddingInterval = Math.round(this.MAX_ADDING_INTERVAL * 1000 / this.width);
      this.addingInterval = this.maxAddingInterval;
      this.createCherries();
    },
    createCherries : function(){
      for(var i = 0, length = Math.round(this.INIT_CHERRY_BLOSSOM_COUNT * this.width / 1000); i < length; i++){
        this.cherries.push(new CHERRY_BLOSSOM(this, true));
      }
    },
    watchWindowSize : function(){
      this.clearTimer();
      this.tmpWidth = window.width;
      this.tmpHeight = window.height;
      this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL));
    },
    clearTimer : function(){
      while(this.watchIds.length > 0){
        clearTimeout(this.watchIds.pop());
      }
    },
    jdugeToStopResize : function(){
      var width = window.width,
        height = window.height,
        stopped = (width == this.tmpWidth && height == this.tmpHeight);
        
      this.tmpWidth = width;
      this.tmpHeight = height;
      
      if(stopped){
        this.setup();
      }
    },
    bindEvent : function(){
      this.$window.on('resize', this.watchWindowSize);
    },
    render : function(){
      //console.log("render")

      if(jq_151(this.$container).css("display")!="none"){
        requestAnimationFrame(this.render);
      }
      
      this.context.clearRect(0, 0, this.width, this.height);
      
      this.cherries.sort(function(cherry1, cherry2){
        return cherry1.z - cherry2.z;
      });
      for(var i = this.cherries.length - 1; i >= 0; i--){
        if(!this.cherries[i].render(this.context)){
          this.cherries.splice(i, 1);
        }
      }
      if(--this.addingInterval == 0){
        this.addingInterval = this.maxAddingInterval;
        this.cherries.push(new CHERRY_BLOSSOM(this, false));
      }
    }
  };
  var CHERRY_BLOSSOM = function(renderer, isRandom){
    this.renderer = renderer;
    this.init(isRandom);
  };
  CHERRY_BLOSSOM.prototype = {
    FOCUS_POSITION : 300,
    FAR_LIMIT : 600,
    MAX_RIPPLE_COUNT : 100,
    RIPPLE_RADIUS : 100,
    SURFACE_RATE : 0.5,
    SINK_OFFSET : 20,
    
    init : function(isRandom){
      this.x = this.getRandomValue(-this.renderer.width, this.renderer.width);
      this.y = isRandom ? this.getRandomValue(0, this.renderer.height) : this.renderer.height * 1.5;
      this.z = this.getRandomValue(0, this.FAR_LIMIT);
      this.vx = this.getRandomValue(-2, 2);
      this.vy = -2;
      this.theta = this.getRandomValue(0, Math.PI * 2);
      this.phi = this.getRandomValue(0, Math.PI * 2);
      this.psi = 0;
      this.dpsi = this.getRandomValue(Math.PI / 600, Math.PI / 300);
      this.opacity = 0;
      this.endTheta = false;
      this.endPhi = false;
      this.rippleCount = 0;
      
      var axis = this.getAxis(),
        theta = this.theta + Math.ceil(-(this.y + this.renderer.height * this.SURFACE_RATE) / this.vy) * Math.PI / 500;
      theta %= Math.PI * 2;
      
      this.offsetY = 40 * ((theta <= Math.PI / 2 || theta >= Math.PI * 3 / 2) ? -1 : 1);
      this.thresholdY = this.renderer.height / 2 + this.renderer.height * this.SURFACE_RATE * axis.rate;
      this.entityColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.entityColor.addColorStop(0, 'hsl(330, 70%, ' + 50 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(0.05, 'hsl(330, 40%,' + 55 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(1, 'hsl(330, 20%, ' + 70 * (0.3 + axis.rate) + '%)');
      this.shadowColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.shadowColor.addColorStop(0, 'hsl(330, 40%, ' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(0.05, 'hsl(330, 40%,' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(1, 'hsl(330, 20%, ' + 40 * (0.3 + axis.rate) + '%)');
    },
    getRandomValue : function(min, max){
      return min + (max - min) * Math.random();
    },
    getAxis : function(){
      var rate = this.FOCUS_POSITION / (this.z + this.FOCUS_POSITION),
        x = this.renderer.width / 2 + this.x * rate,
        y = this.renderer.height / 2 - this.y * rate;
      return {rate : rate, x : x, y : y};
    },
    renderCherry : function(context, axis){
      context.beginPath();
      context.moveTo(0, 40);
      context.bezierCurveTo(-60, 20, -10, -60, 0, -20);
      context.bezierCurveTo(10, -60, 60, 20, 0, 40);
      context.fill();
      
      for(var i = -4; i < 4; i++){
        context.beginPath();
        context.moveTo(0, 40);
        context.quadraticCurveTo(i * 12, 10, i * 4, -24 + Math.abs(i) * 2);
        context.stroke();
      }
    },
    render : function(context){
      var axis = this.getAxis();
      
      if(axis.y == this.thresholdY && this.rippleCount < this.MAX_RIPPLE_COUNT){
        context.save();
        context.lineWidth = 2;
        context.strokeStyle = 'hsla(0, 0%, 100%, ' + (this.MAX_RIPPLE_COUNT - this.rippleCount) / this.MAX_RIPPLE_COUNT + ')';
        context.translate(axis.x + this.offsetY * axis.rate * (this.theta <= Math.PI ? -1 : 1), axis.y);
        context.scale(1, 0.3);
        context.beginPath();
        context.arc(0, 0, this.rippleCount / this.MAX_RIPPLE_COUNT * this.RIPPLE_RADIUS * axis.rate, 0, Math.PI * 2, false);
        context.stroke();
        context.restore();
        this.rippleCount++;
      }
      if(axis.y < this.thresholdY || (!this.endTheta || !this.endPhi)){
        if(this.y <= 0){
          this.opacity = Math.min(this.opacity + 0.01, 1);
        }
        context.save();
        context.globalAlpha = this.opacity;
        context.fillStyle = this.shadowColor;
        context.strokeStyle = 'hsl(330, 30%,' + 40 * (0.3 + axis.rate) + '%)';
        context.translate(axis.x, Math.max(axis.y, this.thresholdY + this.thresholdY - axis.y));
        context.rotate(Math.PI - this.theta);
        context.scale(axis.rate * -Math.sin(this.phi), axis.rate);
        context.translate(0, this.offsetY);
        this.renderCherry(context, axis);
        context.restore();
      }
      context.save();
      context.fillStyle = this.entityColor;
      context.strokeStyle = 'hsl(330, 40%,' + 70 * (0.3 + axis.rate) + '%)';
      context.translate(axis.x, axis.y + Math.abs(this.SINK_OFFSET * Math.sin(this.psi) * axis.rate));
      context.rotate(this.theta);
      context.scale(axis.rate * Math.sin(this.phi), axis.rate);
      context.translate(0, this.offsetY);
      this.renderCherry(context, axis);
      context.restore();
      
      if(this.y <= -this.renderer.height / 4){
        if(!this.endTheta){
          for(var theta = Math.PI / 2, end = Math.PI * 3 / 2; theta <= end; theta += Math.PI){
            if(this.theta < theta && this.theta + Math.PI / 200 > theta){
              this.theta = theta;
              this.endTheta = true;
              break;
            }
          }
        }
        if(!this.endPhi){
          for(var phi = Math.PI / 8, end = Math.PI * 7 / 8; phi <= end; phi += Math.PI * 3 / 4){
            if(this.phi < phi && this.phi + Math.PI / 200 > phi){
              this.phi = Math.PI / 8;
              this.endPhi = true;
              break;
            }
          }
        }
      }
      if(!this.endTheta){
        if(axis.y == this.thresholdY){
          this.theta += Math.PI / 200 * ((this.theta < Math.PI / 2 || (this.theta >= Math.PI && this.theta < Math.PI * 3 / 2)) ? 1 : -1);
        }else{
          this.theta += Math.PI / 500;
        }
        this.theta %= Math.PI * 2;
      }
      if(this.endPhi){
        if(this.rippleCount == this.MAX_RIPPLE_COUNT){
          this.psi += this.dpsi;
          this.psi %= Math.PI * 2;
        }
      }else{
        this.phi += Math.PI / ((axis.y == this.thresholdY) ? 200 : 500);
        this.phi %= Math.PI;
      }
      if(this.y <= -this.renderer.height * this.SURFACE_RATE){
        this.x += 2;
        this.y = -this.renderer.height * this.SURFACE_RATE;
      }else{
        this.x += this.vx;
        this.y += this.vy;
      }
      return this.z > -this.FOCUS_POSITION && this.z < this.FAR_LIMIT && this.x < this.renderer.width * 1.5;
    }
  };
  jq_151(function(){
    RENDERER.init();
  });
</script>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <!--
    <div class="alice">
      <img src="/images/alice-shake.gif" alt="">
    </div>

    
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
    -->
  </div>
  <script
      defer="defer"
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"
      integrity="sha512-1dalHDkG9EtcOmCnoCjiwQ/HEB5SDNqw8d4G2MKoNwjiwMNeBAkudsBCmSlMnXdsH8Bm0mOd3tl/6nL5y0bMaQ=="
      crossorigin="anonymous"
    ></script>
  <script defer="defer" src="/js/gsap/DrawSVGPlugin.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomEase.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomBounce.min.js"></script>
  <script defer="defer" src="/js/gsap/SplitText.min.js"></script>
  <script defer="defer" src="/js/gsap/logo-run.js"></script>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">安卓so加载流程源码分析
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2024-02-14 11:19:19">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2024-02-14T11:19:19+08:00">2024-02-14</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>101k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>1:32</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">oacia</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="/background_picture/1_mary.jpg"></li>
          <li class="item" data-background-image="/background_picture/2_xingye.webp"></li>
          <li class="item" data-background-image="/background_picture/3_xiaoxia.webp"></li>
          <li class="item" data-background-image="/background_picture/4_alice.webp"></li>
          <li class="item" data-background-image="/background_picture/5_mutsuki.jpg"></li>
          <li class="item" data-background-image="/background_picture/6_arona_plana.webp"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb">
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://oacia.dev/android-load-so/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="oacia">
    <meta itemprop="description" content="DEVIL or SWEET, 月遇从云 花遇和风">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="oaciaのBbBlog~">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <blockquote>
<p>对于某些加固壳，加载解释器 elf 的方式不会是常规的 <code>System.loadLibrary</code> , 而是仿照 <code>System.loadLibrary</code>  在 AOSP 中的实现方式，在 JNI 中自己实现 so 的加载</p>
</blockquote>
<p>本次所使用到的 AOSP 的源码的安卓版本为 <code>android-12.0.0_r34</code></p>
<h1 id="so的启动过程"><a class="anchor" href="#so的启动过程">#</a> so 的启动过程</h1>
<h2 id="systemload"><a class="anchor" href="#systemload">#</a> System.load</h2>
<p>在 Android 中我们想要加载一个 so 时，可以有两种方式</p>
<ul>
<li>
<p>静态加载</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"native"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这种加载方式下，要加载的 so 一般已经内置在 apk 的 <code>lib/[arch]/</code>  中</p>
</li>
<li>
<p>动态加载</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">String</span> soPath <span class="token operator">=</span> <span class="token string">"/data/data/com.example.myapp/libmynative.so"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>soPath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这一种加载方式可以加载任意路径下的 so</p>
</li>
</ul>
<p>这里我们将动态加载，即 <code>System.load</code>  函数作为分析的入口，可以发现它实际上调用的是 <code>Runtime.getRuntime().load0</code></p>
<blockquote>
<p>对于静态加载 <code>System.loadLibrary</code>  来说，它调用的函数是 <code>Runtime.getRuntime().loadLibrary0(Reflection.getCallerClass(), libname);</code></p>
</blockquote>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\libcore\ojluni\src\main\java\java\lang\System.java</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre>     * Loads the native library specified by the filename argument.  The filename</pre></td></tr><tr><td data-num="5"></td><td><pre>     * argument must be an absolute path name.</pre></td></tr><tr><td data-num="6"></td><td><pre>     *</pre></td></tr><tr><td data-num="7"></td><td><pre>     * If the filename argument, when stripped of any platform-specific library</pre></td></tr><tr><td data-num="8"></td><td><pre>     * prefix, path, and file extension, indicates a library whose name is,</pre></td></tr><tr><td data-num="9"></td><td><pre>     * for example, L, and a native library called L is statically linked</pre></td></tr><tr><td data-num="10"></td><td><pre>     * with the VM, then the JNI_OnLoad_L function exported by the library</pre></td></tr><tr><td data-num="11"></td><td><pre>     * is invoked rather than attempting to load a dynamic library.</pre></td></tr><tr><td data-num="12"></td><td><pre>     * A filename matching the argument does not have to exist in the</pre></td></tr><tr><td data-num="13"></td><td><pre>     * file system.</pre></td></tr><tr><td data-num="14"></td><td><pre>     * See the JNI Specification for more details.</pre></td></tr><tr><td data-num="15"></td><td><pre>     *</pre></td></tr><tr><td data-num="16"></td><td><pre>     * Otherwise, the filename argument is mapped to a native library image in</pre></td></tr><tr><td data-num="17"></td><td><pre>     * an implementation-dependent manner.</pre></td></tr><tr><td data-num="18"></td><td><pre>     *</pre></td></tr><tr><td data-num="19"></td><td><pre>     * &lt;p></pre></td></tr><tr><td data-num="20"></td><td><pre>     * The call &lt;code>System.load(name)&lt;/code> is effectively equivalent</pre></td></tr><tr><td data-num="21"></td><td><pre>     * to the call:</pre></td></tr><tr><td data-num="22"></td><td><pre>     * &lt;blockquote>&lt;pre></pre></td></tr><tr><td data-num="23"></td><td><pre>     * Runtime.getRuntime().load(name)</pre></td></tr><tr><td data-num="24"></td><td><pre>     * &lt;/pre>&lt;/blockquote></pre></td></tr><tr><td data-num="25"></td><td><pre>     *</pre></td></tr><tr><td data-num="26"></td><td><pre>     * @param      filename   the file to load.</pre></td></tr><tr><td data-num="27"></td><td><pre>     * @exception  SecurityException  if a security manager exists and its</pre></td></tr><tr><td data-num="28"></td><td><pre>     *             &lt;code>checkLink&lt;/code> method doesn't allow</pre></td></tr><tr><td data-num="29"></td><td><pre>     *             loading of the specified dynamic library</pre></td></tr><tr><td data-num="30"></td><td><pre>     * @exception  UnsatisfiedLinkError  if either the filename is not an</pre></td></tr><tr><td data-num="31"></td><td><pre>     *             absolute path name, the native library is not statically</pre></td></tr><tr><td data-num="32"></td><td><pre>     *             linked with the VM, or the library cannot be mapped to</pre></td></tr><tr><td data-num="33"></td><td><pre>     *             a native library image by the host system.</pre></td></tr><tr><td data-num="34"></td><td><pre>     * @exception  NullPointerException if &lt;code>filename&lt;/code> is</pre></td></tr><tr><td data-num="35"></td><td><pre>     *             &lt;code>null&lt;/code></pre></td></tr><tr><td data-num="36"></td><td><pre>     * @see        java.lang.Runtime#load(java.lang.String)</pre></td></tr><tr><td data-num="37"></td><td><pre>     * @see        java.lang.SecurityManager#checkLink(java.lang.String)</pre></td></tr><tr><td data-num="38"></td><td><pre>     */</pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token annotation punctuation">@CallerSensitive</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load0</span><span class="token punctuation">(</span><span class="token class-name">Reflection</span><span class="token punctuation">.</span><span class="token function">getCallerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>Reflection.getCallerClass</strong></p>
<p>第一个传入的参数 <code>Reflection.getCallerClass()</code>  相关的实现即注释如下，读起来可能会有点绕，什么叫返回方法的方法的调用者的类？</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\libcore\ojluni\src\main\java\sun\reflect\Reflection.java</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/** Returns the class of the caller of the method calling this method,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        ignoring frames associated with java.lang.reflect.Method.invoke()</pre></td></tr><tr><td data-num="4"></td><td><pre>        and its implementation. *</pre></td></tr><tr><td data-num="5"></td><td><pre>    @CallerSensitive</pre></td></tr><tr><td data-num="6"></td><td><pre>    public static native Class&lt;?> getCallerClass();</pre></td></tr><tr><td data-num="7"></td><td><pre>    */</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">getCallerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// This method (getCallerClass()) constitutes another stack frame,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// so we need to call getStackClass2() rather than getStackClass1().</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">VMStack</span><span class="token punctuation">.</span><span class="token function">getStackClass2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其实按照逆向的角度来看，就是返回调用栈的最底层的那个类，例如有一个 <code>Class A</code>  经过如下的调用过程: <code>Class A-&gt;反射1-&gt;反射2-&gt;反射n-&gt;...-&gt;Reflection.getCallerClass()</code> , 最终 <code>getCallerClass</code>  方法将返回 <code>Class A</code></p>
<h2 id="runtimegetruntimeload0"><a class="anchor" href="#runtimegetruntimeload0">#</a> Runtime.getRuntime().load0</h2>
<p>在 <code>Runtime.getRuntime().load0</code>  中进行了 <code>filename</code>  是否是 <code>绝对路径</code> 以及 <code>空字符串</code> 的检查之后，便开始调用 <code>nativeLoad</code>  真正的去加载 so 了</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\libcore\ojluni\src\main\java\java\lang\Runtime.java</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">load0</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> fromClass<span class="token punctuation">,</span> <span class="token class-name">String</span> filename<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedLinkError</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token string">"Expecting an absolute path of the library: "</span> <span class="token operator">+</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>filename <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"filename == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">String</span> error <span class="token operator">=</span> <span class="token function">nativeLoad</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> fromClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedLinkError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>fromClass.getClassLoader()</strong></p>
<p>向 <code>nativeLoad</code>  中传入的第二个参数是 <code>fromClass.getClassLoader()</code> , 利用这个方法可以获取到 <code>fromClass</code>  类的 <code>ClassLoader</code></p>
<blockquote>
<p>为什么要获取 ClassLoader 并将其作为参数传入 nativeLoad?</p>
</blockquote>
<h2 id="runtimejava中的nativeload"><a class="anchor" href="#runtimejava中的nativeload">#</a> Runtime.java 中的 nativeLoad</h2>
<p>在 <code>nativeLoad</code>  重载调用了 <code>nativeLoad(String filename, ClassLoader loader, Class&lt;?&gt; caller)</code> , 而该函数的声明为 <code>native</code> , 这便意味着我们即将走出 java 来到 c++ 的世界了</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\libcore\ojluni\src\main\java\java\lang\Runtime.java</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">nativeLoad</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">nativeLoad</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">String</span> <span class="token function">nativeLoad</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> caller<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="runtimec中的nativeload"><a class="anchor" href="#runtimec中的nativeload">#</a> Runtime.c 中的 nativeLoad</h2>
<p>在常规的 JNI 函数的编写过程中，想要让 java 层调用 JNI 中定义的函数，要么使用静态注册，利用 <code>JNIEXPORT</code>  关键字将这个函数导出，或者使用 <code>RegisterNatives</code>  方法去进行动态注册，而在 AOSP 定义 <code>nativeLoad</code>  时，这两种方法都使用到了，对于学习 JNI 的注册过程非常具有参考意义</p>
<p>查看 <code>Runtime_nativeLoad</code>  函数，可以发现它继续调用了 <code>JVM_NativeLoad</code></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\libcore\ojluni\src\main\native\Runtime.c</span></pre></td></tr><tr><td data-num="2"></td><td><pre>JNIEXPORT jstring JNICALL</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">Runtime_nativeLoad</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass ignored<span class="token punctuation">,</span> jstring javaFilename<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                   jobject javaLoader<span class="token punctuation">,</span> jclass caller<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">JVM_NativeLoad</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> javaFilename<span class="token punctuation">,</span> javaLoader<span class="token punctuation">,</span> caller<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">//these macros below are defined at android-platform\libnativehelper\include_platform_header_only\nativehelper\jni_macros.h</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FAST_NATIVE_METHOD</span><span class="token expression"><span class="token punctuation">(</span>className<span class="token punctuation">,</span> functionName<span class="token punctuation">,</span> signature<span class="token punctuation">)</span>           </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token expression"><span class="token function">MAKE_JNI_FAST_NATIVE_METHOD</span><span class="token punctuation">(</span>#functionName<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> className </span><span class="token punctuation">##</span> <span class="token expression">_ </span><span class="token punctuation">##</span> <span class="token expression">functionName<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">NATIVE_METHOD</span><span class="token expression"><span class="token punctuation">(</span>className<span class="token punctuation">,</span> functionName<span class="token punctuation">,</span> signature<span class="token punctuation">)</span>                </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token expression"><span class="token function">MAKE_JNI_NATIVE_METHOD</span><span class="token punctuation">(</span>#functionName<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> className </span><span class="token punctuation">##</span> <span class="token expression">_ </span><span class="token punctuation">##</span> <span class="token expression">functionName<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MAKE_JNI_NATIVE_METHOD</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> function<span class="token punctuation">)</span>                      </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token expression"><span class="token function">_NATIVEHELPER_JNI_MAKE_METHOD</span><span class="token punctuation">(</span>kNormalNative<span class="token punctuation">,</span> name<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> function<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_NATIVEHELPER_JNI_MAKE_METHOD</span><span class="token expression"><span class="token punctuation">(</span>kind<span class="token punctuation">,</span> name<span class="token punctuation">,</span> sig<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token expression"><span class="token function">MAKE_CHECKED_JNI_NATIVE_METHOD</span><span class="token punctuation">(</span>kind<span class="token punctuation">,</span> name<span class="token punctuation">,</span> sig<span class="token punctuation">,</span> fn<span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">//MAKE_CHECKED_JNI_NATIVE_METHOD is defined at platform\libnativehelper\include_platform_header_only\nativehelper\detail\signature_checker.h</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MAKE_CHECKED_JNI_NATIVE_METHOD</span><span class="token expression"><span class="token punctuation">(</span>native_kind<span class="token punctuation">,</span> name_<span class="token punctuation">,</span> signature_<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                                                </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token expression">using namespace nativehelper<span class="token operator">::</span>detail<span class="token punctuation">;</span>  </span><span class="token comment">/* NOLINT(google-build-using-namespace) */</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token expression"><span class="token function">static_assert</span><span class="token punctuation">(</span>                                                       </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token expression">MatchJniDescriptorWithFunctionType<span class="token operator">&lt;</span>native_kind<span class="token punctuation">,</span>                  </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                                           <span class="token expression"><span class="token function">decltype</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span>                 </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                                           <span class="token expression">fn<span class="token punctuation">,</span>                           </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                                           <span class="token expression"><span class="token keyword">sizeof</span><span class="token punctuation">(</span>signature_<span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">(</span>signature_<span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token string">"JNI signature doesn't match C++ function type."</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span>               </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">/* Suppress implicit cast warnings by explicitly casting. */</span>         <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token expression"><span class="token keyword">return</span> JNINativeMethod <span class="token punctuation">&#123;</span>                                             </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token expression">const_cast<span class="token operator">&lt;</span><span class="token function">decltype</span><span class="token punctuation">(</span>JNINativeMethod<span class="token operator">::</span>name<span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">(</span>name_<span class="token punctuation">)</span><span class="token punctuation">,</span>              </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token expression">const_cast<span class="token operator">&lt;</span><span class="token function">decltype</span><span class="token punctuation">(</span>JNINativeMethod<span class="token operator">::</span>signature<span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">(</span>signature_<span class="token punctuation">)</span><span class="token punctuation">,</span>    </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token expression">reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                                 </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token expression"><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">//NELEM is defined at platform\libnativehelper\include\nativehelper\JNIHelp.h</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">NELEM</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">//jniRegisterNativeMethods is defined at platform\libnativehelper\JNIHelp.c</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">int</span> <span class="token function">jniRegisterNativeMethods</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> className<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">const</span> JNINativeMethod<span class="token operator">*</span> methods<span class="token punctuation">,</span> <span class="token keyword">int</span> numMethods<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"Registering %s's %d native methods..."</span><span class="token punctuation">,</span> className<span class="token punctuation">,</span> numMethods<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    jclass clazz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token function">ALOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                         <span class="token string">"Native registration unable to find class '%s'; aborting..."</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                         className<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">RegisterNatives</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> numMethods<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token comment">// Failure to register natives is fatal. Try to report the corresponding exception,</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">// otherwise abort with generic failure message.</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    jthrowable thrown <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ExceptionOccurred</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>thrown <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token keyword">struct</span> <span class="token class-name">ExpandableString</span> summary<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token function">ExpandableStringInitialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>summary<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetExceptionSummary</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> thrown<span class="token punctuation">,</span> <span class="token operator">&amp;</span>summary<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token function">ALOGF</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> summary<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token function">ExpandableStringRelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>summary<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> thrown<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token function">ALOGF</span><span class="token punctuation">(</span><span class="token string">"RegisterNatives failed for '%s'; aborting..."</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token keyword">static</span> JNINativeMethod gMethods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token function">FAST_NATIVE_METHOD</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">,</span> freeMemory<span class="token punctuation">,</span> <span class="token string">"()J"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token function">FAST_NATIVE_METHOD</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">,</span> totalMemory<span class="token punctuation">,</span> <span class="token string">"()J"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token function">FAST_NATIVE_METHOD</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">,</span> maxMemory<span class="token punctuation">,</span> <span class="token string">"()J"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token function">NATIVE_METHOD</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">,</span> nativeGc<span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token function">NATIVE_METHOD</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">,</span> nativeExit<span class="token punctuation">,</span> <span class="token string">"(I)V"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token function">NATIVE_METHOD</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">,</span> nativeLoad<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                <span class="token string">"(Ljava/lang/String;Ljava/lang/ClassLoader;Ljava/lang/Class;)"</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                    <span class="token string">"Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token keyword">void</span> <span class="token function">register_java_lang_Runtime</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token function">jniRegisterNativeMethods</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"java/lang/Runtime"</span><span class="token punctuation">,</span> gMethods<span class="token punctuation">,</span> <span class="token function">NELEM</span><span class="token punctuation">(</span>gMethods<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="jvm_nativeload"><a class="anchor" href="#jvm_nativeload">#</a> JVM_NativeLoad</h2>
<p><code>JVM_NativeLoad</code>  获取当前进程的 <code>javaVM</code>  对象并调用 <code>javaVM</code>  的 <code>LoadNativeLibrary</code>  方法</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\art\openjdkjvm\OpenjdkJvm.cc</span></pre></td></tr><tr><td data-num="2"></td><td><pre>JNIEXPORT jstring <span class="token function">JVM_NativeLoad</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                 jstring javaFilename<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                                 jobject javaLoader<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                                 jclass caller<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">// 实例化一个文件对象</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  ScopedUtfChars <span class="token function">filename</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> javaFilename<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  std<span class="token operator">::</span>string error_msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 获取当前进程的 javaVM 对象</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    art<span class="token operator">::</span>JavaVMExt<span class="token operator">*</span> vm <span class="token operator">=</span> art<span class="token operator">::</span>Runtime<span class="token operator">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetJavaVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    bool success <span class="token operator">=</span> vm<span class="token operator">-></span><span class="token function">LoadNativeLibrary</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                                         filename<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                                         javaLoader<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                                         caller<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                                         <span class="token operator">&amp;</span>error_msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token comment">// Don't let a pending exception from JNI_OnLoad cause a CheckJNI issue with NewStringUTF.</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  env<span class="token operator">-></span><span class="token function">ExceptionClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">return</span> env<span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>error_msg<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="vm-loadnativelibrary"><a class="anchor" href="#vm-loadnativelibrary">#</a> vm-&gt;LoadNativeLibrary</h2>
<p><code>LoadNativeLibrary</code>  的代码很长，细看之后可以分为三个部分</p>
<ol>
<li>
<p><code>so</code>  加载前<br>
这个部分主要判断即将被 so 是否之前就已经被加载过，如果已经被加载好了，那么就直接退出这个函数并返回</p>
</li>
<li>
<p><code>so</code>  加载时<br>
这个部分就是 AOSP 实现动态链接库加载的核心实现，之后会进行详细的分析<br>
当找到这个 so 的 soinfo 之后 (具体是在<a href="###do_dlopen"> do_dlopen</a> 中被找到), 会立即调用 <code>soinfo::call_constructors</code>  函数依次加载 <code>init</code>  和 <code>init_array</code>  函数</p>
</li>
<li>
<p><code>so</code>  加载后<br>
在这最后一个部分中，当一个 so 被成功加载后，会立即调用 <code>so</code>  的导出函数中的 <code>JNI_OnLoad</code>  函数 (如果 <code>JNI_OnLoad</code>  存在的话)</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\art\runtime\jni\java_vm_ext.cc</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 阶段三：当 so 被加载之后，立即调用导出函数 JNI_OnLoad</span></pre></td></tr><tr><td data-num="3"></td><td><pre>bool was_successful <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> sym <span class="token operator">=</span> library<span class="token operator">-></span><span class="token function">FindSymbol</span><span class="token punctuation">(</span><span class="token string">"JNI_OnLoad"</span><span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>sym <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[No JNI_OnLoad found in \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    was_successful <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// Call JNI_OnLoad.  We have to override the current class</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// loader, which will always be "null" since the stuff at the</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// top of the stack is around Runtime.loadLibrary().  (See</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// the comments in the JNI FindClass function.)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    ScopedLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">></span> <span class="token function">old_class_loader</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> env<span class="token operator">-></span><span class="token function">NewLocalRef</span><span class="token punctuation">(</span>self<span class="token operator">-></span><span class="token function">GetClassLoaderOverride</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    self<span class="token operator">-></span><span class="token function">SetClassLoaderOverride</span><span class="token punctuation">(</span>class_loader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[Calling JNI_OnLoad in \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    using JNI_OnLoadFn <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    JNI_OnLoadFn jni_on_load <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>JNI_OnLoadFn<span class="token operator">></span><span class="token punctuation">(</span>sym<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">int</span> version <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>jni_on_load<span class="token punctuation">)</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsSdkVersionSetAndAtMost</span><span class="token punctuation">(</span>runtime_<span class="token operator">-></span><span class="token function">GetTargetSdkVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SdkVersion<span class="token operator">::</span>kL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// Make sure that sigchain owns SIGSEGV.</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">EnsureFrontOfChain</span><span class="token punctuation">(</span>SIGSEGV<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    self<span class="token operator">-></span><span class="token function">SetClassLoaderOverride</span><span class="token punctuation">(</span>old_class_loader<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">==</span> JNI_ERR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token function">StringAppendF</span><span class="token punctuation">(</span>error_msg<span class="token punctuation">,</span> <span class="token string">"JNI_ERR returned from JNI_OnLoad in \"%s\""</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>JavaVMExt<span class="token operator">::</span><span class="token function">IsBadJniVersion</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token function">StringAppendF</span><span class="token punctuation">(</span>error_msg<span class="token punctuation">,</span> <span class="token string">"Bad JNI version returned from JNI_OnLoad in \"%s\": %d"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                      path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">// It's unwise to call dlclose() here, but we can mark it</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// as bad and ensure that future load attempts will fail.</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token comment">// We don't know how far JNI_OnLoad got, so there could</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">// be some partially-initialized stuff accessible through</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token comment">// newly-registered native method calls.  We could try to</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token comment">// unregister them, but that doesn't seem worthwhile.</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        was_successful <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[Returned "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>was_successful <span class="token operator">?</span> <span class="token string">"successfully"</span> <span class="token operator">:</span> <span class="token string">"failure"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token operator">&lt;&lt;</span> <span class="token string">" from JNI_OnLoad in \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li>
</ol>
<p>完整的 <code>LoadNativeLibrary</code>  代码</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\art\runtime\jni\java_vm_ext.cc</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bool JavaVMExt<span class="token operator">::</span><span class="token function">LoadNativeLibrary</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                  <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                                  jobject class_loader<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                                  jclass caller_class<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                                  std<span class="token operator">::</span>string<span class="token operator">*</span> error_msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  error_msg<span class="token operator">-></span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// 阶段一：判断目标 so 是否已经被加载过</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// See if we've already loaded this library.  If we have, and the class loader</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// matches, return successfully without doing anything.</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// TODO: for better results we should canonicalize (规范化) the pathname (or even compare</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">// inodes). This implementation is fine if everybody is using System.loadLibrary.</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  SharedLibrary<span class="token operator">*</span> library<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  Thread<span class="token operator">*</span> self <span class="token operator">=</span> Thread<span class="token operator">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// TODO: move the locking (and more of this logic) into Libraries.</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    MutexLock <span class="token function">mu</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>Locks<span class="token operator">::</span>jni_libraries_lock_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    library <span class="token operator">=</span> libraries_<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">void</span><span class="token operator">*</span> class_loader_allocator <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  std<span class="token operator">::</span>string caller_location<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    ScopedObjectAccess <span class="token function">soa</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// As the incoming class loader is reachable/alive during the call of this function,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// it's okay to decode it without worrying about unexpectedly marking it alive.</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    ObjPtr<span class="token operator">&lt;</span>mirror<span class="token operator">::</span>ClassLoader<span class="token operator">></span> loader <span class="token operator">=</span> soa<span class="token punctuation">.</span>Decode<span class="token operator">&lt;</span>mirror<span class="token operator">::</span>ClassLoader<span class="token operator">></span><span class="token punctuation">(</span>class_loader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    ClassLinker<span class="token operator">*</span> class_linker <span class="token operator">=</span> Runtime<span class="token operator">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetClassLinker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>class_linker<span class="token operator">-></span><span class="token function">IsBootClassLoader</span><span class="token punctuation">(</span>soa<span class="token punctuation">,</span> loader<span class="token punctuation">.</span><span class="token function">Ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      loader <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      class_loader <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>caller_class <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        ObjPtr<span class="token operator">&lt;</span>mirror<span class="token operator">::</span>Class<span class="token operator">></span> caller <span class="token operator">=</span> soa<span class="token punctuation">.</span>Decode<span class="token operator">&lt;</span>mirror<span class="token operator">::</span>Class<span class="token operator">></span><span class="token punctuation">(</span>caller_class<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        ObjPtr<span class="token operator">&lt;</span>mirror<span class="token operator">::</span>DexCache<span class="token operator">></span> dex_cache <span class="token operator">=</span> caller<span class="token operator">-></span><span class="token function">GetDexCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dex_cache <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>          caller_location <span class="token operator">=</span> dex_cache<span class="token operator">-></span><span class="token function">GetLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ToModifiedUtf8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    class_loader_allocator <span class="token operator">=</span> class_linker<span class="token operator">-></span><span class="token function">GetAllocatorForClassLoader</span><span class="token punctuation">(</span>loader<span class="token punctuation">.</span><span class="token function">Ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">CHECK</span><span class="token punctuation">(</span>class_loader_allocator <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>library <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">// Use the allocator pointers for class loader equality to avoid unnecessary weak root decode.</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>library<span class="token operator">-></span><span class="token function">GetClassLoaderAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> class_loader_allocator<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token comment">// The library will be associated with class_loader. The JNI</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token comment">// spec says we can't load the same library into more than one</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token comment">// class loader.</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token comment">//</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token comment">// This isn't very common. So spend some time to get a readable message.</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token keyword">auto</span> call_to_string <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>jobject obj<span class="token punctuation">)</span> <span class="token operator">-></span> std<span class="token operator">::</span>string <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>          <span class="token keyword">return</span> <span class="token string">"null"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">// Handle jweaks. Ignore double local-ref.</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        ScopedLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">></span> <span class="token function">local_ref</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> env<span class="token operator">-></span><span class="token function">NewLocalRef</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>local_ref <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>          ScopedLocalRef<span class="token operator">&lt;</span>jclass<span class="token operator">></span> <span class="token function">local_class</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> env<span class="token operator">-></span><span class="token function">GetObjectClass</span><span class="token punctuation">(</span>local_ref<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>          jmethodID to_string <span class="token operator">=</span> env<span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>local_class<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                                                 <span class="token string">"toString"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                                                 <span class="token string">"()Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>          <span class="token function">DCHECK</span><span class="token punctuation">(</span>to_string <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>          ScopedLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">></span> <span class="token function">local_string</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                                               env<span class="token operator">-></span><span class="token function">CallObjectMethod</span><span class="token punctuation">(</span>local_ref<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to_string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>local_string <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            ScopedUtfChars <span class="token function">utf</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span>jstring<span class="token operator">></span><span class="token punctuation">(</span>local_string<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>utf<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>              <span class="token keyword">return</span> utf<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">ExceptionCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token comment">// We can't do much better logging, really. So leave it with a Describe.</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            env<span class="token operator">-></span><span class="token function">ExceptionDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            env<span class="token operator">-></span><span class="token function">ExceptionClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>          <span class="token keyword">return</span> <span class="token string">"(Error calling toString)"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"null"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      std<span class="token operator">::</span>string old_class_loader <span class="token operator">=</span> <span class="token function">call_to_string</span><span class="token punctuation">(</span>library<span class="token operator">-></span><span class="token function">GetClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      std<span class="token operator">::</span>string new_class_loader <span class="token operator">=</span> <span class="token function">call_to_string</span><span class="token punctuation">(</span>class_loader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>      <span class="token function">StringAppendF</span><span class="token punctuation">(</span>error_msg<span class="token punctuation">,</span> <span class="token string">"Shared library \"%s\" already opened by "</span></pre></td></tr><tr><td data-num="85"></td><td><pre>          <span class="token string">"ClassLoader %p(%s); can't open in ClassLoader %p(%s)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="86"></td><td><pre>          path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="87"></td><td><pre>          library<span class="token operator">-></span><span class="token function">GetClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="88"></td><td><pre>          old_class_loader<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="89"></td><td><pre>          class_loader<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="90"></td><td><pre>          new_class_loader<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>      <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>error_msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[Shared library \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\" already loaded in "</span></pre></td></tr><tr><td data-num="95"></td><td><pre>              <span class="token operator">&lt;&lt;</span> <span class="token string">" ClassLoader "</span> <span class="token operator">&lt;&lt;</span> class_loader <span class="token operator">&lt;&lt;</span> <span class="token string">"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>library<span class="token operator">-></span><span class="token function">CheckOnLoadResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>      <span class="token function">StringAppendF</span><span class="token punctuation">(</span>error_msg<span class="token punctuation">,</span> <span class="token string">"JNI_OnLoad failed on a previous attempt "</span></pre></td></tr><tr><td data-num="98"></td><td><pre>          <span class="token string">"to load \"%s\""</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre></pre></td></tr><tr><td data-num="105"></td><td><pre>  <span class="token comment">// 阶段二：加载 so</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  <span class="token comment">// Open the shared library.  Because we're using a full path, the system</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  <span class="token comment">// doesn't have to search through LD_LIBRARY_PATH.  (It may do so to</span></pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token comment">// resolve this library's dependencies though.)</span></pre></td></tr><tr><td data-num="109"></td><td><pre></pre></td></tr><tr><td data-num="110"></td><td><pre>  <span class="token comment">// Failures here are expected when java.library.path has several entries</span></pre></td></tr><tr><td data-num="111"></td><td><pre>  <span class="token comment">// and we have to hunt for the lib.</span></pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre>  <span class="token comment">// Below we dlopen but there is no paired dlclose, this would be necessary if we supported</span></pre></td></tr><tr><td data-num="114"></td><td><pre>  <span class="token comment">// class unloading. Libraries will only be unloaded when the reference count (incremented by</span></pre></td></tr><tr><td data-num="115"></td><td><pre>  <span class="token comment">// dlopen) becomes zero from dlclose.</span></pre></td></tr><tr><td data-num="116"></td><td><pre></pre></td></tr><tr><td data-num="117"></td><td><pre>  <span class="token comment">// Retrieve the library path from the classloader, if necessary.</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  ScopedLocalRef<span class="token operator">&lt;</span>jstring<span class="token operator">></span> <span class="token function">library_path</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token function">GetLibrarySearchPath</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> class_loader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre></pre></td></tr><tr><td data-num="120"></td><td><pre>  Locks<span class="token operator">::</span>mutator_lock_<span class="token operator">-></span><span class="token function">AssertNotHeld</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path_str <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> nullptr <span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>  bool needs_native_bridge <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>  <span class="token keyword">char</span><span class="token operator">*</span> nativeloader_error_msg <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>  <span class="token comment">// 调用 dlopen 打开目标 so</span></pre></td></tr><tr><td data-num="125"></td><td><pre>  <span class="token keyword">void</span><span class="token operator">*</span> handle <span class="token operator">=</span> android<span class="token operator">::</span><span class="token function">OpenNativeLibrary</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="126"></td><td><pre>      env<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="127"></td><td><pre>      runtime_<span class="token operator">-></span><span class="token function">GetTargetSdkVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="128"></td><td><pre>      path_str<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="129"></td><td><pre>      class_loader<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="130"></td><td><pre>      <span class="token punctuation">(</span>caller_location<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> nullptr <span class="token operator">:</span> caller_location<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="131"></td><td><pre>      library_path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="132"></td><td><pre>      <span class="token operator">&amp;</span>needs_native_bridge<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="133"></td><td><pre>      <span class="token operator">&amp;</span>nativeloader_error_msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>  <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[Call to dlopen(\""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\", RTLD_NOW) returned "</span> <span class="token operator">&lt;&lt;</span> handle <span class="token operator">&lt;&lt;</span> <span class="token string">"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre></pre></td></tr><tr><td data-num="136"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    <span class="token operator">*</span>error_msg <span class="token operator">=</span> nativeloader_error_msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>    android<span class="token operator">::</span><span class="token function">NativeLoaderFreeErrorMessage</span><span class="token punctuation">(</span>nativeloader_error_msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>    <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"dlopen(\""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\", RTLD_NOW) failed: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>error_msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">ExceptionCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> JNI_TRUE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Unexpected exception:"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>    env<span class="token operator">-></span><span class="token function">ExceptionDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>    env<span class="token operator">-></span><span class="token function">ExceptionClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>  <span class="token comment">// Create a new entry.</span></pre></td></tr><tr><td data-num="149"></td><td><pre>  <span class="token comment">// TODO: move the locking (and more of this logic) into Libraries.</span></pre></td></tr><tr><td data-num="150"></td><td><pre>  bool created_library <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>    <span class="token comment">// Create SharedLibrary ahead of taking the libraries lock to maintain lock ordering.</span></pre></td></tr><tr><td data-num="153"></td><td><pre>    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>SharedLibrary<span class="token operator">></span> <span class="token function">new_library</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="154"></td><td><pre>        new <span class="token function">SharedLibrary</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="155"></td><td><pre>                          self<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="156"></td><td><pre>                          path<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="157"></td><td><pre>                          handle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="158"></td><td><pre>                          needs_native_bridge<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="159"></td><td><pre>                          class_loader<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="160"></td><td><pre>                          class_loader_allocator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre></pre></td></tr><tr><td data-num="162"></td><td><pre>    MutexLock <span class="token function">mu</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>Locks<span class="token operator">::</span>jni_libraries_lock_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>    library <span class="token operator">=</span> libraries_<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>library <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// We won race to get libraries_lock.</span></pre></td></tr><tr><td data-num="165"></td><td><pre>      library <span class="token operator">=</span> new_library<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>      libraries_<span class="token operator">-></span><span class="token function">Put</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> library<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>      created_library <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>created_library<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"WOW: we lost a race to add shared library: "</span></pre></td></tr><tr><td data-num="172"></td><td><pre>        <span class="token operator">&lt;&lt;</span> <span class="token string">"\""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\" ClassLoader="</span> <span class="token operator">&lt;&lt;</span> class_loader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="173"></td><td><pre>    <span class="token keyword">return</span> library<span class="token operator">-></span><span class="token function">CheckOnLoadResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="174"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>  <span class="token comment">// 动态链接库装载完成</span></pre></td></tr><tr><td data-num="176"></td><td><pre>  <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[Added shared library \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\" for ClassLoader "</span> <span class="token operator">&lt;&lt;</span> class_loader <span class="token operator">&lt;&lt;</span> <span class="token string">"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="177"></td><td><pre></pre></td></tr><tr><td data-num="178"></td><td><pre>  <span class="token comment">// 阶段三：当 so 被加载之后，立即调用导出函数 JNI_OnLoad</span></pre></td></tr><tr><td data-num="179"></td><td><pre>  bool was_successful <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="180"></td><td><pre>  <span class="token keyword">void</span><span class="token operator">*</span> sym <span class="token operator">=</span> library<span class="token operator">-></span><span class="token function">FindSymbol</span><span class="token punctuation">(</span><span class="token string">"JNI_OnLoad"</span><span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="181"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>sym <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="182"></td><td><pre>    <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[No JNI_OnLoad found in \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="183"></td><td><pre>    was_successful <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>    <span class="token comment">// Call JNI_OnLoad.  We have to override the current class</span></pre></td></tr><tr><td data-num="186"></td><td><pre>    <span class="token comment">// loader, which will always be "null" since the stuff at the</span></pre></td></tr><tr><td data-num="187"></td><td><pre>    <span class="token comment">// top of the stack is around Runtime.loadLibrary().  (See</span></pre></td></tr><tr><td data-num="188"></td><td><pre>    <span class="token comment">// the comments in the JNI FindClass function.)</span></pre></td></tr><tr><td data-num="189"></td><td><pre>    ScopedLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">></span> <span class="token function">old_class_loader</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> env<span class="token operator">-></span><span class="token function">NewLocalRef</span><span class="token punctuation">(</span>self<span class="token operator">-></span><span class="token function">GetClassLoaderOverride</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="190"></td><td><pre>    self<span class="token operator">-></span><span class="token function">SetClassLoaderOverride</span><span class="token punctuation">(</span>class_loader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre></pre></td></tr><tr><td data-num="192"></td><td><pre>    <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[Calling JNI_OnLoad in \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="193"></td><td><pre>    using JNI_OnLoadFn <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="194"></td><td><pre>    JNI_OnLoadFn jni_on_load <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>JNI_OnLoadFn<span class="token operator">></span><span class="token punctuation">(</span>sym<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="195"></td><td><pre>    <span class="token keyword">int</span> version <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>jni_on_load<span class="token punctuation">)</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="196"></td><td><pre></pre></td></tr><tr><td data-num="197"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsSdkVersionSetAndAtMost</span><span class="token punctuation">(</span>runtime_<span class="token operator">-></span><span class="token function">GetTargetSdkVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SdkVersion<span class="token operator">::</span>kL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="198"></td><td><pre>      <span class="token comment">// Make sure that sigchain owns SIGSEGV.</span></pre></td></tr><tr><td data-num="199"></td><td><pre>      <span class="token function">EnsureFrontOfChain</span><span class="token punctuation">(</span>SIGSEGV<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="200"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="201"></td><td><pre></pre></td></tr><tr><td data-num="202"></td><td><pre>    self<span class="token operator">-></span><span class="token function">SetClassLoaderOverride</span><span class="token punctuation">(</span>old_class_loader<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="203"></td><td><pre></pre></td></tr><tr><td data-num="204"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">==</span> JNI_ERR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="205"></td><td><pre>      <span class="token function">StringAppendF</span><span class="token punctuation">(</span>error_msg<span class="token punctuation">,</span> <span class="token string">"JNI_ERR returned from JNI_OnLoad in \"%s\""</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="206"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>JavaVMExt<span class="token operator">::</span><span class="token function">IsBadJniVersion</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="207"></td><td><pre>      <span class="token function">StringAppendF</span><span class="token punctuation">(</span>error_msg<span class="token punctuation">,</span> <span class="token string">"Bad JNI version returned from JNI_OnLoad in \"%s\": %d"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="208"></td><td><pre>                    path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="209"></td><td><pre>      <span class="token comment">// It's unwise to call dlclose() here, but we can mark it</span></pre></td></tr><tr><td data-num="210"></td><td><pre>      <span class="token comment">// as bad and ensure that future load attempts will fail.</span></pre></td></tr><tr><td data-num="211"></td><td><pre>      <span class="token comment">// We don't know how far JNI_OnLoad got, so there could</span></pre></td></tr><tr><td data-num="212"></td><td><pre>      <span class="token comment">// be some partially-initialized stuff accessible through</span></pre></td></tr><tr><td data-num="213"></td><td><pre>      <span class="token comment">// newly-registered native method calls.  We could try to</span></pre></td></tr><tr><td data-num="214"></td><td><pre>      <span class="token comment">// unregister them, but that doesn't seem worthwhile.</span></pre></td></tr><tr><td data-num="215"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="216"></td><td><pre>      was_successful <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="217"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="218"></td><td><pre>    <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[Returned "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>was_successful <span class="token operator">?</span> <span class="token string">"successfully"</span> <span class="token operator">:</span> <span class="token string">"failure"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="219"></td><td><pre>              <span class="token operator">&lt;&lt;</span> <span class="token string">" from JNI_OnLoad in \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="220"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="221"></td><td><pre></pre></td></tr><tr><td data-num="222"></td><td><pre>  library<span class="token operator">-></span><span class="token function">SetResult</span><span class="token punctuation">(</span>was_successful<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>  <span class="token keyword">return</span> was_successful<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="224"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="so的加载过程"><a class="anchor" href="#so的加载过程">#</a> so 的加载过程</h1>
<p>在刚刚对于 <code>vm-&gt;LoadNativeLibrary</code>  函数 <code>so加载时</code> 的简要分析中，我们知道目标 so 是通过 <code>dlopen</code>  打开的，我们可以从 <code>android::OpenNativeLibrary</code>  函数开始分析</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\art\runtime\jni\java_vm_ext.cc</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bool JavaVMExt<span class="token operator">::</span><span class="token function">LoadNativeLibrary</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                  <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                                  jobject class_loader<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                                  jclass caller_class<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                                  std<span class="token operator">::</span>string<span class="token operator">*</span> error_msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  error_msg<span class="token operator">-></span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// 阶段一：判断目标 so 是否已经被加载过</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// 阶段二：加载 so</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// Open the shared library.  Because we're using a full path, the system</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">// doesn't have to search through LD_LIBRARY_PATH.  (It may do so to</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// resolve this library's dependencies though.)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">// Failures here are expected when java.library.path has several entries</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// and we have to hunt for the lib.</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">// Below we dlopen but there is no paired dlclose, this would be necessary if we supported</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">// class unloading. Libraries will only be unloaded when the reference count (incremented by</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token comment">// dlopen) becomes zero from dlclose.</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment">// Retrieve the library path from the classloader, if necessary.</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  ScopedLocalRef<span class="token operator">&lt;</span>jstring<span class="token operator">></span> <span class="token function">library_path</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token function">GetLibrarySearchPath</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> class_loader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  Locks<span class="token operator">::</span>mutator_lock_<span class="token operator">-></span><span class="token function">AssertNotHeld</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path_str <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> nullptr <span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  bool needs_native_bridge <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">char</span><span class="token operator">*</span> nativeloader_error_msg <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token comment">// 调用 dlopen 打开目标 so</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">void</span><span class="token operator">*</span> handle <span class="token operator">=</span> android<span class="token operator">::</span><span class="token function">OpenNativeLibrary</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      env<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      runtime_<span class="token operator">-></span><span class="token function">GetTargetSdkVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      path_str<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      class_loader<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token punctuation">(</span>caller_location<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> nullptr <span class="token operator">:</span> caller_location<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      library_path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token operator">&amp;</span>needs_native_bridge<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token operator">&amp;</span>nativeloader_error_msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[Call to dlopen(\""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\", RTLD_NOW) returned "</span> <span class="token operator">&lt;&lt;</span> handle <span class="token operator">&lt;&lt;</span> <span class="token string">"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token operator">*</span>error_msg <span class="token operator">=</span> nativeloader_error_msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    android<span class="token operator">::</span><span class="token function">NativeLoaderFreeErrorMessage</span><span class="token punctuation">(</span>nativeloader_error_msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"dlopen(\""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\", RTLD_NOW) failed: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>error_msg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token function">ExceptionCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> JNI_TRUE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Unexpected exception:"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    env<span class="token operator">-></span><span class="token function">ExceptionDescribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    env<span class="token operator">-></span><span class="token function">ExceptionClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token comment">// Create a new entry.</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token comment">// TODO: move the locking (and more of this logic) into Libraries.</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  bool created_library <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">// Create SharedLibrary ahead of taking the libraries lock to maintain lock ordering.</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>SharedLibrary<span class="token operator">></span> <span class="token function">new_library</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        new <span class="token function">SharedLibrary</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                          self<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                          path<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                          handle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                          needs_native_bridge<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                          class_loader<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                          class_loader_allocator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>    MutexLock <span class="token function">mu</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>Locks<span class="token operator">::</span>jni_libraries_lock_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    library <span class="token operator">=</span> libraries_<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>library <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// We won race to get libraries_lock.</span></pre></td></tr><tr><td data-num="71"></td><td><pre>      library <span class="token operator">=</span> new_library<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      libraries_<span class="token operator">-></span><span class="token function">Put</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> library<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      created_library <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>created_library<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"WOW: we lost a race to add shared library: "</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token operator">&lt;&lt;</span> <span class="token string">"\""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\" ClassLoader="</span> <span class="token operator">&lt;&lt;</span> class_loader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">return</span> library<span class="token operator">-></span><span class="token function">CheckOnLoadResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token comment">// 动态链接库装载完成</span></pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[Added shared library \""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\" for ClassLoader "</span> <span class="token operator">&lt;&lt;</span> class_loader <span class="token operator">&lt;&lt;</span> <span class="token string">"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token comment">// 阶段三：当 so 被加载之后，立即调用导出函数 JNI_OnLoad</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="androidopennativelibrary"><a class="anchor" href="#androidopennativelibrary">#</a> android::OpenNativeLibrary</h2>
<p>这个函数中有条件编译，接下来我们分析的是 <code>ART_TARGET_ANDROID</code>  的编译条件分支</p>
<p>跟踪 <code>path</code>  参数，可以发现它被传入到了 <code>android_dlopen_ext(const char* filename, int flag, const android_dlextinfo* extinfo)</code>  函数中， <code>flag</code>   <code>RTLD_NOW</code>  的含义是立即解析所有符号，并在加载时报告任何解析错误</p>
<blockquote>
<p><code>android_dlopen_ext</code>  函数的常见 <code>flag</code>  含义</p>
<ul>
<li>RTLD_NOW<br>
 立即解析所有符号，并在加载时报告任何解析错误</li>
<li>RTLD_LAZY<br>
 只在符号首次使用时解析</li>
<li>RTLD_GLOBAL<br>
 将库及其符号添加到全局命名空间中，以便其他库可以使用这些符号</li>
</ul>
</blockquote>
<p><code>extinfo</code>  的值为 <code>&#123;.flags = ANDROID_DLEXT_USE_NAMESPACE,.library_namespace = boot_namespace,&#125;;</code></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\art\libnativeloader\native_loader.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">OpenNativeLibrary</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token class-name">int32_t</span> target_sdk_version<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                        jobject class_loader<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> caller_location<span class="token punctuation">,</span> jstring library_path<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                        bool<span class="token operator">*</span> needs_native_bridge<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> error_msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 条件编译</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//ART_TARGET_ANDROID - Defined for target Android builds of ART.</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">//ref: https://android.googlesource.com/platform/art/+/32c8337/runtime/globals.h</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>ART_TARGET_ANDROID<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token function">UNUSED</span><span class="token punctuation">(</span>target_sdk_version<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>class_loader <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token operator">*</span>needs_native_bridge <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>caller_location <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token class-name">android_namespace_t</span><span class="token operator">*</span> boot_namespace <span class="token operator">=</span> <span class="token function">FindExportedNamespace</span><span class="token punctuation">(</span>caller_location<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>boot_namespace <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">const</span> android_dlextinfo dlextinfo <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">.</span>flags <span class="token operator">=</span> ANDROID_DLEXT_USE_NAMESPACE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token punctuation">.</span>library_namespace <span class="token operator">=</span> boot_namespace<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token comment">// 调用 android_dlopen_ext, 并传入 path</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">void</span><span class="token operator">*</span> handle <span class="token operator">=</span> <span class="token function">android_dlopen_ext</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> RTLD_NOW<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dlextinfo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          <span class="token operator">*</span>error_msg <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token function">dlerror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> handle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// Check if the library is in NATIVELOADER_DEFAULT_NAMESPACE_LIBS and should</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// be loaded from the kNativeloaderExtraLibs namespace.</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      Result<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span> handle <span class="token operator">=</span> <span class="token function">TryLoadNativeloaderExtraLib</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handle<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token operator">*</span>error_msg <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>handle<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">return</span> handle<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token comment">// Fall back to the system namespace. This happens for preloaded JNI</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">// libraries in the zygote.</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token comment">// TODO(b/185833744): Investigate if this should fall back to the app main</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">// namespace (aka anonymous namespace) instead.</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">void</span><span class="token operator">*</span> handle <span class="token operator">=</span> <span class="token function">OpenSystemLibrary</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token operator">*</span>error_msg <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token function">dlerror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">return</span> handle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>  std<span class="token operator">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">guard</span><span class="token punctuation">(</span>g_namespaces_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  NativeLoaderNamespace<span class="token operator">*</span> ns<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ns <span class="token operator">=</span> g_namespaces<span class="token operator">-></span><span class="token function">FindNamespaceByClassLoader</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> class_loader<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">// This is the case where the classloader was not created by ApplicationLoaders</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token comment">// In this case we create an isolated not-shared namespace for it.</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    Result<span class="token operator">&lt;</span>NativeLoaderNamespace<span class="token operator">*</span><span class="token operator">></span> isolated_ns <span class="token operator">=</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token function">CreateClassLoaderNamespaceLocked</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                                         target_sdk_version<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                                         class_loader<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                                         <span class="token comment">/*is_shared=*/</span>false<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                                         <span class="token comment">/*dex_path=*/</span>nullptr<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                                         library_path<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                                         <span class="token comment">/*permitted_path=*/</span>nullptr<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                                         <span class="token comment">/*uses_library_list=*/</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolated_ns<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>      <span class="token operator">*</span>error_msg <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>isolated_ns<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      ns <span class="token operator">=</span> <span class="token operator">*</span>isolated_ns<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">OpenNativeLibraryInNamespace</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> path<span class="token punctuation">,</span> needs_native_bridge<span class="token punctuation">,</span> error_msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token function">UNUSED</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> target_sdk_version<span class="token punctuation">,</span> class_loader<span class="token punctuation">,</span> caller_location<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token comment">// Do some best effort to emulate library-path support. It will not</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token comment">// work for dependencies.</span></pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="83"></td><td><pre>  <span class="token comment">// Note: null has a special meaning and must be preserved.</span></pre></td></tr><tr><td data-num="84"></td><td><pre>  std<span class="token operator">::</span>string c_library_path<span class="token punctuation">;</span>  <span class="token comment">// Empty string by default.</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>library_path <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> path <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    ScopedUtfChars <span class="token function">library_path_utf_chars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> library_path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    c_library_path <span class="token operator">=</span> library_path_utf_chars<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">></span> library_paths <span class="token operator">=</span> base<span class="token operator">::</span><span class="token function">Split</span><span class="token punctuation">(</span>c_library_path<span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> lib_path <span class="token operator">:</span> library_paths<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token operator">*</span>needs_native_bridge <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path_arg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    std<span class="token operator">::</span>string complete_path<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>      <span class="token comment">// Preserve null.</span></pre></td></tr><tr><td data-num="98"></td><td><pre>      path_arg <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>      complete_path <span class="token operator">=</span> lib_path<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>complete_path<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>        complete_path<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>      complete_path<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>      path_arg <span class="token operator">=</span> complete_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token keyword">void</span><span class="token operator">*</span> handle <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span>path_arg<span class="token punctuation">,</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>      <span class="token keyword">return</span> handle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">NativeBridgeIsSupported</span><span class="token punctuation">(</span>path_arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>      <span class="token operator">*</span>needs_native_bridge <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>      handle <span class="token operator">=</span> <span class="token function">NativeBridgeLoadLibrary</span><span class="token punctuation">(</span>path_arg<span class="token punctuation">,</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>        <span class="token keyword">return</span> handle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>      <span class="token operator">*</span>error_msg <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token function">NativeBridgeGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>      <span class="token operator">*</span>error_msg <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span><span class="token function">dlerror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>  <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="android_dlopen_ext"><a class="anchor" href="#android_dlopen_ext">#</a> android_dlopen_ext</h2>
<p><code>android_dlopen_ext</code>  调用了 <code>__loader_android_dlopen_ext</code></p>
<p>在代码的第四行出现了内建函数 <code>__builtin_return_address(LEVEL)</code> , 这个函数用来返回当前函数或调用者的返回地址。函数的参数 LEVEL 表示函数调用链中的不同层次的函数，各个值代表的意义如下:</p>
<ul>
<li>0：返回当前函数的返回地址；</li>
<li>1：返回当前函数调用者的返回地址；</li>
<li>2：返回当前函数调用者的调用者的返回地址；</li>
</ul>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\libdl\libdl.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__weak__<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">android_dlopen_ext</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> extinfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> caller_addr <span class="token operator">=</span> <span class="token function">__builtin_return_address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">__loader_android_dlopen_ext</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> extinfo<span class="token punctuation">,</span> caller_addr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="__loader_android_dlopen_ext"><a class="anchor" href="#__loader_android_dlopen_ext">#</a> __loader_android_dlopen_ext</h2>
<p><code>__loader_android_dlopen_ext</code>  调用了 <code>dlopen_ext</code></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\dlfcn.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">__loader_android_dlopen_ext</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                           <span class="token keyword">int</span> flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                           <span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> extinfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                           <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> caller_addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">dlopen_ext</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> extinfo<span class="token punctuation">,</span> caller_addr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="dlopen_ext"><a class="anchor" href="#dlopen_ext">#</a> dlopen_ext</h2>
<p><code>dlopen_ext</code>  中调用了 <code>do_dlopen</code></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\dlfcn.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">dlopen_ext</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                        <span class="token keyword">int</span> flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                        <span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> extinfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                        <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> caller_addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  ScopedPthreadMutexLocker <span class="token function">locker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_dl_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  g_linker_logger<span class="token punctuation">.</span><span class="token function">ResetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">void</span><span class="token operator">*</span> result <span class="token operator">=</span> <span class="token function">do_dlopen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> extinfo<span class="token punctuation">,</span> caller_addr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">__bionic_format_dlerror</span><span class="token punctuation">(</span><span class="token string">"dlopen failed"</span><span class="token punctuation">,</span> <span class="token function">linker_get_error_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="do_dlopen"><a class="anchor" href="#do_dlopen">#</a> do_dlopen</h2>
<p>这个函数中最为关键的是调用 <code>find_library</code>  获取到了待加载 <code>so</code>  的 <code>soinfo</code></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">do_dlopen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                <span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> extinfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> caller_addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  std<span class="token operator">::</span>string trace_prefix <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"dlopen: "</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> nullptr <span class="token operator">?</span> <span class="token string">"(nullptr)"</span> <span class="token operator">:</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  ScopedTrace <span class="token function">trace</span><span class="token punctuation">(</span>trace_prefix<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  ScopedTrace <span class="token function">loading_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>trace_prefix <span class="token operator">+</span> <span class="token string">" - loading and linking"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  soinfo<span class="token operator">*</span> <span class="token keyword">const</span> caller <span class="token operator">=</span> <span class="token function">find_containing_library</span><span class="token punctuation">(</span>caller_addr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token class-name">android_namespace_t</span><span class="token operator">*</span> ns <span class="token operator">=</span> <span class="token function">get_caller_namespace</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>         <span class="token string">"dlopen(name=\"%s\", flags=0x%x, extinfo=%s, caller=\"%s\", caller_ns=%s@%p, targetSdkVersion=%i) ..."</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>         name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>         flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>         <span class="token function">android_dlextinfo_to_string</span><span class="token punctuation">(</span>extinfo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>         caller <span class="token operator">==</span> nullptr <span class="token operator">?</span> <span class="token string">"(null)"</span> <span class="token operator">:</span> caller<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>         ns <span class="token operator">==</span> nullptr <span class="token operator">?</span> <span class="token string">"(null)"</span> <span class="token operator">:</span> ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>         ns<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>         <span class="token function">get_application_target_sdk_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">auto</span> purge_guard <span class="token operator">=</span> android<span class="token operator">::</span>base<span class="token operator">::</span><span class="token function">make_scope_guard</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">purge_unused_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">auto</span> failure_guard <span class="token operator">=</span> android<span class="token operator">::</span>base<span class="token operator">::</span><span class="token function">make_scope_guard</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span> <span class="token string">"... dlopen failed: %s"</span><span class="token punctuation">,</span> <span class="token function">linker_get_error_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token comment">// 对 flags 的合法性进行判断</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>RTLD_NOW<span class="token operator">|</span>RTLD_LAZY<span class="token operator">|</span>RTLD_LOCAL<span class="token operator">|</span>RTLD_GLOBAL<span class="token operator">|</span>RTLD_NODELETE<span class="token operator">|</span>RTLD_NOLOAD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">DL_OPEN_ERR</span><span class="token punctuation">(</span><span class="token string">"invalid flags to dlopen: %x"</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token comment">// 对 extinfo 的合法性进行判断</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>extinfo <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>ANDROID_DLEXT_VALID_FLAG_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token function">DL_OPEN_ERR</span><span class="token punctuation">(</span><span class="token string">"invalid extended flags to android_dlopen_ext: 0x%"</span> PRIx64<span class="token punctuation">,</span> extinfo<span class="token operator">-></span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_USE_LIBRARY_FD<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">(</span>extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token function">DL_OPEN_ERR</span><span class="token punctuation">(</span><span class="token string">"invalid extended flag combination (ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET without "</span></pre></td></tr><tr><td data-num="42"></td><td><pre>          <span class="token string">"ANDROID_DLEXT_USE_LIBRARY_FD): 0x%"</span> PRIx64<span class="token punctuation">,</span> extinfo<span class="token operator">-></span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_USE_NAMESPACE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>extinfo<span class="token operator">-></span>library_namespace <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token function">DL_OPEN_ERR</span><span class="token punctuation">(</span><span class="token string">"ANDROID_DLEXT_USE_NAMESPACE is set but extinfo->library_namespace is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      ns <span class="token operator">=</span> extinfo<span class="token operator">-></span>library_namespace<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token comment">// Workaround for dlopen(/system/lib/&lt;soname>) when .so is in /apex. http://b/121248172</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token comment">// The workaround works only when targetSdkVersion &lt; Q.</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token comment">// 当 apk 的 targetSdkVersion&lt;Q 时才会将 /system 路径转换成 /apex 路径 (不太清楚这样做的意义是什么)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  std<span class="token operator">::</span>string name_to_apex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">translateSystemPathToApexPath</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>name_to_apex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> new_name <span class="token operator">=</span> name_to_apex<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span> <span class="token string">"dlopen considering translation from %s to APEX path %s"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>           name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="63"></td><td><pre>           new_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token comment">// Some APEXs could be optionally disabled. Only translate the path</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token comment">// when the old file is absent and the new file exists.</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token comment">// TODO(b/124218500): Re-enable it once app compat issue is resolved</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    if (file_exists(name)) &#123;</pre></td></tr><tr><td data-num="69"></td><td><pre>      LD_LOG(kLogDlopen, "dlopen %s exists, not translating", name);</pre></td></tr><tr><td data-num="70"></td><td><pre>    &#125; else</pre></td></tr><tr><td data-num="71"></td><td><pre>    */</pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span>new_name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span> <span class="token string">"dlopen %s does not exist, not translating"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="74"></td><td><pre>             new_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>      <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span> <span class="token string">"dlopen translation accepted: using %s"</span><span class="token punctuation">,</span> new_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>      name <span class="token operator">=</span> new_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token comment">// End Workaround for dlopen(/system/lib/&lt;soname>) when .so is in /apex.</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>  std<span class="token operator">::</span>string asan_name_holder<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> translated_name <span class="token operator">=</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>g_is_asan <span class="token operator">&amp;&amp;</span> translated_name <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> translated_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token keyword">char</span> original_path<span class="token punctuation">[</span>PATH_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">realpath</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> original_path<span class="token punctuation">)</span> <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>      asan_name_holder <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span>kAsanLibDirPrefix<span class="token punctuation">)</span> <span class="token operator">+</span> original_path<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>asan_name_holder<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        soinfo<span class="token operator">*</span> si <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">find_loaded_library_by_realpath</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> original_path<span class="token punctuation">,</span> true<span class="token punctuation">,</span> <span class="token operator">&amp;</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>          <span class="token function">PRINT</span><span class="token punctuation">(</span><span class="token string">"linker_asan dlopen NOT translating \"%s\" -> \"%s\": library already loaded"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                asan_name_holder<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>          <span class="token function">PRINT</span><span class="token punctuation">(</span><span class="token string">"linker_asan dlopen translating \"%s\" -> \"%s\""</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> translated_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>          translated_name <span class="token operator">=</span> asan_name_holder<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre>  ProtectedDataGuard guard<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>  <span class="token comment">// 重头戏，这里调用了 find_library 获取到了这个 so 的 soinfo</span></pre></td></tr><tr><td data-num="104"></td><td><pre>  soinfo<span class="token operator">*</span> si <span class="token operator">=</span> <span class="token function">find_library</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> translated_name<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> extinfo<span class="token punctuation">,</span> caller<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>  loading_trace<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>si <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token keyword">void</span><span class="token operator">*</span> handle <span class="token operator">=</span> si<span class="token operator">-></span><span class="token function">to_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="110"></td><td><pre>           <span class="token string">"... dlopen calling constructors: realpath=\"%s\", soname=\"%s\", handle=%p"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="111"></td><td><pre>           si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> si<span class="token operator">-></span><span class="token function">get_soname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>    <span class="token comment">// 调用 call_constructors 函数来加载 so 中的 init 以及 init_array</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    si<span class="token operator">-></span><span class="token function">call_constructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>    failure_guard<span class="token punctuation">.</span><span class="token function">Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="116"></td><td><pre>           <span class="token string">"... dlopen successful: realpath=\"%s\", soname=\"%s\", handle=%p"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="117"></td><td><pre>           si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> si<span class="token operator">-></span><span class="token function">get_soname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>    <span class="token keyword">return</span> handle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="soinfo"><a class="anchor" href="#soinfo">#</a> soinfo</h3>
<p><code>soinfo</code>  结构体如下所示，可以用在 frida 或者 ida 中</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//IMPORTANT</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">//ELF64 启用该宏</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__LP64__</span>  <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//ELF32 启用该宏</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//#define __work_around_b_24465209__  1</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="8"></td><td><pre>//https://android.googlesource.com/platform/bionic/+/master/linker/Android.bp</pre></td></tr><tr><td data-num="9"></td><td><pre>架构为 32 位 定义__work_around_b_24465209__宏</pre></td></tr><tr><td data-num="10"></td><td><pre>arch: &#123;</pre></td></tr><tr><td data-num="11"></td><td><pre>        arm: &#123;cflags: ["-D__work_around_b_24465209__"],&#125;,</pre></td></tr><tr><td data-num="12"></td><td><pre>        x86: &#123;cflags: ["-D__work_around_b_24465209__"],&#125;,</pre></td></tr><tr><td data-num="13"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num="14"></td><td><pre>*/</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">//android-platform\bionic\libc\include\link.h</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ElfW</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">)</span> Elf64_ </span><span class="token punctuation">##</span> <span class="token expression">type</span></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ElfW</span><span class="token expression"><span class="token punctuation">(</span>type<span class="token punctuation">)</span> Elf32_ </span><span class="token punctuation">##</span> <span class="token expression">type</span></span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_common_types.h</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">// Android uses RELA for LP64.</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USE_RELA</span> <span class="token expression"><span class="token number">1</span></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">//android-platform\bionic\libc\kernel\uapi\asm-generic\int-ll64.h</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">//__signed__-->signed</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">signed</span> <span class="token keyword">char</span> __s8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> __u8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">signed</span> <span class="token keyword">short</span> __s16<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> __u16<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">signed</span> <span class="token keyword">int</span> __s32<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> __u32<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">signed</span> <span class="token keyword">long</span> <span class="token keyword">long</span> __s64<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> __u64<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">//A12-src\msm-google\include\uapi\linux\elf.h</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">/* 32-bit ELF base types. */</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">typedef</span> __u32	Elf32_Addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token keyword">typedef</span> __u16	Elf32_Half<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">typedef</span> __u32	Elf32_Off<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token keyword">typedef</span> __s32	Elf32_Sword<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">typedef</span> __u32	Elf32_Word<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">/* 64-bit ELF base types. */</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token keyword">typedef</span> __u64	Elf64_Addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token keyword">typedef</span> __u16	Elf64_Half<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token keyword">typedef</span> __s16	Elf64_SHalf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token keyword">typedef</span> __u64	Elf64_Off<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token keyword">typedef</span> __s32	Elf64_Sword<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token keyword">typedef</span> __u32	Elf64_Word<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token keyword">typedef</span> __u64	Elf64_Xword<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token keyword">typedef</span> __s64	Elf64_Sxword<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dynamic</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  Elf32_Sword d_tag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token keyword">union</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    Elf32_Sword	d_val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    Elf32_Addr	d_ptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token punctuation">&#125;</span> d_un<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Dyn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  Elf64_Sxword d_tag<span class="token punctuation">;</span>		<span class="token comment">/* entry tag value */</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token keyword">union</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    Elf64_Xword d_val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    Elf64_Addr d_ptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token punctuation">&#125;</span> d_un<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Dyn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf32_rel</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  Elf32_Addr	r_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  Elf32_Word	r_info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Rel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_rel</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  Elf64_Addr r_offset<span class="token punctuation">;</span>	<span class="token comment">/* Location at which to apply the action */</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  Elf64_Xword r_info<span class="token punctuation">;</span>	<span class="token comment">/* index and type of relocation */</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Rel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf32_rela</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  Elf32_Addr	r_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  Elf32_Word	r_info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  Elf32_Sword	r_addend<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Rela<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_rela</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  Elf64_Addr r_offset<span class="token punctuation">;</span>	<span class="token comment">/* Location at which to apply the action */</span></pre></td></tr><tr><td data-num="92"></td><td><pre>  Elf64_Xword r_info<span class="token punctuation">;</span>	<span class="token comment">/* index and type of relocation */</span></pre></td></tr><tr><td data-num="93"></td><td><pre>  Elf64_Sxword r_addend<span class="token punctuation">;</span>	<span class="token comment">/* Constant addend used to compute value */</span></pre></td></tr><tr><td data-num="94"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Rela<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre></pre></td></tr><tr><td data-num="96"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf32_sym</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>  Elf32_Word	st_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>  Elf32_Addr	st_value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>  Elf32_Word	st_size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	st_info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	st_other<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>  Elf32_Half	st_shndx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Sym<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_sym</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  Elf64_Word st_name<span class="token punctuation">;</span>		<span class="token comment">/* Symbol name, index in string tbl */</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	st_info<span class="token punctuation">;</span>	<span class="token comment">/* Type and binding attributes */</span></pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	st_other<span class="token punctuation">;</span>	<span class="token comment">/* No defined meaning, 0 */</span></pre></td></tr><tr><td data-num="109"></td><td><pre>  Elf64_Half st_shndx<span class="token punctuation">;</span>		<span class="token comment">/* Associated section index */</span></pre></td></tr><tr><td data-num="110"></td><td><pre>  Elf64_Addr st_value<span class="token punctuation">;</span>		<span class="token comment">/* Value of the symbol */</span></pre></td></tr><tr><td data-num="111"></td><td><pre>  Elf64_Xword st_size<span class="token punctuation">;</span>		<span class="token comment">/* Associated symbol size */</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Sym<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EI_NIDENT</span>	<span class="token expression"><span class="token number">16</span></span></span></pre></td></tr><tr><td data-num="116"></td><td><pre></pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf32_hdr</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	e_ident<span class="token punctuation">[</span>EI_NIDENT<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  Elf32_Half	e_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>  Elf32_Half	e_machine<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  Elf32_Word	e_version<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>  Elf32_Addr	e_entry<span class="token punctuation">;</span>  <span class="token comment">/* Entry point */</span></pre></td></tr><tr><td data-num="123"></td><td><pre>  Elf32_Off	e_phoff<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>  Elf32_Off	e_shoff<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>  Elf32_Word	e_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>  Elf32_Half	e_ehsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>  Elf32_Half	e_phentsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>  Elf32_Half	e_phnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>  Elf32_Half	e_shentsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>  Elf32_Half	e_shnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>  Elf32_Half	e_shstrndx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Ehdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre></pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_hdr</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	e_ident<span class="token punctuation">[</span>EI_NIDENT<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* ELF "magic number" */</span></pre></td></tr><tr><td data-num="136"></td><td><pre>  Elf64_Half e_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>  Elf64_Half e_machine<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>  Elf64_Word e_version<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>  Elf64_Addr e_entry<span class="token punctuation">;</span>		<span class="token comment">/* Entry point virtual address */</span></pre></td></tr><tr><td data-num="140"></td><td><pre>  Elf64_Off e_phoff<span class="token punctuation">;</span>		<span class="token comment">/* Program header table file offset */</span></pre></td></tr><tr><td data-num="141"></td><td><pre>  Elf64_Off e_shoff<span class="token punctuation">;</span>		<span class="token comment">/* Section header table file offset */</span></pre></td></tr><tr><td data-num="142"></td><td><pre>  Elf64_Word e_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>  Elf64_Half e_ehsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>  Elf64_Half e_phentsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>  Elf64_Half e_phnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>  Elf64_Half e_shentsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>  Elf64_Half e_shnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>  Elf64_Half e_shstrndx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Ehdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token comment">/* These constants define the permissions on sections in the program</span></pre></td></tr><tr><td data-num="152"></td><td><pre>   header, p_flags. */</pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PF_R</span>		<span class="token expression"><span class="token number">0x4</span></span></span></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PF_W</span>		<span class="token expression"><span class="token number">0x2</span></span></span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PF_X</span>		<span class="token expression"><span class="token number">0x1</span></span></span></pre></td></tr><tr><td data-num="156"></td><td><pre></pre></td></tr><tr><td data-num="157"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf32_phdr</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="158"></td><td><pre>  Elf32_Word	p_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="159"></td><td><pre>  Elf32_Off	p_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>  Elf32_Addr	p_vaddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>  Elf32_Addr	p_paddr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>  Elf32_Word	p_filesz<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>  Elf32_Word	p_memsz<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>  Elf32_Word	p_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>  Elf32_Word	p_align<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Phdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre></pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_phdr</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>  Elf64_Word p_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>  Elf64_Word p_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>  Elf64_Off p_offset<span class="token punctuation">;</span>		<span class="token comment">/* Segment file offset */</span></pre></td></tr><tr><td data-num="172"></td><td><pre>  Elf64_Addr p_vaddr<span class="token punctuation">;</span>		<span class="token comment">/* Segment virtual address */</span></pre></td></tr><tr><td data-num="173"></td><td><pre>  Elf64_Addr p_paddr<span class="token punctuation">;</span>		<span class="token comment">/* Segment physical address */</span></pre></td></tr><tr><td data-num="174"></td><td><pre>  Elf64_Xword p_filesz<span class="token punctuation">;</span>		<span class="token comment">/* Segment size in file */</span></pre></td></tr><tr><td data-num="175"></td><td><pre>  Elf64_Xword p_memsz<span class="token punctuation">;</span>		<span class="token comment">/* Segment size in memory */</span></pre></td></tr><tr><td data-num="176"></td><td><pre>  Elf64_Xword p_align<span class="token punctuation">;</span>		<span class="token comment">/* Segment alignment, file &amp; memory */</span></pre></td></tr><tr><td data-num="177"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Phdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="178"></td><td><pre></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf32_shdr</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="180"></td><td><pre>  Elf32_Word	sh_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="181"></td><td><pre>  Elf32_Word	sh_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="182"></td><td><pre>  Elf32_Word	sh_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="183"></td><td><pre>  Elf32_Addr	sh_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>  Elf32_Off	sh_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>  Elf32_Word	sh_size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="186"></td><td><pre>  Elf32_Word	sh_link<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="187"></td><td><pre>  Elf32_Word	sh_info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>  Elf32_Word	sh_addralign<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="189"></td><td><pre>  Elf32_Word	sh_entsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="190"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Shdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre></pre></td></tr><tr><td data-num="192"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">elf64_shdr</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="193"></td><td><pre>  Elf64_Word sh_name<span class="token punctuation">;</span>		<span class="token comment">/* Section name, index in string tbl */</span></pre></td></tr><tr><td data-num="194"></td><td><pre>  Elf64_Word sh_type<span class="token punctuation">;</span>		<span class="token comment">/* Type of section */</span></pre></td></tr><tr><td data-num="195"></td><td><pre>  Elf64_Xword sh_flags<span class="token punctuation">;</span>		<span class="token comment">/* Miscellaneous section attributes */</span></pre></td></tr><tr><td data-num="196"></td><td><pre>  Elf64_Addr sh_addr<span class="token punctuation">;</span>		<span class="token comment">/* Section virtual addr at execution */</span></pre></td></tr><tr><td data-num="197"></td><td><pre>  Elf64_Off sh_offset<span class="token punctuation">;</span>		<span class="token comment">/* Section file offset */</span></pre></td></tr><tr><td data-num="198"></td><td><pre>  Elf64_Xword sh_size<span class="token punctuation">;</span>		<span class="token comment">/* Size of section in bytes */</span></pre></td></tr><tr><td data-num="199"></td><td><pre>  Elf64_Word sh_link<span class="token punctuation">;</span>		<span class="token comment">/* Index of another section */</span></pre></td></tr><tr><td data-num="200"></td><td><pre>  Elf64_Word sh_info<span class="token punctuation">;</span>		<span class="token comment">/* Additional section information */</span></pre></td></tr><tr><td data-num="201"></td><td><pre>  Elf64_Xword sh_addralign<span class="token punctuation">;</span>	<span class="token comment">/* Section alignment */</span></pre></td></tr><tr><td data-num="202"></td><td><pre>  Elf64_Xword sh_entsize<span class="token punctuation">;</span>	<span class="token comment">/* Entry size if section holds table */</span></pre></td></tr><tr><td data-num="203"></td><td><pre><span class="token punctuation">&#125;</span> Elf64_Shdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="204"></td><td><pre></pre></td></tr><tr><td data-num="205"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token class-name">uintptr_t</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="206"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">link_map</span></pre></td></tr><tr><td data-num="207"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="208"></td><td><pre>    <span class="token class-name">uintptr_t</span> l_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="209"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span> l_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="210"></td><td><pre>    <span class="token class-name">uintptr_t</span> l_ld<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="211"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">link_map</span> <span class="token operator">*</span> l_next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="212"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">link_map</span> <span class="token operator">*</span> l_prev<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="213"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="214"></td><td><pre></pre></td></tr><tr><td data-num="215"></td><td><pre></pre></td></tr><tr><td data-num="216"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_soinfo.h</span></pre></td></tr><tr><td data-num="217"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">linker_dtor_function_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="218"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">linker_ctor_function_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="219"></td><td><pre></pre></td></tr><tr><td data-num="220"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__work_around_b_24465209__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="221"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SOINFO_NAME_LEN</span> <span class="token expression"><span class="token number">128</span></span></span></pre></td></tr><tr><td data-num="222"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="223"></td><td><pre></pre></td></tr><tr><td data-num="224"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">soinfo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="225"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__work_around_b_24465209__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="226"></td><td><pre>  <span class="token keyword">char</span> old_name_<span class="token punctuation">[</span>SOINFO_NAME_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="227"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="228"></td><td><pre>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> phdr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="229"></td><td><pre>  <span class="token class-name">size_t</span> phnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="230"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__work_around_b_24465209__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="231"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> unused0<span class="token punctuation">;</span> <span class="token comment">// DO NOT USE, maintained for compatibility.</span></pre></td></tr><tr><td data-num="232"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="233"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> base<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="234"></td><td><pre>  <span class="token class-name">size_t</span> size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="235"></td><td><pre></pre></td></tr><tr><td data-num="236"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__work_around_b_24465209__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="237"></td><td><pre>  <span class="token class-name">uint32_t</span> unused1<span class="token punctuation">;</span>  <span class="token comment">// DO NOT USE, maintained for compatibility.</span></pre></td></tr><tr><td data-num="238"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="239"></td><td><pre></pre></td></tr><tr><td data-num="240"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span><span class="token operator">*</span> dynamic<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="241"></td><td><pre></pre></td></tr><tr><td data-num="242"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__work_around_b_24465209__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="243"></td><td><pre>  <span class="token class-name">uint32_t</span> unused2<span class="token punctuation">;</span> <span class="token comment">// DO NOT USE, maintained for compatibility</span></pre></td></tr><tr><td data-num="244"></td><td><pre>  <span class="token class-name">uint32_t</span> unused3<span class="token punctuation">;</span> <span class="token comment">// DO NOT USE, maintained for compatibility</span></pre></td></tr><tr><td data-num="245"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="246"></td><td><pre></pre></td></tr><tr><td data-num="247"></td><td><pre>  soinfo<span class="token operator">*</span> next<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="248"></td><td><pre>  <span class="token class-name">uint32_t</span> flags_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="249"></td><td><pre></pre></td></tr><tr><td data-num="250"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strtab_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="251"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span><span class="token operator">*</span> symtab_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="252"></td><td><pre></pre></td></tr><tr><td data-num="253"></td><td><pre>  <span class="token class-name">size_t</span> nbucket_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="254"></td><td><pre>  <span class="token class-name">size_t</span> nchain_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="255"></td><td><pre>  <span class="token class-name">uint32_t</span><span class="token operator">*</span> bucket_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="256"></td><td><pre>  <span class="token class-name">uint32_t</span><span class="token operator">*</span> chain_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="257"></td><td><pre></pre></td></tr><tr><td data-num="258"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="259"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span> unused4<span class="token punctuation">;</span> <span class="token comment">// DO NOT USE, maintained for compatibility</span></pre></td></tr><tr><td data-num="260"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="261"></td><td><pre></pre></td></tr><tr><td data-num="262"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>USE_RELA<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="263"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Rela<span class="token punctuation">)</span><span class="token operator">*</span> plt_rela_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="264"></td><td><pre>  <span class="token class-name">size_t</span> plt_rela_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="265"></td><td><pre></pre></td></tr><tr><td data-num="266"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Rela<span class="token punctuation">)</span><span class="token operator">*</span> rela_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="267"></td><td><pre>  <span class="token class-name">size_t</span> rela_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="268"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="269"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Rel<span class="token punctuation">)</span><span class="token operator">*</span> plt_rel_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="270"></td><td><pre>  <span class="token class-name">size_t</span> plt_rel_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="271"></td><td><pre></pre></td></tr><tr><td data-num="272"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Rel<span class="token punctuation">)</span><span class="token operator">*</span> rel_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="273"></td><td><pre>  <span class="token class-name">size_t</span> rel_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="274"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="275"></td><td><pre></pre></td></tr><tr><td data-num="276"></td><td><pre>  <span class="token class-name">linker_ctor_function_t</span><span class="token operator">*</span> preinit_array_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="277"></td><td><pre>  <span class="token class-name">size_t</span> preinit_array_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="278"></td><td><pre></pre></td></tr><tr><td data-num="279"></td><td><pre>  <span class="token class-name">linker_ctor_function_t</span><span class="token operator">*</span> init_array_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="280"></td><td><pre>  <span class="token class-name">size_t</span> init_array_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="281"></td><td><pre>  <span class="token class-name">linker_dtor_function_t</span><span class="token operator">*</span> fini_array_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="282"></td><td><pre>  <span class="token class-name">size_t</span> fini_array_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="283"></td><td><pre></pre></td></tr><tr><td data-num="284"></td><td><pre>  <span class="token class-name">linker_ctor_function_t</span> init_func_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="285"></td><td><pre>  <span class="token class-name">linker_dtor_function_t</span> fini_func_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="286"></td><td><pre></pre></td></tr><tr><td data-num="287"></td><td><pre></pre></td></tr><tr><td data-num="288"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__arm__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="289"></td><td><pre>  <span class="token comment">// ARM EABI section used for stack unwinding.</span></pre></td></tr><tr><td data-num="290"></td><td><pre>  <span class="token class-name">uint32_t</span><span class="token operator">*</span> ARM_exidx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="291"></td><td><pre>  <span class="token class-name">size_t</span> ARM_exidx_count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="292"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="293"></td><td><pre>  <span class="token class-name">size_t</span> ref_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="294"></td><td><pre></pre></td></tr><tr><td data-num="295"></td><td><pre>  link_map link_map_head<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="296"></td><td><pre></pre></td></tr><tr><td data-num="297"></td><td><pre>  bool constructors_called<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="298"></td><td><pre></pre></td></tr><tr><td data-num="299"></td><td><pre>  <span class="token comment">// When you read a virtual address from the ELF file, add this</span></pre></td></tr><tr><td data-num="300"></td><td><pre>  <span class="token comment">// value to get the corresponding address in the process' address space.</span></pre></td></tr><tr><td data-num="301"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> load_bias<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="302"></td><td><pre></pre></td></tr><tr><td data-num="303"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="304"></td><td><pre>  bool has_text_relocations<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="305"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="306"></td><td><pre>  bool has_DT_SYMBOLIC<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="307"></td><td><pre></pre></td></tr><tr><td data-num="308"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="call_constructors"><a class="anchor" href="#call_constructors">#</a> call_constructors</h3>
<p>在这个函数中会先加载 <code>init</code> , 在 so 中的函数名一般为 <code>init_proc</code> , 然后加载 <code>init_array</code>  中的函数</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\bionic\linker\linker_soinfo.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> soinfo<span class="token double-colon punctuation">::</span><span class="token function">call_constructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>constructors_called <span class="token operator">||</span> g_is_ldd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// We set constructors_called before actually calling the constructors, otherwise it doesn't</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// protect against recursive constructor calls. One simple example of constructor recursion</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// is the libc debug malloc, which is implemented in libc_malloc_debug_leak.so:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// 1. The program depends on libc, so libc's constructor is called here.</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// 2. The libc constructor calls dlopen() to load libc_malloc_debug_leak.so.</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 3. dlopen() calls the constructors on the newly created</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">//    soinfo for libc_malloc_debug_leak.so.</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// 4. The debug .so depends on libc, so CallConstructors is</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">//    called again with the libc soinfo. If it doesn't trigger the early-</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">//    out above, the libc constructor will be called again (recursively!).</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  constructors_called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">// 在共享链接库中会忽略 DT_PREINIT_ARRAY</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_main_executable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> preinit_array_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// The GNU dynamic linker silently ignores these, but we warn the developer.</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">PRINT</span><span class="token punctuation">(</span><span class="token string">"\"%s\": ignoring DT_PREINIT_ARRAY in shared library!"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token function">get_children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>soinfo<span class="token operator">*</span> si<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    si<span class="token operator">-></span><span class="token function">call_constructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_linker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token function">bionic_trace_begin</span><span class="token punctuation">(</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"calling constructors: "</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token comment">// DT_INIT should be called before DT_INIT_ARRAY if both are present.</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token comment">// 首先加载 init, 在 so 中的函数名一般为 init_proc, 然后加载 init_array 中的函数</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token function">call_function</span><span class="token punctuation">(</span><span class="token string">"DT_INIT"</span><span class="token punctuation">,</span> init_func_<span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token function">call_array</span><span class="token punctuation">(</span><span class="token string">"DT_INIT_ARRAY"</span><span class="token punctuation">,</span> init_array_<span class="token punctuation">,</span> init_array_count_<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_linker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token function">bionic_trace_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>值得注意的是，在共享链接库中 <code>pre_initarray</code>  会被忽略掉，它在 <code>call_pre_init_constructors</code>  中，但假如你用 <code>ndk-build</code>  编译一个可以在 android 上执行的可执行文件，那么这个预初始化函数就不会被忽略啦</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\bionic\linker\linker_soinfo.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> soinfo<span class="token double-colon punctuation">::</span><span class="token function">call_pre_init_constructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>g_is_ldd<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">// DT_PREINIT_ARRAY functions are called before any other constructors for executables,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">// but ignored in a shared library.</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token function">call_array</span><span class="token punctuation">(</span><span class="token string">"DT_PREINIT_ARRAY"</span><span class="token punctuation">,</span> preinit_array_<span class="token punctuation">,</span> preinit_array_count_<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="find_library"><a class="anchor" href="#find_library">#</a> find_library</h2>
<p>接下来在 <code>find_library</code>  中调用了 <code>find_libraries</code></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> soinfo<span class="token operator">*</span> <span class="token function">find_library</span><span class="token punctuation">(</span><span class="token class-name">android_namespace_t</span><span class="token operator">*</span> ns<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                            <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> rtld_flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                            <span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> extinfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                            soinfo<span class="token operator">*</span> needed_by<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  soinfo<span class="token operator">*</span> si <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// 如果 name 是空的，则为 si 赋值为 somain</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">//somain: main process, always the one after libdl_info</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    si <span class="token operator">=</span> <span class="token function">solist_get_somain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 这个函数将会返回 somain;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">find_libraries</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                             needed_by<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                             <span class="token operator">&amp;</span>name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                             <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                             <span class="token operator">&amp;</span>si<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                             nullptr<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                             <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                             rtld_flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                             extinfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                             false <span class="token comment">/* add_as_children */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>si <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token function">soinfo_unload</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token comment">// 加载 so 成功，so 的引用次数 + 1, 对应了 JavaVMExt::LoadNativeLibrary 中</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token comment">//so 加载时 这一部分的注释↓</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token comment">/*</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  Below we dlopen but there is no paired dlclose, this would be necessary if we supported</pre></td></tr><tr><td data-num="32"></td><td><pre>  class unloading. Libraries will only be unloaded when the reference count (incremented by</pre></td></tr><tr><td data-num="33"></td><td><pre>  dlopen) becomes zero from dlclose.</pre></td></tr><tr><td data-num="34"></td><td><pre>  */</pre></td></tr><tr><td data-num="35"></td><td><pre>  si<span class="token operator">-></span><span class="token function">increment_ref_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">return</span> si<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="find_libraries"><a class="anchor" href="#find_libraries">#</a> find_libraries</h2>
<p>分析了这么久等的就是这个函数！</p>
<p>函数声明:</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    ns                                加载的命名空间 = 调用者的命名空间</pre></td></tr><tr><td data-num="4"></td><td><pre>    start_with                        调用者的 soinfo</pre></td></tr><tr><td data-num="5"></td><td><pre>    library_names                     所有加载库名称</pre></td></tr><tr><td data-num="6"></td><td><pre>    library_names_count               加载库数量</pre></td></tr><tr><td data-num="7"></td><td><pre>    soinfos                           保存加载完成的 soinfo</pre></td></tr><tr><td data-num="8"></td><td><pre>    ld_preloads                       保存预加载库，没有可以为 null</pre></td></tr><tr><td data-num="9"></td><td><pre>    ld_preloads_count                 预加载库数量</pre></td></tr><tr><td data-num="10"></td><td><pre>    extinfo                           Android 调用附带</pre></td></tr><tr><td data-num="11"></td><td><pre>    add_as_children                   是否作为 start_with 的子库</pre></td></tr><tr><td data-num="12"></td><td><pre>    search_linked_namespaces          查询链接命名空间</pre></td></tr><tr><td data-num="13"></td><td><pre>    namespaces                        链接命名空间</pre></td></tr><tr><td data-num="14"></td><td><pre>*/</pre></td></tr><tr><td data-num="15"></td><td><pre>bool <span class="token function">find_libraries</span><span class="token punctuation">(</span><span class="token class-name">android_namespace_t</span><span class="token operator">*</span> ns<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                    soinfo<span class="token operator">*</span> start_with<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> library_names<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                    <span class="token class-name">size_t</span> library_names_count<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                    soinfo<span class="token operator">*</span> soinfos<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>soinfo<span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> ld_preloads<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                    <span class="token class-name">size_t</span> ld_preloads_count<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                    <span class="token keyword">int</span> rtld_flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                    <span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> extinfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                    bool add_as_children<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token class-name">android_namespace_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token operator">*</span> namespaces<span class="token punctuation">)</span></pre></td></tr></table></figure><p>这个函数可以分为七个部分进行分析</p>
<h3 id="准备阶段"><a class="anchor" href="#准备阶段">#</a> 准备阶段</h3>
<p>这一部分将待加载的 so 添加到 <code>LoadTaskList</code>  加载任务队列中</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Step 0: prepare.</span></pre></td></tr><tr><td data-num="2"></td><td><pre>std<span class="token operator">::</span>unordered_map<span class="token operator">&lt;</span><span class="token keyword">const</span> soinfo<span class="token operator">*</span><span class="token punctuation">,</span> ElfReader<span class="token operator">></span> readers_map<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>LoadTaskList load_tasks<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 可以同时加载多个 so, 但从 find_library 传入的参数看来，library_names_count</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 的值为 1, 也就是说仅加载一个目标 path 的 so</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> library_names_count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> library_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 将这个 so push 到 load_tasks 的任务中</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    load_tasks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>LoadTask<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> start_with<span class="token punctuation">,</span> ns<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readers_map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">// If soinfos array is null allocate one on stack.</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// The array is needed in case of failure; for example</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">// when library_names[] = &#123;libone.so, libtwo.so&#125; and libone.so</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// is loaded correctly but libtwo.so failed for some reason.</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">// In this case libone.so should be unloaded on return.</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// See also implementation of failure_guard below.</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">// 为 soinfos 分配空间</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>soinfos <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token class-name">size_t</span> soinfos_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>soinfo<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span>library_names_count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    soinfos <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>soinfo<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token function">alloca</span><span class="token punctuation">(</span>soinfos_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">memset</span><span class="token punctuation">(</span>soinfos<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> soinfos_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">// list of libraries to link - see step 2.</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token class-name">size_t</span> soinfos_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">auto</span> scope_guard <span class="token operator">=</span> android<span class="token operator">::</span>base<span class="token operator">::</span><span class="token function">make_scope_guard</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span>LoadTask<span class="token operator">*</span> t <span class="token operator">:</span> load_tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        LoadTask<span class="token operator">::</span><span class="token function">deleter</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>ZipArchiveCache zip_archive_cache<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token class-name">soinfo_list_t</span> new_global_group_members<span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="寻找依赖库添加到待加载队列"><a class="anchor" href="#寻找依赖库添加到待加载队列">#</a> 寻找依赖库，添加到待加载队列</h3>
<p>将待加载的 so 的依赖库添加到 <code>load_tasks</code>  队列中，此时并不会加载依赖库</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Step 1: expand the list of load_tasks to include</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// all DT_NEEDED libraries (do not load them just yet)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>load_tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    LoadTask<span class="token operator">*</span> task <span class="token operator">=</span> load_tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    soinfo<span class="token operator">*</span> needed_by <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_needed_by</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    bool is_dt_needed <span class="token operator">=</span> needed_by <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>needed_by <span class="token operator">!=</span> start_with <span class="token operator">||</span> add_as_children<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    task<span class="token operator">-></span><span class="token function">set_extinfo</span><span class="token punctuation">(</span>is_dt_needed <span class="token operator">?</span> nullptr <span class="token operator">:</span> extinfo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    task<span class="token operator">-></span><span class="token function">set_dt_needed</span><span class="token punctuation">(</span>is_dt_needed<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span> <span class="token string">"find_libraries(ns=%s): task=%s, is_dt_needed=%d"</span><span class="token punctuation">,</span> ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>           task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is_dt_needed<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// Note: start from the namespace that is stored in the LoadTask. This namespace</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// is different from the current namespace when the LoadTask is for a transitive</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// dependency and the lib that created the LoadTask is not found in the</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// current namespace but in one of the linked namespace.</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">find_library_internal</span><span class="token punctuation">(</span>const_cast<span class="token operator">&lt;</span><span class="token class-name">android_namespace_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>task<span class="token operator">-></span><span class="token function">get_start_from</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                               task<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                               <span class="token operator">&amp;</span>zip_archive_cache<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                               <span class="token operator">&amp;</span>load_tasks<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                               rtld_flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    soinfo<span class="token operator">*</span> si <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_dt_needed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        needed_by<span class="token operator">-></span><span class="token function">add_child</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// When ld_preloads is not null, the first</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// ld_preloads_count libs are in fact ld_preloads.</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    bool is_ld_preload <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ld_preloads <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> soinfos_count <span class="token operator">&lt;</span> ld_preloads_count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        ld_preloads<span class="token operator">-></span><span class="token function">push_back</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        is_ld_preload <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>soinfos_count <span class="token operator">&lt;</span> library_names_count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        soinfos<span class="token punctuation">[</span>soinfos_count<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> si<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token comment">// Add the new global group members to all initial namespaces. Do this secondary namespace setup</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">// at the same time that libraries are added to their primary namespace so that the order of</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">// global group members is the same in the every namespace. Only add a library to a namespace</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token comment">// once, even if it appears multiple times in the dependency graph.</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_ld_preload <span class="token operator">||</span> <span class="token punctuation">(</span>si<span class="token operator">-></span><span class="token function">get_dt_flags_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> DF_1_GLOBAL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> namespaces <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>new_global_group_members<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            new_global_group_members<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> linked_ns <span class="token operator">:</span> <span class="token operator">*</span>namespaces<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> linked_ns<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                    linked_ns<span class="token operator">-></span><span class="token function">add_soinfo</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                    si<span class="token operator">-></span><span class="token function">add_secondary_namespace</span><span class="token punctuation">(</span>linked_ns<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这一步要做的是调用 <code>find_library_internal</code>  获取到这个 so 的依赖库，那么什么是 so 的依赖库呢？我们拿 ida 随便反编译一个 so, <code>Needed Library</code>  开头的就是这一个 so 的所有依赖库</p>
<p><img data-src="/android-load-so/image-20240216214503902.png" alt="image-20240216214503902" style="aspect-ratio:587 / 188;"></p>
<h4 id="find_library_internal"><a class="anchor" href="#find_library_internal">#</a> find_library_internal</h4>
<p>这里做了四次对于待加载 so 的依赖库的寻找</p>
<ol>
<li>调用 <code>find_loaded_library_by_soname</code>  这个库有没有被加载过了？加载过那么我找都不用找了直接返回寻找结果</li>
<li>正常使用 <code>load_library</code>  找依赖库</li>
<li>正常寻找找不到，那这个库是不是已经预置在系统库里面了？试试到全局命名空间 <code>g_default_namespace</code>  里面找找</li>
<li>前三种方式都失败了？启动终极解决方案，到共享命名空间 <code>linked namespace</code>  找这个 so 的依赖库，还没找到那就是真的找不到了</li>
</ol>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> bool <span class="token function">find_library_internal</span><span class="token punctuation">(</span><span class="token class-name">android_namespace_t</span><span class="token operator">*</span> ns<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                  LoadTask<span class="token operator">*</span> task<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                                  ZipArchiveCache<span class="token operator">*</span> zip_archive_cache<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                                  LoadTaskList<span class="token operator">*</span> load_tasks<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                                  <span class="token keyword">int</span> rtld_flags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  soinfo<span class="token operator">*</span> candidate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// 如果这个 so 已经被加载过了，就直接给 task 设置完 soinfo 后返回</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">find_loaded_library_by_soname</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> true <span class="token comment">/* search_linked_namespaces */</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                                    <span class="token operator">&amp;</span>candidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>           <span class="token string">"find_library_internal(ns=%s, task=%s): Already loaded (by soname): %s"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>           ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> candidate<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    task<span class="token operator">-></span><span class="token function">set_soinfo</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">// Library might still be loaded, the accurate detection</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">// of this fact is done by load_library.</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token function">TRACE</span><span class="token punctuation">(</span><span class="token string">"[ \"%s\" find_loaded_library_by_soname failed (*candidate=%s@%p). Trying harder... ]"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> candidate <span class="token operator">==</span> nullptr <span class="token operator">?</span> <span class="token string">"n/a"</span> <span class="token operator">:</span> candidate<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> candidate<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">// 关键函数，用来寻找依赖库</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">load_library</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> task<span class="token punctuation">,</span> zip_archive_cache<span class="token punctuation">,</span> load_tasks<span class="token punctuation">,</span> rtld_flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                   true <span class="token comment">/* search_linked_namespaces */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token comment">// TODO(dimitry): workaround for http://b/26394120 (the exempt-list)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token comment">//exempt lib, 即已经预置在系统库中的 so, 例如 libcrypto.so,libssl.so</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token comment">// 等等比较著名的库，假如发现是这些库的话，用默认命名空间获取 soinfo</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ns<span class="token operator">-></span><span class="token function">is_exempt_list_enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_exempt_lib</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_needed_by</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">// For the libs in the exempt-list, switch to the default namespace and then</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">// try the load again from there. The library could be loaded from the</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment">// default namespace or from another namespace (e.g. runtime) that is linked</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">// from the default namespace.</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>           <span class="token string">"find_library_internal(ns=%s, task=%s): Exempt system library - trying namespace %s"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>           ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g_default_namespace<span class="token punctuation">.</span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    ns <span class="token operator">=</span> <span class="token operator">&amp;</span>g_default_namespace<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">load_library</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> task<span class="token punctuation">,</span> zip_archive_cache<span class="token punctuation">,</span> load_tasks<span class="token punctuation">,</span> rtld_flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                     true <span class="token comment">/* search_linked_namespaces */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token comment">// END OF WORKAROUND</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token comment">// if a library was not found - look into linked namespaces</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token comment">// preserve current dlerror in the case it fails.</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token comment">// 假如找遍了自己的命名空间还是没找到这个 so 的依赖库的话，就去共享命名空间 (linked namespace)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token comment">// 里面去找找看</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  DlErrorRestorer dlerror_restorer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span> <span class="token string">"find_library_internal(ns=%s, task=%s): Trying %zu linked namespaces"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="55"></td><td><pre>         ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ns<span class="token operator">-></span><span class="token function">linked_namespaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> linked_namespace <span class="token operator">:</span> ns<span class="token operator">-></span><span class="token function">linked_namespaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">find_library_in_linked_namespace</span><span class="token punctuation">(</span>linked_namespace<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>      <span class="token comment">// Library is already loaded.</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token comment">// n.b. This code path runs when find_library_in_linked_namespace found an already-loaded</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token comment">// library by soname. That should only be possible with a exempt-list lookup, where we</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token comment">// switch the namespace, because otherwise, find_library_in_linked_namespace is duplicating</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token comment">// the soname scan done in this function's first call to find_loaded_library_by_soname.</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">load_library</span><span class="token punctuation">(</span>linked_namespace<span class="token punctuation">.</span><span class="token function">linked_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">,</span> zip_archive_cache<span class="token punctuation">,</span> load_tasks<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                       rtld_flags<span class="token punctuation">,</span> false <span class="token comment">/* search_linked_namespaces */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span> <span class="token string">"find_library_internal(ns=%s, task=%s): Found in linked namespace %s"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="70"></td><td><pre>               ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> linked_namespace<span class="token punctuation">.</span><span class="token function">linked_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="load_library"><a class="anchor" href="#load_library">#</a> load_library</h4>
<p>函数声明:</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> bool <span class="token function">load_library</span><span class="token punctuation">(</span><span class="token class-name">android_namespace_t</span><span class="token operator">*</span> ns<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                         LoadTask<span class="token operator">*</span> task<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                         ZipArchiveCache<span class="token operator">*</span> zip_archive_cache<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                         LoadTaskList<span class="token operator">*</span> load_tasks<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                         <span class="token keyword">int</span> rtld_flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                         bool search_linked_namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>在这个函数中，首先判断 <code>extinfo-&gt;flags</code>  是否是 <code>ANDROID_DLEXT_USE_LIBRARY_FD</code> , 如果同时有 <code>ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET</code> , 标志在<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vbmRrL3JlZmVyZW5jZS9ncm91cC9saWJkbA=="> Android 官网的解释</span>如下</p>
<p><img data-src="/android-load-so/image-20240217132018399.png" alt="image-20240217132018399" style="aspect-ratio:1095 / 403;"></p>
<p>那这样就方便了，假如已经有了这个 library 的 <code>fd</code>  文件描述符，那直接拿过来用就可以了</p>
<p>但是我们待加载的 so 的 <code>extinfo-&gt;flags</code>  已经在 <code>android::OpenNativeLibrary</code>  中被定义为 <code>ANDROID_DLEXT_USE_NAMESPACE</code>  了，这个标志的含义在上图中也有给出，所以很遗憾，这个 <code>if</code>  语句中的代码并不会被执行</p>
<p><img data-src="/android-load-so/image-20240217131920074.png" alt="image-20240217131920074" style="aspect-ratio:479 / 82;"></p>
<p>那么为什么要特意在此处加入这个 if 语句呢？</p>
<p>我的理解是为了提高运行的效率，有一些底层的库已经打开过，加载过了，那么就完全没有必要再打开，搜索一次，直接把 library 的 <code>fd</code>  文件描述符拿过来用就可以了</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>soinfo<span class="token operator">*</span> needed_by <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_needed_by</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> extinfo <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_extinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 如果 extinfo->flags 的标记是 ANDROID_DLEXT_USE_LIBRARY_FD, 则直接通过</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//fd 文件描述符来打开</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>extinfo <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_USE_LIBRARY_FD<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">off64_t</span> file_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        file_offset <span class="token operator">=</span> extinfo<span class="token operator">-></span>library_fd_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    std<span class="token operator">::</span>string realpath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">realpath_fd</span><span class="token punctuation">(</span>extinfo<span class="token operator">-></span>library_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>realpath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_first_stage_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token function">PRINT</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token string">"warning: unable to get realpath for the library \"%s\" by extinfo->library_fd. "</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token string">"Will use given name."</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        realpath <span class="token operator">=</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    task<span class="token operator">-></span><span class="token function">set_fd</span><span class="token punctuation">(</span>extinfo<span class="token operator">-></span>library_fd<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    task<span class="token operator">-></span><span class="token function">set_file_offset</span><span class="token punctuation">(</span>file_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">load_library</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> task<span class="token punctuation">,</span> load_tasks<span class="token punctuation">,</span> rtld_flags<span class="token punctuation">,</span> realpath<span class="token punctuation">,</span> search_linked_namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>之后，我们千辛万苦终于看到了这对于待加载的 so 的第一个操作，调用 <code>open_library</code>  打开它</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Open the file.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">off64_t</span> file_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>std<span class="token operator">::</span>string realpath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open_library</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> zip_archive_cache<span class="token punctuation">,</span> name<span class="token punctuation">,</span> needed_by<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>realpath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 如果打开 so 失败，寻找失败原因</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token operator">-></span><span class="token function">is_dt_needed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>needed_by<span class="token operator">-></span><span class="token function">is_main_executable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token function">DL_OPEN_ERR</span><span class="token punctuation">(</span><span class="token string">"library \"%s\" not found: needed by main executable"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token function">DL_OPEN_ERR</span><span class="token punctuation">(</span><span class="token string">"library \"%s\" not found: needed by %s in namespace %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                        needed_by<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_start_from</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token function">DL_OPEN_ERR</span><span class="token punctuation">(</span><span class="token string">"library \"%s\" not found"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">//set fd and file_offset</span></pre></td></tr><tr><td data-num="21"></td><td><pre>task<span class="token operator">-></span><span class="token function">set_fd</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>task<span class="token operator">-></span><span class="token function">set_file_offset</span><span class="token punctuation">(</span>file_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>我们知道 <code>System.load</code>  需要指定待加载的 so 的绝对路径，这在 <code>open_library</code>  中便符合第一个 if 语句，所以接下来将会调用 <code>open_library_at_path</code></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">open_library</span><span class="token punctuation">(</span><span class="token class-name">android_namespace_t</span><span class="token operator">*</span> ns<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                        ZipArchiveCache<span class="token operator">*</span> zip_archive_cache<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                        <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> soinfo <span class="token operator">*</span>needed_by<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                        <span class="token class-name">off64_t</span><span class="token operator">*</span> file_offset<span class="token punctuation">,</span> std<span class="token operator">::</span>string<span class="token operator">*</span> realpath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">TRACE</span><span class="token punctuation">(</span><span class="token string">"[ opening %s from namespace %s ]"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// If the name contains a slash, we should attempt to open it directly and not search the paths.</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// 有斜杠，说明是绝对路径打开的</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strchr</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">open_library_at_path</span><span class="token punctuation">(</span>zip_archive_cache<span class="token punctuation">,</span> name<span class="token punctuation">,</span> file_offset<span class="token punctuation">,</span> realpath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">// LD_LIBRARY_PATH has the highest priority. We don't have to check accessibility when searching</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// the namespace's path lists, because anything found on a namespace path list should always be</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">// accessible.</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open_library_on_paths</span><span class="token punctuation">(</span>zip_archive_cache<span class="token punctuation">,</span> name<span class="token punctuation">,</span> file_offset<span class="token punctuation">,</span> ns<span class="token operator">-></span><span class="token function">get_ld_library_paths</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> realpath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">// Try the DT_RUNPATH, and verify that the library is accessible.</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> needed_by <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    fd <span class="token operator">=</span> <span class="token function">open_library_on_paths</span><span class="token punctuation">(</span>zip_archive_cache<span class="token punctuation">,</span> name<span class="token punctuation">,</span> file_offset<span class="token punctuation">,</span> needed_by<span class="token operator">-></span><span class="token function">get_dt_runpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> realpath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ns<span class="token operator">-></span><span class="token function">is_accessible</span><span class="token punctuation">(</span><span class="token operator">*</span>realpath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token comment">// Finally search the namespace's main search path list.</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    fd <span class="token operator">=</span> <span class="token function">open_library_on_paths</span><span class="token punctuation">(</span>zip_archive_cache<span class="token punctuation">,</span> name<span class="token punctuation">,</span> file_offset<span class="token punctuation">,</span> ns<span class="token operator">-></span><span class="token function">get_default_library_paths</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> realpath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">return</span> fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 <code>open_library_at_path</code>  中才算是真正的使用 <code>open</code>  函数打开了这个 so, 并返回文件描述符 <code>fd</code> , 传入的两个标志的含义分别为</p>
<ul>
<li><code>O_RDONLY</code>  表示以只读方式打开文件。</li>
<li><code>O_CLOEXEC</code>  表示在 exec 族函数 (execl, execlp, execle, execv, execvp, execvpe) 调用后，将自动关闭文件描述符</li>
</ul>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">open_library_at_path</span><span class="token punctuation">(</span>ZipArchiveCache<span class="token operator">*</span> zip_archive_cache<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path<span class="token punctuation">,</span> <span class="token class-name">off64_t</span><span class="token operator">*</span> file_offset<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                std<span class="token operator">::</span>string<span class="token operator">*</span> realpath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">// 如果路径中包含 "!/", 则通过 zipfile 打开库</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> kZipFileSeparator<span class="token punctuation">)</span> <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    fd <span class="token operator">=</span> <span class="token function">open_library_in_zipfile</span><span class="token punctuation">(</span>zip_archive_cache<span class="token punctuation">,</span> path<span class="token punctuation">,</span> file_offset<span class="token punctuation">,</span> realpath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    fd <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> O_RDONLY <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token operator">*</span>file_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">realpath_fd</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> realpath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_first_stage_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token function">PRINT</span><span class="token punctuation">(</span><span class="token string">"warning: unable to get realpath for the library \"%s\". Will use given path."</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token operator">*</span>realpath <span class="token operator">=</span> path<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">return</span> fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>成功的打开了这个 so 之后，那就要开始解析这个 so 咯，看看 <code>load_library</code>  最终 <code>return</code>  的啥？竟然还是 <code>load_library</code> ! 不过细看第三个参数，怎么感觉类型不是 <code>ZipArchiveCache*</code>  呢</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">return</span> <span class="token function">load_library</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> task<span class="token punctuation">,</span> load_tasks<span class="token punctuation">,</span> rtld_flags<span class="token punctuation">,</span> realpath<span class="token punctuation">,</span> search_linked_namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>找找函数的声明，原来 <code>load_library</code>  还有一个重载函数，它的第三个参数的类型就是 <code>LoadTaskList*</code></p>
<p>此 <code>load_library</code>  函数的完整代码如下</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> bool <span class="token function">load_library</span><span class="token punctuation">(</span><span class="token class-name">android_namespace_t</span><span class="token operator">*</span> ns<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                         LoadTask<span class="token operator">*</span> task<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                         ZipArchiveCache<span class="token operator">*</span> zip_archive_cache<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                         LoadTaskList<span class="token operator">*</span> load_tasks<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                         <span class="token keyword">int</span> rtld_flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                         bool search_linked_namespaces<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  soinfo<span class="token operator">*</span> needed_by <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_needed_by</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> extinfo <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_extinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// 如果 extinfo->flags 的标记是 ANDROID_DLEXT_USE_LIBRARY_FD, 则直接通过</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">//fd 文件描述符来打开</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>extinfo <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_USE_LIBRARY_FD<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">off64_t</span> file_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      file_offset <span class="token operator">=</span> extinfo<span class="token operator">-></span>library_fd_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    std<span class="token operator">::</span>string realpath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">realpath_fd</span><span class="token punctuation">(</span>extinfo<span class="token operator">-></span>library_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>realpath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_first_stage_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">PRINT</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token string">"warning: unable to get realpath for the library \"%s\" by extinfo->library_fd. "</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token string">"Will use given name."</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      realpath <span class="token operator">=</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    task<span class="token operator">-></span><span class="token function">set_fd</span><span class="token punctuation">(</span>extinfo<span class="token operator">-></span>library_fd<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    task<span class="token operator">-></span><span class="token function">set_file_offset</span><span class="token punctuation">(</span>file_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">load_library</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> task<span class="token punctuation">,</span> load_tasks<span class="token punctuation">,</span> rtld_flags<span class="token punctuation">,</span> realpath<span class="token punctuation">,</span> search_linked_namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>         <span class="token string">"load_library(ns=%s, task=%s, flags=0x%x, search_linked_namespaces=%d): calling "</span></pre></td></tr><tr><td data-num="38"></td><td><pre>         <span class="token string">"open_library"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>         ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> rtld_flags<span class="token punctuation">,</span> search_linked_namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment">// Open the file.</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token class-name">off64_t</span> file_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  std<span class="token operator">::</span>string realpath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open_library</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> zip_archive_cache<span class="token punctuation">,</span> name<span class="token punctuation">,</span> needed_by<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>realpath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token comment">// 如果打开 so 失败，寻找失败原因</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token operator">-></span><span class="token function">is_dt_needed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>needed_by<span class="token operator">-></span><span class="token function">is_main_executable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token function">DL_OPEN_ERR</span><span class="token punctuation">(</span><span class="token string">"library \"%s\" not found: needed by main executable"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token function">DL_OPEN_ERR</span><span class="token punctuation">(</span><span class="token string">"library \"%s\" not found: needed by %s in namespace %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                    needed_by<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_start_from</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token function">DL_OPEN_ERR</span><span class="token punctuation">(</span><span class="token string">"library \"%s\" not found"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token comment">//set fd and file_offset</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  task<span class="token operator">-></span><span class="token function">set_fd</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  task<span class="token operator">-></span><span class="token function">set_file_offset</span><span class="token punctuation">(</span>file_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">load_library</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> task<span class="token punctuation">,</span> load_tasks<span class="token punctuation">,</span> rtld_flags<span class="token punctuation">,</span> realpath<span class="token punctuation">,</span> search_linked_namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="重载的load_library"><a class="anchor" href="#重载的load_library">#</a> 重载的 load_library</h4>
<p>函数声明:</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> bool <span class="token function">load_library</span><span class="token punctuation">(</span><span class="token class-name">android_namespace_t</span><span class="token operator">*</span> ns<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                         LoadTask<span class="token operator">*</span> task<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                         LoadTaskList<span class="token operator">*</span> load_tasks<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                         <span class="token keyword">int</span> rtld_flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                         <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> realpath<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                         bool search_linked_namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这个函数的开头做了一大堆参数合法性的检查，随后终于开始解析 so 了，其关键函数为 <code>task-&gt;read(realpath.c_str(), file_stat.st_size)</code></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>soinfo<span class="token operator">*</span> si <span class="token operator">=</span> <span class="token function">soinfo_alloc</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> realpath<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_stat<span class="token punctuation">,</span> file_offset<span class="token punctuation">,</span> rtld_flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>task<span class="token operator">-></span><span class="token function">set_soinfo</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// Read the ELF header and some of the segments.</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token operator">-></span><span class="token function">read</span><span class="token punctuation">(</span>realpath<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> file_stat<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    task<span class="token operator">-></span><span class="token function">remove_cached_elf_reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    task<span class="token operator">-></span><span class="token function">set_soinfo</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">soinfo_free</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">// Find and set DT_RUNPATH, DT_SONAME, and DT_FLAGS_1.</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// Note that these field values are temporary and are</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">// going to be overwritten on soinfo::prelink_image</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// with values from PT_LOAD segments.</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">const</span> ElfReader<span class="token operator">&amp;</span> elf_reader <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_elf_reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span><span class="token operator">*</span> d <span class="token operator">=</span> elf_reader<span class="token punctuation">.</span><span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> d<span class="token operator">-></span>d_tag <span class="token operator">!=</span> DT_NULL<span class="token punctuation">;</span> <span class="token operator">++</span>d<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag <span class="token operator">==</span> DT_RUNPATH<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        si<span class="token operator">-></span><span class="token function">set_dt_runpath</span><span class="token punctuation">(</span>elf_reader<span class="token punctuation">.</span><span class="token function">get_string</span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag <span class="token operator">==</span> DT_SONAME<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        si<span class="token operator">-></span><span class="token function">set_soname</span><span class="token punctuation">(</span>elf_reader<span class="token punctuation">.</span><span class="token function">get_string</span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// We need to identify a DF_1_GLOBAL library early so we can link it to namespaces.</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag <span class="token operator">==</span> DT_FLAGS_1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        si<span class="token operator">-></span><span class="token function">set_dt_flags_1</span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token function">for_each_dt_needed</span><span class="token punctuation">(</span>task<span class="token operator">-></span><span class="token function">get_elf_reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span> <span class="token string">"load_library(ns=%s, task=%s): Adding DT_NEEDED task: %s"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>           ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    load_tasks<span class="token operator">-></span><span class="token function">push_back</span><span class="token punctuation">(</span>LoadTask<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> si<span class="token punctuation">,</span> ns<span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_readers_map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>LoadTask::read</strong></p>
<p>初始化了一个 <code>ElfReader</code> , 随后调用 <code>elf_reader.Read</code>  正式开始读取</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bool <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> realpath<span class="token punctuation">,</span> <span class="token class-name">off64_t</span> file_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    ElfReader<span class="token operator">&amp;</span> elf_reader <span class="token operator">=</span> <span class="token function">get_elf_reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> elf_reader<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>realpath<span class="token punctuation">,</span> fd_<span class="token punctuation">,</span> file_offset_<span class="token punctuation">,</span> file_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>ElfReader::Read</strong></p>
<p>兜兜转转了那么久，终于看到了这个亲切又熟悉的函数了！！</p>
<p>关于这个函数的更多分析请参考<a href="oacia.dev/ElfReader"> ELF 结构分析及 ElfReader</a></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_phdr.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bool ElfReader<span class="token operator">::</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off64_t</span> file_offset<span class="token punctuation">,</span> <span class="token class-name">off64_t</span> file_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>did_read_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  name_ <span class="token operator">=</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  fd_ <span class="token operator">=</span> fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  file_offset_ <span class="token operator">=</span> file_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  file_size_ <span class="token operator">=</span> file_size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadElfHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token function">VerifyElfHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token function">ReadProgramHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token function">ReadSectionHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token function">ReadDynamicSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    did_read_ <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">return</span> did_read_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><hr>
<p>在获取到待加载的 so 的各个段的结构之后，接下来就是解析 <code>.dynamic</code>  中保存的符号</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// Find and set DT_RUNPATH, DT_SONAME, and DT_FLAGS_1.</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// Note that these field values are temporary and are</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// going to be overwritten on soinfo::prelink_image</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// with values from PT_LOAD segments.</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">const</span> ElfReader<span class="token operator">&amp;</span> elf_reader <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_elf_reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span><span class="token operator">*</span> d <span class="token operator">=</span> elf_reader<span class="token punctuation">.</span><span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> d<span class="token operator">-></span>d_tag <span class="token operator">!=</span> DT_NULL<span class="token punctuation">;</span> <span class="token operator">++</span>d<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag <span class="token operator">==</span> DT_RUNPATH<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        si<span class="token operator">-></span><span class="token function">set_dt_runpath</span><span class="token punctuation">(</span>elf_reader<span class="token punctuation">.</span><span class="token function">get_string</span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag <span class="token operator">==</span> DT_SONAME<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        si<span class="token operator">-></span><span class="token function">set_soname</span><span class="token punctuation">(</span>elf_reader<span class="token punctuation">.</span><span class="token function">get_string</span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// We need to identify a DF_1_GLOBAL library early so we can link it to namespaces.</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag <span class="token operator">==</span> DT_FLAGS_1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        si<span class="token operator">-></span><span class="token function">set_dt_flags_1</span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>之后找到待加载的 so 的依赖库，这里有一个模板函数 <code>for_each_dt_needed</code> , 找到 <code>.dynamic</code>  中所有带有 <code>DT_NEEDED</code>  标志的字符串，这些字符串的名称就是这个 so 所需要的依赖库，然后将它们添加到 <code>load_tasks</code>  队列中</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">for_each_dt_needed</span><span class="token punctuation">(</span>task<span class="token operator">-></span><span class="token function">get_elf_reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span> <span class="token string">"load_library(ns=%s, task=%s): Adding DT_NEEDED task: %s"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>           ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    load_tasks<span class="token operator">-></span><span class="token function">push_back</span><span class="token punctuation">(</span>LoadTask<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> si<span class="token punctuation">,</span> ns<span class="token punctuation">,</span> task<span class="token operator">-></span><span class="token function">get_readers_map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_soinfo.h</span></pre></td></tr><tr><td data-num="9"></td><td><pre>template<span class="token operator">&lt;</span>typename F<span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">void</span> <span class="token function">for_each_dt_needed</span><span class="token punctuation">(</span><span class="token keyword">const</span> soinfo<span class="token operator">*</span> si<span class="token punctuation">,</span> F action<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span><span class="token operator">*</span> d <span class="token operator">=</span> si<span class="token operator">-></span>dynamic<span class="token punctuation">;</span> d<span class="token operator">-></span>d_tag <span class="token operator">!=</span> DT_NULL<span class="token punctuation">;</span> <span class="token operator">++</span>d<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag <span class="token operator">==</span> DT_NEEDED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token function">action</span><span class="token punctuation">(</span><span class="token function">fix_dt_needed</span><span class="token punctuation">(</span>si<span class="token operator">-></span><span class="token function">get_string</span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">,</span> si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="乱序加载库"><a class="anchor" href="#乱序加载库">#</a> 乱序加载库</h3>
<p>乱序加载的原因如下，看上去是为了抵御攻击</p>
<blockquote>
<p>ld.so(1) on ELF platforms now loads libraries in a random order for greater resistance to attacks</p>
</blockquote>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Step 2: Load libraries in random order (see b/24047022)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>LoadTaskList load_list<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> task <span class="token operator">:</span> load_tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    soinfo<span class="token operator">*</span> si <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">auto</span> pred <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> LoadTask<span class="token operator">*</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> t<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> si<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        std<span class="token operator">::</span><span class="token function">find_if</span><span class="token punctuation">(</span>load_list<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> load_list<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pred<span class="token punctuation">)</span> <span class="token operator">==</span> load_list<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        load_list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>bool reserved_address_recursive <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>extinfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    reserved_address_recursive <span class="token operator">=</span> extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_RESERVED_ADDRESS_RECURSIVE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reserved_address_recursive<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// Shuffle the load order in the normal case, but not if we are loading all</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// the libraries to a reserved address range.</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>load_list<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">// Set up address space parameters.</span></pre></td></tr><tr><td data-num="25"></td><td><pre>address_space_params extinfo_params<span class="token punctuation">,</span> default_params<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token class-name">size_t</span> relro_fd_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>extinfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_RESERVED_ADDRESS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        extinfo_params<span class="token punctuation">.</span>start_addr <span class="token operator">=</span> extinfo<span class="token operator">-></span>reserved_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        extinfo_params<span class="token punctuation">.</span>reserved_size <span class="token operator">=</span> extinfo<span class="token operator">-></span>reserved_size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        extinfo_params<span class="token punctuation">.</span>must_use_address <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>extinfo<span class="token operator">-></span>flags <span class="token operator">&amp;</span> ANDROID_DLEXT_RESERVED_ADDRESS_HINT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        extinfo_params<span class="token punctuation">.</span>start_addr <span class="token operator">=</span> extinfo<span class="token operator">-></span>reserved_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        extinfo_params<span class="token punctuation">.</span>reserved_size <span class="token operator">=</span> extinfo<span class="token operator">-></span>reserved_size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> task <span class="token operator">:</span> load_list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    address_space_params<span class="token operator">*</span> address_space <span class="token operator">=</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">(</span>reserved_address_recursive <span class="token operator">||</span> <span class="token operator">!</span>task<span class="token operator">-></span><span class="token function">is_dt_needed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">&amp;</span>extinfo_params <span class="token operator">:</span> <span class="token operator">&amp;</span>default_params<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 加载所有的库，包括待加载的 so</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task<span class="token operator">-></span><span class="token function">load</span><span class="token punctuation">(</span>address_space<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>load</code>  函数就是将 ELF 的相关结构的值赋值给 <code>si_</code> , 其中我们可以看到比较重要的字段有 <code>phdr_count</code> , <code>loaded_phdr</code></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>bool <span class="token function">load</span><span class="token punctuation">(</span>address_space_params<span class="token operator">*</span> address_space<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    ElfReader<span class="token operator">&amp;</span> elf_reader <span class="token operator">=</span> <span class="token function">get_elf_reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>elf_reader<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>address_space<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    si_<span class="token operator">-></span>base <span class="token operator">=</span> elf_reader<span class="token punctuation">.</span><span class="token function">load_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    si_<span class="token operator">-></span>size <span class="token operator">=</span> elf_reader<span class="token punctuation">.</span><span class="token function">load_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    si_<span class="token operator">-></span><span class="token function">set_mapped_by_caller</span><span class="token punctuation">(</span>elf_reader<span class="token punctuation">.</span><span class="token function">is_mapped_by_caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    si_<span class="token operator">-></span>load_bias <span class="token operator">=</span> elf_reader<span class="token punctuation">.</span><span class="token function">load_bias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    si_<span class="token operator">-></span>phnum <span class="token operator">=</span> elf_reader<span class="token punctuation">.</span><span class="token function">phdr_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    si_<span class="token operator">-></span>phdr <span class="token operator">=</span> elf_reader<span class="token punctuation">.</span><span class="token function">loaded_phdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    si_<span class="token operator">-></span><span class="token function">set_gap_start</span><span class="token punctuation">(</span>elf_reader<span class="token punctuation">.</span><span class="token function">gap_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    si_<span class="token operator">-></span><span class="token function">set_gap_size</span><span class="token punctuation">(</span>elf_reader<span class="token punctuation">.</span><span class="token function">gap_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="预链接解析所有依赖库"><a class="anchor" href="#预链接解析所有依赖库">#</a> 预链接解析所有依赖库</h3>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Step 3: pre-link all DT_NEEDED libraries in breadth first order.</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> task <span class="token operator">:</span> load_tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    soinfo<span class="token operator">*</span> si <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">prelink_image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">register_soinfo_tls</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里我们看到调用了 <code>prelink_image</code>  来预链接依赖库，主要是遍历 <code>.dynamic</code>  节，来提取必要的信息例如 <code>strtab_</code> , <code>symtab_</code> , <code>plt_rela_</code> , <code>init_array_</code> 等等各种必要的信息</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>bool soinfo<span class="token operator">::</span><span class="token function">prelink_image</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags_ <span class="token operator">&amp;</span> FLAG_PRELINKED<span class="token punctuation">)</span> <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment">/* Extract dynamic section */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Word<span class="token punctuation">)</span> dynamic_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">// 提取动态节（dynamic section）</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">phdr_table_get_dynamic_section</span><span class="token punctuation">(</span>phdr<span class="token punctuation">,</span> phnum<span class="token punctuation">,</span> load_bias<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dynamic<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dynamic_flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">/* We can't log anything until the linker is relocated */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  bool relocating_linker <span class="token operator">=</span> <span class="token punctuation">(</span>flags_ <span class="token operator">&amp;</span> FLAG_LINKER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>relocating_linker<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">"[ Linking \"%s\" ]"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"si->base = %p si->flags = 0x%08x"</span><span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">,</span> flags_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamic <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>relocating_linker<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"missing PT_DYNAMIC in \"%s\""</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>relocating_linker<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"dynamic = %p"</span><span class="token punctuation">,</span> dynamic<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__arm__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">phdr_table_get_arm_exidx</span><span class="token punctuation">(</span>phdr<span class="token punctuation">,</span> phnum<span class="token punctuation">,</span> load_bias<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                                  <span class="token operator">&amp;</span>ARM_exidx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ARM_exidx_count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  TlsSegment tls_segment<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__bionic_get_tls_segment</span><span class="token punctuation">(</span>phdr<span class="token punctuation">,</span> phnum<span class="token punctuation">,</span> load_bias<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tls_segment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__bionic_check_tls_alignment</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tls_segment<span class="token punctuation">.</span>alignment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>relocating_linker<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"TLS segment alignment in \"%s\" is not a power of 2: %zu"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>               <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tls_segment<span class="token punctuation">.</span>alignment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    tls_ <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>soinfo_tls<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    tls_<span class="token operator">-></span>segment <span class="token operator">=</span> tls_segment<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token comment">// Extract useful information from dynamic section.</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token comment">// Note that: "Except for the DT_NULL element at the end of the array,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token comment">// and the relative order of DT_NEEDED elements, entries may appear in any order."</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token comment">// source: http://www.sco.com/developers/gabi/1998-04-29/ch5.dynamic.html</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token class-name">uint32_t</span> needed_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token comment">// 循环遍历每个动态节，并根据 d_tag 为对应节做相应的处理</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span><span class="token operator">*</span> d <span class="token operator">=</span> dynamic<span class="token punctuation">;</span> d<span class="token operator">-></span>d_tag <span class="token operator">!=</span> DT_NULL<span class="token punctuation">;</span> <span class="token operator">++</span>d<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"d = %p, d[0](tag) = %p d[1](val) = %p"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>          d<span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag<span class="token punctuation">)</span><span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token keyword">case</span> DT_SONAME<span class="token operator">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token comment">// this is parsed after we have strtab initialized (see below).</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token keyword">case</span> DT_HASH<span class="token operator">:</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        nbucket_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        nchain_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        bucket_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        chain_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> nbucket_ <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>      <span class="token keyword">case</span> DT_GNU_HASH<span class="token operator">:</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        gnu_nbucket_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token comment">// skip symndx</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        gnu_maskwords_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        gnu_shift2_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>        gnu_bloom_filter_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        gnu_bucket_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>gnu_bloom_filter_ <span class="token operator">+</span> gnu_maskwords_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token comment">// amend chain for symndx = header[1]</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        gnu_chain_ <span class="token operator">=</span> gnu_bucket_ <span class="token operator">+</span> gnu_nbucket_ <span class="token operator">-</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">powerof2</span><span class="token punctuation">(</span>gnu_maskwords_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>          <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"invalid maskwords for gnu_hash = 0x%x, in \"%s\" expecting power to two"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="80"></td><td><pre>              gnu_maskwords_<span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>          <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token operator">--</span>gnu_maskwords_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre>        flags_ <span class="token operator">|=</span> FLAG_GNU_HASH<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>      <span class="token keyword">case</span> DT_STRTAB<span class="token operator">:</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        strtab_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre>      <span class="token keyword">case</span> DT_STRSZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        strtab_size_ <span class="token operator">=</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre></pre></td></tr><tr><td data-num="96"></td><td><pre>      <span class="token keyword">case</span> DT_SYMTAB<span class="token operator">:</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        symtab_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre>      <span class="token keyword">case</span> DT_SYMENT<span class="token operator">:</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>          <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"invalid DT_SYMENT: %zd in \"%s\""</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="103"></td><td><pre>              static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>          <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre></pre></td></tr><tr><td data-num="108"></td><td><pre>      <span class="token keyword">case</span> DT_PLTREL<span class="token operator">:</span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>USE_RELA<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">!=</span> DT_RELA<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>          <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"unsupported DT_PLTREL in \"%s\"; expected DT_RELA"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>          <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="114"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="115"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">!=</span> DT_REL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>          <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"unsupported DT_PLTREL in \"%s\"; expected DT_REL"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>          <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="120"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre></pre></td></tr><tr><td data-num="122"></td><td><pre>      <span class="token keyword">case</span> DT_JMPREL<span class="token operator">:</span></pre></td></tr><tr><td data-num="123"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>USE_RELA<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="124"></td><td><pre>        plt_rela_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Rela<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="126"></td><td><pre>        plt_rel_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Rel<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="128"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre></pre></td></tr><tr><td data-num="130"></td><td><pre>      <span class="token keyword">case</span> DT_PLTRELSZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>USE_RELA<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="132"></td><td><pre>        plt_rela_count_ <span class="token operator">=</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Rela<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="134"></td><td><pre>        plt_rel_count_ <span class="token operator">=</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Rel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="136"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre></pre></td></tr><tr><td data-num="138"></td><td><pre>      <span class="token keyword">case</span> DT_PLTGOT<span class="token operator">:</span></pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token comment">// Ignored (because RTLD_LAZY is not supported).</span></pre></td></tr><tr><td data-num="140"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="141"></td><td><pre></pre></td></tr><tr><td data-num="142"></td><td><pre>      <span class="token keyword">case</span> DT_DEBUG<span class="token operator">:</span></pre></td></tr><tr><td data-num="143"></td><td><pre>        <span class="token comment">// Set the DT_DEBUG entry to the address of _r_debug for GDB</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        <span class="token comment">// if the dynamic table is writable</span></pre></td></tr><tr><td data-num="145"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dynamic_flags <span class="token operator">&amp;</span> PF_W<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>          d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uintptr_t</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_r_debug<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>USE_RELA<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="150"></td><td><pre>      <span class="token keyword">case</span> DT_RELA<span class="token operator">:</span></pre></td></tr><tr><td data-num="151"></td><td><pre>        rela_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Rela<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="153"></td><td><pre></pre></td></tr><tr><td data-num="154"></td><td><pre>      <span class="token keyword">case</span> DT_RELASZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="155"></td><td><pre>        rela_count_ <span class="token operator">=</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Rela<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="157"></td><td><pre></pre></td></tr><tr><td data-num="158"></td><td><pre>      <span class="token keyword">case</span> DT_ANDROID_RELA<span class="token operator">:</span></pre></td></tr><tr><td data-num="159"></td><td><pre>        android_relocs_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre></pre></td></tr><tr><td data-num="162"></td><td><pre>      <span class="token keyword">case</span> DT_ANDROID_RELASZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="163"></td><td><pre>        android_relocs_size_ <span class="token operator">=</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre></pre></td></tr><tr><td data-num="166"></td><td><pre>      <span class="token keyword">case</span> DT_ANDROID_REL<span class="token operator">:</span></pre></td></tr><tr><td data-num="167"></td><td><pre>        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"unsupported DT_ANDROID_REL in \"%s\""</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="169"></td><td><pre></pre></td></tr><tr><td data-num="170"></td><td><pre>      <span class="token keyword">case</span> DT_ANDROID_RELSZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="171"></td><td><pre>        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"unsupported DT_ANDROID_RELSZ in \"%s\""</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="173"></td><td><pre></pre></td></tr><tr><td data-num="174"></td><td><pre>      <span class="token keyword">case</span> DT_RELAENT<span class="token operator">:</span></pre></td></tr><tr><td data-num="175"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Rela<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="176"></td><td><pre>          <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"invalid DT_RELAENT: %zd"</span><span class="token punctuation">,</span> static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="177"></td><td><pre>          <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="178"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="179"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="180"></td><td><pre></pre></td></tr><tr><td data-num="181"></td><td><pre>      <span class="token comment">// Ignored (see DT_RELCOUNT comments for details).</span></pre></td></tr><tr><td data-num="182"></td><td><pre>      <span class="token keyword">case</span> DT_RELACOUNT<span class="token operator">:</span></pre></td></tr><tr><td data-num="183"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="184"></td><td><pre></pre></td></tr><tr><td data-num="185"></td><td><pre>      <span class="token keyword">case</span> DT_REL<span class="token operator">:</span></pre></td></tr><tr><td data-num="186"></td><td><pre>        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"unsupported DT_REL in \"%s\""</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="187"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="188"></td><td><pre></pre></td></tr><tr><td data-num="189"></td><td><pre>      <span class="token keyword">case</span> DT_RELSZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="190"></td><td><pre>        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"unsupported DT_RELSZ in \"%s\""</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="192"></td><td><pre></pre></td></tr><tr><td data-num="193"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="194"></td><td><pre>      <span class="token keyword">case</span> DT_REL<span class="token operator">:</span></pre></td></tr><tr><td data-num="195"></td><td><pre>        rel_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Rel<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="196"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre></pre></td></tr><tr><td data-num="198"></td><td><pre>      <span class="token keyword">case</span> DT_RELSZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="199"></td><td><pre>        rel_count_ <span class="token operator">=</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Rel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="200"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="201"></td><td><pre></pre></td></tr><tr><td data-num="202"></td><td><pre>      <span class="token keyword">case</span> DT_RELENT<span class="token operator">:</span></pre></td></tr><tr><td data-num="203"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Rel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="204"></td><td><pre>          <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"invalid DT_RELENT: %zd"</span><span class="token punctuation">,</span> static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="205"></td><td><pre>          <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="206"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="207"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="208"></td><td><pre></pre></td></tr><tr><td data-num="209"></td><td><pre>      <span class="token keyword">case</span> DT_ANDROID_REL<span class="token operator">:</span></pre></td></tr><tr><td data-num="210"></td><td><pre>        android_relocs_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="211"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="212"></td><td><pre></pre></td></tr><tr><td data-num="213"></td><td><pre>      <span class="token keyword">case</span> DT_ANDROID_RELSZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="214"></td><td><pre>        android_relocs_size_ <span class="token operator">=</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="215"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="216"></td><td><pre></pre></td></tr><tr><td data-num="217"></td><td><pre>      <span class="token keyword">case</span> DT_ANDROID_RELA<span class="token operator">:</span></pre></td></tr><tr><td data-num="218"></td><td><pre>        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"unsupported DT_ANDROID_RELA in \"%s\""</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="219"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="220"></td><td><pre></pre></td></tr><tr><td data-num="221"></td><td><pre>      <span class="token keyword">case</span> DT_ANDROID_RELASZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="222"></td><td><pre>        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"unsupported DT_ANDROID_RELASZ in \"%s\""</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="224"></td><td><pre></pre></td></tr><tr><td data-num="225"></td><td><pre>      <span class="token comment">// "Indicates that all RELATIVE relocations have been concatenated together,</span></pre></td></tr><tr><td data-num="226"></td><td><pre>      <span class="token comment">// and specifies the RELATIVE relocation count."</span></pre></td></tr><tr><td data-num="227"></td><td><pre>      <span class="token comment">//</span></pre></td></tr><tr><td data-num="228"></td><td><pre>      <span class="token comment">// TODO: Spec also mentions that this can be used to optimize relocation process;</span></pre></td></tr><tr><td data-num="229"></td><td><pre>      <span class="token comment">// Not currently used by bionic linker - ignored.</span></pre></td></tr><tr><td data-num="230"></td><td><pre>      <span class="token keyword">case</span> DT_RELCOUNT<span class="token operator">:</span></pre></td></tr><tr><td data-num="231"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="232"></td><td><pre></pre></td></tr><tr><td data-num="233"></td><td><pre>      <span class="token keyword">case</span> DT_RELA<span class="token operator">:</span></pre></td></tr><tr><td data-num="234"></td><td><pre>        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"unsupported DT_RELA in \"%s\""</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="235"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="236"></td><td><pre></pre></td></tr><tr><td data-num="237"></td><td><pre>      <span class="token keyword">case</span> DT_RELASZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="238"></td><td><pre>        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"unsupported DT_RELASZ in \"%s\""</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="239"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="240"></td><td><pre></pre></td></tr><tr><td data-num="241"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="242"></td><td><pre>      <span class="token keyword">case</span> DT_RELR<span class="token operator">:</span></pre></td></tr><tr><td data-num="243"></td><td><pre>      <span class="token keyword">case</span> DT_ANDROID_RELR<span class="token operator">:</span></pre></td></tr><tr><td data-num="244"></td><td><pre>        relr_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Relr<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="245"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="246"></td><td><pre></pre></td></tr><tr><td data-num="247"></td><td><pre>      <span class="token keyword">case</span> DT_RELRSZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="248"></td><td><pre>      <span class="token keyword">case</span> DT_ANDROID_RELRSZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="249"></td><td><pre>        relr_count_ <span class="token operator">=</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Relr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="250"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="251"></td><td><pre></pre></td></tr><tr><td data-num="252"></td><td><pre>      <span class="token keyword">case</span> DT_RELRENT<span class="token operator">:</span></pre></td></tr><tr><td data-num="253"></td><td><pre>      <span class="token keyword">case</span> DT_ANDROID_RELRENT<span class="token operator">:</span></pre></td></tr><tr><td data-num="254"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Relr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="255"></td><td><pre>          <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"invalid DT_RELRENT: %zd"</span><span class="token punctuation">,</span> static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="256"></td><td><pre>          <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="257"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="258"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="259"></td><td><pre></pre></td></tr><tr><td data-num="260"></td><td><pre>      <span class="token comment">// Ignored (see DT_RELCOUNT comments for details).</span></pre></td></tr><tr><td data-num="261"></td><td><pre>      <span class="token comment">// There is no DT_RELRCOUNT specifically because it would only be ignored.</span></pre></td></tr><tr><td data-num="262"></td><td><pre>      <span class="token keyword">case</span> DT_ANDROID_RELRCOUNT<span class="token operator">:</span></pre></td></tr><tr><td data-num="263"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="264"></td><td><pre></pre></td></tr><tr><td data-num="265"></td><td><pre>      <span class="token keyword">case</span> DT_INIT<span class="token operator">:</span></pre></td></tr><tr><td data-num="266"></td><td><pre>        init_func_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">linker_ctor_function_t</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="267"></td><td><pre>        <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s constructors (DT_INIT) found at %p"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> init_func_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="268"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="269"></td><td><pre></pre></td></tr><tr><td data-num="270"></td><td><pre>      <span class="token keyword">case</span> DT_FINI<span class="token operator">:</span></pre></td></tr><tr><td data-num="271"></td><td><pre>        fini_func_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">linker_dtor_function_t</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="272"></td><td><pre>        <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s destructors (DT_FINI) found at %p"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fini_func_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="273"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="274"></td><td><pre></pre></td></tr><tr><td data-num="275"></td><td><pre>      <span class="token keyword">case</span> DT_INIT_ARRAY<span class="token operator">:</span></pre></td></tr><tr><td data-num="276"></td><td><pre>        init_array_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">linker_ctor_function_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="277"></td><td><pre>        <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s constructors (DT_INIT_ARRAY) found at %p"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> init_array_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="278"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="279"></td><td><pre></pre></td></tr><tr><td data-num="280"></td><td><pre>      <span class="token keyword">case</span> DT_INIT_ARRAYSZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="281"></td><td><pre>        init_array_count_ <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">></span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="282"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="283"></td><td><pre></pre></td></tr><tr><td data-num="284"></td><td><pre>      <span class="token keyword">case</span> DT_FINI_ARRAY<span class="token operator">:</span></pre></td></tr><tr><td data-num="285"></td><td><pre>        fini_array_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">linker_dtor_function_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="286"></td><td><pre>        <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s destructors (DT_FINI_ARRAY) found at %p"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fini_array_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="287"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="288"></td><td><pre></pre></td></tr><tr><td data-num="289"></td><td><pre>      <span class="token keyword">case</span> DT_FINI_ARRAYSZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="290"></td><td><pre>        fini_array_count_ <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">></span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="291"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="292"></td><td><pre></pre></td></tr><tr><td data-num="293"></td><td><pre>      <span class="token keyword">case</span> DT_PREINIT_ARRAY<span class="token operator">:</span></pre></td></tr><tr><td data-num="294"></td><td><pre>        preinit_array_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">linker_ctor_function_t</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="295"></td><td><pre>        <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"%s constructors (DT_PREINIT_ARRAY) found at %p"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> preinit_array_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="296"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="297"></td><td><pre></pre></td></tr><tr><td data-num="298"></td><td><pre>      <span class="token keyword">case</span> DT_PREINIT_ARRAYSZ<span class="token operator">:</span></pre></td></tr><tr><td data-num="299"></td><td><pre>        preinit_array_count_ <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token operator">></span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="300"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="301"></td><td><pre></pre></td></tr><tr><td data-num="302"></td><td><pre>      <span class="token keyword">case</span> DT_TEXTREL<span class="token operator">:</span></pre></td></tr><tr><td data-num="303"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="304"></td><td><pre>        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has text relocations"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="305"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="306"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="307"></td><td><pre>        has_text_relocations <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="308"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="309"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="310"></td><td><pre></pre></td></tr><tr><td data-num="311"></td><td><pre>      <span class="token keyword">case</span> DT_SYMBOLIC<span class="token operator">:</span></pre></td></tr><tr><td data-num="312"></td><td><pre>        has_DT_SYMBOLIC <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="313"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="314"></td><td><pre></pre></td></tr><tr><td data-num="315"></td><td><pre>      <span class="token keyword">case</span> DT_NEEDED<span class="token operator">:</span></pre></td></tr><tr><td data-num="316"></td><td><pre>        <span class="token operator">++</span>needed_count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="317"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="318"></td><td><pre></pre></td></tr><tr><td data-num="319"></td><td><pre>      <span class="token keyword">case</span> DT_FLAGS<span class="token operator">:</span></pre></td></tr><tr><td data-num="320"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">&amp;</span> DF_TEXTREL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="321"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="322"></td><td><pre>          <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has text relocations"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="323"></td><td><pre>          <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="324"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="325"></td><td><pre>          has_text_relocations <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="326"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="327"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="328"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">&amp;</span> DF_SYMBOLIC<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="329"></td><td><pre>          has_DT_SYMBOLIC <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="330"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="331"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="332"></td><td><pre></pre></td></tr><tr><td data-num="333"></td><td><pre>      <span class="token keyword">case</span> DT_FLAGS_1<span class="token operator">:</span></pre></td></tr><tr><td data-num="334"></td><td><pre>        <span class="token function">set_dt_flags_1</span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="335"></td><td><pre></pre></td></tr><tr><td data-num="336"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val <span class="token operator">&amp;</span> <span class="token operator">~</span>SUPPORTED_DT_FLAGS_1<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="337"></td><td><pre>          <span class="token function">DL_WARN</span><span class="token punctuation">(</span><span class="token string">"Warning: \"%s\" has unsupported flags DT_FLAGS_1=%p "</span></pre></td></tr><tr><td data-num="338"></td><td><pre>                  <span class="token string">"(ignoring unsupported flags)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="339"></td><td><pre>                  <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="340"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="341"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="342"></td><td><pre></pre></td></tr><tr><td data-num="343"></td><td><pre>      <span class="token comment">// Ignored: "Its use has been superseded by the DF_BIND_NOW flag"</span></pre></td></tr><tr><td data-num="344"></td><td><pre>      <span class="token keyword">case</span> DT_BIND_NOW<span class="token operator">:</span></pre></td></tr><tr><td data-num="345"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="346"></td><td><pre></pre></td></tr><tr><td data-num="347"></td><td><pre>      <span class="token keyword">case</span> DT_VERSYM<span class="token operator">:</span></pre></td></tr><tr><td data-num="348"></td><td><pre>        versym_ <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Versym<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="349"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="350"></td><td><pre></pre></td></tr><tr><td data-num="351"></td><td><pre>      <span class="token keyword">case</span> DT_VERDEF<span class="token operator">:</span></pre></td></tr><tr><td data-num="352"></td><td><pre>        verdef_ptr_ <span class="token operator">=</span> load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="353"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="354"></td><td><pre>      <span class="token keyword">case</span> DT_VERDEFNUM<span class="token operator">:</span></pre></td></tr><tr><td data-num="355"></td><td><pre>        verdef_cnt_ <span class="token operator">=</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="356"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="357"></td><td><pre></pre></td></tr><tr><td data-num="358"></td><td><pre>      <span class="token keyword">case</span> DT_VERNEED<span class="token operator">:</span></pre></td></tr><tr><td data-num="359"></td><td><pre>        verneed_ptr_ <span class="token operator">=</span> load_bias <span class="token operator">+</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_ptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="360"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="361"></td><td><pre></pre></td></tr><tr><td data-num="362"></td><td><pre>      <span class="token keyword">case</span> DT_VERNEEDNUM<span class="token operator">:</span></pre></td></tr><tr><td data-num="363"></td><td><pre>        verneed_cnt_ <span class="token operator">=</span> d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="364"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="365"></td><td><pre></pre></td></tr><tr><td data-num="366"></td><td><pre>      <span class="token keyword">case</span> DT_RUNPATH<span class="token operator">:</span></pre></td></tr><tr><td data-num="367"></td><td><pre>        <span class="token comment">// this is parsed after we have strtab initialized (see below).</span></pre></td></tr><tr><td data-num="368"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="369"></td><td><pre></pre></td></tr><tr><td data-num="370"></td><td><pre>      <span class="token keyword">case</span> DT_TLSDESC_GOT<span class="token operator">:</span></pre></td></tr><tr><td data-num="371"></td><td><pre>      <span class="token keyword">case</span> DT_TLSDESC_PLT<span class="token operator">:</span></pre></td></tr><tr><td data-num="372"></td><td><pre>        <span class="token comment">// These DT entries are used for lazy TLSDESC relocations. Bionic</span></pre></td></tr><tr><td data-num="373"></td><td><pre>        <span class="token comment">// resolves everything eagerly, so these can be ignored.</span></pre></td></tr><tr><td data-num="374"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="375"></td><td><pre></pre></td></tr><tr><td data-num="376"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__aarch64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="377"></td><td><pre>      <span class="token keyword">case</span> DT_AARCH64_BTI_PLT<span class="token operator">:</span></pre></td></tr><tr><td data-num="378"></td><td><pre>      <span class="token keyword">case</span> DT_AARCH64_PAC_PLT<span class="token operator">:</span></pre></td></tr><tr><td data-num="379"></td><td><pre>      <span class="token keyword">case</span> DT_AARCH64_VARIANT_PCS<span class="token operator">:</span></pre></td></tr><tr><td data-num="380"></td><td><pre>        <span class="token comment">// Ignored: AArch64 processor-specific dynamic array tags.</span></pre></td></tr><tr><td data-num="381"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="382"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="383"></td><td><pre></pre></td></tr><tr><td data-num="384"></td><td><pre>      <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="385"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>relocating_linker<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="386"></td><td><pre>          <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> tag_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="387"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag <span class="token operator">==</span> DT_RPATH<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="388"></td><td><pre>            tag_name <span class="token operator">=</span> <span class="token string">"DT_RPATH"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="389"></td><td><pre>          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag <span class="token operator">==</span> DT_ENCODING<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="390"></td><td><pre>            tag_name <span class="token operator">=</span> <span class="token string">"DT_ENCODING"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="391"></td><td><pre>          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag <span class="token operator">>=</span> DT_LOOS <span class="token operator">&amp;&amp;</span> d<span class="token operator">-></span>d_tag <span class="token operator">&lt;=</span> DT_HIOS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="392"></td><td><pre>            tag_name <span class="token operator">=</span> <span class="token string">"unknown OS-specific"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="393"></td><td><pre>          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag <span class="token operator">>=</span> DT_LOPROC <span class="token operator">&amp;&amp;</span> d<span class="token operator">-></span>d_tag <span class="token operator">&lt;=</span> DT_HIPROC<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="394"></td><td><pre>            tag_name <span class="token operator">=</span> <span class="token string">"unknown processor-specific"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="395"></td><td><pre>          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="396"></td><td><pre>            tag_name <span class="token operator">=</span> <span class="token string">"unknown"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="397"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="398"></td><td><pre>          <span class="token function">DL_WARN</span><span class="token punctuation">(</span><span class="token string">"Warning: \"%s\" unused DT entry: %s (type %p arg %p) (ignoring)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="399"></td><td><pre>                  <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="400"></td><td><pre>                  tag_name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="401"></td><td><pre>                  reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="402"></td><td><pre>                  reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="403"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="404"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="405"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="406"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="407"></td><td><pre></pre></td></tr><tr><td data-num="408"></td><td><pre>  <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"si->base = %p, si->strtab = %p, si->symtab = %p"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="409"></td><td><pre>        reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">,</span> strtab_<span class="token punctuation">,</span> symtab_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="410"></td><td><pre></pre></td></tr><tr><td data-num="411"></td><td><pre>  <span class="token comment">// Validity checks.</span></pre></td></tr><tr><td data-num="412"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>relocating_linker <span class="token operator">&amp;&amp;</span> needed_count <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="413"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"linker cannot have DT_NEEDED dependencies on other libraries"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="414"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="415"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="416"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>nbucket_ <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> gnu_nbucket_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="417"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"empty/missing DT_HASH/DT_GNU_HASH in \"%s\" "</span></pre></td></tr><tr><td data-num="418"></td><td><pre>        <span class="token string">"(new hash type from the future?)"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="419"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="420"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="421"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>strtab_ <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="422"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"empty/missing DT_STRTAB in \"%s\""</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="423"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="424"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="425"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>symtab_ <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="426"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"empty/missing DT_SYMTAB in \"%s\""</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="427"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="428"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="429"></td><td><pre></pre></td></tr><tr><td data-num="430"></td><td><pre>  <span class="token comment">// Second pass - parse entries relying on strtab. Skip this while relocating the linker so as to</span></pre></td></tr><tr><td data-num="431"></td><td><pre>  <span class="token comment">// avoid doing heap allocations until later in the linker's initialization.</span></pre></td></tr><tr><td data-num="432"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>relocating_linker<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="433"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span><span class="token operator">*</span> d <span class="token operator">=</span> dynamic<span class="token punctuation">;</span> d<span class="token operator">-></span>d_tag <span class="token operator">!=</span> DT_NULL<span class="token punctuation">;</span> <span class="token operator">++</span>d<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="434"></td><td><pre>      <span class="token keyword">switch</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>d_tag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="435"></td><td><pre>        <span class="token keyword">case</span> DT_SONAME<span class="token operator">:</span></pre></td></tr><tr><td data-num="436"></td><td><pre>          <span class="token function">set_soname</span><span class="token punctuation">(</span><span class="token function">get_string</span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="437"></td><td><pre>          <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="438"></td><td><pre>        <span class="token keyword">case</span> DT_RUNPATH<span class="token operator">:</span></pre></td></tr><tr><td data-num="439"></td><td><pre>          <span class="token function">set_dt_runpath</span><span class="token punctuation">(</span><span class="token function">get_string</span><span class="token punctuation">(</span>d<span class="token operator">-></span>d_un<span class="token punctuation">.</span>d_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="440"></td><td><pre>          <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="441"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="442"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="443"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="444"></td><td><pre></pre></td></tr><tr><td data-num="445"></td><td><pre>  <span class="token comment">// Before M release, linker was using basename in place of soname. In the case when DT_SONAME is</span></pre></td></tr><tr><td data-num="446"></td><td><pre>  <span class="token comment">// absent some apps stop working because they can't find DT_NEEDED library by soname. This</span></pre></td></tr><tr><td data-num="447"></td><td><pre>  <span class="token comment">// workaround should keep them working. (Applies only for apps targeting sdk version &lt; M.) Make</span></pre></td></tr><tr><td data-num="448"></td><td><pre>  <span class="token comment">// an exception for the main executable, which does not need to have DT_SONAME. The linker has an</span></pre></td></tr><tr><td data-num="449"></td><td><pre>  <span class="token comment">// DT_SONAME but the soname_ field is initialized later on.</span></pre></td></tr><tr><td data-num="450"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>soname_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> this <span class="token operator">!=</span> <span class="token function">solist_get_somain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>relocating_linker <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="451"></td><td><pre>      <span class="token function">get_application_target_sdk_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">23</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="452"></td><td><pre>    soname_ <span class="token operator">=</span> <span class="token function">basename</span><span class="token punctuation">(</span>realpath_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="453"></td><td><pre>    <span class="token function">DL_WARN_documented_change</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">"missing-soname-enforced-for-api-level-23"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="454"></td><td><pre>                              <span class="token string">"\"%s\" has no DT_SONAME (will use %s instead)"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="455"></td><td><pre>                              soname_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="456"></td><td><pre></pre></td></tr><tr><td data-num="457"></td><td><pre>    <span class="token comment">// Don't call add_dlwarning because a missing DT_SONAME isn't important enough to show in the UI</span></pre></td></tr><tr><td data-num="458"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="459"></td><td><pre></pre></td></tr><tr><td data-num="460"></td><td><pre>  <span class="token comment">// Validate each library's verdef section once, so we don't have to validate</span></pre></td></tr><tr><td data-num="461"></td><td><pre>  <span class="token comment">// it each time we look up a symbol with a version.</span></pre></td></tr><tr><td data-num="462"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">validate_verdef_section</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="463"></td><td><pre></pre></td></tr><tr><td data-num="464"></td><td><pre>  flags_ <span class="token operator">|=</span> FLAG_PRELINKED<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="465"></td><td><pre>  <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="466"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="构造全局组"><a class="anchor" href="#构造全局组">#</a> 构造全局组</h3>
<p>这一步为预链接的依赖库设置 <code>DF_1_GLOBAL</code>  全局标志，来标记这个库在全局组中</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Step 4: Construct the global group. DF_1_GLOBAL bit is force set for LD_PRELOADed libs because</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// they must be added to the global group. Note: The DF_1_GLOBAL bit for a library is normally set</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// in step 3.</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>ld_preloads <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> si <span class="token operator">:</span> <span class="token operator">*</span>ld_preloads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        si<span class="token operator">-></span><span class="token function">set_dt_flags_1</span><span class="token punctuation">(</span>si<span class="token operator">-></span><span class="token function">get_dt_flags_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> DF_1_GLOBAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="收集local_groups的根节点"><a class="anchor" href="#收集local_groups的根节点">#</a> 收集 local_groups 的根节点</h3>
<p>看注释感觉挺抽象的，感觉是为了保证可以链接到别的 namespace 里面的依赖库</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Step 5: Collect roots of local_groups.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// Whenever needed_by->si link crosses a namespace boundary it forms its own local_group.</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// Here we collect new roots to link them separately later on. Note that we need to avoid</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// collecting duplicates. Also the order is important. They need to be linked in the same</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// BFS order we link individual libraries.</span></pre></td></tr><tr><td data-num="6"></td><td><pre>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>soinfo<span class="token operator">*</span><span class="token operator">></span> local_group_roots<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>start_with <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> add_as_children<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    local_group_roots<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>start_with<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">CHECK</span><span class="token punctuation">(</span>soinfos_count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    local_group_roots<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>soinfos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> task <span class="token operator">:</span> load_tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    soinfo<span class="token operator">*</span> si <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    soinfo<span class="token operator">*</span> needed_by <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_needed_by</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    bool is_dt_needed <span class="token operator">=</span> needed_by <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>needed_by <span class="token operator">!=</span> start_with <span class="token operator">||</span> add_as_children<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">android_namespace_t</span><span class="token operator">*</span> needed_by_ns <span class="token operator">=</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        is_dt_needed <span class="token operator">?</span> needed_by<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> ns<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> si<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> needed_by_ns<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">auto</span> it <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">find</span><span class="token punctuation">(</span>local_group_roots<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> local_group_roots<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>               <span class="token string">"Crossing namespace boundary (si=%s@%p, si_ns=%s@%p, needed_by=%s@%p, ns=%s@%p, needed_by_ns=%s@%p) adding to local_group_roots: %s"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>               si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>               si<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>               si<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>               si<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>               needed_by <span class="token operator">==</span> nullptr <span class="token operator">?</span> <span class="token string">"(nullptr)"</span> <span class="token operator">:</span> needed_by<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>               needed_by<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>               ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>               ns<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>               needed_by_ns<span class="token operator">-></span><span class="token function">get_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>               needed_by_ns<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>               it <span class="token operator">==</span> local_group_roots<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"yes"</span> <span class="token operator">:</span> <span class="token string">"no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> local_group_roots<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            local_group_roots<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="链接所有的local-groups"><a class="anchor" href="#链接所有的local-groups">#</a> 链接所有的 local groups</h3>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Step 6: Link all local groups</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> root <span class="token operator">:</span> local_group_roots<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">soinfo_list_t</span> local_group<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">android_namespace_t</span><span class="token operator">*</span> local_group_ns <span class="token operator">=</span> root<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">walk_dependencies_tree</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                           <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>soinfo<span class="token operator">*</span> si<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                               <span class="token keyword">if</span> <span class="token punctuation">(</span>local_group_ns<span class="token operator">-></span><span class="token function">is_accessible</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                                   local_group<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                                   <span class="token keyword">return</span> kWalkContinue<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                               <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                                   <span class="token keyword">return</span> kWalkSkip<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                               <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                           <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 获取全局组包含的 soinfo，因为预加载库是一起加载的跟 local_group_ns 是同一个命名空间</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 所有这里的全局组已经包含了预加载库</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">soinfo_list_t</span> global_group <span class="token operator">=</span> local_group_ns<span class="token operator">-></span><span class="token function">get_global_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 将本地组和全局组都添加到 lookup_list 中</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    SymbolLookupList <span class="token function">lookup_list</span><span class="token punctuation">(</span>global_group<span class="token punctuation">,</span> local_group<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    soinfo<span class="token operator">*</span> local_group_root <span class="token operator">=</span> local_group<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    bool linked <span class="token operator">=</span> local_group<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>soinfo<span class="token operator">*</span> si<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// Even though local group may contain accessible soinfos from other namespaces</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// we should avoid linking them (because if they are not linked -> they</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// are in the local_group_roots and will be linked later).</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> si<span class="token operator">-></span><span class="token function">get_primary_namespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> local_group_ns<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> link_extinfo <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>si <span class="token operator">==</span> soinfos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> reserved_address_recursive<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token comment">// Only forward extinfo for the first library unless the recursive</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token comment">// flag is set.</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                link_extinfo <span class="token operator">=</span> extinfo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__libc_shared_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>load_hook<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token function">__libc_shared_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">load_hook</span><span class="token punctuation">(</span>si<span class="token operator">-></span>load_bias<span class="token punctuation">,</span> si<span class="token operator">-></span>phdr<span class="token punctuation">,</span> si<span class="token operator">-></span>phnum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            lookup_list<span class="token punctuation">.</span><span class="token function">set_dt_symbolic_lib</span><span class="token punctuation">(</span>si<span class="token operator">-></span>has_DT_SYMBOLIC <span class="token operator">?</span> si <span class="token operator">:</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token comment">// 调用 link_image 开始进行依赖库的动态链接，重定位等工作</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-></span><span class="token function">link_image</span><span class="token punctuation">(</span>lookup_list<span class="token punctuation">,</span> local_group_root<span class="token punctuation">,</span> link_extinfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>relro_fd_offset<span class="token punctuation">)</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token operator">!</span><span class="token function">get_cfi_shadow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">AfterLoad</span><span class="token punctuation">(</span>si<span class="token punctuation">,</span> <span class="token function">solist_get_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>linked<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>当把所有的本地组和全局组加入到 <code>lookup_list</code>  中后，就开始调用 <code>si-&gt;link_image</code>  来对这些库进行链接的操作</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>bool soinfo<span class="token operator">::</span><span class="token function">link_image</span><span class="token punctuation">(</span><span class="token keyword">const</span> SymbolLookupList<span class="token operator">&amp;</span> lookup_list<span class="token punctuation">,</span> soinfo<span class="token operator">*</span> local_group_root<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                        <span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> extinfo<span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token operator">*</span> relro_fd_offset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_image_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// already linked.</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>g_is_ldd <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">is_main_executable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">async_safe_format_fd</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> <span class="token string">"\t%s => %s (%p)\n"</span><span class="token punctuation">,</span> <span class="token function">get_soname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                         <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  local_group_root_ <span class="token operator">=</span> local_group_root<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>local_group_root_ <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    local_group_root_ <span class="token operator">=</span> this<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags_ <span class="token operator">&amp;</span> FLAG_LINKER<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> local_group_root_ <span class="token operator">==</span> this<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    target_sdk_version_ <span class="token operator">=</span> <span class="token function">get_application_target_sdk_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    </pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">// 进行符号的重定位</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">relocate</span><span class="token punctuation">(</span>lookup_list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"[ finished linking %s ]"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 <code>soinfo::link_image</code>  中调用了 <code>relocate</code>  去进行符号的重定位</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_relocate.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bool soinfo<span class="token operator">::</span><span class="token function">relocate</span><span class="token punctuation">(</span><span class="token keyword">const</span> SymbolLookupList<span class="token operator">&amp;</span> lookup_list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>  VersionTracker version_tracker<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>version_tracker<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  Relocator <span class="token function">relocator</span><span class="token punctuation">(</span>version_tracker<span class="token punctuation">,</span> lookup_list<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  relocator<span class="token punctuation">.</span>si <span class="token operator">=</span> this<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">//`.strtab` 节保存的是符号字符串表，表中的内容会被 `.symtab` 的 `ElfN_Sym` 结构中的 `st_name` 引用</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  relocator<span class="token punctuation">.</span>si_strtab <span class="token operator">=</span> strtab_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  relocator<span class="token punctuation">.</span>si_strtab_size <span class="token operator">=</span> <span class="token function">has_min_version</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> strtab_size_ <span class="token operator">:</span> SIZE_MAX<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">//`.symtab` 节是一个 `ElfN_Sym` 的数组，保存了符号信息</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  relocator<span class="token punctuation">.</span>si_symtab <span class="token operator">=</span> symtab_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  relocator<span class="token punctuation">.</span>tlsdesc_args <span class="token operator">=</span> <span class="token operator">&amp;</span>tlsdesc_args_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  relocator<span class="token punctuation">.</span>tls_tp_base <span class="token operator">=</span> <span class="token function">__libc_shared_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>static_tls_layout<span class="token punctuation">.</span><span class="token function">offset_thread_pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">////android_relocs_在 prelink_image () 中设置，动态节有 DT_ANDROID_REL 才会设置</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>android_relocs_ <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// check signature</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>android_relocs_size_ <span class="token operator">></span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        android_relocs_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'A'</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        android_relocs_<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'P'</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        android_relocs_<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'S'</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        android_relocs_<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'2'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"[ android relocating %s ]"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token keyword">const</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span> packed_relocs <span class="token operator">=</span> android_relocs_ <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token keyword">const</span> <span class="token class-name">size_t</span> packed_relocs_size <span class="token operator">=</span> android_relocs_size_ <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>packed_relocate<span class="token operator">&lt;</span>RelocMode<span class="token operator">::</span>Typical<span class="token operator">></span><span class="token punctuation">(</span>relocator<span class="token punctuation">,</span> <span class="token function">sleb128_decoder</span><span class="token punctuation">(</span>packed_relocs<span class="token punctuation">,</span> packed_relocs_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"bad android relocation header."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>relr_ <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"[ relocating %s relr ]"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">relocate_relr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>USE_RELA<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>rela_ <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"[ relocating %s rela ]"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plain_relocate<span class="token operator">&lt;</span>RelocMode<span class="token operator">::</span>Typical<span class="token operator">></span><span class="token punctuation">(</span>relocator<span class="token punctuation">,</span> rela_<span class="token punctuation">,</span> rela_count_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>plt_rela_ <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"[ relocating %s plt rela ]"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plain_relocate<span class="token operator">&lt;</span>RelocMode<span class="token operator">::</span>JumpTable<span class="token operator">></span><span class="token punctuation">(</span>relocator<span class="token punctuation">,</span> plt_rela_<span class="token punctuation">,</span> plt_rela_count_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>rel_ <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"[ relocating %s rel ]"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plain_relocate<span class="token operator">&lt;</span>RelocMode<span class="token operator">::</span>Typical<span class="token operator">></span><span class="token punctuation">(</span>relocator<span class="token punctuation">,</span> rel_<span class="token punctuation">,</span> rel_count_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>plt_rel_ <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token function">DEBUG</span><span class="token punctuation">(</span><span class="token string">"[ relocating %s plt rel ]"</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plain_relocate<span class="token operator">&lt;</span>RelocMode<span class="token operator">::</span>JumpTable<span class="token operator">></span><span class="token punctuation">(</span>relocator<span class="token punctuation">,</span> plt_rel_<span class="token punctuation">,</span> plt_rel_count_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token comment">// Once the tlsdesc_args_ vector's size is finalized, we can write the addresses of its elements</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token comment">// into the TLSDESC relocations.</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__aarch64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token comment">// Bionic currently only implements TLSDESC for arm64.</span></pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>pair<span class="token operator">&lt;</span>TlsDescriptor<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token operator">></span><span class="token operator">&amp;</span> pair <span class="token operator">:</span> relocator<span class="token punctuation">.</span>deferred_tlsdesc_relocs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    TlsDescriptor<span class="token operator">*</span> desc <span class="token operator">=</span> pair<span class="token punctuation">.</span>first<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    desc<span class="token operator">-></span>func <span class="token operator">=</span> tlsdesc_resolver_dynamic<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    desc<span class="token operator">-></span>arg <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tlsdesc_args_<span class="token punctuation">[</span>pair<span class="token punctuation">.</span>second<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre>  <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>随后依次调用了 <code>plain_relocate-&gt;plain_relocate_impl-&gt;process_relocation</code></p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>template <span class="token operator">&lt;</span>RelocMode OptMode<span class="token punctuation">,</span> typename <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>Args<span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> bool <span class="token function">plain_relocate</span><span class="token punctuation">(</span>Relocator<span class="token operator">&amp;</span> relocator<span class="token punctuation">,</span> Args <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">needs_slow_relocate_loop</span><span class="token punctuation">(</span>relocator<span class="token punctuation">)</span> <span class="token operator">?</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      plain_relocate_impl<span class="token operator">&lt;</span>RelocMode<span class="token operator">::</span>General<span class="token operator">></span><span class="token punctuation">(</span>relocator<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token operator">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      plain_relocate_impl<span class="token operator">&lt;</span>OptMode<span class="token operator">></span><span class="token punctuation">(</span>relocator<span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>template <span class="token operator">&lt;</span>RelocMode Mode<span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noinline<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">static</span> bool <span class="token function">plain_relocate_impl</span><span class="token punctuation">(</span>Relocator<span class="token operator">&amp;</span> relocator<span class="token punctuation">,</span> <span class="token class-name">rel_t</span><span class="token operator">*</span> rels<span class="token punctuation">,</span> <span class="token class-name">size_t</span> rel_count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rel_count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process_relocation<span class="token operator">&lt;</span>Mode<span class="token operator">></span><span class="token punctuation">(</span>relocator<span class="token punctuation">,</span> rels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>template <span class="token operator">&lt;</span>RelocMode Mode<span class="token operator">></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>always_inline<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">inline</span> bool <span class="token function">process_relocation</span><span class="token punctuation">(</span>Relocator<span class="token operator">&amp;</span> relocator<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">rel_t</span><span class="token operator">&amp;</span> reloc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">return</span> Mode <span class="token operator">==</span> RelocMode<span class="token operator">::</span>General <span class="token operator">?</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token function">process_relocation_general</span><span class="token punctuation">(</span>relocator<span class="token punctuation">,</span> reloc<span class="token punctuation">)</span> <span class="token operator">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      process_relocation_impl<span class="token operator">&lt;</span>Mode<span class="token operator">></span><span class="token punctuation">(</span>relocator<span class="token punctuation">,</span> reloc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>最终在 <code>process_relocation_impl</code>  实现了符号的重定向并调用 <code>lookup_symbol</code>  来查找符号</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>template <span class="token operator">&lt;</span>RelocMode Mode<span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>always_inline<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">static</span> bool <span class="token function">process_relocation_impl</span><span class="token punctuation">(</span>Relocator<span class="token operator">&amp;</span> relocator<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">rel_t</span><span class="token operator">&amp;</span> reloc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  constexpr bool IsGeneral <span class="token operator">=</span> Mode <span class="token operator">==</span> RelocMode<span class="token operator">::</span>General<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">void</span><span class="token operator">*</span> <span class="token keyword">const</span> rel_target <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>reloc<span class="token punctuation">.</span>r_offset <span class="token operator">+</span> relocator<span class="token punctuation">.</span>si<span class="token operator">-></span>load_bias<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> r_type <span class="token operator">=</span> <span class="token function">ELFW</span><span class="token punctuation">(</span>R_TYPE<span class="token punctuation">)</span><span class="token punctuation">(</span>reloc<span class="token punctuation">.</span>r_info<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> r_sym <span class="token operator">=</span> <span class="token function">ELFW</span><span class="token punctuation">(</span>R_SYM<span class="token punctuation">)</span><span class="token punctuation">(</span>reloc<span class="token punctuation">.</span>r_info<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  soinfo<span class="token operator">*</span> found_in <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span><span class="token operator">*</span> sym <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> sym_name <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> sym_addr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>r_sym <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  	<span class="token comment">// 获取重定向的符号名</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    sym_name <span class="token operator">=</span> relocator<span class="token punctuation">.</span><span class="token function">get_string</span><span class="token punctuation">(</span>relocator<span class="token punctuation">.</span>si_symtab<span class="token punctuation">[</span>r_sym<span class="token punctuation">]</span><span class="token punctuation">.</span>st_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>USE_RELA<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">auto</span> get_addend_rel   <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> reloc<span class="token punctuation">.</span>r_addend<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">auto</span> get_addend_norel <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> reloc<span class="token punctuation">.</span>r_addend<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">auto</span> get_addend_rel   <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token operator">*</span>static_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>rel_target<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">auto</span> get_addend_norel <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>IsGeneral <span class="token operator">&amp;&amp;</span> <span class="token function">is_tls_reloc</span><span class="token punctuation">(</span>r_type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r_sym <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token comment">// Do nothing.</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token comment">// 利用 lookup_symbol 来查找符号</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lookup_symbol<span class="token operator">&lt;</span>IsGeneral<span class="token operator">></span><span class="token punctuation">(</span>relocator<span class="token punctuation">,</span> r_sym<span class="token punctuation">,</span> sym_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>found_in<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sym<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>sym <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">const</span> bool should_protect_segments <span class="token operator">=</span> handle_text_relocs <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                                             found_in <span class="token operator">==</span> relocator<span class="token punctuation">.</span>si <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                                             <span class="token function">ELF_ST_TYPE</span><span class="token punctuation">(</span>sym<span class="token operator">-></span>st_info<span class="token punctuation">)</span> <span class="token operator">==</span> STT_GNU_IFUNC<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>should_protect_segments <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">protect_segments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        sym_addr <span class="token operator">=</span> found_in<span class="token operator">-></span><span class="token function">resolve_symbol_address</span><span class="token punctuation">(</span>sym<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>should_protect_segments <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">unprotect_segments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">constexpr</span> <span class="token punctuation">(</span>IsGeneral<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token comment">// A weak reference to an undefined symbol. We typically use a zero symbol address, but</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token comment">// use the relocation base for PC-relative relocations, so that the value written is zero.</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>r_type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="50"></td><td><pre>          <span class="token keyword">case</span> R_X86_64_PC32<span class="token operator">:</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            sym_addr <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">(</span>rel_target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__i386__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="54"></td><td><pre>          <span class="token keyword">case</span> R_386_PC32<span class="token operator">:</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            sym_addr <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">(</span>rel_target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token comment">// 大部分符号的类型都是 R_GENERIC_JUMP_SLOT </span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token keyword">if</span> <span class="token function">constexpr</span> <span class="token punctuation">(</span>IsGeneral <span class="token operator">||</span> Mode <span class="token operator">==</span> RelocMode<span class="token operator">::</span>JumpTable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r_type <span class="token operator">==</span> R_GENERIC_JUMP_SLOT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      count_relocation_if<span class="token operator">&lt;</span>IsGeneral<span class="token operator">></span><span class="token punctuation">(</span>kRelocAbsolute<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>      <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> result <span class="token operator">=</span> sym_addr <span class="token operator">+</span> <span class="token function">get_addend_norel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>      <span class="token function">trace_reloc</span><span class="token punctuation">(</span><span class="token string">"RELO JMP_SLOT %16p &lt;- %16p %s"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                  rel_target<span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span> sym_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token operator">*</span>static_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>rel_target<span class="token punctuation">)</span> <span class="token operator">=</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>      <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  其他类型或架构的相关重定向计算省略	</pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 <code>lookup_symbol</code>  中调用了 <code>soinfo_do_lookup</code>  来查找符号</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>template <span class="token operator">&lt;</span>bool DoLogging<span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>always_inline<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">inline</span> bool <span class="token function">lookup_symbol</span><span class="token punctuation">(</span>Relocator<span class="token operator">&amp;</span> relocator<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> r_sym<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> sym_name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                                 soinfo<span class="token operator">*</span><span class="token operator">*</span> found_in<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span> sym<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">//relocator 是前面传进来包含全局组和本地组的 soinfos，全局组排在最前面</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">// 如果上一次已经查找过这个符号，那么久没有必要再查找一次</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>r_sym <span class="token operator">==</span> relocator<span class="token punctuation">.</span>cache_sym_val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token operator">*</span>found_in <span class="token operator">=</span> relocator<span class="token punctuation">.</span>cache_si<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token operator">*</span>sym <span class="token operator">=</span> relocator<span class="token punctuation">.</span>cache_sym<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    count_relocation_if<span class="token operator">&lt;</span>DoLogging<span class="token operator">></span><span class="token punctuation">(</span>kRelocSymbolCached<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">const</span> version_info<span class="token operator">*</span> vi <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>relocator<span class="token punctuation">.</span>si<span class="token operator">-></span><span class="token function">lookup_version_info</span><span class="token punctuation">(</span>relocator<span class="token punctuation">.</span>version_tracker<span class="token punctuation">,</span> r_sym<span class="token punctuation">,</span> sym_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    soinfo<span class="token operator">*</span> local_found_in <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token comment">// 最终调用 soinfo_do_lookup 来查找符号</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span><span class="token operator">*</span> local_sym <span class="token operator">=</span> <span class="token function">soinfo_do_lookup</span><span class="token punctuation">(</span>sym_name<span class="token punctuation">,</span> vi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>local_found_in<span class="token punctuation">,</span> relocator<span class="token punctuation">.</span>lookup_list<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    relocator<span class="token punctuation">.</span>cache_sym_val <span class="token operator">=</span> r_sym<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    relocator<span class="token punctuation">.</span>cache_si <span class="token operator">=</span> local_found_in<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    relocator<span class="token punctuation">.</span>cache_sym <span class="token operator">=</span> local_sym<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token operator">*</span>found_in <span class="token operator">=</span> local_found_in<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token operator">*</span>sym <span class="token operator">=</span> local_sym<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>sym <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ELF_ST_BIND</span><span class="token punctuation">(</span>relocator<span class="token punctuation">.</span>si_symtab<span class="token punctuation">[</span>r_sym<span class="token punctuation">]</span><span class="token punctuation">.</span>st_info<span class="token punctuation">)</span> <span class="token operator">!=</span> STB_WEAK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"cannot locate symbol \"%s\" referenced by \"%s\"..."</span><span class="token punctuation">,</span> sym_name<span class="token punctuation">,</span> relocator<span class="token punctuation">.</span>si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>  count_relocation_if<span class="token operator">&lt;</span>DoLogging<span class="token operator">></span><span class="token punctuation">(</span>kRelocSymbol<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 <code>soinfo_do_lookup</code>  中最终调用模板函数 <code>soinfo_do_lookup_impl</code>  进行符号查找</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_soinfo.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span><span class="token operator">*</span> <span class="token function">soinfo_do_lookup</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> version_info<span class="token operator">*</span> vi<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                  soinfo<span class="token operator">*</span><span class="token operator">*</span> si_found_in<span class="token punctuation">,</span> <span class="token keyword">const</span> SymbolLookupList<span class="token operator">&amp;</span> lookup_list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">return</span> lookup_list<span class="token punctuation">.</span><span class="token function">needs_slow_path</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      soinfo_do_lookup_impl<span class="token operator">&lt;</span>true<span class="token operator">></span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> vi<span class="token punctuation">,</span> si_found_in<span class="token punctuation">,</span> lookup_list<span class="token punctuation">)</span> <span class="token operator">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      soinfo_do_lookup_impl<span class="token operator">&lt;</span>false<span class="token operator">></span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> vi<span class="token punctuation">,</span> si_found_in<span class="token punctuation">,</span> lookup_list<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>有 hash 表查 hash 表，没 hash 表用符号查找</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>template <span class="token operator">&lt;</span>bool IsGeneral<span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noinline<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span><span class="token operator">*</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">soinfo_do_lookup_impl</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> version_info<span class="token operator">*</span> vi<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                      soinfo<span class="token operator">*</span><span class="token operator">*</span> si_found_in<span class="token punctuation">,</span> <span class="token keyword">const</span> SymbolLookupList<span class="token operator">&amp;</span> lookup_list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">auto</span> <span class="token punctuation">[</span> hash<span class="token punctuation">,</span> name_len <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">calculate_gnu_hash</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  constexpr <span class="token class-name">uint32_t</span> kBloomMaskBits <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  SymbolName <span class="token function">elf_symbol_name</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">const</span> SymbolLookupLib<span class="token operator">*</span> end <span class="token operator">=</span> lookup_list<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">const</span> SymbolLookupLib<span class="token operator">*</span> it <span class="token operator">=</span> lookup_list<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">const</span> SymbolLookupLib<span class="token operator">*</span> lib<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">uint32_t</span> sym_idx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// Iterate over libraries until we find one whose Bloom filter matches the symbol we're</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// searching for.</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 在每一个库中都去寻找有没有指定的符号</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> end<span class="token punctuation">)</span> <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      lib <span class="token operator">=</span> it<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>	  <span class="token comment">// 要是没有 hash 表，就通过名称来进行查找</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>IsGeneral <span class="token operator">&amp;&amp;</span> lib<span class="token operator">-></span><span class="token function">needs_sysv_lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span><span class="token operator">*</span> sym <span class="token operator">=</span> lib<span class="token operator">-></span>si_<span class="token operator">-></span><span class="token function">find_symbol_by_name</span><span class="token punctuation">(</span>elf_symbol_name<span class="token punctuation">,</span> vi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token operator">*</span>si_found_in <span class="token operator">=</span> lib<span class="token operator">-></span>si_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token keyword">return</span> sym<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>IsGeneral<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token function">TRACE_TYPE</span><span class="token punctuation">(</span>LOOKUP<span class="token punctuation">,</span> <span class="token string">"SEARCH %s in %s@%p (gnu)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                   name<span class="token punctuation">,</span> lib<span class="token operator">-></span>si_<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lib<span class="token operator">-></span>si_<span class="token operator">-></span>base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>	  <span class="token comment">// 计算符号 hash 桶查询链</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> word_num <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">/</span> kBloomMaskBits<span class="token punctuation">)</span> <span class="token operator">&amp;</span> lib<span class="token operator">-></span>gnu_maskwords_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> bloom_word <span class="token operator">=</span> lib<span class="token operator">-></span>gnu_bloom_filter_<span class="token punctuation">[</span>word_num<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> h1 <span class="token operator">=</span> hash <span class="token operator">%</span> kBloomMaskBits<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> h2 <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">>></span> lib<span class="token operator">-></span>gnu_shift2_<span class="token punctuation">)</span> <span class="token operator">%</span> kBloomMaskBits<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>bloom_word <span class="token operator">>></span> h1<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>bloom_word <span class="token operator">>></span> h2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        sym_idx <span class="token operator">=</span> lib<span class="token operator">-></span>gnu_bucket_<span class="token punctuation">[</span>hash <span class="token operator">%</span> lib<span class="token operator">-></span>gnu_nbucket_<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sym_idx <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>          <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>IsGeneral<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token function">TRACE_TYPE</span><span class="token punctuation">(</span>LOOKUP<span class="token punctuation">,</span> <span class="token string">"NOT FOUND %s in %s@%p"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                   name<span class="token punctuation">,</span> lib<span class="token operator">-></span>si_<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lib<span class="token operator">-></span>si_<span class="token operator">-></span>base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token comment">// Search the library's hash table chain.</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token function">ElfW</span><span class="token punctuation">(</span>Versym<span class="token punctuation">)</span> verneed <span class="token operator">=</span> kVersymNotNeeded<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    bool calculated_verneed <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token class-name">uint32_t</span> chain_value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Sym<span class="token punctuation">)</span><span class="token operator">*</span> sym <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>	</pre></td></tr><tr><td data-num="63"></td><td><pre>	<span class="token comment">//// 根据符号 hash 快速查找</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      sym <span class="token operator">=</span> lib<span class="token operator">-></span>symtab_ <span class="token operator">+</span> sym_idx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      chain_value <span class="token operator">=</span> lib<span class="token operator">-></span>gnu_chain_<span class="token punctuation">[</span>sym_idx<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>chain_value <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>hash <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>vi <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>calculated_verneed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>          calculated_verneed <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>          verneed <span class="token operator">=</span> <span class="token function">find_verdef_version_index</span><span class="token punctuation">(</span>lib<span class="token operator">-></span>si_<span class="token punctuation">,</span> vi<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check_symbol_version</span><span class="token punctuation">(</span>lib<span class="token operator">-></span>versym_<span class="token punctuation">,</span> sym_idx<span class="token punctuation">,</span> verneed<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>sym<span class="token operator">-></span>st_name<span class="token punctuation">)</span> <span class="token operator">+</span> name_len <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> lib<span class="token operator">-></span>strtab_size_ <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token function">memcmp</span><span class="token punctuation">(</span>lib<span class="token operator">-></span>strtab_ <span class="token operator">+</span> sym<span class="token operator">-></span>st_name<span class="token punctuation">,</span> name<span class="token punctuation">,</span> name_len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token function">is_symbol_global_and_defined</span><span class="token punctuation">(</span>lib<span class="token operator">-></span>si_<span class="token punctuation">,</span> sym<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>          <span class="token operator">*</span>si_found_in <span class="token operator">=</span> lib<span class="token operator">-></span>si_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>IsGeneral<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token function">TRACE_TYPE</span><span class="token punctuation">(</span>LOOKUP<span class="token punctuation">,</span> <span class="token string">"FOUND %s in %s (%p) %zd"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                       name<span class="token punctuation">,</span> lib<span class="token operator">-></span>si_<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>sym<span class="token operator">-></span>st_value<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="80"></td><td><pre>                       static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>sym<span class="token operator">-></span>st_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>          <span class="token keyword">return</span> sym<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>      <span class="token operator">++</span>sym_idx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>chain_value <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>IsGeneral<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>      <span class="token function">TRACE_TYPE</span><span class="token punctuation">(</span>LOOKUP<span class="token punctuation">,</span> <span class="token string">"NOT FOUND %s in %s@%p"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                 name<span class="token punctuation">,</span> lib<span class="token operator">-></span>si_<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>lib<span class="token operator">-></span>si_<span class="token operator">-></span>base<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="收尾工作"><a class="anchor" href="#收尾工作">#</a> 收尾工作</h3>
<p>对依赖库的链接情况进行标记，并增加依赖库的引用计数</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// Step 7: Mark all load_tasks as linked and increment refcounts</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token comment">// for references between load_groups (at this point it does not matter if</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment">// referenced load_groups were loaded by previous dlopen or as part of this</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">// one on step 6)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>start_with <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> add_as_children<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    start_with<span class="token operator">-></span><span class="token function">set_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> task <span class="token operator">:</span> load_tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    soinfo<span class="token operator">*</span> si <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    si<span class="token operator">-></span><span class="token function">set_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> task <span class="token operator">:</span> load_tasks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    soinfo<span class="token operator">*</span> si <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_soinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    soinfo<span class="token operator">*</span> needed_by <span class="token operator">=</span> task<span class="token operator">-></span><span class="token function">get_needed_by</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>needed_by <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        needed_by <span class="token operator">!=</span> start_with <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        needed_by<span class="token operator">-></span><span class="token function">get_local_group_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> si<span class="token operator">-></span><span class="token function">get_local_group_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token comment">// 增加依赖库 so 的引用计数</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      si<span class="token operator">-></span><span class="token function">increment_ref_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>至此为止，一个 so 就被成功的加载进来了～</p>
<h1 id="so的卸载过程"><a class="anchor" href="#so的卸载过程">#</a> so 的卸载过程</h1>
<p>在 android 中并没有直接的接口来让开发者卸载一个 so, 所以对于 so 的卸载过程我们无法使用自上而下的方式去分析，但可以利用逆向的方法，自底向上一步一步探索 so 的卸载过程究竟是什么样子的</p>
<p>首先整理一下目前为止从 AOSP 源码以及网上找的线索:</p>
<ol>
<li>
<p>android 的 so 中有一个独特的函数 <code>JNI_OnUnload</code> , 当 so 卸载时会进行调用</p>
</li>
<li>
<p>在 AOSP 的 <code>platform\bionic\linker\linker_soinfo.cpp</code>  中有一个函数 <code>call_destructors</code> , 它的完整代码如下</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\bionic\linker\linker_soinfo.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> soinfo<span class="token double-colon punctuation">::</span><span class="token function">call_destructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>constructors_called<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  ScopedTrace <span class="token function">trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"calling destructors: "</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// DT_FINI_ARRAY must be parsed in reverse order.</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token function">call_array</span><span class="token punctuation">(</span><span class="token string">"DT_FINI_ARRAY"</span><span class="token punctuation">,</span> fini_array_<span class="token punctuation">,</span> fini_array_count_<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// DT_FINI should be called after DT_FINI_ARRAY if both are present.</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">call_function</span><span class="token punctuation">(</span><span class="token string">"DT_FINI"</span><span class="token punctuation">,</span> fini_func_<span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>当调用该函数时，会先调用 <code>final_array</code>  中的函数，最后调用 <code>final</code>  函数 (怎么和 <code>init</code>  与 <code>init_array</code>  反过来了)</p>
</li>
</ol>
<p>那么我们可以提出以下两个问题，来为逆向分析的过程明确一个清晰的目标</p>
<div class="note info">
<ul>
<li>在什么情况下 <code>JNI_OnUnload</code>  与 <code>call_destructors</code>  会被调用？</li>
<li><code>JNI_OnUnload</code>  和 <code>call_destructors</code>  调用的先后顺序是什么？</li>
</ul>
</div>
<p>带着这两个问题，我们首先对 <code>JNI_OnUnload</code>  进行分析</p>
<h2 id="jni_onunload"><a class="anchor" href="#jni_onunload">#</a> JNI_OnUnload</h2>
<h3 id="unloadlibraries"><a class="anchor" href="#unloadlibraries">#</a> UnloadLibraries</h3>
<p>android 中存在一个特有的函数 <code>JNI_OnUnload</code> , 当虚拟机释放该 so 时，来进行善后清除动作，通过在<a href="cs.android.com"> android 官网源码搜索平台</a>翻了好多页的搜索结果，终于找到了 <code>JNI_OnUnload</code>  的<span class="exturl" data-url="aHR0cHM6Ly9jcy5hbmRyb2lkLmNvbS9hbmRyb2lkL3BsYXRmb3JtL3N1cGVycHJvamVjdC8rL21hc3RlcjphcnQvcnVudGltZS9qbmkvamF2YV92bV9leHQuY2M7bD0zODM/cT1KTklfb251bmxvYWQmYW1wO3NzPWFuZHJvaWQlMkZwbGF0Zm9ybSUyRnN1cGVycHJvamVjdCZhbXA7aGw9emgtY24mYW1wO3N0YXJ0PTQx">调用函数</span>，他在 <code>art/runtime/jni/java_vm_ext.cc</code>  中的 <code>UnloadLibraries</code>  中被调用</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\art\runtime\jni\java_vm_ext.cc</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">UnloadLibraries</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>SharedLibrary<span class="token operator">*</span><span class="token operator">></span><span class="token operator">&amp;</span> libraries<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">using</span> JNI_OnUnloadFn <span class="token operator">=</span> <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span>SharedLibrary<span class="token operator">*</span> library <span class="token operator">:</span> libraries<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">void</span><span class="token operator">*</span> <span class="token keyword">const</span> sym <span class="token operator">=</span> library<span class="token operator">-></span><span class="token function">FindSymbol</span><span class="token punctuation">(</span><span class="token string">"JNI_OnUnload"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> android<span class="token double-colon punctuation">::</span>kJNICallTypeRegular<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sym <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[No JNI_OnUnload found in \""</span> <span class="token operator">&lt;&lt;</span> library<span class="token operator">-></span><span class="token function">GetPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[JNI_OnUnload found for \""</span> <span class="token operator">&lt;&lt;</span> library<span class="token operator">-></span><span class="token function">GetPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\"]: Calling..."</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            JNI_OnUnloadFn jni_on_unload <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>JNI_OnUnloadFn<span class="token operator">></span></span></span><span class="token punctuation">(</span>sym<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token function">jni_on_unload</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="unloadnativelibraries"><a class="anchor" href="#unloadnativelibraries">#</a> UnloadNativeLibraries</h3>
<p>再去看一下 <code>UnloadLibraries</code>  的引用，它在 <code>UnloadNativeLibraries</code>  被调用</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\art\runtime\jni\java_vm_ext.cc</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// Unload native libraries with cleared class loaders.</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">void</span> <span class="token function">UnloadNativeLibraries</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token function">REQUIRES</span><span class="token punctuation">(</span><span class="token operator">!</span>Locks<span class="token double-colon punctuation">::</span>jni_libraries_lock_<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">REQUIRES_SHARED</span><span class="token punctuation">(</span>Locks<span class="token double-colon punctuation">::</span>mutator_lock_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    Thread<span class="token operator">*</span> <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>SharedLibrary<span class="token operator">*</span><span class="token operator">></span> unload_libraries<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        MutexLock <span class="token function">mu</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>Locks<span class="token double-colon punctuation">::</span>jni_libraries_lock_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> libraries_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> libraries_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            SharedLibrary<span class="token operator">*</span> <span class="token keyword">const</span> library <span class="token operator">=</span> it<span class="token operator">-></span>second<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token comment">// If class loader is null then it was unloaded, call JNI_OnUnload.</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">const</span> jweak class_loader <span class="token operator">=</span> library<span class="token operator">-></span><span class="token function">GetClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token comment">// If class_loader is a null jobject then it is the boot class loader. We should not unload</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token comment">// the native libraries of the boot class loader.</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>class_loader <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> self<span class="token operator">-></span><span class="token function">IsJWeakCleared</span><span class="token punctuation">(</span>class_loader<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                unload_libraries<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>library<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                it <span class="token operator">=</span> libraries_<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token operator">++</span>it<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    ScopedThreadSuspension <span class="token function">sts</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> kNative<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// Do this without holding the jni libraries lock to prevent possible deadlocks.</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// 调用 so 中的 JNI_OnUnload</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">UnloadLibraries</span><span class="token punctuation">(</span>self<span class="token operator">-></span><span class="token function">GetJniEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetVm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unload_libraries<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> library <span class="token operator">:</span> unload_libraries<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">delete</span> library<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="javavmextunloadnativelibraries"><a class="anchor" href="#javavmextunloadnativelibraries">#</a> JavaVMExt::UnloadNativeLibraries</h3>
<p>这里调用了 <code>libraries_</code> 中的 <code>UnloadNativeLibraries</code>  函数，看起来卸载的过程和 Java 虚拟机有些许的关系</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\art\runtime\jni\java_vm_ext.cc</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">JavaVMExt</span><span class="token double-colon punctuation">::</span><span class="token function">UnloadNativeLibraries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  libraries_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">UnloadNativeLibraries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="heapcollectgarbageinternal"><a class="anchor" href="#heapcollectgarbageinternal">#</a> Heap::CollectGarbageInternal</h3>
<p><code>JavaVMExt::UnloadNativeLibraries</code>  在 <code>Heap::CollectGarbageInternal</code>  的末尾被调用</p>
<p><img data-src="/android-load-so/image-20240709133045436.png" alt="image-20240709133045436" style="aspect-ratio:910 / 168;"></p>
<p>这函数看起来和虚拟机堆执行垃圾回收有关，垃圾回收执行完毕后会去调用 <code>JNI_OnUnload</code></p>
<p>然而再往上寻找却找不到什么有用的函数了，我们只知道在 JVM 垃圾回收之后会去调用 <code>JNI_OnUnload</code></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\art\runtime\gc\heap.cc</span></pre></td></tr><tr><td data-num="2"></td><td><pre>collector<span class="token double-colon punctuation">::</span>GcType <span class="token class-name">Heap</span><span class="token double-colon punctuation">::</span><span class="token function">CollectGarbageInternal</span><span class="token punctuation">(</span>collector<span class="token double-colon punctuation">::</span>GcType gc_type<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                               GcCause gc_cause<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                                               <span class="token keyword">bool</span> clear_soft_references<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                                               <span class="token keyword">uint32_t</span> requested_gc_num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  Thread<span class="token operator">*</span> self <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  Runtime<span class="token operator">*</span> runtime <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token double-colon punctuation">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// If the heap can't run the GC, silently fail and return that no GC was run.</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>gc_type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">case</span> collector<span class="token double-colon punctuation">::</span>kGcTypePartial<span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">HasZygoteSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// Do not increment gcs_completed_ . We should retry with kGcTypeFull.</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> collector<span class="token double-colon punctuation">::</span>kGcTypeNone<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token comment">// Other GC types don't have any special cases which makes them not runnable. The main case</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token comment">// here is full GC.</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  ScopedThreadStateChange <span class="token function">tsc</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> kWaitingPerformingGc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  Locks<span class="token double-colon punctuation">::</span>mutator_lock_<span class="token operator">-></span><span class="token function">AssertNotHeld</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-></span><span class="token function">IsHandlingStackOverflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// If we are throwing a stack overflow error we probably don't have enough remaining stack</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// space to run the GC.</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// Count this as a GC in case someone is waiting for it to complete.</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    gcs_completed_<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">return</span> collector<span class="token double-colon punctuation">::</span>kGcTypeNone<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token keyword">bool</span> compacting_gc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    gc_complete_lock_<span class="token operator">-></span><span class="token function">AssertNotHeld</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    ScopedThreadStateChange <span class="token function">tsc2</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> kWaitingForGcToComplete<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    MutexLock <span class="token function">mu</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>gc_complete_lock_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment">// Ensure there is only one GC at a time.</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token function">WaitForGcToCompleteLocked</span><span class="token punctuation">(</span>gc_cause<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>requested_gc_num <span class="token operator">!=</span> GC_NUM_ANY <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">GCNumberLt</span><span class="token punctuation">(</span><span class="token function">GetCurrentGcNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requested_gc_num<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token comment">// The appropriate GC was already triggered elsewhere.</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token keyword">return</span> collector<span class="token double-colon punctuation">::</span>kGcTypeNone<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    compacting_gc <span class="token operator">=</span> <span class="token function">IsMovingGc</span><span class="token punctuation">(</span>collector_type_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">// GC can be disabled if someone has a used GetPrimitiveArrayCritical.</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>compacting_gc <span class="token operator">&amp;&amp;</span> disable_moving_gc_count_ <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Skipping GC due to disable moving GC count "</span> <span class="token operator">&lt;&lt;</span> disable_moving_gc_count_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token comment">// Again count this as a GC.</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      gcs_completed_<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token keyword">return</span> collector<span class="token double-colon punctuation">::</span>kGcTypeNone<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>gc_disabled_for_shutdown_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      gcs_completed_<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>memory_order_release<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token keyword">return</span> collector<span class="token double-colon punctuation">::</span>kGcTypeNone<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    collector_type_running_ <span class="token operator">=</span> collector_type_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    last_gc_cause_ <span class="token operator">=</span> gc_cause<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>gc_cause <span class="token operator">==</span> kGcCauseForAlloc <span class="token operator">&amp;&amp;</span> runtime<span class="token operator">-></span><span class="token function">HasStatsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token operator">++</span>runtime<span class="token operator">-></span><span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>gc_for_alloc_count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token operator">++</span>self<span class="token operator">-></span><span class="token function">GetStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>gc_for_alloc_count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token keyword">const</span> size_t bytes_allocated_before_gc <span class="token operator">=</span> <span class="token function">GetBytesAllocated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token function">DCHECK_LT</span><span class="token punctuation">(</span>gc_type<span class="token punctuation">,</span> collector<span class="token double-colon punctuation">::</span>kGcTypeMax<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token function">DCHECK_NE</span><span class="token punctuation">(</span>gc_type<span class="token punctuation">,</span> collector<span class="token double-colon punctuation">::</span>kGcTypeNone<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>  collector<span class="token double-colon punctuation">::</span>GarbageCollector<span class="token operator">*</span> collector <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token comment">// TODO: Clean this up.</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>compacting_gc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token function">DCHECK</span><span class="token punctuation">(</span>current_allocator_ <span class="token operator">==</span> kAllocatorTypeBumpPointer <span class="token operator">||</span></pre></td></tr><tr><td data-num="70"></td><td><pre>           current_allocator_ <span class="token operator">==</span> kAllocatorTypeTLAB <span class="token operator">||</span></pre></td></tr><tr><td data-num="71"></td><td><pre>           current_allocator_ <span class="token operator">==</span> kAllocatorTypeRegion <span class="token operator">||</span></pre></td></tr><tr><td data-num="72"></td><td><pre>           current_allocator_ <span class="token operator">==</span> kAllocatorTypeRegionTLAB<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>collector_type_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>      <span class="token keyword">case</span> kCollectorTypeSS<span class="token operator">:</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        semi_space_collector_<span class="token operator">-></span><span class="token function">SetFromSpace</span><span class="token punctuation">(</span>bump_pointer_space_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        semi_space_collector_<span class="token operator">-></span><span class="token function">SetToSpace</span><span class="token punctuation">(</span>temp_space_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        semi_space_collector_<span class="token operator">-></span><span class="token function">SetSwapSemiSpaces</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        collector <span class="token operator">=</span> semi_space_collector_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>      <span class="token keyword">case</span> kCollectorTypeCC<span class="token operator">:</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        collector<span class="token double-colon punctuation">::</span>ConcurrentCopying<span class="token operator">*</span> active_cc_collector<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>use_generational_cc_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>          <span class="token comment">// TODO: Other threads must do the flip checkpoint before they start poking at</span></pre></td></tr><tr><td data-num="84"></td><td><pre>          <span class="token comment">// active_concurrent_copying_collector_. So we should not concurrency here.</span></pre></td></tr><tr><td data-num="85"></td><td><pre>          active_cc_collector <span class="token operator">=</span> <span class="token punctuation">(</span>gc_type <span class="token operator">==</span> collector<span class="token double-colon punctuation">::</span>kGcTypeSticky<span class="token punctuation">)</span> <span class="token operator">?</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                  young_concurrent_copying_collector_ <span class="token operator">:</span> concurrent_copying_collector_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>          active_concurrent_copying_collector_<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>active_cc_collector<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                                                     std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>          <span class="token function">DCHECK</span><span class="token punctuation">(</span>active_cc_collector<span class="token operator">-></span><span class="token function">RegionSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> region_space_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>          collector <span class="token operator">=</span> active_cc_collector<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>          collector <span class="token operator">=</span> active_concurrent_copying_collector_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>      <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Invalid collector type "</span> <span class="token operator">&lt;&lt;</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">></span></span></span><span class="token punctuation">(</span>collector_type_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>collector <span class="token operator">!=</span> active_concurrent_copying_collector_<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>memory_order_relaxed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>      temp_space_<span class="token operator">-></span><span class="token function">GetMemMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Protect</span><span class="token punctuation">(</span>PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>kIsDebugBuild<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token comment">// Try to read each page of the memory map in case mprotect didn't work properly b/19894268.</span></pre></td></tr><tr><td data-num="102"></td><td><pre>        temp_space_<span class="token operator">-></span><span class="token function">GetMemMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">TryReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>      <span class="token function">CHECK</span><span class="token punctuation">(</span>temp_space_<span class="token operator">-></span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>    gc_type <span class="token operator">=</span> collector<span class="token double-colon punctuation">::</span>kGcTypeFull<span class="token punctuation">;</span>  <span class="token comment">// TODO: Not hard code this in.</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current_allocator_ <span class="token operator">==</span> kAllocatorTypeRosAlloc <span class="token operator">||</span></pre></td></tr><tr><td data-num="108"></td><td><pre>      current_allocator_ <span class="token operator">==</span> kAllocatorTypeDlMalloc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>    collector <span class="token operator">=</span> <span class="token function">FindCollectorByGcType</span><span class="token punctuation">(</span>gc_type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Invalid current allocator "</span> <span class="token operator">&lt;&lt;</span> current_allocator_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>  <span class="token function">CHECK</span><span class="token punctuation">(</span>collector <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="115"></td><td><pre>      <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not find garbage collector with collector_type="</span></pre></td></tr><tr><td data-num="116"></td><td><pre>      <span class="token operator">&lt;&lt;</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">></span></span></span><span class="token punctuation">(</span>collector_type_<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" and gc_type="</span> <span class="token operator">&lt;&lt;</span> gc_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>  collector<span class="token operator">-></span><span class="token function">Run</span><span class="token punctuation">(</span>gc_cause<span class="token punctuation">,</span> clear_soft_references <span class="token operator">||</span> runtime<span class="token operator">-></span><span class="token function">IsZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token function">IncrementFreedEver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  <span class="token function">RequestTrim</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>  <span class="token comment">// Collect cleared references.</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  SelfDeletingTask<span class="token operator">*</span> clear <span class="token operator">=</span> reference_processor_<span class="token operator">-></span><span class="token function">CollectClearedReferences</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>  <span class="token comment">// Grow the heap so that we know when to perform the next GC.</span></pre></td></tr><tr><td data-num="123"></td><td><pre>  <span class="token function">GrowForUtilization</span><span class="token punctuation">(</span>collector<span class="token punctuation">,</span> bytes_allocated_before_gc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>  old_native_bytes_allocated_<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token function">GetNativeBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>  <span class="token function">LogGC</span><span class="token punctuation">(</span>gc_cause<span class="token punctuation">,</span> collector<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>  <span class="token function">FinishGC</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gc_type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>  <span class="token comment">// Actually enqueue all cleared references. Do this after the GC has officially finished since</span></pre></td></tr><tr><td data-num="128"></td><td><pre>  <span class="token comment">// otherwise we can deadlock.</span></pre></td></tr><tr><td data-num="129"></td><td><pre>  clear<span class="token operator">-></span><span class="token function">Run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>  clear<span class="token operator">-></span><span class="token function">Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>  <span class="token comment">// Inform DDMS that a GC completed.</span></pre></td></tr><tr><td data-num="132"></td><td><pre>  <span class="token class-name">Dbg</span><span class="token double-colon punctuation">::</span><span class="token function">GcDidFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre></pre></td></tr><tr><td data-num="134"></td><td><pre>  <span class="token comment">// Unload native libraries for class unloading. We do this after calling FinishGC to prevent</span></pre></td></tr><tr><td data-num="135"></td><td><pre>  <span class="token comment">// deadlocks in case the JNI_OnUnload function does allocations.</span></pre></td></tr><tr><td data-num="136"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    ScopedObjectAccess <span class="token function">soa</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>	<span class="token comment">// 调用 JNI_OnUnload</span></pre></td></tr><tr><td data-num="139"></td><td><pre>    soa<span class="token punctuation">.</span><span class="token function">Vm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">UnloadNativeLibraries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>  <span class="token keyword">return</span> gc_type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="call_destructors"><a class="anchor" href="#call_destructors">#</a> call_destructors</h2>
<p><code>call_destructors</code>  函数如下，我们向上找找看交叉引用</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\bionic\linker\linker_soinfo.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> soinfo<span class="token double-colon punctuation">::</span><span class="token function">call_destructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>constructors_called<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  ScopedTrace <span class="token function">trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"calling destructors: "</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// DT_FINI_ARRAY must be parsed in reverse order.</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token function">call_array</span><span class="token punctuation">(</span><span class="token string">"DT_FINI_ARRAY"</span><span class="token punctuation">,</span> fini_array_<span class="token punctuation">,</span> fini_array_count_<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// DT_FINI should be called after DT_FINI_ARRAY if both are present.</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">call_function</span><span class="token punctuation">(</span><span class="token string">"DT_FINI"</span><span class="token punctuation">,</span> fini_func_<span class="token punctuation">,</span> <span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="soinfo_unload_impl"><a class="anchor" href="#soinfo_unload_impl">#</a> soinfo_unload_impl</h3>
<p>这里我们发现 log 代码中都出现了 <code>dlclose</code>  字样，那么显而易见这应该和 <code>dlclose</code>  脱不了干系，在往上看看</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">soinfo_unload_impl</span><span class="token punctuation">(</span>soinfo<span class="token operator">*</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  ScopedTrace <span class="token function">trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"unload "</span><span class="token punctuation">)</span> <span class="token operator">+</span> root<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">bool</span> is_linked <span class="token operator">=</span> root<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token operator">-></span><span class="token function">can_unload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>           <span class="token string">"... dlclose(root=\"%s\"@%p) ... not unloading - the load group is flagged with NODELETE"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>           root<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>           root<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  soinfo_list_t unload_list<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  unload_list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  soinfo_list_t local_unload_list<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  soinfo_list_t external_unload_list<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  soinfo<span class="token operator">*</span> si <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">// 将要卸载的 so 的 soinfo 添加到 local_unload_list 中</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>si <span class="token operator">=</span> unload_list<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>local_unload_list<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    local_unload_list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-></span><span class="token function">has_min_version</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      soinfo<span class="token operator">*</span> child <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>child <span class="token operator">=</span> si<span class="token operator">-></span><span class="token function">get_children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token function">TRACE</span><span class="token punctuation">(</span><span class="token string">"%s@%p needs to unload %s@%p"</span><span class="token punctuation">,</span> si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> si<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            child<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>        child<span class="token operator">-></span><span class="token function">get_parents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>local_unload_list<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>          <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> child<span class="token operator">-></span><span class="token function">get_local_group_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>          external_unload_list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token operator">-></span><span class="token function">get_parents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>          unload_list<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token function">async_safe_fatal</span><span class="token punctuation">(</span><span class="token string">"soinfo for \"%s\"@%p has no version"</span><span class="token punctuation">,</span> si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>  local_unload_list<span class="token punctuation">.</span><span class="token function">for_each</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>soinfo<span class="token operator">*</span> si<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>           <span class="token string">"... dlclose: calling destructors for \"%s\"@%p ... "</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>           si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="55"></td><td><pre>           si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>	<span class="token comment">// 调用 call_destructors 执行 final_array 和 final 函数</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    si<span class="token operator">-></span><span class="token function">call_destructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="59"></td><td><pre>           <span class="token string">"... dlclose: calling destructors for \"%s\"@%p ... done"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="60"></td><td><pre>           si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>           si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token comment">// 进行 soinfo 最后的收尾工作</span></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>si <span class="token operator">=</span> local_unload_list<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="67"></td><td><pre>           <span class="token string">"... dlclose: unloading \"%s\"@%p ..."</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="68"></td><td><pre>           si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>           si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token operator">++</span>g_module_unload_counter<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token function">notify_gdb_of_unload</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token function">unregister_soinfo_tls</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__libc_shared_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>unload_hook<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>      <span class="token function">__libc_shared_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">unload_hook</span><span class="token punctuation">(</span>si<span class="token operator">-></span>load_bias<span class="token punctuation">,</span> si<span class="token operator">-></span>phdr<span class="token punctuation">,</span> si<span class="token operator">-></span>phnum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token function">get_cfi_shadow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">BeforeUnload</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token function">soinfo_free</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>is_linked<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>si <span class="token operator">=</span> external_unload_list<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="83"></td><td><pre>             <span class="token string">"... dlclose: unloading external reference \"%s\"@%p ..."</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="84"></td><td><pre>             si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="85"></td><td><pre>             si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>      <span class="token function">soinfo_unload</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>      <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="90"></td><td><pre>             <span class="token string">"... dlclose: unload_si was not linked - not unloading external references ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="soinfo_unload"><a class="anchor" href="#soinfo_unload">#</a> soinfo_unload</h3>
<p><code>soinfo_unload_impl</code>  被 <code>soinfo_unload</code>  调用，主要让引用计数减一，然后调用核心的卸载逻辑</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">soinfo_unload</span><span class="token punctuation">(</span>soinfo<span class="token operator">*</span> unload_si<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment">// Note that the library can be loaded but not linked;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">// in which case there is no root but we still need</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">// to walk the tree and unload soinfos involved.</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// This happens on unsuccessful dlopen, when one of</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// the DT_NEEDED libraries could not be linked/found.</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// 这个 so 不管有没有被链接，只要加载了，那必须得 unload 卸载</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">bool</span> is_linked <span class="token operator">=</span> unload_si<span class="token operator">-></span><span class="token function">is_linked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  soinfo<span class="token operator">*</span> root <span class="token operator">=</span> is_linked <span class="token operator">?</span> unload_si<span class="token operator">-></span><span class="token function">get_local_group_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> unload_si<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>         <span class="token string">"... dlclose(realpath=\"%s\"@%p) ... load group root is \"%s\"@%p"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>         unload_si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>         unload_si<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>         root<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>         root<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">// 如果被其他库链接了 (其实就是被引用了), 那卸载的时候引用计数就 - 1</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  size_t ref_count <span class="token operator">=</span> is_linked <span class="token operator">?</span> root<span class="token operator">-></span><span class="token function">decrement_ref_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ref_count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>           <span class="token string">"... dlclose(root=\"%s\"@%p) ... not unloading - decrementing ref_count to %zd"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>           root<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>           root<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>           ref_count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token comment">// 执行核心 unload 操作</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token function">soinfo_unload_impl</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="do_dlclose"><a class="anchor" href="#do_dlclose">#</a> do_dlclose</h3>
<p>果不其然，是调用 <code>do_dlclose</code>  来进行卸载的</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">do_dlclose</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  ScopedTrace <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"dlclose"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  ProtectedDataGuard guard<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  soinfo<span class="token operator">*</span> si <span class="token operator">=</span> <span class="token function">soinfo_from_handle</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>si <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">DL_OPEN_ERR</span><span class="token punctuation">(</span><span class="token string">"invalid handle: %p"</span><span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>         <span class="token string">"dlclose(handle=%p, realpath=\"%s\"@%p) ..."</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>         handle<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>         si<span class="token operator">-></span><span class="token function">get_realpath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>         si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">// 卸载 soinfo</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token function">soinfo_unload</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token function">LD_LOG</span><span class="token punctuation">(</span>kLogDlopen<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>         <span class="token string">"dlclose(handle=%p) ... done"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>         handle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="__loader_dlclose"><a class="anchor" href="#__loader_dlclose">#</a> __loader_dlclose</h3>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\bionic\linker\dlfcn.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">__loader_dlclose</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  ScopedPthreadMutexLocker <span class="token function">locker</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_dl_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">do_dlclose</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">__bionic_format_dlerror</span><span class="token punctuation">(</span><span class="token string">"dlclose failed"</span><span class="token punctuation">,</span> <span class="token function">linker_get_error_buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="dlclose"><a class="anchor" href="#dlclose">#</a> dlclose</h3>
<p>最终来到了 <code>dlclose</code>  这个函数，但是因为 <code>dlclose</code>  的调用实在是太多了，我们很难去找到究竟是哪一个函数调用的 <code>dlclose</code>  来对这个 so 执行最终的卸载操作</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//E:\android-platform\bionic\libdl\libdl.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__weak__<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> <span class="token function">dlclose</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">__loader_dlclose</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="注释中的矛盾点"><a class="anchor" href="#注释中的矛盾点">#</a> 注释中的矛盾点</h3>
<p>我们向前看看 android 开发者留给我们的注释</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\art\runtime\jni\java_vm_ext.cc</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">JavaVMExt</span><span class="token double-colon punctuation">::</span><span class="token function">LoadNativeLibrary</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                                  jobject class_loader<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                                  jclass caller_class<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                                  std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> error_msg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// 阶段二：加载 so</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// Open the shared library.  Because we're using a full path, the system</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// doesn't have to search through LD_LIBRARY_PATH.  (It may do so to</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// resolve this library's dependencies though.)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// Failures here are expected when java.library.path has several entries</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">// and we have to hunt for the lib.</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// Below we dlopen but there is no paired dlclose, this would be necessary if we supported</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">// class unloading. Libraries will only be unloaded when the reference count (incremented by</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">// dlopen) becomes zero from dlclose.</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token comment">// Retrieve the library path from the classloader, if necessary.</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  ScopedLocalRef<span class="token operator">&lt;</span>jstring<span class="token operator">></span> <span class="token function">library_path</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token function">GetLibrarySearchPath</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> class_loader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  Locks<span class="token double-colon punctuation">::</span>mutator_lock_<span class="token operator">-></span><span class="token function">AssertNotHeld</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path_str <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">nullptr</span> <span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">bool</span> needs_native_bridge <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">char</span><span class="token operator">*</span> nativeloader_error_msg <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token comment">// 调用 dlopen 打开目标 so</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">void</span><span class="token operator">*</span> handle <span class="token operator">=</span> android<span class="token double-colon punctuation">::</span><span class="token function">OpenNativeLibrary</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      env<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      runtime_<span class="token operator">-></span><span class="token function">GetTargetSdkVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      path_str<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      class_loader<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token punctuation">(</span>caller_location<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">nullptr</span> <span class="token operator">:</span> caller_location<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      library_path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token operator">&amp;</span>needs_native_bridge<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token operator">&amp;</span>nativeloader_error_msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token function">VLOG</span><span class="token punctuation">(</span>jni<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"[Call to dlopen(\""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\", RTLD_NOW) returned "</span> <span class="token operator">&lt;&lt;</span> handle <span class="token operator">&lt;&lt;</span> <span class="token string">"]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote>
<p>Below we dlopen but there is no paired dlclose, this would be necessary if we supported class unloading. Libraries will only be unloaded when the reference count (incremented by dlopen) becomes zero from dlclose.</p>
</blockquote>
<p>当调用 <code>dlopen</code>  加载 so 时，会增加一次对 so 的引用计数，而当引用计数变成 0 之后，便会自动调用 <code>dlclose</code>  卸载 so</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> soinfo<span class="token operator">*</span> <span class="token function">find_library</span><span class="token punctuation">(</span>android_namespace_t<span class="token operator">*</span> ns<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                            <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> rtld_flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                            <span class="token keyword">const</span> android_dlextinfo<span class="token operator">*</span> extinfo<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                            soinfo<span class="token operator">*</span> needed_by<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  soinfo<span class="token operator">*</span> si <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// 加载 so 成功，so 的引用次数 + 1, 对应了 JavaVMExt::LoadNativeLibrary 中</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">//so 加载时 这一部分的注释↓</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">/*</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  Below we dlopen but there is no paired dlclose, this would be necessary if we supported</pre></td></tr><tr><td data-num="12"></td><td><pre>  class unloading. Libraries will only be unloaded when the reference count (incremented by</pre></td></tr><tr><td data-num="13"></td><td><pre>  dlopen) becomes zero from dlclose.</pre></td></tr><tr><td data-num="14"></td><td><pre>  */</pre></td></tr><tr><td data-num="15"></td><td><pre>  si<span class="token operator">-></span><span class="token function">increment_ref_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">return</span> si<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>所以现在我们的目标从谁调用了 <code>dlclose</code>  变成了谁调用了 <code>soinfo::decrement_ref_count</code> , 但是在 <code>soinfo_unload</code>  中，不是已经调用过 <code>decrement_ref_count</code>  了吗，这段注释和实际的情况怎么看起来相互矛盾？我们期望的函数调用是 <code>anonymous_func-&gt;decrement_ref_count-&gt;dlclose</code> , 但是实际的调用流是 <code>dlclose-&gt;decrement_ref_count</code> , 这完全是相反的调用过程呀</p>
<h2 id="编写demo观察卸载函数调用先后情况"><a class="anchor" href="#编写demo观察卸载函数调用先后情况">#</a> 编写 demo 观察卸载函数调用先后情况</h2>
<p>现在我们光从源码已经很难再逆向分析出最终是在哪一个函数中依次调用了 <code>JNI_OnUnload</code>  和 <code>call_destructors</code> , 所以我们需要实际动手写一个测试 demo, 通过打印日志的方式，通过 <code>logcat</code>  来观察实际的调用情况</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jni.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">extern</span> <span class="token string">"C"</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/log.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TAG</span> <span class="token string">"oacia_tag"</span> <span class="token comment">// 这个是自定义的 LOG 的标识</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGD</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">__android_log_print</span><span class="token punctuation">(</span>ANDROID_LOG_DEBUG<span class="token punctuation">,</span>TAG <span class="token punctuation">,</span>__VA_ARGS__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>jint <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved __unused<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"JNI_OnLoad called"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> JNI_VERSION_1_6<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">__attribute</span><span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">before_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"constructor called!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token function">__attribute</span><span class="token punctuation">(</span><span class="token punctuation">(</span>destructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">after_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"destructor called!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">void</span> <span class="token function">JNI_OnUnload</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved __unused<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"JNI_OnUnload called"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然而当退出 app 时，不论 <code>JNI_OnUnload</code>  还是 <code>destructor</code>  均没有被调用，走到这里看起来已经进入死胡同了，可能这两个函数从未被调用… 那暂时先到此为止吧～要是未来有新的发现的话再继续卸载过程的分析</p>
<p><img data-src="/android-load-so/image-20240711144153063.png" alt="image-20240711144153063" style="aspect-ratio:1122 / 63;"></p>
<h1 id="参考资料"><a class="anchor" href="#参考资料">#</a> 参考资料</h1>
<ul>
<li><span class="exturl" data-url="aHR0cDovL2Ryb3BzLnhtZDUuY29tL3N0YXRpYy9kcm9wcy90aXBzLTEyMTIyLmh0bWw=">Android Linker 学习笔记</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ndHRpYW5rYWkuZ2l0aHViLmlvLzIwMTgvMDEvMDMvYW5kcm9pZCVFNyVCMyVCQiVFNyVCQiU5RiVFNSU4QSVBMCVFOCVCRCVCRHNvJUU3JTlBJTg0JUU2JUJBJTkwJUU3JUEwJTgxJUU1JTg4JTg2JUU2JTlFJTkwLw==">Android 系统加载 so 的源码分析</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9zYW5mZW5nYW5kcm9pZC5naXRodWIuaW8vMjAyMS8wMS8xMC9tb2RpZnktbGlua2VyLXRvLWltcGxlbWVudC1wbHQtaG9vay8=">Android 动态修改 Linker 实现 LD_PRELOAD 全局库 PLT Hook</span></li>
</ul>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2025-04-09 02:55:11" itemprop="dateModified" datetime="2025-04-09T02:55:11+08:00">2025-04-09</time>
  </span>
  <span id="android-load-so/" class="item leancloud_visitors" data-flag-title="安卓so加载流程源码分析" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>oacia <i class="ic i-at"><em>@</em></i>oaciaのBbBlog~
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://oacia.dev/android-load-so/" title="安卓so加载流程源码分析">https://oacia.dev/android-load-so/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/wechat-mini-program-with-devtool/" itemprop="url" rel="prev" data-background-image="&#x2F;picture&#x2F;346694.webp" title="微信小程序devtool抓包+反编译wxapkg">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>微信小程序devtool抓包+反编译wxapkg</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/ElfReader/" itemprop="url" rel="next" data-background-image="&#x2F;picture&#x2F;302736.webp" title="ELF结构分析及ElfReader">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>ELF结构分析及ElfReader</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#so%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="toc-text"> so 的启动过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#systemload"><span class="toc-text"> System.load</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#runtimegetruntimeload0"><span class="toc-text"> Runtime.getRuntime().load0</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#runtimejava%E4%B8%AD%E7%9A%84nativeload"><span class="toc-text"> Runtime.java 中的 nativeLoad</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#runtimec%E4%B8%AD%E7%9A%84nativeload"><span class="toc-text"> Runtime.c 中的 nativeLoad</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jvm_nativeload"><span class="toc-text"> JVM_NativeLoad</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vm-loadnativelibrary"><span class="toc-text"> vm-&gt;LoadNativeLibrary</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#so%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B"><span class="toc-text"> so 的加载过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#androidopennativelibrary"><span class="toc-text"> android::OpenNativeLibrary</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#android_dlopen_ext"><span class="toc-text"> android_dlopen_ext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#__loader_android_dlopen_ext"><span class="toc-text"> __loader_android_dlopen_ext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dlopen_ext"><span class="toc-text"> dlopen_ext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#do_dlopen"><span class="toc-text"> do_dlopen</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#soinfo"><span class="toc-text"> soinfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call_constructors"><span class="toc-text"> call_constructors</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#find_library"><span class="toc-text"> find_library</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#find_libraries"><span class="toc-text"> find_libraries</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5"><span class="toc-text"> 准备阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E4%BE%9D%E8%B5%96%E5%BA%93%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%BE%85%E5%8A%A0%E8%BD%BD%E9%98%9F%E5%88%97"><span class="toc-text"> 寻找依赖库，添加到待加载队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#find_library_internal"><span class="toc-text"> find_library_internal</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#load_library"><span class="toc-text"> load_library</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%BD%BD%E7%9A%84load_library"><span class="toc-text"> 重载的 load_library</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%B1%E5%BA%8F%E5%8A%A0%E8%BD%BD%E5%BA%93"><span class="toc-text"> 乱序加载库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E9%93%BE%E6%8E%A5%E8%A7%A3%E6%9E%90%E6%89%80%E6%9C%89%E4%BE%9D%E8%B5%96%E5%BA%93"><span class="toc-text"> 预链接解析所有依赖库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%85%A8%E5%B1%80%E7%BB%84"><span class="toc-text"> 构造全局组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B6%E9%9B%86local_groups%E7%9A%84%E6%A0%B9%E8%8A%82%E7%82%B9"><span class="toc-text"> 收集 local_groups 的根节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E6%89%80%E6%9C%89%E7%9A%84local-groups"><span class="toc-text"> 链接所有的 local groups</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B6%E5%B0%BE%E5%B7%A5%E4%BD%9C"><span class="toc-text"> 收尾工作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#so%E7%9A%84%E5%8D%B8%E8%BD%BD%E8%BF%87%E7%A8%8B"><span class="toc-text"> so 的卸载过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#jni_onunload"><span class="toc-text"> JNI_OnUnload</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#unloadlibraries"><span class="toc-text"> UnloadLibraries</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unloadnativelibraries"><span class="toc-text"> UnloadNativeLibraries</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#javavmextunloadnativelibraries"><span class="toc-text"> JavaVMExt::UnloadNativeLibraries</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#heapcollectgarbageinternal"><span class="toc-text"> Heap::CollectGarbageInternal</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#call_destructors"><span class="toc-text"> call_destructors</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#soinfo_unload_impl"><span class="toc-text"> soinfo_unload_impl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#soinfo_unload"><span class="toc-text"> soinfo_unload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#do_dlclose"><span class="toc-text"> do_dlclose</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#__loader_dlclose"><span class="toc-text"> __loader_dlclose</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dlclose"><span class="toc-text"> dlclose</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A%E4%B8%AD%E7%9A%84%E7%9F%9B%E7%9B%BE%E7%82%B9"><span class="toc-text"> 注释中的矛盾点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99demo%E8%A7%82%E5%AF%9F%E5%8D%B8%E8%BD%BD%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%85%88%E5%90%8E%E6%83%85%E5%86%B5"><span class="toc-text"> 编写 demo 观察卸载函数调用先后情况</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text"> 参考资料</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="oacia"
      data-src="/images/avatar.jpg">
  
  <svg class="logo-overview" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 540.19 380.99">
    <g id="clips" fill= #00a99d; stroke="none">
      <clipPath id="o">
        <path d="M93.57,284c8,0,14.91-1,20.75-3,5.83-2,10.41-3.66,13.75-5,4.66-1.66,6.16-.75,4.5,2.75-1.67,3.5-4.67,6.42-9,8.75-2.34,1.34-6.09,2.84-11.25,4.5-5.17,1.67-11.09,2.5-17.75,2.5-.34,8.67-3.34,16.84-9,24.5-5.67,7.67-13.34,13.34-23,17-6,2.34-12.17,3.59-18.5,3.75-6.34,.17-12.17-.66-17.5-2.5-5.34-1.83-10.09-4.66-14.25-8.5-4.17-3.83-7.25-8.41-9.25-13.75-2-5.33-2.83-11-2.5-17s1.83-11.83,4.5-17.5c2.66-5.66,6.33-10.75,11-15.25,4.66-4.5,10.16-7.75,16.5-9.75,5.66-1.66,11.41-1.66,17.25,0,5.83,1.67,10.08,4.34,12.75,8,1.66,2.67,2.5,5.67,2.5,9,3-2,6.33-3,10-3h1c3.33,0,6.5,.84,9.5,2.5,3,1.67,5.33,4.5,7,8.5l1,3.5Zm-34,39.5c5.66-.66,10.33-3.83,14-9.5,3.66-5.66,5.33-12.16,5-19.5-4.67,.34-9.09-.41-13.25-2.25-4.17-1.83-6.42-4.58-6.75-8.25-.67-3,0-5.5,2-7.5-.67-2.66-2.75-5-6.25-7s-7.09-2.16-10.75-.5c-4.67,2-8.25,5.84-10.75,11.5-2.5,5.67-3.09,11.84-1.75,18.5,1.33,8,4.75,14.34,10.25,19,5.5,4.67,11.58,6.5,18.25,5.5Z"/>
      </clipPath>
      <clipPath id="a1">
        <path d="M176.06,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      <clipPath id="c">
        <path d="M250.06,280.5c4.66-7.66,12-13.16,22-16.5,10-3.33,19.83-3.66,29.5-1,7.66,2.34,13.5,5.67,17.5,10,4,4.34,5.83,8.5,5.5,12.5-.34,4.67-2.25,8.59-5.75,11.75-3.5,3.17-7.09,5.34-10.75,6.5-3.67,1.17-6.84,1.25-9.5,.25-2.67-1-3.34-3.16-2-6.5,2.66-8,2.75-14.58,.25-19.75-2.5-5.16-5.92-6.41-10.25-3.75-2.67,1.67-5,4.09-7,7.25-2,3.17-3.5,6.75-4.5,10.75s-1.42,8.09-1.25,12.25c.16,4.17,.75,7.92,1.75,11.25,1.33,4,3.66,7.42,7,10.25,3.33,2.84,7.16,4.67,11.5,5.5,4.33,.84,8.91,.67,13.75-.5,4.83-1.16,9.25-3.75,13.25-7.75,7.33-6.66,12.33-14.33,15-23,.33-1.66,1.16-2.91,2.5-3.75,1.33-.83,2.5-1.08,3.5-.75,1,.34,1.83,1.09,2.5,2.25,.66,1.17,.66,2.92,0,5.25-2.34,9.34-6.34,17-12,23-4.67,5.67-10.5,10.42-17.5,14.25-7,3.84-14.25,6.09-21.75,6.75-7.5,.67-14.84-.33-22-3-7.17-2.66-13.25-7.5-18.25-14.5-6-8.66-8.75-17.66-8.25-27,.5-9.33,2.25-16.66,5.25-22Z"/>
      </clipPath>
      <clipPath id="i_b">
        <path d="M393.06,330c-2.34,2.67-5.17,5.09-8.5,7.25-3.34,2.17-7.09,3.59-11.25,4.25-4.17,.67-8.59,.67-13.25,0-4.67-.66-9.17-2.33-13.5-5-4.67-2.66-7.67-7.58-9-14.75-1.34-7.16-1.83-14.66-1.5-22.5,.33-7.83,1.33-14.91,3-21.25,1.66-6.33,3.33-10.16,5-11.5,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,3.59,1.25,6.75-.17,3.17-.5,6.92-1,11.25-.5,4.34-1.09,8.92-1.75,13.75-.67,4.84-.67,9.42,0,13.75,.33,3.67,1.33,6.42,3,8.25,1.66,1.84,3.5,2.84,5.5,3,2,.17,4-.25,6-1.25s3.83-2.33,5.5-4c3-3.66,5.66-7.66,8-12,2.33-4.33,4.16-8.16,5.5-11.5,1-3.66,2.91-5.25,5.75-4.75,2.83,.5,3.75,3.09,2.75,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.34,8.59-10,14.25Z"/>
      </clipPath>
      <clipPath id="a2">
        <path d="M461.56,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      
    </g>
    <g
      id="strokes"
      fill="none"
      stroke=#96d7f5
      stroke-linecap="round"
      stroke-linejoin="round"
    >
    <path
    clip-path="url(#o)"
    class="oPath path"
    d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
    stroke-width="32.5"
    ></path>
    <path
      clip-path="url(#a1)"
      class="a1Path path"
      d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
      stroke-width="59"
    ></path>
    <path
      clip-path="url(#c)"
      class="cPath path"
      d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
      stroke-width="110"
    ></path>
    <path
      clip-path="url(#i_b)"
      class="i_bPath path"
      d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
      stroke-width="33"
    ></path>
    <path
      clip-path="url(#a2)"
      class="a2Path path"
      d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
      stroke-width="70"
    ></path>
    </g>
    <g
      id="strokes2"
      fill="none"
      stroke=#ff97b8
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path
        clip-path="url(#o)"
        class="oPath path"
        d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
        stroke-width="32.5"
      ></path>
      <path
        clip-path="url(#a1)"
        class="a1Path path"
        d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
        stroke-width="59"
      ></path>
      <path
        clip-path="url(#c)"
        class="cPath path"
        d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
        stroke-width="110"
      ></path>
      <path
        clip-path="url(#i_b)"
        class="i_bPath path"
        d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
        stroke-width="33"
      ></path>
      <path
        clip-path="url(#a2)"
        class="a2Path path"
        d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
        stroke-width="70"
      ></path>
    </g>
    <g class="dot-group">
      <path
        id="dot"
        fill=#ff97b8
        d="M362.58,182.21c4.66-.33,9.66,1.17,15,4.5,5.33,3.34,7.66,7.5,7,12.5-.67,2.34-1.92,4.92-3.75,7.75-1.84,2.84-4,5.5-6.5,8s-4.84,4.75-7,6.75c-2.17,2-3.75,3.17-4.75,3.5-2.67,1.67-5.34,2.25-8,1.75-2.67-.5-5-1.5-7-3s-3.59-3.33-4.75-5.5c-1.17-2.16-1.92-4.25-2.25-6.25-.34-2,.16-4.66,1.5-8,1.33-3.33,3.08-6.58,5.25-9.75,2.16-3.16,4.58-6,7.25-8.5,2.66-2.5,5.33-3.75,8-3.75Z"
      ></path>
    </g>
  </svg>
  <div class="description" itemprop="description">月遇从云 花遇和风</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">53</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">46</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lh" title="https:&#x2F;&#x2F;github.com&#x2F;oacia"><i class="ic i-github"></i></span>
      <a target="_blank" rel="noopener" href="https://twitter.com/oacia86" title="https:&#x2F;&#x2F;twitter.com&#x2F;oacia86" class="item twitter"><i class="ic i-twitter"></i></a>
      <span class="exturl item paper-plane" data-url="aHR0cHM6Ly90Lm1lL29hY2lh" title="https:&#x2F;&#x2F;t.me&#x2F;oacia"><i class="ic i-paper-plane"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOm9hY2lhODZAZ21haWwuY29t" title="mailto:oacia86@gmail.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about-oacia/" rel="section"><i class="ic i-user"></i>关于oacia</a>
  </li>

    
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-feather"></i>文章</a>
  </li>

    
  <li class="item">
    <a href="/TODOlist/" rel="section"><i class="ic i-clock"></i>要做的事</a>
  </li>

    
  <li class="item">
    <a href="/website_maintenance/" rel="section"><i class="ic i-calendar"></i>更新日志</a>
  </li>

    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>小伙伴</a>
  </li>

    
  <li class="item">
    <a href="/music/" rel="section"><i class="ic i-music"></i>听会儿歌吧</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/wechat-mini-program-with-devtool/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/ElfReader/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2022 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">oacia @ oacia</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">968k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">14:40</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>



<script data-config type="text/javascript">
  var LOCAL = {
    path: 'android-load-so/',
    favicon: {
      show: "柚鳥ナツ",
      hide: "甘い幸せ"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>
<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>


<script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>
<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
