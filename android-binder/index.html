



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="qQVmgWozVe7BXoA15J3gAZpEA5dK168admH4U3W6PAk">
  <meta name="msvalidate.01" content="4902E39C0135E72DE537BCB0FE08B40A">
  <meta name="baidu-site-verification" content="codeva-CSYjpuVg5v">


<link rel="alternate" type="application/rss+xml" title="oaciaのBbBlog~" href="https://oacia.dev/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="oaciaのBbBlog~" href="https://oacia.dev/atom.xml" />
<link rel="alternate" type="application/json" title="oaciaのBbBlog~" href="https://oacia.dev/feed.json" />
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-regular.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-700.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/font_1832207_igi8uaupcus.woff2"
/>
<link rel="preload" href="/background_picture/1_gongzi.webp" as="image" />
<link rel="preload" href="/background_picture/2_xiaoxia.webp" as="image" />
<link rel="preload" href="/background_picture/3_xingye.webp" as="image" />
<link rel="preload" href="/images/avatar.jpg" as="image" />



<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="https://oacia.dev/android-binder/">


<meta name="description" content="Binder 是 Android 独有的一种通信机制， Activity ， Service ， Broadcast ， ContentProvider  这四大组件所涉及的多进程间的通信底层都是依赖于 Binder IPC 机制。学好底层的通信原理对掌握安卓这幢大厦有着重要的意义. # 说明 本文所研究的安卓内核版本为 Linux version 4.9.270-g862f51bac900-ab">
<meta property="og:type" content="article">
<meta property="og:title" content="android binder源码分析">
<meta property="og:url" content="https://oacia.dev/android-binder/">
<meta property="og:site_name" content="oaciaのBbBlog~">
<meta property="og:description" content="Binder 是 Android 独有的一种通信机制， Activity ， Service ， Broadcast ， ContentProvider  这四大组件所涉及的多进程间的通信底层都是依赖于 Binder IPC 机制。学好底层的通信原理对掌握安卓这幢大厦有着重要的意义. # 说明 本文所研究的安卓内核版本为 Linux version 4.9.270-g862f51bac900-ab">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://oacia.dev/android-binder/binder_interprocess_communication.png">
<meta property="og:image" content="https://oacia.dev/android-binder/IPC-Binder.jpg">
<meta property="og:image" content="https://oacia.dev/android-binder/binder_physical_memory.jpg">
<meta property="og:image" content="https://oacia.dev/android-binder/binder_ipc.jpg">
<meta property="og:image" content="https://oacia.dev/android-binder/binder_transaction_ipc.jpg">
<meta property="og:image" content="https://oacia.dev/android-binder/binder_protocol.jpg">
<meta property="og:image" content="https://oacia.dev/android-binder/protocol_transaction.jpg">
<meta property="og:image" content="https://oacia.dev/android-binder/protocol_binder_dead.jpg">
<meta property="og:image" content="https://oacia.dev/android-binder/IPC-Binder.jpg">
<meta property="og:image" content="https://oacia.dev/android-binder/1595250-20211114151720684-1823259499.png">
<meta property="og:image" content="https://oacia.dev/android-binder/image002.png">
<meta property="og:image" content="https://oacia.dev/android-binder/image003.png">
<meta property="og:image" content="https://oacia.dev/android-binder/1595250-20211114151757336-739536801.png">
<meta property="og:image" content="https://oacia.dev/android-binder/1595250-20211114151811263-2017459210.png">
<meta property="article:published_time" content="2024-07-06T06:25:21.000Z">
<meta property="article:modified_time" content="2025-04-08T18:55:11.439Z">
<meta property="article:author" content="oacia">
<meta property="article:tag" content="reverse,安卓逆向,区块链,学习笔记,破解实战,前端,CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oacia.dev/android-binder/binder_interprocess_communication.png">
<meta name="twitter:creator" content="@oacia86">


  <title>
android binder源码分析 |
oacia = oaciaのBbBlog~ = DEVIL or SWEET</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  var jq_151 = $.noConflict(true);
  var RENDERER = {
    INIT_CHERRY_BLOSSOM_COUNT : 30,
    MAX_ADDING_INTERVAL : 10,
    WATCH_INTERVAL : 300,
    
    init : function(){
      this.setParameters();
      this.reconstructMethods();
      this.setup();
      this.bindEvent();
      this.render();
    },
    setParameters : function(){
      this.$window = jq_151(window);
      this.$container = jq_151('#loading');
      this.$canvas = jq_151('<canvas />');
      this.context = this.$canvas.appendTo(this.$container).get(0).getContext('2d');
      this.cherries = [];
      this.watchIds = [];
    },
    reconstructMethods : function(){
      this.watchWindowSize = this.watchWindowSize.bind(this);
      this.jdugeToStopResize = this.jdugeToStopResize.bind(this);
      this.render = this.render.bind(this);
    },
    setup : function(){
      this.cherries.length = 0;
      this.watchIds.length = 0;
      this.width = this.$container.width();
      this.height = this.$container.height();
      this.$canvas.attr({width : this.width, height : this.height});
      this.maxAddingInterval = Math.round(this.MAX_ADDING_INTERVAL * 1000 / this.width);
      this.addingInterval = this.maxAddingInterval;
      this.createCherries();
    },
    createCherries : function(){
      for(var i = 0, length = Math.round(this.INIT_CHERRY_BLOSSOM_COUNT * this.width / 1000); i < length; i++){
        this.cherries.push(new CHERRY_BLOSSOM(this, true));
      }
    },
    watchWindowSize : function(){
      this.clearTimer();
      this.tmpWidth = window.width;
      this.tmpHeight = window.height;
      this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL));
    },
    clearTimer : function(){
      while(this.watchIds.length > 0){
        clearTimeout(this.watchIds.pop());
      }
    },
    jdugeToStopResize : function(){
      var width = window.width,
        height = window.height,
        stopped = (width == this.tmpWidth && height == this.tmpHeight);
        
      this.tmpWidth = width;
      this.tmpHeight = height;
      
      if(stopped){
        this.setup();
      }
    },
    bindEvent : function(){
      this.$window.on('resize', this.watchWindowSize);
    },
    render : function(){
      //console.log("render")

      if(jq_151(this.$container).css("display")!="none"){
        requestAnimationFrame(this.render);
      }
      
      this.context.clearRect(0, 0, this.width, this.height);
      
      this.cherries.sort(function(cherry1, cherry2){
        return cherry1.z - cherry2.z;
      });
      for(var i = this.cherries.length - 1; i >= 0; i--){
        if(!this.cherries[i].render(this.context)){
          this.cherries.splice(i, 1);
        }
      }
      if(--this.addingInterval == 0){
        this.addingInterval = this.maxAddingInterval;
        this.cherries.push(new CHERRY_BLOSSOM(this, false));
      }
    }
  };
  var CHERRY_BLOSSOM = function(renderer, isRandom){
    this.renderer = renderer;
    this.init(isRandom);
  };
  CHERRY_BLOSSOM.prototype = {
    FOCUS_POSITION : 300,
    FAR_LIMIT : 600,
    MAX_RIPPLE_COUNT : 100,
    RIPPLE_RADIUS : 100,
    SURFACE_RATE : 0.5,
    SINK_OFFSET : 20,
    
    init : function(isRandom){
      this.x = this.getRandomValue(-this.renderer.width, this.renderer.width);
      this.y = isRandom ? this.getRandomValue(0, this.renderer.height) : this.renderer.height * 1.5;
      this.z = this.getRandomValue(0, this.FAR_LIMIT);
      this.vx = this.getRandomValue(-2, 2);
      this.vy = -2;
      this.theta = this.getRandomValue(0, Math.PI * 2);
      this.phi = this.getRandomValue(0, Math.PI * 2);
      this.psi = 0;
      this.dpsi = this.getRandomValue(Math.PI / 600, Math.PI / 300);
      this.opacity = 0;
      this.endTheta = false;
      this.endPhi = false;
      this.rippleCount = 0;
      
      var axis = this.getAxis(),
        theta = this.theta + Math.ceil(-(this.y + this.renderer.height * this.SURFACE_RATE) / this.vy) * Math.PI / 500;
      theta %= Math.PI * 2;
      
      this.offsetY = 40 * ((theta <= Math.PI / 2 || theta >= Math.PI * 3 / 2) ? -1 : 1);
      this.thresholdY = this.renderer.height / 2 + this.renderer.height * this.SURFACE_RATE * axis.rate;
      this.entityColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.entityColor.addColorStop(0, 'hsl(330, 70%, ' + 50 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(0.05, 'hsl(330, 40%,' + 55 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(1, 'hsl(330, 20%, ' + 70 * (0.3 + axis.rate) + '%)');
      this.shadowColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.shadowColor.addColorStop(0, 'hsl(330, 40%, ' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(0.05, 'hsl(330, 40%,' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(1, 'hsl(330, 20%, ' + 40 * (0.3 + axis.rate) + '%)');
    },
    getRandomValue : function(min, max){
      return min + (max - min) * Math.random();
    },
    getAxis : function(){
      var rate = this.FOCUS_POSITION / (this.z + this.FOCUS_POSITION),
        x = this.renderer.width / 2 + this.x * rate,
        y = this.renderer.height / 2 - this.y * rate;
      return {rate : rate, x : x, y : y};
    },
    renderCherry : function(context, axis){
      context.beginPath();
      context.moveTo(0, 40);
      context.bezierCurveTo(-60, 20, -10, -60, 0, -20);
      context.bezierCurveTo(10, -60, 60, 20, 0, 40);
      context.fill();
      
      for(var i = -4; i < 4; i++){
        context.beginPath();
        context.moveTo(0, 40);
        context.quadraticCurveTo(i * 12, 10, i * 4, -24 + Math.abs(i) * 2);
        context.stroke();
      }
    },
    render : function(context){
      var axis = this.getAxis();
      
      if(axis.y == this.thresholdY && this.rippleCount < this.MAX_RIPPLE_COUNT){
        context.save();
        context.lineWidth = 2;
        context.strokeStyle = 'hsla(0, 0%, 100%, ' + (this.MAX_RIPPLE_COUNT - this.rippleCount) / this.MAX_RIPPLE_COUNT + ')';
        context.translate(axis.x + this.offsetY * axis.rate * (this.theta <= Math.PI ? -1 : 1), axis.y);
        context.scale(1, 0.3);
        context.beginPath();
        context.arc(0, 0, this.rippleCount / this.MAX_RIPPLE_COUNT * this.RIPPLE_RADIUS * axis.rate, 0, Math.PI * 2, false);
        context.stroke();
        context.restore();
        this.rippleCount++;
      }
      if(axis.y < this.thresholdY || (!this.endTheta || !this.endPhi)){
        if(this.y <= 0){
          this.opacity = Math.min(this.opacity + 0.01, 1);
        }
        context.save();
        context.globalAlpha = this.opacity;
        context.fillStyle = this.shadowColor;
        context.strokeStyle = 'hsl(330, 30%,' + 40 * (0.3 + axis.rate) + '%)';
        context.translate(axis.x, Math.max(axis.y, this.thresholdY + this.thresholdY - axis.y));
        context.rotate(Math.PI - this.theta);
        context.scale(axis.rate * -Math.sin(this.phi), axis.rate);
        context.translate(0, this.offsetY);
        this.renderCherry(context, axis);
        context.restore();
      }
      context.save();
      context.fillStyle = this.entityColor;
      context.strokeStyle = 'hsl(330, 40%,' + 70 * (0.3 + axis.rate) + '%)';
      context.translate(axis.x, axis.y + Math.abs(this.SINK_OFFSET * Math.sin(this.psi) * axis.rate));
      context.rotate(this.theta);
      context.scale(axis.rate * Math.sin(this.phi), axis.rate);
      context.translate(0, this.offsetY);
      this.renderCherry(context, axis);
      context.restore();
      
      if(this.y <= -this.renderer.height / 4){
        if(!this.endTheta){
          for(var theta = Math.PI / 2, end = Math.PI * 3 / 2; theta <= end; theta += Math.PI){
            if(this.theta < theta && this.theta + Math.PI / 200 > theta){
              this.theta = theta;
              this.endTheta = true;
              break;
            }
          }
        }
        if(!this.endPhi){
          for(var phi = Math.PI / 8, end = Math.PI * 7 / 8; phi <= end; phi += Math.PI * 3 / 4){
            if(this.phi < phi && this.phi + Math.PI / 200 > phi){
              this.phi = Math.PI / 8;
              this.endPhi = true;
              break;
            }
          }
        }
      }
      if(!this.endTheta){
        if(axis.y == this.thresholdY){
          this.theta += Math.PI / 200 * ((this.theta < Math.PI / 2 || (this.theta >= Math.PI && this.theta < Math.PI * 3 / 2)) ? 1 : -1);
        }else{
          this.theta += Math.PI / 500;
        }
        this.theta %= Math.PI * 2;
      }
      if(this.endPhi){
        if(this.rippleCount == this.MAX_RIPPLE_COUNT){
          this.psi += this.dpsi;
          this.psi %= Math.PI * 2;
        }
      }else{
        this.phi += Math.PI / ((axis.y == this.thresholdY) ? 200 : 500);
        this.phi %= Math.PI;
      }
      if(this.y <= -this.renderer.height * this.SURFACE_RATE){
        this.x += 2;
        this.y = -this.renderer.height * this.SURFACE_RATE;
      }else{
        this.x += this.vx;
        this.y += this.vy;
      }
      return this.z > -this.FOCUS_POSITION && this.z < this.FAR_LIMIT && this.x < this.renderer.width * 1.5;
    }
  };
  jq_151(function(){
    RENDERER.init();
  });
</script>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <!--
    <div class="alice">
      <img src="/images/alice-shake.gif" alt="">
    </div>

    
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
    -->
  </div>
  <script
      defer="defer"
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"
      integrity="sha512-1dalHDkG9EtcOmCnoCjiwQ/HEB5SDNqw8d4G2MKoNwjiwMNeBAkudsBCmSlMnXdsH8Bm0mOd3tl/6nL5y0bMaQ=="
      crossorigin="anonymous"
    ></script>
  <script defer="defer" src="/js/gsap/DrawSVGPlugin.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomEase.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomBounce.min.js"></script>
  <script defer="defer" src="/js/gsap/SplitText.min.js"></script>
  <script defer="defer" src="/js/gsap/logo-run.js"></script>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">android binder源码分析
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2024-07-06 14:25:21">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2024-07-06T14:25:21+08:00">2024-07-06</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>85k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>1:18</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">oacia</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="/background_picture/1_mary.jpg"></li>
          <li class="item" data-background-image="/background_picture/2_xingye.webp"></li>
          <li class="item" data-background-image="/background_picture/3_xiaoxia.webp"></li>
          <li class="item" data-background-image="/background_picture/4_alice.webp"></li>
          <li class="item" data-background-image="/background_picture/5_mutsuki.jpg"></li>
          <li class="item" data-background-image="/background_picture/6_arona_plana.webp"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb">
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://oacia.dev/android-binder/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="oacia">
    <meta itemprop="description" content="DEVIL or SWEET, 月遇从云 花遇和风">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="oaciaのBbBlog~">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p>Binder 是 Android 独有的一种通信机制， <code>Activity</code> ， <code>Service</code> ， <code>Broadcast</code> ， <code>ContentProvider</code>  这四大组件所涉及的多进程间的通信底层都是依赖于 Binder IPC 机制。学好底层的通信原理对掌握安卓这幢大厦有着重要的意义.</p>
<h1 id="说明"><a class="anchor" href="#说明">#</a> 说明</h1>
<p>本文所研究的安卓内核版本为 <code>Linux version 4.9.270-g862f51bac900-ab7613625</code></p>
<p>安卓框架版本为 <code>android-12.0.0_r34</code></p>
<h1 id="binder简介"><a class="anchor" href="#binder简介">#</a> Binder 简介</h1>
<p>从进程角度来看 IPC (Inter Process Communication) 机制，每个 Android 的进程，只能运行在自己进程所拥有的虚拟地址空间。对于用户空间，不同进程之间彼此是不能共享的，而内核空间却是可共享的。Client 进程向 Server 进程通信，恰恰是利用进程间可共享的内核内存空间来完成底层通信工作的，Client 端与 Server 端进程往往采用 ioctl 等方法跟内核空间的驱动进行交互。</p>
<p><img data-src="/android-binder/binder_interprocess_communication.png" alt="binder_interprocess_communication" style="aspect-ratio:643 / 403;"></p>
<p>Binder 通信采用 C/S 架构，从组件视角来说，包含 Client、Server、ServiceManager 以及 binder 驱动，其中 ServiceManager 用于管理系统中的各种服务。架构图如下所示，图中的 Client,Server,Service Manager 之间交互都是虚线表示，是由于它们彼此之间不是直接交互的，而是都通过 Binder 驱动进行交互的，从而实现 IPC 通信方式。其中 Binder 驱动位于内核空间，Client,Server,Service Manager 位于用户空间。</p>
<p><img data-src="/android-binder/IPC-Binder.jpg" alt="ServiceManager" style="aspect-ratio:921 / 448;"></p>
<h1 id="binder设备的初始化过程"><a class="anchor" href="#binder设备的初始化过程">#</a> Binder 设备的初始化过程</h1>
<p>在 Linux 中，万物皆文件，那么毫无疑问，Binder 其实也是一个文件，它的初始化函数是 <code>binder_init</code> , 主要功能是注册 binder 设备</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//kernel\drivers\android\binder.c</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">binder_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">char</span> <span class="token operator">*</span>device_name<span class="token punctuation">,</span> <span class="token operator">*</span>device_names<span class="token punctuation">,</span> <span class="token operator">*</span>device_tmp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">binder_device</span> <span class="token operator">*</span>device<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">hlist_node</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token comment">// 初始化 lru 链表，该链表用于管理内存页；注册 shrinker 结构体</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	ret <span class="token operator">=</span> <span class="token function">binder_alloc_shrinker_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token comment">// 原子操作赋值</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_transaction_log<span class="token punctuation">.</span>cur<span class="token punctuation">,</span> <span class="token operator">~</span><span class="token number">0U</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_transaction_log_failed<span class="token punctuation">.</span>cur<span class="token punctuation">,</span> <span class="token operator">~</span><span class="token number">0U</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token comment">/**debug 相关的代码，之后 debug 相关的代码将不再出现 **/</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    </pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token comment">// 在 debugfs 文件系统创建了 binder 文件夹</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	binder_debugfs_dir_entry_root <span class="token operator">=</span> <span class="token function">debugfs_create_dir</span><span class="token punctuation">(</span><span class="token string">"binder"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token comment">// 如果 binder 文件夹创建成功，则在该文件夹内继续创建 binder/proc 文件夹</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>binder_debugfs_dir_entry_root<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>		binder_debugfs_dir_entry_proc <span class="token operator">=</span> <span class="token function">debugfs_create_dir</span><span class="token punctuation">(</span><span class="token string">"proc"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>						 binder_debugfs_dir_entry_root<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>binder_debugfs_dir_entry_root<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		<span class="token comment">// 继续在 binder 目录中创建 state,stats,transactions,transaction_log,failed_transaction_log 文件，读取 Binder 驱动程序的运行情况</span></pre></td></tr><tr><td data-num="29"></td><td><pre>		<span class="token function">debugfs_create_file</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>				    <span class="token number">0444</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>				    binder_debugfs_dir_entry_root<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>				    <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>				    <span class="token operator">&amp;</span>binder_state_fops<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>		<span class="token function">debugfs_create_file</span><span class="token punctuation">(</span><span class="token string">"stats"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>				    <span class="token number">0444</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>				    binder_debugfs_dir_entry_root<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>				    <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>				    <span class="token operator">&amp;</span>binder_stats_fops<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>		<span class="token function">debugfs_create_file</span><span class="token punctuation">(</span><span class="token string">"transactions"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>				    <span class="token number">0444</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>				    binder_debugfs_dir_entry_root<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>				    <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>				    <span class="token operator">&amp;</span>binder_transactions_fops<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>		<span class="token function">debugfs_create_file</span><span class="token punctuation">(</span><span class="token string">"transaction_log"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>				    <span class="token number">0444</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>				    binder_debugfs_dir_entry_root<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>				    <span class="token operator">&amp;</span>binder_transaction_log<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>				    <span class="token operator">&amp;</span>binder_transaction_log_fops<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>		<span class="token function">debugfs_create_file</span><span class="token punctuation">(</span><span class="token string">"failed_transaction_log"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>				    <span class="token number">0444</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>				    binder_debugfs_dir_entry_root<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>				    <span class="token operator">&amp;</span>binder_transaction_log_failed<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>				    <span class="token operator">&amp;</span>binder_transaction_log_fops<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="57"></td><td><pre>	 * Copy the module_parameter string, because we don't want to</pre></td></tr><tr><td data-num="58"></td><td><pre>	 * tokenize it in-place.</pre></td></tr><tr><td data-num="59"></td><td><pre>	 */</pre></td></tr><tr><td data-num="60"></td><td><pre>	<span class="token comment">// 在内核空间中分配内存，GFP_KERNEL 表示正常分配内存</span></pre></td></tr><tr><td data-num="61"></td><td><pre>	device_names <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>binder_devices_param<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>device_names<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>		ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>		<span class="token keyword">goto</span> err_alloc_device_names_failed<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>	<span class="token comment">// 将 binder,hwbinder,vndbinder 赋值给 device_names</span></pre></td></tr><tr><td data-num="67"></td><td><pre>	<span class="token function">strcpy</span><span class="token punctuation">(</span>device_names<span class="token punctuation">,</span> binder_devices_param<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>	device_tmp <span class="token operator">=</span> device_names<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>device_name <span class="token operator">=</span> <span class="token function">strsep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device_tmp<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>		<span class="token comment">// 以 "," 作为分隔符，注册 misc 设备 /dev/binder/dev/hwbinder/dev/vndbinder</span></pre></td></tr><tr><td data-num="72"></td><td><pre>		ret <span class="token operator">=</span> <span class="token function">init_binder_device</span><span class="token punctuation">(</span>device_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre>			<span class="token keyword">goto</span> err_init_binder_device_failed<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>	<span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>err_init_binder_device_failed<span class="token operator">:</span></pre></td></tr><tr><td data-num="80"></td><td><pre>	<span class="token function">hlist_for_each_entry_safe</span><span class="token punctuation">(</span>device<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>binder_devices<span class="token punctuation">,</span> hlist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>		<span class="token function">misc_deregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token operator">-></span>miscdev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>		<span class="token function">hlist_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token operator">-></span>hlist<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>		<span class="token function">kfree</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>	<span class="token function">kfree</span><span class="token punctuation">(</span>device_names<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>err_alloc_device_names_failed<span class="token operator">:</span></pre></td></tr><tr><td data-num="89"></td><td><pre>	<span class="token function">debugfs_remove_recursive</span><span class="token punctuation">(</span>binder_debugfs_dir_entry_root<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>	<span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 <code>binder_init</code>  中，调用了 <code>init_binder_device</code>  通过 <code>misc_register</code>  来注册 binder 设备</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//kernel\drivers\android\binder.c</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> binder_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token punctuation">.</span>poll <span class="token operator">=</span> binder_poll<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> binder_ioctl<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token punctuation">.</span>compat_ioctl <span class="token operator">=</span> binder_ioctl<span class="token punctuation">,</span><span class="token comment">//IO 控制函数</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">.</span>mmap <span class="token operator">=</span> binder_mmap<span class="token punctuation">,</span><span class="token comment">// 内存映射函数</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token punctuation">.</span>open <span class="token operator">=</span> binder_open<span class="token punctuation">,</span><span class="token comment">//binder 文件打开函数</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token punctuation">.</span>flush <span class="token operator">=</span> binder_flush<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token punctuation">.</span>release <span class="token operator">=</span> binder_release<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">init_binder_device</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">binder_device</span> <span class="token operator">*</span>binder_device<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>	binder_device <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>binder_device<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>binder_device<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>	binder_device<span class="token operator">-></span>miscdev<span class="token punctuation">.</span>fops <span class="token operator">=</span> <span class="token operator">&amp;</span>binder_fops<span class="token punctuation">;</span><span class="token comment">//// 设备的文件操作结构，这是 file_operations 结构</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	binder_device<span class="token operator">-></span>miscdev<span class="token punctuation">.</span>minor <span class="token operator">=</span> MISC_DYNAMIC_MINOR<span class="token punctuation">;</span><span class="token comment">// 次设备号 动态分配</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	binder_device<span class="token operator">-></span>miscdev<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token comment">//// 设备名</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>	<span class="token comment">// 设置 binder_context，用于记录 servicemanager 的 binder_node 信息，</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token comment">// 由于 binder_device 是全局唯一的，这是 servicemanager 可以成为守护进</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	<span class="token comment">// 程的关键。</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	binder_device<span class="token operator">-></span>context<span class="token punctuation">.</span>binder_context_mgr_uid <span class="token operator">=</span> INVALID_UID<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	binder_device<span class="token operator">-></span>context<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>	<span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_device<span class="token operator">-></span>context<span class="token punctuation">.</span>context_mgr_node_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token comment">// 注册 binder 设备</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	ret <span class="token operator">=</span> <span class="token function">misc_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_device<span class="token operator">-></span>miscdev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>		<span class="token function">kfree</span><span class="token punctuation">(</span>binder_device<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>		<span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>	<span class="token function">hlist_add_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_device<span class="token operator">-></span>hlist<span class="token punctuation">,</span> <span class="token operator">&amp;</span>binder_devices<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>	<span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="binder设备文件的打开过程"><a class="anchor" href="#binder设备文件的打开过程">#</a> Binder 设备文件的打开过程</h1>
<p>一个进程在使用 binder 进行通信之前，需要使用 open 函数来打开设备文件 /dev/binder, 在这个过程中， <code>binder_open</code>  函数就会被调用，这个函数的作用如下</p>
<ul>
<li>创建 <code>binder_proc</code>  对象</li>
<li>把当前进程等信息保存到 <code>binder_proc</code>  对象</li>
<li>把 <code>binder_proc</code>  对象保存到文件指针 <code>filp</code></li>
<li>把 <code>binder_proc</code>  加入到全局链表 <code>binder_procs</code> 。</li>
</ul>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//kernel\drivers\android\binder.c</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>nodp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">binder_device</span> <span class="token operator">*</span>binder_dev<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_OPEN_CLOSE<span class="token punctuation">,</span> <span class="token string">"%s: %d:%d\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		     current<span class="token operator">-></span>group_leader<span class="token operator">-></span>pid<span class="token punctuation">,</span> current<span class="token operator">-></span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token comment">// 创建 binder_proc 结构体遍历 proc，并为 proc 实现初始化</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	proc <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>proc<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>proc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>inner_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>outer_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>tmp_ref<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token function">get_task_struct</span><span class="token punctuation">(</span>current<span class="token operator">-></span>group_leader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	任何一个进程，如果只有主线程，那 pid 是自己，tgid 是自己，group_leader 指向的还是自己。</pre></td></tr><tr><td data-num="21"></td><td><pre>	但是，如果一个进程创建了其他线程，那就会有所变化了。线程有自己的 pid，tgid 就是进程的</pre></td></tr><tr><td data-num="22"></td><td><pre>	主线程的 pid，group_leader 指向的就是进程的主线程。</pre></td></tr><tr><td data-num="23"></td><td><pre>	有了 tgid 之后，我们就可以判断一个 task 是线程还是进程了。</pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>	pid : 每个 task 都有一个 pid，是唯一的，不管是进程还是线程。</pre></td></tr><tr><td data-num="26"></td><td><pre>	tgid: 指向主线程的 pid</pre></td></tr><tr><td data-num="27"></td><td><pre>	*/</pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token comment">//group_leader: 指向进程的主线程</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	proc<span class="token operator">-></span>tsk <span class="token operator">=</span> current<span class="token operator">-></span>group_leader<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>files_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>	<span class="token comment">// 初始化 todo 队列</span></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	<span class="token comment">// 初始化进程优先级</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_supported_policy</span><span class="token punctuation">(</span>current<span class="token operator">-></span>policy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>		proc<span class="token operator">-></span>default_priority<span class="token punctuation">.</span>sched_policy <span class="token operator">=</span> current<span class="token operator">-></span>policy<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>		proc<span class="token operator">-></span>default_priority<span class="token punctuation">.</span>prio <span class="token operator">=</span> current<span class="token operator">-></span>normal_prio<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>		proc<span class="token operator">-></span>default_priority<span class="token punctuation">.</span>sched_policy <span class="token operator">=</span> SCHED_NORMAL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>		proc<span class="token operator">-></span>default_priority<span class="token punctuation">.</span>prio <span class="token operator">=</span> <span class="token function">NICE_TO_PRIO</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>	<span class="token comment">// 初始化 binder_dev,proc->context,proc->alloc</span></pre></td></tr><tr><td data-num="45"></td><td><pre>	binder_dev <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>filp<span class="token operator">-></span>private_data<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_device</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>				  miscdev<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>	proc<span class="token operator">-></span>context <span class="token operator">=</span> <span class="token operator">&amp;</span>binder_dev<span class="token operator">-></span>context<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>	<span class="token function">binder_alloc_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>alloc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>	<span class="token comment">//binder_alloc 初始化</span></pre></td></tr><tr><td data-num="51"></td><td><pre>	<span class="token function">binder_stats_created</span><span class="token punctuation">(</span>BINDER_STAT_PROC<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>	proc<span class="token operator">-></span>pid <span class="token operator">=</span> current<span class="token operator">-></span>group_leader<span class="token operator">-></span>pid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>	<span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>delivered_death<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>	<span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>waiting_threads<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>	<span class="token comment">// 将初始化完成的 binder_proc 结构体 proc 保存到 filp->private_data 中</span></pre></td></tr><tr><td data-num="57"></td><td><pre>	<span class="token comment">//filp 指向一个打开的文件结构体，它和进程调用 open 函数打开设备文件</span></pre></td></tr><tr><td data-num="58"></td><td><pre>	<span class="token comment">///dev/binder 之后内核返回给进程的文件描述符是相互关联的</span></pre></td></tr><tr><td data-num="59"></td><td><pre>	filp<span class="token operator">-></span>private_data <span class="token operator">=</span> proc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>	<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_procs_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>	<span class="token comment">// 将 binder_proc 结构体 proc 加入到一个全局哈希队列 binder_procs 中</span></pre></td></tr><tr><td data-num="63"></td><td><pre>	<span class="token comment">//binder 通过遍历这个哈希队列就可以知道有多少进程在使用 binder</span></pre></td></tr><tr><td data-num="64"></td><td><pre>	<span class="token function">hlist_add_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>proc_node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>binder_procs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>	<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_procs_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="binder设备文件的内存映射过程"><a class="anchor" href="#binder设备文件的内存映射过程">#</a> Binder 设备文件的内存映射过程</h1>
<p>在打开了设备文件 /dev/binder 之后，还需要调用 <code>mmap</code>  函数来把这个设备文件映射到进程的地址空间，此时 binder 驱动程序中的 <code>binder_mmap</code>  函数就会被调用，主要功能：在内核虚拟地址空间，申请一块与用户虚拟内存相同大小的内存；然后再申请 1 个 page 大小的物理内存，再将同一块物理内存分别映射到内核虚拟地址空间和用户虚拟内存空间，从而实现了用户空间的 Buffer 和内核空间的 Buffer 同步操作的功能。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//kernel\drivers\android\binder.c</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_mmap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span>vma<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>failure_string<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token comment">// 保证请求分配内存的线程为主线程</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token operator">-></span>tsk <span class="token operator">!=</span> current<span class="token operator">-></span>group_leader<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token comment">// 保证映射内存 &lt;= 4MB, 说明 Binder 最多能为进程分配 4MB 的内核缓冲区来传输数据</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_end <span class="token operator">-</span> vma<span class="token operator">-></span>vm_start<span class="token punctuation">)</span> <span class="token operator">></span> SZ_4M<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		vma<span class="token operator">-></span>vm_end <span class="token operator">=</span> vma<span class="token operator">-></span>vm_start <span class="token operator">+</span> SZ_4M<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_OPEN_CLOSE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		     <span class="token string">"%s: %d %lx-%lx (%ld K) vma %lx pagep %lx\n"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		     <span class="token constant">__func__</span><span class="token punctuation">,</span> proc<span class="token operator">-></span>pid<span class="token punctuation">,</span> vma<span class="token operator">-></span>vm_start<span class="token punctuation">,</span> vma<span class="token operator">-></span>vm_end<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		     <span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_end <span class="token operator">-</span> vma<span class="token operator">-></span>vm_start<span class="token punctuation">)</span> <span class="token operator">/</span> SZ_1K<span class="token punctuation">,</span> vma<span class="token operator">-></span>vm_flags<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>		     <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">pgprot_val</span><span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_page_prot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token comment">//#define FORBIDDEN_MMAP_FLAGS (VM_WRITE)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token comment">// 检查进程要映射的地址空间是否可写</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>vma<span class="token operator">-></span>vm_flags <span class="token operator">&amp;</span> FORBIDDEN_MMAP_FLAGS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>		ret <span class="token operator">=</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>		failure_string <span class="token operator">=</span> <span class="token string">"bad vm_flags"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>		<span class="token keyword">goto</span> err_bad_arg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>	<span class="token comment">//VM_DONTCOPY	/* Do not copy this vma on fork */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token comment">//VM_MIXEDMAP	/* Can contain "struct page" and pure PFN pages */</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	<span class="token comment">// 禁止拷贝</span></pre></td></tr><tr><td data-num="33"></td><td><pre>	vma<span class="token operator">-></span>vm_flags <span class="token operator">|=</span> VM_DONTCOPY <span class="token operator">|</span> VM_MIXEDMAP<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token comment">// 为该内存赋予 r-x 权限</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	vma<span class="token operator">-></span>vm_flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>VM_MAYWRITE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>	vma<span class="token operator">-></span>vm_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>binder_vm_ops<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>	vma<span class="token operator">-></span>vm_private_data <span class="token operator">=</span> proc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>	<span class="token comment">// 为进程分配内核缓冲区，并将这块物理内存分别映射到内核虚拟地址空间和用户虚拟内存空间</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	ret <span class="token operator">=</span> <span class="token function">binder_alloc_mmap_handler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>alloc<span class="token punctuation">,</span> vma<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>		<span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>	<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>files_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>	proc<span class="token operator">-></span>files <span class="token operator">=</span> <span class="token function">get_files_struct</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>	<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>files_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>err_bad_arg<span class="token operator">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>	<span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"%s: %d %lx-%lx %s failed %d\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>	       proc<span class="token operator">-></span>pid<span class="token punctuation">,</span> vma<span class="token operator">-></span>vm_start<span class="token punctuation">,</span> vma<span class="token operator">-></span>vm_end<span class="token punctuation">,</span> failure_string<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>	<span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Binder 驱动程序为进程分配的内核缓冲区即为一系列物理页面，他们分别被映射到进程的用户地址空间和内核地址空间。当 Binder 驱动程序需要将一块数据传输给一个进程时，它可以先把这块数据保存在为该进程分配所分配的一块内核缓冲区中，然后再把这块内核缓冲区的用户空间地址告诉进程，最后进程就可以访问到里面的数据了。这样做的好处是不需要将内核空间拷贝到用户空间，从而提高了数据传输的效率.</p>
<p><img data-src="/android-binder/binder_physical_memory.jpg" alt="binder_physical_memory" style="aspect-ratio:669 / 628;"></p>
<h1 id="binder设备文件的ioctl"><a class="anchor" href="#binder设备文件的ioctl">#</a> binder 设备文件的 ioctl</h1>
<p><code>binder_ioctl</code>  函数负责在两个进程间收发 IPC 数据和 IPC reply 数据。</p>
<blockquote>
<p>ioctl (input/output control) 是一个专用于设备输入输出操作的系统调用，该调用传入一个跟设备有关的请求码，系统调用的功能完全取决于请求码。</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">ioctl 命令</th>
<th style="text-align:left">数据类型</th>
<th style="text-align:left">操作</th>
<th>使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>BINDER_WRITE_READ</strong></td>
<td style="text-align:left">struct binder_write_read</td>
<td style="text-align:left">收发 Binder IPC 数据</td>
<td>Binder 读写交互场景，IPC.talkWithDriver</td>
</tr>
<tr>
<td style="text-align:left">BINDER_SET_IDLE_TIMEOUT</td>
<td style="text-align:left">__s64</td>
<td style="text-align:left"></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BINDER_SET_MAX_THREADS</td>
<td style="text-align:left">__u32</td>
<td style="text-align:left">设置 Binder 线程最大个数</td>
<td>初始化 ProcessState 对象，open_driver () ; 主动调整参数，ProcessState.setThreadPoolMaxThreadCount ()</td>
</tr>
<tr>
<td style="text-align:left">BINDER_SET_IDLE_PRIORITY</td>
<td style="text-align:left">__s32</td>
<td style="text-align:left"></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BINDER_SET_CONTEXT_MGR</td>
<td style="text-align:left">__s32</td>
<td style="text-align:left">设置 Service Manager 节点</td>
<td>servicemanager 进程成为上下文管理者，binder_become_context_manager ()</td>
</tr>
<tr>
<td style="text-align:left">BINDER_THREAD_EXIT</td>
<td style="text-align:left">__s32</td>
<td style="text-align:left">释放 Binder 线程</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BINDER_VERSION</td>
<td style="text-align:left">struct binder_version</td>
<td style="text-align:left">获取 Binder 版本信息</td>
<td>初始化 ProcessState 对象，open_driver ()</td>
</tr>
<tr>
<td style="text-align:left">BINDER_GET_NODE_DEBUG_INFO</td>
<td style="text-align:left">struct binder_node_debug_info</td>
<td style="text-align:left"></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BINDER_GET_NODE_INFO_FOR_REF</td>
<td style="text-align:left">struct binder_node_info_for_ref</td>
<td style="text-align:left"></td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BINDER_SET_CONTEXT_MGR_EXT</td>
<td style="text-align:left">struct flat_binder_object</td>
<td style="text-align:left"></td>
<td></td>
</tr>
</tbody>
</table>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//kernel\drivers\android\binder.c</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">binder_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc <span class="token operator">=</span> filp<span class="token operator">-></span>private_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token keyword">void</span> __user <span class="token operator">*</span>ubuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token comment">/*pr_info("binder_ioctl: %d:%d %x %lx\n",</span></pre></td></tr><tr><td data-num="11"></td><td><pre>			proc->pid, current->pid, cmd, arg);*/</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token function">binder_selftest_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proc<span class="token operator">-></span>alloc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token function">trace_binder_ioctl</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>	ret <span class="token operator">=</span> <span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>binder_user_error_wait<span class="token punctuation">,</span> binder_stop_on_user_error <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token keyword">goto</span> err_unlocked<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>	thread <span class="token operator">=</span> <span class="token function">binder_get_thread</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>		<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>	<span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	<span class="token comment">// 进行 binder 的读写操作，这个命令使用的最为频繁</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token keyword">case</span> BINDER_WRITE_READ<span class="token operator">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>		ret <span class="token operator">=</span> <span class="token function">binder_ioctl_write_read</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>		<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token comment">// 设置 binder 最大支持的线程数</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	<span class="token keyword">case</span> BINDER_SET_MAX_THREADS<span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>		<span class="token keyword">int</span> max_threads<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>max_threads<span class="token punctuation">,</span> ubuf<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>				   <span class="token keyword">sizeof</span><span class="token punctuation">(</span>max_threads<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>			ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>		<span class="token function">binder_inner_proc_lock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>		proc<span class="token operator">-></span>max_threads <span class="token operator">=</span> max_threads<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>		<span class="token function">binder_inner_proc_unlock</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>		<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>	<span class="token keyword">case</span> BINDER_SET_CONTEXT_MGR_EXT<span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>		<span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> fbo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fbo<span class="token punctuation">,</span> ubuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>fbo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>			ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>		ret <span class="token operator">=</span> <span class="token function">binder_ioctl_set_ctx_mgr</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fbo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>		<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token comment">// 成为 binder 的上下文管理者，也就是 ServiceManager 成为守护进程</span></pre></td></tr><tr><td data-num="61"></td><td><pre>	<span class="token keyword">case</span> BINDER_SET_CONTEXT_MGR<span class="token operator">:</span></pre></td></tr><tr><td data-num="62"></td><td><pre>		ret <span class="token operator">=</span> <span class="token function">binder_ioctl_set_ctx_mgr</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>		<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>	<span class="token comment">// 当 binder 线程退出，释放 binder 线程</span></pre></td></tr><tr><td data-num="67"></td><td><pre>	<span class="token keyword">case</span> BINDER_THREAD_EXIT<span class="token operator">:</span></pre></td></tr><tr><td data-num="68"></td><td><pre>		<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_THREADS<span class="token punctuation">,</span> <span class="token string">"%d:%d exit\n"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>			     proc<span class="token operator">-></span>pid<span class="token punctuation">,</span> thread<span class="token operator">-></span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>		<span class="token function">binder_thread_release</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>		thread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>		<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>	<span class="token comment">// 获取 binder 的版本号</span></pre></td></tr><tr><td data-num="74"></td><td><pre>	<span class="token keyword">case</span> BINDER_VERSION<span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>		<span class="token keyword">struct</span> <span class="token class-name">binder_version</span> __user <span class="token operator">*</span>ver <span class="token operator">=</span> ubuf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_version</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>			ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">put_user</span><span class="token punctuation">(</span>BINDER_CURRENT_PROTOCOL_VERSION<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="82"></td><td><pre>			     <span class="token operator">&amp;</span>ver<span class="token operator">-></span>protocol_version<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>			ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>		<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>	<span class="token keyword">case</span> BINDER_GET_NODE_INFO_FOR_REF<span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>		<span class="token keyword">struct</span> <span class="token class-name">binder_node_info_for_ref</span> info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">,</span> ubuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>			ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="95"></td><td><pre></pre></td></tr><tr><td data-num="96"></td><td><pre>		ret <span class="token operator">=</span> <span class="token function">binder_ioctl_get_node_info_for_ref</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="98"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>			ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="104"></td><td><pre></pre></td></tr><tr><td data-num="105"></td><td><pre>		<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>	<span class="token keyword">case</span> BINDER_GET_NODE_DEBUG_INFO<span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>		<span class="token keyword">struct</span> <span class="token class-name">binder_node_debug_info</span> info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre></pre></td></tr><tr><td data-num="110"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">,</span> ubuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>			ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="114"></td><td><pre></pre></td></tr><tr><td data-num="115"></td><td><pre>		ret <span class="token operator">=</span> <span class="token function">binder_ioctl_get_node_debug_info</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="117"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre></pre></td></tr><tr><td data-num="119"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>ubuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>			ret <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>			<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>		<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>	<span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="126"></td><td><pre>		ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>		<span class="token keyword">goto</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>	ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>err<span class="token operator">:</span></pre></td></tr><tr><td data-num="131"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>thread<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="132"></td><td><pre>		thread<span class="token operator">-></span>looper_need_return <span class="token operator">=</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>	<span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>binder_user_error_wait<span class="token punctuation">,</span> binder_stop_on_user_error <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> ret <span class="token operator">!=</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="135"></td><td><pre>		<span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"%d:%d ioctl %x %lx returned %d\n"</span><span class="token punctuation">,</span> proc<span class="token operator">-></span>pid<span class="token punctuation">,</span> current<span class="token operator">-></span>pid<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>err_unlocked<span class="token operator">:</span></pre></td></tr><tr><td data-num="137"></td><td><pre>	<span class="token function">trace_binder_ioctl_done</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>	<span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="binder内部通信协议"><a class="anchor" href="#binder内部通信协议">#</a> Binder 内部通信协议</h1>
<p>Client 进程通过 RPC (Remote Procedure Call Protocol) 与 Server 通信，可以简单地划分为三层，应用层、IPC 层、内核驱动层。 <code>demo()</code>  是 Client 端和 Server 共同协商好的统一方法；handle、RPC 数据、代码、协议这 4 项组成了 IPC 层的数据，通过 IPC 层进行数据传输；而真正在 Client 和 Server 两端建立通信的基础设施便是 Binder Driver。</p>
<p><img data-src="/android-binder/binder_ipc.jpg" alt="binder_ipc" style="aspect-ratio:793 / 444;"></p>
<h2 id="通信模型"><a class="anchor" href="#通信模型">#</a> 通信模型</h2>
<p>一次完整的 Binder 通信过程如下</p>
<p><img data-src="/android-binder/binder_transaction_ipc.jpg" alt="binder_protocol" style="aspect-ratio:955 / 694;"></p>
<p>Binder 协议包含在 IPC 数据中，分为两类:</p>
<ul>
<li>
<p><code>BINDER_COMMAND_PROTOCOL</code> ：binder 请求码，以”BC_“开头，简称 BC 码，用于从 IPC 层传递到 Binder Driver 层；</p>
</li>
<li>
<p><code>BINDER_RETURN_PROTOCOL</code>  ：binder 响应码，以”BR_“开头，简称 BR 码，用于从 Binder Driver 层传递到 IPC 层；</p>
</li>
</ul>
<p>Binder IPC 通信至少是两个进程的交互：</p>
<ul>
<li>client 进程执行 binder_thread_write，根据 BC_XXX 命令，生成相应的 binder_work；</li>
<li>server 进程执行 binder_thread_read，根据 binder_work.type 类型，生成 BR_XXX，发送到用户空间处理。</li>
</ul>
<h2 id="通信过程"><a class="anchor" href="#通信过程">#</a> 通信过程</h2>
<p>一次 Client 向 Server 通信的过程如图所示</p>
<p><img data-src="/android-binder/binder_protocol.jpg" alt="binder_protocol" style="aspect-ratio:1269 / 500;"></p>
<h3 id="bc_protocol"><a class="anchor" href="#bc_protocol">#</a> BC_PROTOCOL</h3>
<p>binder 请求码，是用 <code>enum binder_driver_command_protocol</code>  来定义的，是用于应用程序向 binder 驱动设备发送请求消息</p>
<table>
<thead>
<tr>
<th style="text-align:left">请求码</th>
<th style="text-align:left">参数类型</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">BC_TRANSACTION</td>
<td style="text-align:left">binder_transaction_data</td>
<td style="text-align:left">Client 向 Binder 驱动发送请求数据</td>
</tr>
<tr>
<td style="text-align:left">BC_REPLY</td>
<td style="text-align:left">binder_transaction_data</td>
<td style="text-align:left">Server 向 Binder 驱动发送请求数据</td>
</tr>
<tr>
<td style="text-align:left">BC_FREE_BUFFER</td>
<td style="text-align:left">binder_uintptr_t (指针)</td>
<td style="text-align:left">释放内存</td>
</tr>
<tr>
<td style="text-align:left">BC_INCREFS</td>
<td style="text-align:left">__u32(descriptor)</td>
<td style="text-align:left">binder_ref 弱引用加 1 操作</td>
</tr>
<tr>
<td style="text-align:left">BC_DECREFS</td>
<td style="text-align:left">__u32(descriptor)</td>
<td style="text-align:left">binder_ref 弱引用减 1 操作</td>
</tr>
<tr>
<td style="text-align:left">BC_ACQUIRE</td>
<td style="text-align:left">__u32(descriptor)</td>
<td style="text-align:left">binder_ref 强引用加 1 操作</td>
</tr>
<tr>
<td style="text-align:left">BC_RELEASE</td>
<td style="text-align:left">__u32(descriptor)</td>
<td style="text-align:left">binder_ref 强引用减 1 操作</td>
</tr>
<tr>
<td style="text-align:left">BC_ACQUIRE_DONE</td>
<td style="text-align:left">binder_ptr_cookie</td>
<td style="text-align:left">binder_node 强引用减 1 操作</td>
</tr>
<tr>
<td style="text-align:left">BC_INCREFS_DONE</td>
<td style="text-align:left">binder_ptr_cookie</td>
<td style="text-align:left">binder_node 弱引用减 1 操作</td>
</tr>
<tr>
<td style="text-align:left">BC_REGISTER_LOOPER</td>
<td style="text-align:left">无参数</td>
<td style="text-align:left">创建新的 looper 线程</td>
</tr>
<tr>
<td style="text-align:left">BC_ENTER_LOOPER</td>
<td style="text-align:left">无参数</td>
<td style="text-align:left">应用线程进入 looper</td>
</tr>
<tr>
<td style="text-align:left">BC_EXIT_LOOPER</td>
<td style="text-align:left">无参数</td>
<td style="text-align:left">应用线程退出 looper</td>
</tr>
<tr>
<td style="text-align:left">BC_REQUEST_DEATH_NOTIFICATION</td>
<td style="text-align:left">binder_handle_cookie</td>
<td style="text-align:left">注册死亡通知</td>
</tr>
<tr>
<td style="text-align:left">BC_CLEAR_DEATH_NOTIFICATION</td>
<td style="text-align:left">binder_handle_cookie</td>
<td style="text-align:left">取消注册的死亡通知</td>
</tr>
<tr>
<td style="text-align:left">BC_DEAD_BINDER_DONE</td>
<td style="text-align:left">binder_uintptr_t (指针)</td>
<td style="text-align:left">已完成 binder 的死亡通知</td>
</tr>
<tr>
<td style="text-align:left">BC_ACQUIRE_RESULT</td>
<td style="text-align:left">-</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">BC_ATTEMPT_ACQUIRE</td>
<td style="text-align:left">-</td>
<td style="text-align:left">-</td>
</tr>
</tbody>
</table>
<ul>
<li>当一个进程请求另外一个进程执行一个操作时，源进程就使用 <code>BC_TRANSACTION</code>  来请求 Binder 驱动进程将通信数据传递到目标进程</li>
<li>当目标进程处理完成源进程所请求的操作之后，它就使用 <code>BC_REPLY</code>  来请求 Binder 驱动进程将结果数据传递给源进程</li>
<li><code>BC_FREE_BUFFER</code>  后面跟的通信数据是一个整数，它指向了在 Binder 驱动进程内部所分配的一块内核缓冲区.Binder 驱动程序就是通过这个内核缓冲区将源进程的通信数据传递到目标进程的。当目标进程处理完成源进程的通信请求之后，它会使用 <code>BC_FREE_BUFFER</code>  来通知 Binder 驱动程序释放这个内核缓冲区</li>
<li>当一个线程将自己注册到 Binder 驱动程序之后，它会使用 <code>BC_ENTER_LOOPER</code>  来通知 Binder 驱动程序，它已经准备就绪处理进程间通信请求了</li>
<li>当 Binder 驱动程序主动请求进程注册一个新的线程到它的 Binder 线程池中来处理进程间通信请求之后，新创建的线程就会使用 <code>BC_REGISTER_LOOPER</code>  来通知 Binder 驱动程序，它准备就绪了</li>
<li>当一个线程要退出时，它使用 <code>BC_EXIT_LOOPER</code>  从 Binder 驱动程序中注销，这样他就不会再接收到进程间通信请求了</li>
<li>如果一个进程希望获得它所引用的 Service 组件的死亡接收通知，那么它需要使用 <code>BC_REQUEST_DEATH_NOTIFICATION</code>  来向 Binder 驱动程序注册一个死亡接收通知</li>
<li>如果一个进程希望注销之前所注册的一个死亡接收通知，那么它需要使用 <code>BC_CLEAR_DEATH_NOTIFICATION</code>  来向 Binder 驱动程序发出请求</li>
<li>当一个进程获得一个 Service 组件的死亡通知时，它会使用 <code>BC_DEAD_BINDER_DONE</code>  来通知 Binder 驱动程序，它已经处理完成该 Service 组件的死亡通知了</li>
</ul>
<h3 id="binder_work"><a class="anchor" href="#binder_work">#</a> binder_work</h3>
<p>结构体 <code>binder_work</code>  用来描述待处理的工作项， <code>binder_work.entry</code>  用来将结构体嵌入到一个宿主结构中，通过 <code>binder_work.type</code>  的取值，Binder 就可以判断出一个 <code>binder_work</code>  结构体嵌入到什么类型的宿主结构中</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">binder_work</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> entry<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">enum</span> <span class="token class-name">binder_work_type</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		BINDER_WORK_TRANSACTION <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token comment">// 最常见</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		BINDER_WORK_TRANSACTION_COMPLETE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		BINDER_WORK_RETURN_ERROR<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		BINDER_WORK_NODE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		BINDER_WORK_DEAD_BINDER<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		BINDER_WORK_DEAD_BINDER_AND_CLEAR<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		BINDER_WORK_CLEAR_DEATH_NOTIFICATION<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token punctuation">&#125;</span> type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><table>
<thead>
<tr>
<th>binder_work 类型</th>
<th>触发时机</th>
</tr>
</thead>
<tbody>
<tr>
<td>BINDER_WORK_TRANSACTION</td>
<td><code>binder_transaction()</code> ; <code>binder_release_work()</code>  被调用</td>
</tr>
<tr>
<td>BINDER_WORK_TRANSACTION_COMPLETE</td>
<td><code>binder_transaction()</code> ; <code>binder_release_work()</code>  被调用</td>
</tr>
<tr>
<td>BINDER_WORK_NODE</td>
<td><code>binder_new_node()</code>  被调用</td>
</tr>
<tr>
<td>BINDER_WORK_DEAD_BINDER</td>
<td><code>binder_thread_write()</code>  收到 <code>BC_REQUEST_DEATH_NOTIFICATION</code></td>
</tr>
<tr>
<td>BINDER_WORK_DEAD_BINDER_AND_CLEAR</td>
<td><code>binder_thread_write()</code>  收到 <code>BC_CLEAR_DEATH_NOTIFICATION</code></td>
</tr>
<tr>
<td>BINDER_WORK_CLEAR_DEATH_NOTIFICATION</td>
<td><code>binder_thread_write()</code>  收到 <code>BC_CLEAR_DEATH_NOTIFICATION</code>  和 <code>BC_DEAD_BINDER_DONE</code></td>
</tr>
</tbody>
</table>
<h3 id="br_protocol"><a class="anchor" href="#br_protocol">#</a> BR_PROTOCOL</h3>
<p>binder 响应码，是用 <code>enum binder_driver_return_protocol</code>  来定义的，是 binder 设备向应用程序回复的消息</p>
<table>
<thead>
<tr>
<th style="text-align:left">响应码</th>
<th style="text-align:left">参数类型</th>
<th style="text-align:left">作用</th>
<th>触发时机</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">BR_ERROR</td>
<td style="text-align:left">__s32</td>
<td style="text-align:left">操作发生错误</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BR_OK</td>
<td style="text-align:left">无参数</td>
<td style="text-align:left">操作完成</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BR_NOOP</td>
<td style="text-align:left">无参数</td>
<td style="text-align:left">不做任何事</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BR_SPAWN_LOOPER</td>
<td style="text-align:left">无参数</td>
<td style="text-align:left">创建新的 Looper 线程</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BR_TRANSACTION</td>
<td style="text-align:left">binder_transaction_data</td>
<td style="text-align:left">Binder 驱动向 Server 端发送请求数据</td>
<td>收到 BINDER_WORK_TRANSACTION</td>
</tr>
<tr>
<td style="text-align:left">BR_REPLY</td>
<td style="text-align:left">binder_transaction_data</td>
<td style="text-align:left">Binder 驱动向 Client 端发送回复数据</td>
<td>收到 BINDER_WORK_TRANSACTION</td>
</tr>
<tr>
<td style="text-align:left">BR_TRANSACTION_COMPLETE</td>
<td style="text-align:left">无参数</td>
<td style="text-align:left">对请求发送的成功反馈</td>
<td>收到 BINDER_WORK_TRANSACTION_COMPLETE</td>
</tr>
<tr>
<td style="text-align:left">BR_DEAD_REPLY</td>
<td style="text-align:left">无参数</td>
<td style="text-align:left">回复失败，往往是线程或节点为空</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BR_FAILED_REPLY</td>
<td style="text-align:left">无参数</td>
<td style="text-align:left">回复失败，往往是 transaction 出错导致</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BR_INCREFS</td>
<td style="text-align:left">binder_ptr_cookie</td>
<td style="text-align:left">binder_ref 弱引用加 1 操作（Server 端）</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BR_DECREFS</td>
<td style="text-align:left">binder_ptr_cookie</td>
<td style="text-align:left">binder_ref 弱引用减 1 操作（Server 端）</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BR_ACQUIRE</td>
<td style="text-align:left">binder_ptr_cookie</td>
<td style="text-align:left">binder_ref 强引用加 1 操作（Server 端）</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BR_RELEASE</td>
<td style="text-align:left">binder_ptr_cookie</td>
<td style="text-align:left">binder_ref 强引用减 1 操作（Server 端）</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BR_DEAD_BINDER</td>
<td style="text-align:left">binder_uintptr_t (指针)</td>
<td style="text-align:left">Binder 驱动向 client 端发送死亡通知</td>
<td>收到 BINDER_WORK_DEAD_BINDER 或 BINDER_WORK_DEAD_BINDER_AND_CLEAR</td>
</tr>
<tr>
<td style="text-align:left">BR_CLEAR_DEATH_NOTIFICATION_DONE</td>
<td style="text-align:left">binder_uintptr_t (指针)</td>
<td style="text-align:left">BC_CLEAR_DEATH_NOTIFICATION 命令对应的响应码</td>
<td>收到 BINDER_WORK_CLEAR_DEATH_NOTIFICATION</td>
</tr>
<tr>
<td style="text-align:left">BR_ACQUIRE_RESULT</td>
<td style="text-align:left">-</td>
<td style="text-align:left">-</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BR_ATTEMPT_ACQUIRE</td>
<td style="text-align:left">-</td>
<td style="text-align:left">-</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">BR_FINISHED</td>
<td style="text-align:left">-</td>
<td style="text-align:left">-</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="协议转换图"><a class="anchor" href="#协议转换图">#</a> 协议转换图</h3>
<blockquote>
<p>BINDER_WORK_xxx –&gt; BW_xxx</p>
</blockquote>
<p>图解：(以 BC_TRANSACTION 为例)</p>
<ul>
<li>发起端进程：binder_transaction () 过程将 BC_TRANSACTION 转换为 BW_TRANSACTION；</li>
<li>接收端进程：binder_thread_read () 过程，将 BW_TRANSACTION 转换为 BR_TRANSACTION;</li>
<li>接收端进程：IPC.executeCommand () 过程，处理 BR_TRANSACTION 命令。</li>
</ul>
<p><img data-src="/android-binder/protocol_transaction.jpg" alt="protocol_transaction.jpg" style="aspect-ratio:1062 / 550;"></p>
<p><img data-src="/android-binder/protocol_binder_dead.jpg" alt="protocol_binder_dead.jpg" style="aspect-ratio:1087 / 538;"></p>
<h1 id="servicemanager介绍"><a class="anchor" href="#servicemanager介绍">#</a> ServiceManager 介绍</h1>
<p>我们知道在 Android 系统中，各个进程之间都是隔离的，假如 Clinet 想和 Server 通信，那么该如何找到 Server 呢？这就需要依靠 ServiceManager 了</p>
<p>ServiceManager 是 Android 进程间通信机制 Binder 的守护进程，它扮演着 Binder 进程间通信机制上下文管理者 (context Manager) 的角色，同时负责管理系统中的 Service 组件，向 Client 组件提供获取 Service 代理对象的服务</p>
<p><img data-src="/android-binder/IPC-Binder.jpg" alt="ServiceManager" style="aspect-ratio:921 / 448;"></p>
<p>我们可以将 binder 跨进程通信和 socket 网络通信类比，在网络通信中，客户端并不知道服务器的 IP 地址，但是知道服务器的域名，现在客户端想要和服务器建立 socket 连接，那么通信的第一步就是通过 DNS 服务器将域名解析为 IP 地址然后层层路由，这样客户端就可以和服务器建立网络连接了。binder 跨进程通信也不例外，ServiceManager 就相当于是 socket 网络通信中的 DNS 服务器，倘若 Server 希望有人能够和它通信，那么 Server 就先前往 Service Manager 那里 “备案” 一下（<strong>1. 注册服务</strong>），过了不久，Client 想要和 Server 去通信了，它就去询问 Service Manager：“Server 在什么地方呀，我要怎么和它通信呀”（<strong>2. 获取服务</strong>），然后 Service Manager 就告诉 Client 通信的方法，这样 Clinet 和 Server 就可以愉快的通信了～（<strong>3. 使用服务</strong>）</p>
<h1 id="servicemanager的启动过程"><a class="anchor" href="#servicemanager的启动过程">#</a> ServiceManager 的启动过程</h1>
<p>ServiceManager 是由 init 进程通过解析 init.rc 文件创建的</p>
<pre><code class="language-rc"># platform\system\core\rootdir\init.rc
on init
	...
	# Start essential services.
    start servicemanager
</code></pre>
<p>具体的服务声明在 <code>platform\frameworks\native\cmds\servicemanager\servicemanager.rc</code></p>
<pre><code class="language-rc"># platform\frameworks\native\cmds\servicemanager\servicemanager.rc
service servicemanager /system/bin/servicemanager
    class core animation# 指定了服务的类别为core和animation
    user system# 指定了服务用户为system,表示该服务将以系统用户的权限来运行
    group system readproc# 指定了服务的用户组为system,并具有 readproc 权限
    critical# 标志该服务为关键服务，这表示它是系统启动的一部分，必须优先启动

    # 要求在servicemanager重新启动时重启
    # apexd服务, audioserver服务, gatekeeperd服务
    # main类别的服务, hal类别的服务, early_hal类别的服务
    onrestart restart apexd
    onrestart restart audioserver
    onrestart restart gatekeeperd
    onrestart class_restart main
    onrestart class_restart hal
    onrestart class_restart early_hal

    # 将 servicemanager 的进程 ID 写入
    # /dev/cpuset/system-background/tasks文件，这可用于CPU集合管理
    writepid /dev/cpuset/system-background/tasks

    # 声明该服务为关键服务，在系统关闭时，这个服务将被优先关闭
    shutdown critical
</code></pre>
<p><code>Service Manager</code>  的入口函数是 <code>main.cpp</code>  中的 <code>main()</code> , 它的启动过程由以下四个步骤组成</p>
<ol>
<li>调用 <code>ProcessState::initWithDriver</code>  打开并映射 binder 驱动设备</li>
<li>将自身作为服务 (服务名称: <code>manager</code> ) 注册到 ServiceManager 中</li>
<li>调用 <code>ps-&gt;becomeContextManager();</code>  成为 binder 进程间通信机制的上下文管理者</li>
<li>使用 <code>looper</code>  无限循环阻塞处理事件</li>
</ol>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\cmds\servicemanager\main.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"usage: "</span> <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" [binder driver]"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">// 指定 driver 的名称，如果无参数，则使用默认驱动 /dev/binder</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> driver <span class="token operator">=</span> argc <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">?</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">"/dev/binder"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	每一个进程只能有一个 ProcessState 对象，service manager 通过 initWithDriver 方法</pre></td></tr><tr><td data-num="12"></td><td><pre>	实例化了一个 ProcessState 对象，并打开 binder 设备和进行 mmap 内存映射，这个过程中</pre></td></tr><tr><td data-num="13"></td><td><pre>	将会同时调用 binder 设备内部的函数 binder_open 和 binder_mmap</pre></td></tr><tr><td data-num="14"></td><td><pre>	*/</pre></td></tr><tr><td data-num="15"></td><td><pre>    sp<span class="token operator">&lt;</span>ProcessState<span class="token operator">></span> ps <span class="token operator">=</span> <span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">initWithDriver</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token comment">// 设置可以同时存在的线程池的最大数量为 0, 即此时只能有 ServiceManager 这一个线程存在</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    ps<span class="token operator">-></span><span class="token function">setThreadPoolMaxThreadCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token comment">// 在阻塞调用时中止进程</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token comment">//FATAL_IF_NOT_ONEWAY: ServiceManager 发起的 Binder 调用必须是单向，否则打印堆栈日志提示</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    ps<span class="token operator">-></span><span class="token function">setCallRestriction</span><span class="token punctuation">(</span>ProcessState<span class="token double-colon punctuation">::</span>CallRestriction<span class="token double-colon punctuation">::</span>FATAL_IF_NOT_ONEWAY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token comment">// 实例化 ServiceManager, 初始化参数为 Access 对象的智能指针</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    sp<span class="token operator">&lt;</span>ServiceManager<span class="token operator">></span> manager <span class="token operator">=</span> <span class="token class-name">sp</span><span class="token operator">&lt;</span>ServiceManager<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">make</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>Access<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token comment">//self register servicemanager,"manager" 将作为 servicemanager 的第一个服务被注册</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>manager<span class="token operator">-></span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token string">"manager"</span><span class="token punctuation">,</span> manager<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*allowIsolated*/</span><span class="token punctuation">,</span> IServiceManager<span class="token double-colon punctuation">::</span>DUMP_FLAG_PRIORITY_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not self register servicemanager"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token comment">// 将 "manager" 服务作为服务端 Bbinder 对象</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">setTheContextObject</span><span class="token punctuation">(</span>manager<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token comment">// 向 binder 驱动发送 ioctl BINDER_SET_CONTEXT_MGR_EXT 信号，将 servicemanager</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	<span class="token comment">// 在 ProcessState::initWithDriver 中打开驱动设备 /dev/driver 所返回的文件描述符句柄</span></pre></td></tr><tr><td data-num="33"></td><td><pre>	<span class="token comment">// 作为整个 binder IPC 通信中的上下文管理者</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    ps<span class="token operator">-></span><span class="token function">becomeContextManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token comment">// 准备 looper</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    sp<span class="token operator">&lt;</span>Looper<span class="token operator">></span> looper <span class="token operator">=</span> <span class="token class-name">Looper</span><span class="token double-colon punctuation">::</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment">/*allowNonCallbacks*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>	<span class="token comment">// 监听 BC_ENTER_LOOPER 信号，收到该信号后回调处理 binder 调用</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token class-name">BinderCallback</span><span class="token double-colon punctuation">::</span><span class="token function">setupTo</span><span class="token punctuation">(</span>looper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token comment">// 监听客户端回调</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token class-name">ClientCallbackCallback</span><span class="token double-colon punctuation">::</span><span class="token function">setupTo</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> manager<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>	<span class="token comment">// 阻塞等待和处理事件</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        looper<span class="token operator">-></span><span class="token function">pollAll</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token comment">// should not be reached</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">return</span> EXIT_FAILURE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="processstateinit"><a class="anchor" href="#processstateinit">#</a> ProcessState::init</h2>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\ProcessState.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>sp<span class="token operator">&lt;</span>ProcessState<span class="token operator">></span> <span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">init</span><span class="token punctuation">(</span>kDefaultDriver<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*requireDefault*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>sp<span class="token operator">&lt;</span>ProcessState<span class="token operator">></span> <span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">initWithDriver</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> driver<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">init</span><span class="token punctuation">(</span>driver<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/*requireDefault*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>sp<span class="token operator">&lt;</span>ProcessState<span class="token operator">></span> <span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>driver<span class="token punctuation">,</span> <span class="token keyword">bool</span> requireDefault<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">[</span><span class="token punctuation">[</span>clang<span class="token double-colon punctuation">::</span>no_destroy<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">static</span> sp<span class="token operator">&lt;</span>ProcessState<span class="token operator">></span> gProcess<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">[</span><span class="token punctuation">[</span>clang<span class="token double-colon punctuation">::</span>no_destroy<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>mutex gProcessMutex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>driver <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">l</span><span class="token punctuation">(</span>gProcessMutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> gProcess<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token comment">/*</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	这里使用了单例模式的设计思想，通过 std::once_flag 和 std::call_once</pre></td></tr><tr><td data-num="23"></td><td><pre>	来保证只有一个线程可以进入初始化代码块，</pre></td></tr><tr><td data-num="24"></td><td><pre>	这保证了在一个线程中只能有一个 ProcessState 实例</pre></td></tr><tr><td data-num="25"></td><td><pre>	</pre></td></tr><tr><td data-num="26"></td><td><pre>	它的工作方式如下</pre></td></tr><tr><td data-num="27"></td><td><pre>	[-] 第一次调用 std::call_once 时，它会检查与 std::once_flag 关联的标记是否已被设置。</pre></td></tr><tr><td data-num="28"></td><td><pre>	如果标记尚未设置，它将执行传递给 std::call_once 的可调用对象，</pre></td></tr><tr><td data-num="29"></td><td><pre>	并设置标记，以标记初始化已完成。</pre></td></tr><tr><td data-num="30"></td><td><pre>	</pre></td></tr><tr><td data-num="31"></td><td><pre>	[-] 如果其他线程尝试再次调用 std::call_once 与相同的 std::once_flag，</pre></td></tr><tr><td data-num="32"></td><td><pre>	它会发现标记已经设置，因此不会再次执行可调用对象。</pre></td></tr><tr><td data-num="33"></td><td><pre>	*/</pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">[</span><span class="token punctuation">[</span>clang<span class="token double-colon punctuation">::</span>no_destroy<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>once_flag gProcessOnce<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    std<span class="token double-colon punctuation">::</span><span class="token function">call_once</span><span class="token punctuation">(</span>gProcessOnce<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>		<span class="token comment">// 判断 binder 驱动是否存在</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>driver<span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Binder driver %s is unavailable. Using /dev/binder instead."</span><span class="token punctuation">,</span> driver<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            driver <span class="token operator">=</span> <span class="token string">"/dev/binder"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">></span> <span class="token function">l</span><span class="token punctuation">(</span>gProcessMutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>		<span class="token comment">// 将 driver 作为参数实例化 ProcessState, 并赋值给 gProcess</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        gProcess <span class="token operator">=</span> <span class="token class-name">sp</span><span class="token operator">&lt;</span>ProcessState<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">make</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>requireDefault<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token comment">// Detect if we are trying to initialize with a different driver, and</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token comment">// consider that an error. ProcessState will only be initialized once above.</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>gProcess<span class="token operator">-></span><span class="token function">getDriverName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> driver<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                            <span class="token string">"ProcessState was already initialized with %s,"</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                            <span class="token string">" can't initialize with %s."</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                            gProcess<span class="token operator">-></span><span class="token function">getDriverName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> driver<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">return</span> gProcess<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="processstate构造函数"><a class="anchor" href="#processstate构造函数">#</a> <strong>ProcessState 构造函数</strong></h2>
<p>在代码的第 26 行，通过 <code>driver</code>  参数实例化了 ProcessState, 它通过 <code>open_driver()</code>  打开了 binder 驱动设备，并使用 <code>mmap</code>  来进行内存映射</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\ProcessState.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">ProcessState</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>driver<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token operator">:</span> <span class="token function">mDriverName</span><span class="token punctuation">(</span><span class="token function">String8</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">,</span> <span class="token function">mDriverFD</span><span class="token punctuation">(</span><span class="token function">open_driver</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 通过系统调用陷入内核，打开 /dev/binder 设备</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">,</span> <span class="token function">mVMStart</span><span class="token punctuation">(</span>MAP_FAILED<span class="token punctuation">)</span><span class="token comment">// 映射内存的起始地址</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">,</span> <span class="token function">mThreadCountLock</span><span class="token punctuation">(</span>PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">,</span> <span class="token function">mThreadCountDecrement</span><span class="token punctuation">(</span>PTHREAD_COND_INITIALIZER<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">,</span> <span class="token function">mExecutingThreadsCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">,</span> <span class="token function">mWaitingForThreads</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">,</span> <span class="token function">mMaxThreads</span><span class="token punctuation">(</span>DEFAULT_MAX_BINDER_THREADS<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">,</span> <span class="token function">mStarvationStartTimeMs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">,</span> <span class="token function">mThreadPoolStarted</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">,</span> <span class="token function">mThreadPoolSeq</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">,</span> <span class="token function">mCallRestriction</span><span class="token punctuation">(</span>CallRestriction<span class="token double-colon punctuation">::</span>NONE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDriverFD <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// mmap the binder, providing a chunk of virtual address space to receive transactions.</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 调用内存映射函数 mmap, 此时 binder 驱动会在内核空间执行 binder_mmap, 来将一块物理内存同时映射到</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 用户空间和内核空间，来帮助进行跨进程通信</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">// #define BINDER_VM_SIZE ((1 * 1024 * 1024) - sysconf(_SC_PAGE_SIZE) * 2) = 1016KB</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// PAGE_SIZE 被定义为 4096</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        mVMStart <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> BINDER_VM_SIZE<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE <span class="token operator">|</span> MAP_NORESERVE<span class="token punctuation">,</span> mDriverFD<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mVMStart <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token comment">// *sigh*</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Using %s failed: unable to mmap transaction memory.\n"</span><span class="token punctuation">,</span> mDriverName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token function">close</span><span class="token punctuation">(</span>mDriverFD<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            mDriverFD <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            mDriverName<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__ANDROID__</span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>mDriverFD <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Binder driver '%s' could not be opened.  Terminating."</span><span class="token punctuation">,</span> driver<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="open_driver"><a class="anchor" href="#open_driver">#</a> <strong>open_driver</strong></h2>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\ProcessState.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">open_driver</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>driver<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">// 以读写方式打开，并为该文件描述符添加 close-on-exec (执行时可关闭) 的标志，</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token comment">// 来防止该文件描述符被意外泄漏给了 fork 创建出来的子进程</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>driver<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">int</span> vers <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        status_t result <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> BINDER_VERSION<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vers<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Binder ioctl to obtain version failed: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> vers <span class="token operator">!=</span> BINDER_CURRENT_PROTOCOL_VERSION<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Binder driver protocol(%d) does not match user space protocol(%d)! ioctl() return value: %d"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                vers<span class="token punctuation">,</span> BINDER_CURRENT_PROTOCOL_VERSION<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		<span class="token comment">// 设置这个打开的 binder 对象的最大线程数为 15</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        size_t maxThreads <span class="token operator">=</span> DEFAULT_MAX_BINDER_THREADS<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        result <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> BINDER_SET_MAX_THREADS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxThreads<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Binder ioctl to set max threads failed: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">uint32_t</span> enable <span class="token operator">=</span> DEFAULT_ENABLE_ONEWAY_SPAM_DETECTION<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        result <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> BINDER_ENABLE_ONEWAY_SPAM_DETECTION<span class="token punctuation">,</span> <span class="token operator">&amp;</span>enable<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"Binder ioctl to enable oneway spam detection failed: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Opening '%s' failed: %s\n"</span><span class="token punctuation">,</span> driver<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">return</span> fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="总结"><a class="anchor" href="#总结">#</a> 总结</h2>
<p><img data-src="/android-binder/1595250-20211114151720684-1823259499.png" alt="img" style="aspect-ratio:1611 / 1058;"></p>
<h1 id="binder中各个类的含义"><a class="anchor" href="#binder中各个类的含义">#</a> Binder 中各个类的含义</h1>
<p>在进行后续的学习前，我们先来了解一下 Binder 中各个类的含义</p>
<table>
<thead>
<tr>
<th>类名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>BpRefBase</td>
<td>RefBase 的子类，提供 remote () 方法获取远程 Binder</td>
</tr>
<tr>
<td>IInterface</td>
<td>Binder 服务接口的基类，Binder 服务通常需要同时提供本地接口和远程接口</td>
</tr>
<tr>
<td>BpInterface</td>
<td>远程接口的基类，<strong>远程接口是供客户端调用的接口集</strong></td>
</tr>
<tr>
<td>BnInterface</td>
<td>本地接口的基类，<strong>本地接口是需要服务中真正实现的接口集</strong></td>
</tr>
<tr>
<td>IBinder</td>
<td>Binder 对象的基类，BBinder 和 BpBinder 都是这个类的子类</td>
</tr>
<tr>
<td>BpBinder</td>
<td>远程 Binder，这个类提供 transact 方法来发送请求，BpXXX 实现中会用到</td>
</tr>
<tr>
<td>BBinder</td>
<td>本地 Binder，服务实现方的基类，提供了 onTransact 接口来接收请求</td>
</tr>
<tr>
<td>ProcessState</td>
<td>代表了使用 Binder 的进程</td>
</tr>
<tr>
<td>IPCThreadState</td>
<td>代表了使用 Binder 的线程，这个类中封装了与 Binder 驱动通信的逻辑</td>
</tr>
<tr>
<td>Parcel</td>
<td>在 Binder 上传递的数据的包装器</td>
</tr>
</tbody>
</table>
<p>Binder 服务的实现类通常都会遵守下面的命名规则</p>
<ul>
<li>服务的接口使用 I 字母作为前缀</li>
<li>远程接口使用 Bp 作为前缀</li>
<li>本地接口使用 Bn 作为前缀</li>
<li>p 即 proxy 的意思，是客户端用来与 Server 交互的类</li>
</ul>
<p><strong>IBinder 家族</strong></p>
<p><img data-src="/android-binder/image002.png" alt="image" style="aspect-ratio:224 / 200;"></p>
<p>BpBinder 和 BBinder 都是 Android 中与 Binder 通信相关的代表，它们都从 IBinder 类中派生而来</p>
<ul>
<li>BpBinder 是客户端用来与 Server 交互的代理类，p 即 proxy 的意思</li>
<li>BBinder 则是 proxy 相对的一端，它是 proxy 交互的目的端。如果说 BpBinder 代表客户端，那么 BBinder 则代表服务端。这里的 BpBinder 和 BBinder 是一一对应的，即某个 BpBinder 只能和对应的 BBinder 交互</li>
<li>在注册服务和获取服务的过程中，ServiceManager 均为服务端</li>
<li>BpBinder 通过 handle 来标识它所对应的 BBinder 端，与其相关的函数为 <code>sp&lt;IBinder&gt; ProcessState::getStrongProxyForHandle(int32_t handle)</code> ,handle 值为 0 表示 ServiceManager 所对应的 BBinder</li>
</ul>
<p><strong>IServiceManager 家族</strong></p>
<p><img data-src="/android-binder/image003.png" alt="image" style="aspect-ratio:392 / 355;"></p>
<ul>
<li>
<p>IServiceManager、BpServiceManager 和 BnServiceManager 都与业务逻辑相关。</p>
</li>
<li>
<p>BnServiceManager 同时从 BBinder 派生，表示它可以直接参与 Binder 通信。</p>
</li>
<li>
<p>BpServiceManager 虽然从 BpInterface 中派生，但是这条分支似乎与 BpBinder 没有关系。</p>
</li>
<li>
<p>BnServiceManager 是一个虚类，它的业务函数最终需要子类来实现。</p>
</li>
</ul>
<h1 id="servicemanager的获取过程"><a class="anchor" href="#servicemanager的获取过程">#</a> ServiceManager 的获取过程</h1>
<p>当一个 Server 想要注册服务，那必须要知道 &quot;ServiceManager 在哪里才可以&quot;, 所以需要有一个方法来让 Server 找到 ServiceManager, 这是通过函数 <code>defaultServiceManager</code>  实现的</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 获取 BpServiceManager 对象</span></pre></td></tr><tr><td data-num="2"></td><td><pre>sp<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> <span class="token function">sm</span><span class="token punctuation">(</span><span class="token function">defaultServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>defaultServiceManager 的主要作用是获取 BpServiceManager 对象，它通过 <code>getContextObject</code>  获取到了 ServiceManager 的 BBinder 所对应的 BpBinder 对象，随后利用 <code>interface_cast</code>  将 <code>BpBinder</code>  对象转换成了 <code>BpServiceManager</code>  对象</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\IServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>sp<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> <span class="token function">defaultServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    std<span class="token double-colon punctuation">::</span><span class="token function">call_once</span><span class="token punctuation">(</span>gSmOnce<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        sp<span class="token operator">&lt;</span>AidlServiceManager<span class="token operator">></span> sm <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span>sm <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			<span class="token comment">// 获取 ServiceManager 的 BBinder 所对应的 BpBinder 对象，</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token comment">// 并将该对象通过 interface_cast 转换为 AidlServiceManager</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            sm <span class="token operator">=</span> <span class="token generic-function"><span class="token function">interface_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>AidlServiceManager<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getContextObject</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Waiting 1s on context object on %s."</span><span class="token punctuation">,</span> <span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getDriverName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token comment">// 实例化 ServiceManagerShim</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        gDefaultServiceManager <span class="token operator">=</span> <span class="token class-name">sp</span><span class="token operator">&lt;</span>ServiceManagerShim<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">make</span><span class="token punctuation">(</span>sm<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> gDefaultServiceManager<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>AidlServiceManager</strong></p>
<p><code>AidlServiceManager</code>  其实是 <code>android::os::IServiceManager</code>  的别名</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">using</span> AidlServiceManager <span class="token operator">=</span> android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span>IServiceManager<span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>ServiceManagerShim</strong></p>
<p>之前是没有 <code>ServiceManagerShim</code>  的，而是直接操作 BpServiceManager，这个辅助类封装了 AIDL 自动生成的 BpServiceManager，所以现在的客户端代码流就变成如下三步：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span>      用户代码 </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span> libbinder代码  binder<span class="token operator">/</span>IServiceManager<span class="token punctuation">.</span>cpp#ServiceManagerShim</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3.</span>     AIDL 代码  android<span class="token operator">/</span>os<span class="token operator">/</span>IServiceManager<span class="token punctuation">.</span>cpp#BpServiceManager 接口</pre></td></tr></table></figure><p>libbinder 中的 ServiceManagerShim 起到了一个中转的作用，把请求转给 out 下 AIDL 自动生成的 BpServiceManager, 原来是在 libbinder#IServiceManager.cpp 中手写实现，现在是 AIDL 帮你实现。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\IServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// From the old libbinder IServiceManager interface to IServiceManager.</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">ServiceManagerShim</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">IServiceManager</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">explicit</span> <span class="token function">ServiceManagerShim</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>AidlServiceManager<span class="token operator">></span><span class="token operator">&amp;</span> impl<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token keyword">const</span> String16<span class="token operator">&amp;</span> name<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> <span class="token function">checkService</span><span class="token punctuation">(</span><span class="token keyword">const</span> String16<span class="token operator">&amp;</span> name<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    status_t <span class="token function">addService</span><span class="token punctuation">(</span><span class="token keyword">const</span> String16<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> service<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                        <span class="token keyword">bool</span> allowIsolated<span class="token punctuation">,</span> <span class="token keyword">int</span> dumpsysPriority<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    Vector<span class="token operator">&lt;</span>String16<span class="token operator">></span> <span class="token function">listServices</span><span class="token punctuation">(</span><span class="token keyword">int</span> dumpsysPriority<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> <span class="token function">waitForService</span><span class="token punctuation">(</span><span class="token keyword">const</span> String16<span class="token operator">&amp;</span> name16<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">bool</span> <span class="token function">isDeclared</span><span class="token punctuation">(</span><span class="token keyword">const</span> String16<span class="token operator">&amp;</span> name<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    Vector<span class="token operator">&lt;</span>String16<span class="token operator">></span> <span class="token function">getDeclaredInstances</span><span class="token punctuation">(</span><span class="token keyword">const</span> String16<span class="token operator">&amp;</span> interface<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>String16<span class="token operator">></span> <span class="token function">updatableViaApex</span><span class="token punctuation">(</span><span class="token keyword">const</span> String16<span class="token operator">&amp;</span> name<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// for legacy ABI</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">const</span> String16<span class="token operator">&amp;</span> <span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">return</span> mTheRealServiceManager<span class="token operator">-></span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    IBinder<span class="token operator">*</span> <span class="token function">onAsBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">IInterface</span><span class="token double-colon punctuation">::</span><span class="token function">asBinder</span><span class="token punctuation">(</span>mTheRealServiceManager<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    sp<span class="token operator">&lt;</span>AidlServiceManager<span class="token operator">></span> mTheRealServiceManager<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="getcontextobject"><a class="anchor" href="#getcontextobject">#</a> getContextObject</h2>
<p>这个函数最主要的功能就是获取 ServiceManager 的 BBinder 所对应的 BpBinder 对象，它通过调用 <code>getStrongProxyForHandle(0)</code>  来进行获取</p>
<p>这里传入的 handle 的值为 0, 它表示 ServiceManager 所对应的 BBinder</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\ProcessState.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> <span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">getContextObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token comment">/*caller*/</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">// 创建一个 BpBinder 对象，getStrongProxyForHandle 传入的参数 handle 的值为 0</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token comment">//,0 代表的就是 ServiceManager 所对应的 BBinder。</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> context <span class="token operator">=</span> <span class="token function">getStrongProxyForHandle</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// The root object is special since we get it directly from the driver, it is never</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// written by Parcell::writeStrongBinder.</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        internal<span class="token double-colon punctuation">::</span><span class="token class-name">Stability</span><span class="token double-colon punctuation">::</span><span class="token function">markCompilationUnit</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Not able to get context object on %s."</span><span class="token punctuation">,</span> mDriverName<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">return</span> context<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>getStrongProxyForHandle(0)</strong></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\ProcessState.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> <span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">getStrongProxyForHandle</span><span class="token punctuation">(</span><span class="token keyword">int32_t</span> handle<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    AutoMutex <span class="token function">_l</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">// 根据索引查找对应资源。</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    handle_entry<span class="token operator">*</span> e <span class="token operator">=</span> <span class="token function">lookupHandleLocked</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token comment">// 如果 lookupHandleLocked 发现没有对应的资源项，则会创建一个新的项并返回。</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// We need to create a new BpBinder if there isn't currently one, OR we</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// are unable to acquire a weak reference on this current one.  The</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// attemptIncWeak() is safe because we know the BpBinder destructor will always</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// call expungeHandle(), which acquires the same lock we are holding now.</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// We need to do this because there is a race condition between someone</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// releasing a reference on this BpBinder, and a new reference on its handle</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// arriving from the driver.</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        IBinder<span class="token operator">*</span> b <span class="token operator">=</span> e<span class="token operator">-></span>binder<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> <span class="token operator">!</span>e<span class="token operator">-></span>refs<span class="token operator">-></span><span class="token function">attemptIncWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token comment">// Special case for context manager...</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token comment">// The context manager is the only object for which we create</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token comment">// a BpBinder proxy without already holding a reference.</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token comment">// Perform a dummy transaction to ensure the context manager</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token comment">// is registered before we create the first local reference</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token comment">// to it (which will occur when creating the BpBinder).</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token comment">// If a local reference is created for the BpBinder when the</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token comment">// context manager is not present, the driver will fail to</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token comment">// provide a reference to the context manager, but the</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token comment">// driver API does not return status.</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token comment">//</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token comment">// Note that this is not race-free if the context manager</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token comment">// dies while this code runs.</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token comment">//</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token comment">// TODO: add a driver API to wait for context manager, or</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token comment">// stop special casing handle 0 for context manager and add</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token comment">// a driver API to get a handle to the context manager with</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token comment">// proper reference counting.</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>                IPCThreadState<span class="token operator">*</span> ipc <span class="token operator">=</span> <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>                CallRestriction originalCallRestriction <span class="token operator">=</span> ipc<span class="token operator">-></span><span class="token function">getCallRestriction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                ipc<span class="token operator">-></span><span class="token function">setCallRestriction</span><span class="token punctuation">(</span>CallRestriction<span class="token double-colon punctuation">::</span>NONE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>                Parcel data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                status_t status <span class="token operator">=</span> ipc<span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                        <span class="token number">0</span><span class="token punctuation">,</span> IBinder<span class="token double-colon punctuation">::</span>PING_TRANSACTION<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>                ipc<span class="token operator">-></span><span class="token function">setCallRestriction</span><span class="token punctuation">(</span>originalCallRestriction<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> DEAD_OBJECT<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                   <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>			<span class="token comment">// 创建一个 BpBinder</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            sp<span class="token operator">&lt;</span>BpBinder<span class="token operator">></span> b <span class="token operator">=</span> <span class="token class-name">BpBinder</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            e<span class="token operator">-></span>binder <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> e<span class="token operator">-></span>refs <span class="token operator">=</span> b<span class="token operator">-></span><span class="token function">getWeakRefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            result <span class="token operator">=</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token comment">// This little bit of nastyness is to allow us to add a primary</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token comment">// reference to the remote proxy when this team doesn't have one</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token comment">// but another team is sending the handle to us.</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            result<span class="token punctuation">.</span><span class="token function">force_set</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            e<span class="token operator">-></span>refs<span class="token operator">-></span><span class="token function">decWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="interface_cast"><a class="anchor" href="#interface_cast">#</a> <strong>interface_cast</strong></h2>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\include\binder\IInterface.h</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="3"></td><td><pre> * If this is a local object and the descriptor matches, this will return the</pre></td></tr><tr><td data-num="4"></td><td><pre> * actual local object which is implementing the interface. Otherwise, this will</pre></td></tr><tr><td data-num="5"></td><td><pre> * return a proxy to the interface without checking the interface descriptor.</pre></td></tr><tr><td data-num="6"></td><td><pre> * This means that subsequent calls may fail with BAD_TYPE.</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">INTERFACE</span><span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">inline</span> sp<span class="token operator">&lt;</span>INTERFACE<span class="token operator">></span> <span class="token function">interface_cast</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">INTERFACE</span><span class="token double-colon punctuation">::</span><span class="token function">asInterface</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这是一个模板函数，其中的 <code>asInterface</code>  是在 <code>DECLARE_META_INTERFACE</code>  宏中定义的</p>
<p><strong>asInterface</strong></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\include\binder\IInterface.h</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">//## 的作用是将前后两个标识符或符号连接在一起，以形成一个单独的标识符或符号。</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 如 #define CONCATENATE (x, y) x##y</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 如果调用 CONCATENATE (a, b)，它将被展开为 ab</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DECLARE_META_INTERFACE</span><span class="token expression"><span class="token punctuation">(</span>INTERFACE<span class="token punctuation">)</span>                               </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token expression"><span class="token keyword">public</span><span class="token operator">:</span>                                                                 </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token expression"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>String16 descriptor<span class="token punctuation">;</span>                        </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token expression"><span class="token keyword">static</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span>I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token operator">></span> <span class="token function">asInterface</span><span class="token punctuation">(</span>                     </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token expression"><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>              </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token expression"><span class="token keyword">virtual</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>String16<span class="token operator">&amp;</span> <span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>  </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token expression">I</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">INTERFACE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                     </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token expression"><span class="token keyword">virtual</span> <span class="token operator">~</span>I</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">INTERFACE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                            </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token expression"><span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">setDefaultImpl</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token operator">></span> impl<span class="token punctuation">)</span><span class="token punctuation">;</span>     </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token expression"><span class="token keyword">static</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token expression"><span class="token keyword">private</span><span class="token operator">:</span>                                                                </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token expression"><span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token operator">></span> default_impl<span class="token punctuation">;</span>                  </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token expression"><span class="token keyword">public</span><span class="token operator">:</span>                                                                 </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">IMPLEMENT_META_INTERFACE</span><span class="token expression"><span class="token punctuation">(</span>INTERFACE<span class="token punctuation">,</span> NAME<span class="token punctuation">)</span>                       </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token expression"><span class="token function">DO_NOT_DIRECTLY_USE_ME_IMPLEMENT_META_INTERFACE</span><span class="token punctuation">(</span>INTERFACE<span class="token punctuation">,</span> NAME<span class="token punctuation">)</span>    </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    </pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DO_NOT_DIRECTLY_USE_ME_IMPLEMENT_META_INTERFACE</span><span class="token expression"><span class="token punctuation">(</span>INTERFACE<span class="token punctuation">,</span> NAME<span class="token punctuation">)</span></span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token expression"><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>StaticString16                                     </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token expression">I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">_descriptor_static_str16</span><span class="token punctuation">(</span><span class="token function">__IINTF_CONCAT</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> NAME<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token expression"><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>String16 I</span><span class="token punctuation">##</span><span class="token expression"><span class="token class-name">INTERFACE</span><span class="token double-colon punctuation">::</span><span class="token function">descriptor</span><span class="token punctuation">(</span>                 </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token expression">I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE</span><span class="token punctuation">##</span><span class="token expression">_descriptor_static_str16<span class="token punctuation">)</span><span class="token punctuation">;</span>                        </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token expression"><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>String16<span class="token operator">&amp;</span>                                          </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token expression">I</span><span class="token punctuation">##</span><span class="token expression"><span class="token class-name">INTERFACE</span><span class="token double-colon punctuation">::</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>              </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token expression"><span class="token keyword">return</span> I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token double-colon punctuation">::</span>descriptor<span class="token punctuation">;</span>                                </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span>                                                                   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token expression"><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span>I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token operator">></span> I</span><span class="token punctuation">##</span><span class="token expression"><span class="token class-name">INTERFACE</span><span class="token double-colon punctuation">::</span><span class="token function">asInterface</span><span class="token punctuation">(</span>              </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token expression"><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> obj<span class="token punctuation">)</span>               </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#123;</span>                                                                   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token expression"><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span>I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token operator">></span> intr<span class="token punctuation">;</span>                               </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                           </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token expression">intr <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span>I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">cast</span><span class="token punctuation">(</span>                   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token expression">obj<span class="token operator">-></span><span class="token function">queryLocalInterface</span><span class="token punctuation">(</span>I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token double-colon punctuation">::</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>intr <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                      </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token expression">intr <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span>Bp</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">make</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>         </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token expression"><span class="token punctuation">&#125;</span>                                                           </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span>                                                               </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token expression"><span class="token keyword">return</span> intr<span class="token punctuation">;</span>                                                    </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span>                                                                   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token expression">std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token operator">></span> I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token double-colon punctuation">::</span>default_impl<span class="token punctuation">;</span>           </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token expression"><span class="token keyword">bool</span> I</span><span class="token punctuation">##</span><span class="token expression"><span class="token class-name">INTERFACE</span><span class="token double-colon punctuation">::</span><span class="token function">setDefaultImpl</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token operator">></span> impl<span class="token punctuation">)</span></span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#123;</span>                                                                   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token comment">/* Only one user of this interface can use this function     */</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token comment">/* at a time. This is a heuristic to detect if two different */</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token comment">/* users in the same process use this function.              */</span> <span class="token punctuation">\</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token expression"><span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token double-colon punctuation">::</span>default_impl<span class="token punctuation">)</span><span class="token punctuation">;</span>                            </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>impl<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                                                     </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token expression">I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token double-colon punctuation">::</span>default_impl <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>impl<span class="token punctuation">)</span><span class="token punctuation">;</span>               </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token expression"><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                                                </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token expression"><span class="token punctuation">&#125;</span>                                                               </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token expression"><span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                                                   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span>                                                                   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token expression"><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token operator">></span><span class="token operator">&amp;</span> I</span><span class="token punctuation">##</span><span class="token expression"><span class="token class-name">INTERFACE</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#123;</span>                                                                   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token expression"><span class="token keyword">return</span> I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token double-colon punctuation">::</span>default_impl<span class="token punctuation">;</span>                              </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token expression"><span class="token punctuation">&#125;</span>                                                                   </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token expression">I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token double-colon punctuation">::</span>I</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">INTERFACE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>                                    </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token expression">I</span><span class="token punctuation">##</span><span class="token expression">INTERFACE<span class="token double-colon punctuation">::</span><span class="token operator">~</span>I</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">INTERFACE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>                                   </span>\</pre></td></tr></table></figure><p>我们将 <code>interface_cast&lt;AidlServiceManager&gt;(new BpBinder(0))</code>  通过宏定义替换一下看的会更加清楚，在这里 <code>asInterface</code>  将 <code>BpBinder</code>  转换成了 <code>BpServiceManager</code> , <code>BpServiceManager</code>  继承了 <code>IServiceManager</code></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>String16 descriptor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">static</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> <span class="token function">asInterface</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">virtual</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>String16<span class="token operator">&amp;</span> <span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">IServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">IServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">setDefaultImpl</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> impl<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> default_impl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>StaticString16</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">IServiceManager_descriptor_static_str16</span><span class="token punctuation">(</span><span class="token function">__IINTF_CONCAT</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>IServiceManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>String16 <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">descriptor</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    IServiceManager_descriptor_static_str16<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>String16<span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> IServiceManager<span class="token double-colon punctuation">::</span>descriptor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">// 在这里终于出现了 asInterface 函数的定义，我们也找到了 BpServiceManager 这个类</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">asInterface</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> intr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        intr <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span><span class="token class-name">sp</span><span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">cast</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            obj<span class="token operator">-></span><span class="token function">queryLocalInterface</span><span class="token punctuation">(</span>IServiceManager<span class="token double-colon punctuation">::</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>intr <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            intr <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span><span class="token class-name">sp</span><span class="token operator">&lt;</span>BpServiceManager<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">make</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">return</span> intr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> IServiceManager<span class="token double-colon punctuation">::</span>default_impl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">setDefaultImpl</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> impl<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">/* Only one user of this interface can use this function     */</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">/* at a time. This is a heuristic to detect if two different */</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">/* users in the same process use this function.              */</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>IServiceManager<span class="token double-colon punctuation">::</span>default_impl<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>impl<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        IServiceManager<span class="token double-colon punctuation">::</span>default_impl <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>impl<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">return</span> IServiceManager<span class="token double-colon punctuation">::</span>default_impl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">IServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">IServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="总结-2"><a class="anchor" href="#总结-2">#</a> 总结</h2>
<p><img data-src="/android-binder/1595250-20211114151757336-739536801.png" alt="img" style="aspect-ratio:1194 / 499;"></p>
<h1 id="server向servicemanager注册服务"><a class="anchor" href="#server向servicemanager注册服务">#</a> Server 向 ServiceManager 注册服务</h1>
<p>这里以 <code>MediaServer</code>  为例来分析 Server 向 ServiceManager 注册服务的过程</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\av\media\mediaserver\main_mediaserver.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc __unused<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv __unused<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">// 创建一个 ProcessState 实例，打开默认驱动 /dev/binder 并进行 mmap 内存映射</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token comment">// 此方法的详细分析请参见右侧目录 ServiceManager 的启动过程 ->ProcessState::init</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    sp<span class="token operator">&lt;</span>ProcessState<span class="token operator">></span> <span class="token function">proc</span><span class="token punctuation">(</span><span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token comment">// 客户端获取 ServiceManagerShim 对象</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token comment">// 此方法的详细分析请参见右侧目录 ServiceManager 的获取过程</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    sp<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> <span class="token function">sm</span><span class="token punctuation">(</span><span class="token function">defaultServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"ServiceManager: %p"</span><span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token comment">// 注册 media.player 服务</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token class-name">MediaPlayerService</span><span class="token double-colon punctuation">::</span><span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">ResourceManagerService</span><span class="token double-colon punctuation">::</span><span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token function">registerExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>hardware<span class="token double-colon punctuation">::</span><span class="token function">configureRpcThreadpool</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token comment">// 启动线程池</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">startThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token comment">// 将线程加入线程池</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">joinThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>hardware<span class="token double-colon punctuation">::</span><span class="token function">joinRpcThreadpool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>MediaPlayerService::instantiate</strong></p>
<p>这个函数的作用就是调用 defaultServiceManager 的 addService 方法来添加向 ServiceManager 注册服务</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\av\media\libmediaplayerservice\MediaPlayerService.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">MediaPlayerService</span><span class="token double-colon punctuation">::</span><span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token function">defaultServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">addService</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function">String16</span><span class="token punctuation">(</span><span class="token string">"media.player"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token function">MediaPlayerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="defaultservicemanager-addservice"><a class="anchor" href="#defaultservicemanager-addservice">#</a> defaultServiceManager()-&gt;addService</h2>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\IServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>status_t <span class="token class-name">ServiceManagerShim</span><span class="token double-colon punctuation">::</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token keyword">const</span> String16<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> service<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                        <span class="token keyword">bool</span> allowIsolated<span class="token punctuation">,</span> <span class="token keyword">int</span> dumpsysPriority<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    Status status <span class="token operator">=</span> mTheRealServiceManager<span class="token operator">-></span><span class="token function">addService</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token function">String8</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">,</span> allowIsolated<span class="token punctuation">,</span> dumpsysPriority<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span> status<span class="token punctuation">.</span><span class="token function">exceptionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里使用了 <code>mTheRealServiceManager</code>  中的 <code>addService</code>  方法，那么 mTheRealServiceManager 是从哪里来的呢？</p>
<h2 id="mtherealservicemanager"><a class="anchor" href="#mtherealservicemanager">#</a> mTheRealServiceManager</h2>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\IServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">using</span> AidlServiceManager <span class="token operator">=</span> android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span>IServiceManager<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// From the old libbinder IServiceManager interface to IServiceManager.</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">ServiceManagerShim</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">IServiceManager</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    sp<span class="token operator">&lt;</span>AidlServiceManager<span class="token operator">></span> mTheRealServiceManager<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token class-name">ServiceManagerShim</span><span class="token double-colon punctuation">::</span><span class="token function">ServiceManagerShim</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>AidlServiceManager<span class="token operator">></span><span class="token operator">&amp;</span> impl<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre> <span class="token operator">:</span> <span class="token function">mTheRealServiceManager</span><span class="token punctuation">(</span>impl<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>从这段 ServiceManagerShim 类的声明中，我们可以清楚的看到 mTheRealServiceManager 是 <code>android::os::IServiceManager</code>  类型的实例，并且在 ServiceManagerShim 实例化时赋值</p>
<p>而在 <strong>ServiceManager 的获取过程</strong> 中，我们知道 <code>ServiceManagerShim </code> 是在 <code>defaultServiceManager()</code>  中实例化的</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\IServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>sp<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> <span class="token function">defaultServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    std<span class="token double-colon punctuation">::</span><span class="token function">call_once</span><span class="token punctuation">(</span>gSmOnce<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        sp<span class="token operator">&lt;</span>AidlServiceManager<span class="token operator">></span> sm <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span>sm <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>			<span class="token comment">// 获取 ServiceManager 的 BBinder 所对应的 BpBinder 对象，</span></pre></td></tr><tr><td data-num="8"></td><td><pre>			<span class="token comment">// 并将该对象通过 interface_cast 转换为 AidlServiceManager</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            sm <span class="token operator">=</span> <span class="token generic-function"><span class="token function">interface_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>AidlServiceManager<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getContextObject</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Waiting 1s on context object on %s."</span><span class="token punctuation">,</span> <span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getDriverName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token comment">// 实例化 ServiceManagerShim</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        gDefaultServiceManager <span class="token operator">=</span> <span class="token class-name">sp</span><span class="token operator">&lt;</span>ServiceManagerShim<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">make</span><span class="token punctuation">(</span>sm<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> gDefaultServiceManager<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>所以说 <code>mTheRealServiceManager </code> 其实是 <code>BpServiceManager(new BpBinder(0))</code> , 注册服务的顺序为 <code>BpServiceManager--&gt;BpBinder--&gt;IPCThreadState--&gt;ioctl</code></p>
<p>而 <code>BpServiceManager</code>  现在是由 AIDL 自动生成，在框架编译完成之后的 out 目录中的</p>
<p><strong>BpServiceManager::addService</strong></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform/out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_arm_armv8-a_shared/gen/aidl/android/os/IServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">namespace</span> android <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">namespace</span> os <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">BpServiceManager</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> _aidl_impl<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token operator">:</span> <span class="token generic-function"><span class="token function">BpInterface</span><span class="token generic class-name"><span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span></span></span><span class="token punctuation">(</span>_aidl_impl<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//_aidl_impl 就是 BpBinder (0) 实例</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> service<span class="token punctuation">,</span> <span class="token keyword">bool</span> allowIsolated<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> dumpPriority<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0、和 Rpc Binder 有关</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">//1、写 interface</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">//2、写 name</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">//3、写 binder 对象</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token comment">//4、写 allowIsolated</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeBool</span><span class="token punctuation">(</span>allowIsolated<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">//5、写 dumpPriority</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInt32</span><span class="token punctuation">(</span>dumpPriority<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token comment">//6、借助 BpBinder (0)#transact 来发起 Binder 通信</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_addService<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">addService</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> allowIsolated<span class="token punctuation">,</span> dumpPriority<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token comment">//7、如果有返回值就从这个 parcel 包里读</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个过程主要是借助  <code>BpBinder(0)#transact</code>  来发起 Binder 通信，Binder 驱动根据 handle == 0 找到我们的 ServiceManager 进程，唤醒他开始处理请求。</p>
<p>还记得在 <strong>ServiceManager 的启动过程</strong> 中的那个 while 循环函数吗？BinderCallback 就是用来处理 Binder 驱动发送的 <code>BR_TRANSACTION</code>  信号的</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\cmds\servicemanager\main.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">// 准备 looper</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    sp<span class="token operator">&lt;</span>Looper<span class="token operator">></span> looper <span class="token operator">=</span> <span class="token class-name">Looper</span><span class="token double-colon punctuation">::</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token comment">/*allowNonCallbacks*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">// 监听 BC_ENTER_LOOPER 信号，收到该信号后回调处理 binder 调用</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">BinderCallback</span><span class="token double-colon punctuation">::</span><span class="token function">setupTo</span><span class="token punctuation">(</span>looper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token comment">// 监听客户端回调</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">ClientCallbackCallback</span><span class="token double-colon punctuation">::</span><span class="token function">setupTo</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> manager<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token comment">// 阻塞等待和处理事件</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        looper<span class="token operator">-></span><span class="token function">pollAll</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// should not be reached</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> EXIT_FAILURE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="bindercallback"><a class="anchor" href="#bindercallback">#</a> BinderCallback</h2>
<p><code>BinderCallback::handleEvent</code>  调用了 <code>IPCThreadState::self()-&gt;handlePolledCommands()</code>  来处理命令</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\cmds\servicemanager\main.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">BinderCallback</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LooperCallback</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">static</span> sp<span class="token operator">&lt;</span>BinderCallback<span class="token operator">></span> <span class="token function">setupTo</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Looper<span class="token operator">></span><span class="token operator">&amp;</span> looper<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        sp<span class="token operator">&lt;</span>BinderCallback<span class="token operator">></span> cb <span class="token operator">=</span> <span class="token class-name">sp</span><span class="token operator">&lt;</span>BinderCallback<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">int</span> binder_fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token comment">// 监听 BC_ENTER_LOOPER 信号</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">setupPolling</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>binder_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Failed to setupPolling: %d"</span><span class="token punctuation">,</span> binder_fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">int</span> ret <span class="token operator">=</span> looper<span class="token operator">-></span><span class="token function">addFd</span><span class="token punctuation">(</span>binder_fd<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                                Looper<span class="token double-colon punctuation">::</span>POLL_CALLBACK<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                                Looper<span class="token double-colon punctuation">::</span>EVENT_INPUT<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                                cb<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                                <span class="token keyword">nullptr</span> <span class="token comment">/*data*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token function">LOG_ALWAYS_FATAL_IF</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Failed to add binder FD to Looper"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> cb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">int</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token comment">/* fd */</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token comment">/* events */</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token comment">/* data */</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">handlePolledCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// Continue receiving callbacks.</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="ipcthreadstatehandlepolledcommands"><a class="anchor" href="#ipcthreadstatehandlepolledcommands">#</a> IPCThreadState::handlePolledCommands</h2>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\IPCThreadState.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>status_t <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">handlePolledCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    status_t result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">// 获取并执行命令</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        result <span class="token operator">=</span> <span class="token function">getAndExecuteCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>mIn<span class="token punctuation">.</span><span class="token function">dataPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> mIn<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">processPendingDerefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">flushCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="ipcthreadstategetandexecutecommand"><a class="anchor" href="#ipcthreadstategetandexecutecommand">#</a> IPCThreadState::getAndExecuteCommand</h2>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\IPCThreadState.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>status_t <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">getAndExecuteCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    status_t result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">int32_t</span> cmd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">// 和 binder 驱动通信，获取或传输数据</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    result <span class="token operator">=</span> <span class="token function">talkWithDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">>=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        size_t IN <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">dataAvail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>IN <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token comment">// 读取命令</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        cmd <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function">IF_LOG_COMMANDS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            alog <span class="token operator">&lt;&lt;</span> <span class="token string">"Processing top-level Command: "</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                 <span class="token operator">&lt;&lt;</span> <span class="token function">getReturnString</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mProcess<span class="token operator">-></span>mThreadCountLock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        mProcess<span class="token operator">-></span>mExecutingThreadsCount<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mProcess<span class="token operator">-></span>mExecutingThreadsCount <span class="token operator">>=</span> mProcess<span class="token operator">-></span>mMaxThreads <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                mProcess<span class="token operator">-></span>mStarvationStartTimeMs <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            mProcess<span class="token operator">-></span>mStarvationStartTimeMs <span class="token operator">=</span> <span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mProcess<span class="token operator">-></span>mThreadCountLock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>		<span class="token comment">// 解析并执行命令</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        result <span class="token operator">=</span> <span class="token function">executeCommand</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mProcess<span class="token operator">-></span>mThreadCountLock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        mProcess<span class="token operator">-></span>mExecutingThreadsCount<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mProcess<span class="token operator">-></span>mExecutingThreadsCount <span class="token operator">&lt;</span> mProcess<span class="token operator">-></span>mMaxThreads <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                mProcess<span class="token operator">-></span>mStarvationStartTimeMs <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">int64_t</span> starvationTimeMs <span class="token operator">=</span> <span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> mProcess<span class="token operator">-></span>mStarvationStartTimeMs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>starvationTimeMs <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"binder thread pool (%zu threads) starved for %"</span> PRId64 <span class="token string">" ms"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                      mProcess<span class="token operator">-></span>mMaxThreads<span class="token punctuation">,</span> starvationTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            mProcess<span class="token operator">-></span>mStarvationStartTimeMs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token comment">// Cond broadcast can be expensive, so don't send it every time a binder</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">// call is processed. b/168806193</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mProcess<span class="token operator">-></span>mWaitingForThreads <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mProcess<span class="token operator">-></span>mThreadCountDecrement<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mProcess<span class="token operator">-></span>mThreadCountLock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="ipcthreadstateexecutecommand"><a class="anchor" href="#ipcthreadstateexecutecommand">#</a> IPCThreadState::executeCommand</h2>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\IPCThreadState.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>status_t <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">executeCommand</span><span class="token punctuation">(</span><span class="token keyword">int32_t</span> cmd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token keyword">case</span> BR_TRANSACTION<span class="token operator">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#123;</span>	<span class="token comment">// 因为目的端 SM 所以 tr.target.ptr 为 0</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        	<span class="token keyword">if</span> <span class="token punctuation">(</span>tr<span class="token punctuation">.</span>target<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        	<span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">// 开始业务分发</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        	    error <span class="token operator">=</span> the_context_object<span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>code<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> tr<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        	<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="ipcthreadstatesetthecontextobject"><a class="anchor" href="#ipcthreadstatesetthecontextobject">#</a> IPCThreadState::setTheContextObject</h2>
<p>在<strong> ServiceManager 的启动过程</strong> 这节的内容中，我们让 ServiceManager 成为了整个 binder IPC 通信中的上下文管理者，并将其存储在全局变量 <code>the_context_object</code>  中</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\cmds\servicemanager\main.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>sp<span class="token operator">&lt;</span>BBinder<span class="token operator">></span> the_context_object<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">setTheContextObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>BBinder<span class="token operator">></span><span class="token operator">&amp;</span> obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    the_context_object <span class="token operator">=</span> obj<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token comment">// 将 "manager" 服务作为服务端 Bbinder 对象</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">setTheContextObject</span><span class="token punctuation">(</span>manager<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token comment">// 向 binder 驱动发送 ioctl BINDER_SET_CONTEXT_MGR_EXT 信号，将 servicemanager</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token comment">// 在 ProcessState::initWithDriver 中打开驱动设备 /dev/driver 所返回的文件描述符句柄</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token comment">// 作为整个 binder IPC 通信中的上下文管理者</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    ps<span class="token operator">-></span><span class="token function">becomeContextManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="bbindertransact"><a class="anchor" href="#bbindertransact">#</a> BBinder::transact</h2>
<p>所以 <code>the_context_object-&gt;transact()</code>  调用就走到  <code>BBinder</code>  的 transact</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\libs\binder\Binder.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// NOLINTNEXTLINE(google-default-arguments)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>status_t <span class="token class-name">BBinder</span><span class="token double-colon punctuation">::</span><span class="token function">transact</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">uint32_t</span> code<span class="token punctuation">,</span> <span class="token keyword">const</span> Parcel<span class="token operator">&amp;</span> data<span class="token punctuation">,</span> Parcel<span class="token operator">*</span> reply<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> flags<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    data<span class="token punctuation">.</span><span class="token function">setDataPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>reply <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> FLAG_CLEAR_BUF<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        reply<span class="token operator">-></span><span class="token function">markSensitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    status_t err <span class="token operator">=</span> NO_ERROR<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">case</span> PING_TRANSACTION<span class="token operator">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            err <span class="token operator">=</span> <span class="token function">pingBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">case</span> EXTENSION_TRANSACTION<span class="token operator">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            err <span class="token operator">=</span> reply<span class="token operator">-></span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">case</span> DEBUG_PID_TRANSACTION<span class="token operator">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            err <span class="token operator">=</span> reply<span class="token operator">-></span><span class="token function">writeInt32</span><span class="token punctuation">(</span><span class="token function">getDebugPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            err <span class="token operator">=</span> <span class="token function">onTransact</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// In case this is being transacted on in the same process.</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>reply <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        reply<span class="token operator">-></span><span class="token function">setDataPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">return</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="bnservicemanagerontransact"><a class="anchor" href="#bnservicemanagerontransact">#</a> BnServiceManager::onTransact</h2>
<p>然后回到了这个 AIDL 自动生成的 IServiceManager.cpp 中 BnServiceManager 的 onTransact () 方法里</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform/out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_arm_armv8-a_shared/gen/aidl/android/os/IServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t <span class="token class-name">BnServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> _aidl_code<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel<span class="token operator">&amp;</span> _aidl_data<span class="token punctuation">,</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel<span class="token operator">*</span> _aidl_reply<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> _aidl_flags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>_aidl_code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_addService<span class="token operator">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string in_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span> in_service<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">bool</span> in_allowIsolated<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">int32_t</span> in_dumpPriority<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 检查 interface</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 读 name</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 读 binder</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_service<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 读 in_allowIsolated</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readBool</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_allowIsolated<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// 读 in_dumpPriority</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_dumpPriority<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">// 调用真正的 ServiceManager.cpp 中的实现 addService</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">addService</span><span class="token punctuation">(</span>in_name<span class="token punctuation">,</span> in_service<span class="token punctuation">,</span> in_allowIsolated<span class="token punctuation">,</span> in_dumpPriority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">// 如果有返回写返回到 _aidl_reply</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="servicemanageraddservice"><a class="anchor" href="#servicemanageraddservice">#</a> ServiceManager::addService</h2>
<p>这里是和 Bp 端是对称的操作，下一步走到 ServiceManager.cpp::addService 方法</p>
<div class="note info">
<p>QUESTION? 为什么通过 <code>::android::binder::Status _aidl_status(addService(in_name, in_service, in_allowIsolated, in_dumpPriority))</code>  可以调用到 <code>ServiceManager::addService</code> ?</p>
</div>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\cmds\servicemanager\ServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>Status <span class="token class-name">ServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> binder<span class="token punctuation">,</span> <span class="token keyword">bool</span> allowIsolated<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> dumpPriority<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">auto</span> ctx <span class="token operator">=</span> mAccess<span class="token operator">-></span><span class="token function">getCallingContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// apps cannot add services</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">multiuser_get_app_id</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>uid<span class="token punctuation">)</span> <span class="token operator">>=</span> AID_APP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">fromExceptionCode</span><span class="token punctuation">(</span>Status<span class="token double-colon punctuation">::</span>EX_SECURITY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAccess<span class="token operator">-></span><span class="token function">canAdd</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">fromExceptionCode</span><span class="token punctuation">(</span>Status<span class="token double-colon punctuation">::</span>EX_SECURITY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>binder <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">fromExceptionCode</span><span class="token punctuation">(</span>Status<span class="token double-colon punctuation">::</span>EX_ILLEGAL_ARGUMENT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token comment">// 检验 Service 名称的合法性，名称长度要求大于 0 并小于等于 127</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token comment">// 字符仅包括 [a-z][A-Z][0-9]_-./</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValidServiceName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Invalid service name: "</span> <span class="token operator">&lt;&lt;</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">fromExceptionCode</span><span class="token punctuation">(</span>Status<span class="token double-colon punctuation">::</span>EX_ILLEGAL_ARGUMENT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">VENDORSERVICEMANAGER</span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">meetsDeclarationRequirements</span><span class="token punctuation">(</span>binder<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// already logged</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">fromExceptionCode</span><span class="token punctuation">(</span>Status<span class="token double-colon punctuation">::</span>EX_ILLEGAL_ARGUMENT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// !VENDORSERVICEMANAGER</span></span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// implicitly unlinked when the binder is removed</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">// 为 binder 对象设置死亡代理</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	在和 service 进行交互时，service 返回一个 Binder 对象。</pre></td></tr><tr><td data-num="37"></td><td><pre>	Binder 是工作在 service 端，如果，由于某种原因，服务端出现故障而死亡，</pre></td></tr><tr><td data-num="38"></td><td><pre>	那么该返回的 Binder 对象也将消失，这时，如果我们在客户端在使用 Binder 对象</pre></td></tr><tr><td data-num="39"></td><td><pre>	进行某些函数调用将会出现错误。为了避免该情况的发生，我们可以为</pre></td></tr><tr><td data-num="40"></td><td><pre>	Binder 对象设置死亡代理 (linkToDeath)。当出现和服务端连接发生故障时，</pre></td></tr><tr><td data-num="41"></td><td><pre>	系统将自动调用死亡代理函数 binderDied ()。</pre></td></tr><tr><td data-num="42"></td><td><pre>	*/</pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>binder<span class="token operator">-></span><span class="token function">remoteBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        binder<span class="token operator">-></span><span class="token function">linkToDeath</span><span class="token punctuation">(</span><span class="token class-name">sp</span><span class="token operator">&lt;</span>ServiceManager<span class="token operator">></span><span class="token double-colon punctuation">::</span><span class="token function">fromExisting</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not linkToDeath when adding "</span> <span class="token operator">&lt;&lt;</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">fromExceptionCode</span><span class="token punctuation">(</span>Status<span class="token double-colon punctuation">::</span>EX_ILLEGAL_STATE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token comment">// Overwrite the old service if it exists</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token comment">// 添加服务，以 name 作为索引值，使用 binder 作为参数实例化 Service 对象</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    mNameToService<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> Service <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">.</span>binder <span class="token operator">=</span> binder<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">.</span>allowIsolated <span class="token operator">=</span> allowIsolated<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token punctuation">.</span>dumpPriority <span class="token operator">=</span> dumpPriority<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token punctuation">.</span>debugPid <span class="token operator">=</span> ctx<span class="token punctuation">.</span>debugPid<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>	<span class="token comment">/* 检查服务注册的合法性，包括</span></pre></td></tr><tr><td data-num="60"></td><td><pre>	1. 服务是否存在</pre></td></tr><tr><td data-num="61"></td><td><pre>	2. 该服务是否是服务端注册的</pre></td></tr><tr><td data-num="62"></td><td><pre>	3. 是否有同名服务存在</pre></td></tr><tr><td data-num="63"></td><td><pre>	4. 为该服务注册的死亡代理是否成功</pre></td></tr><tr><td data-num="64"></td><td><pre>	*/</pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">auto</span> it <span class="token operator">=</span> mNameToRegistrationCallback<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> mNameToRegistrationCallback<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IServiceCallback<span class="token operator">></span><span class="token operator">&amp;</span> cb <span class="token operator">:</span> it<span class="token operator">-></span>second<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            mNameToService<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>guaranteeClient <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token comment">// permission checked in registerForNotifications</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            cb<span class="token operator">-></span><span class="token function">onRegistration</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> binder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="总结-3"><a class="anchor" href="#总结-3">#</a> 总结</h2>
<p>Server 想要向 ServiceManager 注册服务，首先通过 <code>defaultServiceManager</code>  获取到一个 Service Manager 的代理对象，然后再调用它的成员函数 <code>addService</code>  将该 Service 组件注册到 Service Manager 中，该代理对象通过向 Binder 驱动设备发送 <code>BC_TRANSACTION</code>  信号和 <code>Service Manager</code>  通信，在 <code>Service Manager</code>  启动之后会进入一个阻塞的无限循环， <code>Service Manager</code>  通过 <code>BinderCallback</code>  回调函数处理 Binder 驱动设备返回的 <code>BR_TRANSACTION</code> , 调用 BBinder 的 transact 方法，这个方法将会把我们引到 BnServiceManager 的 onTransact () 方法，终于这个方法将我们带到了真正添加服务的方法<strong> ServiceManager.cpp::addService</strong>, 并向 <code>mNameToService</code>  字典中添加 <code>name: Service</code>  的键值对，来为 Client 向 ServiceManager 获取服务的过程做数据准备.</p>
<p><img data-src="/android-binder/1595250-20211114151811263-2017459210.png" alt="img" style="aspect-ratio:1241 / 601;"></p>
<h1 id="client向servicemanager获取服务"><a class="anchor" href="#client向servicemanager获取服务">#</a> Client 向 ServiceManager 获取服务</h1>
<p>这里以 <code>MediaServer</code>  为例来分析 Client 向 ServiceManager 获取服务的过程</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// android-platform\frameworks\av\media\libmedia\IMediaDeathNotifier.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// establish binder interface to MediaPlayerService</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/*static*/</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IMediaPlayerService<span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">IMediaDeathNotifier</span><span class="token double-colon punctuation">::</span><span class="token function">getMediaPlayerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"getMediaPlayerService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    Mutex<span class="token double-colon punctuation">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>sServiceLock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sMediaPlayerService <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        sp<span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span> sm <span class="token operator">=</span> <span class="token function">defaultServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> binder<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            binder <span class="token operator">=</span> sm<span class="token operator">-></span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token function">String16</span><span class="token punctuation">(</span><span class="token string">"media.player"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 核心函数，获取名为 media.player 的服务，因为在之前 Server 已经向 ServiceManager 注册过了</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>binder <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Media player service not published, waiting..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">500000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0.5 s 一个无限循环每 0.5 秒就获取一次服务，知道获取到权限</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sDeathNotifier <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            sDeathNotifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">DeathNotifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Service 死亡后创建死亡通知</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        binder<span class="token operator">-></span><span class="token function">linkToDeath</span><span class="token punctuation">(</span>sDeathNotifier<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        sMediaPlayerService <span class="token operator">=</span> <span class="token generic-function"><span class="token function">interface_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>IMediaPlayerService<span class="token operator">></span></span></span><span class="token punctuation">(</span>binder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token function">ALOGE_IF</span><span class="token punctuation">(</span>sMediaPlayerService <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"no media player service!?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">return</span> sMediaPlayerService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="servicemanagershimgetservice"><a class="anchor" href="#servicemanagershimgetservice">#</a> ServiceManagerShim::getService</h2>
<p>这里调用 <code>ServiceManagerShim::checkService</code>  来寻找以注册的服务</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\frameworks\native\libs\binder\IServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// This implementation could be simplified and made more efficient by delegating</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// to waitForService. However, this changes the threading structure in some</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// cases and could potentially break prebuilts. Once we have higher logistical</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// complexity, this could be attempted.</span></pre></td></tr><tr><td data-num="7"></td><td><pre>sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> <span class="token class-name">ServiceManagerShim</span><span class="token double-colon punctuation">::</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token keyword">const</span> String16<span class="token operator">&amp;</span> name<span class="token punctuation">)</span> <span class="token keyword">const</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">static</span> <span class="token keyword">bool</span> gSystemBootCompleted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> svc <span class="token operator">=</span> <span class="token function">checkService</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 检查一下指定的服务名称是否存在</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>svc <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token keyword">return</span> svc<span class="token punctuation">;</span><span class="token comment">// 找到了 直接返回</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token comment">//verder 进程服务获取逻辑，这里不做分析</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">bool</span> isVendorService <span class="token operator">=</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getDriverName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/dev/vndbinder"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">constexpr</span> <span class="token keyword">int64_t</span> timeout <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">int64_t</span> startTime <span class="token operator">=</span> <span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// Vendor code can't access system properties</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gSystemBootCompleted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isVendorService<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__ANDROID__</span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">char</span> bootCompleted<span class="token punctuation">[</span>PROPERTY_VALUE_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">"sys.boot_completed"</span><span class="token punctuation">,</span> bootCompleted<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        gSystemBootCompleted <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>bootCompleted<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>        gSystemBootCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// retry interval in millisecond; note that vendor services stay at 100ms</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">const</span> useconds_t sleepTime <span class="token operator">=</span> gSystemBootCompleted <span class="token operator">?</span> <span class="token number">1000</span> <span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Waiting for service '%s' on '%s'..."</span><span class="token punctuation">,</span> <span class="token function">String8</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>          <span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getDriverName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">&lt;</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        n<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">*</span>sleepTime<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>        sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> svc <span class="token operator">=</span> <span class="token function">checkService</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>svc <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"Waiting for service '%s' on '%s' successful after waiting %"</span> PRIi64 <span class="token string">"ms"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                  <span class="token function">String8</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getDriverName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                  <span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token keyword">return</span> svc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Service %s didn't start. Returning NULL"</span><span class="token punctuation">,</span> <span class="token function">String8</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="servicemanagershimcheckservice"><a class="anchor" href="#servicemanagershimcheckservice">#</a> ServiceManagerShim::checkService</h2>
<p>这里和<a href="#Server%E5%90%91ServiceManager%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1"> Server 向 ServiceManager 注册服务</a>一节开头中的形式一样，也是通过 <code>mTheRealServiceManager</code>  来执行核心的获取服务逻辑，对该变量的赋值于分析可参阅<a href="##mTheRealServiceManager"> mTheRealServiceManager</a></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> <span class="token class-name">ServiceManagerShim</span><span class="token double-colon punctuation">::</span><span class="token function">checkService</span><span class="token punctuation">(</span><span class="token keyword">const</span> String16<span class="token operator">&amp;</span> name<span class="token punctuation">)</span> <span class="token keyword">const</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mTheRealServiceManager<span class="token operator">-></span><span class="token function">checkService</span><span class="token punctuation">(</span><span class="token function">String8</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="bpservicemanagercheckservice"><a class="anchor" href="#bpservicemanagercheckservice">#</a> BpServiceManager::checkService</h2>
<p>同样的，我们需要从安卓框架编译之后的输入文件中找到由模板 aidl 生成的 <code>IServiceManager.cpp</code></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">///android-platform/out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_arm64_armv8-a_shared/gen/aidl/android/os/IServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">checkService</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">*</span> _aidl_return<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">//1. 写 interface</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">//2. 将要查询的 Service name 写入</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">// 借助 BpBinder (0)#transact 来发起 Binder 通信</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_checkService<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">checkService</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> _aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token punctuation">.</span><span class="token function">readNullableStrongBinder</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="bnservicemanagerontransact-2"><a class="anchor" href="#bnservicemanagerontransact-2">#</a> BnServiceManager::onTransact</h2>
<p>与 <code>Server向ServiceManager注册服务</code> 中相类似， <code>BpBinder(0)#transact</code>  来发起 Binder 通信后，BinderCallback 处理 Binder 驱动发送的 <code>BR_TRANSACTION</code>  信号，并交由 <code>IPCThreadState::self()-&gt;handlePolledCommands()</code>  来处理命令，最终来到由 aidl 生成的 <code>aidl/android/os/IServiceManager.cpp</code>  的 <code>BnServiceManager::onTransact</code>  去执行命令，与 ServiceManager 通过 Binder 通信</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t <span class="token class-name">BnServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> _aidl_code<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel<span class="token operator">&amp;</span> _aidl_data<span class="token punctuation">,</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel<span class="token operator">*</span> _aidl_reply<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> _aidl_flags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>_aidl_code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_checkService<span class="token operator">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string in_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span> _aidl_return<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token comment">// 写入要查询的名称</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token comment">// 调用真正的 ServiceManager.cpp 中的实现 addService</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">checkService</span><span class="token punctuation">(</span>in_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token operator">-></span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNEXPECTED_NULL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span><span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">fromExceptionCode</span><span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status<span class="token double-colon punctuation">::</span>EX_NULL_POINTER<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">return</span> _aidl_ret_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="servicemanagercheckservice"><a class="anchor" href="#servicemanagercheckservice">#</a> ServiceManager::checkService</h2>
<p>同样和 Bp 端是对称的操作，下一步走到 ServiceManager.cpp::checkService 方法中</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\cmds\servicemanager\ServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Status <span class="token class-name">ServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">checkService</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">*</span> outBinder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token operator">*</span>outBinder <span class="token operator">=</span> <span class="token function">tryGetService</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// returns ok regardless of result for legacy reasons</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="servicemanagertrygetservice"><a class="anchor" href="#servicemanagertrygetservice">#</a> ServiceManager::tryGetService</h2>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\cmds\servicemanager\ServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> <span class="token class-name">ServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">tryGetService</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">bool</span> startIfNotFound<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">auto</span> ctx <span class="token operator">=</span> mAccess<span class="token operator">-></span><span class="token function">getCallingContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span> out<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    Service<span class="token operator">*</span> service <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 调用 mNameToService.find 利用 id 查找 Service</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> mNameToService<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> mNameToService<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        service <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>it<span class="token operator">-></span>second<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>service<span class="token operator">-></span>allowIsolated<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            uid_t appid <span class="token operator">=</span> <span class="token function">multiuser_get_app_id</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">bool</span> isIsolated <span class="token operator">=</span> appid <span class="token operator">>=</span> AID_ISOLATED_START <span class="token operator">&amp;&amp;</span> appid <span class="token operator">&lt;=</span> AID_ISOLATED_END<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>isIsolated<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        out <span class="token operator">=</span> service<span class="token operator">-></span>binder<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mAccess<span class="token operator">-></span><span class="token function">canFind</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token comment">// 如果 Service 没有启动的话就尝试启动 Servicve</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out <span class="token operator">&amp;&amp;</span> startIfNotFound<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token function">tryStartService</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>out<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// Setting this guarantee each time we hand out a binder ensures that the client-checking</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">// loop knows about the event even if the client immediately drops the service</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        service<span class="token operator">-></span>guaranteeClient <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">return</span> out<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>而倘若我们深究 <code>mNameToService</code> , 它可以在 <code>ServiceManager.h</code>  找到定义</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform/frameworks/native/libs/fakeservicemanager/ServiceManager.h</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">ServiceManager</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">IServiceManager</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    std<span class="token double-colon punctuation">::</span>map<span class="token operator">&lt;</span>String16<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">>></span> mNameToService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span>  <span class="token comment">// namespace android</span></pre></td></tr></table></figure><p>这样一看原来查找的过程很简单，就是在一个 map 字典里找找是否含有这个键，如果有的话，就是查找成功了并且返回 <code>IBinder</code>  类型的值，添加向字典中添加键值的过程其实已经在注册服务的时候做好了</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//platform\frameworks\native\cmds\servicemanager\ServiceManager.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>Status <span class="token class-name">ServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> binder<span class="token punctuation">,</span> <span class="token keyword">bool</span> allowIsolated<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> dumpPriority<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// Overwrite the old service if it exists</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 添加服务，以 name 作为索引值，使用 binder 作为参数实例化 Service 对象</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    mNameToService<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> Service <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">.</span>binder <span class="token operator">=</span> binder<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">.</span>allowIsolated <span class="token operator">=</span> allowIsolated<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">.</span>dumpPriority <span class="token operator">=</span> dumpPriority<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">.</span>debugPid <span class="token operator">=</span> ctx<span class="token punctuation">.</span>debugPid<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token comment">/* 检查服务注册的合法性，包括</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	1. 服务是否存在</pre></td></tr><tr><td data-num="17"></td><td><pre>	2. 该服务是否是服务端注册的</pre></td></tr><tr><td data-num="18"></td><td><pre>	3. 是否有同名服务存在</pre></td></tr><tr><td data-num="19"></td><td><pre>	4. 为该服务注册的死亡代理是否成功</pre></td></tr><tr><td data-num="20"></td><td><pre>	*/</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">auto</span> it <span class="token operator">=</span> mNameToRegistrationCallback<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> mNameToRegistrationCallback<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IServiceCallback<span class="token operator">></span><span class="token operator">&amp;</span> cb <span class="token operator">:</span> it<span class="token operator">-></span>second<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            mNameToService<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>guaranteeClient <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token comment">// permission checked in registerForNotifications</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            cb<span class="token operator">-></span><span class="token function">onRegistration</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> binder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="总结-4"><a class="anchor" href="#总结-4">#</a> 总结</h2>
<p>Client 向 ServiceManager 获取服务的过程其实很简单，主要就是一个 map 字典查询的过程，值得注意的是，Client 与 ServiceManager 的通信也是通过 Binder 驱动进行的</p>
<h1 id="附录"><a class="anchor" href="#附录">#</a> 附录</h1>
<h2 id="安卓系统编译后由aidl生成的iservicemanagercpp"><a class="anchor" href="#安卓系统编译后由aidl生成的iservicemanagercpp">#</a> 安卓系统编译后由 aidl 生成的 IServiceManager.cpp</h2>
<p>编译系统版本:  <code>android-12.0.0_r34</code></p>
<p><code>platform/out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_arm64_armv8-a_shared/gen/aidl/android/os/IServiceManager.cpp</code></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/os/IServiceManager.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/os/BpServiceManager.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">namespace</span> android <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">namespace</span> os <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">DO_NOT_DIRECTLY_USE_ME_IMPLEMENT_META_INTERFACE</span><span class="token punctuation">(</span>ServiceManager<span class="token punctuation">,</span> <span class="token string">"android.os.IServiceManager"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span>  <span class="token comment">// namespace os</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span>  <span class="token comment">// namespace android</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/os/BpServiceManager.h></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/os/BnServiceManager.h></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;binder/Parcel.h></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android-base/macros.h></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">namespace</span> android <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">namespace</span> os <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">BpServiceManager</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> _aidl_impl<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token operator">:</span> <span class="token generic-function"><span class="token function">BpInterface</span><span class="token generic class-name"><span class="token operator">&lt;</span>IServiceManager<span class="token operator">></span></span></span><span class="token punctuation">(</span>_aidl_impl<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">*</span> _aidl_return<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_getService<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getService</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> _aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token punctuation">.</span><span class="token function">readNullableStrongBinder</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">checkService</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">*</span> _aidl_return<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_checkService<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">checkService</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> _aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token punctuation">.</span><span class="token function">readNullableStrongBinder</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="96"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> service<span class="token punctuation">,</span> <span class="token keyword">bool</span> allowIsolated<span class="token punctuation">,</span> <span class="token keyword">int32_t</span> dumpPriority<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeBool</span><span class="token punctuation">(</span>allowIsolated<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInt32</span><span class="token punctuation">(</span>dumpPriority<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_addService<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">addService</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> allowIsolated<span class="token punctuation">,</span> dumpPriority<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="141"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="144"></td><td><pre></pre></td></tr><tr><td data-num="145"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">listServices</span><span class="token punctuation">(</span><span class="token keyword">int32_t</span> dumpPriority<span class="token punctuation">,</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span><span class="token operator">*</span> _aidl_return<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInt32</span><span class="token punctuation">(</span>dumpPriority<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="157"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="158"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="159"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_listServices<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">listServices</span><span class="token punctuation">(</span>dumpPriority<span class="token punctuation">,</span> _aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="173"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token punctuation">.</span><span class="token function">readUtf8VectorFromUtf16Vector</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="174"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="176"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="177"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="178"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="179"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="180"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="181"></td><td><pre></pre></td></tr><tr><td data-num="182"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">registerForNotifications</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span>IServiceCallback<span class="token operator">></span><span class="token operator">&amp;</span> callback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="183"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="186"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="187"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="189"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="190"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="192"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="193"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="194"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="195"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="196"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span><span class="token class-name">IServiceCallback</span><span class="token double-colon punctuation">::</span><span class="token function">asBinder</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="198"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="199"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="200"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_registerForNotifications<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="201"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="202"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">registerForNotifications</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="203"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="204"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="205"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="206"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="207"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="208"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="209"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="210"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="211"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="212"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="213"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="214"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="215"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="216"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="217"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="218"></td><td><pre></pre></td></tr><tr><td data-num="219"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">unregisterForNotifications</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span>IServiceCallback<span class="token operator">></span><span class="token operator">&amp;</span> callback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="220"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="221"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="222"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="224"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="225"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="226"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="227"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="228"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="229"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="230"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="231"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="232"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="233"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span><span class="token class-name">IServiceCallback</span><span class="token double-colon punctuation">::</span><span class="token function">asBinder</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="234"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="235"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="236"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="237"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_unregisterForNotifications<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="238"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="239"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">unregisterForNotifications</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="240"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="241"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="242"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="243"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="244"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="245"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="246"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="247"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="248"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="249"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="250"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="251"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="252"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="253"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="254"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="255"></td><td><pre></pre></td></tr><tr><td data-num="256"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">isDeclared</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> _aidl_return<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="257"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="258"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="259"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="260"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="261"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="262"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="263"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="264"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="265"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="266"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="267"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="268"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="269"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="270"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_isDeclared<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="271"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="272"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">isDeclared</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> _aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="273"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="274"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="275"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="276"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="277"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="278"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="279"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="280"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="281"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="282"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="283"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="284"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token punctuation">.</span><span class="token function">readBool</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="285"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="286"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="287"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="288"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="289"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="290"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="291"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="292"></td><td><pre></pre></td></tr><tr><td data-num="293"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDeclaredInstances</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> iface<span class="token punctuation">,</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span><span class="token operator">*</span> _aidl_return<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="294"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="295"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="296"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="297"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="298"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="299"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="300"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="301"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="302"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="303"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>iface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="304"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="305"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="306"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="307"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_getDeclaredInstances<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="308"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="309"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getDeclaredInstances</span><span class="token punctuation">(</span>iface<span class="token punctuation">,</span> _aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="310"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="311"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="312"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="313"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="314"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="315"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="316"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="317"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="318"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="319"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="320"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="321"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token punctuation">.</span><span class="token function">readUtf8VectorFromUtf16Vector</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="322"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="323"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="324"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="325"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="326"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="327"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="328"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="329"></td><td><pre></pre></td></tr><tr><td data-num="330"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">updatableViaApex</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span><span class="token operator">*</span> _aidl_return<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="331"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="332"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="333"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="334"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="335"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="336"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="337"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="338"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="339"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="340"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="341"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="342"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="343"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="344"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_updatableViaApex<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="345"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="346"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">updatableViaApex</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> _aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="347"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="348"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="349"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="350"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="351"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="352"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="353"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="354"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="355"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="356"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="357"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="358"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="359"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="360"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="361"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="362"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="363"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="364"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="365"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="366"></td><td><pre></pre></td></tr><tr><td data-num="367"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">registerClientCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> service<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span>IClientCallback<span class="token operator">></span><span class="token operator">&amp;</span> callback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="368"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="369"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="370"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="371"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="372"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="373"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="374"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="375"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="376"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="377"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="378"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="379"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="380"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="381"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="382"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="383"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="384"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="385"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span><span class="token class-name">IClientCallback</span><span class="token double-colon punctuation">::</span><span class="token function">asBinder</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="386"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="387"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="388"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="389"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_registerClientCallback<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="390"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="391"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">registerClientCallback</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="392"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="393"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="394"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="395"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="396"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="397"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="398"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="399"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="400"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="401"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="402"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="403"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="404"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="405"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="406"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="407"></td><td><pre></pre></td></tr><tr><td data-num="408"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">tryUnregisterService</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span><span class="token operator">&amp;</span> service<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="409"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="410"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="411"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="412"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="413"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="414"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="415"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="416"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="417"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="418"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="419"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="420"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="421"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="422"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="423"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="424"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="425"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="426"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_tryUnregisterService<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="427"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="428"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">tryUnregisterService</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="429"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="430"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="431"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="432"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="433"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="434"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="435"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="436"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="437"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="438"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="439"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="440"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="441"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="442"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="443"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="444"></td><td><pre></pre></td></tr><tr><td data-num="445"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token class-name">BpServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getServiceDebugInfo</span><span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span>ServiceDebugInfo<span class="token operator">></span><span class="token operator">*</span> _aidl_return<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="446"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="447"></td><td><pre>  _aidl_data<span class="token punctuation">.</span><span class="token function">markForBinder</span><span class="token punctuation">(</span><span class="token function">remoteStrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="448"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel _aidl_reply<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="449"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="450"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="451"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span><span class="token function">getInterfaceDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="452"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="453"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="454"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="455"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> <span class="token function">remote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">transact</span><span class="token punctuation">(</span>BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_getServiceDebugInfo<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="456"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNKNOWN_TRANSACTION <span class="token operator">&amp;&amp;</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="457"></td><td><pre>     <span class="token keyword">return</span> <span class="token class-name">IServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">getDefaultImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getServiceDebugInfo</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="458"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="459"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="460"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="461"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="462"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">readFromParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="463"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="464"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="465"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="466"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="467"></td><td><pre>    <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="468"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="469"></td><td><pre>  _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token punctuation">.</span><span class="token function">readParcelableVector</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="470"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="471"></td><td><pre>    <span class="token keyword">goto</span> _aidl_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="472"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="473"></td><td><pre>  _aidl_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="474"></td><td><pre>  _aidl_status<span class="token punctuation">.</span><span class="token function">setFromStatusT</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="475"></td><td><pre>  <span class="token keyword">return</span> _aidl_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="476"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="477"></td><td><pre></pre></td></tr><tr><td data-num="478"></td><td><pre><span class="token punctuation">&#125;</span>  <span class="token comment">// namespace os</span></pre></td></tr><tr><td data-num="479"></td><td><pre></pre></td></tr><tr><td data-num="480"></td><td><pre><span class="token punctuation">&#125;</span>  <span class="token comment">// namespace android</span></pre></td></tr><tr><td data-num="481"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/os/BnServiceManager.h></span></span></pre></td></tr><tr><td data-num="482"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;binder/Parcel.h></span></span></pre></td></tr><tr><td data-num="483"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;binder/Stability.h></span></span></pre></td></tr><tr><td data-num="484"></td><td><pre></pre></td></tr><tr><td data-num="485"></td><td><pre><span class="token keyword">namespace</span> android <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="486"></td><td><pre></pre></td></tr><tr><td data-num="487"></td><td><pre><span class="token keyword">namespace</span> os <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="488"></td><td><pre></pre></td></tr><tr><td data-num="489"></td><td><pre><span class="token class-name">BnServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">BnServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="490"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="491"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>internal<span class="token double-colon punctuation">::</span><span class="token class-name">Stability</span><span class="token double-colon punctuation">::</span><span class="token function">markCompilationUnit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="492"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="493"></td><td><pre></pre></td></tr><tr><td data-num="494"></td><td><pre><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t <span class="token class-name">BnServiceManager</span><span class="token double-colon punctuation">::</span><span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> _aidl_code<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel<span class="token operator">&amp;</span> _aidl_data<span class="token punctuation">,</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>Parcel<span class="token operator">*</span> _aidl_reply<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> _aidl_flags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="495"></td><td><pre>  <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>status_t _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="496"></td><td><pre>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>_aidl_code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="497"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_getService<span class="token operator">:</span></pre></td></tr><tr><td data-num="498"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="499"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string in_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="500"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span> _aidl_return<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="501"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="502"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="503"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="504"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="505"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="506"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="507"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="508"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="509"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">getService</span><span class="token punctuation">(</span>in_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="510"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="511"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="512"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="513"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="514"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="515"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="516"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="517"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token operator">-></span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="518"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="519"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="520"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="521"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="522"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="523"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_checkService<span class="token operator">:</span></pre></td></tr><tr><td data-num="524"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="525"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string in_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="526"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span> _aidl_return<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="527"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="528"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="529"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="530"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="531"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="532"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="533"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="534"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="535"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">checkService</span><span class="token punctuation">(</span>in_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="536"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="537"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="538"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="539"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="540"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="541"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="542"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="543"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token operator">-></span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="544"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="545"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="546"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="547"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="548"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="549"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_addService<span class="token operator">:</span></pre></td></tr><tr><td data-num="550"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="551"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string in_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="552"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span> in_service<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="553"></td><td><pre>    <span class="token keyword">bool</span> in_allowIsolated<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="554"></td><td><pre>    <span class="token keyword">int32_t</span> in_dumpPriority<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="555"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="556"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="557"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="558"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="559"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="560"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="561"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="562"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="563"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_service<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="564"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="565"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="566"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="567"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readBool</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_allowIsolated<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="568"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="569"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="570"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="571"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_dumpPriority<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="572"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="573"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="574"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="575"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">addService</span><span class="token punctuation">(</span>in_name<span class="token punctuation">,</span> in_service<span class="token punctuation">,</span> in_allowIsolated<span class="token punctuation">,</span> in_dumpPriority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="576"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="577"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="578"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="579"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="580"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="581"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="582"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="583"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="584"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="585"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_listServices<span class="token operator">:</span></pre></td></tr><tr><td data-num="586"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="587"></td><td><pre>    <span class="token keyword">int32_t</span> in_dumpPriority<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="588"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span> _aidl_return<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="589"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="590"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="591"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="592"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="593"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_dumpPriority<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="594"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="595"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="596"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="597"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">listServices</span><span class="token punctuation">(</span>in_dumpPriority<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="598"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="599"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="600"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="601"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="602"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="603"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="604"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="605"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token operator">-></span><span class="token function">writeUtf8VectorAsUtf16Vector</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="606"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="607"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="608"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="609"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="610"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="611"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_registerForNotifications<span class="token operator">:</span></pre></td></tr><tr><td data-num="612"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="613"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string in_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="614"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span>IServiceCallback<span class="token operator">></span> in_callback<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="615"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="616"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="617"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="618"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="619"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="620"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="621"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="622"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="623"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_callback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="624"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="625"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="626"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="627"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">registerForNotifications</span><span class="token punctuation">(</span>in_name<span class="token punctuation">,</span> in_callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="628"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="629"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="630"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="631"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="632"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="633"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="634"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="635"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="636"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="637"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_unregisterForNotifications<span class="token operator">:</span></pre></td></tr><tr><td data-num="638"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="639"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string in_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="640"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span>IServiceCallback<span class="token operator">></span> in_callback<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="641"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="642"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="643"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="644"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="645"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="646"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="647"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="648"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="649"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_callback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="650"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="651"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="652"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="653"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">unregisterForNotifications</span><span class="token punctuation">(</span>in_name<span class="token punctuation">,</span> in_callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="654"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="655"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="656"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="657"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="658"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="659"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="660"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="661"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="662"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="663"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_isDeclared<span class="token operator">:</span></pre></td></tr><tr><td data-num="664"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="665"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string in_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="666"></td><td><pre>    <span class="token keyword">bool</span> _aidl_return<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="667"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="668"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="669"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="670"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="671"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="672"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="673"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="674"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="675"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">isDeclared</span><span class="token punctuation">(</span>in_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="676"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="677"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="678"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="679"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="680"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="681"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="682"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="683"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token operator">-></span><span class="token function">writeBool</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="684"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="685"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="686"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="687"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="688"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="689"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_getDeclaredInstances<span class="token operator">:</span></pre></td></tr><tr><td data-num="690"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="691"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string in_iface<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="692"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span> _aidl_return<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="693"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="694"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="695"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="696"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="697"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_iface<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="698"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="699"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="700"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="701"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">getDeclaredInstances</span><span class="token punctuation">(</span>in_iface<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="702"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="703"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="704"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="705"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="706"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="707"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="708"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="709"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token operator">-></span><span class="token function">writeUtf8VectorAsUtf16Vector</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="710"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="711"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="712"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="713"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="714"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="715"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_updatableViaApex<span class="token operator">:</span></pre></td></tr><tr><td data-num="716"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="717"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string in_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="718"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span> _aidl_return<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="719"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="720"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="721"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="722"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="723"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="724"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="725"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="726"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="727"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">updatableViaApex</span><span class="token punctuation">(</span>in_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="728"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="729"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="730"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="731"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="732"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="733"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="734"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="735"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token operator">-></span><span class="token function">writeUtf8AsUtf16</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="736"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="737"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="738"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="739"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="740"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="741"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_registerClientCallback<span class="token operator">:</span></pre></td></tr><tr><td data-num="742"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="743"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string in_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="744"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span> in_service<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="745"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span>IClientCallback<span class="token operator">></span> in_callback<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="746"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="747"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="748"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="749"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="750"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="751"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="752"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="753"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="754"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_service<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="755"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="756"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="757"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="758"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_callback<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="759"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="760"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="761"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="762"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">registerClientCallback</span><span class="token punctuation">(</span>in_name<span class="token punctuation">,</span> in_service<span class="token punctuation">,</span> in_callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="763"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="764"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="765"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="766"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="767"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="768"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="769"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="770"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="771"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="772"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_tryUnregisterService<span class="token operator">:</span></pre></td></tr><tr><td data-num="773"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="774"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>string in_name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="775"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>sp<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>IBinder<span class="token operator">></span> in_service<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="776"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="777"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="778"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="779"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="780"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="781"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="782"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="783"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="784"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_service<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="785"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="786"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="787"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="788"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">tryUnregisterService</span><span class="token punctuation">(</span>in_name<span class="token punctuation">,</span> in_service<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="789"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="790"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="791"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="792"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="793"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="794"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="795"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="796"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="797"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="798"></td><td><pre>  <span class="token keyword">case</span> BnServiceManager<span class="token double-colon punctuation">::</span>TRANSACTION_getServiceDebugInfo<span class="token operator">:</span></pre></td></tr><tr><td data-num="799"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="800"></td><td><pre>    <span class="token double-colon punctuation">::</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>os<span class="token double-colon punctuation">::</span>ServiceDebugInfo<span class="token operator">></span> _aidl_return<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="801"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_aidl_data<span class="token punctuation">.</span><span class="token function">checkInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="802"></td><td><pre>      _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>BAD_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="803"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="804"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="805"></td><td><pre>    <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">getServiceDebugInfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="806"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_status<span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="807"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="808"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="809"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="810"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_aidl_status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="811"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="812"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="813"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token operator">-></span><span class="token function">writeParcelableVector</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="814"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_aidl_ret_status<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="815"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="816"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="817"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="818"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="819"></td><td><pre>  <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="820"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="821"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span><span class="token class-name">BBinder</span><span class="token double-colon punctuation">::</span><span class="token function">onTransact</span><span class="token punctuation">(</span>_aidl_code<span class="token punctuation">,</span> _aidl_data<span class="token punctuation">,</span> _aidl_reply<span class="token punctuation">,</span> _aidl_flags<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="822"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="823"></td><td><pre>  <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="824"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="825"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>_aidl_ret_status <span class="token operator">==</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>UNEXPECTED_NULL<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="826"></td><td><pre>    _aidl_ret_status <span class="token operator">=</span> <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span><span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">fromExceptionCode</span><span class="token punctuation">(</span><span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>binder<span class="token double-colon punctuation">::</span>Status<span class="token double-colon punctuation">::</span>EX_NULL_POINTER<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeToParcel</span><span class="token punctuation">(</span>_aidl_reply<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="827"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="828"></td><td><pre>  <span class="token keyword">return</span> _aidl_ret_status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="829"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="830"></td><td><pre></pre></td></tr><tr><td data-num="831"></td><td><pre><span class="token punctuation">&#125;</span>  <span class="token comment">// namespace os</span></pre></td></tr><tr><td data-num="832"></td><td><pre></pre></td></tr><tr><td data-num="833"></td><td><pre><span class="token punctuation">&#125;</span>  <span class="token comment">// namespace android</span></pre></td></tr></table></figure><h1 id="参考资料"><a class="anchor" href="#参考资料">#</a> 参考资料</h1>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXR5dWFuLmNvbS8yMDE0LzAxLzAxL2JpbmRlci1nYWlzaHUv">gityuan 大佬的 Binder 系列</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2MueW9ueW91Y2xvdWQuY29tL2RvYy93aWtpL3Byb2plY3QvZGVlcC1hbmRyb2lkLXYxL2JpbmRlci5odG1sIzA3ZjcwNTE0YmIzODhkYmUyYTFmYzJjYmU3ZGNmZGM4">第 6 章 深入理解 Binder</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vd2FuZ2hvbmd6aHUvcC8xNTU1MTk3OC5odG1s">Android 12 系统源码分析 | Native Binder 代码变迁 </span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaW5ub3N0L2FyY2hpdmUvMjAxMS8wMS8wOS8xOTMxNDU2Lmh0bWw=">Android 深入浅出之 Binder 机制 </span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaGVsbG9raXR0eTIvcC8xNTA4ODI2NS5odG1s">理解 Android Binder 机制 (2/3)：C++ 层</span></li>
</ul>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2025-04-09 02:55:11" itemprop="dateModified" datetime="2025-04-09T02:55:11+08:00">2025-04-09</time>
  </span>
  <span id="android-binder/" class="item leancloud_visitors" data-flag-title="android binder源码分析" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>oacia <i class="ic i-at"><em>@</em></i>oaciaのBbBlog~
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://oacia.dev/android-binder/" title="android binder源码分析">https://oacia.dev/android-binder/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/android-platform-compile/" itemprop="url" rel="prev" data-background-image="&#x2F;picture&#x2F;317953.webp" title="pixel3安卓系统编译及刷入过程记录">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>pixel3安卓系统编译及刷入过程记录</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/ollvm-study/" itemprop="url" rel="next" data-background-image="&#x2F;picture&#x2F;756071.webp" title="ollvm三种混淆模式的反混淆思路">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>ollvm三种混淆模式的反混淆思路</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-text"> 说明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#binder%E7%AE%80%E4%BB%8B"><span class="toc-text"> Binder 简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#binder%E8%AE%BE%E5%A4%87%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="toc-text"> Binder 设备的初始化过程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#binder%E8%AE%BE%E5%A4%87%E6%96%87%E4%BB%B6%E7%9A%84%E6%89%93%E5%BC%80%E8%BF%87%E7%A8%8B"><span class="toc-text"> Binder 设备文件的打开过程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#binder%E8%AE%BE%E5%A4%87%E6%96%87%E4%BB%B6%E7%9A%84%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E8%BF%87%E7%A8%8B"><span class="toc-text"> Binder 设备文件的内存映射过程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#binder%E8%AE%BE%E5%A4%87%E6%96%87%E4%BB%B6%E7%9A%84ioctl"><span class="toc-text"> binder 设备文件的 ioctl</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#binder%E5%86%85%E9%83%A8%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE"><span class="toc-text"> Binder 内部通信协议</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9E%8B"><span class="toc-text"> 通信模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B"><span class="toc-text"> 通信过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bc_protocol"><span class="toc-text"> BC_PROTOCOL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#binder_work"><span class="toc-text"> binder_work</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#br_protocol"><span class="toc-text"> BR_PROTOCOL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AE%E8%BD%AC%E6%8D%A2%E5%9B%BE"><span class="toc-text"> 协议转换图</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#servicemanager%E4%BB%8B%E7%BB%8D"><span class="toc-text"> ServiceManager 介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#servicemanager%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="toc-text"> ServiceManager 的启动过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#processstateinit"><span class="toc-text"> ProcessState::init</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#processstate%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="toc-text"> ProcessState 构造函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#open_driver"><span class="toc-text"> open_driver</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#binder%E4%B8%AD%E5%90%84%E4%B8%AA%E7%B1%BB%E7%9A%84%E5%90%AB%E4%B9%89"><span class="toc-text"> Binder 中各个类的含义</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#servicemanager%E7%9A%84%E8%8E%B7%E5%8F%96%E8%BF%87%E7%A8%8B"><span class="toc-text"> ServiceManager 的获取过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#getcontextobject"><span class="toc-text"> getContextObject</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#interface_cast"><span class="toc-text"> interface_cast</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#server%E5%90%91servicemanager%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1"><span class="toc-text"> Server 向 ServiceManager 注册服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#defaultservicemanager-addservice"><span class="toc-text"> defaultServiceManager()-&gt;addService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mtherealservicemanager"><span class="toc-text"> mTheRealServiceManager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bindercallback"><span class="toc-text"> BinderCallback</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ipcthreadstatehandlepolledcommands"><span class="toc-text"> IPCThreadState::handlePolledCommands</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ipcthreadstategetandexecutecommand"><span class="toc-text"> IPCThreadState::getAndExecuteCommand</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ipcthreadstateexecutecommand"><span class="toc-text"> IPCThreadState::executeCommand</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ipcthreadstatesetthecontextobject"><span class="toc-text"> IPCThreadState::setTheContextObject</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bbindertransact"><span class="toc-text"> BBinder::transact</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bnservicemanagerontransact"><span class="toc-text"> BnServiceManager::onTransact</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#servicemanageraddservice"><span class="toc-text"> ServiceManager::addService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-3"><span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#client%E5%90%91servicemanager%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1"><span class="toc-text"> Client 向 ServiceManager 获取服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#servicemanagershimgetservice"><span class="toc-text"> ServiceManagerShim::getService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#servicemanagershimcheckservice"><span class="toc-text"> ServiceManagerShim::checkService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bpservicemanagercheckservice"><span class="toc-text"> BpServiceManager::checkService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bnservicemanagerontransact-2"><span class="toc-text"> BnServiceManager::onTransact</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#servicemanagercheckservice"><span class="toc-text"> ServiceManager::checkService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#servicemanagertrygetservice"><span class="toc-text"> ServiceManager::tryGetService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-4"><span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-text"> 附录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E7%BC%96%E8%AF%91%E5%90%8E%E7%94%B1aidl%E7%94%9F%E6%88%90%E7%9A%84iservicemanagercpp"><span class="toc-text"> 安卓系统编译后由 aidl 生成的 IServiceManager.cpp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text"> 参考资料</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="oacia"
      data-src="/images/avatar.jpg">
  
  <svg class="logo-overview" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 540.19 380.99">
    <g id="clips" fill= #00a99d; stroke="none">
      <clipPath id="o">
        <path d="M93.57,284c8,0,14.91-1,20.75-3,5.83-2,10.41-3.66,13.75-5,4.66-1.66,6.16-.75,4.5,2.75-1.67,3.5-4.67,6.42-9,8.75-2.34,1.34-6.09,2.84-11.25,4.5-5.17,1.67-11.09,2.5-17.75,2.5-.34,8.67-3.34,16.84-9,24.5-5.67,7.67-13.34,13.34-23,17-6,2.34-12.17,3.59-18.5,3.75-6.34,.17-12.17-.66-17.5-2.5-5.34-1.83-10.09-4.66-14.25-8.5-4.17-3.83-7.25-8.41-9.25-13.75-2-5.33-2.83-11-2.5-17s1.83-11.83,4.5-17.5c2.66-5.66,6.33-10.75,11-15.25,4.66-4.5,10.16-7.75,16.5-9.75,5.66-1.66,11.41-1.66,17.25,0,5.83,1.67,10.08,4.34,12.75,8,1.66,2.67,2.5,5.67,2.5,9,3-2,6.33-3,10-3h1c3.33,0,6.5,.84,9.5,2.5,3,1.67,5.33,4.5,7,8.5l1,3.5Zm-34,39.5c5.66-.66,10.33-3.83,14-9.5,3.66-5.66,5.33-12.16,5-19.5-4.67,.34-9.09-.41-13.25-2.25-4.17-1.83-6.42-4.58-6.75-8.25-.67-3,0-5.5,2-7.5-.67-2.66-2.75-5-6.25-7s-7.09-2.16-10.75-.5c-4.67,2-8.25,5.84-10.75,11.5-2.5,5.67-3.09,11.84-1.75,18.5,1.33,8,4.75,14.34,10.25,19,5.5,4.67,11.58,6.5,18.25,5.5Z"/>
      </clipPath>
      <clipPath id="a1">
        <path d="M176.06,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      <clipPath id="c">
        <path d="M250.06,280.5c4.66-7.66,12-13.16,22-16.5,10-3.33,19.83-3.66,29.5-1,7.66,2.34,13.5,5.67,17.5,10,4,4.34,5.83,8.5,5.5,12.5-.34,4.67-2.25,8.59-5.75,11.75-3.5,3.17-7.09,5.34-10.75,6.5-3.67,1.17-6.84,1.25-9.5,.25-2.67-1-3.34-3.16-2-6.5,2.66-8,2.75-14.58,.25-19.75-2.5-5.16-5.92-6.41-10.25-3.75-2.67,1.67-5,4.09-7,7.25-2,3.17-3.5,6.75-4.5,10.75s-1.42,8.09-1.25,12.25c.16,4.17,.75,7.92,1.75,11.25,1.33,4,3.66,7.42,7,10.25,3.33,2.84,7.16,4.67,11.5,5.5,4.33,.84,8.91,.67,13.75-.5,4.83-1.16,9.25-3.75,13.25-7.75,7.33-6.66,12.33-14.33,15-23,.33-1.66,1.16-2.91,2.5-3.75,1.33-.83,2.5-1.08,3.5-.75,1,.34,1.83,1.09,2.5,2.25,.66,1.17,.66,2.92,0,5.25-2.34,9.34-6.34,17-12,23-4.67,5.67-10.5,10.42-17.5,14.25-7,3.84-14.25,6.09-21.75,6.75-7.5,.67-14.84-.33-22-3-7.17-2.66-13.25-7.5-18.25-14.5-6-8.66-8.75-17.66-8.25-27,.5-9.33,2.25-16.66,5.25-22Z"/>
      </clipPath>
      <clipPath id="i_b">
        <path d="M393.06,330c-2.34,2.67-5.17,5.09-8.5,7.25-3.34,2.17-7.09,3.59-11.25,4.25-4.17,.67-8.59,.67-13.25,0-4.67-.66-9.17-2.33-13.5-5-4.67-2.66-7.67-7.58-9-14.75-1.34-7.16-1.83-14.66-1.5-22.5,.33-7.83,1.33-14.91,3-21.25,1.66-6.33,3.33-10.16,5-11.5,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,3.59,1.25,6.75-.17,3.17-.5,6.92-1,11.25-.5,4.34-1.09,8.92-1.75,13.75-.67,4.84-.67,9.42,0,13.75,.33,3.67,1.33,6.42,3,8.25,1.66,1.84,3.5,2.84,5.5,3,2,.17,4-.25,6-1.25s3.83-2.33,5.5-4c3-3.66,5.66-7.66,8-12,2.33-4.33,4.16-8.16,5.5-11.5,1-3.66,2.91-5.25,5.75-4.75,2.83,.5,3.75,3.09,2.75,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.34,8.59-10,14.25Z"/>
      </clipPath>
      <clipPath id="a2">
        <path d="M461.56,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      
    </g>
    <g
      id="strokes"
      fill="none"
      stroke=#96d7f5
      stroke-linecap="round"
      stroke-linejoin="round"
    >
    <path
    clip-path="url(#o)"
    class="oPath path"
    d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
    stroke-width="32.5"
    ></path>
    <path
      clip-path="url(#a1)"
      class="a1Path path"
      d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
      stroke-width="59"
    ></path>
    <path
      clip-path="url(#c)"
      class="cPath path"
      d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
      stroke-width="110"
    ></path>
    <path
      clip-path="url(#i_b)"
      class="i_bPath path"
      d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
      stroke-width="33"
    ></path>
    <path
      clip-path="url(#a2)"
      class="a2Path path"
      d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
      stroke-width="70"
    ></path>
    </g>
    <g
      id="strokes2"
      fill="none"
      stroke=#ff97b8
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path
        clip-path="url(#o)"
        class="oPath path"
        d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
        stroke-width="32.5"
      ></path>
      <path
        clip-path="url(#a1)"
        class="a1Path path"
        d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
        stroke-width="59"
      ></path>
      <path
        clip-path="url(#c)"
        class="cPath path"
        d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
        stroke-width="110"
      ></path>
      <path
        clip-path="url(#i_b)"
        class="i_bPath path"
        d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
        stroke-width="33"
      ></path>
      <path
        clip-path="url(#a2)"
        class="a2Path path"
        d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
        stroke-width="70"
      ></path>
    </g>
    <g class="dot-group">
      <path
        id="dot"
        fill=#ff97b8
        d="M362.58,182.21c4.66-.33,9.66,1.17,15,4.5,5.33,3.34,7.66,7.5,7,12.5-.67,2.34-1.92,4.92-3.75,7.75-1.84,2.84-4,5.5-6.5,8s-4.84,4.75-7,6.75c-2.17,2-3.75,3.17-4.75,3.5-2.67,1.67-5.34,2.25-8,1.75-2.67-.5-5-1.5-7-3s-3.59-3.33-4.75-5.5c-1.17-2.16-1.92-4.25-2.25-6.25-.34-2,.16-4.66,1.5-8,1.33-3.33,3.08-6.58,5.25-9.75,2.16-3.16,4.58-6,7.25-8.5,2.66-2.5,5.33-3.75,8-3.75Z"
      ></path>
    </g>
  </svg>
  <div class="description" itemprop="description">月遇从云 花遇和风</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">53</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">46</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lh" title="https:&#x2F;&#x2F;github.com&#x2F;oacia"><i class="ic i-github"></i></span>
      <a target="_blank" rel="noopener" href="https://twitter.com/oacia86" title="https:&#x2F;&#x2F;twitter.com&#x2F;oacia86" class="item twitter"><i class="ic i-twitter"></i></a>
      <span class="exturl item paper-plane" data-url="aHR0cHM6Ly90Lm1lL29hY2lh" title="https:&#x2F;&#x2F;t.me&#x2F;oacia"><i class="ic i-paper-plane"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOm9hY2lhODZAZ21haWwuY29t" title="mailto:oacia86@gmail.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about-oacia/" rel="section"><i class="ic i-user"></i>关于oacia</a>
  </li>

    
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-feather"></i>文章</a>
  </li>

    
  <li class="item">
    <a href="/TODOlist/" rel="section"><i class="ic i-clock"></i>要做的事</a>
  </li>

    
  <li class="item">
    <a href="/website_maintenance/" rel="section"><i class="ic i-calendar"></i>更新日志</a>
  </li>

    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>小伙伴</a>
  </li>

    
  <li class="item">
    <a href="/music/" rel="section"><i class="ic i-music"></i>听会儿歌吧</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/android-platform-compile/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/ollvm-study/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2022 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">oacia @ oacia</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">968k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">14:40</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>



<script data-config type="text/javascript">
  var LOCAL = {
    path: 'android-binder/',
    favicon: {
      show: "柚鳥ナツ",
      hide: "甘い幸せ"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>
<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>


<script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>
<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
