



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="qQVmgWozVe7BXoA15J3gAZpEA5dK168admH4U3W6PAk">
  <meta name="msvalidate.01" content="4902E39C0135E72DE537BCB0FE08B40A">
  <meta name="baidu-site-verification" content="codeva-CSYjpuVg5v">


<link rel="alternate" type="application/rss+xml" title="oaciaのBbBlog~" href="https://oacia.dev/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="oaciaのBbBlog~" href="https://oacia.dev/atom.xml" />
<link rel="alternate" type="application/json" title="oaciaのBbBlog~" href="https://oacia.dev/feed.json" />
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-regular.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-700.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/font_1832207_igi8uaupcus.woff2"
/>
<link rel="preload" href="/background_picture/1_gongzi.webp" as="image" />
<link rel="preload" href="/background_picture/2_xiaoxia.webp" as="image" />
<link rel="preload" href="/background_picture/3_xingye.webp" as="image" />
<link rel="preload" href="/images/avatar.jpg" as="image" />



<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="https://oacia.dev/douyin-6shen-init/">


<meta name="description" content="# 前言 抖音六神算法，一听这名字就超 cooool 的，正好最近也没有什么别的事情，于是就趁着周末来逆一逆抖音 APP, 在分析六神算法的过程中，它的 java 层的字符串加密算法我感觉很有意思，于是就写了这篇文章来记录一下～ 本文所分析的抖音版本为 300600 # ssl pinning 绕过 打开 app 之后用 repable 抓包，抖音直接显示无网络，所以想都不用想，肯定是有 ssl">
<meta property="og:type" content="article">
<meta property="og:title" content="初探抖音六神之字符串解密算法分析">
<meta property="og:url" content="https://oacia.dev/douyin-6shen-init/">
<meta property="og:site_name" content="oaciaのBbBlog~">
<meta property="og:description" content="# 前言 抖音六神算法，一听这名字就超 cooool 的，正好最近也没有什么别的事情，于是就趁着周末来逆一逆抖音 APP, 在分析六神算法的过程中，它的 java 层的字符串加密算法我感觉很有意思，于是就写了这篇文章来记录一下～ 本文所分析的抖音版本为 300600 # ssl pinning 绕过 打开 app 之后用 repable 抓包，抖音直接显示无网络，所以想都不用想，肯定是有 ssl">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240801003621820.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240801004717078.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240801004045357.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240801010106216.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818142610556.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818142932419.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818143106335.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818143547405.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818144352514.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818162150793.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240817210246836.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240805011945451.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240805010232627.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240805010341218.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240805010451682.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240814001314102.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240814001439387.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240814211204858.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240815220549586.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240815230204317.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240815230400591.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240815230857961.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240816200219287.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240816201801046.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240816205135003.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240816213750249.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240816214140057.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240816215710033.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240816215930992.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240816221230480.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240816222440542.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818165242631.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818165608816.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818165636201.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818165937173.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818165957226.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818172219054.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818172227363.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240820010529912.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240818172235640.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240820010457580.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240820010508273.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240820014135813.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240820021932419.png">
<meta property="og:image" content="https://oacia.dev/douyin-6shen-init/image-20240820022014949.png">
<meta property="article:published_time" content="2024-08-20T13:52:00.000Z">
<meta property="article:modified_time" content="2025-04-08T18:55:11.505Z">
<meta property="article:author" content="oacia">
<meta property="article:tag" content="reverse,安卓逆向,区块链,学习笔记,破解实战,前端,CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oacia.dev/douyin-6shen-init/image-20240801003621820.png">
<meta name="twitter:creator" content="@oacia86">


  <title>
初探抖音六神之字符串解密算法分析 |
oacia = oaciaのBbBlog~ = DEVIL or SWEET</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  var jq_151 = $.noConflict(true);
  var RENDERER = {
    INIT_CHERRY_BLOSSOM_COUNT : 30,
    MAX_ADDING_INTERVAL : 10,
    WATCH_INTERVAL : 300,
    
    init : function(){
      this.setParameters();
      this.reconstructMethods();
      this.setup();
      this.bindEvent();
      this.render();
    },
    setParameters : function(){
      this.$window = jq_151(window);
      this.$container = jq_151('#loading');
      this.$canvas = jq_151('<canvas />');
      this.context = this.$canvas.appendTo(this.$container).get(0).getContext('2d');
      this.cherries = [];
      this.watchIds = [];
    },
    reconstructMethods : function(){
      this.watchWindowSize = this.watchWindowSize.bind(this);
      this.jdugeToStopResize = this.jdugeToStopResize.bind(this);
      this.render = this.render.bind(this);
    },
    setup : function(){
      this.cherries.length = 0;
      this.watchIds.length = 0;
      this.width = this.$container.width();
      this.height = this.$container.height();
      this.$canvas.attr({width : this.width, height : this.height});
      this.maxAddingInterval = Math.round(this.MAX_ADDING_INTERVAL * 1000 / this.width);
      this.addingInterval = this.maxAddingInterval;
      this.createCherries();
    },
    createCherries : function(){
      for(var i = 0, length = Math.round(this.INIT_CHERRY_BLOSSOM_COUNT * this.width / 1000); i < length; i++){
        this.cherries.push(new CHERRY_BLOSSOM(this, true));
      }
    },
    watchWindowSize : function(){
      this.clearTimer();
      this.tmpWidth = window.width;
      this.tmpHeight = window.height;
      this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL));
    },
    clearTimer : function(){
      while(this.watchIds.length > 0){
        clearTimeout(this.watchIds.pop());
      }
    },
    jdugeToStopResize : function(){
      var width = window.width,
        height = window.height,
        stopped = (width == this.tmpWidth && height == this.tmpHeight);
        
      this.tmpWidth = width;
      this.tmpHeight = height;
      
      if(stopped){
        this.setup();
      }
    },
    bindEvent : function(){
      this.$window.on('resize', this.watchWindowSize);
    },
    render : function(){
      //console.log("render")

      if(jq_151(this.$container).css("display")!="none"){
        requestAnimationFrame(this.render);
      }
      
      this.context.clearRect(0, 0, this.width, this.height);
      
      this.cherries.sort(function(cherry1, cherry2){
        return cherry1.z - cherry2.z;
      });
      for(var i = this.cherries.length - 1; i >= 0; i--){
        if(!this.cherries[i].render(this.context)){
          this.cherries.splice(i, 1);
        }
      }
      if(--this.addingInterval == 0){
        this.addingInterval = this.maxAddingInterval;
        this.cherries.push(new CHERRY_BLOSSOM(this, false));
      }
    }
  };
  var CHERRY_BLOSSOM = function(renderer, isRandom){
    this.renderer = renderer;
    this.init(isRandom);
  };
  CHERRY_BLOSSOM.prototype = {
    FOCUS_POSITION : 300,
    FAR_LIMIT : 600,
    MAX_RIPPLE_COUNT : 100,
    RIPPLE_RADIUS : 100,
    SURFACE_RATE : 0.5,
    SINK_OFFSET : 20,
    
    init : function(isRandom){
      this.x = this.getRandomValue(-this.renderer.width, this.renderer.width);
      this.y = isRandom ? this.getRandomValue(0, this.renderer.height) : this.renderer.height * 1.5;
      this.z = this.getRandomValue(0, this.FAR_LIMIT);
      this.vx = this.getRandomValue(-2, 2);
      this.vy = -2;
      this.theta = this.getRandomValue(0, Math.PI * 2);
      this.phi = this.getRandomValue(0, Math.PI * 2);
      this.psi = 0;
      this.dpsi = this.getRandomValue(Math.PI / 600, Math.PI / 300);
      this.opacity = 0;
      this.endTheta = false;
      this.endPhi = false;
      this.rippleCount = 0;
      
      var axis = this.getAxis(),
        theta = this.theta + Math.ceil(-(this.y + this.renderer.height * this.SURFACE_RATE) / this.vy) * Math.PI / 500;
      theta %= Math.PI * 2;
      
      this.offsetY = 40 * ((theta <= Math.PI / 2 || theta >= Math.PI * 3 / 2) ? -1 : 1);
      this.thresholdY = this.renderer.height / 2 + this.renderer.height * this.SURFACE_RATE * axis.rate;
      this.entityColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.entityColor.addColorStop(0, 'hsl(330, 70%, ' + 50 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(0.05, 'hsl(330, 40%,' + 55 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(1, 'hsl(330, 20%, ' + 70 * (0.3 + axis.rate) + '%)');
      this.shadowColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.shadowColor.addColorStop(0, 'hsl(330, 40%, ' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(0.05, 'hsl(330, 40%,' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(1, 'hsl(330, 20%, ' + 40 * (0.3 + axis.rate) + '%)');
    },
    getRandomValue : function(min, max){
      return min + (max - min) * Math.random();
    },
    getAxis : function(){
      var rate = this.FOCUS_POSITION / (this.z + this.FOCUS_POSITION),
        x = this.renderer.width / 2 + this.x * rate,
        y = this.renderer.height / 2 - this.y * rate;
      return {rate : rate, x : x, y : y};
    },
    renderCherry : function(context, axis){
      context.beginPath();
      context.moveTo(0, 40);
      context.bezierCurveTo(-60, 20, -10, -60, 0, -20);
      context.bezierCurveTo(10, -60, 60, 20, 0, 40);
      context.fill();
      
      for(var i = -4; i < 4; i++){
        context.beginPath();
        context.moveTo(0, 40);
        context.quadraticCurveTo(i * 12, 10, i * 4, -24 + Math.abs(i) * 2);
        context.stroke();
      }
    },
    render : function(context){
      var axis = this.getAxis();
      
      if(axis.y == this.thresholdY && this.rippleCount < this.MAX_RIPPLE_COUNT){
        context.save();
        context.lineWidth = 2;
        context.strokeStyle = 'hsla(0, 0%, 100%, ' + (this.MAX_RIPPLE_COUNT - this.rippleCount) / this.MAX_RIPPLE_COUNT + ')';
        context.translate(axis.x + this.offsetY * axis.rate * (this.theta <= Math.PI ? -1 : 1), axis.y);
        context.scale(1, 0.3);
        context.beginPath();
        context.arc(0, 0, this.rippleCount / this.MAX_RIPPLE_COUNT * this.RIPPLE_RADIUS * axis.rate, 0, Math.PI * 2, false);
        context.stroke();
        context.restore();
        this.rippleCount++;
      }
      if(axis.y < this.thresholdY || (!this.endTheta || !this.endPhi)){
        if(this.y <= 0){
          this.opacity = Math.min(this.opacity + 0.01, 1);
        }
        context.save();
        context.globalAlpha = this.opacity;
        context.fillStyle = this.shadowColor;
        context.strokeStyle = 'hsl(330, 30%,' + 40 * (0.3 + axis.rate) + '%)';
        context.translate(axis.x, Math.max(axis.y, this.thresholdY + this.thresholdY - axis.y));
        context.rotate(Math.PI - this.theta);
        context.scale(axis.rate * -Math.sin(this.phi), axis.rate);
        context.translate(0, this.offsetY);
        this.renderCherry(context, axis);
        context.restore();
      }
      context.save();
      context.fillStyle = this.entityColor;
      context.strokeStyle = 'hsl(330, 40%,' + 70 * (0.3 + axis.rate) + '%)';
      context.translate(axis.x, axis.y + Math.abs(this.SINK_OFFSET * Math.sin(this.psi) * axis.rate));
      context.rotate(this.theta);
      context.scale(axis.rate * Math.sin(this.phi), axis.rate);
      context.translate(0, this.offsetY);
      this.renderCherry(context, axis);
      context.restore();
      
      if(this.y <= -this.renderer.height / 4){
        if(!this.endTheta){
          for(var theta = Math.PI / 2, end = Math.PI * 3 / 2; theta <= end; theta += Math.PI){
            if(this.theta < theta && this.theta + Math.PI / 200 > theta){
              this.theta = theta;
              this.endTheta = true;
              break;
            }
          }
        }
        if(!this.endPhi){
          for(var phi = Math.PI / 8, end = Math.PI * 7 / 8; phi <= end; phi += Math.PI * 3 / 4){
            if(this.phi < phi && this.phi + Math.PI / 200 > phi){
              this.phi = Math.PI / 8;
              this.endPhi = true;
              break;
            }
          }
        }
      }
      if(!this.endTheta){
        if(axis.y == this.thresholdY){
          this.theta += Math.PI / 200 * ((this.theta < Math.PI / 2 || (this.theta >= Math.PI && this.theta < Math.PI * 3 / 2)) ? 1 : -1);
        }else{
          this.theta += Math.PI / 500;
        }
        this.theta %= Math.PI * 2;
      }
      if(this.endPhi){
        if(this.rippleCount == this.MAX_RIPPLE_COUNT){
          this.psi += this.dpsi;
          this.psi %= Math.PI * 2;
        }
      }else{
        this.phi += Math.PI / ((axis.y == this.thresholdY) ? 200 : 500);
        this.phi %= Math.PI;
      }
      if(this.y <= -this.renderer.height * this.SURFACE_RATE){
        this.x += 2;
        this.y = -this.renderer.height * this.SURFACE_RATE;
      }else{
        this.x += this.vx;
        this.y += this.vy;
      }
      return this.z > -this.FOCUS_POSITION && this.z < this.FAR_LIMIT && this.x < this.renderer.width * 1.5;
    }
  };
  jq_151(function(){
    RENDERER.init();
  });
</script>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <!--
    <div class="alice">
      <img src="/images/alice-shake.gif" alt="">
    </div>

    
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
    -->
  </div>
  <script
      defer="defer"
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"
      integrity="sha512-1dalHDkG9EtcOmCnoCjiwQ/HEB5SDNqw8d4G2MKoNwjiwMNeBAkudsBCmSlMnXdsH8Bm0mOd3tl/6nL5y0bMaQ=="
      crossorigin="anonymous"
    ></script>
  <script defer="defer" src="/js/gsap/DrawSVGPlugin.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomEase.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomBounce.min.js"></script>
  <script defer="defer" src="/js/gsap/SplitText.min.js"></script>
  <script defer="defer" src="/js/gsap/logo-run.js"></script>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">初探抖音六神之字符串解密算法分析
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2024-08-20 21:52:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2024-08-20T21:52:00+08:00">2024-08-20</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>17k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>15 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">oacia</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="/background_picture/1_mary.jpg"></li>
          <li class="item" data-background-image="/background_picture/2_xingye.webp"></li>
          <li class="item" data-background-image="/background_picture/3_xiaoxia.webp"></li>
          <li class="item" data-background-image="/background_picture/4_alice.webp"></li>
          <li class="item" data-background-image="/background_picture/5_mutsuki.jpg"></li>
          <li class="item" data-background-image="/background_picture/6_arona_plana.webp"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb">
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://oacia.dev/douyin-6shen-init/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="oacia">
    <meta itemprop="description" content="DEVIL or SWEET, 月遇从云 花遇和风">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="oaciaのBbBlog~">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="前言"><a class="anchor" href="#前言">#</a> 前言</h1>
<p>抖音六神算法，一听这名字就超 cooool 的，正好最近也没有什么别的事情，于是就趁着周末来逆一逆抖音 APP, 在分析六神算法的过程中，它的 java 层的字符串加密算法我感觉很有意思，于是就写了这篇文章来记录一下～</p>
<p>本文所分析的抖音版本为 <code>300600</code></p>
<h1 id="ssl-pinning绕过"><a class="anchor" href="#ssl-pinning绕过">#</a> ssl pinning 绕过</h1>
<p>打开 app 之后用 repable 抓包，抖音直接显示无网络，所以想都不用想，肯定是有 ssl pinning，但是常规的过 ssl pinning 的代码没有用，因为抖音和其他 app 不一样，它的 ssl 校验是在 native 层的</p>
<p>hook apk 打开的 so 库，一般网络库的加载都是在最前面的，在 <code>libsscronet.so</code>  找到 ssl 相关的函数</p>
<p><img data-src="/douyin-6shen-init/image-20240801003621820.png" alt="image-20240801003621820" style="aspect-ratio:2066 / 1065;"></p>
<p>这一块应该是在 so 中用自定义的函数去进行 ssl 的验证</p>
<p>搜索字符串发现有很多 <code>certificate</code> , 那大概率就是在这个 so 里面进行 <code>ssl pinning</code>  的</p>
<p><img data-src="/douyin-6shen-init/image-20240801004717078.png" alt="image-20240801004717078" style="aspect-ratio:1149 / 949;"></p>
<p>看了一下导入函数，感觉 <code>SSL_CTX_set_custom_verify</code>  有点像校验的样子</p>
<blockquote>
<p>SSL_CTX_set_custom_verify 证书校验异步操作，<strong>相比 OpenSSL，BoringSSL 单独将认证证书的流程拿出来从而提供更详细的认证控制</strong></p>
</blockquote>
<p><img data-src="/douyin-6shen-init/image-20240801004045357.png" alt="image-20240801004045357" style="aspect-ratio:906 / 880;"></p>
<p>再细看一下这个函数</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">SSL_CTX_set_custom_verify</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    SSL_CTX <span class="token operator">*</span>ctx<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">enum</span> <span class="token class-name">ssl_verify_result_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>callback<span class="token punctuation">)</span><span class="token punctuation">(</span>SSL <span class="token operator">*</span>ssl<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>out_alert<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  ctx<span class="token operator">-></span>verify_mode <span class="token operator">=</span> mode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  ctx<span class="token operator">-></span>custom_verify_callback <span class="token operator">=</span> callback<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其中的 mode 用来验证客户端，mode 的值为 1 进行验证，但是如果取 0 就是不验证</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// SSL_VERIFY_NONE, on a client, verifies the server certificate but does not</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// make errors fatal. The result may be checked with |SSL_get_verify_result|. On</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// a server it does not request a client certificate. This is the default.</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SSL_VERIFY_NONE</span> <span class="token expression"><span class="token number">0x00</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// SSL_VERIFY_PEER, on a client, makes server certificate errors fatal. On a</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// server it requests a client certificate and makes errors fatal. However,</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">// anonymous clients are still allowed. See</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// |SSL_VERIFY_FAIL_IF_NO_PEER_CERT|.</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SSL_VERIFY_PEER</span> <span class="token expression"><span class="token number">0x01</span></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// SSL_VERIFY_FAIL_IF_NO_PEER_CERT configures a server to reject connections if</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">// the client declines to send a certificate. This flag must be used together</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// with |SSL_VERIFY_PEER|, otherwise it won't work.</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SSL_VERIFY_FAIL_IF_NO_PEER_CERT</span> <span class="token expression"><span class="token number">0x02</span></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">// SSL_VERIFY_PEER_IF_NO_OBC configures a server to request a client certificate</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// if and only if Channel ID is not negotiated.</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SSL_VERIFY_PEER_IF_NO_OBC</span> <span class="token expression"><span class="token number">0x04</span></span></span></pre></td></tr></table></figure><p>所以我们可以直接用 frida patch 第二个参数的值为 0</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_dlopen</span><span class="token punctuation">(</span>soName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>Module<span class="token punctuation">.</span><span class="token function">findExportByName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"android_dlopen_ext"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token keyword">var</span> pathptr <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pathptr <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> pathptr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                    <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span>pathptr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    <span class="token comment">//console.log('load ',path);</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>soName<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                        <span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>is_can_hook<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                    <span class="token function">ssl_bypass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                    <span class="token comment">//do your own code</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">function</span> <span class="token function">ssl_bypass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">let</span> SSL_CTX_set_custom_verify <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">getExportByName</span><span class="token punctuation">(</span><span class="token string">'libsscronet.so'</span><span class="token punctuation">,</span> <span class="token string">'SSL_CTX_set_custom_verify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start hook SSL_CTX_set_custom_verify'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>SSL_CTX_set_custom_verify <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>SSL_CTX_set_custom_verify<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SSL_CTX_set_custom_verify mode: '</span><span class="token punctuation">,</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'patch mode from 1 to 0 to bypass ssl'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">//frida -H 127.0.0.1:1234 -l .\douyin\hook.js -f com.ss.android.ugc.aweme</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token function">setImmediate</span><span class="token punctuation">(</span>hook_dlopen<span class="token punctuation">,</span> <span class="token string">"libsscronet.so"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>抓到包啦</p>
<p><img data-src="/douyin-6shen-init/image-20240801010106216.png" alt="image-20240801010106216" style="aspect-ratio:3840 / 2159;"></p>
<p>在请求头中出现的六个 <code>x-</code>  带头的参数就是六神算法</p>
<p><img data-src="/douyin-6shen-init/image-20240818142610556.png" alt="image-20240818142610556" style="aspect-ratio:161 / 336;"></p>
<h1 id="定位参数位置"><a class="anchor" href="#定位参数位置">#</a> 定位参数位置</h1>
<p>接下来就是去定位这些参数的位置咯，该怎么定位呢？</p>
<p>其实很简单，按照正向安全开发的经验来说，对于大型的 APP, 这种关键参数所涉及的算法基本上是不可能在 java 层中出现的，他们通常极大概率是把加密算法下沉到 native 层中去调用，所以说，我们就只需要找 so 就可以啦，而这种含有关键算法的 so 一般都有一个共性，就是 so 中不会出现静态注册的 java 方法，并且 so 被混淆的非常滴厉害，各种花指令寄存器跳转啥的通通来一遍让我们一打开 IDA 反编译连伪代码都看不了，找到这类 so，那就离关键算法不远了，而其他无关紧要的 so 基本不会做防护，要是也加上高强度的混淆，可能会出 bug 不说，还会拖慢 APP 启动速度影响用户体验</p>
<p>而小型的 APP, 由于很少会在安全上花功夫，所以说我们在 java 层中搜索参数名称，一般就可以找到参数所在的位置了</p>
<p>而在之前我们已经知道进行 <code>ssl pinning</code>  的 so 库的名称是 <code>libsscronet.so</code> , 那对参数进行加密的 so 库一般就在网络库的附近加载，感觉 <code>libmetasec_ml.so</code>  这个 so 挺像的</p>
<p><img data-src="/douyin-6shen-init/image-20240818142932419.png" alt="image-20240818142932419" style="aspect-ratio:2357 / 528;"></p>
<p>一用 IDA 反编译 so 之后引入眼帘的就是让人感到亲切的 <code>BR</code>  寄存器跳转！</p>
<p><img data-src="/douyin-6shen-init/image-20240818143106335.png" alt="image-20240818143106335" style="aspect-ratio:1096 / 297;"></p>
<p>接下来看看这个 so 动态注册了什么方法咯</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">getModuleInfoByPtr</span><span class="token punctuation">(</span><span class="token parameter">fnPtr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">var</span> modules <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">enumerateModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">var</span> modname <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      base <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  modules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">mod</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mod<span class="token punctuation">.</span>base <span class="token operator">&lt;=</span> fnPtr <span class="token operator">&amp;&amp;</span> fnPtr<span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> mod<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> mod<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      modname <span class="token operator">=</span> mod<span class="token punctuation">.</span>name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      base <span class="token operator">=</span> mod<span class="token punctuation">.</span>base<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">return</span> <span class="token punctuation">[</span>modname<span class="token punctuation">,</span> base<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_registNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">var</span> env <span class="token operator">=</span> Java<span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">var</span> handlePointer <span class="token operator">=</span> env<span class="token punctuation">.</span>handle<span class="token punctuation">.</span><span class="token function">readPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"handle: "</span> <span class="token operator">+</span> handlePointer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">var</span> nativePointer <span class="token operator">=</span> handlePointer<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">215</span> <span class="token operator">*</span> Process<span class="token punctuation">.</span>pointerSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"register: "</span> <span class="token operator">+</span> nativePointer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   typedef struct &#123;</pre></td></tr><tr><td data-num="22"></td><td><pre>      const char* name;</pre></td></tr><tr><td data-num="23"></td><td><pre>      const char* signature;</pre></td></tr><tr><td data-num="24"></td><td><pre>      void* fnPtr;</pre></td></tr><tr><td data-num="25"></td><td><pre>   &#125; JNINativeMethod;</pre></td></tr><tr><td data-num="26"></td><td><pre>   jint RegisterNatives(JNIEnv* env, jclass clazz, const JNINativeMethod* methods, jint nMethods)</pre></td></tr><tr><td data-num="27"></td><td><pre>   */</pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>nativePointer<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">onEnter</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token keyword">var</span> env <span class="token operator">=</span> Java<span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">getEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token keyword">var</span> p_size <span class="token operator">=</span> Process<span class="token punctuation">.</span>pointerSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token keyword">var</span> methods <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token keyword">var</span> methodcount <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token keyword">var</span> name <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"==== class: "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">" ===="</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"==== methods: "</span> <span class="token operator">+</span> methods <span class="token operator">+</span> <span class="token string">" nMethods: "</span> <span class="token operator">+</span> methodcount <span class="token operator">+</span> <span class="token string">" ===="</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> methodcount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">var</span> idx <span class="token operator">=</span> i <span class="token operator">*</span> p_size <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">var</span> fnPtr <span class="token operator">=</span> methods<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> p_size <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">var</span> infoArr <span class="token operator">=</span> <span class="token function">getModuleInfoByPtr</span><span class="token punctuation">(</span>fnPtr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">var</span> modulename <span class="token operator">=</span> infoArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">var</span> modulebase <span class="token operator">=</span> infoArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">var</span> logstr <span class="token operator">=</span> <span class="token string">"name: "</span> <span class="token operator">+</span> methods<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", signature: "</span> <span class="token operator">+</span> methods<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> p_size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", fnPtr: "</span> <span class="token operator">+</span> fnPtr <span class="token operator">+</span> <span class="token string">", modulename: "</span> <span class="token operator">+</span> modulename <span class="token operator">+</span> <span class="token string">" -> base: "</span> <span class="token operator">+</span> modulebase<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> modulebase<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>          logstr <span class="token operator">+=</span> <span class="token string">", offset: "</span> <span class="token operator">+</span> fnPtr<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>modulebase<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>logstr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里注册了 <code>ms.bd.c.l.a</code> , 它的方法签名是 <code>(IIJLjava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;</code> , 并且在 so 中的偏移是 <code>0x126e30</code></p>
<p><img data-src="/douyin-6shen-init/image-20240818143547405.png" alt="image-20240818143547405" style="aspect-ratio:1885 / 161;"></p>
<p>直接对偏移 <code>0x126e30</code>  的传入传出参数进行 hook, 发现就是六神算法的生成位置～</p>
<p><img data-src="/douyin-6shen-init/image-20240818144352514.png" alt="image-20240818144352514" style="aspect-ratio:2442 / 744;"></p>
<p>而在对 <code>ms.bd.c.l.a</code>  进行交叉引用后发现，这个 native 函数还有一个字符串加密的功能如图所示，通过调用 <code>l.a</code>  函数，并传入 code 为 <code>0x1000001</code>  来实现 java 层的字符串加密，接下来我们来对这个字符串加密算法进行更加深入的研究</p>
<p><img data-src="/douyin-6shen-init/image-20240818162150793.png" alt="image-20240818162150793" style="aspect-ratio:1607 / 151;"></p>
<h1 id="libmetasec_mlso反混淆"><a class="anchor" href="#libmetasec_mlso反混淆">#</a> libmetasec_ml.so 反混淆</h1>
<p>这个 so 的花指令主要有五类 (其实还有一类是 <code>CSEL-BR</code>  寄存器跳转混淆，但是由于字符串解密算法不涉及 <code>CSEL-BR</code>  混淆，所以此处没有给出相关的示例)</p>
<ol>
<li>
<p><code>BL-BR</code>  寄存器跳转<br>
这个寄存器跳转简单读一下汇编就可以很清楚的知道是怎么实现的啦，主要是通过一个函数获取到了当前 BL 指令下一行的内存地址，然后通过加上一个偏移使用 BR 寄存器跳转的形式跳过去，所以我们只要把中间越过的指令直接 NOP 掉就好啦</p>
<p><img data-src="/douyin-6shen-init/image-20240817210246836.png" alt="image-20240817210246836" style="aspect-ratio:2300 / 1313;"></p>
</li>
<li>
<p><code>B.GT-CBNZ</code>  垃圾指令<br>
这里出现了一大段 IDA 无法解析的指令</p>
</li>
</ol>
<p><img data-src="/douyin-6shen-init/image-20240805011945451.png" alt="image-20240805011945451" style="aspect-ratio:1783 / 1132;"></p>
<p>其实对于此处的汇编来说，它执行后最终的值是固定的</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>MOV             W8, <span class="token comment">#0x1B5</span></pre></td></tr><tr><td data-num="2"></td><td><pre>MOV             W9, <span class="token comment">#0x16F</span></pre></td></tr><tr><td data-num="3"></td><td><pre>STR             W8, <span class="token punctuation">[</span>SP,<span class="token comment">#0x4C]</span></pre></td></tr><tr><td data-num="4"></td><td><pre>STR             W9, <span class="token punctuation">[</span>SP,<span class="token comment">#0x48]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>LDR             W8, <span class="token punctuation">[</span>SP,<span class="token comment">#0x4C]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>LDR             W9, <span class="token punctuation">[</span>SP,<span class="token comment">#0x48]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>CMP             W9, <span class="token comment">#0x4C ; 'L'</span></pre></td></tr><tr><td data-num="8"></td><td><pre>B.GT          </pre></td></tr><tr><td data-num="9"></td><td><pre>MOV             W9, <span class="token comment">#1</span></pre></td></tr><tr><td data-num="10"></td><td><pre>MADD            W8, W8, W8, W9</pre></td></tr><tr><td data-num="11"></td><td><pre>MOV             W9, <span class="token comment">#7</span></pre></td></tr><tr><td data-num="12"></td><td><pre>UDIV            W9, W8, W9</pre></td></tr><tr><td data-num="13"></td><td><pre>SUB             W9, W9, W9,LSL<span class="token comment">#3</span></pre></td></tr><tr><td data-num="14"></td><td><pre>ADD             W8, W8, W9</pre></td></tr><tr><td data-num="15"></td><td><pre>CBNZ            W8, loc_55318</pre></td></tr></table></figure><p>我们可以使用 unicorn 将这段汇编运行一下看看具体的值</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># code for test-fla.elf</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> unicorn <span class="token keyword">import</span> <span class="token operator">*</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">from</span> unicorn<span class="token punctuation">.</span>arm64_const <span class="token keyword">import</span> <span class="token operator">*</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> keystone <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># pip install keystone-engine</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">from</span> capstone <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># pip install capstone</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>BASE <span class="token operator">=</span> <span class="token number">0x0</span></pre></td></tr><tr><td data-num="8"></td><td><pre>CODE <span class="token operator">=</span> BASE <span class="token operator">+</span> <span class="token number">0x0</span></pre></td></tr><tr><td data-num="9"></td><td><pre>CODE_SIZE <span class="token operator">=</span> <span class="token number">0x100000</span></pre></td></tr><tr><td data-num="10"></td><td><pre>STACK <span class="token operator">=</span> <span class="token number">0x7F00000000</span></pre></td></tr><tr><td data-num="11"></td><td><pre>STACK_SIZE <span class="token operator">=</span> <span class="token number">0x100000</span></pre></td></tr><tr><td data-num="12"></td><td><pre>FS <span class="token operator">=</span> <span class="token number">0x7FF0000000</span></pre></td></tr><tr><td data-num="13"></td><td><pre>FS_SIZE <span class="token operator">=</span> <span class="token number">0x100000</span></pre></td></tr><tr><td data-num="14"></td><td><pre>ks <span class="token operator">=</span> Ks<span class="token punctuation">(</span>KS_ARCH_ARM64<span class="token punctuation">,</span> KS_MODE_LITTLE_ENDIAN<span class="token punctuation">)</span>  <span class="token comment"># 汇编引擎</span></pre></td></tr><tr><td data-num="15"></td><td><pre>uc <span class="token operator">=</span> Uc<span class="token punctuation">(</span>UC_ARCH_ARM64<span class="token punctuation">,</span> UC_MODE_LITTLE_ENDIAN<span class="token punctuation">)</span>  <span class="token comment"># 模拟执行引擎</span></pre></td></tr><tr><td data-num="16"></td><td><pre>cs <span class="token operator">=</span> Cs<span class="token punctuation">(</span>CS_ARCH_ARM64<span class="token punctuation">,</span> CS_MODE_LITTLE_ENDIAN<span class="token punctuation">)</span>  <span class="token comment"># 反汇编引擎</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">def</span> <span class="token function">hook_code</span><span class="token punctuation">(</span>uc<span class="token punctuation">:</span> unicorn<span class="token punctuation">.</span>Uc<span class="token punctuation">,</span> address<span class="token punctuation">,</span> size<span class="token punctuation">,</span> user_data<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment"># print(hex(address))</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">for</span> i <span class="token keyword">in</span> cs<span class="token punctuation">.</span>disasm<span class="token punctuation">(</span>CODE_DATA<span class="token punctuation">[</span>address <span class="token operator">-</span> BASE<span class="token punctuation">:</span>address <span class="token operator">-</span> BASE <span class="token operator">+</span> size<span class="token punctuation">]</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment"># arm 架构是 NZCV 寄存器，32 位的寄存器最左边开始的四位依次存储 N,Z,C,V 标志</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        ZF_flag <span class="token operator">=</span> <span class="token punctuation">(</span>uc<span class="token punctuation">.</span>reg_read<span class="token punctuation">(</span>UC_ARM64_REG_NZCV<span class="token punctuation">)</span> <span class="token operator">>></span><span class="token number">30</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">1</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">if</span> i<span class="token punctuation">.</span>mnemonic <span class="token operator">==</span> <span class="token string">"b.gt"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"0x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">.</span>address<span class="token punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">.</span>mnemonic<span class="token punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">.</span>op_str<span class="token punctuation">&#125;</span></span><span class="token string"> ; ZF = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>ZF_flag<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            uc<span class="token punctuation">.</span>reg_write<span class="token punctuation">(</span>UC_ARM64_REG_PC<span class="token punctuation">,</span> address <span class="token operator">+</span> size<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">elif</span> i<span class="token punctuation">.</span>mnemonic <span class="token operator">==</span> <span class="token string">"cmp"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            w9 <span class="token operator">=</span> uc<span class="token punctuation">.</span>reg_read<span class="token punctuation">(</span>UC_ARM64_REG_W9<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"0x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">.</span>address<span class="token punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">.</span>mnemonic<span class="token punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">.</span>op_str<span class="token punctuation">&#125;</span></span><span class="token string"> ; ZF = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>ZF_flag<span class="token punctuation">&#125;</span></span><span class="token string">, w9 = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>w9<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">elif</span> i<span class="token punctuation">.</span>mnemonic <span class="token operator">==</span> <span class="token string">"cbnz"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            w8 <span class="token operator">=</span> uc<span class="token punctuation">.</span>reg_read<span class="token punctuation">(</span>UC_ARM64_REG_W8<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"0x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">.</span>address<span class="token punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">.</span>mnemonic<span class="token punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">.</span>op_str<span class="token punctuation">&#125;</span></span><span class="token string"> ; ZF = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>ZF_flag<span class="token punctuation">&#125;</span></span><span class="token string">, w8 = </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>w8<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            uc<span class="token punctuation">.</span>reg_write<span class="token punctuation">(</span>UC_ARM64_REG_PC<span class="token punctuation">,</span> address <span class="token operator">+</span> size<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"0x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">.</span>address<span class="token punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">.</span>mnemonic<span class="token punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">.</span>op_str<span class="token punctuation">&#125;</span></span><span class="token string"> ; ZF = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>ZF_flag<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token keyword">def</span> <span class="token function">hook_mem_access</span><span class="token punctuation">(</span>uc<span class="token punctuation">:</span> unicorn<span class="token punctuation">.</span>Uc<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">,</span> address<span class="token punctuation">,</span> size<span class="token punctuation">,</span> value<span class="token punctuation">,</span> userdata<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    pc <span class="token operator">=</span> uc<span class="token punctuation">.</span>reg_read<span class="token punctuation">(</span>UC_ARM64_REG_PC<span class="token punctuation">)</span>  <span class="token comment"># UC_ARM64_REG_PC</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'pc:%x type:%d addr:%x size:%x'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>pc<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">,</span> address<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment"># uc.emu_stop()</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token keyword">def</span> <span class="token function">inituc</span><span class="token punctuation">(</span>uc<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    uc<span class="token punctuation">.</span>mem_map<span class="token punctuation">(</span>CODE<span class="token punctuation">,</span> CODE_SIZE<span class="token punctuation">,</span> UC_PROT_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    uc<span class="token punctuation">.</span>mem_map<span class="token punctuation">(</span>STACK<span class="token punctuation">,</span> STACK_SIZE<span class="token punctuation">,</span> UC_PROT_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    uc<span class="token punctuation">.</span>mem_write<span class="token punctuation">(</span>CODE<span class="token punctuation">,</span> CODE_DATA<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    uc<span class="token punctuation">.</span>reg_write<span class="token punctuation">(</span>UC_ARM64_REG_SP<span class="token punctuation">,</span> STACK <span class="token operator">+</span> <span class="token number">0x1000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>    uc<span class="token punctuation">.</span>hook_add<span class="token punctuation">(</span>UC_HOOK_CODE<span class="token punctuation">,</span> hook_code<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    uc<span class="token punctuation">.</span>hook_add<span class="token punctuation">(</span>UC_HOOK_MEM_UNMAPPED <span class="token operator">|</span> UC_HOOK_INTR<span class="token punctuation">,</span> hook_mem_access<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>shellcode <span class="token operator">=</span> <span class="token triple-quoted-string string">'''</span></pre></td></tr><tr><td data-num="59"></td><td><pre>MOV W8, #0x1B5</pre></td></tr><tr><td data-num="60"></td><td><pre>MOV W9, #0x16F</pre></td></tr><tr><td data-num="61"></td><td><pre>STR W8, [SP,#0x4C]</pre></td></tr><tr><td data-num="62"></td><td><pre>STR W9, [SP,#0x48]</pre></td></tr><tr><td data-num="63"></td><td><pre>LDR W8, [SP,#0x4C]</pre></td></tr><tr><td data-num="64"></td><td><pre>LDR W9, [SP,#0x48]</pre></td></tr><tr><td data-num="65"></td><td><pre>CMP W9, #0x4C</pre></td></tr><tr><td data-num="66"></td><td><pre>B.GT #0x55318</pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>MOV W9, #1</pre></td></tr><tr><td data-num="69"></td><td><pre>MADD W8, W8, W8, W9</pre></td></tr><tr><td data-num="70"></td><td><pre>MOV W9, #7</pre></td></tr><tr><td data-num="71"></td><td><pre>UDIV W9, W8, W9</pre></td></tr><tr><td data-num="72"></td><td><pre>SUB W9, W9, W9,LSL#3</pre></td></tr><tr><td data-num="73"></td><td><pre>ADD W8, W8, W9</pre></td></tr><tr><td data-num="74"></td><td><pre>CBNZ W8, #0x55318</pre></td></tr><tr><td data-num="75"></td><td><pre>'''</pre></td></tr><tr><td data-num="76"></td><td><pre>CODE_DATA<span class="token punctuation">,</span>count <span class="token operator">=</span> ks<span class="token punctuation">.</span>asm<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="77"></td><td><pre>CODE_DATA <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>CODE_DATA<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="78"></td><td><pre>inituc<span class="token punctuation">(</span>uc<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="79"></td><td><pre><span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    uc<span class="token punctuation">.</span>emu_start<span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>CODE_DATA<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span></pre></td></tr></table></figure><p>输出如下，可以发现 <code>cmp w9, #0x4c</code>  将 ZF 标志位置为 1, <code> b.gt</code>  大于跳转永远成立， <code>cbnz</code>  跳转也永远成立，也就是不管怎么样，最终都会越过中间这段无用的指令，而跳转到 <code>0x55318</code>  的位置</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>0x0: mov w8, <span class="token comment">#0x1b5 ; ZF = 1</span></pre></td></tr><tr><td data-num="2"></td><td><pre>0x4: mov w9, <span class="token comment">#0x16f ; ZF = 1</span></pre></td></tr><tr><td data-num="3"></td><td><pre>0x8: str w8, <span class="token punctuation">[</span>sp, <span class="token comment">#0x4c] ; ZF = 1</span></pre></td></tr><tr><td data-num="4"></td><td><pre>0x12: str w9, <span class="token punctuation">[</span>sp, <span class="token comment">#0x48] ; ZF = 1</span></pre></td></tr><tr><td data-num="5"></td><td><pre>0x16: ldr w8, <span class="token punctuation">[</span>sp, <span class="token comment">#0x4c] ; ZF = 1</span></pre></td></tr><tr><td data-num="6"></td><td><pre>0x20: ldr w9, <span class="token punctuation">[</span>sp, <span class="token comment">#0x48] ; ZF = 1</span></pre></td></tr><tr><td data-num="7"></td><td><pre>0x24: <span class="token function">cmp</span> w9, <span class="token comment">#0x4c ; ZF = 1, w9 = 0x16f</span></pre></td></tr><tr><td data-num="8"></td><td><pre>0x28: b.gt <span class="token comment">#0x55318 ; ZF = 0</span></pre></td></tr><tr><td data-num="9"></td><td><pre>0x32: mov w9, <span class="token comment">#1 ; ZF = 0</span></pre></td></tr><tr><td data-num="10"></td><td><pre>0x36: madd w8, w8, w8, w9 <span class="token punctuation">;</span> ZF <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="11"></td><td><pre>0x40: mov w9, <span class="token comment">#7 ; ZF = 0</span></pre></td></tr><tr><td data-num="12"></td><td><pre>0x44: udiv w9, w8, w9 <span class="token punctuation">;</span> ZF <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="13"></td><td><pre>0x48: sub w9, w9, w9, lsl <span class="token comment">#3 ; ZF = 0</span></pre></td></tr><tr><td data-num="14"></td><td><pre>0x52: <span class="token function">add</span> w8, w8, w9 <span class="token punctuation">;</span> ZF <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="15"></td><td><pre>0x56: cbnz w8, <span class="token comment">#0x55318 ; ZF = 0, w8 = 0x3</span></pre></td></tr></table></figure><p>所以对于这种 ida 无法识别的无用指令，我们直接 nop 掉即可</p>
<ol start="3">
<li><code>F1 F6 77 FF 1F 20 03 D5 1F 20 03 D5 1F 20 03 D5</code> , 这个花指令主要是用来进行 so 完整性校验的，但是我们主要是进行静态分析，所以对于影响我们看汇编的指令，直接 nop 掉</li>
</ol>
<p><img data-src="/douyin-6shen-init/image-20240805010232627.png" alt="image-20240805010232627" style="aspect-ratio:1265 / 545;"></p>
<ol start="4">
<li><code>EB FF 1F D6 01 00 00 D4</code> , 这个被 ida 解析成了 svc 调用，实际上看看上下文根本没有给 x8 赋值的语句，所以这八字节也是花指令</li>
</ol>
<p><img data-src="/douyin-6shen-init/image-20240805010341218.png" alt="image-20240805010341218" style="aspect-ratio:1211 / 431;"></p>
<ol start="5">
<li><code>01 00 00 D4 DE 01 70 47</code> , 同样的，这里出现的 svc 也不是真的 svc, 是花指令，直接 patch 掉就好啦</li>
</ol>
<p><img data-src="/douyin-6shen-init/image-20240805010451682.png" alt="image-20240805010451682" style="aspect-ratio:1284 / 339;"></p>
<p>所以最终的去花代码如下</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> ida_segment</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> idautils</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> idc</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> ida_bytes</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">from</span> keystone <span class="token keyword">import</span> <span class="token operator">*</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">def</span> <span class="token function">patch_nop</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># arm64 中的 NOP 指令是 b'\x1F\x20\x03\xD5'</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">while</span> end <span class="token operator">></span> begin<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        ida_bytes<span class="token punctuation">.</span>patch_bytes<span class="token punctuation">(</span>begin<span class="token punctuation">,</span> <span class="token string">b'\x1F\x20\x03\xD5'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        begin <span class="token operator">=</span> begin <span class="token operator">+</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 获取 text 段的起始地址</span></pre></td></tr><tr><td data-num="12"></td><td><pre>text_seg <span class="token operator">=</span> ida_segment<span class="token punctuation">.</span>get_segm_by_name<span class="token punctuation">(</span><span class="token string">".text"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>start<span class="token punctuation">,</span> end <span class="token operator">=</span> text_seg<span class="token punctuation">.</span>start_ea<span class="token punctuation">,</span> text_seg<span class="token punctuation">.</span>end_ea</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">#start,end = 0x533A4,0x533E0#BL-BR 结构寄存器跳转单个情况测试</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">#start,end = 0x55288,0x55318#B.GT-CBNZ 跳转 垃圾指令测试</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#start,end = 0x94048,0x94070#B.GT-CBNZ 跳转 垃圾指令测试 1</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#去除花指令</span></pre></td></tr><tr><td data-num="18"></td><td><pre>pattern <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"01 00 00 D4 DE 01 70 47"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>           <span class="token string">"EB FF 1F D6 01 00 00 D4"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>           <span class="token string">"F1 F6 77 FF 1F 20 03 D5 1F 20 03 D5 1F 20 03 D5"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    cur_addr <span class="token operator">=</span> start</pre></td></tr><tr><td data-num="23"></td><td><pre>    end_addr <span class="token operator">=</span> end</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">while</span> cur_addr <span class="token operator">&lt;</span> end_addr<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        cur_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>find_binary<span class="token punctuation">(</span>cur_addr<span class="token punctuation">,</span> idc<span class="token punctuation">.</span>SEARCH_DOWN<span class="token punctuation">,</span> pattern<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">if</span> cur_addr <span class="token operator">==</span> idc<span class="token punctuation">.</span>BADADDR<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"patch flower code: "</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>cur_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 打印提示信息</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token comment">#patch_nop(cur_addr, cur_addr + len(pattern[i].split(' ')))</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        cur_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>cur_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>current_addr <span class="token operator">=</span> start</pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">while</span> current_addr <span class="token operator">&lt;</span> end<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment"># BL-BR 结构寄存器跳转</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>current_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"BR"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        BR_addr <span class="token operator">=</span> current_addr</pre></td></tr><tr><td data-num="40"></td><td><pre>        BL_addr<span class="token punctuation">,</span>nop_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>        temp_addr <span class="token operator">=</span> current_addr</pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"BL"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                BL_addr <span class="token operator">=</span> temp_addr</pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ADD"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                nop_count <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>prev_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">if</span> BL_addr <span class="token keyword">and</span> nop_count<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"patch BL-BR from </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>BL_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>BL_addr<span class="token punctuation">)</span><span class="token operator">+</span>nop_count<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            patch_nop<span class="token punctuation">(</span>BL_addr<span class="token punctuation">,</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>BL_addr<span class="token punctuation">)</span> <span class="token operator">+</span> nop_count<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token comment">#B.GT-CBNZ 跳转</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">elif</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>current_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"CBNZ"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        CBNZ_addr <span class="token operator">=</span> current_addr</pre></td></tr><tr><td data-num="55"></td><td><pre>        CBNZ_jmp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>current_addr<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        BGT_addr <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        temp_addr <span class="token operator">=</span> current_addr</pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token keyword">if</span> idc<span class="token punctuation">.</span>print_insn_mnem<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"B.GT"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                BGT_jmp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>get_operand_value<span class="token punctuation">(</span>temp_addr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                <span class="token keyword">if</span> CBNZ_jmp_addr<span class="token operator">==</span>BGT_jmp_addr<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"patch B.GT-CBNZ junk code from </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>CBNZ_addr<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>CBNZ_jmp_addr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                    patch_nop<span class="token punctuation">(</span>CBNZ_addr<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">,</span> CBNZ_jmp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                <span class="token keyword">break</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            temp_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>prev_head<span class="token punctuation">(</span>temp_addr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>    current_addr <span class="token operator">=</span> idc<span class="token punctuation">.</span>next_head<span class="token punctuation">(</span>current_addr<span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="自加载libmetasec_mlso"><a class="anchor" href="#自加载libmetasec_mlso">#</a> 自加载 libmetasec_ml.so</h1>
<p>为了防止其他的 so 对我们的干扰，所以可以写个 demo 加载这个 so，但一加载这个 so 的时候程序就崩溃了并留下了下面这一串报错，既然调用了这个类 <code>com.bytedance.mobsec.metasec.ml.MS</code> ，那肯定和算法有些许的联系</p>
<p><img data-src="/douyin-6shen-init/image-20240814001314102.png" alt="image-20240814001314102" style="aspect-ratio:3181 / 451;"></p>
<p>而这个 <code>MS</code>  类，他继承了 <code>e0</code>  类</p>
<p><img data-src="/douyin-6shen-init/image-20240814001439387.png" alt="image-20240814001439387" style="aspect-ratio:655 / 253;"></p>
<p>而这个 e0 类，他又继承了 <code>ms.bd.c.l</code>  这个类，这个类就是 <code>libmetasec_ml.so</code>  唯一动态注册的函数 <code>a</code>  所在的类，在 <code>e0</code>  中，又定义了四个函数，但是他们的函数竟然啥内容都没有</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">ms<span class="token punctuation">.</span>bd<span class="token punctuation">.</span>c</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>bytedance<span class="token punctuation">.</span>covode<span class="token punctuation">.</span>number<span class="token punctuation">.</span></span><span class="token class-name">Covode</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> e0 <span class="token keyword">extends</span> l <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">Covode</span><span class="token punctuation">.</span><span class="token function">recordClassIndex</span><span class="token punctuation">(</span><span class="token number">1018605</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token class-name">Bill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">strictfp</span> <span class="token keyword">void</span> <span class="token class-name">Francies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token class-name">Louis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token class-name">Zeoy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>把缺少的类补上去之后，随便调用一个字符串加密的函数</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>l<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token number">0x1000001</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token string">"d8044a"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">0x7B</span><span class="token punctuation">,</span> <span class="token number">0x7A</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">69</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0x74</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0x76</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>没想到竟然输出了乱码</p>
<p><img data-src="/douyin-6shen-init/image-20240814211204858.png" alt="image-20240814211204858" style="aspect-ratio:357 / 39;"></p>
<p>为什么调用本来的字符串加密算法不能正常输出解密之后的字符串呢？</p>
<p>我思考了一下有以下几种可能的情况存在</p>
<ol>
<li>包名 / 签名校验：然而我 hook 了一圈都没找到相关的函数，包名改成和抖音一样的还是不行</li>
<li>异常环境检测：但是我放到正常的手机上，log 输出的还是同样的结果</li>
<li>检查 / 读取特定的文件：难道是检查 app 私有目录下有没有特定的文件，如果有特定的文件，就给解密的算法赋值正确的密钥？</li>
<li>利用 binder 或者 socket 和其他的进程通讯来获取初始密钥？</li>
</ol>
<p>下面是我对第三种情况读取文件的排查过程，因为考虑到最安全的调用系统函数的方式是 svc 调用</p>
<h2 id="svc调用"><a class="anchor" href="#svc调用">#</a> SVC 调用</h2>
<p>svc 的各个 code 对应的含义可以在<span class="exturl" data-url="aHR0cHM6Ly9jcy5hbmRyb2lkLmNvbS9hbmRyb2lkL3BsYXRmb3JtL3N1cGVycHJvamVjdC8rL21hc3RlcjpiaW9uaWMvbGliYy9rZXJuZWwvdWFwaS9hc20tZ2VuZXJpYy91bmlzdGQuaA==">此处</span>找到</p>
<p>ida 搜索 svc 特征汇编 <code>01 00 00 D4</code>  找到如下位置，在 <code>sub_13E274</code>  中</p>
<p><img data-src="/douyin-6shen-init/image-20240815220549586.png" alt="image-20240815220549586" style="aspect-ratio:2063 / 858;"></p>
<p>对这个函数 hook 一下</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">hook_svc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libmetasec_ml.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x13E274</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hook svc code->'</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x8<span class="token punctuation">.</span><span class="token function">toInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>但是却崩溃了？</p>
<p>用 frida 打个内存读写的断点看看</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">memory_read_hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libmetasec_ml.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    MemoryAccessMonitor<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                    <span class="token literal-property property">base</span><span class="token operator">:</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x13E274</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                    <span class="token literal-property property">size</span><span class="token operator">:</span><span class="token number">48</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    <span class="token function-variable function">onAccess</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">details</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span>operation<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">get_addr_in_so</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span>from<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">function</span> <span class="token function">get_addr_in_so</span><span class="token punctuation">(</span><span class="token parameter">addr</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">var</span> process_Obj_Module_Arr <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">enumerateModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> process_Obj_Module_Arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>addr<span class="token operator">></span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base <span class="token operator">&amp;&amp;</span> addr<span class="token operator">&lt;</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">return</span> addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" is in "</span><span class="token operator">+</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">" offset: 0x"</span><span class="token operator">+</span><span class="token punctuation">(</span>addr<span class="token operator">-</span>process_Obj_Module_Arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">return</span> addr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>需要注意的是我们需要在对 svc 的 hook 完成之后，延迟三秒在打内存读写断点</p>
<p><img data-src="/douyin-6shen-init/image-20240815230204317.png" alt="image-20240815230204317" style="aspect-ratio:412 / 126;"></p>
<p>frida 打印出了如下日志随后进程退出</p>
<p><img data-src="/douyin-6shen-init/image-20240815230400591.png" alt="image-20240815230400591" style="aspect-ratio:921 / 79;"></p>
<p>跳转到 <code>0x13e030</code>  看看，看来是对 svc 函数的完整性做了校验来防 hook</p>
<p><img data-src="/douyin-6shen-init/image-20240815230857961.png" alt="image-20240815230857961" style="aspect-ratio:1548 / 625;"></p>
<p>那就对这个函数进行 hook 把校验的值强制改成 <code>0x312768B</code> , 没想到又崩溃了，但是打印的地址还是和先前相同，因为 frida  <code>MemoryAccessMonitor</code>  自身的限制，只在第一次访问内存页的时候产生回调，后续的访问就不显示了，这个特性在 frida 的<span class="exturl" data-url="aHR0cHM6Ly9mcmlkYS5yZS9kb2NzL2phdmFzY3JpcHQtYXBpLyNtZW1vcnlhY2Nlc3Ntb25pdG9y">官方文档</span>中有所提及</p>
<p><img data-src="/douyin-6shen-init/image-20240816200219287.png" alt="image-20240816200219287" style="aspect-ratio:1088 / 408;"></p>
<p>接下来考虑打个硬件断点看看</p>
<details class="info"><summary>stackplz 打硬件断点</summary><div>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./stackplz <span class="token parameter variable">--rpc</span> <span class="token parameter variable">--stack</span></pre></td></tr></table></figure><p>hook 代码如下</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>msg<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">SetHWBrk</span><span class="token punctuation">(</span><span class="token parameter">brk_addr<span class="token punctuation">,</span> brk_type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">let</span> size_len <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">let</span> brk_options <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token comment">// brk_pid: Process.id,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token literal-property property">brk_pid</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token literal-property property">brk_len</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token literal-property property">brk_type</span><span class="token operator">:</span> brk_type<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token literal-property property">brk_addr</span><span class="token operator">:</span> brk_addr<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// open conn</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[SetHWBrk] open conn</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// stackplz --rpc-path</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">var</span> conn <span class="token operator">=</span> <span class="token keyword">await</span> Socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token literal-property property">family</span><span class="token operator">:</span> <span class="token string">"ipv4"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">41718</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">let</span> payload <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>brk_options<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">brk_options -> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>payload<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">let</span> msg_len <span class="token operator">=</span> payload<span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// send payload size</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">let</span> size_buffer <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>size_len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        size_buffer<span class="token punctuation">.</span><span class="token function">writeU32</span><span class="token punctuation">(</span>msg_len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">await</span> conn<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">writeAll</span><span class="token punctuation">(</span>size_buffer<span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span>size_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token comment">// send payload</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">let</span> payload_buffer <span class="token operator">=</span> Memory<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        payload_buffer<span class="token punctuation">.</span><span class="token function">writeUtf8String</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">await</span> conn<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">writeAll</span><span class="token punctuation">(</span>payload_buffer<span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// try read resp size</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">let</span> resp_size_buffer <span class="token operator">=</span> <span class="token keyword">await</span> conn<span class="token punctuation">.</span>input<span class="token punctuation">.</span><span class="token function">readAll</span><span class="token punctuation">(</span>size_len<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token keyword">let</span> resp_size <span class="token operator">=</span> resp_size_buffer<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readU32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">let</span> resp <span class="token operator">=</span> <span class="token keyword">await</span> conn<span class="token punctuation">.</span>input<span class="token punctuation">.</span><span class="token function">readAll</span><span class="token punctuation">(</span>resp_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">resp -> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">hexdump</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token comment">// close conn</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">await</span> conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[SetHWBrk] error </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token keyword">function</span> <span class="token function">do_hw_brk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token comment">// modify here</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">let</span> lib <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libmetasec_ml.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token function">SetHWBrk</span><span class="token punctuation">(</span>lib<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x13E274</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">error </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>error<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>遇到这个 <code>unable to create socket: Operation not permitted</code> , 这是由于测试的 demo 没有给网络权限所以不能建立 socket</p>
<p><img data-src="/douyin-6shen-init/image-20240816201801046.png" alt="image-20240816201801046" style="aspect-ratio:1333 / 90;"></p>
<p>在 <code>AndroidManifest.xml</code>  里面加上这个权限就可以了</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span>uses-permission android:name<span class="token operator">=</span><span class="token string">"android.permission.INTERNET"</span>/<span class="token operator">></span></pre></td></tr></table></figure><p>但是貌似 hit 不到， <code>0x23c00</code>  跳转过去是空的并没有代码</p>
<p><img data-src="/douyin-6shen-init/image-20240816205135003.png" alt="image-20240816205135003" style="aspect-ratio:1739 / 412;"></p>
</div></details>
<p>使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FiY3ozMTYvcndQcm9jTWVtMzM="> rwprocmem33</span> 打硬件断点，发现硬件断点命中了上千万次，而检测点的偏移计算出来是 <code>0x13e0e8</code></p>
<p><img data-src="/douyin-6shen-init/image-20240816213750249.png" alt="image-20240816213750249" style="aspect-ratio:1332 / 1238;"></p>
<p>这个检测点就是我们先前去除垃圾指令后看到的这个函数</p>
<p><img data-src="/douyin-6shen-init/image-20240816214140057.png" alt="image-20240816214140057" style="aspect-ratio:1562 / 630;"></p>
<p>这不是和我们之前用 frida 的 <code>MemoryAccessMonitor</code>  找到的监测点一模一样吗，那为啥下面这个脚本没办法过检测呢？直接把 checksum 修改成和正确的值 <code>0x312768B</code>  一样不应该行得通的嘛</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">bypass_svc_func_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> module <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">findModuleByName</span><span class="token punctuation">(</span><span class="token string">"libmetasec_ml.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>base<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x13E10C</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'internal svc func check bypass, x8 '</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x8<span class="token punctuation">,</span><span class="token string">'-> 0x312768B'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x8 <span class="token operator">=</span> <span class="token number">0x312768B</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>但是我们想想，rwprocmem33 打印出来的硬件断点，命中次数达到了上千万次，那么这绝对是另外起了一个线程来专门对这个地方做检测的</p>
<p>所以这个检测线程既然如此暴力，那么我们索性也一不做二不休，直接把检测的汇编暴力 patch 了不就好了！</p>
<p>具体代码如下，使用 <code>Memory.protect</code>  将这个 so 设为 <code>rwx</code> , 然后直接修改内存，把 <code>B.NE</code>  跳转改为 <code>B</code>  跳转</p>
<p><img data-src="/douyin-6shen-init/image-20240816215710033.png" alt="image-20240816215710033" style="aspect-ratio:1454 / 302;"></p>
<p>这样这个 so 不管起多少线程，其内部线程的执行逻辑都将以我们期望的方式运行</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">bypass_svc_func_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">var</span> libso <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">getModuleByName</span><span class="token punctuation">(</span><span class="token string">"libmetasec_ml.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[name]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[base]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[size]:"</span><span class="token punctuation">,</span> <span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"[path]:"</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    Memory<span class="token punctuation">.</span><span class="token function">protect</span><span class="token punctuation">(</span><span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">,</span> libso<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token string">'rwx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    Memory<span class="token punctuation">.</span><span class="token function">writeByteArray</span><span class="token punctuation">(</span><span class="token function">ptr</span><span class="token punctuation">(</span>libso<span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x13E110</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0X03</span><span class="token punctuation">,</span> <span class="token number">0X00</span><span class="token punctuation">,</span> <span class="token number">0X00</span><span class="token punctuation">,</span> <span class="token number">0X14</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>终于我们也是成功的 hook 到了 svc 的调用码</p>
<p><img data-src="/douyin-6shen-init/image-20240816215930992.png" alt="image-20240816215930992" style="aspect-ratio:439 / 369;"></p>
<p>各个 svc code 的含义如下</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>hook svc code-<span class="token operator">></span> <span class="token number">56</span><span class="token punctuation">(</span>__NR_openat<span class="token punctuation">)</span> <span class="token function">open</span> /proc/self/exe</pre></td></tr><tr><td data-num="2"></td><td><pre>hook svc code-<span class="token operator">></span> <span class="token number">62</span><span class="token punctuation">(</span>__NR3264_lseek<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>hook svc code-<span class="token operator">></span> <span class="token number">63</span><span class="token punctuation">(</span>__NR_read<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>hook svc code-<span class="token operator">></span> <span class="token number">57</span><span class="token punctuation">(</span>__NR_close<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>hook svc code-<span class="token operator">></span> <span class="token number">135</span><span class="token punctuation">(</span>__NR_rt_sigprocmask<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>hook svc code-<span class="token operator">></span> <span class="token number">172</span><span class="token punctuation">(</span>__NR_getpid<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>hook svc code-<span class="token operator">></span> <span class="token number">178</span><span class="token punctuation">(</span>__NR_gettid<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>hook svc code-<span class="token operator">></span> <span class="token number">135</span><span class="token punctuation">(</span>__NR_rt_sigprocmask<span class="token punctuation">)</span></pre></td></tr></table></figure><p>但是感觉没有 open 什么有意义的文件的样子…</p>
<h2 id="svc函数hook检测的bug"><a class="anchor" href="#svc函数hook检测的bug">#</a> svc 函数 hook 检测的 bug</h2>
<p>但是这个检测是有 bug 的，其实这个点我其实在最初就发现了，但是本着严谨的态度于是就顺着这段检测代码想要的方式去过检测</p>
<p>回到检测函数我们看到这个检测函数对 <code>sub_13E274</code>  的 12 行汇编进行完整性检测</p>
<p><img data-src="/douyin-6shen-init/image-20240816221230480.png" alt="image-20240816221230480" style="aspect-ratio:1349 / 633;"></p>
<p>但是被检查的函数，可是有 13 行的，所以我们直接对 <code>RET</code>  这行所在的地址进行 hook, 别的什么都不用做就可以成功的绕过完整性检测～</p>
<p><img data-src="/douyin-6shen-init/image-20240816222440542.png" alt="image-20240816222440542" style="aspect-ratio:1269 / 904;"></p>
<h1 id="字符串解密算法分析"><a class="anchor" href="#字符串解密算法分析">#</a> 字符串解密算法分析</h1>
<p>那么如何才能成功的输出解密后的字符串呢？我又回去看了看 hook  <code>ms.bd.c.l.a</code>  函数之后打印出来的日志，于是想着去调用最初的几个字符串参数去看看情况</p>
<p><img data-src="/douyin-6shen-init/image-20240818165242631.png" alt="image-20240818165242631" style="aspect-ratio:2356 / 235;"></p>
<p>没想到 <code>.ms</code>  和 <code>.md</code>  一起调用的时候， <code>com.bytedance.ttnet.TTNetInit</code>  可以正常输出</p>
<p><img data-src="/douyin-6shen-init/image-20240818165608816.png" alt="image-20240818165608816" style="aspect-ratio:1512 / 110;"></p>
<p>而单独调用 <code>com.bytedance.ttnet.TTNetInit</code>  输出的却是乱码</p>
<p><img data-src="/douyin-6shen-init/image-20240818165636201.png" alt="image-20240818165636201" style="aspect-ratio:1475 / 46;"></p>
<p>那先调用 <code>.ms</code>  和 <code>.md</code> , 再调用之前解密出乱码的那个密文？</p>
<p><img data-src="/douyin-6shen-init/image-20240818165937173.png" alt="image-20240818165937173" style="aspect-ratio:1510 / 309;"></p>
<p>这次字符串被成功的解密出来了！</p>
<p><img data-src="/douyin-6shen-init/image-20240818165957226.png" alt="image-20240818165957226" style="aspect-ratio:1374 / 112;"></p>
<p>所以这个加密算法也很明了了，前两次被解密的字符串初始化了密钥，他们和后续字符串解密算法所使用的密钥有所关联的</p>
<p>现在我们用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NoYW1lMWVvbi9qbml0cmFjZQ=="> jnitrace</span> 去 trace 一下解密 <code>.ms</code>  时的 JNI 调用</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>jnitrace <span class="token parameter variable">-l</span> libmetasec_ml.so <span class="token parameter variable">-b</span> fuzzy com.ss.android.ugc.awemea</pre></td></tr></table></figure><p>在 <code>0x128b24</code>  的位置读取了传入的字符串密钥和密文，它所在的函数名为 <code>sub_128AAC</code></p>
<p><img data-src="/douyin-6shen-init/image-20240818172219054.png" alt="image-20240818172219054" style="aspect-ratio:1631 / 488;"></p>
<p><img data-src="/douyin-6shen-init/image-20240818172227363.png" alt="image-20240818172227363" style="aspect-ratio:1654 / 495;"></p>
<p><img data-src="/douyin-6shen-init/image-20240820010529912.png" alt="image-20240820010529912" style="aspect-ratio:1566 / 763;"></p>
<p>在 <code>0x5664c</code>  的位置是出现了被解密的字符串，它所在的函数名为 <code>sub_5611C</code></p>
<p><img data-src="/douyin-6shen-init/image-20240818172235640.png" alt="image-20240818172235640" style="aspect-ratio:1628 / 406;"></p>
<p>进入 <code>sub_128B88</code>  后我们发现，实际上在 <code>sub_5611C</code>  最后调用的 <code>sub_128B88</code>  才是 <code>NewStringUTF</code>  的位置</p>
<p><img data-src="/douyin-6shen-init/image-20240820010457580.png" alt="image-20240820010457580" style="aspect-ratio:1121 / 248;"></p>
<p><img data-src="/douyin-6shen-init/image-20240820010508273.png" alt="image-20240820010508273" style="aspect-ratio:941 / 204;"></p>
<p>接下来我们在读取输入的函数 <code>sub_128AAC</code>  打印一下堆栈，来看看究竟是什么函数调用了他们</p>
<p>结果如下，堆栈回溯的地址都指向了 <code>sub_5611C</code></p>
<p><img data-src="/douyin-6shen-init/image-20240820014135813.png" alt="image-20240820014135813" style="aspect-ratio:1577 / 1391;"></p>
<p>在这个函数中，初始密钥为 <code>0x71,0x62,0x13,0x14,0x5f,0x77,0x63,0x41,0x31,0x30</code> , 随后做了读取 str 密钥，密文的操作，并将初始密钥与传入的密钥循环异或生成二次密钥</p>
<p><img data-src="/douyin-6shen-init/image-20240820021932419.png" alt="image-20240820021932419" style="aspect-ratio:1532 / 381;"></p>
<p>随后二次密钥与密文循环异或实现解密，但是如果没有没有实现字符串解密的两次初始化 <code>.ms</code>  和 <code>.md</code>  的话，将会对解密后的数组再次异或密钥，并异或 0x55, 通过这种方式来隐去密钥的相关特征</p>
<p><img data-src="/douyin-6shen-init/image-20240820022014949.png" alt="image-20240820022014949" style="aspect-ratio:1619 / 1415;"></p>
<p>所以最终的字符串解密算法如下～</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#code: 0x1000001</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">def</span> <span class="token function">douyin_str_dec</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> enc<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    init_key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x71</span><span class="token punctuation">,</span> <span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x13</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">,</span> <span class="token number">0x5f</span><span class="token punctuation">,</span> <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0x63</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x31</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    key <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">ord</span><span class="token punctuation">(</span>key<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> init_key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>init_key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    ret <span class="token operator">=</span> <span class="token punctuation">[</span>enc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>enc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># com.bytedance.ttnet.TTNetInit</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>douyin_str_dec<span class="token punctuation">(</span><span class="token string">"976bf9"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                     <span class="token punctuation">[</span><span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">54</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">52</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">115</span><span class="token punctuation">,</span> <span class="token number">124</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">52</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">115</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2025-04-09 02:55:11" itemprop="dateModified" datetime="2025-04-09T02:55:11+08:00">2025-04-09</time>
  </span>
  <span id="douyin-6shen-init/" class="item leancloud_visitors" data-flag-title="初探抖音六神之字符串解密算法分析" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>oacia <i class="ic i-at"><em>@</em></i>oaciaのBbBlog~
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://oacia.dev/douyin-6shen-init/" title="初探抖音六神之字符串解密算法分析">https://oacia.dev/douyin-6shen-init/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/frida-inline-hook/" itemprop="url" rel="prev" data-background-image="&#x2F;picture&#x2F;598879.webp" title="frida inline hook原理分析及实践">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>frida inline hook原理分析及实践</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/dexguard-java-str-dec/" itemprop="url" rel="next" data-background-image="&#x2F;picture&#x2F;793597.webp" title="DexGuard java字符串反混淆">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>DexGuard java字符串反混淆</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text"> 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ssl-pinning%E7%BB%95%E8%BF%87"><span class="toc-text"> ssl pinning 绕过</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E5%8F%82%E6%95%B0%E4%BD%8D%E7%BD%AE"><span class="toc-text"> 定位参数位置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#libmetasec_mlso%E5%8F%8D%E6%B7%B7%E6%B7%86"><span class="toc-text"> libmetasec_ml.so 反混淆</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%8A%A0%E8%BD%BDlibmetasec_mlso"><span class="toc-text"> 自加载 libmetasec_ml.so</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#svc%E8%B0%83%E7%94%A8"><span class="toc-text"> SVC 调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#svc%E5%87%BD%E6%95%B0hook%E6%A3%80%E6%B5%8B%E7%9A%84bug"><span class="toc-text"> svc 函数 hook 检测的 bug</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-text"> 字符串解密算法分析</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="oacia"
      data-src="/images/avatar.jpg">
  
  <svg class="logo-overview" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 540.19 380.99">
    <g id="clips" fill= #00a99d; stroke="none">
      <clipPath id="o">
        <path d="M93.57,284c8,0,14.91-1,20.75-3,5.83-2,10.41-3.66,13.75-5,4.66-1.66,6.16-.75,4.5,2.75-1.67,3.5-4.67,6.42-9,8.75-2.34,1.34-6.09,2.84-11.25,4.5-5.17,1.67-11.09,2.5-17.75,2.5-.34,8.67-3.34,16.84-9,24.5-5.67,7.67-13.34,13.34-23,17-6,2.34-12.17,3.59-18.5,3.75-6.34,.17-12.17-.66-17.5-2.5-5.34-1.83-10.09-4.66-14.25-8.5-4.17-3.83-7.25-8.41-9.25-13.75-2-5.33-2.83-11-2.5-17s1.83-11.83,4.5-17.5c2.66-5.66,6.33-10.75,11-15.25,4.66-4.5,10.16-7.75,16.5-9.75,5.66-1.66,11.41-1.66,17.25,0,5.83,1.67,10.08,4.34,12.75,8,1.66,2.67,2.5,5.67,2.5,9,3-2,6.33-3,10-3h1c3.33,0,6.5,.84,9.5,2.5,3,1.67,5.33,4.5,7,8.5l1,3.5Zm-34,39.5c5.66-.66,10.33-3.83,14-9.5,3.66-5.66,5.33-12.16,5-19.5-4.67,.34-9.09-.41-13.25-2.25-4.17-1.83-6.42-4.58-6.75-8.25-.67-3,0-5.5,2-7.5-.67-2.66-2.75-5-6.25-7s-7.09-2.16-10.75-.5c-4.67,2-8.25,5.84-10.75,11.5-2.5,5.67-3.09,11.84-1.75,18.5,1.33,8,4.75,14.34,10.25,19,5.5,4.67,11.58,6.5,18.25,5.5Z"/>
      </clipPath>
      <clipPath id="a1">
        <path d="M176.06,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      <clipPath id="c">
        <path d="M250.06,280.5c4.66-7.66,12-13.16,22-16.5,10-3.33,19.83-3.66,29.5-1,7.66,2.34,13.5,5.67,17.5,10,4,4.34,5.83,8.5,5.5,12.5-.34,4.67-2.25,8.59-5.75,11.75-3.5,3.17-7.09,5.34-10.75,6.5-3.67,1.17-6.84,1.25-9.5,.25-2.67-1-3.34-3.16-2-6.5,2.66-8,2.75-14.58,.25-19.75-2.5-5.16-5.92-6.41-10.25-3.75-2.67,1.67-5,4.09-7,7.25-2,3.17-3.5,6.75-4.5,10.75s-1.42,8.09-1.25,12.25c.16,4.17,.75,7.92,1.75,11.25,1.33,4,3.66,7.42,7,10.25,3.33,2.84,7.16,4.67,11.5,5.5,4.33,.84,8.91,.67,13.75-.5,4.83-1.16,9.25-3.75,13.25-7.75,7.33-6.66,12.33-14.33,15-23,.33-1.66,1.16-2.91,2.5-3.75,1.33-.83,2.5-1.08,3.5-.75,1,.34,1.83,1.09,2.5,2.25,.66,1.17,.66,2.92,0,5.25-2.34,9.34-6.34,17-12,23-4.67,5.67-10.5,10.42-17.5,14.25-7,3.84-14.25,6.09-21.75,6.75-7.5,.67-14.84-.33-22-3-7.17-2.66-13.25-7.5-18.25-14.5-6-8.66-8.75-17.66-8.25-27,.5-9.33,2.25-16.66,5.25-22Z"/>
      </clipPath>
      <clipPath id="i_b">
        <path d="M393.06,330c-2.34,2.67-5.17,5.09-8.5,7.25-3.34,2.17-7.09,3.59-11.25,4.25-4.17,.67-8.59,.67-13.25,0-4.67-.66-9.17-2.33-13.5-5-4.67-2.66-7.67-7.58-9-14.75-1.34-7.16-1.83-14.66-1.5-22.5,.33-7.83,1.33-14.91,3-21.25,1.66-6.33,3.33-10.16,5-11.5,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,3.59,1.25,6.75-.17,3.17-.5,6.92-1,11.25-.5,4.34-1.09,8.92-1.75,13.75-.67,4.84-.67,9.42,0,13.75,.33,3.67,1.33,6.42,3,8.25,1.66,1.84,3.5,2.84,5.5,3,2,.17,4-.25,6-1.25s3.83-2.33,5.5-4c3-3.66,5.66-7.66,8-12,2.33-4.33,4.16-8.16,5.5-11.5,1-3.66,2.91-5.25,5.75-4.75,2.83,.5,3.75,3.09,2.75,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.34,8.59-10,14.25Z"/>
      </clipPath>
      <clipPath id="a2">
        <path d="M461.56,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      
    </g>
    <g
      id="strokes"
      fill="none"
      stroke=#96d7f5
      stroke-linecap="round"
      stroke-linejoin="round"
    >
    <path
    clip-path="url(#o)"
    class="oPath path"
    d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
    stroke-width="32.5"
    ></path>
    <path
      clip-path="url(#a1)"
      class="a1Path path"
      d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
      stroke-width="59"
    ></path>
    <path
      clip-path="url(#c)"
      class="cPath path"
      d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
      stroke-width="110"
    ></path>
    <path
      clip-path="url(#i_b)"
      class="i_bPath path"
      d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
      stroke-width="33"
    ></path>
    <path
      clip-path="url(#a2)"
      class="a2Path path"
      d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
      stroke-width="70"
    ></path>
    </g>
    <g
      id="strokes2"
      fill="none"
      stroke=#ff97b8
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path
        clip-path="url(#o)"
        class="oPath path"
        d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
        stroke-width="32.5"
      ></path>
      <path
        clip-path="url(#a1)"
        class="a1Path path"
        d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
        stroke-width="59"
      ></path>
      <path
        clip-path="url(#c)"
        class="cPath path"
        d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
        stroke-width="110"
      ></path>
      <path
        clip-path="url(#i_b)"
        class="i_bPath path"
        d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
        stroke-width="33"
      ></path>
      <path
        clip-path="url(#a2)"
        class="a2Path path"
        d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
        stroke-width="70"
      ></path>
    </g>
    <g class="dot-group">
      <path
        id="dot"
        fill=#ff97b8
        d="M362.58,182.21c4.66-.33,9.66,1.17,15,4.5,5.33,3.34,7.66,7.5,7,12.5-.67,2.34-1.92,4.92-3.75,7.75-1.84,2.84-4,5.5-6.5,8s-4.84,4.75-7,6.75c-2.17,2-3.75,3.17-4.75,3.5-2.67,1.67-5.34,2.25-8,1.75-2.67-.5-5-1.5-7-3s-3.59-3.33-4.75-5.5c-1.17-2.16-1.92-4.25-2.25-6.25-.34-2,.16-4.66,1.5-8,1.33-3.33,3.08-6.58,5.25-9.75,2.16-3.16,4.58-6,7.25-8.5,2.66-2.5,5.33-3.75,8-3.75Z"
      ></path>
    </g>
  </svg>
  <div class="description" itemprop="description">月遇从云 花遇和风</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">53</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">46</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lh" title="https:&#x2F;&#x2F;github.com&#x2F;oacia"><i class="ic i-github"></i></span>
      <a target="_blank" rel="noopener" href="https://twitter.com/oacia86" title="https:&#x2F;&#x2F;twitter.com&#x2F;oacia86" class="item twitter"><i class="ic i-twitter"></i></a>
      <span class="exturl item paper-plane" data-url="aHR0cHM6Ly90Lm1lL29hY2lh" title="https:&#x2F;&#x2F;t.me&#x2F;oacia"><i class="ic i-paper-plane"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOm9hY2lhODZAZ21haWwuY29t" title="mailto:oacia86@gmail.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about-oacia/" rel="section"><i class="ic i-user"></i>关于oacia</a>
  </li>

    
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-feather"></i>文章</a>
  </li>

    
  <li class="item">
    <a href="/TODOlist/" rel="section"><i class="ic i-clock"></i>要做的事</a>
  </li>

    
  <li class="item">
    <a href="/website_maintenance/" rel="section"><i class="ic i-calendar"></i>更新日志</a>
  </li>

    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>小伙伴</a>
  </li>

    
  <li class="item">
    <a href="/music/" rel="section"><i class="ic i-music"></i>听会儿歌吧</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/frida-inline-hook/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/dexguard-java-str-dec/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2022 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">oacia @ oacia</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">968k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">14:40</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>



<script data-config type="text/javascript">
  var LOCAL = {
    path: 'douyin-6shen-init/',
    favicon: {
      show: "柚鳥ナツ",
      hide: "甘い幸せ"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>
<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>


<script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>
<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
