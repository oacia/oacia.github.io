



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="qQVmgWozVe7BXoA15J3gAZpEA5dK168admH4U3W6PAk">
  <meta name="msvalidate.01" content="4902E39C0135E72DE537BCB0FE08B40A">
  <meta name="baidu-site-verification" content="codeva-CSYjpuVg5v">


<link rel="alternate" type="application/rss+xml" title="oaciaのBbBlog~" href="https://oacia.dev/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="oaciaのBbBlog~" href="https://oacia.dev/atom.xml" />
<link rel="alternate" type="application/json" title="oaciaのBbBlog~" href="https://oacia.dev/feed.json" />
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-regular.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/noto-serif-sc-v22-chinese-simplified_latin-700.woff2"
/>
<link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin=""
      href="/fonts/font_1832207_igi8uaupcus.woff2"
/>
<link rel="preload" href="/background_picture/1_gongzi.webp" as="image" />
<link rel="preload" href="/background_picture/2_xiaoxia.webp" as="image" />
<link rel="preload" href="/background_picture/3_xingye.webp" as="image" />
<link rel="preload" href="/images/avatar.jpg" as="image" />



<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="https://oacia.dev/ElfReader/">


<meta name="description" content="在 Android 中使用 System.load  加载一个 so 时，是通过 ElfReader  去解析这个 so 的重要结构及属性的，本文将对 ELF 的结构，链接过程，装载过程进行分析，并研究 ELF 在 AOSP 中的解析过程 # ELF 结构简析 ELF 文件主要分为 3 个部分:  ELF Header  描述整个文件的组织 Program Header Table  包含了运行时">
<meta property="og:type" content="article">
<meta property="og:title" content="ELF结构分析及ElfReader">
<meta property="og:url" content="https://oacia.dev/ElfReader/">
<meta property="og:site_name" content="oaciaのBbBlog~">
<meta property="og:description" content="在 Android 中使用 System.load  加载一个 so 时，是通过 ElfReader  去解析这个 so 的重要结构及属性的，本文将对 ELF 的结构，链接过程，装载过程进行分析，并研究 ELF 在 AOSP 中的解析过程 # ELF 结构简析 ELF 文件主要分为 3 个部分:  ELF Header  描述整个文件的组织 Program Header Table  包含了运行时">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://oacia.dev/ElfReader/segment_flag_bits.png">
<meta property="og:image" content="https://oacia.dev/ElfReader/segment-permission.png">
<meta property="og:image" content="https://oacia.dev/ElfReader/elf-symtab-strtab.png">
<meta property="og:image" content="https://oacia.dev/ElfReader/linking-process.png">
<meta property="og:image" content="https://oacia.dev/ElfReader/elf-simple-merge.png">
<meta property="og:image" content="https://oacia.dev/ElfReader/elf-similar-merge.png">
<meta property="og:image" content="https://oacia.dev/ElfReader/two-step-linking.png">
<meta property="og:image" content="https://oacia.dev/ElfReader/different-elf-type.png">
<meta property="og:image" content="https://oacia.dev/ElfReader/inter-module-data-access.png">
<meta property="og:image" content="https://oacia.dev/ElfReader/executable-file-load-process.png">
<meta property="article:published_time" content="2024-02-17T06:11:23.000Z">
<meta property="article:modified_time" content="2025-04-08T18:55:11.409Z">
<meta property="article:author" content="oacia">
<meta property="article:tag" content="reverse,安卓逆向,区块链,学习笔记,破解实战,前端,CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oacia.dev/ElfReader/segment_flag_bits.png">
<meta name="twitter:creator" content="@oacia86">


  <title>
ELF结构分析及ElfReader |
oacia = oaciaのBbBlog~ = DEVIL or SWEET</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  var jq_151 = $.noConflict(true);
  var RENDERER = {
    INIT_CHERRY_BLOSSOM_COUNT : 30,
    MAX_ADDING_INTERVAL : 10,
    WATCH_INTERVAL : 300,
    
    init : function(){
      this.setParameters();
      this.reconstructMethods();
      this.setup();
      this.bindEvent();
      this.render();
    },
    setParameters : function(){
      this.$window = jq_151(window);
      this.$container = jq_151('#loading');
      this.$canvas = jq_151('<canvas />');
      this.context = this.$canvas.appendTo(this.$container).get(0).getContext('2d');
      this.cherries = [];
      this.watchIds = [];
    },
    reconstructMethods : function(){
      this.watchWindowSize = this.watchWindowSize.bind(this);
      this.jdugeToStopResize = this.jdugeToStopResize.bind(this);
      this.render = this.render.bind(this);
    },
    setup : function(){
      this.cherries.length = 0;
      this.watchIds.length = 0;
      this.width = this.$container.width();
      this.height = this.$container.height();
      this.$canvas.attr({width : this.width, height : this.height});
      this.maxAddingInterval = Math.round(this.MAX_ADDING_INTERVAL * 1000 / this.width);
      this.addingInterval = this.maxAddingInterval;
      this.createCherries();
    },
    createCherries : function(){
      for(var i = 0, length = Math.round(this.INIT_CHERRY_BLOSSOM_COUNT * this.width / 1000); i < length; i++){
        this.cherries.push(new CHERRY_BLOSSOM(this, true));
      }
    },
    watchWindowSize : function(){
      this.clearTimer();
      this.tmpWidth = window.width;
      this.tmpHeight = window.height;
      this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL));
    },
    clearTimer : function(){
      while(this.watchIds.length > 0){
        clearTimeout(this.watchIds.pop());
      }
    },
    jdugeToStopResize : function(){
      var width = window.width,
        height = window.height,
        stopped = (width == this.tmpWidth && height == this.tmpHeight);
        
      this.tmpWidth = width;
      this.tmpHeight = height;
      
      if(stopped){
        this.setup();
      }
    },
    bindEvent : function(){
      this.$window.on('resize', this.watchWindowSize);
    },
    render : function(){
      //console.log("render")

      if(jq_151(this.$container).css("display")!="none"){
        requestAnimationFrame(this.render);
      }
      
      this.context.clearRect(0, 0, this.width, this.height);
      
      this.cherries.sort(function(cherry1, cherry2){
        return cherry1.z - cherry2.z;
      });
      for(var i = this.cherries.length - 1; i >= 0; i--){
        if(!this.cherries[i].render(this.context)){
          this.cherries.splice(i, 1);
        }
      }
      if(--this.addingInterval == 0){
        this.addingInterval = this.maxAddingInterval;
        this.cherries.push(new CHERRY_BLOSSOM(this, false));
      }
    }
  };
  var CHERRY_BLOSSOM = function(renderer, isRandom){
    this.renderer = renderer;
    this.init(isRandom);
  };
  CHERRY_BLOSSOM.prototype = {
    FOCUS_POSITION : 300,
    FAR_LIMIT : 600,
    MAX_RIPPLE_COUNT : 100,
    RIPPLE_RADIUS : 100,
    SURFACE_RATE : 0.5,
    SINK_OFFSET : 20,
    
    init : function(isRandom){
      this.x = this.getRandomValue(-this.renderer.width, this.renderer.width);
      this.y = isRandom ? this.getRandomValue(0, this.renderer.height) : this.renderer.height * 1.5;
      this.z = this.getRandomValue(0, this.FAR_LIMIT);
      this.vx = this.getRandomValue(-2, 2);
      this.vy = -2;
      this.theta = this.getRandomValue(0, Math.PI * 2);
      this.phi = this.getRandomValue(0, Math.PI * 2);
      this.psi = 0;
      this.dpsi = this.getRandomValue(Math.PI / 600, Math.PI / 300);
      this.opacity = 0;
      this.endTheta = false;
      this.endPhi = false;
      this.rippleCount = 0;
      
      var axis = this.getAxis(),
        theta = this.theta + Math.ceil(-(this.y + this.renderer.height * this.SURFACE_RATE) / this.vy) * Math.PI / 500;
      theta %= Math.PI * 2;
      
      this.offsetY = 40 * ((theta <= Math.PI / 2 || theta >= Math.PI * 3 / 2) ? -1 : 1);
      this.thresholdY = this.renderer.height / 2 + this.renderer.height * this.SURFACE_RATE * axis.rate;
      this.entityColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.entityColor.addColorStop(0, 'hsl(330, 70%, ' + 50 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(0.05, 'hsl(330, 40%,' + 55 * (0.3 + axis.rate) + '%)');
      this.entityColor.addColorStop(1, 'hsl(330, 20%, ' + 70 * (0.3 + axis.rate) + '%)');
      this.shadowColor = this.renderer.context.createRadialGradient(0, 40, 0, 0, 40, 80);
      this.shadowColor.addColorStop(0, 'hsl(330, 40%, ' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(0.05, 'hsl(330, 40%,' + 30 * (0.3 + axis.rate) + '%)');
      this.shadowColor.addColorStop(1, 'hsl(330, 20%, ' + 40 * (0.3 + axis.rate) + '%)');
    },
    getRandomValue : function(min, max){
      return min + (max - min) * Math.random();
    },
    getAxis : function(){
      var rate = this.FOCUS_POSITION / (this.z + this.FOCUS_POSITION),
        x = this.renderer.width / 2 + this.x * rate,
        y = this.renderer.height / 2 - this.y * rate;
      return {rate : rate, x : x, y : y};
    },
    renderCherry : function(context, axis){
      context.beginPath();
      context.moveTo(0, 40);
      context.bezierCurveTo(-60, 20, -10, -60, 0, -20);
      context.bezierCurveTo(10, -60, 60, 20, 0, 40);
      context.fill();
      
      for(var i = -4; i < 4; i++){
        context.beginPath();
        context.moveTo(0, 40);
        context.quadraticCurveTo(i * 12, 10, i * 4, -24 + Math.abs(i) * 2);
        context.stroke();
      }
    },
    render : function(context){
      var axis = this.getAxis();
      
      if(axis.y == this.thresholdY && this.rippleCount < this.MAX_RIPPLE_COUNT){
        context.save();
        context.lineWidth = 2;
        context.strokeStyle = 'hsla(0, 0%, 100%, ' + (this.MAX_RIPPLE_COUNT - this.rippleCount) / this.MAX_RIPPLE_COUNT + ')';
        context.translate(axis.x + this.offsetY * axis.rate * (this.theta <= Math.PI ? -1 : 1), axis.y);
        context.scale(1, 0.3);
        context.beginPath();
        context.arc(0, 0, this.rippleCount / this.MAX_RIPPLE_COUNT * this.RIPPLE_RADIUS * axis.rate, 0, Math.PI * 2, false);
        context.stroke();
        context.restore();
        this.rippleCount++;
      }
      if(axis.y < this.thresholdY || (!this.endTheta || !this.endPhi)){
        if(this.y <= 0){
          this.opacity = Math.min(this.opacity + 0.01, 1);
        }
        context.save();
        context.globalAlpha = this.opacity;
        context.fillStyle = this.shadowColor;
        context.strokeStyle = 'hsl(330, 30%,' + 40 * (0.3 + axis.rate) + '%)';
        context.translate(axis.x, Math.max(axis.y, this.thresholdY + this.thresholdY - axis.y));
        context.rotate(Math.PI - this.theta);
        context.scale(axis.rate * -Math.sin(this.phi), axis.rate);
        context.translate(0, this.offsetY);
        this.renderCherry(context, axis);
        context.restore();
      }
      context.save();
      context.fillStyle = this.entityColor;
      context.strokeStyle = 'hsl(330, 40%,' + 70 * (0.3 + axis.rate) + '%)';
      context.translate(axis.x, axis.y + Math.abs(this.SINK_OFFSET * Math.sin(this.psi) * axis.rate));
      context.rotate(this.theta);
      context.scale(axis.rate * Math.sin(this.phi), axis.rate);
      context.translate(0, this.offsetY);
      this.renderCherry(context, axis);
      context.restore();
      
      if(this.y <= -this.renderer.height / 4){
        if(!this.endTheta){
          for(var theta = Math.PI / 2, end = Math.PI * 3 / 2; theta <= end; theta += Math.PI){
            if(this.theta < theta && this.theta + Math.PI / 200 > theta){
              this.theta = theta;
              this.endTheta = true;
              break;
            }
          }
        }
        if(!this.endPhi){
          for(var phi = Math.PI / 8, end = Math.PI * 7 / 8; phi <= end; phi += Math.PI * 3 / 4){
            if(this.phi < phi && this.phi + Math.PI / 200 > phi){
              this.phi = Math.PI / 8;
              this.endPhi = true;
              break;
            }
          }
        }
      }
      if(!this.endTheta){
        if(axis.y == this.thresholdY){
          this.theta += Math.PI / 200 * ((this.theta < Math.PI / 2 || (this.theta >= Math.PI && this.theta < Math.PI * 3 / 2)) ? 1 : -1);
        }else{
          this.theta += Math.PI / 500;
        }
        this.theta %= Math.PI * 2;
      }
      if(this.endPhi){
        if(this.rippleCount == this.MAX_RIPPLE_COUNT){
          this.psi += this.dpsi;
          this.psi %= Math.PI * 2;
        }
      }else{
        this.phi += Math.PI / ((axis.y == this.thresholdY) ? 200 : 500);
        this.phi %= Math.PI;
      }
      if(this.y <= -this.renderer.height * this.SURFACE_RATE){
        this.x += 2;
        this.y = -this.renderer.height * this.SURFACE_RATE;
      }else{
        this.x += this.vx;
        this.y += this.vy;
      }
      return this.z > -this.FOCUS_POSITION && this.z < this.FAR_LIMIT && this.x < this.renderer.width * 1.5;
    }
  };
  jq_151(function(){
    RENDERER.init();
  });
</script>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <!--
    <div class="alice">
      <img src="/images/alice-shake.gif" alt="">
    </div>

    
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
    -->
  </div>
  <script
      defer="defer"
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"
      integrity="sha512-1dalHDkG9EtcOmCnoCjiwQ/HEB5SDNqw8d4G2MKoNwjiwMNeBAkudsBCmSlMnXdsH8Bm0mOd3tl/6nL5y0bMaQ=="
      crossorigin="anonymous"
    ></script>
  <script defer="defer" src="/js/gsap/DrawSVGPlugin.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomEase.min.js"></script>
  <script defer="defer" src="/js/gsap/CustomBounce.min.js"></script>
  <script defer="defer" src="/js/gsap/SplitText.min.js"></script>
  <script defer="defer" src="/js/gsap/logo-run.js"></script>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">ELF结构分析及ElfReader
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2024-02-17 14:11:23">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2024-02-17T14:11:23+08:00">2024-02-17</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>34k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>31 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">oacia</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="/background_picture/1_mary.jpg"></li>
          <li class="item" data-background-image="/background_picture/2_xingye.webp"></li>
          <li class="item" data-background-image="/background_picture/3_xiaoxia.webp"></li>
          <li class="item" data-background-image="/background_picture/4_alice.webp"></li>
          <li class="item" data-background-image="/background_picture/5_mutsuki.jpg"></li>
          <li class="item" data-background-image="/background_picture/6_arona_plana.webp"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb">
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://oacia.dev/ElfReader/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="oacia">
    <meta itemprop="description" content="DEVIL or SWEET, 月遇从云 花遇和风">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="oaciaのBbBlog~">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p>在 Android 中使用 <code>System.load</code>  加载一个 so 时，是通过 <code>ElfReader</code>  去解析这个 so 的重要结构及属性的，本文将对 ELF 的结构，链接过程，装载过程进行分析，并研究 ELF 在 AOSP 中的解析过程</p>
<h1 id="elf结构简析"><a class="anchor" href="#elf结构简析">#</a> ELF 结构简析</h1>
<p>ELF 文件主要分为 3 个部分:</p>
<ul>
<li>ELF Header<br>
 描述整个文件的组织</li>
<li>Program Header Table<br>
 包含了<strong>运行时</strong>加载程序所需要的信息</li>
<li>Section Header Table<br>
 包含了<strong>链接时</strong>所需要用到的信息</li>
</ul>
<h2 id="elf-header"><a class="anchor" href="#elf-header">#</a> ELF Header</h2>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//https://github.com/bminor/glibc/blob/glibc-2.27/elf/elf.h</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EI_NIDENT</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span>	e_ident<span class="token punctuation">[</span>EI_NIDENT<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* Magic number and other info */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  Elf32_Half	e_type<span class="token punctuation">;</span>			<span class="token comment">/* Object file type */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  Elf32_Half	e_machine<span class="token punctuation">;</span>		<span class="token comment">/* Architecture */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  Elf32_Word	e_version<span class="token punctuation">;</span>		<span class="token comment">/* Object file version */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  Elf32_Addr	e_entry<span class="token punctuation">;</span>		<span class="token comment">/* Entry point virtual address */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  Elf32_Off	e_phoff<span class="token punctuation">;</span>		<span class="token comment">/* Program header table file offset */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  Elf32_Off	e_shoff<span class="token punctuation">;</span>		<span class="token comment">/* Section header table file offset */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  Elf32_Word	e_flags<span class="token punctuation">;</span>		<span class="token comment">/* Processor-specific flags */</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  Elf32_Half	e_ehsize<span class="token punctuation">;</span>		<span class="token comment">/* ELF header size in bytes */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  Elf32_Half	e_phentsize<span class="token punctuation">;</span>		<span class="token comment">/* Program header table entry size */</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  Elf32_Half	e_phnum<span class="token punctuation">;</span>		<span class="token comment">/* Program header table entry count */</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  Elf32_Half	e_shentsize<span class="token punctuation">;</span>		<span class="token comment">/* Section header table entry size */</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  Elf32_Half	e_shnum<span class="token punctuation">;</span>		<span class="token comment">/* Section header table entry count */</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  Elf32_Half	e_shstrndx<span class="token punctuation">;</span>		<span class="token comment">/* Section header string table index */</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Ehdr<span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="e_identei_nident"><a class="anchor" href="#e_identei_nident">#</a> e_ident[EI_NIDENT]</h3>
<p>该变量给出了用于解码和解释文件中与机器无关的数据的方式。这个数组对于不同的下标的含义如下</p>
<table>
<thead>
<tr>
<th style="text-align:left">宏名称</th>
<th style="text-align:left">下标</th>
<th style="text-align:left">目的</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">EI_MAG0</td>
<td style="text-align:left">0</td>
<td style="text-align:left">文件标识</td>
</tr>
<tr>
<td style="text-align:left">EI_MAG1</td>
<td style="text-align:left">1</td>
<td style="text-align:left">文件标识</td>
</tr>
<tr>
<td style="text-align:left">EI_MAG2</td>
<td style="text-align:left">2</td>
<td style="text-align:left">文件标识</td>
</tr>
<tr>
<td style="text-align:left">EI_MAG3</td>
<td style="text-align:left">3</td>
<td style="text-align:left">文件标识</td>
</tr>
<tr>
<td style="text-align:left">EI_CLASS</td>
<td style="text-align:left">4</td>
<td style="text-align:left">文件类</td>
</tr>
<tr>
<td style="text-align:left">EI_DATA</td>
<td style="text-align:left">5</td>
<td style="text-align:left">数据编码</td>
</tr>
<tr>
<td style="text-align:left">EI_VERSION</td>
<td style="text-align:left">6</td>
<td style="text-align:left">文件版本</td>
</tr>
<tr>
<td style="text-align:left">EI_PAD</td>
<td style="text-align:left">7</td>
<td style="text-align:left">补齐字节开始处</td>
</tr>
</tbody>
</table>
<h4 id="e_identei_mag0ei_mag3"><a class="anchor" href="#e_identei_mag0ei_mag3">#</a> e_ident[EI_MAG0…EI_MAG3]</h4>
<p>这是 ELF 文件的头 4 个字节，被称作 “魔数”，标识该文件是一个 ELF 目标文件。</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">值</th>
<th style="text-align:left">位置</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ELFMAG0</td>
<td style="text-align:left">0x7f</td>
<td style="text-align:left">e_ident[EI_MAG0]</td>
</tr>
<tr>
<td style="text-align:left">ELFMAG1</td>
<td style="text-align:left">‘E’</td>
<td style="text-align:left">e_ident[EI_MAG1]</td>
</tr>
<tr>
<td style="text-align:left">ELFMAG2</td>
<td style="text-align:left">‘L’</td>
<td style="text-align:left">e_ident[EI_MAG2]</td>
</tr>
<tr>
<td style="text-align:left">ELFMAG3</td>
<td style="text-align:left">‘F’</td>
<td style="text-align:left">e_ident[EI_MAG3]</td>
</tr>
</tbody>
</table>
<h4 id="e_identei_class"><a class="anchor" href="#e_identei_class">#</a> e_ident[EI_CLASS]</h4>
<p>标识文件的类型或容量</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">值</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ELFCLASSNONE</td>
<td style="text-align:left">0</td>
<td style="text-align:left">无效类型</td>
</tr>
<tr>
<td style="text-align:left">ELFCLASS32</td>
<td style="text-align:left">1</td>
<td style="text-align:left">32 位文件</td>
</tr>
<tr>
<td style="text-align:left">ELFCLASS64</td>
<td style="text-align:left">2</td>
<td style="text-align:left">64 位文件</td>
</tr>
</tbody>
</table>
<h4 id="e_identei_data"><a class="anchor" href="#e_identei_data">#</a> e_ident[EI_DATA]</h4>
<p>给出目标文件中的特定处理器数据的编码方式</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">值</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ELFDATANONE</td>
<td style="text-align:left">0</td>
<td style="text-align:left">无效数据编码</td>
</tr>
<tr>
<td style="text-align:left">ELFDATA2LSB</td>
<td style="text-align:left">1</td>
<td style="text-align:left">小端</td>
</tr>
<tr>
<td style="text-align:left">ELFDATA2MSB</td>
<td style="text-align:left">2</td>
<td style="text-align:left">大端</td>
</tr>
</tbody>
</table>
<h3 id="e_type"><a class="anchor" href="#e_type">#</a> e_type</h3>
<p><code>e_type</code>  标识目标文件类型。</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">值</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ET_NONE</td>
<td style="text-align:left">0</td>
<td style="text-align:left">无文件类型</td>
</tr>
<tr>
<td style="text-align:left">ET_REL</td>
<td style="text-align:left">1</td>
<td style="text-align:left">可重定位文件</td>
</tr>
<tr>
<td style="text-align:left">ET_EXEC</td>
<td style="text-align:left">2</td>
<td style="text-align:left">可执行文件</td>
</tr>
<tr>
<td style="text-align:left">ET_DYN</td>
<td style="text-align:left">3</td>
<td style="text-align:left">共享目标文件</td>
</tr>
<tr>
<td style="text-align:left">ET_CORE</td>
<td style="text-align:left">4</td>
<td style="text-align:left">核心转储文件</td>
</tr>
<tr>
<td style="text-align:left">ET_LOPROC</td>
<td style="text-align:left">0xff00</td>
<td style="text-align:left">处理器指定下限</td>
</tr>
<tr>
<td style="text-align:left">ET_HIPROC</td>
<td style="text-align:left">0xffff</td>
<td style="text-align:left">处理器指定上限</td>
</tr>
</tbody>
</table>
<h3 id="e_machine"><a class="anchor" href="#e_machine">#</a> e_machine</h3>
<p>这一项指定了当前文件可以运行的机器架构，EM 是  <code>ELF Machine</code>  的简写</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">值</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">EM_NONE</td>
<td style="text-align:left">0</td>
<td style="text-align:left">无机器类型</td>
</tr>
<tr>
<td style="text-align:left">EM_M32</td>
<td style="text-align:left">1</td>
<td style="text-align:left">AT&amp;T WE 32100</td>
</tr>
<tr>
<td style="text-align:left">EM_SPARC</td>
<td style="text-align:left">2</td>
<td style="text-align:left">SPARC</td>
</tr>
<tr>
<td style="text-align:left">EM_386</td>
<td style="text-align:left">3</td>
<td style="text-align:left">Intel 80386</td>
</tr>
<tr>
<td style="text-align:left">EM_68K</td>
<td style="text-align:left">4</td>
<td style="text-align:left">Motorola 68000</td>
</tr>
<tr>
<td style="text-align:left">EM_88K</td>
<td style="text-align:left">5</td>
<td style="text-align:left">Motorola 88000</td>
</tr>
<tr>
<td style="text-align:left">EM_860</td>
<td style="text-align:left">7</td>
<td style="text-align:left">Intel 80860</td>
</tr>
<tr>
<td style="text-align:left">EM_MIPS</td>
<td style="text-align:left">8</td>
<td style="text-align:left">MIPS RS3000</td>
</tr>
</tbody>
</table>
<h3 id="e_version"><a class="anchor" href="#e_version">#</a> e_version</h3>
<p>标识目标文件的版本。</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">值</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">EV_NONE</td>
<td style="text-align:left">0</td>
<td style="text-align:left">无效版本</td>
</tr>
<tr>
<td style="text-align:left">EV_CURRENT</td>
<td style="text-align:left">1</td>
<td style="text-align:left">当前版本</td>
</tr>
</tbody>
</table>
<h3 id="e_entry"><a class="anchor" href="#e_entry">#</a> e_entry</h3>
<p>这一项为系统转交控制权给 ELF 中相应代码的虚拟地址。如果没有相关的入口项，则这一项为 0。</p>
<p>例如当 <code>e_entry</code>  为 <code>00 00 80 00</code>  时，得到可执行程序的入口地址为 <code>0x8000</code></p>
<p>它是程序的入口虚拟地址，注意不是 main 函数的地址，而是 <code>.text</code>  段的首地址 <code>_start</code> 。当然这也要求程序本身非 PIE ( <code>-no-pie</code> ) 编译的且 ASLR 关闭的情况下，对于非 <code>ET_EXEC</code>  类型通常并不是实际的虚拟地址值.</p>
<h3 id="e_phoff"><a class="anchor" href="#e_phoff">#</a> e_phoff</h3>
<p>这一项给出<strong>程序头部表</strong>在文件中的字节偏移（<strong>Program Header table OFFset</strong>）。如果文件中没有程序头部表，则为 0。</p>
<h3 id="e_shoff"><a class="anchor" href="#e_shoff">#</a> e_shoff</h3>
<p>这一项给出<strong>节头表</strong>在文件中的字节偏移（ <strong>Section Header table OFFset</strong> ）。如果文件中没有节头表，则为 0。</p>
<h3 id="e_flags"><a class="anchor" href="#e_flags">#</a> e_flags</h3>
<p>这一项给出文件中与特定处理器相关的标志，这些标志命名格式为 <code>EF_machine_flag</code> 。</p>
<h3 id="e_ehsize"><a class="anchor" href="#e_ehsize">#</a> e_ehsize</h3>
<p>这一项给出 ELF 文件头部的字节长度（ELF Header Size）。</p>
<h3 id="e_phentsize"><a class="anchor" href="#e_phentsize">#</a> e_phentsize</h3>
<p>这一项给出程序头部表中每个表项的字节长度（<strong>Program Header ENTry SIZE</strong>）。每个表项的大小相同。</p>
<h3 id="e_phnum"><a class="anchor" href="#e_phnum">#</a> e_phnum</h3>
<p>这一项给出程序头部表的项数（ <strong>Program Header entry NUMber</strong> ）。因此， <code>e_phnum</code>  与  <code>e_phentsize</code>  的乘积即为程序头部表的字节长度。如果文件中没有程序头部表，则该项值为 0。</p>
<h3 id="e_shentsize"><a class="anchor" href="#e_shentsize">#</a> e_shentsize</h3>
<p>这一项给出节头的字节长度（<strong>Section Header ENTry SIZE</strong>）。一个节头是节头表中的一项；节头表中所有项占据的空间大小相同。</p>
<h3 id="e_shnum"><a class="anchor" href="#e_shnum">#</a> e_shnum</h3>
<p>这一项给出节头表中的项数（<strong>Section Header NUMber</strong>）。因此，  <code>e_shnum</code>  与  <code>e_shentsize</code>  的乘积即为节头表的字节长度。如果文件中没有节头表，则该项值为 0。</p>
<h3 id="e_shstrndx"><a class="anchor" href="#e_shstrndx">#</a> e_shstrndx</h3>
<p>这一项给出节头表中与节名字符串表相关的表项的索引值（<strong>Section Header table InDeX related with section name STRing table</strong>）, 即 section table 中的第<em> e_shstrndx</em> 项元素，保存了所有 section table 名称的字符串信息。如果文件中没有节名字符串表，则该项值为 <code>SHN_UNDEF</code></p>
<h2 id="program-header"><a class="anchor" href="#program-header">#</a> Program Header</h2>
<p>Program Header Table 是一个结构体数组，每一个元素的类型是  <code>Elf32_Phdr</code> ，描述了一个段或者其它系统在准备程序执行时所需要的信息。其中，ELF 头中的  <code>e_phentsize</code>  和  <code>e_phnum</code>  指定了该数组每个元素的大小以及元素个数。一个目标文件的段包含一个或者多个节。<strong>程序的头部只有对于可执行文件和共享目标文件有意义。</strong></p>
<p>可以说，Program Header Table 就是专门为 ELF 文件运行时中的段所准备的。</p>
<p><code>Elf32_Phdr</code>  的数据结构如下</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  Elf32_Word	p_type<span class="token punctuation">;</span>			<span class="token comment">/* Segment type */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  Elf32_Off	    p_offset<span class="token punctuation">;</span>		<span class="token comment">/* Segment file offset */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  Elf32_Addr	p_vaddr<span class="token punctuation">;</span>		<span class="token comment">/* Segment virtual address */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  Elf32_Addr	p_paddr<span class="token punctuation">;</span>		<span class="token comment">/* Segment physical address */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  Elf32_Word	p_filesz<span class="token punctuation">;</span>		<span class="token comment">/* Segment size in file */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  Elf32_Word	p_memsz<span class="token punctuation">;</span>		<span class="token comment">/* Segment size in memory */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  Elf32_Word	p_flags<span class="token punctuation">;</span>		<span class="token comment">/* Segment flags */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  Elf32_Word	p_align<span class="token punctuation">;</span>		<span class="token comment">/* Segment alignment */</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Phdr<span class="token punctuation">;</span></pre></td></tr></table></figure><p>每个字段的说明如下</p>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">p_type</td>
<td style="text-align:left">该字段为段的类型，或者表明了该结构的相关信息。</td>
</tr>
<tr>
<td style="text-align:left">p_offset</td>
<td style="text-align:left">该字段给出了从文件开始到该段开头的第一个字节的偏移。</td>
</tr>
<tr>
<td style="text-align:left">p_vaddr</td>
<td style="text-align:left">该字段给出了该段第一个字节在内存中的虚拟地址。</td>
</tr>
<tr>
<td style="text-align:left">p_paddr</td>
<td style="text-align:left">该字段仅用于物理地址寻址相关的系统中， 由于 “System V” 忽略了应用程序的物理寻址，可执行文件和共享目标文件的该项内容并未被限定。</td>
</tr>
<tr>
<td style="text-align:left">p_filesz</td>
<td style="text-align:left">该字段给出了文件镜像中该段的大小，可能为 0。</td>
</tr>
<tr>
<td style="text-align:left">p_memsz</td>
<td style="text-align:left">该字段给出了内存镜像中该段的大小，可能为 0。</td>
</tr>
<tr>
<td style="text-align:left">p_flags</td>
<td style="text-align:left">该字段给出了与段相关的标记。</td>
</tr>
<tr>
<td style="text-align:left">p_align</td>
<td style="text-align:left">可加载的程序的段的 p_vaddr 以及 p_offset 的大小必须是 page 的整数倍。该成员给出了段在文件以及内存中的对齐方式。如果该值为 0 或 1 的话，表示不需要对齐。除此之外，p_align 应该是 2 的整数指数次方，并且 p_vaddr 与 p_offset 在模 p_align 的意义下，应该相等。</td>
</tr>
</tbody>
</table>
<h3 id="p_type"><a class="anchor" href="#p_type">#</a> p_type</h3>
<p>可执行文件中的段类型如下</p>
<table>
<thead>
<tr>
<th style="text-align:left">名字</th>
<th style="text-align:left">取值</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">PT_NULL</td>
<td style="text-align:left">0</td>
<td style="text-align:left">表明段未使用，其结构中其他成员都是未定义的。</td>
</tr>
<tr>
<td style="text-align:left">PT_LOAD</td>
<td style="text-align:left">1</td>
<td style="text-align:left">此类型段为一个可加载的段，大小由 p_filesz 和 p_memsz 描述。文件中的字节被映射到相应内存段开始处。如果 p_memsz 大于 p_filesz，“剩余” 的字节都要被置为 0。p_filesz 不能大于 p_memsz。可加载的段在程序头部中按照 p_vaddr 的升序排列。</td>
</tr>
<tr>
<td style="text-align:left">PT_DYNAMIC</td>
<td style="text-align:left">2</td>
<td style="text-align:left">此类型段给出动态链接信息。</td>
</tr>
<tr>
<td style="text-align:left">PT_INTERP</td>
<td style="text-align:left">3</td>
<td style="text-align:left">此类型段给出了一个以 NULL 结尾的字符串的位置和长度，该字符串将被当作解释器调用。这种段类型仅对可执行文件有意义（也可能出现在共享目标文件中）。此外，这种段在一个文件中最多出现一次。而且这种类型的段存在的话，它必须在所有可加载段项的前面。</td>
</tr>
<tr>
<td style="text-align:left">PT_NOTE</td>
<td style="text-align:left">4</td>
<td style="text-align:left">此类型段给出附加信息的位置和大小。</td>
</tr>
<tr>
<td style="text-align:left">PT_SHLIB</td>
<td style="text-align:left">5</td>
<td style="text-align:left">该段类型被保留，不过语义未指定。而且，包含这种类型的段的程序不符合 ABI 标准。</td>
</tr>
<tr>
<td style="text-align:left">PT_PHDR</td>
<td style="text-align:left">6</td>
<td style="text-align:left">该段类型的数组元素如果存在的话，则给出了程序头部表自身的大小和位置，既包括在文件中也包括在内存中的信息。此类型的段在文件中最多出现一次。<strong>此外，只有程序头部表是程序的内存映像的一部分时，它才会出现</strong>。如果此类型段存在，则必须在所有可加载段项目的前面。</td>
</tr>
<tr>
<td style="text-align:left">PT_LOPROC~PT_HIPROC</td>
<td style="text-align:left">0x70000000 ~0x7fffffff</td>
<td style="text-align:left">此范围的类型保留给处理器专用语义。</td>
</tr>
</tbody>
</table>
<h3 id="p_flags"><a class="anchor" href="#p_flags">#</a> p_flags</h3>
<p>被系统加载到内存中的程序至少有一个可加载的段。当系统为可加载的段创建内存镜像时，它会按照 p_flags 将段<strong>设置为对应的权限</strong>。可能的段权限位有</p>
<p><img data-src="/ElfReader/segment_flag_bits.png" alt="img" style="aspect-ratio:809 / 251;"></p>
<p>其中，所有在 PF_MASKPROC 中的比特位都是被保留用于与处理器相关的语义信息。</p>
<p>如果一个权限位被设置为 0，这种类型的段是不可访问的。实际的内存权限取决于相应的内存管理单元，不同的系统可能操作方式不一样。尽管所有的权限组合都是可以的，但是系统一般会授予比请求更多的权限。在任何情况下，除非明确说明，一个段不会有写权限。下面给出了所有的可能组合。</p>
<p><img data-src="/ElfReader/segment-permission.png" alt="img" style="aspect-ratio:842 / 375;"></p>
<p>例如，一般来说，.text 段一般具有读和执行权限，但是不会有写权限。数据段一般具有写，读，以及执行权限。</p>
<h2 id="section-header"><a class="anchor" href="#section-header">#</a> Section Header</h2>
<p>ELF 头中的  <code>e_shoff</code>  项给出了从文件开头到节头表位置的字节偏移。 <code>e_shnum</code>  告诉了我们节头表包含的项数； <code>e_shentsize</code>  给出了每一项的字节大小。</p>
<p>节头表是一个数组，每个数组的元素的类型是  <code>ELF32_Shdr</code>  ，每一个元素都描述了一个节区的概要内容。每个节区头部可以用下面的数据结构进行描述：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  Elf32_Word	sh_name<span class="token punctuation">;</span>		<span class="token comment">/* Section name (string tbl index) */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  Elf32_Word	sh_type<span class="token punctuation">;</span>		<span class="token comment">/* Section type */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  Elf32_Word	sh_flags<span class="token punctuation">;</span>		<span class="token comment">/* Section flags */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  Elf32_Addr	sh_addr<span class="token punctuation">;</span>		<span class="token comment">/* Section virtual addr at execution */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  Elf32_Off	sh_offset<span class="token punctuation">;</span>		<span class="token comment">/* Section file offset */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  Elf32_Word	sh_size<span class="token punctuation">;</span>		<span class="token comment">/* Section size in bytes */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  Elf32_Word	sh_link<span class="token punctuation">;</span>		<span class="token comment">/* Link to another section */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  Elf32_Word	sh_info<span class="token punctuation">;</span>		<span class="token comment">/* Additional section information */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  Elf32_Word	sh_addralign<span class="token punctuation">;</span>		<span class="token comment">/* Section alignment */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  Elf32_Word	sh_entsize<span class="token punctuation">;</span>		<span class="token comment">/* Entry size if section holds table */</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span> Elf32_Shdr<span class="token punctuation">;</span></pre></td></tr></table></figure><p>每个字段的含义如下</p>
<table>
<thead>
<tr>
<th style="text-align:left">成员</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">sh_name</td>
<td style="text-align:left">节名称，是节区头字符串表节区中（Section Header String Table Section）的索引，因此该字段实际是一个数值。在字符串表中的具体内容是以 NULL 结尾的字符串。</td>
</tr>
<tr>
<td style="text-align:left">sh_type</td>
<td style="text-align:left">根据节的内容和语义进行分类，具体的类型下面会介绍。</td>
</tr>
<tr>
<td style="text-align:left">sh_flags</td>
<td style="text-align:left">每一比特代表不同的标志，描述节是否可写，可执行，需要分配内存等属性。</td>
</tr>
<tr>
<td style="text-align:left">sh_addr</td>
<td style="text-align:left">如果节区将出现在进程的内存映像中，此成员给出节区的第一个字节应该在进程镜像中的位置。否则，此字段为 0。</td>
</tr>
<tr>
<td style="text-align:left">sh_offset</td>
<td style="text-align:left">给出节区的第一个字节与文件开始处之间的偏移。SHT_NOBITS 类型的节区不占用文件的空间，因此其 sh_offset 成员给出的是概念性的偏移。</td>
</tr>
<tr>
<td style="text-align:left">sh_size</td>
<td style="text-align:left">此成员给出节区的字节大小。除非节区的类型是 SHT_NOBITS ，否则该节占用文件中的 sh_size 字节。类型为 SHT_NOBITS 的节区长度可能非零，不过却不占用文件中的空间。</td>
</tr>
<tr>
<td style="text-align:left">sh_link</td>
<td style="text-align:left">此成员给出节区头部表索引链接，其具体的解释依赖于节区类型。</td>
</tr>
<tr>
<td style="text-align:left">sh_info</td>
<td style="text-align:left">此成员给出附加信息，其解释依赖于节区类型。</td>
</tr>
<tr>
<td style="text-align:left">sh_addralign</td>
<td style="text-align:left">某些节区的地址需要对齐。例如，如果一个节区有一个 doubleword 类型的变量，那么系统必须保证整个节区按双字对齐。也就是说， <code>sh_addr%sh_addralign=0</code> 。目前它仅允许为 0，以及 2 的正整数幂数。 0 和 1 表示没有对齐约束。</td>
</tr>
<tr>
<td style="text-align:left">sh_entsize</td>
<td style="text-align:left">某些节区中存在具有固定大小的表项的表，如符号表。对于这类节区，该成员给出每个表项的字节大小。反之，此成员取值为 0。</td>
</tr>
</tbody>
</table>
<h3 id="sh_type"><a class="anchor" href="#sh_type">#</a> sh_type</h3>
<p>节类型目前有下列可选范围，其中 SHT 是 <strong>Section Header Table</strong> 的简写。</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">取值</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SHT_NULL</td>
<td style="text-align:left">0</td>
<td style="text-align:left">该类型节区是非活动的，这种类型的节头中的其它成员取值无意义。</td>
</tr>
<tr>
<td style="text-align:left">SHT_PROGBITS</td>
<td style="text-align:left">1</td>
<td style="text-align:left">该类型节区包含程序定义的信息，它的格式和含义都由程序来决定。</td>
</tr>
<tr>
<td style="text-align:left">SHT_SYMTAB</td>
<td style="text-align:left">2</td>
<td style="text-align:left">该类型节区包含一个符号表（<strong>SYMbol TABle</strong>）。目前目标文件对每种类型的节区都只 能包含一个，不过这个限制将来可能发生变化。 一般，SHT_SYMTAB 节区提供用于链接编辑（指 ld 而言） 的符号，尽管也可用来实现动态链接。</td>
</tr>
<tr>
<td style="text-align:left">SHT_STRTAB</td>
<td style="text-align:left">3</td>
<td style="text-align:left">该类型节区包含字符串表（ <strong>STRing TABle</strong> ）。</td>
</tr>
<tr>
<td style="text-align:left">SHT_RELA</td>
<td style="text-align:left">4</td>
<td style="text-align:left">该类型节区包含显式指定位数的重定位项（ <strong>RELocation entry with Addends</strong> ），例如，32 位目标文件中的 Elf32_Rela 类型。此外，目标文件可能拥有多个重定位节区。</td>
</tr>
<tr>
<td style="text-align:left">SHT_HASH</td>
<td style="text-align:left">5</td>
<td style="text-align:left">该类型节区包含符号哈希表（ <strong>HASH table</strong> ）。</td>
</tr>
<tr>
<td style="text-align:left">SHT_DYNAMIC</td>
<td style="text-align:left">6</td>
<td style="text-align:left">该类型节区包含动态链接的信息（ <strong>DYNAMIC linking</strong> ）。</td>
</tr>
<tr>
<td style="text-align:left">SHT_NOTE</td>
<td style="text-align:left">7</td>
<td style="text-align:left">该类型节区包含以某种方式标记文件的信息（<strong>NOTE</strong>）。</td>
</tr>
<tr>
<td style="text-align:left">SHT_NOBITS</td>
<td style="text-align:left">8</td>
<td style="text-align:left">该类型节区不占用文件的空间，其它方面和 SHT_PROGBITS 相似。尽管该类型节区不包含任何字节，其对应的节头成员 sh_offset 中还是会包含概念性的文件偏移。</td>
</tr>
<tr>
<td style="text-align:left">SHT_REL</td>
<td style="text-align:left">9</td>
<td style="text-align:left">该类型节区包含重定位表项（<strong>RELocation entry without Addends</strong>），不过并没有指定位数。例如，32 位目标文件中的 Elf32_rel 类型。目标文件中可以拥有多个重定位节区。</td>
</tr>
<tr>
<td style="text-align:left">SHT_SHLIB</td>
<td style="text-align:left">10</td>
<td style="text-align:left">该类型此节区被保留，不过其语义尚未被定义。</td>
</tr>
<tr>
<td style="text-align:left">SHT_DYNSYM</td>
<td style="text-align:left">11</td>
<td style="text-align:left">作为一个完整的符号表，它可能包含很多对动态链接而言不必 要的符号。因此，目标文件也可以包含一个 SHT_DYNSYM 节区，其中保存动态链接符号的一个最小集合，以节省空间。</td>
</tr>
<tr>
<td style="text-align:left">SHT_LOPROC</td>
<td style="text-align:left">0X70000000</td>
<td style="text-align:left">此值指定保留给处理器专用语义的下界（ <strong>LOw PROCessor-specific semantics</strong> ）。</td>
</tr>
<tr>
<td style="text-align:left">SHT_HIPROC</td>
<td style="text-align:left">OX7FFFFFFF</td>
<td style="text-align:left">此值指定保留给处理器专用语义的上界（ <strong>HIgh PROCessor-specific semantics</strong> ）。</td>
</tr>
<tr>
<td style="text-align:left">SHT_LOUSER</td>
<td style="text-align:left">0X80000000</td>
<td style="text-align:left">此值指定保留给应用程序的索引下界。</td>
</tr>
<tr>
<td style="text-align:left">SHT_HIUSER</td>
<td style="text-align:left">0X8FFFFFFF</td>
<td style="text-align:left">此值指定保留给应用程序的索引上界。</td>
</tr>
</tbody>
</table>
<h3 id="sh_flags"><a class="anchor" href="#sh_flags">#</a> sh_flags</h3>
<p>节头中  <code>sh_flags</code>  字段的每一个比特位都可以给出其相应的标记信息，其定义了对应的节区的内容是否可以被修改、被执行等信息。如果一个标志位被设置，则该位取值为 1，未定义的位都为 0。目前已定义值如下，其他值保留。</p>
<table>
<thead>
<tr>
<th style="text-align:left">名称</th>
<th style="text-align:left">值</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SHF_WRITE</td>
<td style="text-align:left">0x1</td>
<td style="text-align:left">这种节包含了进程运行过程中可以被写的数据。</td>
</tr>
<tr>
<td style="text-align:left">SHF_ALLOC</td>
<td style="text-align:left">0x2</td>
<td style="text-align:left">这种节在进程运行时占用内存。对于不占用目标文件的内存镜像空间的某些控制节，该属性处于关闭状态 (off)。</td>
</tr>
<tr>
<td style="text-align:left">SHF_EXECINSTR</td>
<td style="text-align:left">0x4</td>
<td style="text-align:left">这种节包含可执行的机器指令（<strong>EXECutable INSTRuction</strong>）。</td>
</tr>
<tr>
<td style="text-align:left">SHF_MASKPROC</td>
<td style="text-align:left">0xf0000000</td>
<td style="text-align:left">所有在这个掩码中的比特位用于特定处理器语义。</td>
</tr>
</tbody>
</table>
<h3 id="sh_link-sh_info"><a class="anchor" href="#sh_link-sh_info">#</a> sh_link &amp; sh_info</h3>
<p>当节区类型的不同的时候，sh_link 和 sh_info 也会具有不同的含义。</p>
<table>
<thead>
<tr>
<th style="text-align:left">sh_type</th>
<th style="text-align:left">sh_link</th>
<th style="text-align:left">sh_info</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">SHT_DYNAMIC</td>
<td style="text-align:left">节区中使用的字符串表的节头索引</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">SHT_HASH</td>
<td style="text-align:left">此哈希表所使用的符号表的节头索引</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">SHT_REL/SHT_RELA</td>
<td style="text-align:left">与符号表相关的节头索引</td>
<td style="text-align:left">重定位应用到的节的节头索引</td>
</tr>
<tr>
<td style="text-align:left">SHT_SYMTAB/SHT_DYNSYM</td>
<td style="text-align:left">操作系统特定信息，Linux 中的 ELF 文件中该项指向符号表中符号所对应的字符串节区在 Section Header Table 中的偏移。</td>
<td style="text-align:left">操作系统特定信息</td>
</tr>
<tr>
<td style="text-align:left">other</td>
<td style="text-align:left"><code>SHN_UNDEF</code></td>
<td style="text-align:left">0</td>
</tr>
</tbody>
</table>
<h2 id="elf-sections"><a class="anchor" href="#elf-sections">#</a> ELF sections</h2>
<h3 id="节的分类"><a class="anchor" href="#节的分类">#</a> 节的分类</h3>
<h4 id="text节"><a class="anchor" href="#text节">#</a> .text 节</h4>
<p><code>.text</code>  节是保存了程序代码指令的<strong>代码节</strong>。<strong>一段可执行程序，如果存在 Phdr，则 <code>.text</code>  节就会存在于 <code>text</code>  段中</strong>。由于 <code>.text</code>  节保存了程序代码，所以节类型为 <code>SHT_PROGBITS</code> 。</p>
<h4 id="rodata节"><a class="anchor" href="#rodata节">#</a> .rodata 节</h4>
<p><code>rodata</code>  节保存了只读的数据，如一行 C 语言代码中的字符串。由于 <code>.rodata</code>  节是只读的，所以只能存在于一个可执行文件的<strong>只读段</strong>中。因此，只能在 <code>text</code>  段（不是 <code>data</code>  段）中找到 <code>.rodata</code>  节。由于 <code>.rodata</code>  节是只读的，所以节类型为 <code>SHT_PROGBITS</code> 。</p>
<h4 id="plt节过程链接表"><a class="anchor" href="#plt节过程链接表">#</a> .plt 节（过程链接表）</h4>
<p><code>.plt</code>  节也称为<strong>过程链接表（Procedure Linkage Table）</strong>，<strong>其包含了动态链接器调用从共享库导入的函数所必需的相关代码</strong>。由于 <code>.plt</code>  节保存了代码，所以节类型为 <code>SHT_PROGBITS</code> 。</p>
<h4 id="data节"><a class="anchor" href="#data节">#</a> .data 节</h4>
<p><code>.data</code>  节存在于 <code>data</code>  段中，<strong>其保存了初始化的全局变量等数据</strong>。由于 <code>.data</code>  节保存了程序的变量数据，所以节类型为 <code>SHT_PROGBITS</code> 。</p>
<h4 id="bss节"><a class="anchor" href="#bss节">#</a> .bss 节</h4>
<p><code>.bss</code>  节存在于 <code>data</code>  段中，占用空间不超过 4 字节，仅表示这个节本省的空间。<strong> <code>.bss</code>  节保存了未进行初始化的全局数据</strong>。程序加载时数据被初始化为 0，在程序执行期间可以进行赋值。由于 <code>.bss</code>  节未保存实际的数据，所以节类型为 <code>SHT_NOBITS</code> 。</p>
<h4 id="gotplt节全局偏移表-过程链接表"><a class="anchor" href="#gotplt节全局偏移表-过程链接表">#</a> .got.plt 节（全局偏移表 - 过程链接表）</h4>
<p><code>.got</code>  节保存了<strong>全局偏移表</strong>。<strong> <code>.got</code>  节和 <code>.plt</code>  节一起提供了对导入的共享库函数的访问入口，由动态链接器在运行时进行修改</strong>。由于 <code>.got.plt</code>  节与程序执行有关，所以节类型为 <code>SHT_PROGBITS</code> 。</p>
<h4 id="dynsym节动态链接符号表"><a class="anchor" href="#dynsym节动态链接符号表">#</a> .dynsym 节（动态链接符号表）</h4>
<p><code>.dynsym</code>  节保存在 <code>text</code>  段中。<strong>其保存了从共享库导入的动态符号表</strong>。节类型为 <code>SHT_DYNSYM</code> 。</p>
<h4 id="dynstr节动态链接字符串表"><a class="anchor" href="#dynstr节动态链接字符串表">#</a> .dynstr 节（动态链接字符串表）</h4>
<p><code>.dynstr</code>  保存了动态链接字符串表，表中存放了一系列字符串，这些字符串代表了符号名称，以空字符作为终止符。</p>
<h4 id="rel节重定位表"><a class="anchor" href="#rel节重定位表">#</a> .rel.* 节（重定位表）</h4>
<p>重定位表保存了重定位相关的信息，<strong>这些信息描述了如何在链接或运行时，对 ELF 目标文件的某部分或者进程镜像进行补充或修改</strong>。由于重定位表保存了重定位相关的数据，所以节类型为 <code>SHT_REL</code> 。</p>
<h4 id="hash节"><a class="anchor" href="#hash节">#</a> .hash 节</h4>
<p><code>.hash</code>  节也称为 <code>.gnu.hash</code> ，其保存了一个用于查找符号的散列表。</p>
<h4 id="symtab节符号表"><a class="anchor" href="#symtab节符号表">#</a> .symtab 节（符号表）</h4>
<p><code>.symtab</code>  节是一个 <code>ElfN_Sym</code>  的数组，保存了符号信息。节类型为 <code>SHT_SYMTAB</code> 。</p>
<h4 id="strtab节字符串表"><a class="anchor" href="#strtab节字符串表">#</a> .strtab 节（字符串表）</h4>
<p><code>.strtab</code>  节保存的是符号字符串表，表中的内容会被 <code>.symtab</code>  的 <code>ElfN_Sym</code>  结构中的 <code>st_name</code>  引用。节类型为 <code>SHT_STRTAB</code> 。</p>
<h4 id="ctors节和dtors节"><a class="anchor" href="#ctors节和dtors节">#</a> .ctors 节和.dtors 节</h4>
<p><code>.ctors</code> （<strong>构造器</strong>）节和 <code>.dtors</code> （<strong>析构器</strong>）节分别保存了指向构造函数和析构函数的函数指针，<strong>构造函数是在 main 函数执行之前需要执行的代码；析构函数是在 main 函数之后需要执行的代码</strong>。</p>
<h3 id="符号表"><a class="anchor" href="#符号表">#</a> 符号表</h3>
<p><strong>符号是对某些类型的数据或代码（如全局变量或函数）的符号引用，函数名或变量名就是符号名</strong>。例如， <code>printf()</code>  函数会在动态链接符号表 <code>.dynsym</code>  中存有一个指向该函数的符号项（以 <code>Elf_Sym</code>  数据结构表示）。在大多数共享库和动态链接可执行文件中，存在两个符号表。即 <code>.dynsym</code>  和 <code>.symtab</code> 。</p>
<p><strong> <code>.dynsym</code>  保存了引用来自外部文件符号的全局符号</strong>。如 <code>printf</code>  库函数。<strong> <code>.dynsym</code>  保存的符号是 <code>.symtab</code>  所保存符合的子集， <code>.symtab</code>  中还保存了可执行文件的本地符号</strong>。如全局变量，代码中定义的本地函数等。</p>
<p>既然 <code>.dynsym</code>  是 <code>.symtab</code>  的子集，那为何要同时存在两个符号表呢？</p>
<p>通过 <code>readelf -S</code>  命令可以查看可执行文件的输出，一部分节标志位（ <code>sh_flags</code> ）被标记为了<strong> A（ALLOC）、WA（WRITE/ALLOC）、AX（ALLOC/EXEC）</strong>。其中， <code>.dynsym</code>  被标记为 ALLOC，而 <code>.symtab</code>  则没有标记。</p>
<p>ALLOC 表示有该标记的节会在运行时分配并装载进入内存，而 <code>.symtab</code>  不是在运行时必需的，因此不会被装载到内存中。<strong> <code>.dynsym</code>  保存的符号只能在运行时被解析，因此是运行时动态链接器所需的唯一符号</strong>。 <code>.dynsym</code>  对于动态链接可执行文件的执行是必需的，而 <code>.symtab</code>  只是用来进行调试和链接的。</p>
<p><img data-src="/ElfReader/elf-symtab-strtab.png" alt="img" style="aspect-ratio:2148 / 1428;"></p>
<p>上图所示为通过符号表索引字符串表的示意图。符号表中的每一项都是一个 <code>Elf_Sym</code>  结构，对应可以在字符串表中索引得到一个字符串。该数据结构中成员的含义如下表所示：</p>
<table>
<thead>
<tr>
<th style="text-align:left">成员</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">st_name</td>
<td style="text-align:left">符号名。该值为该符号名在字符串表中的偏移地址。</td>
</tr>
<tr>
<td style="text-align:left">st_value</td>
<td style="text-align:left">符号对应的值。存放符号的值（可能是地址或位置偏移量）。</td>
</tr>
<tr>
<td style="text-align:left">st_size</td>
<td style="text-align:left">符号的大小。</td>
</tr>
<tr>
<td style="text-align:left">st_other</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left">st_shndx</td>
<td style="text-align:left">符号所在的节</td>
</tr>
<tr>
<td style="text-align:left">st_info</td>
<td style="text-align:left">符号类型及绑定属性</td>
</tr>
</tbody>
</table>
<p>使用 readelf 工具我们也能够看到符号表的相关信息。</p>
<pre><code>$ readelf -s hello.o

Symbol table '.symtab' contains 11 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS hello.c
     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1
     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3
     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5
     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    7
     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    8
     8: 0000000000000000     0 SECTION LOCAL  DEFAULT    6
     9: 0000000000000000    21 FUNC    GLOBAL DEFAULT    1 main
    10: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND puts
</code></pre>
<h3 id="字符串表"><a class="anchor" href="#字符串表">#</a> 字符串表</h3>
<p>类似于符号表，在大多数共享库和动态链接可执行文件中，也存在两个字符串表。即 <code>.dynstr</code>  和 <code>.strtab</code> ，分别对应于 <code>.dynsym</code>  和 <code>symtab</code> 。此外，还有一个 <code>.shstrtab</code>  的节头字符串表，用于保存节头表中用到的字符串，可通过 <code>sh_name</code>  进行索引。</p>
<p>ELF 文件中所有字符表的结构基本一致，如上图所示。</p>
<h3 id="重定位表"><a class="anchor" href="#重定位表">#</a> 重定位表</h3>
<p><strong>重定位就是将符号定义和符号引用进行连接的过程</strong>。可重定位文件需要包含描述如何修改节内容的相关信息，从而使可执行文件和共享目标文件能够保存进程的程序镜像所需要的正确信息。</p>
<p>重定位表是进行重定位的重要依据。我们可以使用 objdump 工具查看目标文件的重定位表：</p>
<pre><code>$ objdump -r hello.o


hello.o:     file format elf64-x86-64

RELOCATION RECORDS FOR [.text]:
OFFSET           TYPE              VALUE
0000000000000005 R_X86_64_32       .rodata
000000000000000a R_X86_64_PC32     puts-0x0000000000000004


RELOCATION RECORDS FOR [.eh_frame]:
OFFSET           TYPE              VALUE
0000000000000020 R_X86_64_PC32     .text
</code></pre>
<p>重定位表是一个 <code>Elf_Rel</code>  类型的数组结构，每一项对应一个需要进行重定位的项。 其成员含义如下表所示：</p>
<table>
<thead>
<tr>
<th style="text-align:left">成员</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">r_offset</td>
<td style="text-align:left">重定位入口的偏移。对于<strong>可重定位文件</strong>来说，这个值是该重定位入口所要修正的位置的第一个字节相对于节起始的偏移；对于<strong>可执行文件或共享对象文件</strong>来说，这个值是该重定位入口所要修正的位置的第一个字节的虚拟地址</td>
</tr>
<tr>
<td style="text-align:left">r_info</td>
<td style="text-align:left">重定位入口的类型和符号。因为不同处理器的指令系统不一样，所以重定位所要修正的指令地址格式也不一样。每种处理器都有自己的一套重定位入口的类型。对于<strong>可执行文件和共享目标文件</strong>来说，它们的重定位入口是动态链接类型的。</td>
</tr>
</tbody>
</table>
<p>重定位是目标文件链接成为可执行文件的关键。</p>
<h1 id="elf的链接过程"><a class="anchor" href="#elf的链接过程">#</a> ELF 的链接过程</h1>
<blockquote>
<p>此处的内容来源于<span class="exturl" data-url="aHR0cDovL2NodXF1YW4ubWUvMjAxOC8wNi8wMy9saW5raW5nLXN0YXRpYy1saW5raW5nLWR5bmFtaWMtbGlua2luZy8=">计算机那些事 (5)—— 链接、静态链接、动态链接</span>，仅作学习记录和备份用</p>
</blockquote>
<h2 id="链接概述"><a class="anchor" href="#链接概述">#</a> 链接概述</h2>
<p>模块化设计是软件开发中最常用的设计思想。<strong>链接（Linking）</strong> 本质上就是把各个模块之间相互引用的部分处理好，使得各个模块之间能够正确衔接。比如：</p>
<blockquote>
<p>我们在模块 <code>main.c</code>  中使用另一个模块 <code>func.c</code>  中的 <code>foo()</code>  函数。我们在 <code>main.c</code>  模块中每一处调用 <code>foo</code>  时都必须确切知道 <code>foo</code>  函数的地址。但由于每个模块都是单独编译的。编译器在编译 <code>main.c</code>  的时候并不知道 <code>foo</code>  函数的地址。所以编译器会暂时把这些调用 <code>foo</code>  的指令的目标地址搁置，等待最后链接时由链接器将这些指令的目标地址修正。这就是静态链接最基本的过程和作用。</p>
</blockquote>
<p>如下图所示为最基本的静态链接过程示意图。每个模块的源代码文件（如 <code>.c</code> ）文件经过编译器编译成<strong>目标文件</strong>（Object File，一般扩展名为 <code>.o</code>  或 <code>.obj</code> ）。目标文件和 <strong>库（Library）</strong> 一起链接形成最终的可执行文件。</p>
<p>其中，最常见的库就是<strong>运行时库（Runtime Library）</strong>，它是支持程序运行的基本函数的集合。<strong>库本质上是一组目标文件的包，由一些最常用的代码编译成目标文件后打包而成</strong>。</p>
<p><img data-src="/ElfReader/linking-process.png" alt="img" style="aspect-ratio:2148 / 2595;"></p>
<p>链接过程主要包含了三个步骤：</p>
<ol>
<li><strong>地址与空间分配（Address and Storage Allocation）</strong></li>
<li><strong>符号解析（Symbol Resolution）</strong></li>
<li><strong>重定位（Relocation）</strong></li>
</ol>
<p>下面，我们以两个源代码文件 <code>a.c</code>  和 <code>b.c</code>  为例展开分析。</p>
<pre><code>// a.c
extern int shared;

int main() &#123;
    int a = 100;
    swap(&amp;a, &amp;shared);
&#125;
// b.c
int shared = 1;

void swap(int *a, int *b) &#123;
    *a ^= *b ^= *a ^= *b;
&#125;
</code></pre>
<p>其中， <code>b.c</code>  中定义了两个全局符号：变量 <code>shared</code> 、函数 <code>swap</code> ； <code>a.c</code>  中定义了一个全局符号： <code>main</code> 。 <code>a.c</code>  引用了 <code>b.c</code>  中的 <code>swap</code>  和 <code>shared</code> 。接下来我们要将两个目标文件链接在一起并最终形成一个执行程文件 <code>ab</code> 。</p>
<p>使用 <code>gcc -c</code>  命令我们可以分别编译得到 <code>a.o</code>  和 <code>b.o</code>  两个目标文件。</p>
<h3 id="地址与空间分配"><a class="anchor" href="#地址与空间分配">#</a> 地址与空间分配</h3>
<p>在介绍 ELF 文件结构关于段与节的区别时，我们就提到过可执行文件中的段是由目标文件中的节合并而来的。那么，我们的第一个问题是：对于多个输入目标文件，链接器如何将它们的各个节合并到输出文件呢？或者说，输出文件中的空间如何分配给输入文件。</p>
<h4 id="按序叠加"><a class="anchor" href="#按序叠加">#</a> 按序叠加</h4>
<p>一个最简单的方案就是将输入的文件按序叠加，如下图所示。</p>
<p><img data-src="/ElfReader/elf-simple-merge.png" alt="img" style="aspect-ratio:2148 / 2595;"></p>
<p>虽然这种方法非常简单，但是它存在一个问题：在有很多输入文件的情况下，输出文件会有很多零散的节。这种做法非常浪费空间，因为每个节都需要有一定的地址和空间对齐要求。x86 硬件的对齐要求是 4KB。如果一个节的大小只有 1 个字节，它也要在内存在重用 4KB。这样会造成大量内部碎片。所以不是一个好的方案。</p>
<h4 id="合并相似节"><a class="anchor" href="#合并相似节">#</a> 合并相似节</h4>
<p>一个更加实际的方法便是合并相同性质的节，比如：将所有输入文件的 <strong> <code>.text</code>  节</strong>合并到输出文件的 <strong> <code>text</code>  段</strong>（注意，此时出现了段和节两个概念），如下图所示。</p>
<p><img data-src="/ElfReader/elf-similar-merge.png" alt="img" style="aspect-ratio:2148 / 2595;"></p>
<p>其中 <code>.bss</code>  节在目标文件和可执行文件中不占用文件的空间，但是它在装载时占用地址空间。事实上，这里的<strong>空间和地址</strong>有两层含义:</p>
<ol>
<li>在输出的可执行文件中的空间</li>
<li>在装载后的虚拟地址中的空间</li>
</ol>
<p>对于有实际数据的节，如 <code>.text</code>  和 <code>.data</code> ，它们在文件中和虚拟地址中都要分配空间，因为它们在这两者中都存在；对于 <code>.bss</code>  来，分配空间的意义只局限于虚拟地址空间，因为它在文件中并没有内容。<strong>我们在这里谈到的空间分配只关注于虚拟地址空间的分配</strong>，因为这关系到链接器后面的关于地址计算的步骤，而可执行文件本身的空间分配与链接的关系并不大。</p>
<p>现在的链接器空间分配的策略基本上都采用 “合并相似节” 的方法，使用这种方法的链接器一般采用一种叫 <strong>两步链接（Two-pass Linking）</strong> 的方法。即整个链接过程分为两步：</p>
<ul>
<li><strong>第一步 地址与空间分配</strong><br>
扫描所有的输入目标文件，获得它们的各个节的长度、属性、位置，并将输入目标文件中的符号表中所有的符号定义和符号引用收集起来，统一放到一个全局的符号表。这一步，链接器能够获得所有输入目标文件的节的长度，并将它们合并，计算出输出文件中各个节合并后的长度与位置，并建立映射关系。</li>
<li><strong>第二步 符号解析与重定位</strong><br>
使用前一步中收集到的所有信息，读取输入文件中节的输数据、重定位信息，并且进行符号解析与重定位、调整代码、调整代码中的地址等。事实上，第二步是链接过程的核心，尤其是重定位。</li>
</ul>
<p><img data-src="/ElfReader/two-step-linking.png" alt="img" style="aspect-ratio:2148 / 1257;"></p>
<p>在地址与空间分配步骤完成之后，相似权限的节会被合并成段，并生成了<span class="exturl" data-url="aHR0cDovL2NodXF1YW4ubWUvMjAxOC8wNS8yMS9lbGYtaW50cm9kdWNlLw=="> ELF 文件结构</span>一文中没有介绍的 <strong>程序头表（Program Header Table）</strong> 结构。如下右图可执行文件结构所示，主要生成两个段：代码段（  <code>text</code>  段）、数据段（  <code>data</code>  段 ）。</p>
<p><img data-src="/ElfReader/different-elf-type.png" alt="img" style="aspect-ratio:2148 / 1257;"></p>
<p>我们使用 ld 或 gcc 将 <code>a.o</code>  和 <code>b.o</code>  链接起来，然后使用 objdump 工具来查看链接前后的地址分配情况。</p>
<pre><code>$ objdump -h a.o

Sections:
Idx Name          Size      VMA               LMA               File off  Algn
  0 .text         0000004f  0000000000000000  0000000000000000  00000040  2**0
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE
  1 .data         00000000  0000000000000000  0000000000000000  0000008f  2**0
                  CONTENTS, ALLOC, LOAD, DATA
  2 .bss          00000000  0000000000000000  0000000000000000  0000008f  2**0
                  ALLOC
  ...
$ objdump -h b.o

Sections:
Idx Name          Size      VMA               LMA               File off  Algn
  0 .text         0000004b  0000000000000000  0000000000000000  00000040  2**0
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  1 .data         00000004  0000000000000000  0000000000000000  0000008c  2**2
                  CONTENTS, ALLOC, LOAD, DATA
  2 .bss          00000000  0000000000000000  0000000000000000  00000090  2**0
                  ALLOC
  ...
$ objdump -h ab

Sections:
Idx Name          Size      VMA               LMA               File off  Algn
  ...
  13 .text         00000202  0000000000400450  0000000000400450  00000450  2**4
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  ...
  24 .data         00000014  0000000000601028  0000000000601028  00001028  2**3
                  CONTENTS, ALLOC, LOAD, DATA
  25 .bss          00000004  000000000060103c  000000000060103c  0000103c  2**0
                  ALLOC
  ...
</code></pre>
<p>可以发现，链接前目标文件中所有节的 <strong>VMA（Virtual Memory Address）</strong> 都是 0，因为虚拟空间还没有分配。链接后，可执行文件 <code>ab</code>  中各个节被分配到了相应的虚拟地址，如 <code>.text</code>  节被分配到了地址 <code>0x0000000000400450</code> 。</p>
<p>那么，为什么链接器要将可执行文件 <code>ab</code>  的 <code>.text</code>  节分配到 <code>0x0000000000400450</code> ？而不是从虚拟空间的 0 地址开始分配呢？这涉及到操作系统的进程虚拟地址空间的分配规则。在 Linux x86-64 系统中，代码段总是从 <code>0x0000000000400000</code>  开始的，另外 <code>.text</code>  节之前还有 <code>ELF Header</code> 、 <code>Program Header Table</code> 、 <code>.init</code>  等占用了一定的空间，所以就被分配到了 <code>0x0000000000400450</code> 。</p>
<h3 id="符号解析"><a class="anchor" href="#符号解析">#</a> 符号解析</h3>
<p>在<strong>两步链接</strong>中，这一步和重定位被合并成了一步，这是因为重定位的过程是伴随着符号解析的。这里我们分开介绍。</p>
<p>链接器解析符号引用的方法是将每个引用与它输入的可重定位目标文件的符号表中的一个确定的符号定义关联起来。对那些和引用定义在相同模块的局部符号的引用，符号解析是非常简单的。编译器只允许每个模块中每个局部符号有一个定义。静态局部变量也会有本地链接器符号，编译器还要确保它们拥有唯一的名字。</p>
<p>然而，对于全局符号的解析要复杂得多。当编译器遇到一个不是在当前模块中定义的符号（变量或函数名）时，会假设该符号是在其他某个模块中定义的，生成一个链接器符号表条目，并把它交给链接器处理。如果链接器在它的任何输入模块中都找不到这个被引用符号的定义，就输出一条错误信息并终止。</p>
<p>另一方面，对全局符号的解析，经常会面临多个目标文件可能会定义相同名字的全局符号。这种情况下，链接器必须要么标志一个错误，要么以某种方法选出一个定义并抛弃其他定义。</p>
<h4 id="多重定义的全局符号解析"><a class="anchor" href="#多重定义的全局符号解析">#</a> 多重定义的全局符号解析</h4>
<p>链接器的输入是一组可重定位目标模块。每个模块定义一组符号，有些是局部符号（只对定义该符号的模块可见），有些是全局符号（对其他模块也可见）。如果多个模块定义同名的全局符号，该如何进行取舍？</p>
<p>Linux 编译系统采用如下的方法解决多重定义的全局符号解析：</p>
<p><strong>在编译时，编译器想汇编器输出每个全局符号，或者是强（strong）或者是弱（weak），而汇编器把这个信息隐含地编码在可重定位目标文件的符号表中。</strong></p>
<p>根据强弱符号的定义，Linux 链接器使用下面的规则来处理多重定义的符号名：</p>
<ul>
<li><strong>规则 1：不允许有多个同名的强符号。</strong></li>
<li><strong>规则 2：如果有一个强符号和多个弱符号同名，则选择强符号。</strong></li>
<li><strong>规则 3：如果有多个弱符号同名，则从这些弱符号中任意选择一个。</strong></li>
</ul>
<p>另一方面，由于允许一个符号定义在多个文件中，所以可能会导致一个问题：如果一个弱符号定义在多个目标文件中，而它们的类型不同，怎么办？这种情况主要有三种：</p>
<ul>
<li><strong>情况 1：两个或两个以上的强符号类型不一致。</strong></li>
<li><strong>情况 2：有一个强符号，其他都是弱符号，出现类型不一致。</strong></li>
<li><strong>情况 3：两个或两个以上弱符号类型不一致。</strong></li>
</ul>
<p>其中，情况 1 由于多个强符号定义本身就是非法的，所以链接器就会报错。对于后两种情况，编译器和链接器采用一种叫 <strong>COMMON 块（Common Block ）</strong> 的机制来处理。其过程如下：</p>
<p><strong>首先，编译器将未初始化的全局变量定义为弱符号处理。对于情况 3，最终链接时选择最大的类型。对于情况 2，最终输出结果中的符号所占空间与强符号相同，如果链接过程中有弱符号大于强符号，链接器会发出警告。</strong></p>
<h3 id="重定位"><a class="anchor" href="#重定位">#</a> 重定位</h3>
<p>事实上，重定位过程也伴随着符号的解析过程。链接的前两步完成之后，链接器就已经确定所有符号的虚拟地址了，那么链接器就可以根据符号的地址对每个需要重定位的指令进行地址修正。</p>
<p>那么链接器如何知道哪些指令是要被调整的呢？事实上，我们前面提到的 ELF 文件中的 <strong>重定位表（Relocation Table）</strong> 专门用来保存这些与重定位相关的信息。</p>
<p>对于可重定位的 ELF 文件来说，它必须包含重定位表，用来描述如何修改相应的节的内容。对于每个要被重定位的 ELF 节都有一个对应的重定位表。如果 <code>.text</code>  节需要被重定位，则会有一个相对应叫 <code>.rel.text</code>  的节保存了代码节的重定位表；如果 <code>.data</code>  节需要被重定位，则会有一个相对应的 <code>.rel.tdata</code>  的节保存了数据节的重定位表。</p>
<p>我们可以使用 objdump 工具来查看目标文件中的重定位表：</p>
<pre><code>$ objdump -r a.o

a.o:     file format elf64-x86-64

RELOCATION RECORDS FOR [.text]:
OFFSET           TYPE              VALUE
0000000000000023 R_X86_64_32       share
0000000000000030 R_X86_64_PC32     swap-0x0000000000000004
0000000000000049 R_X86_64_PC32     __stack_chk_fail-0x0000000000000004


RELOCATION RECORDS FOR [.eh_frame]:
OFFSET           TYPE              VALUE
0000000000000020 R_X86_64_PC32     .text
</code></pre>
<p>我们可以看到每个要被重定位的地方是一个 <strong>重定位入口（Relocation Entry）</strong>。利用数据结构成员包含的信息，即可完成重定位。</p>
<h2 id="静态链接"><a class="anchor" href="#静态链接">#</a> 静态链接</h2>
<p>事实上，静态链接的过程就是上文所描述的过程。在 Linux 中，静态链接器（static linker） <code>ld</code>  以一组可重定位目标文件和命令行参数作为输入，生成一个完全链接的、可以加载和运行的可执行目标文件作为输出。输入的可重定位目标文件由各种不同的节组成，每一节都是一个连续的字节序列。</p>
<h2 id="动态链接"><a class="anchor" href="#动态链接">#</a> 动态链接</h2>
<p>静态链接使得进行模块化开发，大大提供了程序的开发效率。随着，程序规模的扩大，静态链接的诸多缺点也逐渐暴露出来，如：浪费内存和磁盘空间、模块更新困难等。在静态链接中，C 语言静态库是很典型的浪费空间的例子。关于模块更新，静态链接的程序有任何更新，都必须重新编译链接，用户则需要重新下载安装该程序。</p>
<p>解决空间浪费和更新困难最简单的方法便是将程序的模块相互分割开来，形成独立文件。简而言之，就是不对那些组成程序的目标文件进行链接，而是等到程序要运行时才进行链接。</p>
<h3 id="动态链接的基本实现"><a class="anchor" href="#动态链接的基本实现">#</a> 动态链接的基本实现</h3>
<p>动态链接涉及运行时的链接以及多个文件的装载，必需要有操作系统的支持。因为动态链接的情况下，进程的虚拟地址空间的分布会比静态链接情况下更为复杂，还有一些存储管理、内存共享、进程线程等机制在动态链接下也会有一些微妙的变化。</p>
<p>目前，主流操作系统都支持动态链接。在 Linux 中，ELF 动态链接文件被称为 <strong>动态共享对象（DSO，Dynamic Shared Objects）</strong>，一般以 <code>.so</code>  为后缀；在 Windows 中，动态链接文件被称为 <strong>动态链接库（Dynamic Linking Library）</strong>，一般以 <code>.dll</code>  为后缀。</p>
<p>在 Linux 中，常用的 C 语言库的运行库 glibc，其动态链接形式的版本保留在  <code>/lib</code>  目录下，文件名为  <code>libc.so</code> 。整个系统只保留一份 C 语言动态链接文件 <code>libc.so</code> ，所有的 C 语言编写的、动态链接的程序都可以在运行时使用它。当程序被装载时，系统的<strong>动态链接器</strong>会将程序所需要的所有动态链接库装载到进程的地址空间，并将程序中所有未解析的符号绑定到相应的动态链接库中，并进行重定位。</p>
<h3 id="动态链接程序运行时地址空间分布"><a class="anchor" href="#动态链接程序运行时地址空间分布">#</a> 动态链接程序运行时地址空间分布</h3>
<p>对于静态链接的可执行文件来说，整个进程只有一个文件要被映射，即可执行文件。而对于动态链接，除了可执行文件，还有它所依赖的共享目标文件。</p>
<p>关于共享目标文件在内存中的地址分配，主要有两种解决方案，分别是：</p>
<ul>
<li><strong>静态共享库（Static Shared Library）</strong>（地址固定）</li>
<li><strong>动态共享库（Dynamic Shared Libary）</strong>（地址不固定）</li>
</ul>
<h4 id="静态共享库"><a class="anchor" href="#静态共享库">#</a> 静态共享库</h4>
<p>静态共享库的做法是将程序的各个模块统一交给操作系统进行管理，操作系统在<strong>某个特定的地址</strong>划分出一些地址块，为那些已知的模块预留足够的空间。因为这个地址对于不同的应用程序来说，都是固定的，所以称之为<strong>静态</strong>。</p>
<p>但是静态共享库的目标地址会导致地址冲突、升级等问题。</p>
<h4 id="动态共享库"><a class="anchor" href="#动态共享库">#</a> 动态共享库</h4>
<p>采用动态共享库的方式，也称为<strong>装载时重定位（Load Time Relocation）</strong>。其基本思路是：<strong>在链接时，对所有绝对地址的引用都不作重定位，而把这一步推迟到装载时再完成。一旦模块装载地址确定，即目标地址确定，那么系统就对程序中所有的绝对地址引用进行重定位。</strong></p>
<p>但是这种方式也存在一些问题。比如，动态链接模块被装载映射至虚拟空间后，指令部分是在多个进程间共享的，由于装载时重定位的方法需要修改指令，所以没有办法做到同一份指令被多个进程共享，因为指令被重定位后对于每个进程来说都是不同的。</p>
<p>虽然，动态链接库中的代码是共享的，但是其中的可修改数据部分对于不同进程来说是由多个副本的。基于此，一种名为<strong>地址无关代码</strong>的技术被提出以克服这个问题。</p>
<h4 id="地址无关代码"><a class="anchor" href="#地址无关代码">#</a> 地址无关代码</h4>
<blockquote>
<p>计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决。</p>
</blockquote>
<p><strong>地址无关代码（PIC，Position-independent Code）</strong> 技术完美阐释了上面这句名言，其基本原理是：把指令中那些需要被修改的部分分离出来，跟数据部分放在一起，这样指令部分就可以保持不变，而数据部分可以在每个进程中拥有一个副本。</p>
<p>共享对象模块中的地址引用按照是否为跨模块分为两类：模块内部引用、模块外部引用。按照不用的引用方式又可分为：指令引用、数据引用。以如下代码为例，可得出如下四种类型：</p>
<ul>
<li><strong>类型 1：模块内部的函数调用。</strong></li>
<li><strong>类型 2：模块内部的数据访问，如模块中定义的全局变量、静态变量。</strong></li>
<li><strong>类型 3：模块外部的函数调用。</strong></li>
<li><strong>类型 4：模块外部的数据访问，如其他模块中定义的全局变量。</strong></li>
</ul>
<pre><code>static int a;
extern int b;
extern void ext();

void bar() &#123;
    a = 1;      // 类型2：模块内部数据访问
    b = 2;      // 类型4：模块外部数据访问
&#125;

void foo() &#123;
    bar();      // 类型1：模块内部函数调用
    ext();      // 类型4：模块外部函数调用
&#125;
</code></pre>
<h5 id="类型1-模块内部函数调用"><a class="anchor" href="#类型1-模块内部函数调用">#</a> 类型 1 模块内部函数调用</h5>
<p>由于被调用的函数与调用者都处于同一模块，它们之间的相对位置是固定的。对于现代的系统来说，模块内部的调用都可以是相对地址调用，或者是基于寄存器的相对调用，所以对于这种指令是不需要重定位的。</p>
<h5 id="类型2-模块内部数据访问"><a class="anchor" href="#类型2-模块内部数据访问">#</a> 类型 2 模块内部数据访问</h5>
<p>一个模块前面一般是若干个页的代码，后面紧跟着若干个页的数据，这些页之间的相对位置是固定的，即任何一条指令与它需要访问的模块内部数据之间的相对位置是固定的，所以只需要相对于当前指令加上固定的偏移量就可以访问模块内部数据了。</p>
<h5 id="类型3-模块间数据访问"><a class="anchor" href="#类型3-模块间数据访问">#</a> 类型 3 模块间数据访问</h5>
<p>模块间的数据访问比模块内部稍微麻烦一些，因为模块间的数据访问目标地址要等到装载时才决定。此时，动态链接需要使用代码无关地址技术，其基本思想是把地址相关的部分放到数据段。ELF 的实现方法是：在数据段中建立一个<strong>指向这些变量的指针数组</strong>，也称为<strong>全局偏移表（Global Offset Table，GOT）</strong>，当代码需要引用该全局变量时，可以通过 GOT 中相对应的项间接引用。过程示意图如下所示：</p>
<p><img data-src="/ElfReader/inter-module-data-access.png" alt="img" style="aspect-ratio:2148 / 1875;"></p>
<p>当指令中需要访问变量 b 时，程序会先找到 GOT，然后根据 GOT 中变量所对应的项找到变量的目标地址。每个变量都对应一个 4 字节的地址，链接器在装载模块时会查找每个变量所在的地址，然后填充 GOT 中的各个项，以确保每个指针所指向的地址正确。由于 GOT 本身是放在数据段的，所以它可以<strong>在模块装载时被修改</strong>，并且每个进程都可以有独立的副本，相互不受影响。</p>
<h5 id="类型4-模块间函数调用"><a class="anchor" href="#类型4-模块间函数调用">#</a> 类型 4 模块间函数调用</h5>
<p>对于模块间函数调用，同样可以采用类型 3 的方法来解决。与上面的类型有所不同的是，GOT 中响应的项保存的是目标函数的地址，当模块需要调用目标函数时，可以通过 GOT 中的项进行间接跳转。</p>
<h1 id="elf的装载过程"><a class="anchor" href="#elf的装载过程">#</a> ELF 的装载过程</h1>
<blockquote>
<p>此处的内容来源于<span class="exturl" data-url="aHR0cDovL2NodXF1YW4ubWUvMjAxOC8wNi8xNy9leGVjdXRhYmxlLWZpbGUtbG9hZC1hbmQtZXhlY3V0aW9uLw==">计算机那些事 (6)—— 可执行文件的装载与运行</span>，仅作学习记录和备份用</p>
</blockquote>
<p>当我们在 Linux 的 bash 中输入命令执行某个 ELF 可执行文件时，如下所示。</p>
<pre><code>$ ./hello.out
</code></pre>
<p>那么，Linux 系统是如何装载该 ELF 文件并执行的呢？这个过程可以分为以下这些步骤：</p>
<ul>
<li>创建新进程</li>
<li>检查可执行文件类型</li>
<li>搜索匹配装载处理过程</li>
<li>装载执行可执行文件</li>
</ul>
<h2 id="创建新进程"><a class="anchor" href="#创建新进程">#</a> 创建新进程</h2>
<p>首先在用户层面，bash 进程会调用  <code>fork()</code>  系统调用创建一个新的进程。其次，新的进程通过调用  <code>execve()</code>  系统调用来执行指定的 ELF 文件。原先的 bash 进程继续返回并等待刚才启动的新进程结束，之后继续等待用户输入命令。</p>
<p><code>execve()</code>  系统调用被定义在  <code>unistd.h</code> ，其原型如下所示。其中的三个参数分别对应被执行程序的 <strong>程序文件名</strong>、<strong>执行参数</strong>、<strong>环境变量</strong>。</p>
<pre><code>int execve(const char *filename, char *const argv[], char *const envp[]);
</code></pre>
<h2 id="检查可执行文件类型"><a class="anchor" href="#检查可执行文件类型">#</a> 检查可执行文件类型</h2>
<p>当进入  <code>execve()</code>  系统调用之后，Linux 内核就开始进行真正的装载工作。在内核中， <code>execve()</code>  系统调用相应的入口是  <code>sys_execve()</code> 。 <code>sys_execve()</code>  进行一些参数的检查复制之后，调用  <code>do_execve()</code> 。 <code>do_execve()</code>  会首先查找被执行的文件，如果找到文件，则读取文件的前 128 个字节。</p>
<p>为什么要先读取文件的前 128 个字节？这是因为 Linux 支持的可执行文件不止 ELF 一种，还包括 <strong>a.out</strong>、<strong>Java 程序</strong>、<strong>以  <code>#!</code>  开头的脚本程序</strong>。 <code>do_execve()</code>  通过读取前 128 个字节来判断文件的格式。每种可执行文件格式的开头几个字节都是很特殊的，尤其是前 4 个字节，被称为 <strong>魔数（Magic Number）</strong>。比如：ELF 的可执行文件格式的头 4 个字节为  <code>0x7F</code> 、 <code>e</code> 、 <code>l</code> 、 <code>f</code> ；Java 的可执行文件格式的头 4 个字节为  <code>c</code> 、 <code>a</code> 、 <code>f</code> 、 <code>e</code> ；如果是解释型语言的脚本，则第一行通常是  <code>#!/bin/sh</code>  或  <code>#!/user/bin/python</code> ，其中  <code>#</code>  和  <code>!</code>  构成了魔数，系统一旦判断到这两个字节，就对后面的字符串进行解析，以确定具体的解释程序的路径。</p>
<h2 id="搜索匹配装载处理过程"><a class="anchor" href="#搜索匹配装载处理过程">#</a> 搜索匹配装载处理过程</h2>
<p>当  <code>do_execve()</code>  读取了 128 个字节的文件头部之后，调用  <code>search_binary_handle()</code>  去搜索和匹配合适的可执行文件装载处理过程。<strong>Linux 中所有被支持的可执行文件格式都有相应的装载处理过程</strong>， <code>search_binary_handler()</code>  会通过判断头部的魔术确定文件的格式，并且调用相应的装载处理过程。常见的可执行程序及其装载处理过程的对应关系如下所示.</p>
<ul>
<li>ELF 可执行文件： <code>load_elf_binary()</code></li>
<li>a.out 可执行文件： <code>load_aout_binary()</code></li>
<li>可执行脚本程序： <code>load_script()</code></li>
</ul>
<h2 id="装载执行可执行文件"><a class="anchor" href="#装载执行可执行文件">#</a> 装载执行可执行文件</h2>
<p>以 ELF 的装载处理过程  <code>load_elf_binary()</code>  为例，其所包含的步骤如下图所示：</p>
<p><img data-src="/ElfReader/executable-file-load-process.png" alt="img" style="aspect-ratio:2148 / 2460;"></p>
<ol>
<li>操作系统读取可执行文件 ELF 的  <code>Header</code> ，检查文件的有效性。</li>
<li>操作系统读取可执行文件 ELF 的  <code>Program Header Table</code>  中读取每个  <code>Segment</code>  的虚拟地址、文件地址、属性等。</li>
<li>操作系统根据  <code>Program Header Table</code>  将可执行文件 ELF 映射至内存。</li>
<li>如果是静态链接的情况，则直接跳转至第 7 步；如果是动态链接的情况，操作系统将查找  <code>.interp</code>  节，找到 <strong>动态链接器（Dynamic Linker）</strong> 的位置，并启动动态链接器。在 Linux 下，动态链接器  <code>ld.so</code>  是一个共享对象，操作系统同样通过映射的方式将它加载到进程的地址空间。操作系统在加载完后，将控制权交给动态链接器的入口。</li>
<li>动态链接器获得控制权后，开始执行一系列初始化操作。</li>
<li>动态链接器根据当前的环境参数，对可执行文件进行动态链接工作。</li>
<li>控制权被转交到可执行文件的入口地址，程序开始正式执行。</li>
</ol>
<h2 id="technical-note-on-elf-loading"><a class="anchor" href="#technical-note-on-elf-loading">#</a> TECHNICAL NOTE ON ELF LOADING</h2>
<p>在 <code>android-platform\bionic\linker\linker_phdr.cpp</code>  中开头的这处注释也可以帮助我们快速理解 ELF 的加载过程</p>
<p>TECHNICAL NOTE ON ELF LOADING.</p>
<p>An ELF file’s program header table contains one or more PT_LOAD<br>
segments, which corresponds to portions of the file that need to<br>
be mapped into the process’ address space.</p>
<p>Each loadable segment has the following important properties:</p>
<pre><code>p_offset  -&gt; segment file offset
p_filesz  -&gt; segment file size
p_memsz   -&gt; segment memory size (always &gt;= p_filesz)
p_vaddr   -&gt; segment's virtual address
p_flags   -&gt; segment flags (e.g. readable, writable, executable)
p_align   -&gt; segment's in-memory and in-file alignment
</code></pre>
<p>We will ignore the p_paddr field of ElfW(Phdr) for now.</p>
<p>The loadable segments can be seen as a list of [p_vaddr … p_vaddr+p_memsz)<br>
ranges of virtual addresses. A few rules apply:</p>
<ul>
<li>
<p>the virtual address ranges should not overlap.</p>
</li>
<li>
<p>if a segment’s p_filesz is smaller than its p_memsz, the extra bytes<br>
between them should always be initialized to 0.</p>
</li>
<li>
<p>ranges do not necessarily start or end at page boundaries. Two distinct<br>
segments can have their start and end on the same page. In this case, the<br>
page inherits the mapping flags of the latter segment.</p>
</li>
</ul>
<p>Finally, the real load addrs of each segment is not p_vaddr. Instead the<br>
loader decides where to load the first segment, then will load all others<br>
relative to the first one to respect the initial range layout.</p>
<p>For example, consider the following list:</p>
<pre><code>[ offset:0,      filesz:0x4000, memsz:0x4000, vaddr:0x30000 ],
[ offset:0x4000, filesz:0x2000, memsz:0x8000, vaddr:0x40000 ],
</code></pre>
<p>This corresponds to two segments that cover these virtual address ranges:</p>
<pre><code>   0x30000...0x34000
   0x40000...0x48000
</code></pre>
<p>If the loader decides to load the first segment at address 0xa0000000<br>
then the segments’ load address ranges will be:</p>
<pre><code>   0xa0030000...0xa0034000
   0xa0040000...0xa0048000
</code></pre>
<p>In other words, all segments must be loaded at an address that has the same<br>
constant offset from their p_vaddr value. This offset is computed as the<br>
difference between the first segment’s load address, and its p_vaddr value.</p>
<p>However, in practice, segments do <em>not</em> start at page boundaries. Since we<br>
can only memory-map at page boundaries, this means that the bias is<br>
computed as:</p>
<pre><code>   load_bias = phdr0_load_address - PAGE_START(phdr0-&gt;p_vaddr)
</code></pre>
<p>(NOTE: The value must be used as a 32-bit unsigned integer, to deal with<br>
possible wrap around UINT32_MAX for possible large p_vaddr values).</p>
<p>And that the phdr0_load_address must start at a page boundary, with<br>
the segment’s real content starting at:</p>
<pre><code>   phdr0_load_address + PAGE_OFFSET(phdr0-&gt;p_vaddr)
</code></pre>
<p>Note that ELF requires the following condition to make the mmap()-ing work:</p>
<pre><code>  PAGE_OFFSET(phdr0-&gt;p_vaddr) == PAGE_OFFSET(phdr0-&gt;p_offset)
</code></pre>
<p>The load_bias must be added to any p_vaddr value read from the ELF file to<br>
determine the corresponding memory address.</p>
<h1 id="elfreader类"><a class="anchor" href="#elfreader类">#</a> ElfReader 类</h1>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_phdr.h</span></pre></td></tr><tr><td data-num="2"></td><td><pre>class ElfReader <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre> public<span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">ElfReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  bool <span class="token function">Read</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off64_t</span> file_offset<span class="token punctuation">,</span> <span class="token class-name">off64_t</span> file_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  bool <span class="token function">Load</span><span class="token punctuation">(</span>address_space_params<span class="token operator">*</span> address_space<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token class-name">size_t</span> <span class="token function">phdr_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> phdr_num_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> <span class="token function">load_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">(</span>load_start_<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token class-name">size_t</span> <span class="token function">load_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> load_size_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> <span class="token function">gap_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">(</span>gap_start_<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token class-name">size_t</span> <span class="token function">gap_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> gap_size_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> <span class="token function">load_bias</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> load_bias_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> <span class="token function">loaded_phdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> loaded_phdr_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span><span class="token operator">*</span> <span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> dynamic_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">get_string</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Word<span class="token punctuation">)</span> index<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  bool <span class="token function">is_mapped_by_caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> mapped_by_caller_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> <span class="token function">entry_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> header_<span class="token punctuation">.</span>e_entry <span class="token operator">+</span> load_bias_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre> private<span class="token operator">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  bool <span class="token function">ReadElfHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  bool <span class="token function">VerifyElfHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  bool <span class="token function">ReadProgramHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  bool <span class="token function">ReadSectionHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  bool <span class="token function">ReadDynamicSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  bool <span class="token function">ReserveAddressSpace</span><span class="token punctuation">(</span>address_space_params<span class="token operator">*</span> address_space<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  bool <span class="token function">LoadSegments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  bool <span class="token function">FindPhdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  bool <span class="token function">FindGnuPropertySection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  bool <span class="token function">CheckPhdr</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  bool <span class="token function">CheckFileRange</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> offset<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">size_t</span> alignment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>  bool did_read_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  bool did_load_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  std<span class="token operator">::</span>string name_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token keyword">int</span> fd_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token class-name">off64_t</span> file_offset_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token class-name">off64_t</span> file_size_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Ehdr<span class="token punctuation">)</span> header_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token class-name">size_t</span> phdr_num_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>  MappedFileFragment phdr_fragment_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> phdr_table_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>  MappedFileFragment shdr_fragment_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Shdr<span class="token punctuation">)</span><span class="token operator">*</span> shdr_table_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token class-name">size_t</span> shdr_num_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>  MappedFileFragment dynamic_fragment_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span><span class="token operator">*</span> dynamic_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>  MappedFileFragment strtab_fragment_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> strtab_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token class-name">size_t</span> strtab_size_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token comment">// First page of reserved address space.</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token keyword">void</span><span class="token operator">*</span> load_start_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token comment">// Size in bytes of reserved address space.</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token class-name">size_t</span> load_size_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token comment">// First page of inaccessible gap mapping reserved for this DSO.</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token keyword">void</span><span class="token operator">*</span> gap_start_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token comment">// Size in bytes of the gap mapping.</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token class-name">size_t</span> gap_size_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token comment">// Load bias.</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token function">ElfW</span><span class="token punctuation">(</span>Addr<span class="token punctuation">)</span> load_bias_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token comment">// Loaded phdr.</span></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> loaded_phdr_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token comment">// Is map owned by the caller</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  bool mapped_by_caller_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token comment">// Only used by AArch64 at the moment.</span></pre></td></tr><tr><td data-num="77"></td><td><pre>  GnuPropertySection note_gnu_property_ __unused<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="aosp中解析elf示例"><a class="anchor" href="#aosp中解析elf示例">#</a> AOSP 中解析 Elf 示例</h2>
<p>在 AOSP 中，调用 <code>ElfReader</code>  解析 so 的示例代码如下所示，传入的四个参数的含义如下所示</p>
<ul>
<li><code>realpath</code> :  <code>elf</code>  的路径</li>
<li><code>fd_</code> : 打开的 <code>elf</code>  的 <code>fd</code>  文件描述符</li>
<li><code>file_offset_</code> :  <code>elf</code>  文件指针的当前偏移，初始值为 0</li>
<li><code>file_size</code> :  <code>elf</code>  的文件大小</li>
</ul>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">//LoadTask::read</span></pre></td></tr><tr><td data-num="3"></td><td><pre>bool <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> realpath<span class="token punctuation">,</span> <span class="token class-name">off64_t</span> file_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    ElfReader<span class="token operator">&amp;</span> elf_reader <span class="token operator">=</span> <span class="token function">get_elf_reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">return</span> elf_reader<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>realpath<span class="token punctuation">,</span> fd_<span class="token punctuation">,</span> file_offset_<span class="token punctuation">,</span> file_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="elfreaderread"><a class="anchor" href="#elfreaderread">#</a> ElfReader::Read</h2>
<p>非常典型的 <code>elf解析五件套</code> 代码，经过上面对于 ELF 的详细分析，我们也不难理解这五个函数的功能了</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_phdr.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bool ElfReader<span class="token operator">::</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off64_t</span> file_offset<span class="token punctuation">,</span> <span class="token class-name">off64_t</span> file_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>did_read_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  name_ <span class="token operator">=</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  fd_ <span class="token operator">=</span> fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  file_offset_ <span class="token operator">=</span> file_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  file_size_ <span class="token operator">=</span> file_size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadElfHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token function">VerifyElfHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token function">ReadProgramHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token function">ReadSectionHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token function">ReadDynamicSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    did_read_ <span class="token operator">=</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">return</span> did_read_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="readelfheader"><a class="anchor" href="#readelfheader">#</a> ReadElfHeader</h3>
<p>读取 ELF Header</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_phdr.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bool ElfReader<span class="token operator">::</span><span class="token function">ReadElfHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">ssize_t</span> rc <span class="token operator">=</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">pread64</span><span class="token punctuation">(</span>fd_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>header_<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>header_<span class="token punctuation">)</span><span class="token punctuation">,</span> file_offset_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"can't read file \"%s\": %s"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>header_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" is too small to be an ELF executable: only found %zd bytes"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>               static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="verifyelfheader"><a class="anchor" href="#verifyelfheader">#</a> VerifyElfHeader</h3>
<p>判断是否是 ELF Header 的合法性</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_phdr.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bool ElfReader<span class="token operator">::</span><span class="token function">VerifyElfHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>header_<span class="token punctuation">.</span>e_ident<span class="token punctuation">,</span> ELFMAG<span class="token punctuation">,</span> SELFMAG<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has bad ELF magic: %02x%02x%02x%02x"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>           header_<span class="token punctuation">.</span>e_ident<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> header_<span class="token punctuation">.</span>e_ident<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> header_<span class="token punctuation">.</span>e_ident<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> header_<span class="token punctuation">.</span>e_ident<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// Try to give a clear diagnostic for ELF class mismatches, since they're</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// an easy mistake to make during the 32-bit/64-bit transition period.</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">int</span> elf_class <span class="token operator">=</span> header_<span class="token punctuation">.</span>e_ident<span class="token punctuation">[</span>EI_CLASS<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__LP64__<span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>elf_class <span class="token operator">!=</span> ELFCLASS64<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>elf_class <span class="token operator">==</span> ELFCLASS32<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" is 32-bit instead of 64-bit"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has unknown ELF class: %d"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> elf_class<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>elf_class <span class="token operator">!=</span> ELFCLASS32<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>elf_class <span class="token operator">==</span> ELFCLASS64<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" is 64-bit instead of 32-bit"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has unknown ELF class: %d"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> elf_class<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>header_<span class="token punctuation">.</span>e_ident<span class="token punctuation">[</span>EI_DATA<span class="token punctuation">]</span> <span class="token operator">!=</span> ELFDATA2LSB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" not little-endian: %d"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header_<span class="token punctuation">.</span>e_ident<span class="token punctuation">[</span>EI_DATA<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>header_<span class="token punctuation">.</span>e_type <span class="token operator">!=</span> ET_DYN<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has unexpected e_type: %d"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header_<span class="token punctuation">.</span>e_type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>header_<span class="token punctuation">.</span>e_version <span class="token operator">!=</span> EV_CURRENT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has unexpected e_version: %d"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header_<span class="token punctuation">.</span>e_version<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>header_<span class="token punctuation">.</span>e_machine <span class="token operator">!=</span> <span class="token function">GetTargetElfMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" is for %s (%d) instead of %s (%d)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="49"></td><td><pre>           name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>           <span class="token function">EM_to_string</span><span class="token punctuation">(</span>header_<span class="token punctuation">.</span>e_machine<span class="token punctuation">)</span><span class="token punctuation">,</span> header_<span class="token punctuation">.</span>e_machine<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>           <span class="token function">EM_to_string</span><span class="token punctuation">(</span><span class="token function">GetTargetElfMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GetTargetElfMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>header_<span class="token punctuation">.</span>e_shentsize <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Shdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token comment">// Fail if app is targeting Android O or above</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_application_target_sdk_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">26</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>      <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has unsupported e_shentsize: 0x%x (expected 0x%zx)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                     name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header_<span class="token punctuation">.</span>e_shentsize<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Shdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token function">DL_WARN_documented_change</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                              <span class="token string">"invalid-elf-header_section-headers-enforced-for-api-level-26"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                              <span class="token string">"\"%s\" has unsupported e_shentsize 0x%x (expected 0x%zx)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                              name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header_<span class="token punctuation">.</span>e_shentsize<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Shdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token function">add_dlwarning</span><span class="token punctuation">(</span>name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"has invalid ELF header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>header_<span class="token punctuation">.</span>e_shstrndx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token comment">// Fail if app is targeting Android O or above</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_application_target_sdk_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">26</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has invalid e_shstrndx"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token function">DL_WARN_documented_change</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                              <span class="token string">"invalid-elf-header_section-headers-enforced-for-api-level-26"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                              <span class="token string">"\"%s\" has invalid e_shstrndx"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token function">add_dlwarning</span><span class="token punctuation">(</span>name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"has invalid ELF header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="readprogramheaders"><a class="anchor" href="#readprogramheaders">#</a> ReadProgramHeaders</h3>
<p>读取 Program Header</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_phdr.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// Loads the program header table from an ELF file into a read-only private</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// anonymous mmap-ed block.</span></pre></td></tr><tr><td data-num="4"></td><td><pre>bool ElfReader<span class="token operator">::</span><span class="token function">ReadProgramHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  phdr_num_ <span class="token operator">=</span> header_<span class="token punctuation">.</span>e_phnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// Like the kernel, we only accept program header tables that</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// are smaller than 64KiB.</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>phdr_num_ <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> phdr_num_ <span class="token operator">></span> <span class="token number">65536</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has invalid e_phnum: %zd"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> phdr_num_<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// Boundary checks</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token class-name">size_t</span> size <span class="token operator">=</span> phdr_num_ <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CheckFileRange</span><span class="token punctuation">(</span>header_<span class="token punctuation">.</span>e_phoff<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token function">alignof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has invalid phdr offset/size: %zu/%zu"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                   name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                   static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>header_<span class="token punctuation">.</span>e_phoff<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                   size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>phdr_fragment_<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span>fd_<span class="token punctuation">,</span> file_offset_<span class="token punctuation">,</span> header_<span class="token punctuation">.</span>e_phoff<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" phdr mmap failed: %s"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  phdr_table_ <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>phdr_fragment_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="readsectionheaders"><a class="anchor" href="#readsectionheaders">#</a> ReadSectionHeaders</h3>
<p>读取 Section Header</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_phdr.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bool ElfReader<span class="token operator">::</span><span class="token function">ReadSectionHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  shdr_num_ <span class="token operator">=</span> header_<span class="token punctuation">.</span>e_shnum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>shdr_num_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has no section headers"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token class-name">size_t</span> size <span class="token operator">=</span> shdr_num_ <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">ElfW</span><span class="token punctuation">(</span>Shdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CheckFileRange</span><span class="token punctuation">(</span>header_<span class="token punctuation">.</span>e_shoff<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token function">alignof</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Shdr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has invalid shdr offset/size: %zu/%zu"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                   name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                   static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>header_<span class="token punctuation">.</span>e_shoff<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                   size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shdr_fragment_<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span>fd_<span class="token punctuation">,</span> file_offset_<span class="token punctuation">,</span> header_<span class="token punctuation">.</span>e_shoff<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" shdr mmap failed: %s"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  shdr_table_ <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Shdr<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>shdr_fragment_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="readdynamicsection"><a class="anchor" href="#readdynamicsection">#</a> ReadDynamicSection</h3>
<p>读取 Dynamic Section</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//android-platform\bionic\linker\linker_phdr.cpp</span></pre></td></tr><tr><td data-num="2"></td><td><pre>bool ElfReader<span class="token operator">::</span><span class="token function">ReadDynamicSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment">// 1. Find .dynamic section (in section headers)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Shdr<span class="token punctuation">)</span><span class="token operator">*</span> dynamic_shdr <span class="token operator">=</span> nullptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> shdr_num_<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>shdr_table_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sh_type <span class="token operator">==</span> SHT_DYNAMIC<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      dynamic_shdr <span class="token operator">=</span> <span class="token operator">&amp;</span>shdr_table_ <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamic_shdr <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" .dynamic section header was not found"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// Make sure dynamic_shdr offset and size matches PT_DYNAMIC phdr</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token class-name">size_t</span> pt_dynamic_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token class-name">size_t</span> pt_dynamic_filesz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> phdr_num_<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Phdr<span class="token punctuation">)</span><span class="token operator">*</span> phdr <span class="token operator">=</span> <span class="token operator">&amp;</span>phdr_table_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>phdr<span class="token operator">-></span>p_type <span class="token operator">==</span> PT_DYNAMIC<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      pt_dynamic_offset <span class="token operator">=</span> phdr<span class="token operator">-></span>p_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      pt_dynamic_filesz <span class="token operator">=</span> phdr<span class="token operator">-></span>p_filesz<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>pt_dynamic_offset <span class="token operator">!=</span> dynamic_shdr<span class="token operator">-></span>sh_offset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_application_target_sdk_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">26</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" .dynamic section has invalid offset: 0x%zx, "</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                     <span class="token string">"expected to match PT_DYNAMIC offset: 0x%zx"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                     name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                     static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>dynamic_shdr<span class="token operator">-></span>sh_offset<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                     pt_dynamic_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token function">DL_WARN_documented_change</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                              <span class="token string">"invalid-elf-header_section-headers-enforced-for-api-level-26"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                              <span class="token string">"\"%s\" .dynamic section has invalid offset: 0x%zx "</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                              <span class="token string">"(expected to match PT_DYNAMIC offset 0x%zx)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                              name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                              static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>dynamic_shdr<span class="token operator">-></span>sh_offset<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                              pt_dynamic_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token function">add_dlwarning</span><span class="token punctuation">(</span>name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"invalid .dynamic section"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>pt_dynamic_filesz <span class="token operator">!=</span> dynamic_shdr<span class="token operator">-></span>sh_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_application_target_sdk_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">26</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" .dynamic section has invalid size: 0x%zx, "</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                     <span class="token string">"expected to match PT_DYNAMIC filesz: 0x%zx"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                     name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                     static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>dynamic_shdr<span class="token operator">-></span>sh_size<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                     pt_dynamic_filesz<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token function">DL_WARN_documented_change</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                              <span class="token string">"invalid-elf-header_section-headers-enforced-for-api-level-26"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                              <span class="token string">"\"%s\" .dynamic section has invalid size: 0x%zx "</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                              <span class="token string">"(expected to match PT_DYNAMIC filesz 0x%zx)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                              name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                              static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">></span><span class="token punctuation">(</span>dynamic_shdr<span class="token operator">-></span>sh_size<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                              pt_dynamic_filesz<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token function">add_dlwarning</span><span class="token punctuation">(</span>name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"invalid .dynamic section"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamic_shdr<span class="token operator">-></span>sh_link <span class="token operator">>=</span> shdr_num_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" .dynamic section has invalid sh_link: %d"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                   name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                   dynamic_shdr<span class="token operator">-></span>sh_link<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Shdr<span class="token punctuation">)</span><span class="token operator">*</span> strtab_shdr <span class="token operator">=</span> <span class="token operator">&amp;</span>shdr_table_<span class="token punctuation">[</span>dynamic_shdr<span class="token operator">-></span>sh_link<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>strtab_shdr<span class="token operator">-></span>sh_type <span class="token operator">!=</span> SHT_STRTAB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" .dynamic section has invalid link(%d) sh_type: %d (expected SHT_STRTAB)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="77"></td><td><pre>                   name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dynamic_shdr<span class="token operator">-></span>sh_link<span class="token punctuation">,</span> strtab_shdr<span class="token operator">-></span>sh_type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CheckFileRange</span><span class="token punctuation">(</span>dynamic_shdr<span class="token operator">-></span>sh_offset<span class="token punctuation">,</span> dynamic_shdr<span class="token operator">-></span>sh_size<span class="token punctuation">,</span> <span class="token function">alignof</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has invalid offset/size of .dynamic section"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dynamic_fragment_<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span>fd_<span class="token punctuation">,</span> file_offset_<span class="token punctuation">,</span> dynamic_shdr<span class="token operator">-></span>sh_offset<span class="token punctuation">,</span> dynamic_shdr<span class="token operator">-></span>sh_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" dynamic section mmap failed: %s"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>  dynamic_ <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token function">ElfW</span><span class="token punctuation">(</span>Dyn<span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>dynamic_fragment_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">CheckFileRange</span><span class="token punctuation">(</span>strtab_shdr<span class="token operator">-></span>sh_offset<span class="token punctuation">,</span> strtab_shdr<span class="token operator">-></span>sh_size<span class="token punctuation">,</span> <span class="token function">alignof</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token function">DL_ERR_AND_LOG</span><span class="token punctuation">(</span><span class="token string">"\"%s\" has invalid offset/size of the .strtab section linked from .dynamic section"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                   name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strtab_fragment_<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span>fd_<span class="token punctuation">,</span> file_offset_<span class="token punctuation">,</span> strtab_shdr<span class="token operator">-></span>sh_offset<span class="token punctuation">,</span> strtab_shdr<span class="token operator">-></span>sh_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token function">DL_ERR</span><span class="token punctuation">(</span><span class="token string">"\"%s\" strtab section mmap failed: %s"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token keyword">return</span> false<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre>  strtab_ <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>strtab_fragment_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>  strtab_size_ <span class="token operator">=</span> strtab_fragment_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  <span class="token keyword">return</span> true<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="参考资料"><a class="anchor" href="#参考资料">#</a> 参考资料</h1>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9ldmlscGFuLmNvbS8yMDIwLzA4LzA5L2VsZi1pbnNpZGUtb3V0Lw==">深入浅出 ELF</span></li>
<li>https://ctf-wiki.org/executable/elf</li>
<li><span class="exturl" data-url="aHR0cDovL2NodXF1YW4ubWUvMjAxOC8wNS8yMS9lbGYtaW50cm9kdWNl">计算机那些事 (4)——ELF 文件结构</span></li>
<li><span class="exturl" data-url="aHR0cDovL2NodXF1YW4ubWUvMjAxOC8wNi8wMy9saW5raW5nLXN0YXRpYy1saW5raW5nLWR5bmFtaWMtbGlua2luZy8=">计算机那些事 (5)—— 链接、静态链接、动态链接</span></li>
<li><span class="exturl" data-url="aHR0cDovL2NodXF1YW4ubWUvMjAxOC8wNi8xNy9leGVjdXRhYmxlLWZpbGUtbG9hZC1hbmQtZXhlY3V0aW9uLw==">计算机那些事 (6)—— 可执行文件的装载与运行</span></li>
</ul>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2025-04-09 02:55:11" itemprop="dateModified" datetime="2025-04-09T02:55:11+08:00">2025-04-09</time>
  </span>
  <span id="ElfReader/" class="item leancloud_visitors" data-flag-title="ELF结构分析及ElfReader" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>oacia <i class="ic i-at"><em>@</em></i>oaciaのBbBlog~
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://oacia.dev/ElfReader/" title="ELF结构分析及ElfReader">https://oacia.dev/ElfReader/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/android-load-so/" itemprop="url" rel="prev" data-background-image="&#x2F;picture&#x2F;681080.webp" title="安卓so加载流程源码分析">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>安卓so加载流程源码分析</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/360-jiagu/" itemprop="url" rel="next" data-background-image="&#x2F;picture&#x2F;740545.webp" title="360加固dex解密流程分析">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>360加固dex解密流程分析</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#elf%E7%BB%93%E6%9E%84%E7%AE%80%E6%9E%90"><span class="toc-text"> ELF 结构简析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#elf-header"><span class="toc-text"> ELF Header</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#e_identei_nident"><span class="toc-text"> e_ident[EI_NIDENT]</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#e_identei_mag0ei_mag3"><span class="toc-text"> e_ident[EI_MAG0…EI_MAG3]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#e_identei_class"><span class="toc-text"> e_ident[EI_CLASS]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#e_identei_data"><span class="toc-text"> e_ident[EI_DATA]</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_type"><span class="toc-text"> e_type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_machine"><span class="toc-text"> e_machine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_version"><span class="toc-text"> e_version</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_entry"><span class="toc-text"> e_entry</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_phoff"><span class="toc-text"> e_phoff</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_shoff"><span class="toc-text"> e_shoff</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_flags"><span class="toc-text"> e_flags</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_ehsize"><span class="toc-text"> e_ehsize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_phentsize"><span class="toc-text"> e_phentsize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_phnum"><span class="toc-text"> e_phnum</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_shentsize"><span class="toc-text"> e_shentsize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_shnum"><span class="toc-text"> e_shnum</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e_shstrndx"><span class="toc-text"> e_shstrndx</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#program-header"><span class="toc-text"> Program Header</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#p_type"><span class="toc-text"> p_type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#p_flags"><span class="toc-text"> p_flags</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#section-header"><span class="toc-text"> Section Header</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sh_type"><span class="toc-text"> sh_type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sh_flags"><span class="toc-text"> sh_flags</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sh_link-sh_info"><span class="toc-text"> sh_link &amp; sh_info</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#elf-sections"><span class="toc-text"> ELF sections</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%9A%84%E5%88%86%E7%B1%BB"><span class="toc-text"> 节的分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#text%E8%8A%82"><span class="toc-text"> .text 节</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rodata%E8%8A%82"><span class="toc-text"> .rodata 节</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#plt%E8%8A%82%E8%BF%87%E7%A8%8B%E9%93%BE%E6%8E%A5%E8%A1%A8"><span class="toc-text"> .plt 节（过程链接表）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#data%E8%8A%82"><span class="toc-text"> .data 节</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bss%E8%8A%82"><span class="toc-text"> .bss 节</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gotplt%E8%8A%82%E5%85%A8%E5%B1%80%E5%81%8F%E7%A7%BB%E8%A1%A8-%E8%BF%87%E7%A8%8B%E9%93%BE%E6%8E%A5%E8%A1%A8"><span class="toc-text"> .got.plt 节（全局偏移表 - 过程链接表）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dynsym%E8%8A%82%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-text"> .dynsym 节（动态链接符号表）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dynstr%E8%8A%82%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A1%A8"><span class="toc-text"> .dynstr 节（动态链接字符串表）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rel%E8%8A%82%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A8"><span class="toc-text"> .rel.* 节（重定位表）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hash%E8%8A%82"><span class="toc-text"> .hash 节</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#symtab%E8%8A%82%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-text"> .symtab 节（符号表）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strtab%E8%8A%82%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A1%A8"><span class="toc-text"> .strtab 节（字符串表）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ctors%E8%8A%82%E5%92%8Cdtors%E8%8A%82"><span class="toc-text"> .ctors 节和.dtors 节</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="toc-text"> 符号表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A1%A8"><span class="toc-text"> 字符串表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A8"><span class="toc-text"> 重定位表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#elf%E7%9A%84%E9%93%BE%E6%8E%A5%E8%BF%87%E7%A8%8B"><span class="toc-text"> ELF 的链接过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E6%A6%82%E8%BF%B0"><span class="toc-text"> 链接概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%88%86%E9%85%8D"><span class="toc-text"> 地址与空间分配</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%89%E5%BA%8F%E5%8F%A0%E5%8A%A0"><span class="toc-text"> 按序叠加</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%88%E5%B9%B6%E7%9B%B8%E4%BC%BC%E8%8A%82"><span class="toc-text"> 合并相似节</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E8%A7%A3%E6%9E%90"><span class="toc-text"> 符号解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E9%87%8D%E5%AE%9A%E4%B9%89%E7%9A%84%E5%85%A8%E5%B1%80%E7%AC%A6%E5%8F%B7%E8%A7%A3%E6%9E%90"><span class="toc-text"> 多重定义的全局符号解析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D"><span class="toc-text"> 重定位</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-text"> 静态链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-text"> 动态链接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 动态链接的基本实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E6%97%B6%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%88%86%E5%B8%83"><span class="toc-text"> 动态链接程序运行时地址空间分布</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%85%B1%E4%BA%AB%E5%BA%93"><span class="toc-text"> 静态共享库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%85%B1%E4%BA%AB%E5%BA%93"><span class="toc-text"> 动态共享库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E6%97%A0%E5%85%B3%E4%BB%A3%E7%A0%81"><span class="toc-text"> 地址无关代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B1-%E6%A8%A1%E5%9D%97%E5%86%85%E9%83%A8%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="toc-text"> 类型 1 模块内部函数调用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B2-%E6%A8%A1%E5%9D%97%E5%86%85%E9%83%A8%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE"><span class="toc-text"> 类型 2 模块内部数据访问</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B3-%E6%A8%A1%E5%9D%97%E9%97%B4%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE"><span class="toc-text"> 类型 3 模块间数据访问</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B4-%E6%A8%A1%E5%9D%97%E9%97%B4%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="toc-text"> 类型 4 模块间函数调用</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#elf%E7%9A%84%E8%A3%85%E8%BD%BD%E8%BF%87%E7%A8%8B"><span class="toc-text"> ELF 的装载过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E8%BF%9B%E7%A8%8B"><span class="toc-text"> 创建新进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="toc-text"> 检查可执行文件类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%8C%B9%E9%85%8D%E8%A3%85%E8%BD%BD%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B"><span class="toc-text"> 搜索匹配装载处理过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A3%85%E8%BD%BD%E6%89%A7%E8%A1%8C%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6"><span class="toc-text"> 装载执行可执行文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#technical-note-on-elf-loading"><span class="toc-text"> TECHNICAL NOTE ON ELF LOADING</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#elfreader%E7%B1%BB"><span class="toc-text"> ElfReader 类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#aosp%E4%B8%AD%E8%A7%A3%E6%9E%90elf%E7%A4%BA%E4%BE%8B"><span class="toc-text"> AOSP 中解析 Elf 示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#elfreaderread"><span class="toc-text"> ElfReader::Read</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#readelfheader"><span class="toc-text"> ReadElfHeader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#verifyelfheader"><span class="toc-text"> VerifyElfHeader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#readprogramheaders"><span class="toc-text"> ReadProgramHeaders</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#readsectionheaders"><span class="toc-text"> ReadSectionHeaders</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#readdynamicsection"><span class="toc-text"> ReadDynamicSection</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text"> 参考资料</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="oacia"
      data-src="/images/avatar.jpg">
  
  <svg class="logo-overview" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 540.19 380.99">
    <g id="clips" fill= #00a99d; stroke="none">
      <clipPath id="o">
        <path d="M93.57,284c8,0,14.91-1,20.75-3,5.83-2,10.41-3.66,13.75-5,4.66-1.66,6.16-.75,4.5,2.75-1.67,3.5-4.67,6.42-9,8.75-2.34,1.34-6.09,2.84-11.25,4.5-5.17,1.67-11.09,2.5-17.75,2.5-.34,8.67-3.34,16.84-9,24.5-5.67,7.67-13.34,13.34-23,17-6,2.34-12.17,3.59-18.5,3.75-6.34,.17-12.17-.66-17.5-2.5-5.34-1.83-10.09-4.66-14.25-8.5-4.17-3.83-7.25-8.41-9.25-13.75-2-5.33-2.83-11-2.5-17s1.83-11.83,4.5-17.5c2.66-5.66,6.33-10.75,11-15.25,4.66-4.5,10.16-7.75,16.5-9.75,5.66-1.66,11.41-1.66,17.25,0,5.83,1.67,10.08,4.34,12.75,8,1.66,2.67,2.5,5.67,2.5,9,3-2,6.33-3,10-3h1c3.33,0,6.5,.84,9.5,2.5,3,1.67,5.33,4.5,7,8.5l1,3.5Zm-34,39.5c5.66-.66,10.33-3.83,14-9.5,3.66-5.66,5.33-12.16,5-19.5-4.67,.34-9.09-.41-13.25-2.25-4.17-1.83-6.42-4.58-6.75-8.25-.67-3,0-5.5,2-7.5-.67-2.66-2.75-5-6.25-7s-7.09-2.16-10.75-.5c-4.67,2-8.25,5.84-10.75,11.5-2.5,5.67-3.09,11.84-1.75,18.5,1.33,8,4.75,14.34,10.25,19,5.5,4.67,11.58,6.5,18.25,5.5Z"/>
      </clipPath>
      <clipPath id="a1">
        <path d="M176.06,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      <clipPath id="c">
        <path d="M250.06,280.5c4.66-7.66,12-13.16,22-16.5,10-3.33,19.83-3.66,29.5-1,7.66,2.34,13.5,5.67,17.5,10,4,4.34,5.83,8.5,5.5,12.5-.34,4.67-2.25,8.59-5.75,11.75-3.5,3.17-7.09,5.34-10.75,6.5-3.67,1.17-6.84,1.25-9.5,.25-2.67-1-3.34-3.16-2-6.5,2.66-8,2.75-14.58,.25-19.75-2.5-5.16-5.92-6.41-10.25-3.75-2.67,1.67-5,4.09-7,7.25-2,3.17-3.5,6.75-4.5,10.75s-1.42,8.09-1.25,12.25c.16,4.17,.75,7.92,1.75,11.25,1.33,4,3.66,7.42,7,10.25,3.33,2.84,7.16,4.67,11.5,5.5,4.33,.84,8.91,.67,13.75-.5,4.83-1.16,9.25-3.75,13.25-7.75,7.33-6.66,12.33-14.33,15-23,.33-1.66,1.16-2.91,2.5-3.75,1.33-.83,2.5-1.08,3.5-.75,1,.34,1.83,1.09,2.5,2.25,.66,1.17,.66,2.92,0,5.25-2.34,9.34-6.34,17-12,23-4.67,5.67-10.5,10.42-17.5,14.25-7,3.84-14.25,6.09-21.75,6.75-7.5,.67-14.84-.33-22-3-7.17-2.66-13.25-7.5-18.25-14.5-6-8.66-8.75-17.66-8.25-27,.5-9.33,2.25-16.66,5.25-22Z"/>
      </clipPath>
      <clipPath id="i_b">
        <path d="M393.06,330c-2.34,2.67-5.17,5.09-8.5,7.25-3.34,2.17-7.09,3.59-11.25,4.25-4.17,.67-8.59,.67-13.25,0-4.67-.66-9.17-2.33-13.5-5-4.67-2.66-7.67-7.58-9-14.75-1.34-7.16-1.83-14.66-1.5-22.5,.33-7.83,1.33-14.91,3-21.25,1.66-6.33,3.33-10.16,5-11.5,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,3.59,1.25,6.75-.17,3.17-.5,6.92-1,11.25-.5,4.34-1.09,8.92-1.75,13.75-.67,4.84-.67,9.42,0,13.75,.33,3.67,1.33,6.42,3,8.25,1.66,1.84,3.5,2.84,5.5,3,2,.17,4-.25,6-1.25s3.83-2.33,5.5-4c3-3.66,5.66-7.66,8-12,2.33-4.33,4.16-8.16,5.5-11.5,1-3.66,2.91-5.25,5.75-4.75,2.83,.5,3.75,3.09,2.75,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.34,8.59-10,14.25Z"/>
      </clipPath>
      <clipPath id="a2">
        <path d="M461.56,270c5,4,8.5,9.17,10.5,15.5,.66-1.33,1.25-2.33,1.75-3,.5-.66,1.08-1.33,1.75-2,3.66-2.66,8-3.08,13-1.25,5,1.84,8.5,4.09,10.5,6.75,1,1.34,1.41,2.75,1.25,4.25-.17,1.5-.5,3.42-1,5.75-.5,2.34-1,5.09-1.5,8.25-.5,3.17-.42,6.92,.25,11.25,.33,3.67,1.25,6.5,2.75,8.5s3.16,3.25,5,3.75c1.83,.5,3.75,.34,5.75-.5,2-.83,3.83-2.08,5.5-3.75,3-3.66,5.75-7.66,8.25-12,2.5-4.33,4.25-8.16,5.25-11.5,1.33-3.66,3.41-5.25,6.25-4.75,2.83,.5,3.58,3.09,2.25,7.75-1.34,4.67-3,8.92-5,12.75-2,3.84-5.17,8.59-9.5,14.25-4.67,5.67-11.34,9.59-20,11.75-8.67,2.17-17.67,.42-27-5.25-5-3.33-8.34-8.83-10-16.5-.67,1.34-2,3.34-4,6-3.67,4.67-7.84,8.59-12.5,11.75-4.67,3.17-9.42,5.34-14.25,6.5-4.84,1.17-9.59,1.34-14.25,.5-4.67-.83-9-2.75-13-5.75-7.67-6-11.75-14.33-12.25-25-.5-10.66,2.91-20.83,10.25-30.5,7.33-9.66,16.25-15.75,26.75-18.25s19.58-.91,27.25,4.75Zm-25,60c4.66,1.67,9.66,.17,15-4.5,5.33-4.66,9.33-10.83,12-18.5,2.33-6.66,2.58-12.5,.75-17.5-1.84-5-5.09-8.33-9.75-10-4.67-1.66-9.34-1.33-14,1-4.67,2.34-8.34,7.34-11,15-3,7.67-3.84,14.92-2.5,21.75,1.33,6.84,4.5,11.09,9.5,12.75Z"/>
      </clipPath>
      
    </g>
    <g
      id="strokes"
      fill="none"
      stroke=#96d7f5
      stroke-linecap="round"
      stroke-linejoin="round"
    >
    <path
    clip-path="url(#o)"
    class="oPath path"
    d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
    stroke-width="32.5"
    ></path>
    <path
      clip-path="url(#a1)"
      class="a1Path path"
      d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
      stroke-width="59"
    ></path>
    <path
      clip-path="url(#c)"
      class="cPath path"
      d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
      stroke-width="110"
    ></path>
    <path
      clip-path="url(#i_b)"
      class="i_bPath path"
      d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
      stroke-width="33"
    ></path>
    <path
      clip-path="url(#a2)"
      class="a2Path path"
      d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
      stroke-width="70"
    ></path>
    </g>
    <g
      id="strokes2"
      fill="none"
      stroke=#ff97b8
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path
        clip-path="url(#o)"
        class="oPath path"
        d="M65.07,278.38c-.29-1.76-1.26-6.18-5-10-3.34-3.4-7.07-4.47-9-5-6.95-1.9-12.89,.22-15,1-10.95,4.04-18.33,15.16-20,26-1.42,9.21,1.56,16.56,3,20,1.49,3.55,3.94,9.39,10,14,6.66,5.07,13.73,5.65,18,6,3,.25,9.01,.67,16-2,1.72-.66,5.78-2.38,10-6,.99-.86,4.82-4.25,8-10,2.79-5.06,3.72-9.49,4-11,.39-2.12,1.09-6.93,0-13-1.05-5.85-1.95-10.86-6-13-2.83-1.5-7.27-1.62-10,1-1.73,1.66-2.85,4.55-2,7,1.04,2.99,4.58,4.01,8,5,1.16,.33,2.91,.75,8,1,4.72,.23,8.68,.18,12,0,6.49-.36,9.74-.54,12-1,4.35-.88,7.44-2.14,12-4,4.67-1.9,6.76-3.17,8-4,2.56-1.7,3.95-3.1,5-4,5.5-4.73,12.89-6.48,18-7,6.09-.62,11.96-.21,18,3,4.89,2.6,8.27,6.84,10,9,1.86,2.32,3.15,4.46,4,6"
        stroke-width="32.5"
      ></path>
      <path
        clip-path="url(#a1)"
        class="a1Path path"
        d="M154.07,270.38c-3.73,1.48-11.88,5.3-18,14-4.95,7.03-6.09,13.7-7,19-1.38,8.06-2.81,16.39,2,24,3.93,6.21,9.88,8.58,11,9,7.28,2.76,13.71,.75,16,0,5.19-1.71,8.32-4.6,12-8,2.48-2.29,6.78-6.34,10-13,2.71-5.61,3.51-10.73,4-14,.86-5.79,.57-9.98,1-10,.41-.02,.79,3.69,2,11,1.71,10.28,2.44,11.93,3,13,1.44,2.76,2.62,5.84,7,10,4.73,4.49,8.09,5.74,11,7,6.75,2.92,13.16,1.45,15,1,4.94-1.21,8.2-3.64,10-5,4.09-3.11,6.34-6.48,8-9,2.23-3.4,3.47-6.35,5-10,1.22-2.9,2.18-5.67,3-8,1.52-4.35,1.41-4.5,2-6,1.75-4.46,2-6,7-12,2.31-2.77,6.32-8.54,10-11,3.79-2.54,7-3.81,10-5,5.33-2.12,9-2.17,12-2,5.4,.32,10.2,4.49,12,6,2.31,1.93,6.05,6.97,7,12,.62,3.29-.19,5.13-1,8-.86,3.04-3.06,5.4-4,7"
        stroke-width="59"
      ></path>
      <path
        clip-path="url(#c)"
        class="cPath path"
        d="M273.07,272.38c-3.08,2.79-9.54,9.45-12,20-2.1,9.02-.22,16.29,1,21,1.57,6.05,3.22,12.44,9,18,6.67,6.42,14.58,7.66,17,8,6.36,.9,11.22-.42,17-2,3.68-1,8.59-2.39,14-6,4.13-2.76,6.84-5.67,9-8,3.24-3.49,5.27-6.46,7-9,2.22-3.27,4.18-6.89,8-14,3.39-6.3,5.1-9.5,6-12,1.67-4.63,2.38-8.58,3-12,.72-4,.94-6.77,1-9,.03-1.23,.02-2.26,0-3"
        stroke-width="110"
      ></path>
      <path
        clip-path="url(#i_b)"
        class="i_bPath path"
        d="M355.07,265.38c-1.55,12.11-2.45,22.6-3,31-.66,10.17-.79,16.98,2,25,1.74,5,3.75,10.53,9,13,6.29,2.97,13.34-.3,17-2,6.11-2.83,9.64-6.89,14-12,9.03-10.59,9.67-15.19,10-17,.6-3.32,1.32-6.16,1-8"
        stroke-width="33"
      ></path>
      <path
        clip-path="url(#a2)"
        class="a2Path path"
        d="M470.07,302.38c.32-2.77,.45-7.09-1-12-.98-3.32-5.25-15.49-17-19-12.13-3.62-22.23,4.71-25,7-6.75,5.57-9.28,12.36-11,17-1.68,4.53-5.22,14.03-2,25,1.19,4.05,3.29,11.22,10,15,7.78,4.39,16.49,1.26,20,0,6.31-2.27,10.12-6.13,14-10,4.99-4.97,7.76-9.61,11-15,1.88-3.14,4.54-7.61,7-14,3.15-8.18,3.42-14.06,4-14,.51,.05-.23,7.53,0,19,.07,3.38,.38,6.92,1,14,.41,4.62,.69,7.05,2,10,.82,1.86,2.1,4.74,5,7,4.4,3.43,9.65,3.17,13,3,1.08-.05,5.74-.35,11-3,4.39-2.21,7.04-4.97,9-7,.85-.89,3.48-3.69,6-8,1.51-2.58,1.83-3.87,4-9,1.54-3.64,2.92-6.7,4-9"
        stroke-width="70"
      ></path>
    </g>
    <g class="dot-group">
      <path
        id="dot"
        fill=#ff97b8
        d="M362.58,182.21c4.66-.33,9.66,1.17,15,4.5,5.33,3.34,7.66,7.5,7,12.5-.67,2.34-1.92,4.92-3.75,7.75-1.84,2.84-4,5.5-6.5,8s-4.84,4.75-7,6.75c-2.17,2-3.75,3.17-4.75,3.5-2.67,1.67-5.34,2.25-8,1.75-2.67-.5-5-1.5-7-3s-3.59-3.33-4.75-5.5c-1.17-2.16-1.92-4.25-2.25-6.25-.34-2,.16-4.66,1.5-8,1.33-3.33,3.08-6.58,5.25-9.75,2.16-3.16,4.58-6,7.25-8.5,2.66-2.5,5.33-3.75,8-3.75Z"
      ></path>
    </g>
  </svg>
  <div class="description" itemprop="description">月遇从云 花遇和风</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">53</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">46</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL29hY2lh" title="https:&#x2F;&#x2F;github.com&#x2F;oacia"><i class="ic i-github"></i></span>
      <a target="_blank" rel="noopener" href="https://twitter.com/oacia86" title="https:&#x2F;&#x2F;twitter.com&#x2F;oacia86" class="item twitter"><i class="ic i-twitter"></i></a>
      <span class="exturl item paper-plane" data-url="aHR0cHM6Ly90Lm1lL29hY2lh" title="https:&#x2F;&#x2F;t.me&#x2F;oacia"><i class="ic i-paper-plane"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOm9hY2lhODZAZ21haWwuY29t" title="mailto:oacia86@gmail.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about-oacia/" rel="section"><i class="ic i-user"></i>关于oacia</a>
  </li>

    
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-feather"></i>文章</a>
  </li>

    
  <li class="item">
    <a href="/TODOlist/" rel="section"><i class="ic i-clock"></i>要做的事</a>
  </li>

    
  <li class="item">
    <a href="/website_maintenance/" rel="section"><i class="ic i-calendar"></i>更新日志</a>
  </li>

    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>小伙伴</a>
  </li>

    
  <li class="item">
    <a href="/music/" rel="section"><i class="ic i-music"></i>听会儿歌吧</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/android-load-so/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/360-jiagu/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2022 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">oacia @ oacia</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">968k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">14:40</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>



<script data-config type="text/javascript">
  var LOCAL = {
    path: 'ElfReader/',
    favicon: {
      show: "柚鳥ナツ",
      hide: "甘い幸せ"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>
<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>


<script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>
<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
